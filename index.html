<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAP Readiness Hub - Offline</title>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons (React version - same as original app) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide-react.min.js"></script>

  <!-- JSZip for ZIP file handling -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- PDF/Canvas for reports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100">
  <div id="root"></div>

  <!-- Offline Data Handling -->
  <script>
  // File mapping from CAPWATCH exports to payload structure
// Based on Code.gs lines 162-200
// Attach to window so it's accessible from Babel-transpiled scripts
window.CAPWATCH_FILE_MAP = {
  // Config files (use contains matching - these names are unique enough)
  'PL_Paths': { cat: 'config', key: 'paths' },
  'PL_Groups': { cat: 'config', key: 'groups' },
  'PL_Tasks': { cat: 'config', key: 'tasks' },
  'PL_TaskGroupAssignments': { cat: 'config', key: 'assignments' },
  'CdtAchvEnum': { cat: 'config', key: 'cadetAchvEnum' },
  'AchvStepTasks': { cat: 'config', key: 'esAchvStepTasks' },
  'AchvStepAchv': { cat: 'config', key: 'esAchvStepAchv' },
  // Data files (use contains matching - these names are unique enough)
  'CadetDutyPositions': { cat: 'data', key: 'cadetDuty' },
  'SeniorLevel': { cat: 'data', key: 'seniorLevels' },
  'SpecTrack': { cat: 'data', key: 'tracks' },
  'MbrCommittee': { cat: 'data', key: 'committees' },
  'MbrContact': { cat: 'data', key: 'contacts' },
  'MbrAchievements': { cat: 'data', key: 'esMbrAchievements' },
  'MbrTasks': { cat: 'data', key: 'esMbrTasks' },
  'PL_MemberTaskCredit': { cat: 'data', key: 'memberTasks' },
  'PL_MemberPathCredit': { cat: 'data', key: 'memberPaths' },
  'CadetRank': { cat: 'data', key: 'cadetRank' },
  'CadetAchvAprs': { cat: 'data', key: 'cadetAchvAprs' },
  'CadetAchvFullReport': { cat: 'data', key: 'cadetAchvFullReport' },
  'CadetActivities': { cat: 'data', key: 'cadetActivities' },
  'CadetHFZInformation': { cat: 'data', key: 'cadetHFZ' },
  'CadetPhase': { cat: 'data', key: 'cadetPhase' },
  'CadetAwards': { cat: 'data', key: 'cadetAwards' },
  'SeniorAwards': { cat: 'data', key: 'seniorAwards' },
  'OFlight': { cat: 'data', key: 'oFlights' },
  'ORGStatistics': { cat: 'data', key: 'orgStats' },
  'PL_VolUInstructors': { cat: 'data', key: 'voluInstructors' }
};

// Special handling for files that need exact matching vs contains matching
// These files have names that are substrings of other files, so we must match exactly
window.EXACT_MATCH_FILES = {
  'Achievements': { cat: 'config', key: 'esAchievements' },
  'Tasks': { cat: 'config', key: 'esTasks' },
  'CadetAchv': { cat: 'data', key: 'cadetAchv' },
  'Member': { cat: 'data', key: 'members' },
  'Organization': { cat: 'data', key: 'organization' },
  'DutyPosition': { cat: 'data', key: 'duty' },
  'Training': { cat: 'data', key: 'training' },
  'DownLoadDate': { cat: 'meta', key: 'downloadDate' }
};

  // IndexedDB wrapper for offline data persistence
// Attach to window so it's accessible from Babel-transpiled scripts
window.CapwatchDB = {
  DB_NAME: 'capwatch-offline',
  DB_VERSION: 1,
  STORE_NAME: 'data',

  async open() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve(request.result);
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
          db.createObjectStore(this.STORE_NAME);
        }
      };
    });
  },

  async save(payload) {
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      const store = tx.objectStore(this.STORE_NAME);
      const request = store.put({ payload, timestamp: Date.now() }, 'current');
      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve();
      tx.oncomplete = () => db.close();
    });
  },

  async load() {
    try {
      const db = await this.open();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(this.STORE_NAME, 'readonly');
        const store = tx.objectStore(this.STORE_NAME);
        const request = store.get('current');
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        tx.oncomplete = () => db.close();
      });
    } catch (e) {
      console.warn('IndexedDB load failed:', e);
      return null;
    }
  },

  async clear() {
    const db = await this.open();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      const store = tx.objectStore(this.STORE_NAME);
      const request = store.clear();
      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve();
      tx.oncomplete = () => db.close();
    });
  }
};

  // Import CAPWATCH ZIP file and extract data
// Attach to window so it's accessible from Babel-transpiled scripts
window.importCapwatchZip = async function(file, onProgress) {
  try {
    onProgress && onProgress('Reading ZIP file...');
    console.log('[ZIP Import] Starting import of:', file.name);
    const zip = await JSZip.loadAsync(file);

    const payload = {
      config: {},
      data: {},
      meta: {
        lastUpdated: new Date().toISOString(),
        source: 'zip-import',
        filename: file.name
      }
    };

    const entries = Object.entries(zip.files).filter(([_, entry]) => !entry.dir);
    console.log('[ZIP Import] Found', entries.length, 'files in ZIP');
    let processed = 0;
    let matched = 0;

    for (const [filename, zipEntry] of entries) {
      const baseName = filename.split('/').pop().replace('.txt', '');
      let wasMatched = false;

      // Try exact match files first
      for (const [searchKey, def] of Object.entries(window.EXACT_MATCH_FILES)) {
        if (baseName === searchKey) {
          onProgress && onProgress('Processing ' + baseName + '...');
          const content = await zipEntry.async('string');
          payload[def.cat][def.key] = content;
          console.log('[ZIP Import] EXACT MATCH:', baseName, '->', def.cat + '.' + def.key, '(' + content.length + ' chars)');
          wasMatched = true;
          matched++;
          break;
        }
      }

      // Then try contains matching (only if not already matched)
      if (!wasMatched) {
        for (const [searchKey, def] of Object.entries(window.CAPWATCH_FILE_MAP)) {
          if (baseName.includes(searchKey)) {
            // Check exclusions
            if (def.exclude && def.exclude.some(ex => baseName.includes(ex))) {
              console.log('[ZIP Import] EXCLUDED:', baseName, '(contains excluded term)');
              continue;
            }

            onProgress && onProgress('Processing ' + baseName + '...');
            const content = await zipEntry.async('string');
            payload[def.cat][def.key] = content;
            console.log('[ZIP Import] CONTAINS MATCH:', baseName, '->', def.cat + '.' + def.key, '(' + content.length + ' chars)');
            wasMatched = true;
            matched++;
            break;
          }
        }
      }

      if (!wasMatched) {
        console.log('[ZIP Import] NO MATCH:', baseName);
      }

      processed++;
      if (processed % 5 === 0) {
        onProgress && onProgress('Processed ' + processed + '/' + entries.length + ' files...');
      }
    }

    console.log('[ZIP Import] Matched', matched, 'of', entries.length, 'files');
    console.log('[ZIP Import] Payload config keys:', Object.keys(payload.config));
    console.log('[ZIP Import] Payload data keys:', Object.keys(payload.data));

    // Parse DownLoadDate if present and use it as lastUpdated
    if (payload.meta.downloadDate) {
      const lines = payload.meta.downloadDate.split('\n').filter(l => l.trim());
      if (lines.length > 1) {
        // Second line contains the date, strip quotes
        const dateStr = lines[1].replace(/"/g, '').trim();
        const parsed = new Date(dateStr);
        if (!isNaN(parsed.getTime())) {
          payload.meta.lastUpdated = parsed.toISOString();
          console.log('[ZIP Import] Using DownLoadDate as lastUpdated:', dateStr, '->', payload.meta.lastUpdated);
        }
      }
    }

    // Log sample of members data if present
    if (payload.data.members) {
      const lines = payload.data.members.split('\n');
      console.log('[ZIP Import] Members file has', lines.length, 'lines');
      console.log('[ZIP Import] Members header:', lines[0]);
      if (lines.length > 1) console.log('[ZIP Import] Members first row:', lines[1]);
    }

    onProgress && onProgress('Saving to local storage...');
    await window.CapwatchDB.save(payload);

    console.log('[ZIP Import] Complete! Payload saved to IndexedDB');
    return payload;
  } catch (error) {
    console.error('ZIP import failed:', error);
    throw error;
  }
}
  </script>
<style>
/* Custom scrollbar */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

/* Animation for loading */
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
</style>

<script type="text/babel">
// --- APP METADATA ---
const APP_VERSION = '1.0.0';  // Increment with releases
// APP_NAME: Customize this for your unit (must match APP_NAME in Code.gs)
const APP_NAME = 'CAP Readiness Hub';

// --- FEEDBACK CATEGORIES ---
// Used by the feedback submission form in ReferenceModal
const FEEDBACK_CATEGORIES = [
  { id: 'bug', label: 'Bug Report', icon: 'Bug', description: 'Something is not working correctly' },
  { id: 'feature', label: 'Feature Request', icon: 'Lightbulb', description: 'Suggest a new feature or improvement' },
  { id: 'data-issue', label: 'Data Issue', icon: 'Database', description: 'Incorrect or missing data' },
  { id: 'ui-ux', label: 'UI/UX Feedback', icon: 'Palette', description: 'Improve the look or usability' },
  { id: 'question', label: 'Question', icon: 'HelpCircle', description: 'Ask how something works' },
  { id: 'other', label: 'Other', icon: 'MessageSquare', description: 'General feedback' }
];

const DUTY_TO_TRACK_MAP = {
  "AEROSPACE EDUCATION OFFICER": "AEROSPACE", "CYBER EDUCATION OFFICER": "AEROSPACE", "DIRECTOR OF AEROSPACE EDUCATION": "AEROSPACE",
  "DEPUTY COMMANDER FOR CADETS": "CADET PROGRAMS", "ACTIVITIES OFFICER": "CADET PROGRAMS", "DRUG DEMAND REDUCTION OFFICER": "CADET PROGRAMS", "FITNESS OFFICER": "CADET PROGRAMS", "SQUADRON LEADERSHIP OFFICER": "CADET PROGRAMS", "LEADERSHIP OFFICER": "CADET PROGRAMS", "DIRECTOR OF CADET PROGRAMS": "CADET PROGRAMS",
  "COMMANDER": "COMMAND",
  "HISTORIAN": "HISTORIAN",
  "HEALTH SERVICES OFFICER": "HEALTH SERVICES", "DIRECTOR OF HEALTH SERVICES": "HEALTH SERVICES",
  "COMMUNICATIONS OFFICER": "COMMUNICATIONS", "DIRECTOR OF COMMUNICATIONS": "COMMUNICATIONS",
  "DISASTER PREPAREDNESS OFFICER": "EMERGENCY SERVICES", "EMERGENCY SERVICES OFFICER": "EMERGENCY SERVICES", "EMERGENCY SERVICES TRAINING OFFICER": "EMERGENCY SERVICES", "SEARCH AND RESCUE OFFICER": "EMERGENCY SERVICES", "DIRECTOR OF EMERGENCY SERVICES": "EMERGENCY SERVICES",
  "FINANCE OFFICER": "FINANCE", "DIRECTOR OF FINANCE": "FINANCE",
  "LEGAL OFFICER": "LEGAL",
  "INFORMATION TECHNOLOGIES OFFICER": "INFORMATION TECHNOLOGY", "WEB SECURITY ADMIN": "INFORMATION TECHNOLOGY", "DIRECTOR OF INFORMATION TECHNOLOGY": "INFORMATION TECHNOLOGY",
  "LOGISTICS OFFICER": "LOGISTICS", "MAINTENANCE OFFICER": "LOGISTICS", "SUPPLY OFFICER": "LOGISTICS", "TRANSPORTATION OFFICER": "LOGISTICS", "DIRECTOR OF LOGISTICS": "LOGISTICS",
  "PUBLIC AFFAIRS OFFICER": "PUBLIC AFFAIRS", "DIRECTOR OF PUBLIC AFFAIRS": "PUBLIC AFFAIRS",
  "RECRUITING OFFICER": "RECRUITING AND RETENTION", "RETENTION OFFICER": "RECRUITING AND RETENTION", "RECRUITING AND RETENTION OFFICER": "RECRUITING AND RETENTION", "DIRECTOR OF RECRUITING AND RETENTION": "RECRUITING AND RETENTION",
  "ALERTING OFFICER": "OPERATIONS", "HOMELAND SECURITY OFFICER": "OPERATIONS", "OPERATIONS OFFICER": "OPERATIONS", "SMALL UNMANNED AERIAL SYSTEMS OFFICER": "OPERATIONS", "DIRECTOR OF OPERATIONS": "OPERATIONS",
  "PERSONNEL OFFICER": "PERSONNEL", "DIRECTOR OF PERSONNEL": "PERSONNEL",
  "ADMINISTRATIVE OFFICER": "ADMINISTRATION", "DIRECTOR OF ADMINISTRATION": "ADMINISTRATION",
  "EDUCATION AND TRAINING OFFICER": "PROFESSIONAL DEVELOPMENT", "TESTING OFFICER": "PROFESSIONAL DEVELOPMENT", "DIRECTOR OF PROFESSIONAL DEVELOPMENT": "PROFESSIONAL DEVELOPMENT", "DIRECTOR OF EDUCATION AND TRAINING": "PROFESSIONAL DEVELOPMENT",
  "SAFETY OFFICER": "SAFETY", "DIRECTOR OF SAFETY": "SAFETY",
  "STANDARDIZATION AND EVALUATION OFFICER": "STANDARDS AND EVALUATIONS", "STANDARDIZATION/EVALUATION OFFICER": "STANDARDS AND EVALUATIONS", "DIRECTOR OF STANDARDIZATION AND EVALUATION": "STANDARDS AND EVALUATIONS",
  "INSPECTOR GENERAL": "INSPECTOR GENERAL",
  "CHAPLAIN": "CHAPLAIN",
  "CHARACTER DEVELOPMENT INSTRUCTOR": "CHARACTER DEVELOPMENT"
};

// Specialty Track Display Name Normalization
// Maps track names as they appear in data to clean display names
const normalizeTrackDisplayName = (trackName) => {
  if (!trackName) return trackName;
  const upperName = trackName.toUpperCase().trim();

  // Remove " OFFICER" suffix from Information Technology
  if (upperName === 'INFORMATION TECHNOLOGY OFFICER') {
    return 'INFORMATION TECHNOLOGY';
  }

  // Return original name for all other tracks
  return trackName;
};

// Emergency Services Color Scheme
const ES_STATUS_COLORS = {
  'ACTIVE': { bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-300', badge: 'green' },
  'TRAINING': { bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-300', badge: 'amber' },
  'EXPIRED': { bg: 'bg-rose-100', text: 'text-rose-800', border: 'border-rose-300', badge: 'red' },
  'NOT_APPROVED': { bg: 'bg-slate-100', text: 'text-slate-600', border: 'border-slate-300', badge: 'gray' }
};

// Well-known ES Achievement IDs
const ES_ACHIEVEMENT_IDS = {
  GES: '53',           // General Emergency Services
  SET: '217',          // Skills Evaluation Technician (Note: This is actually ICUT, SET is 124)
  ICUT: '217',         // Introductory Communications User Training
  SET_ACTUAL: '124',   // Skills Evaluator Training
  VFR_PILOT: '44',     // VFR Pilot
  MISSION_SCANNER: '55', // Mission Scanner
  GTL: '69',           // Ground Team Leader
  IC3: '61',           // Incident Commander Level 3
  DRIVERS_LICENSE: '211', // CAP Drivers License
  BCUT: '212',         // Basic Communications User Training (Outdated)
  ACUT: '213'          // Advanced Communications User Training (Outdated)
};

// ES Functional Area Display Names
const ES_FUNCTIONAL_AREAS = {
  'OPS-Emergency_Services': 'Emergency Services',
  'OPS-CAPPilot': 'CAP Pilot',
  'OPS-CAPPilot_OLD': 'CAP Pilot (Outdated)',
  'OPS-Emergency_Services_SAR': 'Search & Rescue',
  'OPS-Emergency_Services_DR': 'Disaster Relief',
  'OPS-DriversLicense': 'Drivers License',
  'Communications': 'Communications',
  'Cadet_Programs': 'Cadet Programs',
  'ET-Senior': 'Education & Training - Senior',
  'OPS-CounterDrug': 'Counter Drug',
  'OPS-ARCHER': 'ARCHER',
  'OPS-CISM': 'CISM',
  'OPS-OPSEC': 'OPSEC',
  'OPS-NOCAUG': 'NOC Augmentee',
  'OPS-K9Handler': 'K9 Handler'
};

// ES Qualifications to EXCLUDE from display (badges, patches, IS/ICS courses, etc.)
// These are achievement IDs that should NOT be shown in the ES qualifications section
const ES_EXCLUDED_ACHIEVEMENT_IDS = new Set([
  // Badges and Patches
  '197', // CAP Emergency Services Patch
  '199', // CAP Master Ground Team Badge
  '200', // CAP Senior Ground Team Badge
  '201', // CAP Basic Ground Team Badge
  '202', // CAP Master Emergency Services Qualification Badge
  '203', // CAP Senior Emergency Services Qualification Badge
  '204', // CAP Basic Emergency Services Qualification Badge
  '241', // Basic Incident Commander Badge
  '242', // Senior Incident Commander Badge
  '243', // Master Incident Commander Badge
  '205', // CAP Master Observer Rating
  '206', // CAP Senior Observer Rating
  '207', // CAP Observer Rating
  '238', // CAP Aircrew Rating
  '239', // CAP Senior Aircrew Rating
  '240', // CAP Master Aircrew Rating

  // IS and ICS Courses
  '176', // IS100 - IS-100
  '177', // IS200 - IS-200
  '178', // ICS300 - ICS-300
  '179', // ICS400 - ICS-400
  '180', // IS700 - IS-700
  '181', // IS800 - IS-800
  '267', // IS3 - IS-3 Radiological Emergency Management
  '268', // IS5.A - IS-5A An Introduction to Hazardous Materials
  '270', // IS368 - IS-368
  '271', // IS405 - IS-405
  '272', // IS505 - IS-505
  '273', // IS520 - IS-520

  // ET-Senior Levels
  '96',  // Level 1
  '131', // Level II
  '132', // Level III
  '133', // Level IV
  '134', // Level V

  // Outdated Communications (BCUT and ACUT - keep ICUT)
  '212', // BCUT - Basic Communications User Training
  '213', // ACUT - Advanced Communications User Training

  // Cadet Programs
  '95',  // Achievement 1 (Curry)

  // CAP Pilot OLD qualifications (CAPPILOT_OLD functional area)
  '220', // Instructor Pilot - G1000 (CAP Trained) (OLD)
  '221', // Check Pilot - G1000 (CAP Trained) (OLD)
  '223'  // Instrument Pilot - G1000 (CAP Trained) (OLD)
]);

// Functional areas to EXCLUDE from ES qualifications display
const ES_EXCLUDED_FUNCTIONAL_AREAS = new Set([
  'OPS-CAPPilot',      // All CAP Pilot qualifications (handled by check pilots/instructor pilots)
  'OPS-CAPPilot_OLD',  // Outdated CAP Pilot qualifications
  'Cadet_Programs',    // Cadet Programs (like Achievement 1)
  'ET-Senior'          // Education & Training Senior Levels
]);

// Qualifications that CAN have Skills Evaluators
// Only actual ES qualifications, not badges/patches/pilot ratings
const ES_SKILLS_EVALUATOR_ALLOWED_FUNCTIONAL_AREAS = new Set([
  'OPS-Emergency_Services',
  'Communications' // Only ICUT in this area is allowed
]);

// ES Prerequisite Special Cases
// Some qualifications have OR logic or conditional requirements based on member type
// These are documented here for reference and future implementation
const ES_PREREQUISITE_SPECIAL_CASES = {
  // VFR Pilot: Requires Basic Medical OR Basic Medical Military Waiver
  '44': {
    name: 'VFR Pilot',
    specialPrereqs: [
      { type: 'OR', options: ['246', '247'] } // Basic Medical OR Basic Medical Military Waiver
    ]
  },
  // GES: Requires Level 1 for seniors OR Achievement 1 for cadets
  '53': {
    name: 'GES - General Emergency Services',
    specialPrereqs: [
      { type: 'CONDITIONAL_MEMBER_TYPE', senior: '96', cadet: '95' }, // Level 1 (seniors) OR Achievement 1 (cadets)
      { type: 'TASK', taskID: '131' } // CAP Test 116 ICS 100
    ]
  },
  // Planning Section Chief: Requires AOBD OR GBD, with cross-training requirement
  '64': {
    name: 'PSC - Planning Section Chief',
    specialPrereqs: [
      {
        type: 'OR_WITH_CROSS_TRAINING',
        options: [
          { achvID: '67', crossTraining: ['70', '71'] }, // AOBD + (GTM3 OR UDF)
          { achvID: '68', crossTraining: ['55'] }  // GBD + Mission Scanner
        ]
      }
    ]
  },
  // UASMP - sUAS Mission Pilot: Requires FAA Part 107 and Form 5U
  '257': {
    name: 'UASMP - sUAS Mission Pilot',
    specialPrereqs: [
      { type: 'TASK', taskID: '1502' }, // FAA Part 107 Remote Pilot Certification
      { type: 'TASK', taskID: '1544' }  // Form 5U - Current and valid Form 5U
    ]
  }
};

// ES Age Requirements
// Defines minimum age requirements for ES qualifications
// Based on CAP regulations (CAPR 60-1, CAPR 60-3)
// Only includes qualifications with explicit age requirements in regulations
const ES_AGE_REQUIREMENTS = {
  // Airborne Operations (18+ years - required for all flight operations)
  '55': 18,   // MS - Mission Scanner
  '56': 18,   // TMP - Transport Mission Pilot
  '57': 18,   // MP - SAR/DR Mission Pilot
  '81': 18,   // MO - Mission Observer
  '193': 18,  // AP - Airborne Photographer

  // Ground Operations (18+ years)
  '69': 18,   // GTL - Ground Team Leader
  '68': 18,   // GBD - Ground Branch Director

  // Flight Line Operations (18+ years)
  '73': 18,   // FLS - Flight Line Supervisor

  // Mission Staff (18+ years)
  '72': 18,   // PIO - Public Information Officer
  '78': 18,   // LO - Liaison Officer

  // Section Chiefs (21+ years - ICS leadership positions)
  '63': 21,   // OSC - Operations Section Chief
  '64': 21,   // PSC - Planning Section Chief
  '65': 21,   // LSC - Logistics Section Chief
  '66': 21,   // FASC - Finance/Admin Section Chief

  // Incident Command (21+ years - senior leadership)
  '61': 21,   // IC3 - Incident Commander Level 3
  '125': 21,  // IC2 - Incident Commander Level 2
  '128': 21,  // IC1 - Incident Commander Level 1

  // Mission Safety (21+ years - safety leadership)
  '77': 21,   // MSO - Mission Safety Officer

  // Transportation (18+ years - driving requirement)
  '211': 18   // CAP Drivers License
};

// Special handling qualifications for dashboard
const ES_DASHBOARD_SPECIAL = {
  GES: '53',           // Show in red if missing, hide if completed
  OPSEC: '169',        // Show in red if missing, hide if completed
  SE_TRAINING: '124',  // SET - Skills Evaluator Training - hide on senior dashboard
  CD_COUNTERDRUG: '112' // CD - Counterdrug - hide on senior dashboard
};

// Qualifications that cannot have Skills Evaluators
// Note: sUASMP excluded because it's a pilot/aircrew qual and SET tracking is outside this app's scope
const ES_NO_SKILLS_EVALUATOR_IDS = new Set([
  '53',  // GES - General Emergency Services
  '124', // SET - Skills Evaluator Training itself
  '182', // WS - Water Survival
  '186', // FRO - Flight Release Officer
  '187', // SMC/BISC - AFRCC SAR Management Course
  '188', // SPC - National Inland SAR Planning Course
  '189', // WAO - Wing Alert Officer
  '190', // UAO - Unit Alert Officer
  '248', // SFRO - Senior Flight Release Officer
  '250', // PODC - Point of Distribution Course
  '257'  // UASMP - sUAS Mission Pilot (pilot qual, SET tracking outside app scope)
]);

// Non-expiring qualifications to exclude from profile (except GES which is special)
const ES_NON_EXPIRING_EXCLUSIONS = new Set([
  '198', // CAP CN Observer
  '187', // SMC/BISC - AFRCC SAR Management Course
  '188'  // SPC - National Inland SAR Planning Course
  // Add more as needed
]);

// ES Team Composition Requirements (based on CAPR 60-3)
// Defines minimum team composition for operational missions
const ES_TEAM_REQUIREMENTS = {
  fieldOps: {
    name: 'Field Operations',
    shortName: 'Field',
    icon: 'Users',
    description: 'Ground teams and urban direction finding',
    // Ground Team: 1 GTL + 3 GTM minimum (4-person team)
    // UDF: 2 UDF-qualified members minimum
    achvIDs: {
      GTL: '69',   // Ground Team Leader
      GTM1: '127', // Ground Team Member Level 1
      GTM2: '126', // Ground Team Member Level 2
      GTM3: '70',  // Ground Team Member Level 3
      UDF: '71',   // Urban Direction Finding
      GBD: '68'    // Ground Branch Director
    },
    // Any of these count as GTM for team composition
    gtmAchvIDs: ['70', '126', '127']
  },
  aircrew: {
    name: 'Aircrew',
    shortName: 'Air',
    icon: 'Plane',
    description: 'Airborne search and reconnaissance',
    minimum: { pilot: 1, scanner: 1 },
    preferred: { MP: 1, MO: 1, AP: 1 },
    achvIDs: {
      MP: '57',    // SAR/DR Mission Pilot
      TMP: '56',   // Transport Mission Pilot
      MS: '55',    // Mission Scanner
      MO: '81',    // Mission Observer
      AP: '193',   // Airborne Photographer
      AOBD: '67'   // Air Operations Branch Director
    },
    // Any of these count as pilot
    pilotAchvIDs: ['56', '57'],
    // Any of these count as scanner/observer
    scannerAchvIDs: ['55', '81']
  },
  suas: {
    name: 'sUAS Team',
    shortName: 'sUAS',
    icon: 'Camera',
    description: 'Small Unmanned Aerial Systems team',
    minimum: { UASMP: 1, UAST: 1 },
    achvIDs: {
      UASMP: '257', // sUAS Mission Pilot
      UAST: '258'   // sUAS Technician
    }
  },
  missionBase: {
    name: 'Mission Base',
    shortName: 'Base',
    icon: 'Radio',
    description: 'Mission base operations staff',
    positions: [
      { code: 'MSA', name: 'Mission Staff Assistant', achvID: '80' },
      { code: 'MRO', name: 'Mission Radio Operator', achvID: '76' },
      { code: 'CUL', name: 'Communications Unit Leader', achvID: '75' },
      { code: 'FLM', name: 'Flight Line Marshaller', achvID: '74' },
      { code: 'FLS', name: 'Flight Line Supervisor', achvID: '73' },
      { code: 'PIO', name: 'Public Information Officer', achvID: '72' },
      { code: 'LO', name: 'Liaison Officer', achvID: '78' },
      { code: 'MSO', name: 'Mission Safety Officer', achvID: '77' }
    ],
    // Minimum positions for a functional mission base
    minimumPositions: ['MSA', 'MRO']
  },
  command: {
    name: 'Command Staff',
    shortName: 'Cmd',
    icon: 'Shield',
    description: 'Incident command and section chiefs',
    positions: [
      // Incident Commanders (hierarchical)
      { code: 'IC3', name: 'Incident Commander Level 3', achvID: '61', tier: 1 },
      { code: 'IC2', name: 'Incident Commander Level 2', achvID: '125', tier: 2 },
      { code: 'IC1', name: 'Incident Commander Level 1', achvID: '128', tier: 3 },
      // Section Chiefs
      { code: 'OSC', name: 'Operations Section Chief', achvID: '63', section: true },
      { code: 'PSC', name: 'Planning Section Chief', achvID: '64', section: true },
      { code: 'LSC', name: 'Logistics Section Chief', achvID: '65', section: true },
      { code: 'FASC', name: 'Finance/Admin Section Chief', achvID: '66', section: true },
      // Branch Directors
      { code: 'GBD', name: 'Ground Branch Director', achvID: '68', branch: true },
      { code: 'AOBD', name: 'Air Operations Branch Director', achvID: '67', branch: true }
    ],
    // Any IC qualifies
    icAchvIDs: ['61', '125', '128'],
    // Section chief IDs
    sectionChiefAchvIDs: ['63', '64', '65', '66']
  }
};

// Reverse lookup: Achievement ID to position code
const ES_ACHV_TO_POSITION = {
  // Ground
  '69': 'GTL', '127': 'GTM1', '126': 'GTM2', '70': 'GTM3', '71': 'UDF', '68': 'GBD',
  // Air
  '57': 'MP', '56': 'TMP', '55': 'MS', '81': 'MO', '193': 'AP', '67': 'AOBD',
  // sUAS
  '257': 'UASMP', '258': 'UAST',
  // Mission Base
  '80': 'MSA', '76': 'MRO', '74': 'FLM', '73': 'FLS', '72': 'PIO', '78': 'LO', '77': 'MSO', '75': 'CUL',
  // Command
  '66': 'FASC', '65': 'LSC', '61': 'IC3', '125': 'IC2', '128': 'IC1', '63': 'OSC', '64': 'PSC',
  // Foundational
  '53': 'GES', '124': 'SET'
};

// Position code to Achievement ID lookup
const ES_POSITION_TO_ACHV = Object.fromEntries(
  Object.entries(ES_ACHV_TO_POSITION).map(([k, v]) => [v, k])
);

// ES Readiness Score Weights (fixed weights per user preference)
const ES_READINESS_WEIGHTS = {
  teamCapability: 0.35,      // Can field required teams
  qualificationHealth: 0.25, // Active vs expired ratio
  evaluatorCoverage: 0.15,   // SET evaluator availability
  riskMitigation: 0.15,      // No single points of failure
  pipelineStrength: 0.10     // Members in training
};

// ES Readiness Rating Thresholds
const ES_READINESS_THRESHOLDS = {
  excellent: 80,  // 80+ is excellent
  good: 65,       // 65-79 is good
  fair: 50        // 50-64 is fair, below 50 is needs-attention
};

// Communications duty positions (for ICUT Skills Evaluator requirement)
const COMMUNICATIONS_DUTY_POSITIONS = new Set([
  'DIRECTOR OF COMMUNICATIONS',
  'COMMUNICATIONS OFFICER',
  'CADET COMMUNICATIONS OFFICER'
]);

// Cadet program constants
const CADET_ACHIEVEMENT_TO_RANK = {
  "1": "C/Amn", "2": "C/A1C", "3": "C/SrA",
  "4": "C/SSgt", "5": "C/TSgt", "6": "C/MSgt", "7": "C/SMSgt", "8": "C/CMSgt",
  "9": "C/CMSgt", "10": "C/2d Lt", "11": "C/2d Lt", "12": "C/1st Lt", "13": "C/1st Lt",
  "14": "C/Capt", "15": "C/Capt", "16": "C/Capt", "17": "C/Maj", "18": "C/Maj", "19": "C/Maj",
  "20": "C/Lt Col", "21": "C/Col"
};

const CADET_PHASES = {
  1: { name: "Phase I (Learning)", achievements: [1, 2, 3], milestoneAchv: 4, milestoneName: "Wright Brothers" },
  2: { name: "Phase II (Leadership)", achievements: [5, 6, 7, 8, 9], milestoneAchv: 10, milestoneName: "Billy Mitchell", requiresEncampment: true },
  3: { name: "Phase III (Command)", achievements: [11, 12, 13], milestoneAchv: 14, milestoneName: "Amelia Earhart" },
  4: { name: "Phase IV (Executive)", achievements: [15, 16, 17, 18, 19], milestoneAchv: 20, milestoneName: "Ira C. Eaker", requiresCLS: true },
  5: { name: "Spaatz Award", achievements: [], milestoneAchv: 21, milestoneName: "Carl A. Spaatz" }
};

const CADET_MILESTONE_ACHIEVEMENTS = [4, 10, 14, 20, 21]; // Wright Brothers, Mitchell, Earhart, Eaker, Spaatz

// Achievement ID to Pioneer Last Name mapping (for non-milestone achievements)
const CADET_ACHIEVEMENT_PIONEERS = {
  "1": "Curry",
  "2": "Arnold",
  "3": "Feik",
  "5": "Rickenbacker",
  "6": "Doolittle",
  "7": "Goddard",
  "8": "Armstrong",
  "9": "Brown",
  "11": "Boyd",
  "12": "Ride"
};

// Achievement ID to Achievement Name mapping (based on eServices data)
const CADET_ACHIEVEMENT_NAMES = {
  "1": "Achievement 1",
  "2": "Achievement 2",
  "3": "Achievement 3",
  "4": "Wright Brothers",
  "5": "Achievement 4",
  "6": "Achievement 5",
  "7": "Achievement 6",
  "8": "Achievement 7",
  "9": "Achievement 8",
  "10": "Billy Mitchell",
  "11": "Achievement 9",
  "12": "Achievement 10",
  "13": "Achievement 11",
  "14": "Amelia Earhart",
  "15": "Achievement 12",
  "16": "Achievement 13",
  "17": "Achievement 14",
  "18": "Achievement 15",
  "19": "Achievement 16",
  "20": "Gen Ira C Eaker",
  "21": "Gen Carl A Spaatz"
};

// Map CadetAchvID to public achievement number
const CADET_PUBLIC_ACHIEVEMENT_NUMBERS = {
  "1": 1, "2": 2, "3": 3,
  "5": 4, "6": 5, "7": 6, "8": 7, "9": 8,
  "11": 9, "12": 10, "13": 11,
  "15": 12, "16": 13, "17": 14, "18": 15, "19": 16
};

// Achievement ID to Rank Insignia URL mapping
// Note: Using Google Drive thumbnail API format for proper image embedding
// Achievements 9, 11, 13, 15, 16, 18, 19 don't award new ranks (N/A), so they show current rank insignia
//
// IMPORTANT FOR PUBLIC RELEASE:
// These Google Drive file IDs point to cadet rank insignia images.
// For your own deployment, you have two options:
// 1. Upload your own rank insignia images to Google Drive and replace the IDs below
// 2. Set these to empty strings "" to disable rank insignia display
// The thumbnail format is: https://drive.google.com/thumbnail?id=YOUR_FILE_ID&sz=w200
const CADET_RANK_INSIGNIA = {
  "1": "https://drive.google.com/thumbnail?id=167Z2v5uu9GWG8SBr_h67xVIj51AUj22s&sz=w200", // C/Amn
  "2": "https://drive.google.com/thumbnail?id=1D2s7d9kILAEKmf5WsoqCsFQ3GV6qKEZA&sz=w200", // C/A1C
  "3": "https://drive.google.com/thumbnail?id=1Yy6bs1qMLHKk1_GgkYHkRkD2NqEF2yEo&sz=w200", // C/SrA
  "4": "https://drive.google.com/thumbnail?id=12_z47ceNd8Ipao-UXzD-wI6WD0wQOzvy&sz=w200", // C/SSgt (Wright Brothers)
  "5": "https://drive.google.com/thumbnail?id=1-ItusNWLmJR5jzAQGgdTivQciPaPCS1y&sz=w200", // C/TSgt
  "6": "https://drive.google.com/thumbnail?id=1wVCkls5mJA8LCVR8C3UMW2VN_Gn2YqjS&sz=w200", // C/MSgt
  "7": "https://drive.google.com/thumbnail?id=1PbShr0Lpd4eP5IYJojxynFgW4VM-dQN7&sz=w200", // C/SMSgt
  "8": "https://drive.google.com/thumbnail?id=1MeT5Iq_ZXgicPAFhvx_nwyOhp7jWnaD2&sz=w200", // C/CMSgt
  "9": "https://drive.google.com/thumbnail?id=1MeT5Iq_ZXgicPAFhvx_nwyOhp7jWnaD2&sz=w200", // Achievement 8 - N/A rank (keeps C/CMSgt)
  "10": "https://drive.google.com/thumbnail?id=18uWgxCSwESqSQ5kxI066uu1lMiKyKp9Q&sz=w200", // C/2dLt (Billy Mitchell)
  "11": "https://drive.google.com/thumbnail?id=18uWgxCSwESqSQ5kxI066uu1lMiKyKp9Q&sz=w200", // Achievement 9 - N/A rank (keeps C/2dLt)
  "12": "https://drive.google.com/thumbnail?id=1Ei_WCpLRL2aG4yBCNDPU3uupj9kg-q6D&sz=w200", // C/1stLt (Achievement 10)
  "13": "https://drive.google.com/thumbnail?id=1Ei_WCpLRL2aG4yBCNDPU3uupj9kg-q6D&sz=w200", // Achievement 11 - N/A rank (keeps C/1stLt)
  "14": "https://drive.google.com/thumbnail?id=1ofimebcDTSezpjFx1p5Km4JxKASQ6_da&sz=w200", // C/Capt (Amelia Earhart)
  "15": "https://drive.google.com/thumbnail?id=1ofimebcDTSezpjFx1p5Km4JxKASQ6_da&sz=w200", // Achievement 12 - N/A rank (keeps C/Capt)
  "16": "https://drive.google.com/thumbnail?id=1ofimebcDTSezpjFx1p5Km4JxKASQ6_da&sz=w200", // Achievement 13 - N/A rank (keeps C/Capt)
  "17": "https://drive.google.com/thumbnail?id=1BqEUaSAeFpWBbYGZKsN2uDjLbsbqOWv9&sz=w200", // C/Maj (Achievement 14)
  "18": "https://drive.google.com/thumbnail?id=1BqEUaSAeFpWBbYGZKsN2uDjLbsbqOWv9&sz=w200", // Achievement 15 - N/A rank (keeps C/Maj)
  "19": "https://drive.google.com/thumbnail?id=1BqEUaSAeFpWBbYGZKsN2uDjLbsbqOWv9&sz=w200", // Achievement 16 - N/A rank (keeps C/Maj)
  "20": "https://drive.google.com/thumbnail?id=1TnqlPKUWiSGe4nfANyj-FB0c5-i585r8&sz=w200", // C/LtCol (Gen Ira C Eaker)
  "21": "https://drive.google.com/thumbnail?id=14GxKhbIbwq5p16CwmRGubkZDjqSNvVSS&sz=w200"  // C/Col (Gen Carl A Spaatz)
};

const CADET_TIME_IN_GRADE_DAYS = 56; // 8 weeks
const CADET_MIN_TEST_SCORE = 80; // 80% minimum passing

// Cadet promotion requirement labels (single source of truth for UI text)
const CADET_REQUIREMENT_LABELS = {
  timeInGrade: 'Time in Grade (8 weeks)',
  physicalFitness: {
    early: 'Physical Fitness (HFZ attempted within 180 days)',
    standard: 'Physical Fitness (HFZ passed within 180 days)'
  },
  activeParticipation: 'Active',
  cadetOath: 'Oath',
  characterDevelopment: 'Character Development',
  leadershipTest: 'Leadership Test (80%+)',
  aerospaceTest: 'Aerospace Test (80%+)',
  drillTest: 'Drill & Ceremonies',
  sdaService: 'SDA: Service',
  sdaPresentation: 'SDA: Presentation',
  sdaWriting: 'SDA: Writing',
  leadershipExpectations: 'Leadership Expectations',
  uniformWear: 'Uniform',
  leadershipFeedback: 'Leadership Feedback',
  cadetWingmanCourse: 'Cadet Wingman Course',
  wrightBrothersLeadershipExam: 'Comprehensive Exam: Learn to Lead Ch. 1-3',
  mitchellLeadershipExam: 'Comprehensive Exam: Learn to Lead Ch. 4-8',
  mitchellAerospaceExam: 'Comprehensive Exam: Aerospace Dimensions 1-7',
  encampment: 'Encampment (Required)',
  earhartLeadershipExam: 'Comprehensive Exam: Learn to Lead Ch. 9-11',
  eakerSpeech: 'Speech',
  eakerEssay: 'Essay',
  cls: 'Cadet Leadership School (RCLS/COS)',
  spaatzLeadershipExam: 'Comprehensive Exam: Learn to Lead Ch. 1-16',
  spaatzJOFExam: 'Comprehensive Exam: Journey of Flight',
  spaatzEssay: 'Essay',
  spaatzCFA: 'USAFA Candidate Fitness Assessment'
};

// Default requirement set if an achievement ID is missing from the map
const CADET_DEFAULT_REQUIREMENTS = [
  'physicalFitness', 'activeParticipation', 'cadetOath', 'characterDevelopment', 'timeInGrade'
];

// Cadet promotion requirements by achievement ID
const CADET_ACHIEVEMENT_REQUIREMENTS = {
  "1": [
    'leadershipTest', 'drillTest', 'leadershipExpectations', 'cadetWingmanCourse',
    'physicalFitness', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "2": [
    'leadershipTest', 'aerospaceTest', 'drillTest', 'leadershipExpectations', 'uniformWear',
    'physicalFitness', 'characterDevelopment', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "3": [
    'leadershipTest', 'aerospaceTest', 'drillTest', 'leadershipExpectations', 'uniformWear',
    'physicalFitness', 'characterDevelopment', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "4": [
    'wrightBrothersLeadershipExam', 'leadershipFeedback', 'leadershipExpectations', 'uniformWear',
    'physicalFitness', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "5": [
    'leadershipTest', 'aerospaceTest', 'drillTest', 'leadershipExpectations', 'uniformWear',
    'physicalFitness', 'characterDevelopment', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "6": [
    'leadershipTest', 'aerospaceTest', 'drillTest', 'leadershipExpectations', 'uniformWear',
    'physicalFitness', 'characterDevelopment', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "7": [
    'leadershipTest', 'aerospaceTest', 'drillTest', 'leadershipExpectations', 'uniformWear',
    'physicalFitness', 'characterDevelopment', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "8": [
    'leadershipTest', 'aerospaceTest', 'drillTest', 'leadershipExpectations', 'uniformWear',
    'physicalFitness', 'characterDevelopment', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "9": [
    'leadershipTest', 'aerospaceTest', 'drillTest', 'leadershipExpectations', 'uniformWear',
    'physicalFitness', 'characterDevelopment', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "10": [
    'mitchellLeadershipExam', 'mitchellAerospaceExam', 'encampment', 'leadershipFeedback',
    'leadershipExpectations', 'uniformWear', 'physicalFitness', 'characterDevelopment',
    'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "11": [
    'leadershipTest', 'aerospaceTest', 'sdaService', 'sdaPresentation', 'sdaWriting',
    'leadershipExpectations', 'uniformWear', 'physicalFitness', 'characterDevelopment',
    'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "12": [
    'leadershipTest', 'sdaService', 'sdaPresentation', 'sdaWriting',
    'leadershipExpectations', 'uniformWear', 'physicalFitness', 'characterDevelopment',
    'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "13": [
    'leadershipTest', 'sdaService', 'sdaPresentation', 'sdaWriting',
    'leadershipExpectations', 'uniformWear', 'physicalFitness', 'characterDevelopment',
    'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "14": [
    'earhartLeadershipExam', 'leadershipFeedback', 'leadershipExpectations', 'uniformWear',
    'physicalFitness', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "15": [
    'leadershipTest', 'sdaService', 'sdaPresentation', 'sdaWriting',
    'leadershipExpectations', 'uniformWear', 'physicalFitness', 'characterDevelopment',
    'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "16": [
    'leadershipTest', 'sdaService', 'sdaPresentation', 'sdaWriting',
    'leadershipExpectations', 'uniformWear', 'physicalFitness', 'characterDevelopment',
    'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "17": [
    'leadershipTest', 'aerospaceTest', 'sdaService', 'sdaPresentation', 'sdaWriting',
    'leadershipExpectations', 'uniformWear', 'physicalFitness', 'characterDevelopment',
    'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "18": [
    'leadershipTest', 'aerospaceTest', 'sdaService', 'sdaPresentation', 'sdaWriting',
    'leadershipExpectations', 'uniformWear', 'physicalFitness', 'characterDevelopment',
    'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "19": [
    'leadershipTest', 'aerospaceTest', 'sdaService', 'sdaPresentation', 'sdaWriting',
    'leadershipExpectations', 'uniformWear', 'physicalFitness', 'characterDevelopment',
    'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "20": [
    'leadershipTest', 'eakerSpeech', 'eakerEssay', 'cls', 'leadershipFeedback',
    'leadershipExpectations', 'uniformWear', 'physicalFitness', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ],
  "21": [
    'spaatzLeadershipExam', 'spaatzJOFExam', 'spaatzEssay', 'spaatzCFA',
    'leadershipExpectations', 'uniformWear', 'characterDevelopment', 'activeParticipation', 'cadetOath', 'timeInGrade'
  ]
};

// Task IDs for cadet leadership expectations by achievement ID
const CADET_LEADERSHIP_EXPECTATIONS_TASKS = {
  "1": "451",
  "2": "458",
  "3": "461",
  "4": "503",
  "5": "464",
  "6": "467",
  "7": "470",
  "8": "473",
  "9": "476",
  "10": "506",
  "11": "479",
  "12": "482",
  "13": "485",
  "14": "509",
  "15": "488",
  "16": "491",
  "17": "494",
  "18": "497",
  "19": "500",
  "20": "512",
  "21": "515"
};

// Task IDs for cadet uniform wear by achievement ID
const CADET_UNIFORM_TASKS = {
  "2": "516",
  "3": "517",
  "4": "531",
  "5": "518",
  "6": "519",
  "7": "520",
  "8": "521",
  "9": "522",
  "10": "532",
  "11": "523",
  "12": "524",
  "13": "525",
  "14": "533",
  "15": "526",
  "16": "527",
  "17": "528",
  "18": "529",
  "19": "530",
  "20": "534",
  "21": "535"
};

// Task IDs for drill and ceremonies performance tests by achievement ID
const CADET_DRILL_TASKS = {
  "1": "328",
  "2": "333",
  "3": "344",
  "4": "348",
  "5": "352",
  "6": "357",
  "7": "362",
  "8": "367",
  "9": "372"
};

// Task IDs for character forum participation by achievement ID
const CADET_CHARACTER_FORUM_TASKS = {
  "2": "340",
  "3": "345",
  "4": "353",
  "5": "358",
  "6": "363",
  "7": "368",
  "8": "376",
  "9": "400",
  "10": "406",
  "11": "412",
  "12": "419",
  "13": "424",
  "14": "429",
  "15": "434",
  "16": "439"
};

// Task IDs for cadet oath by achievement ID
const CADET_OATH_TASKS = {
  "1": "450",
  "2": "456",
  "3": "459",
  "4": "501",
  "5": "465",
  "6": "468",
  "7": "471",
  "8": "474",
  "9": "477",
  "10": "504",
  "11": "483",
  "12": "486",
  "13": "489",
  "14": "507",
  "15": "495",
  "16": "498",
  "20": "510",
  "21": "513"
};

// Task IDs for active participation by achievement ID
const CADET_ACTIVE_PARTICIPATION_TASKS = {
  "1": "449",
  "2": "457",
  "3": "460",
  "4": "502",
  "5": "466",
  "6": "469",
  "7": "472",
  "8": "475",
  "9": "478",
  "10": "505",
  "11": "484",
  "12": "487",
  "13": "490",
  "14": "508",
  "15": "496",
  "16": "499",
  "20": "511",
  "21": "514"
};

// Task IDs for leadership feedback (once per phase)
const CADET_PHASE_LEADERSHIP_FEEDBACK_TASKS = {
  1: "452",
  2: "453",
  3: "454",
  4: "455"
};

// Path IDs (PL_Paths) for cadet achievements
const CADET_ACHIEVEMENT_PATH_IDS = {
  "1": "31",
  "2": "32",
  "3": "33",
  "5": "35",
  "6": "36",
  "7": "37",
  "8": "38",
  "9": "39",
  "11": "41",
  "12": "42",
  "13": "43",
  "15": "45",
  "16": "46",
  "17": "47",
  "18": "48",
  "19": "49"
};

// Mapping of Achievement ID to Cadet Interactive Leadership Module Task IDs
// This allows the system to check BOTH old (LeadLabDateP/LeadLabScore) and new (PL_MemberTaskCredit) systems
const ACHIEVEMENT_LEADERSHIP_MODULE_TASKS = {
  '1': ['325', '326'],  // Achievement 1: Module 0 (Cadet Welcome Course) + Module 1
  '2': ['331'],         // Achievement 2: Module 2
  '3': ['342'],         // Achievement 3: Module 3
  '5': ['350'],         // Achievement 5: Module 4
  '6': ['355'],         // Achievement 6: Module 5
  '7': ['360'],         // Achievement 7: Module 6
  '8': ['365'],         // Achievement 8: Module 7
  '9': ['370'],         // Achievement 9: Module 8
  '11': ['382'],        // Achievement 11: Module 9
  '12': ['402'],        // Achievement 12: Module 10
  '13': ['408'],        // Achievement 13: Module 11
  // Note: Milestones (4, 10, 14, 20, 21) use comprehensive exams, handled separately
};

// Aerospace Dimensions modules (task IDs match PL_MemberTaskCredit)
const AEROSPACE_DIMENSIONS_MODULES = [
  { moduleNum: 1, taskId: '334', achievementId: '2', title: 'Aerospace Dimensions 1 - Introduction to Flight' },
  { moduleNum: 2, taskId: '335', achievementId: '3', title: 'Aerospace Dimensions 2 - Aircraft Systems & Airports' },
  { moduleNum: 3, taskId: '336', achievementId: '5', title: 'Aerospace Dimensions 3 - Air Environment' },
  { moduleNum: 4, taskId: '337', achievementId: '6', title: 'Aerospace Dimensions 4 - Rockets' },
  { moduleNum: 5, taskId: '338', achievementId: '7', title: 'Aerospace Dimensions 5 - Space Environment' },
  { moduleNum: 6, taskId: '339', achievementId: '8', title: 'Aerospace Dimensions 6 - Spacecraft' },
  { moduleNum: 7, taskId: '375', achievementId: '9', title: 'Aerospace Dimensions 7 - Cyber Security' }
];

// Mapping of Achievement ID to Cadet Interactive Aerospace Module Task IDs (derived from module list)
const ACHIEVEMENT_AEROSPACE_MODULE_TASKS = AEROSPACE_DIMENSIONS_MODULES.reduce((acc, module) => {
  if (!acc[module.achievementId]) acc[module.achievementId] = [];
  acc[module.achievementId].push(module.taskId);
  return acc;
}, {});

// Education & Training level definitions (splits Level 2 into two parts)
const LEVELS = [
  { id: 'L1', label: '1', name: 'Level 1', pathMatch: 'Level 1', baseLevel: 1, legacyKey: 'LV1' },
  { id: 'L2P1', label: '2.1', name: 'Level 2 Part 1', pathMatch: 'Level 2 Part 1', baseLevel: 2 },
  { id: 'L2P2', label: '2.2', name: 'Level 2 Part 2', pathMatch: 'Level 2 Part 2', fallbackMatch: 'Level 2', baseLevel: 2, legacyKey: 'LV2' },
  { id: 'L3', label: '3', name: 'Level 3', pathMatch: 'Level 3', baseLevel: 3, legacyKey: 'LV3' },
  { id: 'L4', label: '4', name: 'Level 4', pathMatch: 'Level 4', baseLevel: 4, legacyKey: 'LV4' },
  { id: 'L5', label: '5', name: 'Level 5', pathMatch: 'Level 5', baseLevel: 5, legacyKey: 'LV5' }
];
const LEVEL_ORDER = LEVELS.map(l => l.id);
const LEVEL_DISPLAY_MAP = LEVELS.reduce((acc, lvl) => { acc[lvl.id] = lvl; return acc; }, {});
const normalizeTaskName = (name = "") => (name || "").toUpperCase().replace(/[^A-Z0-9]/g, "");
const MODERATED_MODULES = {
  L2P1: [
    "Accountability and Responsibility of the Adult Leader",
    "Cadet Protection from the Senior Perspective",
    "Choosing Your Duty Assignment and Specialty Track",
    "Bringing Your Service to Civil Air Patrol"
  ],
  L2P2: [
    "Communication Fundamentals",
    "Civil Air Patrol Communication Fundamentals",
    "Mentoring",
    "Basic Drill",
    "Leadership Fundamentals",
    "Leading Volunteers"
  ],
  L3: [
    "Compliance Requirements",
    "Command Responsibility in Finance",
    "Safety and Risk Management for Squadron Level Leaders",
    "Stewardship and Risk Management",
    "Advanced Civil Air Patrol Communications",
    "Communication Skills for Command",
    "The Care and Feeding of a Member",
    "Developing Our Members",
    "Motivating and Mentoring",
    "Effective Volunteer Teams",
    "Leading People and Managing Stuff",
    "Customs, Courtesies, and Ceremonies",
    "Taking Command",
    "Squadrons and the Missions",
    "Meetings and Meeting Planning",
    "Data-Driven Decision Making",
    "Public Affairs and Branding",
    "Reaching Outside the Squadron",
    "Commander's Intent",
    "Appointing and Utilizing Staff",
    "The Role and Responsibilities of the Squadron/Flight Commander"
  ],
  L4: [
    "Developing Personal Leadership Philosophy",
    "The Role and Responsibilities of the Group Commander",
    "Maintaining High Performing Teams",
    "Engaging and Working with the Cadet Advisory Council",
    "Management Principles",
    "Mentoring Skills and Program Development",
    "Shaping Cultures of Trust and Innovation",
    "Using New Media to Communicate",
    "Boards and Board Leadership",
    "The Civil Air Patrol Safety Program for Group or Wing Level Leader",
    "Planning and Leading A Major Activity",
    "Prioritization and Time Management",
    "Recruiting and Retention",
    "Staff Processes Group Staffing",
    "Effective Communication with External Partners",
    "Leadership Challenges Today Membership Issues",
    "Group Staffing",
    "Role of the Group"
  ],
  L5: [
    "Local to the Global: A Broadened View of Civil Air Patrol",
    "Emerging Leadership Trends",
    "Committees and Teams",
    "Boards at the Region and National Level",
    "Strategic Engagement with the Cadet Advisory Council",
    "Ethical Leadership",
    "Mentoring Programs",
    "Developing Staff and Succession Planning",
    "Preparing to Serve on Region or National Staff",
    "Region Commander Roles and Responsibilities",
    "Civil Air Patrol Governance",
    "Selecting Members of the Board of Governors",
    "The Chief Operating Officer and CAP-USAF Commander Perspectives",
    "The National Commander's Perspective",
    "Operations at a Strategic Level",
    "Safety and Risk Management for Region and National Leaders",
    "Marketing and Strategic Communications",
    "Logistics and Property Management",
    "Fleet Management",
    "Logistics at the Region Level",
    "Leading Change",
    "Government Relations",
    "Financial Management",
    "Finances at the Region Level",
    "The Civil Air Patrol Strategic Plan",
    "Linking the Region to the Strategic Plan",
    "Strategic Leadership",
    "Challenging Situations and Region Command",
    "Civil Air Patrol Culture and Its Unique Challenges",
    "Capstone Project"
  ]
};
const MODERATED_LOOKUP = Object.fromEntries(
  Object.entries(MODERATED_MODULES).map(([lvl, list]) => [
    lvl,
    new Set(list.map(normalizeTaskName))
  ])
);

// Level 2 track selection and track-specific modules
const LEVEL2_TRACK_CHOICES = { "190": "CADET", "268": "MILITARY", "269": "NEW", "270": "PROFESSIONAL" };
const LEVEL2_TASK_TRACKS = {
  "16": ["ALL"], "17": ["ALL"], "18": ["ALL"], "19": ["MILITARY"], "20": ["ALL"], "21": ["NEW", "PROFESSIONAL"],
  "22": ["ALL"], "23": ["NEW", "PROFESSIONAL"], "24": ["MILITARY"], "25": ["CADET"], "26": ["NEW", "MILITARY", "PROFESSIONAL"],
  "27": ["CADET"], "28": ["NEW", "PROFESSIONAL"], "29": ["MILITARY"], "30": ["NEW"], "31": ["MILITARY"], "32": ["CADET"],
  "33": ["PROFESSIONAL"], "34": ["NEW", "PROFESSIONAL"], "35": ["CADET"], "36": ["NEW", "CADET"], "37": ["ALL"], "38": ["ALL"],
  "39": ["ALL"], "40": ["ALL"], "41": ["ALL"], "42": ["ALL"], "43": ["ALL"], "44": ["NEW", "PROFESSIONAL"], "45": ["MILITARY"],
  "46": ["ALL"], "47": ["ALL"], "49": ["ALL"], "50": ["ALL"], "51": ["MILITARY", "PROFESSIONAL"], "52": ["CADET"], "53": ["ALL"],
  "54": ["ALL"], "186": ["ALL"], "190": ["CADET"], "250": ["ALL"], "268": ["MILITARY"], "269": ["NEW"], "270": ["PROFESSIONAL"],
  "280": ["ALL"], "281": ["ALL"], "290": ["PROFESSIONAL", "MILITARY"]
};

// --- DATA CONSTANTS ---
// Configuration values for data caching, pagination, and API settings
const DATA_CONSTANTS = {
  CACHE_KEY: 'cap_data_cache_v5',
  CACHE_MAX_AGE_MS: 6 * 60 * 60 * 1000, // 6 hours in milliseconds
  ITEMS_PER_PAGE: 50,
};

// --- QUALITY UNIT AWARD (QUA) CONSTANTS ---
// Great Lakes Region Quality Unit Award for Groups, Senior Squadrons, and Composite Squadrons
// Award cycle: Fiscal Year (1 October - 30 September)
// Requirement: 7 of 10 criteria must be met (3 required + 4 from mission-specific)

// ES Operational Qualifications for QUA criterion #4
// Includes: UDF, GTM3, MS, or above (field, air, mission base, advanced)
const QUA_OPERATIONAL_ES_ACHIEVEMENT_IDS = new Set([
  // Field Operations
  '70',   // GTM3 - Ground Team Member 3
  '71',   // UDF - Unit Deputy Field
  '69',   // GTL - Ground Team Leader
  '126',  // GTM2 - Ground Team Member 2
  '127',  // GTM1 - Ground Team Member 1
  '68',   // GBD - Ground Branch Director
  '258',  // UAST - sUAS Technician
  '257',  // UASMP - sUAS Mission Pilot
  // Air Operations
  '55',   // MS - Mission Scanner
  '81',   // MO - Mission Observer
  '193',  // AP - Airborne Photographer
  '56',   // TMP - Transport Mission Pilot
  '57',   // MP - SAR/DR Mission Pilot
  '67',   // AOBD - Air Operations Branch Director
  // Mission Base Operations
  '80',   // MSA - Mission Staff Assistant
  '76',   // MRO - Mission Radio Operator
  '75',   // CUL - Communications Unit Leader
  '74',   // FLM - Flight Line Marshaller
  '73',   // FLS - Flight Line Supervisor
  '72',   // PIO - Public Information Officer
  '66',   // FASC - Finance/Admin Section Chief
  '78',   // LO - Liaison Officer
  '77',   // MSO - Mission Safety Officer
  '65',   // LSC - Logistics Section Chief
  // Advanced Leadership
  '64',   // PSC - Planning Section Chief
  '63',   // OSC - Operations Section Chief
  '61',   // IC3 - Incident Commander Level 3
  '125',  // IC2 - Incident Commander Level 2
  '128'   // IC1 - Incident Commander Level 1
]);

// Senior ranks that qualify as Captain or higher for QUA criterion #5
const QUA_CAPTAIN_OR_HIGHER_RANKS = new Set([
  'CAPT', 'CPT', 'CAPTAIN',
  'MAJ', 'MAJOR',
  'LT COL', 'LTCOL', 'LTC', 'LIEUTENANT COLONEL',
  'COL', 'COLONEL',
  'BRIG GEN', 'BG', 'BRIGADIER GENERAL',
  'MAJ GEN', 'MG', 'MAJOR GENERAL',
  'LT GEN', 'LTG', 'LIEUTENANT GENERAL',
  'GEN', 'GENERAL'
]);

// NCO ranks for SM->NCO promotion check (alternative to officer path)
const QUA_NCO_RANKS = new Set([
  'CMSGT', 'CHIEF MASTER SERGEANT', 'CHIEF MASTER SGT',
  'SMSGT', 'SENIOR MASTER SERGEANT', 'SENIOR MASTER SGT',
  'MSGT', 'MASTER SERGEANT', 'MASTER SGT',
  'TSGT', 'TECHNICAL SERGEANT', 'TECHNICAL SGT',
  'SSGT', 'STAFF SERGEANT', 'STAFF SGT',
  'SGT', 'SERGEANT'
]);

// Unit types that are eligible for QUA (Groups, Senior Squadrons, Composite Squadrons)
const QUA_ELIGIBLE_UNIT_TYPES = {
  GROUP: { type: 'GROUP', threshold: 15, label: 'Group' },
  SENIOR_SQUADRON: { type: 'SENIOR', threshold: 10, label: 'Senior Squadron' },
  COMPOSITE_SQUADRON: { type: 'COMPOSITE', threshold: 10, label: 'Composite Squadron' }
};

// Cadet Protection Training course identifiers (check within 1 year)
const QUA_CADET_PROTECTION_COURSES = [
  'Cadet Protection Basic Course',
  'Cadet Protection',
  'CPPT',
  'Cadet Protection Program Training'
];

// Yeager Award identifier for senior awards
const QUA_YEAGER_AWARD_NAME = 'YEAGER';

</script>

<script type="text/babel">
const PROMOTION_RULES = {
  "2D LT": { next: "1st Lt", tigMonths: 18, level: 2 },
  "1ST LT": { next: "Capt", tigMonths: 30, level: 3 },
  "CAPT": { next: "Maj", tigMonths: 36, level: 4 },
  "MAJ": { next: "Lt Col", tigMonths: 48, level: 5 },
  "LT COL": { next: "Col", tigMonths: 60, level: 5 },
  "FO": { next: "TFO", tigMonths: 18, level: 2 },
  "TFO": { next: "SFO", tigMonths: 30, level: 3 },
  "SFO": { next: "Capt", tigMonths: 0, level: 3 },
  "SM": { next: "2d Lt", tigMonths: 0, level: 1, requiredParts: ['L1', 'L2P1'] },
  "SSGT": { next: "TSgt", tigMonths: 12, level: 2 },
  "TSGT": { next: "MSgt", tigMonths: 24, level: 3, dutyReq: "Unit NCO", dutyMonths: 24 },
  "MSGT": { next: "SMSgt", tigMonths: 36, level: 4, dutyReq: "NCO Advisor", dutyMonths: 36 },
  "SMSGT": { next: "CMSgt", tigMonths: 48, level: 5, dutyReq: "Command NCO", dutyMonths: 48 }
};
</script>

<script type="text/babel">
const parseCSV = (text) => {
  if (!text || typeof text !== 'string') return [];
  const lines = text.split('\n').filter(l => l.trim());
  if (lines.length === 0) return [];
  const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
  return lines.slice(1).map(line => {
    const row = {};
    let currentVal = '';
    let inQuotes = false;
    let colIndex = 0;
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') inQuotes = !inQuotes;
      else if (char === ',' && !inQuotes) {
        if (colIndex < headers.length) row[headers[colIndex]] = currentVal.trim().replace(/^"|"$/g, '');
        currentVal = '';
        colIndex++;
      } else currentVal += char;
    }
    if (colIndex < headers.length) row[headers[colIndex]] = currentVal.trim().replace(/^"|"$/g, '');
    return row;
  });
};

// Parse the AdditionalOptions column from PL_MemberTaskCredit (lightweight, resilient parser)
const parseAdditionalOptions = (optionsString) => {
  if (!optionsString || typeof optionsString !== 'string') return {};
  const trimmed = optionsString.trim();
  const content = trimmed.startsWith('{') && trimmed.endsWith('}')
    ? trimmed.slice(1, -1)
    : trimmed;

  const result = {};
  content.split(',').forEach(part => {
    const [rawKey, ...rest] = part.split(':');
    if (!rawKey || !rest.length) return;
    const key = rawKey.trim();
    const rawValue = rest.join(':').trim().replace(/^"|"$/g, '');
    if (!key) return;
    if (/^(true|false)$/i.test(rawValue)) {
      result[key] = rawValue.toLowerCase() === 'true';
    } else if (rawValue !== '' && !Number.isNaN(Number(rawValue))) {
      result[key] = Number(rawValue);
    } else {
      result[key] = rawValue;
    }
  });
  return result;
};

const normalizeRank = (rank) => {
  if (!rank) return "";
  const r = rank.toUpperCase().replace(".", "").trim();
  if (r === "SENIOR MEMBER" || r === "SM") return "SM";
  if (r.includes("SECOND") || r === "2D LT") return "2D LT";
  if (r.includes("FIRST") || r === "1ST LT") return "1ST LT";
  if (r.includes("CAPTAIN")) return "CAPT";
  if (r.includes("MAJOR")) return "MAJ";
  if (r.includes("LIEUTENANT COLONEL") || r === "LT COL") return "LT COL";
  if (r.includes("COLONEL")) return "COL";
  if (r === "FLIGHT OFFICER") return "FO";
  if (r === "TECHNICAL FLIGHT OFFICER") return "TFO";
  if (r === "SENIOR FLIGHT OFFICER") return "SFO";
  if (r === "STAFF SERGEANT") return "SSGT";
  if (r === "TECHNICAL SERGEANT") return "TSGT";
  if (r === "MASTER SERGEANT") return "MSGT";
  if (r === "SENIOR MASTER SERGEANT") return "SMSGT";
  if (r === "CHIEF MASTER SERGEANT") return "CMSGT";
  return r;
};
</script>

<script type="text/babel">
// Cadet-specific utility functions
const calculateDaysSince = (dateString) => {
  if (!dateString || dateString === '01/01/1900') return null;
  const date = new Date(dateString);
  const today = new Date();
  const diffTime = Math.abs(today - date);
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
};
</script>

<script type="text/babel">
const determinePhaseFromAchievement = (achievementID) => {
  const achvId = parseInt(achievementID);
  if (!achvId) return 0;
  const phaseEntries = Object.entries(CADET_PHASES || {});
  for (const [phaseId, phase] of phaseEntries) {
    const list = [...(phase.achievements || []), phase.milestoneAchv].filter(Boolean);
    if (list.includes(achvId)) return parseInt(phaseId);
  }
  return 0;
};

const isMilestoneAchievement = (achievementID) => {
  return CADET_MILESTONE_ACHIEVEMENTS.includes(parseInt(achievementID));
};

// Get the display name for an achievement (includes special award names and pioneer names)
const getAchievementDisplayName = (achievementID) => {
  const id = achievementID?.toString();
  const baseName = CADET_ACHIEVEMENT_NAMES[id] || `Achievement ${achievementID}`;

  // Add pioneer name in parentheses for non-milestone achievements
  const pioneerName = CADET_ACHIEVEMENT_PIONEERS[id];
  if (pioneerName) {
    return `${baseName} (${pioneerName})`;
  }

  return baseName;
};

// Get the public-facing achievement number (maps CadetAchvID to public achievement numbering)
const getPublicAchievementNumber = (achievementID) => {
  const id = achievementID?.toString();
  return CADET_PUBLIC_ACHIEVEMENT_NUMBERS[id] || parseInt(achievementID) || null;
};

// Get the rank insignia URL for an achievement
const getRankInsigniaUrl = (achievementID) => {
  const id = achievementID?.toString();
  return CADET_RANK_INSIGNIA[id] || null;
};
</script>

<script type="text/babel">
// Level helpers (path ids, track selection, and status calculation)
const deriveLevelPathMap = (paths = []) => {
  const findId = (namePart) => (paths || []).find(p => (p.PathName || "").includes(namePart))?.PathID;
  const map = {};
  LEVELS.forEach(def => {
    const matchId = findId(def.pathMatch);
    if (matchId) { map[def.id] = matchId; return; }
    if (def.fallbackMatch) {
      const fallbackId = findId(def.fallbackMatch);
      if (fallbackId) map[def.id] = fallbackId;
    }
  });
  return map;
};

const determineLevel2Track = (memberTasks = []) => {
  const choices = (memberTasks || [])
    .filter(mt => LEVEL2_TRACK_CHOICES[mt.TaskID] && mt.StatusID === "8")
    .map(mt => ({
      track: LEVEL2_TRACK_CHOICES[mt.TaskID],
      completed: mt.Completed ? new Date(mt.Completed) : null,
      id: parseInt(mt.MemberTaskCreditID || mt.MemberTaskID || 0) || 0
    }));
  if (!choices.length) return null;
  choices.sort((a, b) => {
    const aTime = a.completed ? a.completed.getTime() : 0;
    const bTime = b.completed ? b.completed.getTime() : 0;
    if (aTime !== bTime) return bTime - aTime;
    return b.id - a.id;
  });
  return choices[0].track;
};

const calculateLevelsProgress = (member, configFiles, dataFiles, levelPathMap) => {
  const progress = {};
  const memberTasks = (dataFiles.memberTasks || []).filter(mt => mt.CAPID === member.CAPID);
  const memberPaths = (dataFiles.memberPaths || []).filter(mp => mp.CAPID === member.CAPID);
  const memberLegacyLevels = (dataFiles.seniorLevels || []).filter(sl => sl.CAPID === member.CAPID);

  LEVELS.forEach(def => {
    const pathId = levelPathMap[def.id];
    let totalReq = 0, totalComp = 0;

    if (pathId && (configFiles.groups || []).length > 0) {
      const groups = (configFiles.groups || []).filter(g => g.PathID === pathId);
      groups.forEach(group => {
        const req = parseInt(group.NumberOfRequiredTasks) || 0;
        if (req === 0) return;
        totalReq += req;
        const groupTaskIds = (configFiles.assignments || []).filter(a => a.GroupID === group.GroupID).map(a => a.TaskID);
        const comp = memberTasks.filter(mt => groupTaskIds.includes(mt.TaskID) && mt.StatusID === "8").length;
        totalComp += Math.min(comp, req);
      });
    }

    let percent = totalReq > 0 ? Math.round((totalComp / totalReq) * 100) : 0;
    const legacyEntry = def.legacyKey ? memberLegacyLevels.find(sl => sl.Lvl === def.legacyKey) : null;
    const creditsForPath = pathId ? memberPaths.filter(mp => mp.PathID === pathId) : [];
    const approvedCredit = creditsForPath.find(mp => mp.StatusID === "8");
    const pendingCredit = creditsForPath.find(mp => mp.StatusID === "26");
    const disapprovedCredit = creditsForPath.find(mp => mp.StatusID === "27");

    let status = 'not-started';
    let approvalStatus = null;
    let date = null;

    if (legacyEntry || approvedCredit) {
      status = 'completed';
      approvalStatus = 'approved';
      date = legacyEntry ? legacyEntry.Completed : approvedCredit.Completed;
      percent = 100;
    } else if (percent >= 100) {
      if (pendingCredit || disapprovedCredit) {
        status = 'pending';
        approvalStatus = pendingCredit ? 'pending' : 'disapproved';
        date = (pendingCredit || disapprovedCredit).Completed;
      } else {
        status = 'ready';
        approvalStatus = 'ready';
      }
    } else if (percent > 0) {
      status = 'in-progress';
    }

    progress[def.id] = {
      percent,
      status,
      approvalStatus,
      date,
      pathId,
      totalReq,
      totalComp,
      legacy: !!legacyEntry
    };
  });

  // Legacy Level 2 awards should satisfy both parts in the new split
  const legacyLevel2 = memberLegacyLevels.find(sl => sl.Lvl === 'LV2');
  if (legacyLevel2) {
    ['L2P1', 'L2P2'].forEach(id => {
      if (progress[id] && progress[id].status !== 'completed') {
        progress[id] = { ...progress[id], status: 'completed', approvalStatus: 'approved', percent: 100, date: legacyLevel2.Completed, legacy: true };
      }
    });
  }

  const baseComplete = {
    1: progress.L1 && progress.L1.status === 'completed',
    2: progress.L2P1 && progress.L2P1.status === 'completed' && progress.L2P2 && progress.L2P2.status === 'completed',
    3: progress.L3 && progress.L3.status === 'completed',
    4: progress.L4 && progress.L4.status === 'completed',
    5: progress.L5 && progress.L5.status === 'completed',
  };

  let currentLevel = 0;
  for (let lvl = 5; lvl >= 1; lvl--) {
    if (baseComplete[lvl]) { currentLevel = lvl; break; }
  }

  return { progress, currentLevel };
};

function createDataService() {
  let _rawData = {
    members: [], duty: [], tracks: [], memberTasks: [], memberPaths: [], organization: [],
    cadetDuty: [], seniorLevels: [], committees: [], contacts: [],
    cadetRank: [], cadetAchv: [], cadetAchvAprs: [], cadetAchvFullReport: [],
    cadetPhase: [], cadetAwards: [], cadetHFZ: [], cadetActivities: [],
    training: [], seniorAwards: [], oFlights: [],
    // ES Member Data
    esMbrAchievements: [], esMbrTasks: [],
    // VOLU Instructor Data
    voluInstructors: []
  };
  let _rawConfig = {
    paths: [], groups: [], tasks: [], assignments: [], lookups: [], cadetAchvEnum: [],
    // ES Config Data
    esAchievements: [], esTasks: [], esAchvStepTasks: [], esAchvStepAchv: []
  };
  let _levelPathMap = {};
  let _unitChildrenMap = new Map();
  let _esService = null;
  let _esUnitAnalysisService = null;

  const padUnit = (val) => (val || "").replace(/^0+/, '').padStart(3, '0');
  const buildUnitChildren = () => {
    const map = new Map();
    (_rawData.organization || []).forEach(o => {
      const parentId = String(o.NextLevel || "").trim();
      const childId = String(o.ORGID || "").trim();
      if (!parentId || parentId === childId) return;
      if (!map.has(parentId)) map.set(parentId, []);
      map.get(parentId).push(childId);
    });
    _unitChildrenMap = map;
  };

  const getDescendantOrgIds = (rootId) => {
    const root = String(rootId || "").trim();
    if (!root) return [];
    const results = [root];
    const queue = [root];
    const visited = new Set([root]);
    while (queue.length > 0) {
      const curr = queue.shift();
      const kids = _unitChildrenMap.get(curr) || [];
      kids.forEach(k => {
        if (!visited.has(k)) {
          visited.add(k);
          results.push(k);
          queue.push(k);
        }
      });
    }
    return results;
  };

  const findLevelPathIds = () => { _levelPathMap = deriveLevelPathMap(_rawConfig.paths || []); };

  const parsePayload = (payload) => {
    _rawConfig = {
      paths: parseCSV(payload?.config?.paths) || [],
      groups: parseCSV(payload?.config?.groups) || [],
      tasks: parseCSV(payload?.config?.tasks) || [],
      assignments: parseCSV(payload?.config?.assignments) || [],
      lookups: parseCSV(payload?.config?.lookups) || [],
      cadetAchvEnum: parseCSV(payload?.config?.cadetAchvEnum) || [],
      // ES Config
      esAchievements: parseCSV(payload?.config?.esAchievements) || [],
      esTasks: parseCSV(payload?.config?.esTasks) || [],
      esAchvStepTasks: parseCSV(payload?.config?.esAchvStepTasks) || [],
      esAchvStepAchv: parseCSV(payload?.config?.esAchvStepAchv) || []
    };
    _rawData = {
      members: parseCSV(payload?.data?.members) || [],
      duty: parseCSV(payload?.data?.duty) || [],
      tracks: parseCSV(payload?.data?.tracks) || [],
      memberTasks: parseCSV(payload?.data?.memberTasks) || [],
      memberPaths: parseCSV(payload?.data?.memberPaths) || [],
      organization: parseCSV(payload?.data?.organization) || [],
      cadetDuty: parseCSV(payload?.data?.cadetDuty) || [],
      seniorLevels: parseCSV(payload?.data?.seniorLevels) || [],
      committees: parseCSV(payload?.data?.committees) || [],
      contacts: parseCSV(payload?.data?.contacts) || [],
      cadetRank: parseCSV(payload?.data?.cadetRank) || [],
      cadetAchv: parseCSV(payload?.data?.cadetAchv) || [],
      cadetAchvAprs: parseCSV(payload?.data?.cadetAchvAprs) || [],
      cadetAchvFullReport: parseCSV(payload?.data?.cadetAchvFullReport) || [],
      cadetPhase: parseCSV(payload?.data?.cadetPhase) || [],
      cadetAwards: parseCSV(payload?.data?.cadetAwards) || [],
      cadetHFZ: parseCSV(payload?.data?.cadetHFZ) || [],
      cadetActivities: parseCSV(payload?.data?.cadetActivities) || [],
      training: parseCSV(payload?.data?.training) || [],
      seniorAwards: parseCSV(payload?.data?.seniorAwards) || [],
      oFlights: parseCSV(payload?.data?.oFlights) || [],
      // ES Member Data
      esMbrAchievements: parseCSV(payload?.data?.esMbrAchievements) || [],
      esMbrTasks: parseCSV(payload?.data?.esMbrTasks) || [],
      // VOLU Instructor Data
      voluInstructors: parseCSV(payload?.data?.voluInstructors) || []
    };
    buildUnitChildren();
    findLevelPathIds();
    // Initialize ES service with config and data
    _esService = createESDataService(_rawConfig, _rawData);
    // Initialize ES Unit Analysis service
    _esUnitAnalysisService = createESUnitAnalysisService(_rawConfig, _rawData, _esService);
  };

  const buildUnitName = (org) => {
    if (!org) return "Unknown";
    const r = org.Region || "";
    const w = org.Wing || "";
    const u = padUnit(org.Unit || "000");
    return `${r}-${w}-${u}`;
  };

  const buildLevelsProgress = (member) => {
    const { progress, currentLevel } = calculateLevelsProgress(member, _rawConfig, _rawData, _levelPathMap);
    return { levelsProgress: progress, highestLevel: currentLevel };
  };

  const buildTracks = (member) => (_rawData.tracks || [])
    .filter(t => t.CAPID === member.CAPID)
    .map(t => ({ name: t.Track, level: t.TrackLevel, date: t.DateMod }));

  const buildSeniorAwards = (member) => (_rawData.seniorAwards || [])
    .filter(a => a.CAPID === member.CAPID && a.Completed && a.Completed !== '01/01/1900')
    .map(a => ({
      award: a.Award,
      awardNo: a.AwardNo,
      completed: a.Completed,
      usrId: a.UsrID,
      dateMod: a.DateMod
    }));

  const buildDuties = (member) => (_rawData.duty || [])
    .filter(d => d.CAPID === member.CAPID)
    .map(d => {
      const org = (_rawData.organization || []).find(o => o.ORGID === d.ORGID);
      const orgString = org ? `${org.Region}-${org.Wing}-${org.Unit}` : "Unknown";
      return {
        name: d.Duty,
        isAsst: d.Asst === "1",
        date: d.DateMod,
        orgString,
        displayName: `${d.Duty}${d.Asst === "1" ? " (A)" : ""}`
      };
    });

  const applyDutyTrackWarnings = (duties, tracks) => {
    const dutiesWithStatus = duties.map(duty => {
      const cleanDuty = (duty.name || "").toUpperCase().trim();
      const requiredTrack = DUTY_TO_TRACK_MAP[cleanDuty];
      let hasTrack = true;
      let warningMsg = "";
      if (requiredTrack) {
        const hasEnrolled = tracks.some(t => {
          const trackName = (t.name || "").toUpperCase().trim();
          return trackName.includes(requiredTrack) || requiredTrack.includes(trackName);
        });
        if (!hasEnrolled) { hasTrack = false; warningMsg = `Missing Track: ${requiredTrack}`; }
      }
      return { ...duty, hasTrack, warningMsg };
    });

    const tracksWithStatus = tracks.map(track => {
      const isNone = track.level === "NONE";
      let hasDuty = true;
      let warningMsg = "";
      if (isNone) {
        const trackNameUpper = (track.name || "").toUpperCase().trim();
        const relevantDutyExists = duties.some(d => {
          const mappedTrack = DUTY_TO_TRACK_MAP[(d.name || "").toUpperCase().trim()];
          return mappedTrack === trackNameUpper;
        });
        if (!relevantDutyExists) { hasDuty = false; warningMsg = "Enrolled (NONE) but no Duty Position assigned."; }
      }
      return { ...track, hasDuty, warningMsg };
    });

    return { dutiesWithStatus, tracksWithStatus };
  };

  const getProcessedMembers = (unitFilter, includeDescendants = false) => {
    if (!_rawData.members || _rawData.members.length === 0) return [];
    const validOrgIds = includeDescendants ? getDescendantOrgIds(unitFilter) : [unitFilter];
    const validOrgSet = new Set(validOrgIds.map(id => String(id || "").trim()));
    // Senior dashboard should only show senior members (including LIFE) with ACTIVE status
    const membersInScope = _rawData.members.filter(m => {
      const type = String(m.Type || m.TYPE || "").toUpperCase();
      const isSenior = type === "SENIOR" || type === "LIFE";
      const status = String(m.MbrStatus || "").toUpperCase();
      const isActive = status === "ACTIVE";
      return isSenior && isActive && validOrgSet.has(String(m.ORGID || "").trim());
    });
    return membersInScope.map(member => {
      const org = (_rawData.organization || []).find(o => o.ORGID === member.ORGID);
      const memberUnitName = buildUnitName(org);
      const duties = buildDuties(member);
      const tracks = buildTracks(member);
      const { dutiesWithStatus, tracksWithStatus } = applyDutyTrackWarnings(duties, tracks);
      const { levelsProgress, highestLevel } = buildLevelsProgress(member);
      const level2Track = determineLevel2Track((_rawData.memberTasks || []).filter(mt => mt.CAPID === member.CAPID));
      const seniorAwards = buildSeniorAwards(member);
      const esQualifications = _esService.buildESQualifications(member, { forDashboard: true, forSenior: true });
      const esQualificationsAll = _esService.buildESQualifications(member, { forDashboard: false, forSenior: true });
      return {
        ...member,
        memberUnitName,
        duties: dutiesWithStatus,
        tracks: tracksWithStatus,
        seniorAwards,
        esQualifications,
        esQualificationsAll,
        levelsProgress,
        level2Track,
        currentLevel: highestLevel,
        rankDate: member.RankDate
      };
    });
  };

  return {
    initialize: parsePayload,
    rawData: () => _rawData,
    rawConfig: () => _rawConfig,
    getProcessedMembers,
    // ES Helper Methods
    getESAchievementTasks: (achvID, capid) => _esService.getESAchievementTasks(achvID, capid),
    buildESPrerequisiteTree: (achvID, ancestry) => _esService.buildESPrerequisiteTree(achvID, ancestry),
    checkESQualificationEligibility: (achvID, member) => _esService.checkESQualificationEligibility(achvID, member),
    getAllESAchievements: () => _esService.getAllESAchievements(),
    // ES Unit Analysis Service
    getESUnitAnalysisService: () => _esUnitAnalysisService
  };
}
</script>

<script type="text/babel">
function createCadetDataService() {
  let _rawData = {
    members: [], cadetRank: [], cadetAchv: [], cadetAchvAprs: [], cadetAchvFullReport: [],
    cadetPhase: [], cadetAwards: [], cadetHFZ: [], cadetActivities: [], cadetDuty: [],
    organization: [], cadetAchvEnum: [], memberTasks: [], memberPaths: [], oFlights: [],
    // ES Data
    esMbrAchievements: [], esMbrTasks: []
  };
  let _rawConfig = {
    cadetAchvEnum: [],
    // ES Config
    esAchievements: [], esTasks: [], esAchvStepTasks: [], esAchvStepAchv: []
  };
  let _esService = null;

  const parsePayload = (payload) => {
    // Accept already-parsed data from dataFiles (not raw CSV strings)
    _rawData = {
      members: payload?.data?.members || [],
      cadetRank: payload?.data?.cadetRank || [],
      cadetAchv: payload?.data?.cadetAchv || [],
      cadetAchvAprs: payload?.data?.cadetAchvAprs || [],
      cadetAchvFullReport: payload?.data?.cadetAchvFullReport || [],
      cadetPhase: payload?.data?.cadetPhase || [],
      cadetAwards: payload?.data?.cadetAwards || [],
      cadetHFZ: payload?.data?.cadetHFZ || [],
      cadetActivities: payload?.data?.cadetActivities || [],
      cadetDuty: payload?.data?.cadetDuty || [],
      organization: payload?.data?.organization || [],
      memberTasks: payload?.data?.memberTasks || [],
      memberPaths: payload?.data?.memberPaths || [],
      oFlights: payload?.data?.oFlights || [],
      // ES Data
      esMbrAchievements: payload?.data?.esMbrAchievements || [],
      esMbrTasks: payload?.data?.esMbrTasks || []
    };
    _rawConfig = {
      cadetAchvEnum: payload?.config?.cadetAchvEnum || [],
      // ES Config
      esAchievements: payload?.config?.esAchievements || [],
      esTasks: payload?.config?.esTasks || [],
      esAchvStepTasks: payload?.config?.esAchvStepTasks || [],
      esAchvStepAchv: payload?.config?.esAchvStepAchv || []
    };
    // Initialize ES service with config and data
    _esService = createESDataService(_rawConfig, _rawData);
  };

  const getCurrentRank = (capid) => {
    const ranks = _rawData.cadetRank.filter(r => r.CAPID === capid);
    if (!ranks.length) return null;
    ranks.sort((a, b) => new Date(b.RankDate) - new Date(a.RankDate));
    return ranks[0];
  };

  const getApprovedAchievements = (capid) => {
    return _rawData.cadetAchvAprs
      .filter(a => a.CAPID === capid && a.Status === 'APR')
      .map(a => parseInt(a.CadetAchvID))
      .sort((a, b) => a - b);
  };

  const getTimeInGrade = (rankDate) => {
    if (!rankDate || rankDate === '01/01/1900') return { days: 0, weeks: 0, isEligible: false, eligibleDate: null };
    const days = calculateDaysSince(rankDate);
    const weeks = Math.floor(days / 7);
    const isEligible = days >= CADET_TIME_IN_GRADE_DAYS;

    // Calculate the date eligible for promotion (rank date + 56 days)
    const rankDateObj = new Date(rankDate);
    const eligibleDate = new Date(rankDateObj);
    eligibleDate.setDate(eligibleDate.getDate() + CADET_TIME_IN_GRADE_DAYS);

    return {
      days,
      weeks,
      isEligible,
      eligibleDate: eligibleDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
    };
  };

  const checkHFZStatus = (capid, achievementID) => {
    const achvID = parseInt(achievementID);
    const requiresPassing = achvID >= 4; // Wright Brothers (achievement 4) and beyond require passing HFZ
    const requiresWithin180Days = achvID <= 3; // First 3 achievements only need attempt within 180 days

    // Normalize CAPID for comparison (ensure string and trim)
    const normalizedCapid = String(capid || '').trim();

    // Get all HFZ records for this cadet, sorted by date (newest first)
    // Filter out invalid dates and ensure CAPID matches
    const allHFZRecords = _rawData.cadetHFZ
      .filter(h => {
        const hfzCapid = String(h.CAPID || '').trim();
        const hasValidDate = h.DateTaken && h.DateTaken !== '01/01/1900' && h.DateTaken !== '';
        return hfzCapid === normalizedCapid && hasValidDate;
      })
      .map(h => ({
        ...h,
        isPassed: h.IsPassed === 'True' || h.IsPassed === '1' || h.IsPassed === true,
        date: h.DateTaken
      }))
      .sort((a, b) => {
        try {
          return new Date(b.DateTaken) - new Date(a.DateTaken);
        } catch (e) {
          return 0;
        }
      });

    if (allHFZRecords.length === 0) {
      return { status: 'NOT_ATTEMPTED', message: 'No HFZ record found', date: null };
    }

    const today = new Date();
    const daysAgo180 = new Date(today.getTime() - (180 * 24 * 60 * 60 * 1000));

    // Find valid HFZ based on achievement requirements
    let validHFZ = null;

    if (requiresWithin180Days) {
      // For achievements 1-3: Find any HFZ attempt within 180 days
      validHFZ = allHFZRecords.find(h => {
        try {
          const hfzDate = new Date(h.DateTaken);
          return !isNaN(hfzDate.getTime()) && hfzDate >= daysAgo180;
        } catch (e) {
          return false;
        }
      });
    } else if (requiresPassing) {
      // For achievement 4+: Find passing HFZ within 180 days
      validHFZ = allHFZRecords.find(h => {
        try {
          const hfzDate = new Date(h.DateTaken);
          return h.isPassed && !isNaN(hfzDate.getTime()) && hfzDate >= daysAgo180;
        } catch (e) {
          return false;
        }
      });
    }

    // If we found a valid HFZ, return it
    if (validHFZ) {
      return {
        status: validHFZ.isPassed ? 'PASSED' : 'ATTEMPTED',
        message: validHFZ.isPassed
          ? `HFZ Passed on ${validHFZ.DateTaken}`
          : `HFZ Attempted on ${validHFZ.DateTaken}`,
        date: validHFZ.DateTaken,
        details: validHFZ
      };
    }

    // No valid HFZ found - show most recent passing or most recent attempt
    const mostRecentPassing = allHFZRecords.find(h => h.isPassed);
    const mostRecentAttempt = allHFZRecords[0]; // Already sorted newest first

    if (mostRecentPassing) {
      try {
        const daysSince = Math.floor((today - new Date(mostRecentPassing.DateTaken)) / (1000 * 60 * 60 * 24));
        return {
          status: 'EXPIRED',
          message: `Last passing HFZ: ${mostRecentPassing.DateTaken} (${daysSince} days ago)`,
          date: mostRecentPassing.DateTaken,
          details: mostRecentPassing
        };
      } catch (e) {
        return { status: 'EXPIRED', message: `Last passing HFZ: ${mostRecentPassing.DateTaken}`, date: mostRecentPassing.DateTaken };
      }
    } else if (mostRecentAttempt) {
      try {
        const daysSince = Math.floor((today - new Date(mostRecentAttempt.DateTaken)) / (1000 * 60 * 60 * 24));
        return {
          status: 'EXPIRED',
          message: `Last HFZ attempt: ${mostRecentAttempt.DateTaken} (${daysSince} days ago)`,
          date: mostRecentAttempt.DateTaken,
          details: mostRecentAttempt
        };
      } catch (e) {
        return { status: 'EXPIRED', message: `Last HFZ attempt: ${mostRecentAttempt.DateTaken}`, date: mostRecentAttempt.DateTaken };
      }
    }

    return { status: 'NOT_ATTEMPTED', message: 'No HFZ record found', date: null };
  };

  const checkEncampment = (capid) => {
    const encampments = _rawData.cadetActivities.filter(a =>
      a.CAPID === capid && a.Type === 'ENCAMP' && a.Completed && a.Completed !== '01/01/1900'
    );
    return {
      completed: encampments.length > 0,
      dates: encampments.map(e => e.Completed),
      locations: encampments.map(e => e.Location)
    };
  };

  const checkCLS = (capid) => {
    const clsTypes = ['RCLS', 'COS', 'COS STAFF'];
    const activities = _rawData.cadetActivities.filter(a => {
      const activityType = String(a.Type || '').toUpperCase();
      const isCLS = clsTypes.includes(activityType) || activityType.startsWith('COS');
      return a.CAPID === capid && isCLS && a.Completed && a.Completed !== '01/01/1900';
    });
    return {
      completed: activities.length > 0,
      activities: activities.map(a => ({ type: a.Type, date: a.Completed, location: a.Location }))
    };
  };

  const getAchievementRequirements = (capid, achievementID, timeInGrade = null) => {
    const achvData = _rawData.cadetAchv.find(a => a.CAPID === capid && a.CadetAchvID === achievementID);

    // Helper function to check if a PL task is completed
    const isTaskCompleted = (taskId) => {
      return _rawData.memberTasks.some(mt =>
        mt.CAPID === capid && mt.TaskID === taskId && mt.StatusID === "8"
      );
    };

    const achvID = parseInt(achievementID);
    const requirementKeys = CADET_ACHIEVEMENT_REQUIREMENTS[achievementID] || CADET_DEFAULT_REQUIREMENTS;
    const getAchievementBaseName = (id) => CADET_ACHIEVEMENT_NAMES[id] || `Achievement ${id}`;
    const getRequirementLabel = (key) => {
      if (key === 'physicalFitness') {
        return achvID <= 3
          ? CADET_REQUIREMENT_LABELS.physicalFitness.early
          : CADET_REQUIREMENT_LABELS.physicalFitness.standard;
      }

      const achievementScopedLabels = {
        activeParticipation: 'Active Participation',
        cadetOath: 'Cadet Oath',
        leadershipExpectations: 'Leadership Expectations',
        uniformWear: 'Uniform'
      };

      if (achievementScopedLabels[key]) {
        return `${getAchievementBaseName(achievementID)} - ${achievementScopedLabels[key]}`;
      }

      if (key === 'leadershipFeedback') {
        const phaseLabels = {
          1: 'Phase I Leadership Feedback',
          2: 'Phase II Leadership Feedback',
          3: 'Phase III Leadership Feedback',
          4: 'Phase IV Leadership Feedback'
        };
        const phaseId = determinePhaseFromAchievement(achievementID);
        return phaseLabels[phaseId] || CADET_REQUIREMENT_LABELS.leadershipFeedback;
      }

      return CADET_REQUIREMENT_LABELS[key] || key;
    };

    const requirements = requirementKeys.reduce((acc, key) => {
      acc[key] = { label: getRequirementLabel(key), completed: false, value: null };
      return acc;
    }, {});

    const getTaskCompletion = (taskMap, id) => {
      const taskId = taskMap[id];
      return taskId ? isTaskCompleted(taskId) : false;
    };
    const taskActiveParticipation = requirements.activeParticipation
      ? getTaskCompletion(CADET_ACTIVE_PARTICIPATION_TASKS, achievementID)
      : false;
    const taskCadetOath = requirements.cadetOath
      ? getTaskCompletion(CADET_OATH_TASKS, achievementID)
      : false;
    const taskDrillTest = requirements.drillTest
      ? getTaskCompletion(CADET_DRILL_TASKS, achievementID)
      : false;
    const taskCharacterForum = requirements.characterDevelopment
      ? getTaskCompletion(CADET_CHARACTER_FORUM_TASKS, achievementID)
      : false;

    // Check Time in Grade (if provided)
    if (timeInGrade && requirements.timeInGrade) {
      // Special cases: no time in grade requirement
      // 1. New cadets (achievement 0 â†’ 1): no TIG requirement until C/Amn
      // 2. C/Lt Col to C/Col (achievement 20 â†’ 21): immediately eligible
      const noTigRequired = (achievementID === '1') || (achievementID === '21');

      if (noTigRequired) {
        requirements.timeInGrade.completed = true;
        requirements.timeInGrade.value = 'No time in grade requirement';
      } else {
        requirements.timeInGrade.completed = timeInGrade.isEligible;
        requirements.timeInGrade.value = timeInGrade.isEligible
          ? `${timeInGrade.days} days (${timeInGrade.weeks} weeks) âœ“`
          : `${timeInGrade.days} days (need ${CADET_TIME_IN_GRADE_DAYS - timeInGrade.days} more days)`;
      }
    }

    // Check Physical Fitness - ALWAYS check HFZ regardless of achievement record
    // This ensures HFZ shows as complete even if the cadet hasn't started the next achievement
    if (requirements.physicalFitness) {
      const hfzStatus = checkHFZStatus(capid, achievementID);
      requirements.physicalFitness.completed = hfzStatus.status === 'PASSED' || hfzStatus.status === 'ATTEMPTED';
      requirements.physicalFitness.value = hfzStatus.message;
    }

    if (requirements.leadershipExpectations) {
      const taskId = CADET_LEADERSHIP_EXPECTATIONS_TASKS[achievementID];
      const completed = taskId ? isTaskCompleted(taskId) : false;
      requirements.leadershipExpectations.completed = completed;
      requirements.leadershipExpectations.value = completed ? 'Completed' : 'Not completed';
    }

    if (requirements.uniformWear) {
      const taskId = CADET_UNIFORM_TASKS[achievementID];
      const completed = taskId ? isTaskCompleted(taskId) : false;
      requirements.uniformWear.completed = completed;
      requirements.uniformWear.value = completed ? 'Completed' : 'Not completed';
    }

    if (requirements.leadershipFeedback) {
      const phaseId = determinePhaseFromAchievement(achievementID);
      const taskId = CADET_PHASE_LEADERSHIP_FEEDBACK_TASKS[phaseId];
      const completed = taskId ? isTaskCompleted(taskId) : false;
      requirements.leadershipFeedback.completed = completed;
      requirements.leadershipFeedback.value = completed ? 'Completed' : 'Not completed';
    }

    // Only check achievement data if record exists
    if (achvData) {
      // Check Leadership Test (only if not using comprehensive exam)
      // NEW: Check BOTH old system (LeadLabDateP/LeadLabScore) and new system (Cadet Interactive Modules in PL_MemberTaskCredit)
      if (requirements.leadershipTest) {
        let leadershipCompleted = false;
        let leadershipValue = 'Not started';

        // PRIORITY 1: Check NEW system (Cadet Interactive Leadership Modules via PL_MemberTaskCredit)
        const leadershipModuleTasks = ACHIEVEMENT_LEADERSHIP_MODULE_TASKS[achievementID];
        if (leadershipModuleTasks && leadershipModuleTasks.length > 0) {
          // Check if ALL required leadership module tasks are completed
          const allModulesCompleted = leadershipModuleTasks.every(taskId => isTaskCompleted(taskId));
          if (allModulesCompleted) {
            leadershipCompleted = true;
            if (leadershipModuleTasks.length === 1) {
              leadershipValue = 'Completed via Cadet Interactive Module';
            } else {
              leadershipValue = `Completed via ${leadershipModuleTasks.length} Cadet Interactive Modules`;
            }
          } else {
            // Some modules completed, show which ones
            const completedCount = leadershipModuleTasks.filter(taskId => isTaskCompleted(taskId)).length;
            if (completedCount > 0) {
              leadershipValue = `${completedCount}/${leadershipModuleTasks.length} modules completed`;
            }
          }
        }

        // PRIORITY 2: If not found in new system, check OLD system (Learn to Lead via CadetAchv table)
        if (!leadershipCompleted && achvData.LeadLabDateP && achvData.LeadLabDateP !== '01/01/1900') {
          const score = parseInt(achvData.LeadLabScore) || 0;
          leadershipCompleted = score >= CADET_MIN_TEST_SCORE;
          leadershipValue = `${score}% on ${achvData.LeadLabDateP} (Learn to Lead)`;
        }

        requirements.leadershipTest.completed = leadershipCompleted;
        requirements.leadershipTest.value = leadershipValue;
      }

      // Check Aerospace Test (only if not using comprehensive exam)
      // NEW: Check BOTH old system (AEDateP/AEScore) and new system (Cadet Interactive Aerospace Modules in PL_MemberTaskCredit)
      if (requirements.aerospaceTest) {
        let aerospaceCompleted = false;
        let aerospaceValue = 'Not started';

        // PRIORITY 1: Check NEW system (Cadet Interactive Aerospace Modules via PL_MemberTaskCredit)
        const aerospaceModuleTasks = ACHIEVEMENT_AEROSPACE_MODULE_TASKS[achievementID];
        if (aerospaceModuleTasks && aerospaceModuleTasks.length > 0) {
          // Check if ALL required aerospace module tasks are completed
          const allModulesCompleted = aerospaceModuleTasks.every(taskId => isTaskCompleted(taskId));
          if (allModulesCompleted) {
            aerospaceCompleted = true;
            aerospaceValue = 'Completed via Cadet Interactive Module';
          } else {
            // Some modules completed, show which ones
            const completedCount = aerospaceModuleTasks.filter(taskId => isTaskCompleted(taskId)).length;
            if (completedCount > 0) {
              aerospaceValue = `${completedCount}/${aerospaceModuleTasks.length} modules completed`;
            }
          }
        }

        // PRIORITY 2: If not found in new system, check OLD system (Written Aerospace Test via CadetAchv table)
        if (!aerospaceCompleted && achvData && achvData.AEDateP && achvData.AEDateP !== '01/01/1900') {
          const score = parseInt(achvData.AEScore) || 0;
          aerospaceCompleted = score >= CADET_MIN_TEST_SCORE;
          aerospaceValue = `${score}% on ${achvData.AEDateP} (Written Test)`;
        }

        requirements.aerospaceTest.completed = aerospaceCompleted;
        requirements.aerospaceTest.value = aerospaceValue;
      }

      // Check Drill Test (only for pre-Billy Mitchell non-milestone achievements)
      if (requirements.drillTest && achvData.DrillDate && achvData.DrillDate !== '01/01/1900') {
        const score = parseInt(achvData.DrillScore) || 0;
        const drillCompleted = score > 0 || taskDrillTest;
        requirements.drillTest.completed = drillCompleted;
        requirements.drillTest.value = `Score: ${score} on ${achvData.DrillDate}`;
      } else if (requirements.drillTest) {
        requirements.drillTest.completed = taskDrillTest;
        requirements.drillTest.value = taskDrillTest ? 'Completed' : 'Not started';
      }

      // Check Staff Duty Analysis (post-Billy Mitchell requirement) - three parts
      if (requirements.sdaService) {
        if (achvData.StaffServiceDate && achvData.StaffServiceDate !== '01/01/1900') {
          requirements.sdaService.completed = true;
          requirements.sdaService.value = `Completed on ${achvData.StaffServiceDate}`;
        }
      }
      if (requirements.sdaPresentation) {
        if (achvData.OralPresentationDate && achvData.OralPresentationDate !== '01/01/1900') {
          requirements.sdaPresentation.completed = true;
          requirements.sdaPresentation.value = `Completed on ${achvData.OralPresentationDate}`;
        }
      }
      if (requirements.sdaWriting) {
        if (achvData.TechnicalWritingAssignmentDate && achvData.TechnicalWritingAssignmentDate !== '01/01/1900') {
          requirements.sdaWriting.completed = true;
          requirements.sdaWriting.value = `Completed on ${achvData.TechnicalWritingAssignmentDate}`;
        }
      }

      // Check Active Participation
      if (requirements.activeParticipation) {
        const achvActive = achvData.ActivePart === 'True' || achvData.ActivePart === '1';
        requirements.activeParticipation.completed = achvActive || taskActiveParticipation;
        requirements.activeParticipation.value = requirements.activeParticipation.completed ? 'Yes' : 'No';
      }

      // Check Cadet Oath
      if (requirements.cadetOath) {
        const achvOath = achvData.CadetOath === 'True' || achvData.CadetOath === '1';
        requirements.cadetOath.completed = achvOath || taskCadetOath;
        requirements.cadetOath.value = requirements.cadetOath.completed ? 'Recited' : 'Not Recited';
      }

      // Check Character Development Forum (if required for this achievement)
      if (requirements.characterDevelopment) {
        if (achvData.MoralLDateP && achvData.MoralLDateP !== '01/01/1900') {
          requirements.characterDevelopment.completed = true;
          requirements.characterDevelopment.value = `Completed on ${achvData.MoralLDateP}`;
        } else if (taskCharacterForum) {
          requirements.characterDevelopment.completed = true;
          requirements.characterDevelopment.value = 'Completed';
        } else {
          requirements.characterDevelopment.completed = false;
          requirements.characterDevelopment.value = 'Not completed';
        }
      }
    } else {
      // No achievement record yet - still check NEW system (Cadet Interactive Modules) in case cadet completed modules
      // before starting the achievement in the old system
      if (requirements.leadershipTest) {
        const leadershipModuleTasks = ACHIEVEMENT_LEADERSHIP_MODULE_TASKS[achievementID];
        if (leadershipModuleTasks && leadershipModuleTasks.length > 0) {
          const allModulesCompleted = leadershipModuleTasks.every(taskId => isTaskCompleted(taskId));
          if (allModulesCompleted) {
            requirements.leadershipTest.completed = true;
            if (leadershipModuleTasks.length === 1) {
              requirements.leadershipTest.value = 'Completed via Cadet Interactive Module';
            } else {
              requirements.leadershipTest.value = `Completed via ${leadershipModuleTasks.length} Cadet Interactive Modules`;
            }
          } else {
            const completedCount = leadershipModuleTasks.filter(taskId => isTaskCompleted(taskId)).length;
            if (completedCount > 0) {
              requirements.leadershipTest.value = `${completedCount}/${leadershipModuleTasks.length} modules completed`;
            } else {
              requirements.leadershipTest.value = 'Not started';
            }
          }
        } else {
          requirements.leadershipTest.value = 'Not started';
        }
      }

      // Check NEW system for Aerospace modules (even if no achievement record exists)
      if (requirements.aerospaceTest) {
        const aerospaceModuleTasks = ACHIEVEMENT_AEROSPACE_MODULE_TASKS[achievementID];
        if (aerospaceModuleTasks && aerospaceModuleTasks.length > 0) {
          const allModulesCompleted = aerospaceModuleTasks.every(taskId => isTaskCompleted(taskId));
          if (allModulesCompleted) {
            requirements.aerospaceTest.completed = true;
            requirements.aerospaceTest.value = 'Completed via Cadet Interactive Module';
          } else {
            const completedCount = aerospaceModuleTasks.filter(taskId => isTaskCompleted(taskId)).length;
            if (completedCount > 0) {
              requirements.aerospaceTest.value = `${completedCount}/${aerospaceModuleTasks.length} modules completed`;
            } else {
              requirements.aerospaceTest.value = 'Not started';
            }
          }
        } else {
          requirements.aerospaceTest.value = 'Not started';
        }
      }

      // Show default "Not started" values for other requirements
      if (requirements.drillTest) {
        requirements.drillTest.completed = taskDrillTest;
        requirements.drillTest.value = taskDrillTest ? 'Completed' : 'Not started';
      }
      if (requirements.sdaService) requirements.sdaService.value = 'Not started';
      if (requirements.sdaPresentation) requirements.sdaPresentation.value = 'Not started';
      if (requirements.sdaWriting) requirements.sdaWriting.value = 'Not started';
      // Note: physicalFitness value is already set above from HFZ check
      if (requirements.activeParticipation) {
        requirements.activeParticipation.completed = taskActiveParticipation;
        requirements.activeParticipation.value = taskActiveParticipation ? 'Yes' : 'No';
      }
      if (requirements.cadetOath) {
        requirements.cadetOath.completed = taskCadetOath;
        requirements.cadetOath.value = taskCadetOath ? 'Recited' : 'Not recited';
      }
      if (requirements.characterDevelopment) {
        requirements.characterDevelopment.completed = taskCharacterForum;
        requirements.characterDevelopment.value = taskCharacterForum ? 'Completed' : 'Not completed';
      }
    }

    // Add milestone-specific requirements from PL_MemberTaskCredit
    if (requirements.cadetWingmanCourse) { // Achievement 1 (C/Amn)
      const cadetWingman = isTaskCompleted('329');
      requirements.cadetWingmanCourse.completed = cadetWingman;
      requirements.cadetWingmanCourse.value = cadetWingman ? 'Completed' : 'Not completed';
    }
    if (requirements.wrightBrothersLeadershipExam) { // Wright Brothers
      const learnToLeadExam = isTaskCompleted('347');
      requirements.wrightBrothersLeadershipExam.completed = learnToLeadExam;
      requirements.wrightBrothersLeadershipExam.value = learnToLeadExam ? 'Passed' : 'Not passed';
    }
    if (requirements.mitchellLeadershipExam || requirements.mitchellAerospaceExam || requirements.encampment) { // Billy Mitchell
      const learnToLeadExam = isTaskCompleted('378');
      const aerospaceExam = isTaskCompleted('379');
      const encampmentData = checkEncampment(capid);
      const encampment = isTaskCompleted('381') || encampmentData.completed;

      if (requirements.mitchellLeadershipExam) {
        requirements.mitchellLeadershipExam.completed = learnToLeadExam;
        requirements.mitchellLeadershipExam.value = learnToLeadExam ? 'Passed' : 'Not passed';
      }
      if (requirements.mitchellAerospaceExam) {
        requirements.mitchellAerospaceExam.completed = aerospaceExam;
        requirements.mitchellAerospaceExam.value = aerospaceExam ? 'Passed' : 'Not passed';
      }

      // Build encampment value with date and location if available
      let encampmentValue = 'Not completed';
      if (encampment && encampmentData.completed) {
        const date = encampmentData.dates[0];
        const location = encampmentData.locations[0];
        encampmentValue = location ? `Completed on ${date} at ${location}` : `Completed on ${date}`;
      } else if (encampment) {
        encampmentValue = 'Completed';
      }

      if (requirements.encampment) {
        requirements.encampment.completed = encampment;
        requirements.encampment.value = encampmentValue;
      }
    }
    if (requirements.earhartLeadershipExam) { // Amelia Earhart
      const learnToLeadExam = isTaskCompleted('414');
      requirements.earhartLeadershipExam.completed = learnToLeadExam;
      requirements.earhartLeadershipExam.value = learnToLeadExam ? 'Passed' : 'Not passed';
    }
    if (requirements.eakerSpeech || requirements.eakerEssay || requirements.cls) { // Eaker
      const speech = isTaskCompleted('441');
      const essay = isTaskCompleted('442');
      const cos = isTaskCompleted('444') || checkCLS(capid).completed;

      if (requirements.eakerSpeech) {
        requirements.eakerSpeech.completed = speech;
        requirements.eakerSpeech.value = speech ? 'Passed' : 'Not passed';
      }
      if (requirements.eakerEssay) {
        requirements.eakerEssay.completed = essay;
        requirements.eakerEssay.value = essay ? 'Passed' : 'Not passed';
      }
      if (requirements.cls) {
        requirements.cls.completed = cos;
        requirements.cls.value = cos ? 'Completed' : 'Not completed';
      }
    }
    if (requirements.spaatzLeadershipExam || requirements.spaatzJOFExam || requirements.spaatzEssay || requirements.spaatzCFA) { // Spaatz
      const learnToLeadExam = isTaskCompleted('445');
      const jofExam = isTaskCompleted('446');
      const essay = isTaskCompleted('447');
      const cfa = isTaskCompleted('448');

      if (requirements.spaatzLeadershipExam) {
        requirements.spaatzLeadershipExam.completed = learnToLeadExam;
        requirements.spaatzLeadershipExam.value = learnToLeadExam ? 'Passed' : 'Not passed';
      }
      if (requirements.spaatzJOFExam) {
        requirements.spaatzJOFExam.completed = jofExam;
        requirements.spaatzJOFExam.value = jofExam ? 'Passed' : 'Not passed';
      }
      if (requirements.spaatzEssay) {
        requirements.spaatzEssay.completed = essay;
        requirements.spaatzEssay.value = essay ? 'Passed' : 'Not passed';
      }
      if (requirements.spaatzCFA) {
        requirements.spaatzCFA.completed = cfa;
        requirements.spaatzCFA.value = cfa ? 'Passed' : 'Not passed';
      }
    }

    const completed = Object.values(requirements).filter(r => r.completed);
    const pending = Object.values(requirements).filter(r => !r.completed);

    return { requirements, completed, pending, completionPercent: Math.round((completed.length / Object.keys(requirements).length) * 100) };
  };

  // Check if a cadet has earned Honor Credit for a specific achievement
  // Honor Credit is earned when ExtraCreditEarned.CreditEarned is true in PL_MemberPathCredit
  const checkHonorCredit = (capid, achievementID) => {
    if (CADET_MILESTONE_ACHIEVEMENTS.includes(parseInt(achievementID))) {
      return { earned: false, reason: 'N/A - Milestone Award' };
    }

    const pathId = CADET_ACHIEVEMENT_PATH_IDS[achievementID];
    if (!pathId) {
      return { earned: false, reason: 'N/A - No Path Mapping' };
    }

    const parseExtraCredit = (raw) => {
      const text = String(raw || '');
      const earned = /CreditEarned\s*:\s*true/i.test(text);
      const dateMatch = text.match(/EarnedDate\s*:\s*([0-9-]+)/i);
      return { earned, earnedDate: dateMatch ? dateMatch[1] : null };
    };

    const normalizedCapid = String(capid || '').trim();
    const normalizedPathId = String(pathId || '').trim();
    const pathCredits = _rawData.memberPaths
      .filter(mp => String(mp.CAPID || '').trim() === normalizedCapid &&
        String(mp.PathID || '').trim() === normalizedPathId &&
        String(mp.StatusID || '').trim() === "8");

    const earnedCredits = pathCredits
      .map(mp => parseExtraCredit(mp.ExtraCreditEarned))
      .filter(ec => ec.earned);

    if (earnedCredits.length > 0) {
      const latest = earnedCredits.find(ec => ec.earnedDate) || earnedCredits[0];
      return { earned: true, earnedDate: latest.earnedDate || null };
    }
    if (pathCredits.length > 0) {
      return { earned: false, reason: 'Extra credit not earned' };
    }

    const achvData = _rawData.cadetAchv.find(a => a.CAPID === capid && a.CadetAchvID === achievementID);

    // Helper function to check if a PL task is completed
    const isTaskCompleted = (taskId) => {
      return _rawData.memberTasks.some(mt =>
        mt.CAPID === capid && mt.TaskID === taskId && mt.StatusID === "8"
      );
    };

    // Check if BOTH interactive modules completed
    const leadershipModuleTasks = ACHIEVEMENT_LEADERSHIP_MODULE_TASKS[achievementID];
    const aerospaceModuleTasks = ACHIEVEMENT_AEROSPACE_MODULE_TASKS[achievementID];

    const leadershipModuleComplete = leadershipModuleTasks &&
      leadershipModuleTasks.every(taskId => isTaskCompleted(taskId));
    const aerospaceModuleComplete = aerospaceModuleTasks &&
      aerospaceModuleTasks.every(taskId => isTaskCompleted(taskId));

    // Check if BOTH written tests passed
    const leadershipTestPassed = achvData && achvData.LeadLabDateP &&
      achvData.LeadLabDateP !== '01/01/1900' &&
      parseInt(achvData.LeadLabScore) >= CADET_MIN_TEST_SCORE;
    const aerospaceTestPassed = achvData && achvData.AEDateP &&
      achvData.AEDateP !== '01/01/1900' &&
      parseInt(achvData.AEScore) >= CADET_MIN_TEST_SCORE;

    // Honor Credit earned if ALL FOUR conditions met
    const earned = leadershipModuleComplete && aerospaceModuleComplete &&
                   leadershipTestPassed && aerospaceTestPassed;

    return {
      earned,
      details: {
        leadershipModule: leadershipModuleComplete,
        aerospaceModule: aerospaceModuleComplete,
        leadershipTest: leadershipTestPassed,
        aerospaceTest: aerospaceTestPassed
      }
    };
  };

  const calculatePromotionReadiness = (capid, currentAchievement, timeInGrade) => {
    const nextAchievement = currentAchievement + 1;
    if (nextAchievement > 21) return { status: 'SPAATZ_COMPLETE', message: 'Spaatz Award achieved!' };

    const reqData = getAchievementRequirements(capid, nextAchievement.toString(), timeInGrade);
    const tigReady = timeInGrade.isEligible;

    // Check only cadet-controllable requirements (exclude activeParticipation and cadetOath)
    const cadetControllableReqs = Object.entries(reqData.requirements).filter(([key, _]) =>
      key !== 'activeParticipation' && key !== 'cadetOath'
    );
    const cadetControllableCompleted = cadetControllableReqs.filter(([_, req]) => req.completed).length;
    const reqsReady = cadetControllableCompleted === cadetControllableReqs.length;

    // Check for READY: everything cadet can control is complete
    if (tigReady && reqsReady) return { status: 'READY', message: 'Ready for promotion!' };

    // Check for TIME_PENDING: everything done but not eligible due to time in grade
    if (reqsReady && !tigReady) return { status: 'TIME_PENDING', message: `${CADET_TIME_IN_GRADE_DAYS - timeInGrade.days} days until eligible` };

    // Check for NEARLY_READY: 2 of 3 hard requirements (leadership, fitness, aerospace) complete
    // Hard requirements have lower priority value since manual checkboxes are lower priority
    const reqs = reqData.requirements;
    const hardReqsCompleted = [
      // Leadership
      reqs.leadershipTest?.completed || reqs.wrightBrothersLeadershipExam?.completed ||
      reqs.mitchellLeadershipExam?.completed || reqs.earhartLeadershipExam?.completed ||
      reqs.spaatzLeadershipExam?.completed,
      // Fitness
      reqs.physicalFitness?.completed || reqs.spaatzCFA?.completed,
      // Aerospace
      reqs.aerospaceTest?.completed || reqs.mitchellAerospaceExam?.completed || reqs.spaatzJOFExam?.completed
    ].filter(Boolean).length;

    if (hardReqsCompleted >= 2) return { status: 'NEARLY_READY', message: 'Nearly ready!' };
    // Only consider "In Progress" if cadet has completed at least one controllable requirement
    // (time in grade alone doesn't count as having started)
    if (cadetControllableCompleted > 0) return { status: 'IN_PROGRESS', message: 'In progress' };
    return { status: 'NOT_STARTED', message: 'Not started' };
  };

  const getMilestoneAwards = (capid) => {
    return _rawData.cadetAwards
      .filter(a => a.CAPID === capid && a.Completed && a.Completed !== '01/01/1900')
      .map(a => ({ award: a.Award, awardNo: a.AwardNo, completed: a.Completed }));
  };

  const getDescendantOrgIds = (rootId) => {
    const root = String(rootId).trim();
    let results = [root];
    const queue = [root];
    const visited = new Set([root]);

    // Build children map
    const childrenMap = new Map();
    _rawData.organization.forEach(o => {
      const parentId = String(o.NextLevel).trim();
      const childId = String(o.ORGID).trim();
      if (parentId && parentId !== childId) {
        if (!childrenMap.has(parentId)) childrenMap.set(parentId, []);
        childrenMap.get(parentId).push(childId);
      }
    });

    // BFS to get all descendants
    while (queue.length > 0) {
      const curr = queue.shift();
      const kids = childrenMap.get(curr) || [];
      kids.forEach(k => {
        if (!visited.has(k)) {
          visited.add(k);
          results.push(k);
          queue.push(k);
        }
      });
    }
    return results;
  };

  const getProcessedCadets = (unitFilter, includeDescendants = false) => {
    // Get valid org IDs
    const validOrgIds = includeDescendants ? getDescendantOrgIds(unitFilter) : [String(unitFilter).trim()];

    // Filter for cadets only with ACTIVE status
    const cadets = _rawData.members.filter(m => {
      const type = String(m.Type || m.TYPE || "").toUpperCase();
      const status = String(m.MbrStatus || "").toUpperCase();
      const isActive = status === "ACTIVE";
      return type === "CADET" && isActive && validOrgIds.includes(String(m.ORGID).trim());
    });

    return cadets.map(cadet => {
      const currentRank = getCurrentRank(cadet.CAPID);
      const approvedAchievements = getApprovedAchievements(cadet.CAPID);
      const currentAchievement = approvedAchievements.length > 0 ? Math.max(...approvedAchievements) : 0;
      const nextAchievement = currentAchievement + 1;
      const phase = determinePhaseFromAchievement(currentAchievement);
      const timeInGrade = currentRank ? getTimeInGrade(currentRank.RankDate) : { days: 0, weeks: 0, isEligible: false };
      const promotionStatus = calculatePromotionReadiness(cadet.CAPID, currentAchievement, timeInGrade);
      const nextRequirements = nextAchievement <= 21 ? getAchievementRequirements(cadet.CAPID, nextAchievement.toString(), timeInGrade) : null;
      const milestoneAwards = getMilestoneAwards(cadet.CAPID);

      // Check honor credit for all approved achievements
      const honorCreditAchievements = approvedAchievements.map(achvId => {
        const honorCredit = checkHonorCredit(cadet.CAPID, achvId.toString());
        return { achievementId: achvId, honorCredit };
      }).filter(a => a.honorCredit.earned);

      // Check honor credit opportunity for next achievement
      const nextHonorCreditStatus = nextAchievement <= 21 ? checkHonorCredit(cadet.CAPID, nextAchievement.toString()) : null;

      // Build unit name from organization data
      let memberUnitName = "Unknown";
      if (_rawData.organization) {
        const memOrg = _rawData.organization.find(o => o.ORGID === cadet.ORGID);
        if (memOrg) {
          const r = memOrg.Region || "";
          const w = memOrg.Wing || "";
          const u = memOrg.Unit ? memOrg.Unit.replace(/^0+/, '').padStart(3,'0') : "000";
          memberUnitName = `${r}-${w}-${u}`;
        }
      }

      // Get cadet duty positions
      const cadetDuties = _rawData.cadetDuty
        ? _rawData.cadetDuty
            .filter(d => d.CAPID === cadet.CAPID && d.Duty && !d.Duty.toUpperCase().includes('#REF'))
            .map(d => {
              const org = _rawData.organization.find(o => o.ORGID === d.ORGID);
              const orgString = org ? `${org.Region}-${org.Wing}-${org.Unit ? org.Unit.replace(/^0+/, '').padStart(3,'0') : '000'}` : "Unknown";
              return { name: d.Duty, date: d.DateMod, orgString };
            })
        : [];

      const esQualifications = _esService.buildESQualifications(cadet, { forDashboard: true, forCadet: true });
      const esQualificationsAll = _esService.buildESQualifications(cadet, { forDashboard: false, forCadet: true });

      return {
        ...cadet,
        memberUnitName,
        cadetDuties,
        currentRank: currentRank ? currentRank.Rank : 'N/A',
        rankDate: currentRank ? currentRank.RankDate : null,
        currentAchievement,
        nextAchievement: nextAchievement <= 21 ? nextAchievement : null,
        phase,
        timeInGrade,
        promotionStatus,
        approvedAchievements,
        nextRequirements,
        milestoneAwards,
        honorCreditAchievements,
        nextHonorCreditStatus,
        esQualifications,
        esQualificationsAll
      };
    });
  };

  return {
    initialize: parsePayload,
    rawData: () => _rawData,
    getProcessedCadets,
    getCurrentRank,
    getApprovedAchievements,
    getAchievementRequirements,
    checkHFZStatus,
    checkEncampment,
    checkCLS,
    getMilestoneAwards,
    checkHonorCredit,
    // ES Helper Methods
    getESAchievementTasks: (achvID, capid) => _esService.getESAchievementTasks(achvID, capid),
    buildESPrerequisiteTree: (achvID, ancestry) => _esService.buildESPrerequisiteTree(achvID, ancestry),
    checkESQualificationEligibility: (achvID, member) => _esService.checkESQualificationEligibility(achvID, member),
    getAllESAchievements: () => _esService.getAllESAchievements()
  };
}
</script>

<script type="text/babel">
/**
 * ServicesESDataService.html
 *
 * Centralized Emergency Services (ES) qualification data processing service.
 * Provides shared ES logic for both senior and cadet data services.
 *
 * Dependencies:
 * - ConfigConstants.html (ES_*, COMMUNICATIONS_DUTY_POSITIONS)
 * - UtilsDataParsing.html
 */

function createESDataService(rawConfig, rawData) {
  const _rawConfig = rawConfig;
  const _rawData = rawData;

  // ES Helper: Check if member is Skills Evaluator for a qualification
  const checkSkillsEvaluator = (capid, achv, functionalArea, member) => {
    // Skills Evaluator: Member holds qual for 1+ year AND has active SET achievement
    // AND the qualification is in an allowed functional area (not badges, patches, pilot ratings, etc.)
    // AND the qualification is ACTIVE (not expired or training)
    // AND NOT GES or SET itself

    // Only ES qualifications can have Skills Evaluators
    if (!ES_SKILLS_EVALUATOR_ALLOWED_FUNCTIONAL_AREAS.has(functionalArea)) {
      return false;
    }

    // Cannot be SE for GES, SET, or other restricted qualifications
    if (ES_NO_SKILLS_EVALUATOR_IDS.has(achv.AchvID)) {
      return false;
    }

    // Qualification must be ACTIVE (not expired or training)
    const statusUpper = String(achv.Status || '').toUpperCase();
    if (statusUpper !== 'ACTIVE') {
      return false;
    }

    // Check if qualification held for 1+ year
    const completedDate = achv.Completed && achv.Completed !== '01/01/1900'
      ? new Date(achv.Completed)
      : null;

    if (!completedDate) return false;

    const today = new Date();
    const oneYearAgo = new Date(today);
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

    const heldForOneYear = completedDate <= oneYearAgo;
    if (!heldForOneYear) return false;

    // Check for active SET (Skills Evaluator Training) achievement
    // SET is AchvID 124 in the ES system
    const SET_ACHV_ID = '124';

    const hasActiveSET = (_rawData.esMbrAchievements || []).some(a =>
      a.CAPID === capid &&
      a.AchvID === SET_ACHV_ID &&
      String(a.Status || '').toUpperCase() === 'ACTIVE'
    );

    if (!hasActiveSET) return false;

    // Special requirement for ICUT: Must also be in a communications duty position
    if (achv.AchvID === '217') { // ICUT
      const memberDuties = (_rawData.duty || [])
        .filter(d => d.CAPID === capid)
        .map(d => String(d.Duty || '').toUpperCase().trim());

      const hasCommDuty = memberDuties.some(duty =>
        COMMUNICATIONS_DUTY_POSITIONS.has(duty)
      );

      if (!hasCommDuty) return false;
    }

    return true;
  };

  // ES Core: Build ES qualifications for a member
  const buildESQualifications = (member, options = {}) => {
    const {
      forDashboard = false,  // Apply dashboard-specific filtering
      forCadet = false,      // Use cadet-specific logic
      forSenior = false      // Use senior-specific logic (default if neither cadet nor senior specified)
    } = options;

    const capid = member.CAPID;
    const today = new Date();

    // Get member's ES achievements (all statuses)
    const memberAchievements = (_rawData.esMbrAchievements || [])
      .filter(a => a.CAPID === capid);

    // Build qualification objects with full details
    const qualifications = memberAchievements.map(achv => {
      const achvDef = (_rawConfig.esAchievements || [])
        .find(def => def.AchvID === achv.AchvID);

      if (!achvDef) return null;

      const functionalArea = achvDef.FunctionalArea;

      // FILTER OUT: Exclude badges, patches, IS/ICS courses, ET-Senior levels, BCUT/ACUT, CAPPILOT_OLD, and Cadet Programs
      // Check both achievement ID and functional area
      if (ES_EXCLUDED_ACHIEVEMENT_IDS.has(achv.AchvID) || ES_EXCLUDED_FUNCTIONAL_AREAS.has(functionalArea)) {
        return null; // Skip this qualification
      }

      // Calculate status and color
      let status, colorClass;
      const statusUpper = String(achv.Status || '').toUpperCase();

      if (statusUpper === 'ACTIVE') {
        status = 'Active';
        colorClass = 'es-active'; // green
      } else if (statusUpper === 'TRAINING') {
        status = 'Training';
        colorClass = 'es-training'; // amber
      } else if (statusUpper === 'EXPIRED') {
        status = 'Expired';
        colorClass = 'es-expired'; // red
      } else {
        status = 'Not Approved';
        colorClass = 'es-not-approved'; // gray
      }

      // Calculate expiration info (only for senior members or full profile views)
      let expirationDate = null;
      let daysTilExpiration = null;
      let isExpiringSoon = false;

      if (!forCadet || !forDashboard) {
        expirationDate = achv.Expiration && achv.Expiration !== '01/01/1900'
          ? new Date(achv.Expiration)
          : null;

        if (expirationDate) {
          const timeDiff = expirationDate - today;
          daysTilExpiration = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

          if (status === 'Active' && daysTilExpiration <= 90 && daysTilExpiration >= 0) {
            isExpiringSoon = true; // Expiring within 3 months
          }

          if (status === 'Expired') {
            const daysSinceExpiration = Math.abs(daysTilExpiration);
            if (forDashboard && daysSinceExpiration > 180) {
              return null; // Skip if expired for more than 6 months (dashboard only)
            }
            if (!forDashboard && daysSinceExpiration > 730) {
              return null; // Skip if expired for more than 2 years (profile)
            }
          }
        }

        // Filter out non-expiring qualifications (except GES which is special)
        if (!expirationDate && achv.AchvID !== ES_DASHBOARD_SPECIAL.GES) {
          if (ES_NON_EXPIRING_EXCLUSIONS.has(achv.AchvID)) {
            return null;
          }
        }

        // Dashboard-specific filtering (for seniors)
        if (forDashboard && !forCadet) {
          // Hide SET (SE Training) on senior dashboard
          if (achv.AchvID === ES_DASHBOARD_SPECIAL.SE_TRAINING) return null;

          // Hide CD - Counterdrug only when expired (doesn't have expiration date, relies on status)
          if (achv.AchvID === ES_DASHBOARD_SPECIAL.CD_COUNTERDRUG && status === 'Expired') return null;

          // Hide completed GES and OPSEC on dashboard (show only if missing/training)
          if ((achv.AchvID === ES_DASHBOARD_SPECIAL.GES || achv.AchvID === ES_DASHBOARD_SPECIAL.OPSEC) &&
              status === 'Active') {
            return null;
          }
        }
      }

      // Check if member holds qual for 1+ year AND has active SET achievement
      // Pass member object for duty checking
      // Cadets typically don't qualify as Skills Evaluators
      const isSkillsEvaluator = forCadet ? false : checkSkillsEvaluator(capid, achv, functionalArea, member);

      return {
        achvID: achv.AchvID,
        name: achvDef.Achv,
        functionalArea: functionalArea,
        status: status,
        statusRaw: achv.Status,
        colorClass: colorClass,
        completed: achv.Completed,
        expiration: achv.Expiration,
        expirationDate: expirationDate,
        daysTilExpiration: daysTilExpiration,
        isExpiringSoon: isExpiringSoon,
        isSkillsEvaluator: isSkillsEvaluator,
        // For detail modal
        originallyAccomplished: achv.OriginallyAccomplished,
        authByCAPID: achv.AuthByCAPID,
        authDate: achv.AuthDate,
        source: achv.Source
      };
    }).filter(Boolean); // Remove null entries (filtered qualifications)

    // Handle duplicates (only for senior members or detailed views): If a member has both expired and training status for same qual, keep only the most recent (preferably training)
    let uniqueQualifications;
    if (!forCadet || !forDashboard) {
      const qualMap = new Map();
      qualifications.forEach(qual => {
        const existing = qualMap.get(qual.name);
        if (!existing) {
          qualMap.set(qual.name, qual);
        } else {
          // Priority: Training > Active > Not Approved > Expired
          const statusPriority = { 'Training': 1, 'Active': 2, 'Not Approved': 3, 'Expired': 4 };
          const existingPriority = statusPriority[existing.status] || 999;
          const currentPriority = statusPriority[qual.status] || 999;

          if (currentPriority < existingPriority) {
            qualMap.set(qual.name, qual);
          } else if (currentPriority === existingPriority) {
            // If same priority, keep the most recently completed one
            const existingDate = existing.completed ? new Date(existing.completed) : new Date(0);
            const currentDate = qual.completed ? new Date(qual.completed) : new Date(0);
            if (currentDate > existingDate) {
              qualMap.set(qual.name, qual);
            }
          }
        }
      });

      // Convert map back to array
      uniqueQualifications = Array.from(qualMap.values());
    } else {
      // For cadet dashboard, no duplicate handling
      uniqueQualifications = qualifications;
    }

    // Dashboard-specific: Add missing GES and OPSEC if not present at all (only for seniors)
    if (forDashboard && !forCadet) {
      const hasGES = memberAchievements.some(a => a.AchvID === ES_DASHBOARD_SPECIAL.GES);
      const hasOPSEC = memberAchievements.some(a => a.AchvID === ES_DASHBOARD_SPECIAL.OPSEC);

      // Add GES if missing
      if (!hasGES) {
        const gesDef = (_rawConfig.esAchievements || []).find(a => a.AchvID === ES_DASHBOARD_SPECIAL.GES);
        if (gesDef) {
          uniqueQualifications.push({
            achvID: ES_DASHBOARD_SPECIAL.GES,
            name: gesDef.Achv,
            functionalArea: gesDef.FunctionalArea,
            status: 'Missing',
            statusRaw: null,
            colorClass: 'es-expired', // Use red styling
            completed: null,
            expiration: null,
            expirationDate: null,
            daysTilExpiration: null,
            isExpiringSoon: false,
            isSkillsEvaluator: false,
            originallyAccomplished: null,
            authByCAPID: null,
            authDate: null,
            source: null
          });
        }
      }

      // Add OPSEC if missing
      if (!hasOPSEC) {
        const opsecDef = (_rawConfig.esAchievements || []).find(a => a.AchvID === ES_DASHBOARD_SPECIAL.OPSEC);
        if (opsecDef) {
          uniqueQualifications.push({
            achvID: ES_DASHBOARD_SPECIAL.OPSEC,
            name: opsecDef.Achv,
            functionalArea: opsecDef.FunctionalArea,
            status: 'Missing',
            statusRaw: null,
            colorClass: 'es-expired', // Use red styling
            completed: null,
            expiration: null,
            expirationDate: null,
            daysTilExpiration: null,
            isExpiringSoon: false,
            isSkillsEvaluator: false,
            originallyAccomplished: null,
            authByCAPID: null,
            authDate: null,
            source: null
          });
        }
      }
    }

    // Sort: Active first, then Training, then Expired, then Missing, then Not Approved
    // Within each group, sort alphabetically by name
    const statusOrder = { 'Active': 1, 'Training': 2, 'Expired': 3, 'Missing': 4, 'Not Approved': 5 };
    uniqueQualifications.sort((a, b) => {
      const statusDiff = statusOrder[a.status] - statusOrder[b.status];
      if (statusDiff !== 0) return statusDiff;
      return (a.name || '').localeCompare(b.name || '');
    });

    return uniqueQualifications;
  };

  // ES Helper: Build prerequisite tree for a qualification
  const buildESPrerequisiteTree = (achvID, ancestry = []) => {
    const buildNode = (currentAchvID, currentAncestry = []) => {
      // Get achievement definition
      const achvDef = (_rawConfig.esAchievements || [])
        .find(a => a.AchvID === currentAchvID);

      if (!achvDef) return null;

      // Prevent infinite recursion - if we've already seen this ID in our ancestry chain, stop
      if (currentAncestry.includes(currentAchvID)) {
        return {
          achvID: currentAchvID,
          name: achvDef.Achv,
          functionalArea: achvDef.FunctionalArea,
          prerequisites: [], // Don't recurse further
          note: 'Already shown above'
        };
      }

      // Add current ID to ancestry for this branch
      const newAncestry = [...currentAncestry, currentAchvID];

      // Get prerequisite achievements from AchvStepAchv
      const prereqLinks = (_rawConfig.esAchvStepAchv || [])
        .filter(link => link.AchvID === currentAchvID);

      // Build all prerequisite nodes
      const prereqs = prereqLinks
        .map(link => buildNode(link.OrigAchvID, newAncestry))
        .filter(Boolean);

      // Collect all transitive prerequisite IDs (prerequisites of prerequisites, recursively)
      const collectTransitivePrereqIDs = (node) => {
        const ids = new Set();
        if (node && node.prerequisites) {
          node.prerequisites.forEach(prereq => {
            ids.add(prereq.achvID);
            // Recursively collect IDs from this prerequisite's prerequisites
            const transitiveIDs = collectTransitivePrereqIDs(prereq);
            transitiveIDs.forEach(id => ids.add(id));
          });
        }
        return ids;
      };

      // Collect all transitive prerequisite IDs from all direct prerequisites
      const allTransitiveIDs = new Set();
      prereqs.forEach(prereq => {
        const transitiveIDs = collectTransitivePrereqIDs(prereq);
        transitiveIDs.forEach(id => allTransitiveIDs.add(id));
      });

      // Filter out direct prerequisites that appear transitively through other prerequisites
      // Keep a prerequisite if it's NOT found in the transitive set of OTHER prerequisites
      const filteredPrereqs = prereqs.filter(prereq => {
        // For each prereq, check if it appears in the transitive dependencies of OTHER prereqs
        const otherPrereqs = prereqs.filter(p => p.achvID !== prereq.achvID);
        const otherTransitiveIDs = new Set();
        otherPrereqs.forEach(otherPrereq => {
          const transitiveIDs = collectTransitivePrereqIDs(otherPrereq);
          transitiveIDs.forEach(id => otherTransitiveIDs.add(id));
        });

        // Keep this prereq if it's NOT in the other prereqs' transitive dependencies
        return !otherTransitiveIDs.has(prereq.achvID);
      });

      return {
        achvID: currentAchvID,
        name: achvDef.Achv,
        functionalArea: achvDef.FunctionalArea,
        prerequisites: filteredPrereqs
      };
    };

    return buildNode(achvID, ancestry);
  };

  // ES Helper: Get meaningful step name based on StepID and task content
  const getESStepName = (stepID, tasks = []) => {
    const sid = String(stepID);

    // Standard ES qualification step structure
    const stepNames = {
      '1': 'Prerequisites',
      '2': 'Commander Approval for Prerequisites',
      '3': 'Familiarization and Preparatory Training',
      '4': 'Commander Approval for F&P Training',
      '5': 'Advanced Training',
      '6': 'Additional Requirements',
      '7': 'Exercise Participation',
      '8': 'Continuing Education',
      '9': 'Final Approval',
      '10': 'Recertification'
    };

    // Use standard name if available
    if (stepNames[sid]) {
      return stepNames[sid];
    }

    // Fall back to analyzing task names for context
    if (tasks.length > 0) {
      const firstTaskName = tasks[0].taskName || '';
      if (firstTaskName.includes('Commander Approval')) {
        return 'Commander Approval';
      }
      if (firstTaskName.includes('Exercise Participation')) {
        return 'Exercise Participation';
      }
      if (firstTaskName.includes('Continuing Education')) {
        return 'Continuing Education';
      }
      if (firstTaskName.includes('Age Eligibility') || firstTaskName.includes('Age eligibility')) {
        return 'Prerequisites & Age Eligibility';
      }
    }

    // Generic fallback
    return `Step ${stepID}`;
  };

  // ES Helper: Get tasks required for an achievement, grouped by step
  const getESAchievementTasks = (achvID, capid) => {
    // Normalize IDs to strings for comparison
    const targetAchvID = String(achvID || '').trim();
    const targetCAPID = String(capid || '').trim();

    // Get all task links for this achievement
    const taskLinks = (_rawConfig.esAchvStepTasks || [])
      .filter(link => String(link.AchvID || '').trim() === targetAchvID);

    // Get member's completed tasks
    const memberTasks = (_rawData.esMbrTasks || [])
      .filter(t => String(t.CAPID || '').trim() === targetCAPID);

    // Group by StepID
    const stepMap = {};

    taskLinks.forEach(link => {
      const stepID = link.StepID;

      if (!stepMap[stepID]) {
        stepMap[stepID] = {
          stepID: stepID,
          stepName: null, // Will be set after all tasks are collected
          tasks: []
        };
      }

      // Get task definition
      const taskDef = (_rawConfig.esTasks || [])
        .find(t => String(t.TaskID || '').trim() === String(link.TaskID || '').trim());

      if (!taskDef) {
        console.warn(`Task definition not found for TaskID: ${link.TaskID}`);
        return;
      }

      // Check if member has completed this task
      const memberTask = memberTasks.find(mt =>
        String(mt.TaskID || '').trim() === String(link.TaskID || '').trim()
      );
      const isCompleted = memberTask &&
        String(memberTask.Status || '').toUpperCase() === 'ACTIVE';

      stepMap[stepID].tasks.push({
        taskID: link.TaskID,
        taskName: taskDef.TaskName,
        functionalArea: taskDef.FunctionalArea,
        completed: isCompleted,
        completedDate: memberTask ? memberTask.Completed : null,
        expiration: memberTask ? memberTask.Expiration : null,
        status: memberTask ? memberTask.Status : null
      });
    });

    // Set step names based on collected tasks
    Object.keys(stepMap).forEach(stepID => {
      stepMap[stepID].stepName = getESStepName(stepID, stepMap[stepID].tasks);
    });

    // Convert to array and sort by stepID
    return Object.values(stepMap).sort((a, b) =>
      parseInt(a.stepID) - parseInt(b.stepID)
    );
  };

  // ES Helper: Check special prerequisite cases (OR logic, conditional requirements)
  const checkSpecialPrerequisites = (achvID, member) => {
    const capid = member.CAPID;
    const memberType = String(member.Type || member.TYPE || '').toUpperCase();
    const missing = [];
    const satisfiedPrereqs = [];

    // Check age requirement first (if applicable)
    const requiredAge = ES_AGE_REQUIREMENTS[achvID];
    if (requiredAge) {
      const memberAge = member.DOB ? Math.floor((new Date() - new Date(member.DOB)) / (1000 * 60 * 60 * 24 * 365.25)) : null;

      if (memberAge === null) {
        missing.push('Date of birth required for age verification');
      } else if (memberAge < requiredAge) {
        missing.push(`Age eligibility: ${requiredAge} years (member is ${memberAge} years old)`);
      } else {
        satisfiedPrereqs.push(`Age requirement: ${requiredAge}+ years`);
      }
    }

    // Check other special prerequisites
    const specialCase = ES_PREREQUISITE_SPECIAL_CASES[achvID];
    if (!specialCase) {
      // No special case, but return age check results
      return {
        eligible: missing.length === 0,
        missing: missing,
        satisfiedPrereqs: satisfiedPrereqs
      };
    }

    specialCase.specialPrereqs.forEach(prereq => {
      if (prereq.type === 'OR') {
        // OR logic: Member needs at least ONE of the options
        const hasAny = prereq.options.some(optionID =>
          (_rawData.esMbrAchievements || []).some(a =>
            a.CAPID === capid &&
            a.AchvID === optionID &&
            String(a.Status || '').toUpperCase() === 'ACTIVE'
          )
        );
        if (!hasAny) {
          // Get names of the options for display
          const optionNames = prereq.options.map(optID => {
            const achvDef = (_rawConfig.esAchievements || []).find(a => a.AchvID === optID);
            return achvDef ? achvDef.Achv : optID;
          });
          missing.push(`One of: ${optionNames.join(' OR ')}`);
        } else {
          satisfiedPrereqs.push('OR requirement');
        }
      } else if (prereq.type === 'CONDITIONAL_MEMBER_TYPE') {
        // Conditional: Requirement depends on member type
        // Senior members are anyone who is NOT a cadet (includes SENIOR, LIFE, SM, PATRON, etc.)
        const isCadet = memberType === 'CADET';
        const isSenior = !isCadet;
        const requiredAchvID = isSenior ? prereq.senior : prereq.cadet;

        let hasRequired = false;

        if (isSenior) {
          // For senior members, check Level 1 completion in seniorLevels (E&T data)
          // Level 1 is Achievement ID '96' but it's NOT in esMbrAchievements - it's in seniorLevels
          hasRequired = (_rawData.seniorLevels || []).some(sl =>
            sl.CAPID === capid &&
            sl.Lvl === 'LV1' &&
            sl.Completed && sl.Completed !== '01/01/1900'
          );

          // Also check memberPaths for Level 1 completion (search for Level 1 path dynamically)
          if (!hasRequired) {
            // Find Level 1 PathID by searching for 'Level 1' in path names
            const level1Path = (_rawConfig.paths || []).find(p =>
              (p.PathName || '').includes('Level 1')
            );

            if (level1Path) {
              hasRequired = (_rawData.memberPaths || []).some(mp =>
                mp.CAPID === capid &&
                mp.PathID === level1Path.PathID &&
                mp.StatusID === '8' // Approved/Completed
              );
            }
          }
        } else {
          // For cadets, check Achievement 1 (Curry) in esMbrAchievements
          hasRequired = (_rawData.esMbrAchievements || []).some(a =>
            a.CAPID === capid &&
            a.AchvID === requiredAchvID &&
            String(a.Status || '').toUpperCase() === 'ACTIVE'
          );
        }

        if (!hasRequired) {
          // Only show the requirement that applies to this member type
          const reqName = isSenior ? 'Level 1' : 'Achievement 1 (Curry)';
          missing.push(reqName);
        } else {
          satisfiedPrereqs.push(isSenior ? 'Level 1' : 'Achievement 1');
        }
      } else if (prereq.type === 'TASK') {
        // Task requirement: Member must have completed a specific task
        // Check both general member tasks (PL_MemberTaskCredit) and ES member tasks (MbrTasks)
        let hasTask = (_rawData.memberTasks || []).some(mt =>
          mt.CAPID === capid &&
          mt.TaskID === prereq.taskID &&
          mt.StatusID === '8' // Completed/Active
        );

        // Also check ES member tasks (esMbrTasks) for ES-specific tasks
        if (!hasTask) {
          hasTask = (_rawData.esMbrTasks || []).some(mt =>
            String(mt.CAPID || '').trim() === String(capid || '').trim() &&
            String(mt.TaskID || '').trim() === String(prereq.taskID || '').trim() &&
            String(mt.Status || '').toUpperCase() === 'ACTIVE'
          );
        }

        // Special case: ICS 100 requirement (TaskID 131) can also be satisfied by IS-100 course (AchvID 176)
        if (!hasTask && prereq.taskID === '131') {
          const hasIS100 = (_rawData.esMbrAchievements || []).some(a =>
            a.CAPID === capid &&
            a.AchvID === '176' && // IS-100 achievement ID
            String(a.Status || '').toUpperCase() === 'ACTIVE'
          );
          hasTask = hasIS100;
        }

        if (!hasTask) {
          const taskDef = (_rawConfig.esTasks || _rawConfig.tasks || []).find(t =>
            String(t.TaskID || '').trim() === String(prereq.taskID || '').trim()
          );
          missing.push(taskDef ? taskDef.TaskName : `Task ${prereq.taskID}`);
        } else {
          const taskDef = (_rawConfig.esTasks || _rawConfig.tasks || []).find(t =>
            String(t.TaskID || '').trim() === String(prereq.taskID || '').trim()
          );
          satisfiedPrereqs.push(taskDef ? taskDef.TaskName : `Task ${prereq.taskID}`);
        }
      } else if (prereq.type === 'OR_WITH_CROSS_TRAINING') {
        // Complex OR: One of the options plus cross-training requirements
        const hasAny = prereq.options.some(option => {
          const hasMain = (_rawData.esMbrAchievements || []).some(a =>
            a.CAPID === capid &&
            a.AchvID === option.achvID &&
            String(a.Status || '').toUpperCase() === 'ACTIVE'
          );
          if (!hasMain) return false;

          // Check cross-training requirements
          const hasCrossTraining = option.crossTraining.some(ctID =>
            (_rawData.esMbrAchievements || []).some(a =>
              a.CAPID === capid &&
              a.AchvID === ctID &&
              String(a.Status || '').toUpperCase() === 'ACTIVE'
            )
          );
          return hasCrossTraining;
        });
        if (!hasAny) {
          missing.push('Cross-training requirement');
        } else {
          satisfiedPrereqs.push('Cross-training');
        }
      }
    });

    return {
      eligible: missing.length === 0,
      missing: missing,
      satisfiedPrereqs: satisfiedPrereqs
    };
  };

  // ES Helper: Check eligibility for a qualification
  const checkESQualificationEligibility = (achvID, member) => {
    const capid = member.CAPID;

    // Check special prerequisite cases first
    const specialCheck = checkSpecialPrerequisites(achvID, member);
    if (!specialCheck.eligible) {
      return {
        eligible: false,
        reasons: specialCheck.missing,
        prereqTree: null
      };
    }

    // Get prerequisite tree
    const prereqTree = buildESPrerequisiteTree(achvID);

    // Build list of achievement IDs that are handled by special cases
    // These should be excluded from tree-based checking to avoid duplicates
    const specialCase = ES_PREREQUISITE_SPECIAL_CASES[achvID];
    const specialCaseAchvIDs = new Set();
    if (specialCase && specialCase.specialPrereqs) {
      specialCase.specialPrereqs.forEach(prereq => {
        if (prereq.type === 'CONDITIONAL_MEMBER_TYPE') {
          // Both senior and cadet achievement IDs are handled by special case
          specialCaseAchvIDs.add(prereq.senior);
          specialCaseAchvIDs.add(prereq.cadet);
        }
      });
    }

    // Check if all prerequisites are met
    const checkPrereqs = (node) => {
      if (!node) return { eligible: true, missing: [] };

      // Skip if this is a repeated node (already shown above in tree)
      if (node.note) {
        return { eligible: true, missing: [] };
      }

      // Skip if this achievement is handled by special case logic
      if (specialCaseAchvIDs.has(node.achvID)) {
        return { eligible: true, missing: [] };
      }

      // SPECIAL HANDLING: Achievement 1 (Curry) vs Level 1
      // Achievement 1 (ID '95') is for cadets, Level 1 (ID '96') is for seniors
      // These are equivalent prerequisites but for different member types
      const memberType = String(member.Type || member.TYPE || '').toUpperCase();
      const isCadet = memberType === 'CADET';
      const isSenior = !isCadet;

      if (node.achvID === '95' || node.achvID === '96') {
        // '95' = Achievement 1 (Curry) for cadets
        // '96' = Level 1 for seniors

        if (isSenior) {
          // For senior members, check Level 1 completion in seniorLevels (E&T data)
          let hasLevel1 = (_rawData.seniorLevels || []).some(sl =>
            sl.CAPID === capid &&
            sl.Lvl === 'LV1' &&
            sl.Completed && sl.Completed !== '01/01/1900'
          );

          // Also check memberPaths for Level 1 completion
          if (!hasLevel1) {
            const level1Path = (_rawConfig.paths || []).find(p =>
              (p.PathName || '').includes('Level 1')
            );

            if (level1Path) {
              hasLevel1 = (_rawData.memberPaths || []).some(mp =>
                mp.CAPID === capid &&
                mp.PathID === level1Path.PathID &&
                mp.StatusID === '8' // Approved/Completed
              );
            }
          }

          if (!hasLevel1 && node.achvID !== achvID) {
            return { eligible: false, missing: ['Level 1'] };
          }
        } else {
          // For cadets, check Achievement 1 in esMbrAchievements
          const hasAchv1 = (_rawData.esMbrAchievements || []).some(a =>
            a.CAPID === capid &&
            a.AchvID === '95' &&
            String(a.Status || '').toUpperCase() === 'ACTIVE'
          );

          if (!hasAchv1 && node.achvID !== achvID) {
            return { eligible: false, missing: ['Achievement 1 (Curry)'] };
          }
        }
      } else {
        // Regular achievement checking
        const hasQual = (_rawData.esMbrAchievements || []).some(a =>
          a.CAPID === capid &&
          a.AchvID === node.achvID &&
          String(a.Status || '').toUpperCase() === 'ACTIVE'
        );

        if (!hasQual && node.achvID !== achvID) {
          return { eligible: false, missing: [node.name] };
        }
      }

      // Recursively check prerequisites
      const missing = [];
      node.prerequisites.forEach(prereq => {
        const result = checkPrereqs(prereq);
        if (!result.eligible) {
          missing.push(...result.missing);
        }
      });

      return {
        eligible: missing.length === 0,
        missing: missing
      };
    };

    const result = checkPrereqs(prereqTree);

    return {
      eligible: result.eligible,
      reasons: result.missing,
      prereqTree: prereqTree
    };
  };

  // ES Helper: Get all ES achievement definitions
  const getAllESAchievements = () => {
    return _rawConfig.esAchievements || [];
  };

  // Public API
  return {
    // Core ES functions
    buildESQualifications,
    buildESPrerequisiteTree,
    getESAchievementTasks,
    checkESQualificationEligibility,
    getAllESAchievements
  };
}
</script>

<script type="text/babel">
/**
 * ServicesESUnitAnalysisService.html
 *
 * Unit-level Emergency Services analysis service.
 * Analyzes ES readiness, team composition, qualification health, and risks.
 *
 * Dependencies:
 * - ConfigConstants.html (ES_TEAM_REQUIREMENTS, ES_READINESS_WEIGHTS, etc.)
 * - ServicesESDataService.html (buildESQualifications, etc.)
 */

function createESUnitAnalysisService(rawConfig, rawData, esDataService) {
  const _rawConfig = rawConfig;
  const _rawData = rawData;
  const _esDataService = esDataService;

  // Helper: Get active members for an org (or multiple orgs)
  // Includes seniors and cadets with ES qualifications, excludes Patrons and Cadet Sponsors
  const getMembersForOrg = (orgId, options = {}) => {
    const { includeDescendants = false, descendantOrgIds = [] } = options;

    const targetOrgIds = new Set([String(orgId || '').trim()]);
    if (includeDescendants && descendantOrgIds.length > 0) {
      descendantOrgIds.forEach(id => targetOrgIds.add(String(id || '').trim()));
    }

    // Excluded member types - Patrons and Cadet Sponsors cannot participate in ES
    const excludedMemberTypes = new Set(['PATRON', 'CADET SPONSOR']);

    return (_rawData.members || []).filter(m => {
      const status = String(m.MbrStatus || '').toUpperCase();
      const memberOrgId = String(m.ORGID || '').trim();
      const memberType = String(m.Type || '').toUpperCase();

      // Must be active, in target org, and not a Patron or Cadet Sponsor
      // Cadets are now included - they can hold ES qualifications and participate
      return status === 'ACTIVE' &&
             targetOrgIds.has(memberOrgId) &&
             !excludedMemberTypes.has(memberType);
    });
  };

  // Helper: Get all ES qualifications for a member (active only)
  const getMemberActiveQuals = (capid) => {
    return (_rawData.esMbrAchievements || []).filter(a =>
      a.CAPID === capid &&
      String(a.Status || '').toUpperCase() === 'ACTIVE' &&
      !ES_EXCLUDED_ACHIEVEMENT_IDS.has(a.AchvID) &&
      !ES_EXCLUDED_FUNCTIONAL_AREAS.has(
        (_rawConfig.esAchievements || []).find(def => def.AchvID === a.AchvID)?.FunctionalArea
      )
    );
  };

  // Helper: Get all ES qualifications for a member (any status)
  // Deduplicates so each AchvID appears only once with the most relevant status
  const getMemberAllQuals = (capid) => {
    const rawQuals = (_rawData.esMbrAchievements || []).filter(a =>
      a.CAPID === capid &&
      !ES_EXCLUDED_ACHIEVEMENT_IDS.has(a.AchvID) &&
      !ES_EXCLUDED_FUNCTIONAL_AREAS.has(
        (_rawConfig.esAchievements || []).find(def => def.AchvID === a.AchvID)?.FunctionalArea
      )
    );

    // Deduplicate: Keep only one record per AchvID, preferring Active > Training > Expired
    const qualMap = new Map();
    const statusPriority = { 'ACTIVE': 1, 'TRAINING': 2, 'NOT APPROVED': 3, 'EXPIRED': 4 };

    rawQuals.forEach(q => {
      const existing = qualMap.get(q.AchvID);
      const currentStatus = String(q.Status || '').toUpperCase();
      const currentPriority = statusPriority[currentStatus] || 999;

      if (!existing) {
        qualMap.set(q.AchvID, q);
      } else {
        const existingStatus = String(existing.Status || '').toUpperCase();
        const existingPriority = statusPriority[existingStatus] || 999;

        // Keep higher priority status (lower number = higher priority)
        if (currentPriority < existingPriority) {
          qualMap.set(q.AchvID, q);
        }
      }
    });

    return Array.from(qualMap.values());
  };

  // Calculate Field Operations capacity (Ground Teams + UDF combined)
  const calculateFieldOpsCapacity = (members) => {
    const fieldReq = ES_TEAM_REQUIREMENTS.fieldOps;
    let gtlCount = 0;
    let gtm1Count = 0;
    let gtm2Count = 0;
    let gtm3Count = 0;
    let udfCount = 0;
    let gbdCount = 0;
    const qualifiedMembers = [];

    members.forEach(m => {
      const quals = getMemberActiveQuals(m.CAPID);
      const positions = [];

      quals.forEach(q => {
        if (q.AchvID === fieldReq.achvIDs.GTL) {
          gtlCount++;
          positions.push('GTL');
        }
        // Track individual GTM levels
        if (q.AchvID === fieldReq.achvIDs.GTM1) {
          gtm1Count++;
          positions.push('GTM1');
        }
        if (q.AchvID === fieldReq.achvIDs.GTM2) {
          gtm2Count++;
          positions.push('GTM2');
        }
        if (q.AchvID === fieldReq.achvIDs.GTM3) {
          gtm3Count++;
          positions.push('GTM3');
        }
        if (q.AchvID === fieldReq.achvIDs.UDF) {
          udfCount++;
          positions.push('UDF');
        }
        if (q.AchvID === fieldReq.achvIDs.GBD) {
          gbdCount++;
          positions.push('GBD');
        }
      });

      if (positions.length > 0) {
        qualifiedMembers.push({
          capid: m.CAPID,
          name: `${m.NameFirst} ${m.NameLast}`,
          rank: m.Rank,
          positions
        });
      }
    });

    // Total GTM count for team calculation (any GTM level counts)
    const gtmTotal = gtm1Count + gtm2Count + gtm3Count;

    // Calculate ground teams fieldable
    // Per CAPR 60-3: Each team needs 1 GTL and 3 GTMs for a 4-person minimum team
    const groundTeamsFieldable = Math.min(gtlCount, Math.floor(gtmTotal / 3));
    const canFieldGround = gtlCount >= 1 && gtmTotal >= 3;

    // Calculate UDF teams fieldable (2 UDF members per team)
    const udfTeamsFieldable = Math.floor(udfCount / 2);
    const canFieldUDF = udfCount >= 2;

    // Overall field capability
    const canField = canFieldGround || canFieldUDF;

    const gaps = [];
    // Ground team gaps
    if (gtlCount < 1) gaps.push('Need 1 GTL for ground team');
    else if (gtlCount === 1 && canFieldGround) gaps.push('Single GTL (SPOF)');
    if (gtmTotal < 3) gaps.push(`Need ${3 - gtmTotal} more GTM`);
    // UDF gaps
    if (udfCount < 2) gaps.push(`Need ${2 - udfCount} more UDF`);

    // Determine color based on both capabilities
    let color = 'red';
    if (canFieldGround && canFieldUDF) {
      color = (groundTeamsFieldable >= 2 || udfTeamsFieldable >= 2) ? 'green' : 'blue';
    } else if (canFieldGround || canFieldUDF) {
      color = 'blue';
    } else if (gtlCount > 0 || gtmTotal > 0 || udfCount > 0) {
      color = 'amber';
    }

    return {
      name: fieldReq.name,
      shortName: fieldReq.shortName,
      icon: fieldReq.icon,
      canField,
      canFieldGround,
      canFieldUDF,
      groundTeamsFieldable,
      udfTeamsFieldable,
      positionCounts: { GTL: gtlCount, GTM1: gtm1Count, GTM2: gtm2Count, GTM3: gtm3Count, UDF: udfCount, GBD: gbdCount },
      gaps,
      qualifiedMembers,
      color
    };
  };

  // Calculate Aircrew capacity
  const calculateAircrewCapacity = (members) => {
    const airReq = ES_TEAM_REQUIREMENTS.aircrew;
    let mpCount = 0;   // SAR/DR Mission Pilot
    let tmpCount = 0;  // Transport Mission Pilot
    let msCount = 0;   // Mission Scanner
    let moCount = 0;   // Mission Observer
    let apCount = 0;   // Airborne Photographer
    let aobdCount = 0; // Air Operations Branch Director
    const qualifiedMembers = [];

    members.forEach(m => {
      const quals = getMemberActiveQuals(m.CAPID);
      const positions = [];

      quals.forEach(q => {
        // Track individual pilot types
        if (q.AchvID === airReq.achvIDs.MP) {
          mpCount++;
          positions.push('MP');
        }
        if (q.AchvID === airReq.achvIDs.TMP) {
          tmpCount++;
          positions.push('TMP');
        }
        // Track individual scanner types
        if (q.AchvID === airReq.achvIDs.MS) {
          msCount++;
          positions.push('MS');
        }
        if (q.AchvID === airReq.achvIDs.MO) {
          moCount++;
          positions.push('MO');
        }
        if (q.AchvID === airReq.achvIDs.AP) {
          apCount++;
          positions.push('AP');
        }
        if (q.AchvID === airReq.achvIDs.AOBD) {
          aobdCount++;
          positions.push('AOBD');
        }
      });

      if (positions.length > 0) {
        qualifiedMembers.push({
          capid: m.CAPID,
          name: `${m.NameFirst} ${m.NameLast}`,
          rank: m.Rank,
          positions
        });
      }
    });

    // Total pilots and scanners for team calculation
    const pilotTotal = mpCount + tmpCount;
    const scannerTotal = msCount + moCount;

    // Each aircrew needs 1 pilot and 1 scanner/observer
    const teamsFieldable = Math.min(pilotTotal, scannerTotal);
    const canField = pilotTotal >= 1 && scannerTotal >= 1;

    const gaps = [];
    if (pilotTotal < 1) gaps.push('Need 1 pilot (MP/TMP)');
    else if (pilotTotal === 1) gaps.push('Single pilot (SPOF risk)');
    if (scannerTotal < 1) gaps.push('Need 1 scanner (MS/MO)');

    return {
      name: airReq.name,
      shortName: airReq.shortName,
      icon: airReq.icon,
      canField,
      teamsFieldable,
      positionCounts: { MP: mpCount, TMP: tmpCount, MS: msCount, MO: moCount, AP: apCount, AOBD: aobdCount },
      gaps,
      qualifiedMembers,
      color: canField ? (teamsFieldable >= 2 ? 'green' : 'blue') : (pilotTotal > 0 || scannerTotal > 0 ? 'amber' : 'red')
    };
  };

  // Calculate sUAS capacity
  const calculateSUASCapacity = (members) => {
    const suasReq = ES_TEAM_REQUIREMENTS.suas;
    let uasmpCount = 0;
    let uastCount = 0;
    const qualifiedMembers = [];

    members.forEach(m => {
      const quals = getMemberActiveQuals(m.CAPID);
      const positions = [];

      quals.forEach(q => {
        if (q.AchvID === suasReq.achvIDs.UASMP) {
          uasmpCount++;
          positions.push('UASMP');
        }
        if (q.AchvID === suasReq.achvIDs.UAST) {
          uastCount++;
          positions.push('UAST');
        }
      });

      if (positions.length > 0) {
        qualifiedMembers.push({
          capid: m.CAPID,
          name: `${m.NameFirst} ${m.NameLast}`,
          rank: m.Rank,
          positions
        });
      }
    });

    const teamsFieldable = Math.min(uasmpCount, uastCount);
    const canField = uasmpCount >= 1 && uastCount >= 1;

    const gaps = [];
    if (uasmpCount < 1) gaps.push('Need 1 UASMP');
    if (uastCount < 1) gaps.push('Need 1 UAST');

    return {
      name: suasReq.name,
      shortName: suasReq.shortName,
      icon: suasReq.icon,
      canField,
      teamsFieldable,
      positionCounts: { UASMP: uasmpCount, UAST: uastCount },
      gaps,
      qualifiedMembers,
      color: canField ? 'green' : (uasmpCount > 0 || uastCount > 0 ? 'amber' : 'red')
    };
  };

  // Calculate Mission Base staffing (qualified personnel, not teams)
  const calculateMissionBaseCapacity = (members) => {
    const baseReq = ES_TEAM_REQUIREMENTS.missionBase;
    const positionCounts = {};
    const qualifiedMembers = [];

    baseReq.positions.forEach(pos => {
      positionCounts[pos.code] = 0;
    });

    members.forEach(m => {
      const quals = getMemberActiveQuals(m.CAPID);
      const positions = [];

      quals.forEach(q => {
        const posInfo = baseReq.positions.find(p => p.achvID === q.AchvID);
        if (posInfo) {
          positionCounts[posInfo.code]++;
          positions.push(posInfo.code);
        }
      });

      if (positions.length > 0) {
        qualifiedMembers.push({
          capid: m.CAPID,
          name: `${m.NameFirst} ${m.NameLast}`,
          rank: m.Rank,
          positions
        });
      }
    });

    // Count total qualified personnel (unique members with base quals)
    const qualifiedCount = qualifiedMembers.length;
    // Count how many different position types are covered
    const positionsCovered = Object.values(positionCounts).filter(c => c > 0).length;
    const totalPositionTypes = baseReq.positions.length;

    // Check if minimum required positions are covered
    const hasMinimum = baseReq.minimumPositions.every(code => positionCounts[code] >= 1);

    const gaps = [];
    baseReq.minimumPositions.forEach(code => {
      if (positionCounts[code] < 1) {
        gaps.push(`Need ${code}`);
      }
    });

    return {
      name: baseReq.name,
      shortName: baseReq.shortName,
      icon: baseReq.icon,
      isStaffing: true,  // Indicates this is staffing, not team-based
      qualifiedCount,
      positionsCovered,
      totalPositionTypes,
      hasMinimum,
      positionCounts,
      gaps,
      qualifiedMembers,
      color: positionsCovered >= 6 ? 'green' : positionsCovered >= 4 ? 'blue' : positionsCovered >= 2 ? 'amber' : 'red'
    };
  };

  // Calculate Command Staff staffing (qualified personnel, not teams)
  const calculateCommandCapacity = (members) => {
    const cmdReq = ES_TEAM_REQUIREMENTS.command;
    const positionCounts = {};
    const qualifiedMembers = [];
    let hasIC = false;
    let sectionChiefCount = 0;

    cmdReq.positions.forEach(pos => {
      positionCounts[pos.code] = 0;
    });

    members.forEach(m => {
      const quals = getMemberActiveQuals(m.CAPID);
      const positions = [];

      quals.forEach(q => {
        const posInfo = cmdReq.positions.find(p => p.achvID === q.AchvID);
        if (posInfo) {
          positionCounts[posInfo.code]++;
          positions.push(posInfo.code);

          if (cmdReq.icAchvIDs.includes(q.AchvID)) hasIC = true;
          if (cmdReq.sectionChiefAchvIDs.includes(q.AchvID)) sectionChiefCount++;
        }
      });

      if (positions.length > 0) {
        qualifiedMembers.push({
          capid: m.CAPID,
          name: `${m.NameFirst} ${m.NameLast}`,
          rank: m.Rank,
          positions
        });
      }
    });

    // Count total qualified personnel and positions covered
    const qualifiedCount = qualifiedMembers.length;
    const positionsCovered = Object.values(positionCounts).filter(c => c > 0).length;
    const totalPositionTypes = cmdReq.positions.length;

    const gaps = [];
    if (!hasIC) gaps.push('Need IC');
    if (sectionChiefCount < 2) gaps.push('Limited section chiefs');

    return {
      name: cmdReq.name,
      shortName: cmdReq.shortName,
      icon: cmdReq.icon,
      isStaffing: true,  // Indicates this is staffing, not team-based
      qualifiedCount,
      positionsCovered,
      totalPositionTypes,
      hasIC,
      sectionChiefCount,
      positionCounts,
      gaps,
      qualifiedMembers,
      color: hasIC && sectionChiefCount >= 3 ? 'green' :
             hasIC && sectionChiefCount >= 1 ? 'blue' :
             hasIC || sectionChiefCount > 0 ? 'amber' : 'red'
    };
  };

  // Build set of displayed Achievement IDs from ES_TEAM_REQUIREMENTS
  // Only OPERATIONAL qualifications are counted in the summary
  // GES and SET are foundational/administrative and not counted here
  const getDisplayedAchievementIDs = () => {
    const displayed = new Set();

    // Field Operations
    Object.values(ES_TEAM_REQUIREMENTS.fieldOps.achvIDs).forEach(id => displayed.add(id));

    // Aircrew
    Object.values(ES_TEAM_REQUIREMENTS.aircrew.achvIDs).forEach(id => displayed.add(id));

    // sUAS
    Object.values(ES_TEAM_REQUIREMENTS.suas.achvIDs).forEach(id => displayed.add(id));

    // Mission Base
    ES_TEAM_REQUIREMENTS.missionBase.positions.forEach(pos => displayed.add(pos.achvID));

    // Command
    ES_TEAM_REQUIREMENTS.command.positions.forEach(pos => displayed.add(pos.achvID));

    // NOTE: GES and SET are NOT included in active count - they are foundational/administrative
    // GES is tracked separately in missingGES array
    // SET is tracked in evaluator availability section

    return displayed;
  };

  // Calculate qualification summary across all members
  // Only counts qualifications that are displayed in the ES team capability sections
  const calculateQualificationSummary = (members) => {
    const today = new Date();
    const in90Days = new Date();
    in90Days.setDate(in90Days.getDate() + 90);

    const displayedAchvIDs = getDisplayedAchievementIDs();

    let activeCount = 0;
    let trainingCount = 0;
    let expiredCount = 0;
    const expiringWithin90Days = [];
    const missingGES = [];
    const byFunctionalArea = {};

    members.forEach(m => {
      const allQuals = getMemberAllQuals(m.CAPID);
      const hasGES = allQuals.some(q =>
        q.AchvID === ES_DASHBOARD_SPECIAL.GES &&
        String(q.Status || '').toUpperCase() === 'ACTIVE'
      );

      if (!hasGES) {
        missingGES.push({
          capid: m.CAPID,
          name: `${m.NameFirst} ${m.NameLast}`,
          rank: m.Rank
        });
      }

      allQuals.forEach(q => {
        // Only count qualifications that are displayed in the team capability sections
        if (!displayedAchvIDs.has(q.AchvID)) return;

        const status = String(q.Status || '').toUpperCase();
        const achvDef = (_rawConfig.esAchievements || []).find(def => def.AchvID === q.AchvID);
        const functionalArea = achvDef?.FunctionalArea || 'Unknown';

        if (!byFunctionalArea[functionalArea]) {
          byFunctionalArea[functionalArea] = { active: 0, training: 0, expired: 0 };
        }

        if (status === 'ACTIVE') {
          activeCount++;
          byFunctionalArea[functionalArea].active++;

          // Check if expiring soon
          if (q.Expiration && q.Expiration !== '01/01/1900') {
            const expDate = new Date(q.Expiration);
            if (expDate >= today && expDate <= in90Days) {
              const daysUntil = Math.floor((expDate - today) / (1000 * 60 * 60 * 24));
              expiringWithin90Days.push({
                capid: m.CAPID,
                name: `${m.NameFirst} ${m.NameLast}`,
                rank: m.Rank,
                qualification: achvDef?.Achv || q.AchvID,
                achvID: q.AchvID,
                expiration: q.Expiration,
                daysUntil,
                urgency: daysUntil <= 30 ? 'critical' : daysUntil <= 60 ? 'warning' : 'notice'
              });
            }
          }
        } else if (status === 'TRAINING') {
          trainingCount++;
          byFunctionalArea[functionalArea].training++;
        } else if (status === 'EXPIRED') {
          expiredCount++;
          byFunctionalArea[functionalArea].expired++;
        }
      });
    });

    // Sort expiring by urgency
    expiringWithin90Days.sort((a, b) => a.daysUntil - b.daysUntil);

    return {
      byStatus: { active: activeCount, training: trainingCount, expired: expiredCount },
      byFunctionalArea,
      expiringWithin90Days,
      missingGES,
      healthRatio: activeCount > 0 ? Math.round((activeCount / (activeCount + expiredCount)) * 100) : 0
    };
  };

  // Calculate evaluator availability
  const calculateEvaluatorAvailability = (members) => {
    const evaluators = [];
    const qualsCovered = new Set();

    members.forEach(m => {
      const quals = getMemberActiveQuals(m.CAPID);
      const hasSET = quals.some(q => q.AchvID === ES_ACHIEVEMENT_IDS.SET_ACTUAL);

      if (!hasSET) return;

      // Check which qualifications they can evaluate
      const canEvaluate = [];
      quals.forEach(q => {
        // Must have held qual for 1+ year
        if (q.Completed && q.Completed !== '01/01/1900') {
          const completedDate = new Date(q.Completed);
          const oneYearAgo = new Date();
          oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

          if (completedDate <= oneYearAgo &&
              !ES_NO_SKILLS_EVALUATOR_IDS.has(q.AchvID) &&
              ES_SKILLS_EVALUATOR_ALLOWED_FUNCTIONAL_AREAS.has(
                (_rawConfig.esAchievements || []).find(def => def.AchvID === q.AchvID)?.FunctionalArea
              )) {
            const achvDef = (_rawConfig.esAchievements || []).find(def => def.AchvID === q.AchvID);
            canEvaluate.push({
              achvID: q.AchvID,
              name: achvDef?.Achv || q.AchvID
            });
            qualsCovered.add(q.AchvID);
          }
        }
      });

      if (canEvaluate.length > 0) {
        evaluators.push({
          capid: m.CAPID,
          name: `${m.NameFirst} ${m.NameLast}`,
          rank: m.Rank,
          canEvaluate
        });
      }
    });

    // Determine gaps - qualifications with active holders but no evaluators
    const activeQuals = new Set();
    members.forEach(m => {
      getMemberActiveQuals(m.CAPID).forEach(q => {
        if (!ES_NO_SKILLS_EVALUATOR_IDS.has(q.AchvID) &&
            ES_SKILLS_EVALUATOR_ALLOWED_FUNCTIONAL_AREAS.has(
              (_rawConfig.esAchievements || []).find(def => def.AchvID === q.AchvID)?.FunctionalArea
            )) {
          activeQuals.add(q.AchvID);
        }
      });
    });

    const gaps = [];
    activeQuals.forEach(achvID => {
      if (!qualsCovered.has(achvID)) {
        const achvDef = (_rawConfig.esAchievements || []).find(def => def.AchvID === achvID);
        gaps.push(achvDef?.Achv || achvID);
      }
    });

    const coverage = activeQuals.size > 0
      ? Math.round((qualsCovered.size / activeQuals.size) * 100)
      : 0;

    return {
      available: evaluators,
      qualsCovered: Array.from(qualsCovered),
      gaps,
      coverage,
      evaluatorCount: evaluators.length
    };
  };

  // Identify single points of failure
  const identifySinglePointsOfFailure = (members, teamCapacities) => {
    const spofs = [];

    // Check Field Operations (Ground Team)
    if (teamCapacities.fieldOps.positionCounts.GTL === 1) {
      const gtl = teamCapacities.fieldOps.qualifiedMembers.find(m =>
        m.positions.includes('GTL')
      );
      if (gtl) {
        spofs.push({
          position: 'GTL',
          positionName: 'Ground Team Leader',
          member: gtl.name,
          capid: gtl.capid,
          impact: 'Cannot field any ground teams without GTL',
          severity: 'high'
        });
      }
    }

    // Check Aircrew - use sum of individual pilot positions
    const pilotTotal = (teamCapacities.aircrew.positionCounts.MP || 0) + (teamCapacities.aircrew.positionCounts.TMP || 0);
    if (pilotTotal === 1) {
      const pilot = teamCapacities.aircrew.qualifiedMembers.find(m =>
        m.positions.includes('MP') || m.positions.includes('TMP')
      );
      if (pilot) {
        spofs.push({
          position: 'Pilot',
          positionName: 'Mission Pilot',
          member: pilot.name,
          capid: pilot.capid,
          impact: 'Cannot field any aircrews without pilot',
          severity: 'high'
        });
      }
    }

    // Check Scanner - use sum of individual scanner positions
    const scannerTotal = (teamCapacities.aircrew.positionCounts.MS || 0) + (teamCapacities.aircrew.positionCounts.MO || 0);
    if (scannerTotal === 1) {
      const scanner = teamCapacities.aircrew.qualifiedMembers.find(m =>
        m.positions.includes('MS') || m.positions.includes('MO')
      );
      if (scanner) {
        spofs.push({
          position: 'Scanner',
          positionName: 'Mission Scanner/Observer',
          member: scanner.name,
          capid: scanner.capid,
          impact: 'Cannot field any aircrews without scanner',
          severity: 'high'
        });
      }
    }

    // Check Command
    if (teamCapacities.command.hasIC) {
      const icCount = (teamCapacities.command.positionCounts.IC3 || 0) +
                      (teamCapacities.command.positionCounts.IC2 || 0) +
                      (teamCapacities.command.positionCounts.IC1 || 0);
      if (icCount === 1) {
        const ic = teamCapacities.command.qualifiedMembers.find(m =>
          m.positions.some(p => ['IC3', 'IC2', 'IC1'].includes(p))
        );
        if (ic) {
          spofs.push({
            position: 'IC',
            positionName: 'Incident Commander',
            member: ic.name,
            capid: ic.capid,
            impact: 'Limited command flexibility',
            severity: 'medium'
          });
        }
      }
    }

    return spofs;
  };

  // Get training pipeline (members close to qualification)
  const calculateTrainingPipeline = (members) => {
    const nearQualification = [];
    const activeTraining = [];

    members.forEach(m => {
      const allQuals = getMemberAllQuals(m.CAPID);

      allQuals.forEach(q => {
        const status = String(q.Status || '').toUpperCase();
        if (status === 'TRAINING') {
          const achvDef = (_rawConfig.esAchievements || []).find(def => def.AchvID === q.AchvID);
          activeTraining.push({
            capid: m.CAPID,
            name: `${m.NameFirst} ${m.NameLast}`,
            rank: m.Rank,
            qualification: achvDef?.Achv || q.AchvID,
            achvID: q.AchvID,
            position: ES_ACHV_TO_POSITION[q.AchvID] || 'Unknown'
          });
        }
      });
    });

    return {
      nearQualification,
      activeTraining
    };
  };

  // Generate recommendations based on analysis
  const generateRecommendations = (analysis) => {
    const recommendations = [];

    // Critical gaps
    if (!analysis.teams.fieldOps.canField && !analysis.teams.aircrew.canField) {
      recommendations.push({
        priority: 'critical',
        area: 'Team Capability',
        recommendation: 'Unit cannot field any operational teams. Prioritize GTL and pilot training.',
        impact: 'Cannot participate in operational missions'
      });
    }

    // SPOFs
    analysis.risks.singlePointsOfFailure.forEach(spof => {
      if (spof.severity === 'high') {
        recommendations.push({
          priority: 'high',
          area: 'Resilience',
          recommendation: `Train backup ${spof.positionName} - ${spof.member} is single point of failure`,
          impact: spof.impact
        });
      }
    });

    // Expiring qualifications
    const criticalExpiring = analysis.qualifications.expiringWithin90Days.filter(e => e.urgency === 'critical');
    if (criticalExpiring.length > 0) {
      recommendations.push({
        priority: 'high',
        area: 'Currency',
        recommendation: `${criticalExpiring.length} critical qualification(s) expiring within 30 days`,
        impact: 'May lose team capability if not renewed'
      });
    }

    // Missing GES
    if (analysis.qualifications.missingGES.length > 0) {
      recommendations.push({
        priority: 'medium',
        area: 'Foundation',
        recommendation: `${analysis.qualifications.missingGES.length} senior member(s) without GES - required for all ES activities`,
        impact: 'Cannot participate in ES missions'
      });
    }

    // Evaluator gaps
    if (analysis.evaluators.gaps.length > 0) {
      recommendations.push({
        priority: 'medium',
        area: 'Evaluation',
        recommendation: `No evaluators available for ${analysis.evaluators.gaps.length} qualification(s)`,
        impact: 'May need external support for qualification sign-offs'
      });
    }

    // sUAS opportunity
    if (!analysis.teams.suas.canField && analysis.teams.fieldOps.canField) {
      recommendations.push({
        priority: 'low',
        area: 'Capability Expansion',
        recommendation: 'Consider sUAS training to add aerial reconnaissance capability',
        impact: 'Expands mission options'
      });
    }

    return recommendations;
  };

  // Calculate overall readiness score
  const calculateReadinessScore = (analysis) => {
    const weights = ES_READINESS_WEIGHTS;

    // Team Capability Score (35%)
    // Field Ops: Can field ground team or UDF team
    const fieldOpsTeams = (analysis.teams.fieldOps.groundTeamsFieldable || 0) + (analysis.teams.fieldOps.udfTeamsFieldable || 0);
    // Calculate totals from individual position counts
    const pilotTotal = (analysis.teams.aircrew.positionCounts.MP || 0) + (analysis.teams.aircrew.positionCounts.TMP || 0);
    const teamScores = {
      fieldOps: analysis.teams.fieldOps.canField ?
        (fieldOpsTeams >= 2 ? 100 : 80) :
        (analysis.teams.fieldOps.positionCounts.GTL > 0 || analysis.teams.fieldOps.positionCounts.UDF > 0 ? 40 : 0),
      aircrew: analysis.teams.aircrew.canField ?
        (analysis.teams.aircrew.teamsFieldable >= 2 ? 100 : 80) :
        (pilotTotal > 0 ? 40 : 0),
      suas: analysis.teams.suas.canField ? 100 : 0,
      missionBase: (analysis.teams.missionBase.positionsCovered / analysis.teams.missionBase.totalPositionTypes) * 100,
      command: analysis.teams.command.hasIC ?
        (analysis.teams.command.sectionChiefCount >= 3 ? 100 : 70) : 30
    };
    const teamScore = (teamScores.fieldOps * 0.3 + teamScores.aircrew * 0.3 +
                       teamScores.suas * 0.1 + teamScores.missionBase * 0.15 +
                       teamScores.command * 0.15);

    // Qualification Health Score (25%)
    const qualScore = analysis.qualifications.healthRatio;

    // Evaluator Coverage Score (15%)
    const evaluatorScore = analysis.evaluators.coverage;

    // Risk Mitigation Score (15%)
    const spofCount = analysis.risks.singlePointsOfFailure.length;
    const riskScore = Math.max(0, 100 - (spofCount * 25));

    // Pipeline Score (10%)
    const pipelineScore = analysis.pipeline.activeTraining.length > 0 ?
      Math.min(100, 50 + analysis.pipeline.activeTraining.length * 10) : 30;

    const overallScore = Math.round(
      teamScore * weights.teamCapability +
      qualScore * weights.qualificationHealth +
      evaluatorScore * weights.evaluatorCoverage +
      riskScore * weights.riskMitigation +
      pipelineScore * weights.pipelineStrength
    );

    const score = Math.max(0, Math.min(100, overallScore));
    const rating = score >= ES_READINESS_THRESHOLDS.excellent ? 'excellent' :
                   score >= ES_READINESS_THRESHOLDS.good ? 'good' :
                   score >= ES_READINESS_THRESHOLDS.fair ? 'fair' : 'needs-attention';

    return {
      score,
      rating,
      components: {
        teamScore: Math.round(teamScore),
        qualScore,
        evaluatorScore,
        riskScore,
        pipelineScore
      }
    };
  };

  // Generate quick summary text
  const generateQuickSummary = (teams) => {
    const summaryParts = [];

    // Field Operations (Ground Team + UDF combined)
    if (teams.fieldOps.canFieldGround) {
      summaryParts.push(`${teams.fieldOps.groundTeamsFieldable} ground team${teams.fieldOps.groundTeamsFieldable !== 1 ? 's' : ''}`);
    }
    if (teams.fieldOps.canFieldUDF) {
      summaryParts.push(`${teams.fieldOps.udfTeamsFieldable} UDF team${teams.fieldOps.udfTeamsFieldable !== 1 ? 's' : ''}`);
    }
    if (teams.aircrew.canField) {
      summaryParts.push(`${teams.aircrew.teamsFieldable} aircrew${teams.aircrew.teamsFieldable !== 1 ? 's' : ''}`);
    }
    if (teams.suas.canField) {
      summaryParts.push('sUAS team');
    }

    if (summaryParts.length === 0) {
      // Check for partial capability
      const partialParts = [];
      const gtmTotal = (teams.fieldOps.positionCounts.GTM1 || 0) +
                       (teams.fieldOps.positionCounts.GTM2 || 0) +
                       (teams.fieldOps.positionCounts.GTM3 || 0);
      if (teams.fieldOps.positionCounts.GTL > 0 || gtmTotal > 0) {
        partialParts.push('ground');
      }
      if (teams.fieldOps.positionCounts.UDF > 0) {
        partialParts.push('UDF');
      }
      const pilotTotal = (teams.aircrew.positionCounts.MP || 0) + (teams.aircrew.positionCounts.TMP || 0);
      const scannerTotal = (teams.aircrew.positionCounts.MS || 0) + (teams.aircrew.positionCounts.MO || 0);
      if (pilotTotal > 0 || scannerTotal > 0) {
        partialParts.push('air');
      }
      if (partialParts.length > 0) {
        return `Partial ${partialParts.join('/')} capability`;
      }
      return 'No operational teams available';
    }

    return `Can field ${summaryParts.join(', ')}`;
  };

  // Main analysis entry point
  const analyzeUnit = (orgId, options = {}) => {
    const members = getMembersForOrg(orgId, options);

    if (members.length === 0) {
      return {
        readinessScore: 0,
        readinessRating: 'needs-attention',
        quickSummary: 'No active members',
        memberCount: 0,
        teams: {
          fieldOps: { canField: false, canFieldGround: false, canFieldUDF: false, groundTeamsFieldable: 0, udfTeamsFieldable: 0, gaps: [], color: 'red', positionCounts: {} },
          aircrew: { canField: false, teamsFieldable: 0, gaps: [], color: 'red', positionCounts: {} },
          suas: { canField: false, teamsFieldable: 0, gaps: [], color: 'red', positionCounts: {} },
          missionBase: { isStaffing: true, qualifiedCount: 0, positionsCovered: 0, totalPositionTypes: 8, gaps: [], color: 'red', positionCounts: {} },
          command: { isStaffing: true, qualifiedCount: 0, hasIC: false, sectionChiefCount: 0, gaps: [], color: 'red', positionCounts: {} }
        },
        qualifications: {
          byStatus: { active: 0, training: 0, expired: 0 },
          expiringWithin90Days: [],
          missingGES: [],
          healthRatio: 0
        },
        evaluators: { available: [], gaps: [], coverage: 0 },
        risks: { singlePointsOfFailure: [], criticalGaps: [], recommendations: [] },
        pipeline: { nearQualification: [], activeTraining: [] }
      };
    }

    // Calculate team capacities
    const teams = {
      fieldOps: calculateFieldOpsCapacity(members),
      aircrew: calculateAircrewCapacity(members),
      suas: calculateSUASCapacity(members),
      missionBase: calculateMissionBaseCapacity(members),
      command: calculateCommandCapacity(members)
    };

    // Calculate other metrics
    const qualifications = calculateQualificationSummary(members);
    const evaluators = calculateEvaluatorAvailability(members);
    const pipeline = calculateTrainingPipeline(members);
    const singlePointsOfFailure = identifySinglePointsOfFailure(members, teams);

    // Build analysis object
    const analysis = {
      teams,
      qualifications,
      evaluators,
      pipeline,
      risks: {
        singlePointsOfFailure,
        criticalGaps: []
      },
      memberCount: members.length
    };

    // Add critical gaps
    if (!teams.fieldOps.canField) analysis.risks.criticalGaps.push('Cannot field ground/UDF team');
    if (!teams.aircrew.canField) analysis.risks.criticalGaps.push('Cannot field aircrew');

    // Calculate readiness score
    const readiness = calculateReadinessScore(analysis);

    // Generate recommendations
    analysis.risks.recommendations = generateRecommendations(analysis);

    // Generate quick summary
    const quickSummary = generateQuickSummary(teams);

    return {
      ...analysis,
      readinessScore: readiness.score,
      readinessRating: readiness.rating,
      readinessComponents: readiness.components,
      quickSummary
    };
  };

  // Get key data for collapsed view
  const getKeyDataSummary = (orgId, options = {}) => {
    const analysis = analyzeUnit(orgId, options);
    return {
      quickSummary: analysis.quickSummary,
      readinessScore: analysis.readinessScore,
      readinessRating: analysis.readinessRating,
      expiringCount: analysis.qualifications.expiringWithin90Days.length,
      teamStatus: {
        fieldOps: analysis.teams.fieldOps.color,
        aircrew: analysis.teams.aircrew.color,
        suas: analysis.teams.suas.color,
        missionBase: analysis.teams.missionBase.color,
        command: analysis.teams.command.color
      }
    };
  };

  // Get metrics for multiple units (for aggregate view)
  const getMetricsForMultipleUnits = (orgIds, options = {}) => {
    return orgIds.map(orgId => {
      const analysis = analyzeUnit(orgId, { includeDescendants: false });
      return {
        orgId,
        readinessScore: analysis.readinessScore,
        readinessRating: analysis.readinessRating,
        canFieldOps: analysis.teams.fieldOps.canField,
        canFieldAir: analysis.teams.aircrew.canField,
        canFieldSUAS: analysis.teams.suas.canField,
        expiringCount: analysis.qualifications.expiringWithin90Days.length,
        memberCount: analysis.memberCount,
        teamStatus: {
          fieldOps: analysis.teams.fieldOps.color,
          aircrew: analysis.teams.aircrew.color,
          suas: analysis.teams.suas.color,
          missionBase: analysis.teams.missionBase.color,
          command: analysis.teams.command.color
        }
      };
    });
  };

  // Public API
  return {
    analyzeUnit,
    getKeyDataSummary,
    getMetricsForMultipleUnits,
    // Individual calculation functions (for testing/debugging)
    calculateFieldOpsCapacity,
    calculateAircrewCapacity,
    calculateSUASCapacity,
    calculateMissionBaseCapacity,
    calculateCommandCapacity,
    calculateQualificationSummary,
    calculateEvaluatorAvailability
  };
}
</script>

<script type="text/babel">
/**
 * ServicesOrgStatsDataService.html
 *
 * Recruiting & Retention data processing service.
 * Provides aggregation and analysis of historical membership statistics
 * from ORGStatistics data.
 *
 * Member Type Categories:
 * - Senior Program: SENIOR, FIFTY YEAR, LIFE (full senior members)
 * - Cadet Program: CADET (youth members)
 * - Cadet Sponsors: CADET SPONSOR (adults supporting cadet program only)
 * - Patron: PATRON (financial supporters, rarely used)
 * - Other: AEM, etc.
 *
 * Dependencies:
 * - UtilsDataParsing.html (parseCSV)
 */

function createOrgStatsDataService() {
  let _rawData = [];
  let _orgIndex = new Map();

  // === MEMBER TYPE CLASSIFICATION ===
  // Maps raw MbrType values to program categories
  const MEMBER_TYPE_MAP = {
    'SENIOR': 'senior',
    'FIFTY YEAR': 'senior',  // 50+ year members are still seniors
    'LIFE': 'senior',         // Life members are still seniors
    'CADET': 'cadet',
    'CADET SPONSOR': 'cadetSponsor',
    'PATRON': 'patron',
    'AEM': 'other'
  };

  // Which categories to include in "combined" totals (main operational membership)
  const OPERATIONAL_CATEGORIES = ['senior', 'cadet'];

  // Metric explanations for UI help text
  const METRIC_EXPLANATIONS = {
    recruitingRate: {
      label: 'Recruiting Rate',
      shortDesc: 'New + returning members per month',
      fullDesc: 'Average number of new members and rejoining former members your unit gains each month. This shows how effective your recruiting efforts are.',
      howToImprove: 'Host open houses, attend community events, leverage social media, partner with schools and community organizations.',
      goodValue: '2+ per month for squadrons',
      formula: '(New Members + Rejoins) Ã· Number of Months'
    },
    retentionRate: {
      label: 'Retention Rate',
      shortDesc: 'Percentage of members who renew',
      fullDesc: 'Of members eligible for renewal, what percentage actually renewed their membership. High retention means members find value in CAP.',
      howToImprove: 'Engage members in meaningful activities, recognize achievements, maintain regular communication, address concerns promptly.',
      goodValue: '80%+ is healthy',
      formula: 'Renewals Ã· (Renewals + Estimated Attrition) Ã— 100'
    },
    netChange: {
      label: 'Net Growth',
      shortDesc: '12-month membership change',
      fullDesc: 'The difference between your current membership and 12 months ago. Positive means growth, negative means decline.',
      howToImprove: 'Focus on both recruiting AND retention. Growing units recruit enough to offset natural attrition plus add new members.',
      goodValue: 'Positive growth year-over-year',
      formula: 'Current Total - Total 12 Months Ago'
    },
    stability: {
      label: 'Stability',
      shortDesc: 'Month-to-month consistency',
      fullDesc: 'How consistent your membership numbers are month-to-month. High stability means predictable membership levels.',
      howToImprove: 'Steady recruiting throughout the year, proactive retention outreach before expiration dates.',
      goodValue: 'Low variation (<10%)',
      formula: 'Based on coefficient of variation in monthly totals'
    },
    attritionRate: {
      label: 'Attrition Rate',
      shortDesc: 'Members lost per year',
      fullDesc: 'The estimated number of members your unit loses annually through non-renewal or transfer. Understanding attrition helps you plan recruiting to maintain or grow membership.',
      howToImprove: 'Focus on member engagement, address concerns early, ensure meaningful activities for all members.',
      goodValue: 'Lower than recruiting rate',
      formula: 'Estimated from: Recruited - Net Change'
    },
    newMembers: {
      label: 'New Members',
      shortDesc: 'First-time joins + returning members',
      fullDesc: 'Total count of brand new members who joined plus former members who rejoined during the time period.',
      howToImprove: 'Host open houses, partner with schools, leverage social media, attend community events.',
      goodValue: 'At least 2 per month for squadrons'
    },
    renewals: {
      label: 'Renewals',
      shortDesc: 'Members who renewed membership',
      fullDesc: 'Count of existing members who renewed their annual membership during the time period. High renewals indicate member satisfaction.',
      howToImprove: 'Send reminders before expiration, keep members engaged with meaningful activities.',
      goodValue: 'Higher than attrition'
    },
    dataPoints: {
      label: 'Data Points',
      shortDesc: 'Months of data analyzed',
      fullDesc: 'The number of monthly data points included in this analysis. More data points provide more reliable trends and seasonality patterns.',
      howToImprove: 'Select a longer time range to see more historical data.',
      goodValue: '24+ months for seasonality analysis'
    },
    sustainability: {
      label: 'Sustainability Score',
      shortDesc: 'Overall membership health',
      fullDesc: 'A composite score (0-100) combining recruiting, retention, growth, and stability. Higher scores indicate a healthier, more sustainable unit.',
      howToImprove: 'Address your lowest-scoring component first for the biggest impact.',
      goodValue: '65+ is good, 80+ is excellent',
      formula: '25% Recruiting + 35% Retention + 25% Growth + 15% Stability'
    }
  };

  // === INITIALIZATION ===
  const initialize = (orgStatsRaw) => {
    if (!orgStatsRaw) {
      console.warn('OrgStatsDataService: No org stats data provided');
      return;
    }
    _rawData = parseCSV(orgStatsRaw) || [];
    buildIndexes();
  };

  const buildIndexes = () => {
    _orgIndex.clear();

    _rawData.forEach(row => {
      const orgId = row.ORGID;
      if (!_orgIndex.has(orgId)) _orgIndex.set(orgId, []);
      _orgIndex.get(orgId).push(row);
    });
  };

  /**
   * Classify a raw member type to a category
   */
  const classifyMemberType = (rawType) => {
    const normalized = (rawType || '').trim().toUpperCase();
    return MEMBER_TYPE_MAP[normalized] || 'other';
  };

  // === DATE UTILITIES ===
  const parseDate = (dateStr) => {
    if (!dateStr) return null;
    // Format: MM/DD/YYYY
    const parts = dateStr.split('/');
    if (parts.length !== 3) return null;
    const [month, day, year] = parts;
    return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
  };

  const getMonthsAgo = (months) => {
    const date = new Date();
    date.setMonth(date.getMonth() - months);
    return date;
  };

  const formatMonthLabel = (dateStr) => {
    const date = parseDate(dateStr);
    if (!date) return dateStr;
    return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
  };

  // === FILTERING ===
  const getDataForOrg = (orgId, includeDescendants = false, descendantOrgIds = []) => {
    const validOrgIds = includeDescendants
      ? new Set([String(orgId), ...descendantOrgIds.map(id => String(id))])
      : new Set([String(orgId)]);

    return _rawData.filter(row => validOrgIds.has(String(row.ORGID)));
  };

  const getDataInTimeRange = (data, startDate, endDate = new Date()) => {
    return data.filter(row => {
      const rowDate = parseDate(row.CntDate);
      if (!rowDate) return false;
      return rowDate >= startDate && rowDate <= endDate;
    });
  };

  // === AGGREGATION ===
  /**
   * Aggregate data by month with proper member type categorization
   *
   * Categories tracked:
   * - senior: SENIOR + FIFTY YEAR + LIFE (operational senior members)
   * - cadet: CADET (youth members)
   * - cadetSponsor: CADET SPONSOR (adult sponsors, tracked separately)
   * - combined: senior + cadet (main operational membership)
   * - all: everything including sponsors, patron
   */
  const aggregateByMonth = (data, filterCategories = null) => {
    const monthlyData = new Map();

    // Create empty bucket structure
    const createBucket = () => ({
      total: 0, new: 0, renew: 0, rejoin: 0
    });

    data.forEach(row => {
      const rawMbrType = (row.MbrType || '').trim().toUpperCase();
      const category = classifyMemberType(rawMbrType);

      // Skip if we're filtering and this category isn't included
      if (filterCategories && !filterCategories.includes(category)) return;

      const dateKey = row.CntDate;
      const cntType = (row.CntType || '').trim().toUpperCase();
      const quantity = parseInt(row.Quantity) || 0;

      if (!monthlyData.has(dateKey)) {
        monthlyData.set(dateKey, {
          date: dateKey,
          dateObj: parseDate(dateKey),
          label: formatMonthLabel(dateKey),
          senior: createBucket(),      // SENIOR + FIFTY YEAR + LIFE
          cadet: createBucket(),       // CADET only
          cadetSponsor: createBucket(),// CADET SPONSOR
          patron: createBucket(),      // PATRON
          combined: createBucket(),    // senior + cadet (operational)
          all: createBucket()          // everything
        });
      }

      const monthEntry = monthlyData.get(dateKey);

      // Add to the specific category bucket
      const targetBucket = monthEntry[category];
      if (targetBucket) {
        if (cntType === 'TOTAL') {
          targetBucket.total += quantity;
        } else if (cntType.includes('RENEW')) {
          // Check RENEW before NEW since 'RENEW' contains 'NEW'
          targetBucket.renew += quantity;
        } else if (cntType.includes('REJOIN')) {
          targetBucket.rejoin += quantity;
        } else if (cntType.includes('NEW')) {
          targetBucket.new += quantity;
        }
      }
    });

    // Calculate combined and all totals
    monthlyData.forEach(entry => {
      // Combined = senior + cadet (operational membership only)
      entry.combined.total = entry.senior.total + entry.cadet.total;
      entry.combined.new = entry.senior.new + entry.cadet.new;
      entry.combined.renew = entry.senior.renew + entry.cadet.renew;
      entry.combined.rejoin = entry.senior.rejoin + entry.cadet.rejoin;

      // All = everything
      entry.all.total = entry.senior.total + entry.cadet.total +
                        entry.cadetSponsor.total + entry.patron.total;
      entry.all.new = entry.senior.new + entry.cadet.new +
                      entry.cadetSponsor.new + entry.patron.new;
      entry.all.renew = entry.senior.renew + entry.cadet.renew +
                        entry.cadetSponsor.renew + entry.patron.renew;
      entry.all.rejoin = entry.senior.rejoin + entry.cadet.rejoin +
                         entry.cadetSponsor.rejoin + entry.patron.rejoin;
    });

    // Sort by date ascending
    return Array.from(monthlyData.values())
      .filter(entry => entry.dateObj) // Filter out entries with invalid dates
      .sort((a, b) => a.dateObj - b.dateObj);
  };

  // === METRIC CALCULATIONS ===

  /**
   * Calculate recruiting throughput (new + rejoin rate)
   * Measures how effectively the unit brings in new members
   * @param {Array} monthlyData - Full monthly data array
   * @param {string} mbrType - Member type filter
   * @param {number} timeRangeMonths - Number of months to analyze (0 = all)
   */
  const calculateRecruitingThroughput = (monthlyData, mbrType = 'combined', timeRangeMonths = 12) => {
    if (!monthlyData || monthlyData.length === 0) return null;

    // Use specified time range, or all data if timeRangeMonths is 0
    const numMonths = timeRangeMonths === 0 ? monthlyData.length : Math.min(timeRangeMonths, monthlyData.length);
    const recentMonths = monthlyData.slice(-numMonths);

    const totalRecruited = recentMonths.reduce((sum, m) =>
      sum + (m[mbrType]?.new || 0) + (m[mbrType]?.rejoin || 0), 0);
    const avgMonthlyRecruiting = totalRecruited / recentMonths.length;

    // Compare to prior period of same length if available
    let trend = 'stable';
    let trendPercent = 0;

    if (monthlyData.length >= numMonths * 2) {
      const priorMonths = monthlyData.slice(-numMonths * 2, -numMonths);
      const priorRecruited = priorMonths.reduce((sum, m) =>
        sum + (m[mbrType]?.new || 0) + (m[mbrType]?.rejoin || 0), 0);
      const priorAvg = priorRecruited / priorMonths.length;

      if (priorAvg > 0) {
        trendPercent = ((avgMonthlyRecruiting - priorAvg) / priorAvg) * 100;
        trend = trendPercent > 5 ? 'increasing' :
                trendPercent < -5 ? 'decreasing' : 'stable';
      }
    }

    return {
      totalInPeriod: totalRecruited,
      monthlyAverage: Math.round(avgMonthlyRecruiting * 10) / 10,
      trend,
      trendPercent: Math.round(trendPercent * 10) / 10,
      explanation: METRIC_EXPLANATIONS.recruitingRate
    };
  };

  /**
   * Calculate retention rate
   *
   * Method: Compare renewals against the pool of members who could have renewed.
   * We estimate the renewal-eligible pool as: previous period total - new members in current period
   *
   * A simpler, more meaningful approach:
   * - Look at how many members renewed vs how many were lost
   * - If renewals >> losses, retention is high
   * - If losses >> renewals, retention is low
   *
   * @param {Array} monthlyData - Full monthly data array
   * @param {string} mbrType - Member type filter
   * @param {number} timeRangeMonths - Number of months to analyze (0 = all)
   */
  const calculateRetentionLoad = (monthlyData, mbrType = 'combined', timeRangeMonths = 12) => {
    if (!monthlyData || monthlyData.length < 2) return null;

    // Use specified time range, or all data if timeRangeMonths is 0
    const numMonths = timeRangeMonths === 0 ? monthlyData.length : Math.min(timeRangeMonths, monthlyData.length);
    const recentMonths = monthlyData.slice(-numMonths);
    if (recentMonths.length < 2) return null;

    // Total renewals over the period
    const totalRenewals = recentMonths.reduce((sum, m) =>
      sum + (m[mbrType]?.renew || 0), 0);

    // Total new recruits (new + rejoin)
    const totalRecruited = recentMonths.reduce((sum, m) =>
      sum + (m[mbrType]?.new || 0) + (m[mbrType]?.rejoin || 0), 0);

    // Net change over the period
    const startTotal = recentMonths[0][mbrType]?.total || 0;
    const endTotal = recentMonths[recentMonths.length - 1][mbrType]?.total || 0;
    const netChange = endTotal - startTotal;

    // Estimated attrition = recruited - net change
    // (If you recruited 10 but only grew by 2, you lost 8)
    const estimatedAttrition = Math.max(0, totalRecruited - netChange);

    // Retention rate: what percentage of the "renewal eligible" stayed?
    // Renewal eligible â‰ˆ previous total (those who could have left but didn't)
    // Simpler: Renewals / (Renewals + Attrition)
    let retentionRate = null;
    if (totalRenewals + estimatedAttrition > 0) {
      retentionRate = (totalRenewals / (totalRenewals + estimatedAttrition)) * 100;
    } else if (startTotal > 0 && endTotal >= startTotal) {
      // No attrition detected, and membership stable or growing = good retention
      retentionRate = 95;
    } else if (totalRenewals > 0) {
      // Have renewals but can't calculate attrition = assume decent retention
      retentionRate = 75;
    }

    // Sanity check: cap at 100%
    if (retentionRate !== null) {
      retentionRate = Math.min(100, Math.max(0, retentionRate));
    }

    const healthIndicator = retentionRate === null ? 'unknown' :
                           retentionRate >= 80 ? 'healthy' :
                           retentionRate >= 60 ? 'moderate' : 'at-risk';

    // Calculate annualized attrition rate as a percentage
    const monthsOfData = recentMonths.length;
    const annualizedAttrition = startTotal > 0
      ? (estimatedAttrition / startTotal) * 100 * (12 / monthsOfData)
      : null;

    return {
      renewalsInPeriod: totalRenewals,
      estimatedAttrition: Math.round(estimatedAttrition),
      annualizedAttritionRate: annualizedAttrition !== null ? Math.round(annualizedAttrition * 10) / 10 : null,
      retentionRate: retentionRate !== null ? Math.round(retentionRate * 10) / 10 : null,
      healthIndicator,
      explanation: METRIC_EXPLANATIONS.retentionRate,
      attritionExplanation: METRIC_EXPLANATIONS.attritionRate
    };
  };

  /**
   * Calculate growth vs replacement ratio
   * Shows if recruiting is growing the unit or just replacing losses
   * @param {Array} monthlyData - Full monthly data array
   * @param {string} mbrType - Member type filter
   * @param {number} timeRangeMonths - Number of months to analyze (0 = all)
   */
  const calculateGrowthAnalysis = (monthlyData, mbrType = 'combined', timeRangeMonths = 12) => {
    if (!monthlyData || monthlyData.length < 2) return null;

    // Use specified time range, or all data if timeRangeMonths is 0
    const numMonths = timeRangeMonths === 0 ? monthlyData.length : Math.min(timeRangeMonths, monthlyData.length);
    const recentMonths = monthlyData.slice(-numMonths);
    if (recentMonths.length < 2) return null;

    const firstMonth = recentMonths[0][mbrType]?.total || 0;
    const lastMonth = recentMonths[recentMonths.length - 1][mbrType]?.total || 0;

    const netChange = lastMonth - firstMonth;
    const totalRecruited = recentMonths.reduce((sum, m) =>
      sum + (m[mbrType]?.new || 0) + (m[mbrType]?.rejoin || 0), 0);

    const replacementNeeded = totalRecruited - netChange;
    const growthContribution = netChange > 0 ? netChange : 0;

    const growthRatio = totalRecruited > 0
      ? (growthContribution / totalRecruited) * 100
      : 0;

    return {
      netChangeInPeriod: netChange,
      totalRecruited: totalRecruited,
      replacementNeeded: Math.max(0, replacementNeeded),
      growthContribution: growthContribution,
      growthRatio: Math.round(growthRatio),
      status: netChange > 0 ? 'growing' :
              netChange === 0 ? 'stable' : 'declining',
      explanation: METRIC_EXPLANATIONS.netChange
    };
  };

  /**
   * Calculate seasonality patterns
   * Identifies which months have highest/lowest recruiting
   */
  const calculateSeasonality = (monthlyData, mbrType = 'combined') => {
    if (!monthlyData || monthlyData.length < 24) return null;

    const monthlyAverages = Array(12).fill(null).map(() => ({
      count: 0,
      totalNew: 0,
      totalRejoin: 0,
      totalRenew: 0
    }));

    monthlyData.forEach(m => {
      if (!m.dateObj) return;
      const monthIndex = m.dateObj.getMonth();
      const bucket = monthlyAverages[monthIndex];
      bucket.count++;
      bucket.totalNew += m[mbrType]?.new || 0;
      bucket.totalRejoin += m[mbrType]?.rejoin || 0;
      bucket.totalRenew += m[mbrType]?.renew || 0;
    });

    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    const patterns = monthlyAverages.map((bucket, idx) => ({
      month: monthNames[idx],
      monthIndex: idx,
      avgRecruiting: bucket.count > 0
        ? (bucket.totalNew + bucket.totalRejoin) / bucket.count
        : 0,
      avgRenewals: bucket.count > 0 ? bucket.totalRenew / bucket.count : 0
    }));

    const sorted = [...patterns].sort((a, b) => b.avgRecruiting - a.avgRecruiting);

    return {
      patterns,
      peakMonths: sorted.slice(0, 3).map(p => p.month),
      lowMonths: sorted.slice(-3).reverse().map(p => p.month)
    };
  };

  /**
   * Calculate volatility indicators
   * Measures month-to-month membership stability
   * @param {Array} monthlyData - Full monthly data array
   * @param {string} mbrType - Member type filter
   * @param {number} timeRangeMonths - Number of months to analyze (0 = all)
   */
  const calculateVolatility = (monthlyData, mbrType = 'combined', timeRangeMonths = 12) => {
    if (!monthlyData || monthlyData.length < 6) return null;

    // Use specified time range, or all data if timeRangeMonths is 0
    const numMonths = timeRangeMonths === 0 ? monthlyData.length : Math.min(timeRangeMonths, monthlyData.length);
    const recentMonths = monthlyData.slice(-numMonths);
    const totals = recentMonths.map(m => m[mbrType]?.total || 0).filter(t => t > 0);

    if (totals.length < 3) return null;

    const mean = totals.reduce((sum, t) => sum + t, 0) / totals.length;
    const variance = totals.reduce((sum, t) => sum + Math.pow(t - mean, 2), 0) / totals.length;
    const stdDev = Math.sqrt(variance);
    const coeffOfVariation = mean > 0 ? (stdDev / mean) * 100 : 0;

    // Calculate max swing
    let maxSwing = 0;
    for (let i = 1; i < totals.length; i++) {
      const swing = Math.abs(totals[i] - totals[i-1]);
      if (swing > maxSwing) maxSwing = swing;
    }

    return {
      standardDeviation: Math.round(stdDev * 10) / 10,
      coefficientOfVariation: Math.round(coeffOfVariation * 10) / 10,
      maxMonthlySwing: maxSwing,
      stabilityRating: coeffOfVariation < 5 ? 'very-stable' :
                       coeffOfVariation < 10 ? 'stable' :
                       coeffOfVariation < 20 ? 'moderate' : 'volatile',
      explanation: METRIC_EXPLANATIONS.stability
    };
  };

  /**
   * Calculate long-term sustainability score
   * Composite metric for overall membership health
   * @param {Array} monthlyData - Full monthly data array
   * @param {string} mbrType - Member type filter
   * @param {number} timeRangeMonths - Number of months to analyze (0 = all)
   */
  const calculateSustainability = (monthlyData, mbrType = 'combined', timeRangeMonths = 12) => {
    const recruiting = calculateRecruitingThroughput(monthlyData, mbrType, timeRangeMonths);
    const retention = calculateRetentionLoad(monthlyData, mbrType, timeRangeMonths);
    const growth = calculateGrowthAnalysis(monthlyData, mbrType, timeRangeMonths);
    const volatility = calculateVolatility(monthlyData, mbrType, timeRangeMonths);

    if (!recruiting && !retention && !growth && !volatility) return null;

    // Score components (0-100 each)
    const recruitingScore = recruiting
      ? Math.min(100, (recruiting.monthlyAverage || 0) * 20)
      : 50;
    const retentionScore = retention?.retentionRate || 50;
    const growthScore = growth
      ? (growth.status === 'growing' ? 80 + Math.min(20, (growth.netChangeInPeriod || 0) * 2) :
         growth.status === 'stable' ? 60 :
         Math.max(0, 50 + (growth.netChangeInPeriod || 0) * 5))
      : 50;
    const stabilityScore = volatility
      ? (volatility.stabilityRating === 'very-stable' ? 100 :
         volatility.stabilityRating === 'stable' ? 80 :
         volatility.stabilityRating === 'moderate' ? 60 : 40)
      : 70;

    const overallScore = (recruitingScore * 0.25 +
                          retentionScore * 0.35 +
                          growthScore * 0.25 +
                          stabilityScore * 0.15);

    // Find lowest component to suggest focus area
    const componentScores = [
      { name: 'recruiting', score: recruitingScore, label: 'Recruiting' },
      { name: 'retention', score: retentionScore, label: 'Retention' },
      { name: 'growth', score: growthScore, label: 'Growth' },
      { name: 'stability', score: stabilityScore, label: 'Stability' }
    ];
    const lowestComponent = [...componentScores].sort((a, b) => a.score - b.score)[0];

    return {
      overallScore: Math.round(overallScore),
      components: {
        recruiting: Math.round(recruitingScore),
        retention: Math.round(retentionScore),
        growth: Math.round(growthScore),
        stability: Math.round(stabilityScore)
      },
      rating: overallScore >= 80 ? 'excellent' :
              overallScore >= 65 ? 'good' :
              overallScore >= 50 ? 'fair' : 'needs-attention',
      summary: overallScore >= 80 ? 'Unit membership is healthy and sustainable' :
               overallScore >= 65 ? 'Unit membership is stable with room for improvement' :
               overallScore >= 50 ? 'Unit should focus on retention and recruiting' :
               'Unit membership needs immediate attention',
      focusArea: lowestComponent,
      explanation: METRIC_EXPLANATIONS.sustainability
    };
  };

  // === MAIN API ===

  /**
   * Get comprehensive recruiting/retention metrics for a unit
   */
  const getMetricsForUnit = (orgId, options = {}) => {
    const {
      includeDescendants = false,
      descendantOrgIds = [],
      timeRangeMonths = 12,
      mbrType = 'combined'
    } = options;

    if (!orgId) return null;

    const unitData = getDataForOrg(orgId, includeDescendants, descendantOrgIds);
    if (unitData.length === 0) {
      return null;
    }

    // For "all time" (0), use all available data
    // Otherwise, get extra months for trend analysis (at least 24 months or 2x requested)
    const isAllTime = timeRangeMonths === 0;
    const analysisMonths = isAllTime ? 999 : Math.max(timeRangeMonths * 2, 24);
    const startDate = isAllTime ? new Date(2000, 0, 1) : getMonthsAgo(analysisMonths);
    const filteredData = getDataInTimeRange(unitData, startDate);
    const monthlyData = aggregateByMonth(filteredData);

    // Limit to requested time range for display (all-time shows everything)
    const displayData = isAllTime
      ? monthlyData
      : monthlyData.slice(-timeRangeMonths);

    const currentTotal = displayData.length > 0
      ? displayData[displayData.length - 1][mbrType]?.total || 0
      : 0;

    const yearAgoTotal = monthlyData.length >= 12
      ? monthlyData[monthlyData.length - 12]?.[mbrType]?.total || null
      : null;

    // Get latest month's breakdown by member type
    const latestMonth = displayData.length > 0 ? displayData[displayData.length - 1] : null;
    const memberBreakdown = latestMonth ? {
      senior: latestMonth.senior?.total || 0,
      cadet: latestMonth.cadet?.total || 0,
      cadetSponsor: latestMonth.cadetSponsor?.total || 0,
      patron: latestMonth.patron?.total || 0,
      combined: latestMonth.combined?.total || 0,
      all: latestMonth.all?.total || 0
    } : null;

    // Pass timeRangeMonths to all calculation functions so metrics reflect the selected period
    return {
      monthlyData: displayData,
      metrics: {
        recruiting: calculateRecruitingThroughput(monthlyData, mbrType, timeRangeMonths),
        retention: calculateRetentionLoad(monthlyData, mbrType, timeRangeMonths),
        growth: calculateGrowthAnalysis(monthlyData, mbrType, timeRangeMonths),
        seasonality: calculateSeasonality(monthlyData, mbrType),  // Seasonality uses all available data for pattern detection
        volatility: calculateVolatility(monthlyData, mbrType, timeRangeMonths),
        sustainability: calculateSustainability(monthlyData, mbrType, timeRangeMonths)
      },
      summary: {
        currentTotal,
        yearAgoTotal,
        dataPointCount: displayData.length,
        memberBreakdown
      }
    };
  };

  /**
   * Get key data for collapsed section view
   */
  const getKeyDataForUnit = (orgId, options = {}) => {
    const fullMetrics = getMetricsForUnit(orgId, options);

    if (!fullMetrics) {
      return {
        currentTotal: 0,
        yearOverYearChange: null,
        sustainabilityScore: null,
        sustainabilityRating: 'unknown',
        trendDirection: 'unknown',
        retentionRate: null
      };
    }

    return {
      currentTotal: fullMetrics.summary.currentTotal,
      yearOverYearChange: fullMetrics.summary.yearAgoTotal
        ? fullMetrics.summary.currentTotal - fullMetrics.summary.yearAgoTotal
        : null,
      sustainabilityScore: fullMetrics.metrics.sustainability?.overallScore || null,
      sustainabilityRating: fullMetrics.metrics.sustainability?.rating || 'unknown',
      trendDirection: fullMetrics.metrics.recruiting?.trend || 'unknown',
      retentionRate: fullMetrics.metrics.retention?.retentionRate || null
    };
  };

  /**
   * Check if data is available for a unit
   */
  const hasDataForUnit = (orgId, includeDescendants = false, descendantOrgIds = []) => {
    const validOrgIds = includeDescendants
      ? new Set([String(orgId), ...descendantOrgIds.map(id => String(id))])
      : new Set([String(orgId)]);

    return _rawData.some(row => validOrgIds.has(String(row.ORGID)));
  };

  /**
   * Get metrics for multiple units at once (for unit comparison table)
   * Returns an array of unit metrics sorted by sustainability score
   */
  const getMetricsForMultipleUnits = (orgIds, options = {}) => {
    const {
      timeRangeMonths = 12,
      mbrType = 'combined'
    } = options;

    if (!orgIds || orgIds.length === 0) return [];

    const results = orgIds.map(orgId => {
      const metrics = getMetricsForUnit(orgId, {
        includeDescendants: false,
        descendantOrgIds: [],
        timeRangeMonths,
        mbrType
      });

      return {
        orgId: String(orgId),
        hasData: metrics !== null,
        currentTotal: metrics?.summary?.currentTotal || 0,
        yearOverYearChange: metrics?.summary?.yearAgoTotal
          ? metrics.summary.currentTotal - metrics.summary.yearAgoTotal
          : null,
        sustainabilityScore: metrics?.metrics?.sustainability?.overallScore || null,
        sustainabilityRating: metrics?.metrics?.sustainability?.rating || 'unknown',
        retentionRate: metrics?.metrics?.retention?.retentionRate || null,
        recruitingRate: metrics?.metrics?.recruiting?.monthlyAverage || null,
        growthStatus: metrics?.metrics?.growth?.status || 'unknown',
        netChange: metrics?.metrics?.growth?.netChangeInPeriod || null,
        memberBreakdown: metrics?.summary?.memberBreakdown || null
      };
    }).filter(r => r.hasData);

    // Sort by sustainability score (highest first)
    return results.sort((a, b) => (b.sustainabilityScore || 0) - (a.sustainabilityScore || 0));
  };

  /**
   * Get explanation text for a specific metric
   */
  const getMetricExplanation = (metricKey) => {
    return METRIC_EXPLANATIONS[metricKey] || null;
  };

  /**
   * Get all metric explanations
   */
  const getMetricExplanations = () => METRIC_EXPLANATIONS;

  /**
   * Get member type categories for UI display
   */
  const getMemberTypeCategories = () => ({
    senior: {
      label: 'Senior Members',
      description: 'Includes SENIOR, FIFTY YEAR, and LIFE members',
      includes: ['SENIOR', 'FIFTY YEAR', 'LIFE']
    },
    cadet: {
      label: 'Cadets',
      description: 'Youth members aged 12-18',
      includes: ['CADET']
    },
    cadetSponsor: {
      label: 'Cadet Sponsors',
      description: 'Adults who support the cadet program only',
      includes: ['CADET SPONSOR']
    },
    patron: {
      label: 'Patrons',
      description: 'Financial supporters (rarely used)',
      includes: ['PATRON']
    },
    combined: {
      label: 'Operational Membership',
      description: 'Senior + Cadet members (primary mission workforce)',
      includes: ['SENIOR', 'FIFTY YEAR', 'LIFE', 'CADET']
    }
  });

  return {
    initialize,
    getMetricsForUnit,
    getMetricsForMultipleUnits,
    getKeyDataForUnit,
    hasDataForUnit,
    // Expose explanations for UI
    getMetricExplanation,
    getMetricExplanations,
    getMemberTypeCategories,
    // Expose for charts
    aggregateByMonth,
    getDataForOrg,
    getDataInTimeRange,
    // Expose individual calculations if needed
    calculateRecruitingThroughput,
    calculateRetentionLoad,
    calculateGrowthAnalysis,
    calculateSeasonality,
    calculateVolatility,
    calculateSustainability
  };
}
</script>

<script type="text/babel">
class ErrorBoundary extends React.Component {
  constructor(props) { super(props); this.state = { hasError: false, error: null }; }
  static getDerivedStateFromError(error) { return { hasError: true, error }; }
  componentDidCatch(error, errorInfo) {
    // Log to console for debugging, but don't expose to users
    console.error('Application Error:', error, errorInfo);
  }
  render() {
    if (this.state.hasError) {
      return (
        <div className="p-8 bg-red-50 text-red-900 h-screen flex flex-col items-center justify-center text-center">
          <h1 className="text-2xl font-bold mb-4">Application Error</h1>
          <p className="mb-4">Something went wrong while rendering the dashboard.</p>
          <p className="text-sm text-red-600 mb-4">Please try refreshing the page. If the problem persists, clear your browser cache.</p>
          <button onClick={() => window.location.reload()} className="mt-6 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Reload Page</button>
        </div>
      );
    }
    return this.props.children;
  }
}

const Icon = ({ name, className, ...props }) => {
  const lib = window.lucideReact || window.LucideReact || window.lucide;
  let LucideIcon = lib ? lib[name] : null;

  // Try alternate names for common icons
  if (!LucideIcon && name === 'HelpCircle') LucideIcon = lib?.['CircleHelp'];
  if (!LucideIcon && name === 'CircleHelp') LucideIcon = lib?.['HelpCircle'];

  // Fallback for missing icons
  if (!LucideIcon) {
    if (name === 'X') return <span className={`font-bold ${className}`}>X</span>;
    if (name === 'HelpCircle' || name === 'CircleHelp') {
      // Hardcoded HelpCircle SVG fallback
      return (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
          <circle cx="12" cy="12" r="10"/>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
          <path d="M12 17h.01"/>
        </svg>
      );
    }
    return null;
  }
  return <LucideIcon className={className} {...props} />;
};

// --- HARDCODED SVGs FOR CRITICAL UI ELEMENTS (To avoid library failures) ---
const WarningTriangle = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-amber-500 mr-1.5"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
);

const CheckCircleFilled = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="text-green-500 mr-2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
);

const CircleEmpty = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-slate-300 mr-2"><circle cx="12" cy="12" r="10"/></svg>
);

  const Badge = ({ children, color = "blue", warning, isRed = false, title, ...props }) => {
    let colors = { blue: "bg-blue-100 text-blue-800 border-blue-200", green: "bg-green-100 text-green-800 border-green-200", gray: "bg-slate-100 text-slate-800 border-slate-200", red: "bg-red-100 text-red-800 border-red-200", amber: "bg-amber-100 text-amber-800 border-amber-200" };
    if (isRed) colors[color] = "bg-slate-100 text-red-600 border-slate-200 font-bold";

  return (
    <span className={`flex items-center px-2.5 py-0.5 rounded border text-xs font-medium cursor-help whitespace-nowrap ${colors[color] || colors.blue}`} title={title} {...props}>
      {children}
      {warning && <WarningTriangle />}
    </span>
  );
};

const ESBadge = ({ qualification, onClick, size = 'normal', showStatus = false }) => {
  const { name, status, colorClass, isSkillsEvaluator, isExpiringSoon } = qualification;

  // Size variants
  const sizeClasses = {
    small: 'px-2 py-0.5 text-[10px]',
    normal: 'px-2.5 py-1 text-xs',
    large: 'px-3 py-1.5 text-sm'
  };

  // Color mapping - with support for expiring soon (green background with amber border)
  // SET-rated qualifications get thicker border (border-3)
  const colors = {
    'es-active': isExpiringSoon
      ? 'bg-emerald-100 text-emerald-800 border-amber-400 border-2 hover:bg-emerald-200'
      : isSkillsEvaluator
        ? 'bg-emerald-100 text-emerald-800 border-emerald-400 border-[3px] hover:bg-emerald-200'
        : 'bg-emerald-100 text-emerald-800 border-emerald-300 hover:bg-emerald-200',
    'es-training': 'bg-amber-100 text-amber-800 border-amber-300 hover:bg-amber-200',
    'es-expired': 'bg-rose-100 text-rose-800 border-rose-300 hover:bg-rose-200',
    'es-not-approved': 'bg-slate-100 text-slate-600 border-slate-300 hover:bg-slate-200'
  };

  // Extract acronym from name (except for CAP Drivers License and OPSEC which show full name)
  const getDisplayName = (fullName) => {
    // Keep full name for CAP Drivers License and OPSEC
    if (fullName.includes('CAP Drivers License') || fullName === 'OPSEC') {
      return fullName;
    }

    // Extract acronym (text before the first dash and hyphen)
    const dashIndex = fullName.indexOf(' - ');
    if (dashIndex > 0) {
      return fullName.substring(0, dashIndex).trim();
    }

    // If no dash found, return the full name
    return fullName;
  };

  const title = `${name} - ${status}${isSkillsEvaluator ? ' (SET Rated)' : ''}`;
  const displayText = showStatus ? status : getDisplayName(name);

  return (
    <span
      className={`inline-flex items-center gap-1 rounded border font-medium cursor-pointer transition-colors ${sizeClasses[size]} ${colors[colorClass]}`}
      onClick={onClick}
      title={title}
    >
      {isSkillsEvaluator && (
        <Icon name="Star" className="w-3 h-3 fill-current" />
      )}
      <span className={`truncate max-w-[120px] ${showStatus ? 'uppercase' : ''}`}>{displayText}</span>
    </span>
  );
};

const Modal = ({ isOpen, onClose, title, children, zIndex = 50, maxWidthClass = "max-w-4xl" }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 p-4" style={{ zIndex }} onClick={onClose}>
      <div className={`bg-white rounded-lg shadow-xl w-full ${maxWidthClass} max-h-[90vh] flex flex-col`} onClick={(e) => e.stopPropagation()}>
        <div className="flex justify-between items-center p-6 border-b border-slate-200">
          <h2 className="text-xl font-bold text-slate-900">{title}</h2>
          <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-2"><Icon name="X" className="w-6 h-6" /></button>
        </div>
        <div className="p-6 overflow-y-auto">{children}</div>
      </div>
    </div>
  );
};

/**
 * DashboardSection - Collapsible accordion section for Unit Overview
 *
 * Props:
 * - id: string - unique section identifier
 * - title: string - section header
 * - icon: string - Lucide icon name
 * - isExpanded: boolean - current expansion state
 * - onToggle: function - called when section is clicked
 * - onDeepDive: function - called when "View Details" button clicked
 * - keyData: ReactNode - content to show when collapsed
 * - children: ReactNode - content to show when expanded
 * - accentColor: string - 'blue' | 'green' | 'amber' | 'indigo' | 'rose'
 */
const DashboardSection = ({
  id,
  title,
  icon,
  isExpanded,
  onToggle,
  onDeepDive,
  keyData,
  children,
  accentColor = 'blue'
}) => {
  const accentStyles = {
    blue: {
      border: 'border-blue-200',
      headerBg: 'bg-blue-50',
      iconBg: 'bg-blue-100',
      iconText: 'text-blue-600',
      expandedBorder: 'border-blue-300'
    },
    green: {
      border: 'border-emerald-200',
      headerBg: 'bg-emerald-50',
      iconBg: 'bg-emerald-100',
      iconText: 'text-emerald-600',
      expandedBorder: 'border-emerald-300'
    },
    amber: {
      border: 'border-amber-200',
      headerBg: 'bg-amber-50',
      iconBg: 'bg-amber-100',
      iconText: 'text-amber-600',
      expandedBorder: 'border-amber-300'
    },
    indigo: {
      border: 'border-indigo-200',
      headerBg: 'bg-indigo-50',
      iconBg: 'bg-indigo-100',
      iconText: 'text-indigo-600',
      expandedBorder: 'border-indigo-300'
    },
    rose: {
      border: 'border-rose-200',
      headerBg: 'bg-rose-50',
      iconBg: 'bg-rose-100',
      iconText: 'text-rose-600',
      expandedBorder: 'border-rose-300'
    }
  };

  const styles = accentStyles[accentColor] || accentStyles.blue;

  return (
    <div className={`bg-white rounded-xl border shadow-sm overflow-hidden transition-all duration-200 ${
      isExpanded ? styles.expandedBorder : styles.border
    }`}>
      {/* Header - always visible, clickable */}
      <button
        onClick={() => onToggle(id)}
        className={`w-full p-4 flex items-center justify-between gap-4 text-left hover:bg-slate-50 transition-colors ${
          isExpanded ? styles.headerBg : ''
        }`}
      >
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 rounded-lg ${styles.iconBg} ${styles.iconText} flex items-center justify-center shrink-0`}>
            <Icon name={icon} className="w-5 h-5" />
          </div>
          <div>
            <h3 className="font-bold text-lg text-slate-800">{title}</h3>
            {!isExpanded && keyData && (
              <div className="text-sm text-slate-600 mt-0.5">{keyData}</div>
            )}
          </div>
        </div>
        <div className="flex items-center gap-2">
          {onDeepDive && (
            <span
              onClick={(e) => { e.stopPropagation(); onDeepDive(id); }}
              className="px-3 py-1.5 text-sm font-medium text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors cursor-pointer"
            >
              View Details
            </span>
          )}
          <Icon
            name={isExpanded ? 'ChevronUp' : 'ChevronDown'}
            className="w-5 h-5 text-slate-400"
          />
        </div>
      </button>

      {/* Expanded content */}
      {isExpanded && (
        <div className="p-4 pt-0 border-t border-slate-100">
          {children}
        </div>
      )}
    </div>
  );
};

/**
 * KeyMetricCard - Compact metric display for collapsed section view
 */
const KeyMetricCard = ({ label, value, subValue, trend, trendDirection, color = 'blue' }) => {
  const colorStyles = {
    blue: 'bg-blue-50 border-blue-100',
    green: 'bg-emerald-50 border-emerald-100',
    amber: 'bg-amber-50 border-amber-100',
    red: 'bg-rose-50 border-rose-100',
    slate: 'bg-slate-50 border-slate-100'
  };

  const trendColors = {
    up: 'text-emerald-600',
    down: 'text-rose-600',
    stable: 'text-slate-500'
  };

  return (
    <div className={`px-3 py-2 rounded-lg border ${colorStyles[color] || colorStyles.blue}`}>
      <div className="text-[10px] uppercase font-bold text-slate-500 tracking-wide">{label}</div>
      <div className="flex items-baseline gap-2">
        <span className="text-xl font-bold text-slate-800">{value}</span>
        {trend && (
          <span className={`text-xs font-medium ${trendColors[trendDirection] || trendColors.stable}`}>
            {trendDirection === 'up' && '+'}
            {trend}
          </span>
        )}
      </div>
      {subValue && <div className="text-xs text-slate-500">{subValue}</div>}
    </div>
  );
};

/**
 * SustainabilityGauge - Visual indicator for sustainability score
 */
const SustainabilityGauge = ({ score, rating }) => {
  const ratingStyles = {
    'excellent': { color: 'text-emerald-600', bg: 'bg-emerald-500', label: 'Excellent' },
    'good': { color: 'text-blue-600', bg: 'bg-blue-500', label: 'Good' },
    'fair': { color: 'text-amber-600', bg: 'bg-amber-500', label: 'Fair' },
    'needs-attention': { color: 'text-rose-600', bg: 'bg-rose-500', label: 'Needs Attention' },
    'unknown': { color: 'text-slate-500', bg: 'bg-slate-400', label: 'Insufficient Data' }
  };

  const style = ratingStyles[rating] || ratingStyles.unknown;

  return (
    <div className="flex items-center gap-3">
      <div className="flex-1">
        <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
          <div
            className={`h-full ${style.bg} transition-all duration-500`}
            style={{ width: `${score || 0}%` }}
          />
        </div>
      </div>
      <div className={`text-sm font-semibold ${style.color}`}>
        {score !== null && score !== undefined ? `${score}%` : '--'}
      </div>
      <div className={`text-xs font-medium px-2 py-0.5 rounded-full ${style.bg} text-white`}>
        {style.label}
      </div>
    </div>
  );
};
</script>


  <!-- ZIP Import Modal (added after ComponentsCore which defines Icon) -->
  <script type="text/babel">
  // ZIP Import Modal Component
function ZipImportModal({ onImport, onClose, isOpen }) {
  const [dragOver, setDragOver] = React.useState(false);
  const [importing, setImporting] = React.useState(false);
  const [progress, setProgress] = React.useState('');
  const [error, setError] = React.useState(null);
  const fileInputRef = React.useRef(null);

  if (!isOpen) return null;

  const handleFile = async (file) => {
    if (!file || !file.name.toLowerCase().endsWith('.zip')) {
      setError('Please select a valid ZIP file');
      return;
    }

    setImporting(true);
    setError(null);
    setProgress('Starting import...');

    try {
      const payload = await window.importCapwatchZip(file, setProgress);
      setProgress('Import complete!');
      setTimeout(() => {
        onImport(payload);
      }, 500);
    } catch (err) {
      setError('Import failed: ' + err.message);
      setImporting(false);
    }
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setDragOver(false);
    const file = e.dataTransfer.files[0];
    handleFile(file);
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    setDragOver(true);
  };

  // Compute className without template literal to avoid PowerShell escaping issues
  const baseClass = "border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-colors";
  const activeClass = dragOver ? "border-blue-500 bg-blue-50" : "border-slate-300 hover:border-blue-400 hover:bg-slate-50";
  const dropZoneClass = baseClass + " " + activeClass;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl p-6 max-w-lg w-full shadow-2xl">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold text-slate-900">Import CAPWATCH Data</h2>
          {onClose && !importing && (
            <button onClick={onClose} className="text-slate-400 hover:text-slate-600">
              <Icon name="X" className="w-5 h-5" />
            </button>
          )}
        </div>

        <p className="text-sm text-slate-600 mb-4">
          Upload your CAPWATCH export ZIP file to load member data.
          The file is processed locally in your browser and stored offline.
        </p>

        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
            {error}
          </div>
        )}

        {importing ? (
          <div className="text-center py-8">
            <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
            <p className="text-sm text-slate-600">{progress}</p>
          </div>
        ) : (
          <div
            className={dropZoneClass}
            onDragOver={handleDragOver}
            onDragLeave={() => setDragOver(false)}
            onDrop={handleDrop}
            onClick={() => fileInputRef.current?.click()}
          >
            <Icon name="Upload" className="mx-auto h-12 w-12 text-slate-400 mb-4" />
            <p className="text-slate-600 font-medium">Drop your CAPWATCH export ZIP file here</p>
            <p className="text-sm text-slate-400 mt-2">or click to browse</p>
          </div>
        )}

        <input
          ref={fileInputRef}
          type="file"
          accept=".zip"
          className="hidden"
          onChange={(e) => handleFile(e.target.files[0])}
        />

        <div className="mt-4 text-xs text-slate-400 text-center">
          Data is stored locally in your browser using IndexedDB
        </div>
      </div>
    </div>
  );
}
  </script>
<script type="text/babel">
const LevelIndicator = ({ level, label, name, progress = {}, onClick }) => {
  const pct = progress.percent || 0;
  const status = progress.status || 'not-started';
  const approvalStatus = progress.approvalStatus;
  const isComplete = status === 'completed';
  const isReady = status === 'ready';
  const isPending = status === 'pending';
  const isInProgress = status === 'in-progress';
  const isStarted = pct > 0;

  let circleClass = "border-slate-200 bg-white";
  let textClass = "text-slate-400";
  if (isComplete) { circleClass = "border-blue-600 bg-blue-600"; textClass = "text-white"; }
  else if (isReady) { circleClass = "border-amber-500 bg-amber-50"; textClass = "text-amber-700"; }
  else if (isPending) { circleClass = "border-amber-600 bg-white"; textClass = "text-amber-700"; }
  else if (isInProgress || isStarted) { circleClass = "border-blue-400 bg-white"; textClass = "text-blue-600"; }

  const statusLine = (() => {
    if (isComplete) return `Completed${progress.date ? `: ${progress.date}` : ""}`;
    if (isPending) return approvalStatus === 'disapproved' ? "Submitted - needs update" : "Submitted - awaiting approval";
    if (isReady) return "All modules done - submit for approval";
    if (isInProgress) return "In progress";
    if (isStarted) return "Started";
    return "Not started";
  })();

  return (
    <div className="flex flex-col items-center group cursor-pointer relative" onClick={onClick}>
      <div className={`relative w-8 h-8 flex items-center justify-center rounded-full border-2 ${circleClass}`}>
        {!isComplete && isStarted && !isReady && !isPending && (
          <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
            <path className="text-blue-500" strokeDasharray={`${pct}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
          </svg>
        )}
        {(isReady || isPending) && (
          <span className={`absolute -top-1 -right-1 w-3 h-3 rounded-full border-2 border-white ${isPending ? 'bg-amber-600 animate-pulse' : 'bg-amber-500'}`} />
        )}
        <span className={`text-xs font-bold ${textClass}`}>{label || level}</span>
      </div>
      <div className="absolute bottom-full mb-2 hidden group-hover:block z-50 w-max bg-slate-800 text-white text-xs rounded py-1 px-2 shadow-lg">
          {name || `Level ${label || level}`}: {pct}%
          <div className="text-[10px] text-slate-300 mt-1">{statusLine}</div>
      </div>
    </div>
  );
};
</script>

<script type="text/babel">
const FilterButton = ({ label, active, onClick, children }) => (
  <div className="relative inline-block text-left">
      <button 
          onClick={(e) => {
              e.stopPropagation();
              onClick();
          }}
          className={`flex items-center px-3 py-2 text-xs font-medium rounded-lg border transition-colors ${active ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
      >
          {label} <Icon name="ChevronDown" className={`w-3 h-3 ml-1.5 transition-transform ${active ? 'rotate-180' : ''}`} />
      </button>
      {active && (
          <div className="absolute top-full left-0 mt-1 w-56 bg-white border border-slate-200 shadow-xl rounded-lg z-50 p-2 grid gap-1 max-h-60 overflow-y-auto" onClick={(e) => e.stopPropagation()}>
              {children}
          </div>
      )}
  </div>
);

// New Filter Header Component for columns
const FilterHeader = ({ label, active, onClick, children }) => (
  <div className="relative inline-block text-left ml-2">
      <button 
          onClick={(e) => {
              e.stopPropagation();
              onClick();
          }}
          className={`p-1 rounded hover:bg-slate-200 transition-colors ${active ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}
          title={`Filter by ${label}`}
      >
          <Icon name="Filter" className="w-3 h-3" />
      </button>
      {active && (
          <div className="absolute top-full right-0 mt-1 w-56 bg-white border border-slate-200 shadow-xl rounded-lg z-50 p-2 grid gap-1 max-h-60 overflow-y-auto" onClick={(e) => e.stopPropagation()}>
              <div className="text-xs font-bold text-slate-500 mb-1 uppercase tracking-wider">{label} Filter</div>
              {children}
          </div>
      )}
  </div>
);

{/*
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CADET DASHBOARD UI COMPONENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Specialized components for the Cadet Promotion Tracker dashboard.
*/}

// Component-based Progress Bar - Shows requirement completion as individual segments
</script>

<script type="text/babel">
// ES Qualification Card Component
// Displays a single ES qualification with name, functional area, status badge, and dates
const ESQualificationCard = ({
  qualification,
  onClick = null,
  showSkillsEvaluator = true,
  ES_FUNCTIONAL_AREAS
}) => {
  const isClickable = typeof onClick === 'function';

  return (
    <div
      className={`p-3 bg-slate-50 rounded-lg border border-slate-200 ${
        isClickable ? 'hover:border-blue-300 transition-colors cursor-pointer' : ''
      }`}
      onClick={isClickable ? () => onClick(qualification) : undefined}
    >
      <div className="flex items-start justify-between gap-2">
        <div className="flex-1">
          <div className="font-semibold text-sm text-slate-800 flex items-center gap-2">
            {showSkillsEvaluator && qualification.isSkillsEvaluator && (
              <Icon name="Star" className="w-4 h-4 text-amber-500 fill-current" />
            )}
            {qualification.name}
          </div>
          {qualification.functionalArea && (
            <div className="text-xs text-slate-500 mt-0.5">
              {ES_FUNCTIONAL_AREAS[qualification.functionalArea] || qualification.functionalArea}
            </div>
          )}
        </div>
        <ESBadge
          qualification={qualification}
          size="small"
          showStatus={true}
          onClick={(e) => e?.stopPropagation()}
        />
      </div>
      <div className="mt-2 text-xs text-slate-600 space-y-1">
        {qualification.completed && qualification.completed !== '01/01/1900' && (
          <div>Completed: {qualification.completed}</div>
        )}
        {qualification.expiration && qualification.expiration !== '01/01/1900' && (
          <div>Expires: {qualification.expiration}</div>
        )}
        {showSkillsEvaluator && qualification.isSkillsEvaluator && (
          <div className="text-amber-700 font-medium flex items-center gap-1 mt-1">
            <Icon name="Star" className="w-3 h-3" />
            Skills Evaluator Qualified
          </div>
        )}
      </div>
    </div>
  );
};

// ES Qualifications Section Component
// Displays the full ES qualifications section with header, optional skill tree button, and grid of cards
const ESQualificationsSection = ({
  qualifications = [],
  onQualificationClick = null,
  onViewSkillTree = null,
  showSkillTreeButton = true,
  showSkillsEvaluator = true,
  emptyMessage = "No emergency services qualifications on record",
  ES_FUNCTIONAL_AREAS,
  headerClassName = "flex items-center justify-between mb-2"
}) => {
  const hasQualifications = qualifications && qualifications.length > 0;
  const showTreeButton = showSkillTreeButton && hasQualifications && typeof onViewSkillTree === 'function';

  return (
    <div>
      <div className={headerClassName}>
        <h4 className="font-bold flex items-center gap-2">
          <Icon name="Activity" className="w-4 h-4 text-rose-600" />
          Emergency Services Qualifications
        </h4>
        {showTreeButton && (
          <button
            onClick={onViewSkillTree}
            className="text-xs px-3 py-1 bg-blue-50 text-blue-700 rounded-lg border border-blue-200 hover:bg-blue-100 transition-colors font-medium"
          >
            View Skill Tree
          </button>
        )}
      </div>
      {hasQualifications ? (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          {qualifications.map((qual, i) => (
            <ESQualificationCard
              key={i}
              qualification={qual}
              onClick={onQualificationClick}
              showSkillsEvaluator={showSkillsEvaluator}
              ES_FUNCTIONAL_AREAS={ES_FUNCTIONAL_AREAS}
            />
          ))}
        </div>
      ) : (
        <div className="text-sm text-slate-400 italic bg-slate-50 border border-slate-100 rounded-lg p-3">
          {emptyMessage}
        </div>
      )}
    </div>
  );
};

// Compact ES Qualifications List Component (optional - for dashboard summary views)
// Displays ES qualifications in a more compact list format
const ESQualificationsList = ({
  qualifications = [],
  onQualificationClick = null,
  maxDisplay = null,
  showViewAll = false,
  onViewAll = null,
  ES_FUNCTIONAL_AREAS
}) => {
  const hasQualifications = qualifications && qualifications.length > 0;
  const displayQualifications = maxDisplay ? qualifications.slice(0, maxDisplay) : qualifications;
  const hasMore = maxDisplay && qualifications.length > maxDisplay;

  if (!hasQualifications) {
    return (
      <div className="text-xs text-slate-400 italic">
        No ES qualifications
      </div>
    );
  }

  return (
    <div className="space-y-2">
      {displayQualifications.map((qual, i) => (
        <div
          key={i}
          className={`flex items-center justify-between gap-2 p-2 rounded ${
            onQualificationClick ? 'hover:bg-slate-50 cursor-pointer' : ''
          }`}
          onClick={onQualificationClick ? () => onQualificationClick(qual) : undefined}
        >
          <div className="flex-1 min-w-0">
            <div className="text-sm font-medium text-slate-700 truncate flex items-center gap-1">
              {qual.isSkillsEvaluator && (
                <Icon name="Star" className="w-3 h-3 text-amber-500 fill-current flex-shrink-0" />
              )}
              {qual.name}
            </div>
            {qual.functionalArea && (
              <div className="text-xs text-slate-500 truncate">
                {ES_FUNCTIONAL_AREAS[qual.functionalArea] || qual.functionalArea}
              </div>
            )}
          </div>
          <ESBadge qualification={qual} size="small" />
        </div>
      ))}
      {hasMore && showViewAll && onViewAll && (
        <button
          onClick={onViewAll}
          className="text-xs text-blue-600 hover:text-blue-700 font-medium"
        >
          View all {qualifications.length} qualifications â†’
        </button>
      )}
    </div>
  );
};
</script>

<script type="text/babel">
const ComponentProgressBar = ({ requirements }) => {
  if (!requirements || !requirements.requirements) return null;

  const reqEntries = Object.entries(requirements.requirements);

  // Define requirement categories with consistent colors and priority order
  // Order: Leadership, D&C, Aerospace, Fitness, Character, Special Activity
  const categoryMap = {
    // Hard requirements - Leadership (priority 1)
    leadershipTest: { short: 'Leadership', full: 'Leadership Test', color: 'bg-purple-500', priority: 1, type: 'hard' },
    wrightBrothersLeadershipExam: { short: 'Leadership', full: 'Wright Bros Leadership', color: 'bg-purple-500', priority: 1, type: 'hard' },
    mitchellLeadershipExam: { short: 'Leadership', full: 'Mitchell Leadership', color: 'bg-purple-500', priority: 1, type: 'hard' },
    earhartLeadershipExam: { short: 'Leadership', full: 'Earhart Leadership', color: 'bg-purple-500', priority: 1, type: 'hard' },
    spaatzLeadershipExam: { short: 'Leadership', full: 'Spaatz Leadership', color: 'bg-purple-500', priority: 1, type: 'hard' },

    // Hard requirements - Drill & Ceremonies (priority 2)
    drillTest: { short: 'D&C', full: 'Drill & Ceremonies', color: 'bg-rose-500', priority: 2, type: 'hard' },

    // Hard requirements - Aerospace (priority 3)
    aerospaceTest: { short: 'Aerospace', full: 'Aerospace Test', color: 'bg-indigo-500', priority: 3, type: 'hard' },
    mitchellAerospaceExam: { short: 'Aerospace', full: 'Mitchell Aerospace', color: 'bg-indigo-500', priority: 3, type: 'hard' },
    spaatzJOFExam: { short: 'Aerospace', full: 'Journey of Flight', color: 'bg-indigo-500', priority: 3, type: 'hard' },

    // Hard requirements - Fitness (priority 4)
    physicalFitness: { short: 'Fitness', full: 'Physical Fitness', color: 'bg-green-500', priority: 4, type: 'hard' },
    spaatzCFA: { short: 'Fitness', full: 'CFA', color: 'bg-green-500', priority: 4, type: 'hard' },

    // Character development - manual checkboxes (priority 5, lower priority than hard requirements)
    cadetOath: { short: 'Oath', full: 'Oath', color: 'bg-amber-500', priority: 5, type: 'manual' },
    activeParticipation: { short: 'Active', full: 'Active', color: 'bg-amber-500', priority: 5, type: 'manual' },
    characterDevelopment: { short: 'Forum', full: 'Character Development', color: 'bg-amber-500', priority: 5, type: 'manual' },

    // Special activities (priority 6, only shown if required)
    cadetWingmanCourse: { short: 'Wingman', full: 'Cadet Wingman Course', color: 'bg-teal-500', priority: 6, type: 'special' },
    encampment: { short: 'Encampment', full: 'Encampment', color: 'bg-teal-500', priority: 6, type: 'special' },
    cls: { short: 'CLS', full: 'Cadet Leadership School', color: 'bg-teal-500', priority: 6, type: 'special' },
    leadershipExpectations: { short: 'Expect', full: 'Leadership Expectations', color: 'bg-amber-500', priority: 5, type: 'manual' },
    leadershipFeedback: { short: 'Feedback', full: 'Leadership Feedback', color: 'bg-amber-500', priority: 5, type: 'manual' },
    uniformWear: { short: 'Uniform', full: 'Uniform', color: 'bg-amber-500', priority: 5, type: 'manual' },
    eakerSpeech: { short: 'Speech', full: 'Speech', color: 'bg-orange-500', priority: 6, type: 'special' },
    eakerEssay: { short: 'Essay', full: 'Essay', color: 'bg-orange-600', priority: 6, type: 'special' },
    spaatzEssay: { short: 'Essay', full: 'Spaatz Essay', color: 'bg-orange-600', priority: 6, type: 'special' },

    // Staff Duty Analysis (post-Billy Mitchell requirement) - three parts
    sdaService: { short: 'Service', full: 'SDA: Service', color: 'bg-cyan-500', priority: 2.5, type: 'hard' },
    sdaPresentation: { short: 'Present', full: 'SDA: Presentation', color: 'bg-cyan-600', priority: 2.5, type: 'hard' },
    sdaWriting: { short: 'Writing', full: 'SDA: Writing', color: 'bg-cyan-700', priority: 2.5, type: 'hard' }
  };

  // Sort requirements by priority order
  const sortedReqs = reqEntries
    .map(([key, req]) => ({
      key,
      req,
      category: categoryMap[key] || { short: key.slice(0, 4), full: key, color: 'bg-slate-500', priority: 99, type: 'other' }
    }))
    .sort((a, b) => a.category.priority - b.category.priority);

  const totalCount = sortedReqs.length;
  const completedCount = sortedReqs.filter(item => item.req.completed).length;

  return (
    <div className="space-y-1.5">
      {/* Progress indicator */}
      <div className="flex justify-between items-center text-xs font-medium text-slate-600">
        <span>{completedCount} of {totalCount} completed</span>
        <span className="text-slate-500">{Math.round((completedCount / totalCount) * 100)}%</span>
      </div>

      {/* Segmented progress bar with labels */}
      <div className="space-y-0.5">
        <div className="flex gap-0.5 h-4 rounded overflow-hidden border border-slate-200 bg-slate-100">
          {sortedReqs.map(({ key, req, category }) => {
            const isCompleted = req.completed;
            const completedClass = isCompleted ? category.color : 'bg-slate-200';
            const widthPercent = (1 / totalCount) * 100;

            return (
              <div
                key={key}
                className={`relative flex items-center justify-center transition-all group cursor-default ${completedClass}`}
                style={{ width: `${widthPercent}%` }}
                title={req.label}
              >
                {/* Checkmark for completed */}
                {isCompleted && (
                  <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                )}

                {/* Tooltip on hover */}
                <div className="absolute bottom-full mb-2 hidden group-hover:block z-50 w-max max-w-xs bg-slate-800 text-white text-xs rounded py-2 px-3 shadow-lg pointer-events-none">
                  <div className="font-bold mb-0.5">{category.full}</div>
                  <div className="text-slate-300">{req.value || (isCompleted ? 'Completed' : 'Not completed')}</div>
                  <div className={`mt-1 text-xs ${isCompleted ? 'text-green-300' : 'text-amber-300'}`}>
                    {isCompleted ? 'âœ“ Completed' : 'â—‹ Pending'}
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        {/* Labels directly below each segment */}
        <div className="flex gap-0.5">
          {sortedReqs.map(({ key, req, category }) => {
            const isCompleted = req.completed;
            const widthPercent = (1 / totalCount) * 100;

            return (
              <div
                key={`label-${key}`}
                className="flex items-center justify-center"
                style={{ width: `${widthPercent}%` }}
              >
                <span className={`text-[8px] font-semibold text-center leading-tight ${isCompleted ? 'text-slate-700' : 'text-slate-400'}`}>
                  {category.short}
                </span>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

// Promotion Status Card - Shows current rank, time in grade, and readiness
const PromotionStatusCard = ({ cadet }) => {
  const { currentRank, rankDate, currentAchievement, nextAchievement, timeInGrade, promotionStatus, nextRequirements } = cadet;

  const statusColors = {
    'READY': 'bg-green-50 border-green-200',
    'TIME_PENDING': 'bg-amber-50 border-amber-200',
    'NEARLY_READY': 'bg-blue-50 border-blue-200',
    'IN_PROGRESS': 'bg-slate-50 border-slate-200',
    'NOT_STARTED': 'bg-slate-50 border-slate-300',
    'SPAATZ_COMPLETE': 'bg-purple-50 border-purple-200'
  };

  const statusTextColors = {
    'READY': 'text-green-700',
    'TIME_PENDING': 'text-amber-700',
    'NEARLY_READY': 'text-blue-700',
    'IN_PROGRESS': 'text-slate-700',
    'NOT_STARTED': 'text-slate-600',
    'SPAATZ_COMPLETE': 'text-purple-700'
  };

  const statusIcons = {
    'READY': 'âœ“',
    'TIME_PENDING': 'â±',
    'NEARLY_READY': 'â–¶',
    'IN_PROGRESS': 'â—‹',
    'NOT_STARTED': 'â—‹',
    'SPAATZ_COMPLETE': 'â˜…'
  };

  const completionPercent = nextRequirements ? nextRequirements.completionPercent : 0;
  const nextRank = nextAchievement ? CADET_ACHIEVEMENT_TO_RANK[nextAchievement.toString()] : null;

  return (
    <div className={`border rounded-lg p-4 ${statusColors[promotionStatus.status]}`}>
      <div className="flex justify-between items-start mb-3">
        <div>
          <h3 className="text-lg font-bold text-slate-900">{cadet.NameLast}, {cadet.NameFirst}</h3>
          <p className="text-sm text-slate-600">CAPID: {cadet.CAPID}</p>
        </div>
        <div className={`text-2xl ${statusTextColors[promotionStatus.status]}`}>
          {statusIcons[promotionStatus.status]}
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4 mb-3">
        <div>
          <p className="text-xs text-slate-500 uppercase">Current Rank</p>
          <div className="flex items-center gap-2">
            {getRankInsigniaUrl(currentAchievement) && (
              <img src={getRankInsigniaUrl(currentAchievement)} alt={currentRank} className="h-8 w-auto object-contain" />
            )}
            <div>
              <p className="text-lg font-semibold text-slate-900">{currentRank}</p>
              <p className="text-xs text-slate-600">{getAchievementDisplayName(currentAchievement)}</p>
            </div>
          </div>
        </div>
        <div title={rankDate && rankDate !== '01/01/1900' ? `Date of Rank: ${rankDate}` : ''}>
          <p className="text-xs text-slate-500 uppercase">Promotion Eligible</p>
          <p className={`text-lg font-semibold ${timeInGrade.isEligible ? 'text-green-600' : 'text-slate-900'}`}>
            {timeInGrade.eligibleDate || 'N/A'}
          </p>
          <p className="text-xs text-slate-600">
            {timeInGrade.isEligible ? 'âœ“ Eligible now' : `${timeInGrade.days} days (${CADET_TIME_IN_GRADE_DAYS - timeInGrade.days} more needed)`}
          </p>
        </div>
      </div>

      {nextAchievement && nextRank && (
        <div className="border-t border-slate-200 pt-3 space-y-3">
          <div className="flex justify-between items-center">
            <p className="text-sm font-medium text-slate-700">Next: {getAchievementDisplayName(nextAchievement)} â†’ {nextRank}</p>
            <span className={`text-xs font-bold px-2 py-1 rounded ${
              promotionStatus.status === 'READY' ? 'bg-green-100 text-green-700' :
              promotionStatus.status === 'TIME_PENDING' ? 'bg-amber-100 text-amber-700' :
              promotionStatus.status === 'NEARLY_READY' ? 'bg-blue-100 text-blue-700' :
              'bg-slate-100 text-slate-600'
            }`}>
              {promotionStatus.message}
            </span>
          </div>

          {/* Component-based progress bar */}
          <ComponentProgressBar requirements={nextRequirements} />
        </div>
      )}
    </div>
  );
};

// Requirements Checklist - Detailed view of promotion requirements
const RequirementsChecklist = ({ requirements }) => {
  if (!requirements || !requirements.requirements) return null;

  const reqEntries = Object.entries(requirements.requirements);

  // Category map with priority order (same as progress bar)
  const categoryMap = {
    // Hard requirements - Leadership (priority 1)
    leadershipTest: { priority: 1 },
    wrightBrothersLeadershipExam: { priority: 1 },
    mitchellLeadershipExam: { priority: 1 },
    earhartLeadershipExam: { priority: 1 },
    spaatzLeadershipExam: { priority: 1 },
    spaatzJOFExam: { priority: 1 },

    // Hard requirements - D&C and SDA (priority 2)
    drillTest: { priority: 2 },
    sdaService: { priority: 2.5 },
    sdaPresentation: { priority: 2.5 },
    sdaWriting: { priority: 2.5 },

    // Hard requirements - Aerospace (priority 3)
    aerospaceTest: { priority: 3 },
    mitchellAerospaceExam: { priority: 3 },

    // Hard requirements - Fitness (priority 4)
    physicalFitness: { priority: 4 },
    spaatzCFA: { priority: 4 },

    // Character development (priority 5)
    cadetOath: { priority: 5 },
    activeParticipation: { priority: 5 },
    characterDevelopment: { priority: 5 },

    // Special activities (priority 6)
    cadetWingmanCourse: { priority: 6 },
    encampment: { priority: 6 },
    cls: { priority: 6 },
    leadershipExpectations: { priority: 5 },
    leadershipFeedback: { priority: 5 },
    uniformWear: { priority: 5 },
    eakerSpeech: { priority: 6 },
    eakerEssay: { priority: 6 },
    spaatzEssay: { priority: 6 },

    // Time in grade (priority 0 - always first)
    timeInGrade: { priority: 0 }
  };

  // Sort requirements by priority order
  const sortedReqs = reqEntries
    .map(([key, req]) => ({
      key,
      req,
      priority: categoryMap[key] ? categoryMap[key].priority : 99
    }))
    .sort((a, b) => a.priority - b.priority);

  return (
    <div className="space-y-2">
      {sortedReqs.map(({ key, req }) => (
        <div key={key} className="flex items-start justify-between p-2 rounded border border-slate-200 hover:bg-slate-50">
          <div className="flex items-start space-x-2">
            {req.completed ? <CheckCircleFilled /> : <CircleEmpty />}
            <div>
              <p className={`text-sm font-medium ${req.completed ? 'text-slate-900' : 'text-slate-600'}`}>
                {req.label}
              </p>
              {req.value && (
                <p className="text-xs text-slate-500 mt-0.5">{req.value}</p>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  );
};

const AchievementDetailPanel = ({ details, onClose }) => {
  if (!details) return null;

  const { id, isComplete, approvalDate, requirements, honorCreditEarned } = details;
  const displayName = getAchievementDisplayName(id);
  const publicNumber = getPublicAchievementNumber(id);
  const showPublicNumber = publicNumber && !/^Achievement\s+\d+/i.test(displayName || '');

  return (
    <div className="border border-slate-200 rounded-lg bg-white p-4 shadow-sm">
      <div className="flex items-start justify-between gap-3">
        <div>
          <h4 className="text-base font-bold text-slate-900">{displayName || `Achievement ${id}`}</h4>
          {showPublicNumber && (
            <div className="text-xs text-slate-500 mt-0.5">Achievement {publicNumber}</div>
          )}
          <div className="text-xs text-slate-500 mt-1">
            {isComplete
              ? (approvalDate ? `Approved on ${approvalDate}` : 'Approved (date not available)')
              : 'Not yet approved'}
          </div>
        </div>
        <button
          type="button"
          onClick={onClose}
          className="text-xs font-semibold text-slate-600 hover:text-slate-900 border border-slate-200 rounded px-2 py-1 bg-slate-50 hover:bg-slate-100"
        >
          Close details
        </button>
      </div>

      {honorCreditEarned && (
        <div className="mt-2 text-xs font-semibold text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1 inline-flex">
          Honor credit earned
        </div>
      )}

      {requirements && (
        <div className="mt-4">
          <div className="text-xs uppercase font-bold text-slate-500 mb-2">Requirements</div>
          <RequirementsChecklist requirements={requirements} />
        </div>
      )}
    </div>
  );
};

// Phase Progress Timeline - Visual representation of phase progression
const PhaseProgressTimeline = ({ currentAchievement, approvedAchievements, honorCreditAchievements = [], cadet, cadetDataService, dataFiles }) => {
  const [selectedAchievement, setSelectedAchievement] = React.useState(null);
  const phases = Object.entries(CADET_PHASES || {})
    .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
    .map(([id, phase]) => {
      const match = (phase.name || '').match(/^(Phase\s+[^()]+)\s*\(([^)]+)\)$/i);
      return {
        id: parseInt(id),
        name: match ? match[1].trim() : phase.name,
        subtitle: match ? match[2].trim() : '',
        achievements: phase.achievements || [],
        milestone: phase.milestoneAchv,
        milestoneName: phase.milestoneName
      };
    });

  const isAchievementComplete = (achvId) => approvedAchievements.includes(achvId);
  const hasHonorCredit = (achvId) => honorCreditAchievements.some(h => h.achievementId === achvId);
  const currentPhase = determinePhaseFromAchievement(currentAchievement);

  const getApprovalDate = (achvId) => {
    if (!cadet || !dataFiles) return null;
    const capid = String(cadet.CAPID || '').trim();
    const achvStr = String(achvId || '').trim();
    const approvals = (dataFiles.cadetAchvAprs || [])
      .filter(a =>
        String(a.CAPID || '').trim() === capid &&
        String(a.CadetAchvID || '').trim() === achvStr &&
        String(a.Status || '').trim() === 'APR'
      );
    const pickDate = (record) => {
      const created = String(record.DateCreated || '').trim();
      const modified = String(record.DateMod || '').trim();
      if (created && created !== '01/01/1900') return created;
      if (modified && modified !== '01/01/1900') return modified;
      return null;
    };
    if (approvals.length > 0) {
      const dated = approvals.map(pickDate).filter(Boolean);
      if (dated.length > 0) return dated[0];
    }

    const name = (CADET_ACHIEVEMENT_NAMES[String(achvId)] || '').toLowerCase();
    if (name && dataFiles.cadetAchvFullReport) {
      const match = dataFiles.cadetAchvFullReport.find(r =>
        String(r.CAPID || '').trim() === capid &&
        String(r.AchvName || '').trim().toLowerCase() === name
      );
      if (match && match.AprDate && match.AprDate !== '01/01/1900') {
        return String(match.AprDate).trim();
      }
    }

    return null;
  };

  const buildAchievementDetails = (achievementId) => {
    if (!cadet) return null;
    const isComplete = isAchievementComplete(achievementId);
    const approvalDate = getApprovalDate(achievementId);
    const honorCreditEarned = hasHonorCredit(achievementId);
    const requirements = cadetDataService
      ? cadetDataService.getAchievementRequirements(cadet.CAPID, achievementId.toString(), cadet.timeInGrade)
      : null;

    return {
      id: achievementId,
      isComplete,
      approvalDate,
      honorCreditEarned,
      requirements
    };
  };

  const handleSelectAchievement = (achievementId) => {
    setSelectedAchievement((prev) => {
      if (prev && prev.id === achievementId) return null;
      return buildAchievementDetails(achievementId);
    });
  };

  return (
    <div className="space-y-4">
      <div className="text-xs text-slate-500">Click an achievement to view completion dates and requirements.</div>
      {phases.map((phase, idx) => {
        const allAchievementsComplete = [...phase.achievements, phase.milestone].every(a => isAchievementComplete(a));
        const milestoneComplete = isAchievementComplete(phase.milestone);
        const isCurrent = phase.id === currentPhase;
        const isPast = phase.id < currentPhase;

        return (
          <div key={phase.id} className="relative">
            {idx < phases.length - 1 && (
              <div className={`absolute left-4 top-12 w-0.5 h-full ${isPast ? 'bg-green-500' : 'bg-slate-200'}`} />
            )}

            <div className={`border rounded-lg p-4 ${isCurrent ? 'border-blue-500 bg-blue-50' : isPast ? 'border-green-200 bg-green-50' : 'border-slate-200'}`}>
              <div className="flex items-start space-x-3">
                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                  allAchievementsComplete ? 'bg-green-500 text-white' :
                  isCurrent ? 'bg-blue-500 text-white' :
                  'bg-slate-200 text-slate-600'
                }`}>
                  {allAchievementsComplete ? 'âœ“' : phase.id}
                </div>

                <div className="flex-1">
                  <h4 className="font-bold text-slate-900">
                    {phase.subtitle ? `${phase.name} - ${phase.subtitle}` : phase.name}
                  </h4>
                  <div className="flex flex-wrap gap-2 mb-2">
                    {phase.achievements.map(achv => (
                      <button
                        type="button"
                        key={achv}
                        onClick={() => handleSelectAchievement(achv)}
                        className={`relative px-2 py-1 rounded text-xs font-medium transition hover:shadow-sm ${
                          isAchievementComplete(achv) ? "bg-green-100 text-green-800" :
                          achv === currentAchievement + 1 ? "bg-blue-100 text-blue-800" :
                          "bg-slate-100 text-slate-600"
                        }`}
                        title={`${getAchievementDisplayName(achv)}${hasHonorCredit(achv) ? " - Honor Credit Earned" : ""}`}
                      >
                        {getPublicAchievementNumber(achv)}
                        {isAchievementComplete(achv) && hasHonorCredit(achv) && (
                          <svg className="inline-block w-3 h-3 ml-1 text-amber-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7-6.3-4.6-6.3 4.6 2.3-7-6-4.6h7.6z"/>
                          </svg>
                        )}
                      </button>
                    ))}
                  </div>

                  <button
                    type="button"
                    onClick={() => handleSelectAchievement(phase.milestone)}
                    className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                      milestoneComplete ? "bg-amber-500 text-white" : "bg-amber-100 text-amber-800"
                    }`}
                  >
                    â˜… {phase.milestoneName}
                    {milestoneComplete && " âœ“"}
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      })}
      <Modal
        isOpen={!!selectedAchievement}
        onClose={() => setSelectedAchievement(null)}
        title={selectedAchievement ? getAchievementDisplayName(selectedAchievement.id) : 'Achievement Details'}
      >
        <AchievementDetailPanel
          details={selectedAchievement}
          onClose={() => setSelectedAchievement(null)}
        />
      </Modal>
    </div>
  );
};

// Milestone Awards Card - Shows major awards progress
const MilestoneAwardsCard = ({ milestoneAwards, currentAchievement }) => {
  const milestones = [
    { id: 4, name: 'Wright Brothers', rank: 'C/SSgt', phase: 1 },
    { id: 10, name: 'Billy Mitchell', rank: 'C/2dLt', phase: 2 },
    { id: 14, name: 'Amelia Earhart', rank: 'C/Capt', phase: 3 },
    { id: 20, name: 'Ira C. Eaker', rank: 'C/LtCol', phase: 4 },
    { id: 21, name: 'Carl A. Spaatz', rank: 'C/Col', phase: 5 }
  ];

  const getAwardStatus = (milestoneId) => {
    const award = milestoneAwards.find(a => a.award && a.award.toUpperCase().includes(milestones.find(m => m.id === milestoneId)?.name.split(' ').pop().toUpperCase()));
    if (award) return { status: 'EARNED', date: award.completed, awardNo: award.awardNo };
    if (currentAchievement >= milestoneId) return { status: 'EARNED', date: null };
    if (currentAchievement === milestoneId - 1) return { status: 'IN_PROGRESS' };
    return { status: 'FUTURE' };
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
      {milestones.map((milestone) => {
        const status = getAwardStatus(milestone.id);

        return (
          <div key={milestone.id} className={`border rounded-lg p-4 text-center ${
            status.status === 'EARNED' ? 'border-amber-500 bg-amber-50' :
            status.status === 'IN_PROGRESS' ? 'border-blue-500 bg-blue-50' :
            'border-slate-200 bg-white'
          }`}>
            <div className="relative mb-3">
              {getRankInsigniaUrl(milestone.id) && (
                <img src={getRankInsigniaUrl(milestone.id)} alt={milestone.rank} className="h-16 w-auto object-contain mx-auto" />
              )}
              <div className={`absolute -top-1 -right-1 text-2xl ${
                status.status === 'EARNED' ? 'text-amber-500' :
                status.status === 'IN_PROGRESS' ? 'text-blue-500' :
                'text-slate-300'
              }`}>
                {status.status === 'EARNED' ? 'â˜…' : 'â˜†'}
              </div>
            </div>
            <h4 className="font-bold text-sm text-slate-900 mb-1">{milestone.name}</h4>
            <p className="text-xs text-slate-600 mb-1">{milestone.rank}</p>
            <p className="text-xs text-slate-500">{getAchievementDisplayName(milestone.id)}</p>
            {status.date && (
              <p className="text-xs text-amber-700 mt-2 font-medium">Earned: {status.date}</p>
            )}
            {status.awardNo && (
              <p className="text-xs text-slate-500">#{status.awardNo}</p>
            )}
          </div>
        );
      })}
    </div>
  );
};

// Orientation Flights Card - Shows powered O-Flight progress for cadets
// Syllabus 6-10 are the five powered orientation flight syllabi
// Syllabus 99 is a back seat ride
const OrientationFlightsCard = ({ oFlights = [], capid }) => {
  // Filter flights for this cadet
  const cadetFlights = oFlights.filter(f => String(f.CAPID || '').trim() === String(capid || '').trim());

  // Powered flight syllabi (6-10) with their descriptions
  const poweredSyllabi = [
    { num: 6, name: 'Ground Handling, Preflight, Takeoff & Landing', short: 'Ground' },
    { num: 7, name: 'Normal Flight Maneuvers', short: 'Normal' },
    { num: 8, name: 'Advanced Flight Maneuvers', short: 'Advanced' },
    { num: 9, name: 'Use of Instruments in Flight', short: 'Instruments' },
    { num: 10, name: 'Weather', short: 'Weather' }
  ];

  // Get completed syllabi with dates
  const getSyllabusFlights = (syllabusNum) => {
    return cadetFlights
      .filter(f => {
        const syllabus = parseInt(f.Syllabus);
        return syllabus === syllabusNum;
      })
      .sort((a, b) => new Date(b.FltDate) - new Date(a.FltDate));
  };

  // Count total powered flights (syllabus 6-10)
  const poweredFlights = cadetFlights.filter(f => {
    const syllabus = parseInt(f.Syllabus);
    return syllabus >= 6 && syllabus <= 10;
  });

  // Count back seat rides (syllabus 99)
  const backSeatRides = cadetFlights.filter(f => parseInt(f.Syllabus) === 99);

  const hasAnyFlights = cadetFlights.length > 0;
  const completedSyllabiCount = poweredSyllabi.filter(s => getSyllabusFlights(s.num).length > 0).length;

  return (
    <div className="space-y-4">
      {/* Summary Stats */}
      <div className="flex flex-wrap gap-4 text-sm">
        <div className="flex items-center gap-2">
          <Icon name="Plane" className="w-4 h-4 text-sky-600" />
          <span className="text-slate-600">
            <span className="font-semibold text-slate-900">{poweredFlights.length}</span> powered flight{poweredFlights.length !== 1 ? 's' : ''}
          </span>
        </div>
        {backSeatRides.length > 0 && (
          <div className="flex items-center gap-2">
            <Icon name="Users" className="w-4 h-4 text-slate-500" />
            <span className="text-slate-600">
              <span className="font-semibold text-slate-900">{backSeatRides.length}</span> back seat ride{backSeatRides.length !== 1 ? 's' : ''}
            </span>
          </div>
        )}
      </div>

      {/* Syllabus Progress Circles */}
      <div className="flex flex-wrap gap-3 justify-center md:justify-start">
        {poweredSyllabi.map((syllabus) => {
          const flights = getSyllabusFlights(syllabus.num);
          const isCompleted = flights.length > 0;
          const latestFlight = flights[0];
          const flightDate = latestFlight?.FltDate || null;
          const aircraft = latestFlight?.AcftTailNum || null;

          // Build tooltip text
          let tooltipText = `Syllabus ${syllabus.num}: ${syllabus.name}`;
          if (isCompleted) {
            tooltipText += `\nCompleted: ${flightDate}`;
            if (aircraft) tooltipText += `\nAircraft: ${aircraft}`;
            if (flights.length > 1) tooltipText += `\n(${flights.length} total flights)`;
          } else {
            tooltipText += '\nNot yet completed';
          }

          return (
            <div
              key={syllabus.num}
              className="group relative flex flex-col items-center gap-1"
            >
              {/* Circle indicator */}
              <div
                className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg transition-all cursor-default ${
                  isCompleted
                    ? 'bg-emerald-500 text-white shadow-md'
                    : 'bg-slate-100 text-slate-400 border-2 border-slate-200'
                }`}
                title={tooltipText}
              >
                {syllabus.num}
                {isCompleted && flights.length > 1 && (
                  <span className="absolute -top-1 -right-1 bg-sky-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-medium">
                    {flights.length}
                  </span>
                )}
              </div>

              {/* Label */}
              <span className={`text-[10px] font-medium text-center leading-tight max-w-[60px] ${
                isCompleted ? 'text-slate-700' : 'text-slate-400'
              }`}>
                {syllabus.short}
              </span>

              {/* Checkmark for completed */}
              {isCompleted && (
                <div className="absolute -top-1 -left-1 bg-white rounded-full">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="text-emerald-500">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                </div>
              )}

              {/* Hover tooltip */}
              <div className="absolute bottom-full mb-2 hidden group-hover:block z-50 w-max max-w-xs bg-slate-800 text-white text-xs rounded py-2 px-3 shadow-lg pointer-events-none whitespace-pre-line">
                {tooltipText}
              </div>
            </div>
          );
        })}
      </div>

      {/* Progress indicator */}
      <div className="text-xs text-slate-500 text-center md:text-left">
        {completedSyllabiCount === 5 ? (
          <span className="text-emerald-600 font-semibold">All 5 powered O-Flight syllabi completed!</span>
        ) : completedSyllabiCount > 0 ? (
          <span>{completedSyllabiCount} of 5 powered O-Flight syllabi completed</span>
        ) : (
          <span className="text-slate-400">No powered O-Flights recorded yet</span>
        )}
      </div>

      {/* Flight History (collapsible if many flights) */}
      {hasAnyFlights && (
        <details className="text-sm">
          <summary className="cursor-pointer text-sky-600 hover:text-sky-800 font-medium">
            View flight history ({cadetFlights.length} total)
          </summary>
          <div className="mt-2 max-h-48 overflow-y-auto border border-slate-200 rounded-lg">
            <table className="w-full text-xs">
              <thead className="bg-slate-50 sticky top-0">
                <tr className="text-left text-slate-600">
                  <th className="px-3 py-2 font-medium">Date</th>
                  <th className="px-3 py-2 font-medium">Syllabus</th>
                  <th className="px-3 py-2 font-medium">Aircraft</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {cadetFlights
                  .sort((a, b) => new Date(b.FltDate) - new Date(a.FltDate))
                  .map((flight, idx) => {
                    const syllabusNum = parseInt(flight.Syllabus);
                    const syllabusInfo = poweredSyllabi.find(s => s.num === syllabusNum);
                    const syllabusName = syllabusNum === 99 ? 'Back Seat' : (syllabusInfo?.short || `#${syllabusNum}`);

                    return (
                      <tr key={idx} className="hover:bg-slate-50">
                        <td className="px-3 py-2 text-slate-700">{flight.FltDate}</td>
                        <td className="px-3 py-2">
                          <span className={`inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium ${
                            syllabusNum === 99
                              ? 'bg-slate-100 text-slate-600'
                              : 'bg-sky-100 text-sky-700'
                          }`}>
                            {syllabusName}
                          </span>
                        </td>
                        <td className="px-3 py-2 text-slate-600 font-mono">{flight.AcftTailNum || '-'}</td>
                      </tr>
                    );
                  })}
              </tbody>
            </table>
          </div>
        </details>
      )}
    </div>
  );
};

</script>

<script type="text/babel">
const OrgNode = ({ node, hideVacant, expandedSections, setExpandedSections, onMemberClick, showCommandChainOnly, onDrillDown }) => {
  if (!node) return null;

  const hasVisibleChildren = (n) => {
    if (!hideVacant) return n.children && n.children.length > 0;
    if (n.members && n.members.length > 0) return true;
    return n.children && n.children.some(c => hasVisibleChildren(c));
  };

  if (hideVacant && !hasVisibleChildren(node) && node.members.length === 0) return null;

  const isCadet = node.type && node.type === 'cadet';
  const colorClass = isCadet ? "bg-slate-700 text-white" : "bg-blue-900 text-white";

  // Command chain positions (only show these when command chain filter is active)
  // Unit level: Commander, Deputies, Cadet Commander and Cadet Deputies, Flight Leadership
  const commandChainIds = [
    'root', 'deputy', 'cds', 'cdc',
    'ccmdr', 'c_dep_ops', 'c_dep_sup', 'c_first',
    'flight_cmdr', 'flight_sgt', 'group_cmdr', 'squadron_cmdr'
  ];

  // Allow dynamic command-chain nodes (unit-specific ids) to appear when expanded
  const commandChainSuffixes = [
    '_deputy', '_cds', '_cdc', '_ccmdr', '_c_dep_ops', '_c_dep_sup', '_c_first', '_flight_cmdr', '_flight_sgt'
  ];

  const isCommandChainNode = (n) => {
    if (!n) return false;
    if (commandChainIds.includes(n.id)) return true;
    // Allow dynamic commander nodes that carry the unit id in the key
    if (n.id.startsWith('group_cmdr_') || n.id.startsWith('squadron_cmdr_')) return true;
    return commandChainSuffixes.some(suffix => n.id.endsWith(suffix));
  };

  let visibleChildren = hideVacant
    ? (node.children || []).filter(c => hasVisibleChildren(c) || c.members.length > 0)
    : (node.children || []);

  // Filter to command chain only if enabled
  if (showCommandChainOnly) {
    visibleChildren = visibleChildren.filter(isCommandChainNode);
  }

  const isCollapsed = expandedSections && !expandedSections.has(node.id);
  const hasChildren = visibleChildren.length > 0;

  const toggleExpand = (e) => {
    e.stopPropagation();
    if (!setExpandedSections || !hasChildren) return;

    // Gather IDs for cadet chain and their parents so the whole chain opens in one click
    const collectCadetIds = (n, ids) => {
      if (!n) return false;
      const isCadetish = n.type === 'cadet' || n.id.startsWith('c_') || n.id.startsWith('flight');
      let hasCadet = isCadetish;
      (n.children || []).forEach(child => {
        if (collectCadetIds(child, ids)) hasCadet = true;
      });
      if (hasCadet) ids.push(n.id);
      return hasCadet;
    };

    setExpandedSections(prev => {
      const newSet = new Set(prev);
      if (newSet.has(node.id)) {
        newSet.delete(node.id);
      } else {
        newSet.add(node.id);
        // When showing command chain, auto-expand cadet chain under this unit
        if (showCommandChainOnly) {
          const cadetIds = [];
          collectCadetIds(node, cadetIds);
          cadetIds.forEach(id => newSet.add(id));
        }
      }
      return newSet;
    });
  };

  const handleMemberClick = (memberName) => {
    if (!onMemberClick) return;
    // Extract CAPID from member string format: "Rank LastName, FirstName"
    // This is a simplified extraction - would need actual CAPID from data
    onMemberClick(memberName);
  };

  // Grouping node: specifically designed to group positions (like "Commander's Staff")
  // Only certain IDs are true grouping nodes, not just any vacant position with children
  const isGroupingNode = node.id === 'commander_staff';

  return (
    <div className="flex flex-col items-center mx-2 my-1">
      <div className="relative border-2 rounded-lg shadow-lg mb-3 p-0 w-56 bg-white z-10 hover:shadow-xl transition-shadow">
        <div className={`${colorClass} px-3 py-2 text-center text-xs font-bold uppercase ${isGroupingNode ? 'rounded-md' : 'rounded-t-md'} flex items-center justify-center gap-1`} title={node.title}>
          {onDrillDown && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                onDrillDown(node);
              }}
              className="text-white hover:bg-black hover:bg-opacity-20 rounded p-1 transition-colors"
              title="View across all sub-units"
            >
              <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                <path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd"/>
              </svg>
            </button>
          )}
          <span className="flex-1 text-center leading-tight whitespace-normal">{node.title}</span>
          {hasChildren && (
            <button
              onClick={toggleExpand}
              className="text-white hover:bg-black hover:bg-opacity-20 rounded px-1.5 py-0.5 transition-colors"
              title={isCollapsed ? "Expand" : "Collapse"}
            >
              {isCollapsed ? '>' : 'v'}
            </button>
          )}
        </div>
        {/* Only show white body section if not a grouping node */}
        {!isGroupingNode && (
          <div className="p-2 min-h-[40px] flex flex-col justify-center bg-white rounded-b-md">
            {node.members && node.members.length > 0 ? (
              node.members.map((m,i) => {
                const display = m.includes('||') ? m.split('||')[0] : m;
                return (
                  <div
                    key={i}
                    className="text-xs font-medium text-slate-800 border-b last:border-0 border-slate-100 py-1 px-1 hover:bg-blue-50 cursor-pointer transition-colors rounded"
                    onClick={() => handleMemberClick(m)}
                    title="Click to view profile"
                  >
                    {display}
                  </div>
                );
              })
            ) : (
              <span className="text-[11px] uppercase font-bold text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1 text-center">Vacant</span>
            )}
          </div>
        )}
      </div>

      {hasChildren && !isCollapsed && (
        <div className="relative w-full flex flex-col items-center">
          <div className="w-0.5 h-4 bg-slate-400"></div>
          <div className="relative flex justify-center items-start gap-2">
            {visibleChildren.length > 1 && (
              <div className="absolute top-0 left-0 right-0 h-0.5 bg-slate-400" style={{width: '100%'}}></div>
            )}
            {visibleChildren.map(c => (
              <div key={c.id} className="relative flex flex-col items-center">
                {visibleChildren.length > 1 && <div className="w-0.5 h-4 bg-slate-400"></div>}
                <OrgNode node={c} hideVacant={hideVacant} expandedSections={expandedSections} setExpandedSections={setExpandedSections} onMemberClick={onMemberClick} showCommandChainOnly={showCommandChainOnly} onDrillDown={onDrillDown} />
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// Expose OrgNode globally for use in other script blocks
window.OrgNode = OrgNode;

</script>

<script type="text/babel">
// Level Detail Modal
// Shows detailed breakdown of Education & Training level progress for a member
const LevelDetailModal = ({
  isOpen,
  onClose,
  member,
  level,
  // Helper functions
  getLevelBreakdown,
  // Constants
  LEVEL_DISPLAY_MAP
}) => {
  if (!isOpen || !member || !level) return null;

  const breakdown = getLevelBreakdown(member, level);
  const groups = breakdown?.groups || [];
  const track = breakdown?.track;
  const meta = (member.levelsProgress && member.levelsProgress[level]) || { percent: 0, status: 'not-started' };
  const levelDef = LEVEL_DISPLAY_MAP[level] || { name: `Level ${level}`, label: level };

  const statusLabel = (() => {
    if (meta.status === 'completed') return 'Completed / Awarded';
    if (meta.status === 'pending') return meta.approvalStatus === 'disapproved' ? 'Submitted - Needs Update' : 'Submitted - Pending Approval';
    if (meta.status === 'ready') return 'Ready for Approval';
    if (meta.status === 'in-progress') return 'In Progress';
    return 'Not Started';
  })();

  const statusColor = meta.status === 'completed' ? 'bg-green-50 border-green-200 text-green-800' : (meta.status === 'ready' || meta.status === 'pending') ? 'bg-amber-50 border-amber-200 text-amber-800' : 'bg-slate-50 border-slate-200 text-slate-700';

  return (
    <Modal
      isOpen={isOpen}
      zIndex={60}
      onClose={onClose}
      title={`${member.NameLast} - ${levelDef.name || 'Level Progress'}`}
    >
      <div className="space-y-3">
        <div className={`border rounded-lg p-4 flex items-start justify-between ${statusColor}`}>
          <div>
            <div className="text-xs uppercase tracking-wide font-bold text-slate-500">{levelDef.name}</div>
            <div className="text-lg font-bold mt-1">{statusLabel}</div>
            <div className="text-xs text-slate-600 mt-1">Progress: {meta.percent || 0}%</div>
            {meta.status === 'completed' && meta.date && <div className="text-[11px] text-slate-500 mt-1">Completed: {meta.date}</div>}
            {meta.status === 'ready' && <div className="text-[11px] text-amber-700 font-semibold mt-1">All modules complete. Submit for award.</div>}
            {meta.status === 'pending' && <div className="text-[11px] text-amber-700 font-semibold mt-1">Awaiting approval.</div>}
          </div>
          {(level === 'L2P1' || level === 'L2P2') && (
            <div className="text-right">
              <div className="text-[11px] text-slate-500 uppercase font-bold mb-1">Level 2 Track</div>
              <div className="inline-flex items-center px-2 py-1 rounded-full text-[11px] font-semibold border bg-white">
                {track ? track : 'Not Selected'}
              </div>
            </div>
          )}
        </div>

        {groups.map((g, i) => (
          <div key={i} className="border rounded-lg overflow-hidden shadow-sm">
            <div className={`px-4 py-2.5 text-sm font-bold flex justify-between items-center ${g.isGroupDone ? 'bg-green-50 text-green-800 border-b border-green-100' : 'bg-amber-50 text-amber-800 border-b border-amber-200'}`}>
              <span>{g.groupName}</span>
              <span className="text-xs px-2 py-0.5 bg-white rounded border ml-2">{g.completedCount} / {g.required}</span>
            </div>
            <div className="p-4 bg-white space-y-2">
              {g.tasks.map((t, ti) => (
                <div key={ti} className="flex items-start text-xs group">
                  <div className="mr-3 mt-0.5">
                    {t.isDone ? <CheckCircleFilled /> : <CircleEmpty />}
                  </div>
                  <div>
                    <div className="flex items-center gap-2">
                      <span className={`font-medium ${t.isDone ? "text-slate-900" : "text-slate-600"}`}>{t.TaskName}</span>
                      {(() => {
                        const trackTags = (t.appliesTo || []).filter(tag => tag !== 'ALL');
                        if (!trackTags.length) return null;
                        return (
                          <div className="flex gap-1">
                            {trackTags.map(tag => (
                              <span key={`${t.TaskID}-${tag}`} className="text-[10px] px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-600 border border-slate-200">{tag}</span>
                            ))}
                          </div>
                        );
                      })()}
                    </div>
                    {t.Description && <p className="text-slate-400 mt-0.5 leading-tight">{t.Description}</p>}
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </Modal>
  );
};
</script>

<script type="text/babel">
// Promotion Eligibility Check Modal
// Shows detailed promotion criteria and member's current status toward next rank
const PromotionCriteriaModal = ({
  isOpen,
  onClose,
  member,
  // Helper functions
  getPromotionDetails
}) => {
  if (!isOpen || !member) return null;

  const d = getPromotionDetails(member);

  if (!d) {
    return (
      <Modal isOpen={isOpen} onClose={onClose} title="Promotion Eligibility Check">
        <div className="p-8 text-center text-slate-400 bg-slate-50 rounded-lg border border-dashed border-slate-300">
          No promotion criteria found for {member.Rank}
        </div>
      </Modal>
    );
  }

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Promotion Eligibility Check">
      <div className="space-y-6">
        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-100 flex justify-between items-center shadow-sm">
          <div>
            <div className="text-xs uppercase text-blue-600 font-bold tracking-wider mb-1">Current Rank</div>
            <div className="text-3xl font-bold text-slate-800">{d.currentRank}</div>
            <div className="text-xs text-slate-500 mt-1">Date of Rank: {d.rankDate}</div>
          </div>
          <div className="text-right">
            <div className="text-xs uppercase text-indigo-600 font-bold tracking-wider mb-1">Next Rank</div>
            <div className="text-3xl font-bold text-slate-800">{d.nextRank}</div>
            <div className={`text-xs font-bold mt-1 px-2 py-0.5 rounded-full inline-block ${d.isTigMet && d.isLevelMet && (!d.dutyReq || d.isDutyMet) ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-600'}`}>
              {d.isTigMet && d.isLevelMet && (!d.dutyReq || d.isDutyMet) ? "ELIGIBLE NOW" : `Earliest: ${d.eligibleDate}`}
            </div>
          </div>
        </div>

        <div className={`grid grid-cols-1 ${d.dutyReq ? 'md:grid-cols-3' : 'md:grid-cols-2'} gap-4`}>
          <div className={`p-4 rounded-lg border-l-4 shadow-sm ${d.isTigMet ? 'bg-green-50 border-green-500' : 'bg-amber-50 border-amber-500'}`}>
            <div className="flex items-center mb-2">
              <Icon name={d.isTigMet ? "CheckCircle" : "Clock"} className={`w-5 h-5 mr-2 ${d.isTigMet ? 'text-green-600' : 'text-amber-600'}`} />
              <h4 className={`font-bold ${d.isTigMet ? 'text-green-800' : 'text-amber-800'}`}>Time in Grade</h4>
            </div>
            <p className="text-sm text-slate-600 mb-1">Required: {d.tigMonthsRequired} Months</p>
            <p className="text-xs font-bold text-slate-500">{d.isTigMet ? "Completed" : `${d.tigMonthsCurrent} / ${d.tigMonthsRequired} Months accrued`}</p>
          </div>

          <div className={`p-4 rounded-lg border-l-4 shadow-sm ${d.isLevelMet ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`}>
            <div className="flex items-center mb-2">
              <Icon name={d.isLevelMet ? "CheckCircle" : "TrendingUp"} className={`w-5 h-5 mr-2 ${d.isLevelMet ? 'text-green-600' : 'text-red-600'}`} />
              <h4 className={`font-bold ${d.isLevelMet ? 'text-green-800' : 'text-red-800'}`}>Education & Training</h4>
            </div>
            <p className="text-sm text-slate-600 mb-1">Required: {d.levelRequired}</p>
            <p className="text-xs font-bold text-slate-500">{d.isLevelMet ? `Requirement Met` : `Current: ${d.levelCurrent}`}</p>
          </div>

          {d.dutyReq && (
            <div className={`p-4 rounded-lg border-l-4 shadow-sm ${d.isDutyMet ? 'bg-green-50 border-green-500' : 'bg-amber-50 border-amber-500'}`}>
              <div className="flex items-center mb-2">
                <Icon name={d.isDutyMet ? "CheckCircle" : "Briefcase"} className={`w-5 h-5 mr-2 ${d.isDutyMet ? 'text-green-600' : 'text-amber-600'}`} />
                <h4 className={`font-bold ${d.isDutyMet ? 'text-green-800' : 'text-amber-800'}`}>Duty Tenure</h4>
              </div>
              <p className="text-sm text-slate-600 mb-1">Req: {d.dutyReq}</p>
              <p className="text-xs font-bold text-slate-500">{d.dutyStatusString}</p>
            </div>
          )}
        </div>

        <div className="bg-slate-50 p-4 text-xs text-slate-500 italic rounded-lg border border-slate-100">
          Note: This tracker calculates basic TIG and ET requirements based on CAPR 35-5. It does not track commander approval, board reviews, or specialty specific requirements (e.g. Mission Pilot ratings).
        </div>
      </div>
    </Modal>
  );
};
</script>

<script type="text/babel">
// Senior Member Profile Modal
// Comprehensive view of senior member's qualifications, training, duties, and ES quals
const SeniorProfileModal = ({
  isOpen,
  onClose,
  member,
  // Helper functions
  getMemberEmail,
  getCadetProtectionStatus,
  getTlcStatus,
  getPromotionDetails,
  normalizeTrackDisplayName,
  // Data
  dataFiles,
  trainingCourseIndex,
  voluInstructorIndex,
  // Constants
  LEVELS,
  PME_COURSE_DEFS,
  CAP_LEADERSHIP_COURSE_DEFS,
  LEGACY_LEADERSHIP_COURSE_DEFS,
  ES_FUNCTIONAL_AREAS,
  // Modal state setters
  setSelectedMember,
  setDetailLevel,
  setSelectedESQualification,
  setShowESTreeModal
}) => {
  if (!isOpen || !member) return null;

  // Helper function to get level status display properties
  const getLevelStatusDisplay = (meta = {}) => {
    const status = meta.status || 'not-started';
    const statusMap = {
      completed: { label: 'Completed', badge: 'bg-emerald-100 text-emerald-700 border-emerald-200', bar: 'bg-emerald-500' },
      pending: { label: 'Submitted', badge: 'bg-amber-100 text-amber-700 border-amber-200', bar: 'bg-amber-500' },
      ready: { label: 'Ready to Submit', badge: 'bg-amber-100 text-amber-700 border-amber-200', bar: 'bg-amber-500' },
      'in-progress': { label: 'In Progress', badge: 'bg-blue-100 text-blue-700 border-blue-200', bar: 'bg-blue-500' },
      'not-started': { label: 'Not Started', badge: 'bg-slate-100 text-slate-600 border-slate-200', bar: 'bg-slate-400' }
    };
    return statusMap[status] || statusMap['not-started'];
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Member Profile" maxWidthClass="max-w-5xl">
      <div className="space-y-4">
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg">
          <div className="text-2xl font-bold">{member.Rank} {member.NameLast}, {member.NameFirst}</div>
          <div className="text-sm text-slate-600 mt-1">CAPID: {member.CAPID}</div>
          <div className="text-sm text-slate-600">Unit: {member.memberUnitName}</div>
          <div className="text-sm text-slate-600 mt-1">
            Email:{' '}
            {getMemberEmail(member.CAPID) ? (
              <a href={`mailto:${getMemberEmail(member.CAPID)}`} className="text-blue-600 hover:underline">
                {getMemberEmail(member.CAPID)}
              </a>
            ) : (
              <span className="text-slate-400 italic">Not available</span>
            )}
          </div>
        </div>

        {/* Education and Training */}
        <div className="border-t pt-4">
          <div className="flex flex-wrap items-center justify-between gap-2">
            <h4 className="font-bold flex items-center gap-2">
              <Icon name="BookOpen" className="w-4 h-4 text-green-600" />
              Education and Training
            </h4>
            <div className="flex flex-wrap items-center gap-2">
              <span className="text-[11px] font-semibold uppercase text-slate-600 bg-slate-100 border border-slate-200 px-2 py-0.5 rounded-full">
                Current Level: {member.currentLevel ? `Level ${member.currentLevel}` : 'Not Started'}
              </span>
              {(!member.currentLevel || member.currentLevel < 3) && (
                <span className="text-[11px] font-semibold uppercase text-slate-600 bg-blue-50 border border-blue-200 px-2 py-0.5 rounded-full">
                  Level 2 Track: {member.level2Track || 'Not Selected'}
                </span>
              )}
            </div>
          </div>

          <div className="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {LEVELS.map(lvl => {
              const meta = member.levelsProgress[lvl.id] || { percent: 0, status: 'not-started' };
              const display = getLevelStatusDisplay(meta);
              const percent = Math.min(100, Math.max(0, meta.percent || 0));
              return (
                <button
                  key={lvl.id}
                  className="text-left border border-slate-200 rounded-lg p-3 bg-white hover:border-blue-300 hover:shadow-sm transition-all"
                  onClick={() => {
                    setSelectedMember(member);
                    setDetailLevel(lvl.id);
                  }}
                >
                  <div className="flex items-start justify-between gap-2">
                    <div>
                      <div className="text-[11px] uppercase tracking-wide font-bold text-slate-500">Level {lvl.label}</div>
                      <div className="text-sm font-semibold text-slate-800">{lvl.name}</div>
                    </div>
                    <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${display.badge}`}>{display.label}</span>
                  </div>
                  <div className="mt-3 h-2 bg-slate-100 rounded-full overflow-hidden">
                    <div className={`h-full ${display.bar}`} style={{ width: `${percent}%` }}></div>
                  </div>
                  <div className="mt-1 text-[11px] text-slate-500">{percent}% complete</div>
                </button>
              );
            })}
          </div>

          {/* Cadet Protection & TLC */}
          {(() => {
            const cadetProtection = getCadetProtectionStatus ? getCadetProtectionStatus(member) : null;
            const cadetProtectionCourses = cadetProtection ? cadetProtection.displayCourses : [];
            const tlcStatus = getTlcStatus ? getTlcStatus(member) : null;
            if (!cadetProtection && !tlcStatus) return null;

            const cpStatusKey = cadetProtection?.indicator?.status || (cadetProtectionCourses.length ? 'current' : 'not-required');
            const cpBorderClassMap = {
              current: 'border-emerald-200',
              'due-soon': 'border-amber-200',
              overdue: 'border-rose-200',
              missing: 'border-rose-200',
              eligible: 'border-blue-200',
              'not-required': 'border-slate-200'
            };
            const cpBorderClass = cpBorderClassMap[cpStatusKey] || 'border-slate-200';

            const tlcTitle = (() => {
              if (!tlcStatus?.course) return 'TLC';
              const suffix = tlcStatus.course.replace(/^TLC\s*-?\s*/i, '');
              return suffix ? `TLC - ${suffix}` : 'TLC';
            })();

            return (
              <div className="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-2 sm:gap-3 items-stretch">
                {cadetProtection && (
                  <div className={`border ${cpBorderClass} rounded-lg p-3 bg-white h-full min-h-[160px] flex flex-col`}>
                    {cadetProtectionCourses.length === 0 ? (
                      <div className="text-sm text-slate-400 italic mt-2">No cadet protection requirement on file</div>
                    ) : (
                      <div className="space-y-3">
                        {cadetProtectionCourses.map((course, idx) => {
                          const courseLabel = (course.label || '').replace(/^Cadet Protection\s*-\s*/i, '');
                          const courseTitle = courseLabel ? `Cadet Protection - ${courseLabel}` : (course.label || 'Cadet Protection');
                          return (
                            <div key={course.id} className={`${idx > 0 ? 'border-t border-slate-100 pt-3' : ''}`}>
                              <div className="flex items-center justify-between font-semibold text-slate-800">
                                <span>{courseTitle}</span>
                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${course.badgeClass}`}>{course.statusLabel}</span>
                              </div>
                              <div className="mt-1 text-xs text-slate-600 space-y-1">
                                <div>Last completion: {course.lastCompleted ? course.lastCompleted.toLocaleDateString() : 'Not completed'}</div>
                                <div>Expiration: {course.expirationDate ? course.expirationDate.toLocaleDateString() : 'N/A'}</div>
                                <div>Days: {course.daysText}</div>
                                {cadetProtection.requiredCourses.length > 0 && (
                                  <div>Required courses: {cadetProtection.summaryLabel}</div>
                                )}
                              </div>
                              {course.note && <div className="text-[11px] text-slate-500 mt-2">{course.note}</div>}
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {tlcStatus && (
                  <div className={`border ${tlcStatus.borderClass} rounded-lg p-3 bg-white h-full min-h-[160px] flex flex-col`}>
                    <div className="flex items-center justify-between">
                      <div className="font-semibold text-slate-800">{tlcTitle}</div>
                      <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${tlcStatus.badgeClass}`}>{tlcStatus.statusLabel}</span>
                    </div>
                    <div className="mt-2 text-xs text-slate-600 space-y-1">
                      <div>Completed: {tlcStatus.completed ? tlcStatus.completed.toLocaleDateString() : 'N/A'}</div>
                      <div>Expiration: {tlcStatus.expirationDate ? tlcStatus.expirationDate.toLocaleDateString() : 'N/A'}</div>
                      <div>Days: {tlcStatus.daysText}</div>
                      <div>Renewal: every 36 months</div>
                    </div>
                  </div>
                )}
              </div>
            );
          })()}

          {/* PME & Leadership Courses */}
          {(() => {
            const capid = String(member.CAPID || '').trim();
            const summary = trainingCourseIndex.get(capid) || { pme: {}, leadership: {}, legacyLeadership: {} };
            const pmeCourses = PME_COURSE_DEFS.map(def => ({
              key: def.key,
              label: def.label,
              completed: summary.pme[def.key]?.raw || null
            }));
            const leadershipCourses = CAP_LEADERSHIP_COURSE_DEFS.map(def => ({
              key: def.key,
              label: def.label,
              completed: summary.leadership[def.key]?.raw || null
            }));
            const legacyLeadershipCourses = LEGACY_LEADERSHIP_COURSE_DEFS.map(def => ({
              key: def.key,
              label: def.label,
              completed: summary.legacyLeadership[def.key]?.raw || null
            })).filter(course => course.completed);
            const completedPme = pmeCourses.filter(course => course.completed);
            const completedLeadership = leadershipCourses.filter(course => course.completed);
            const showPme = completedPme.length > 0;
            const courseBoxBase = 'rounded-lg border p-2';
            const courseBoxActive = 'bg-indigo-50 border-indigo-300 text-indigo-800 ring-1 ring-indigo-200 shadow-sm';
            const courseBoxInactive = 'bg-slate-50 border-slate-200 text-slate-500';

            return (
              <div className={`mt-4 grid grid-cols-1 ${showPme ? 'lg:grid-cols-2' : ''} gap-3`}>
                {showPme && (
                  <div className="border border-slate-200 rounded-lg p-3 bg-white">
                    <div className="flex items-center justify-between">
                      <div className="font-semibold text-slate-800 flex items-center gap-2">
                        <Icon name="BookOpen" className="w-4 h-4 text-slate-600" />
                        Professional Military Education
                      </div>
                      <span className="text-[10px] font-semibold uppercase text-slate-500 bg-slate-100 border border-slate-200 px-2 py-0.5 rounded-full">
                        {completedPme.length} / {pmeCourses.length}
                      </span>
                    </div>
                    <div className="mt-2 flex flex-wrap gap-2">
                      {completedPme.map(course => (
                        <span
                          key={course.key}
                          className="text-[11px] font-semibold px-2 py-1 rounded border border-emerald-200 bg-emerald-50 text-emerald-700"
                          title={`Completed: ${course.completed}`}
                        >
                          {course.label}
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                <div className="border border-slate-200 rounded-lg p-3 bg-white">
                  <div className="flex items-center justify-between">
                    <div className="font-semibold text-slate-800 flex items-center gap-2">
                      <Icon name="Award" className="w-4 h-4 text-slate-600" />
                      Command and Instructor Development
                    </div>
                    <span className="text-[10px] font-semibold uppercase text-slate-500 bg-slate-100 border border-slate-200 px-2 py-0.5 rounded-full">
                      {completedLeadership.length} / {leadershipCourses.length}
                    </span>
                  </div>
                  <div className="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-2">
                    {leadershipCourses.map(course => {
                      const isComplete = !!course.completed;
                      return (
                        <div
                          key={course.key}
                          className={`${courseBoxBase} ${isComplete ? courseBoxActive : courseBoxInactive}`}
                          title={isComplete ? `Completed: ${course.completed}` : 'Not completed'}
                        >
                          <div className="flex items-start justify-between gap-2">
                            <span className="text-[11px] uppercase tracking-wide font-semibold">{course.label}</span>
                            {isComplete && <Icon name="CheckCircle" className="w-4 h-4 text-indigo-600" />}
                          </div>
                          <div className="mt-1 text-[10px] uppercase tracking-wide">
                            {isComplete ? 'Completed' : 'Not completed'}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  {legacyLeadershipCourses.length > 0 && (
                    <div className="mt-3">
                      <div className="text-[10px] font-semibold uppercase tracking-wide text-slate-500">Legacy or Role-Specific</div>
                      <div className="mt-2 flex flex-wrap gap-2">
                        {legacyLeadershipCourses.map(course => (
                          <span
                            key={course.key}
                            className="text-[10px] font-semibold px-2 py-1 rounded border border-slate-200 bg-slate-100 text-slate-600"
                            title={`Completed: ${course.completed}`}
                          >
                            {course.label}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* VOLU Instructor Qualifications */}
                  {(() => {
                    const instructorData = voluInstructorIndex?.get(capid);
                    if (!instructorData || instructorData.courses.size === 0) return null;

                    // Define display order for courses
                    const courseOrder = [
                      'Level 1', 'Level 2 Part 1', 'Level 2 Part 2', 'Level 3', 'Level 4', 'Level 5',
                      'Squadron Commander Training', 'Group Commander Training', 'Region Commander Training'
                    ];

                    // Convert Map to sorted array
                    const sortedCourses = Array.from(instructorData.courses.entries())
                      .sort((a, b) => {
                        const idxA = courseOrder.indexOf(a[0]);
                        const idxB = courseOrder.indexOf(b[0]);
                        if (idxA === -1 && idxB === -1) return a[0].localeCompare(b[0]);
                        if (idxA === -1) return 1;
                        if (idxB === -1) return -1;
                        return idxA - idxB;
                      });

                    return (
                      <div className="mt-3 pt-3 border-t border-slate-100">
                        <div className="flex items-center gap-2 mb-2">
                          <Icon name="GraduationCap" className="w-4 h-4 text-amber-600" />
                          <span className="text-[10px] font-semibold uppercase tracking-wide text-slate-600">
                            VOLU Instructor Qualifications
                          </span>
                          {instructorData.isChair && (
                            <span className="text-[9px] font-bold px-1.5 py-0.5 rounded bg-amber-100 text-amber-700 border border-amber-200">
                              CHAIR
                            </span>
                          )}
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-1.5">
                          {sortedCourses.map(([courseName, modes]) => {
                            const hasOnline = modes.online;
                            const hasFaceToFace = modes.faceToFace;
                            return (
                              <div
                                key={courseName}
                                className="flex items-center justify-between gap-2 px-2 py-1.5 rounded bg-amber-50 border border-amber-200"
                              >
                                <span className="text-[11px] font-medium text-amber-800 truncate">{courseName}</span>
                                <div className="flex items-center gap-1 flex-shrink-0">
                                  {hasFaceToFace && (
                                    <span
                                      className="text-[9px] font-semibold px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 border border-blue-200"
                                      title="Face-to-Face Instructor"
                                    >
                                      F2F
                                    </span>
                                  )}
                                  {hasOnline && (
                                    <span
                                      className="text-[9px] font-semibold px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 border border-purple-200"
                                      title="Online Instructor"
                                    >
                                      OL
                                    </span>
                                  )}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })()}
                </div>
              </div>
            );
          })()}

          {/* Specialty Tracks */}
          <div className="mt-4">
            <h5 className="font-bold text-sm mb-2 flex items-center gap-2 text-slate-700">
              <Icon name="Award" className="w-4 h-4 text-purple-600" />
              Specialty Tracks
            </h5>
            {member.tracks.length > 0 ? (
              member.tracks.map((t, i) => {
                const badgeClass = t.level==='MASTER'?'bg-purple-100 text-purple-700':t.level==='SENIOR'?'bg-blue-100 text-blue-700': t.level==='TECHNICIAN'?'bg-green-100 text-green-700' : 'text-slate-400 font-normal';
                return (
                <div key={i} className="text-sm mb-2 p-2 bg-slate-50 rounded border border-slate-100">
                  <div className="font-medium flex justify-between items-center">
                    <span>{normalizeTrackDisplayName(t.name)}</span>
                    <span className={`text-xs font-bold px-1.5 rounded ${badgeClass}`}>{t.level}</span>
                  </div>
                  <div className="text-xs text-slate-500">Awarded: {t.date}</div>
                </div>
                )
              })
            ) : (
              <div className="text-sm text-slate-400 italic">No specialty tracks</div>
            )}
          </div>
        </div>

        {/* Promotion Eligibility */}
        <div className="border-t pt-4">
          <h4 className="font-bold mb-2 flex items-center gap-2">
            <Icon name="TrendingUp" className="w-4 h-4 text-amber-600" />
            Promotion Eligibility
          </h4>
          {(() => {
            const promoDetails = getPromotionDetails(member);
            if (!promoDetails) {
              return <div className="text-sm text-slate-400 italic">No promotion pathway available for current rank</div>;
            }

            const isEligibleNow = promoDetails.isTigMet && promoDetails.isLevelMet && promoDetails.isDutyMet;

            return (
              <div className="space-y-2">
                <div className="bg-gradient-to-r from-slate-50 to-slate-100 p-3 rounded-lg border border-slate-200">
                  <div className="text-sm font-medium text-slate-600 mb-1">Next Rank</div>
                  <div className="text-lg font-bold text-slate-900">{promoDetails.nextRank}</div>
                  {isEligibleNow ? (
                    <div className="mt-2 inline-flex items-center gap-1.5 text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded">
                      <Icon name="CheckCircle" className="w-3.5 h-3.5" />
                      ELIGIBLE NOW
                    </div>
                  ) : (
                    <div className="mt-2 text-xs text-amber-600 font-medium">
                      Eligible: {promoDetails.eligibleDate}
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-1 gap-2">
                  <div className={`p-2 rounded border text-xs ${promoDetails.isTigMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'}`}>
                    <div className="flex items-center justify-between">
                      <span className="font-medium text-slate-700">Time in Grade</span>
                      {promoDetails.isTigMet ? (
                        <Icon name="CheckCircle" className="w-4 h-4 text-green-600" />
                      ) : (
                        <Icon name="Clock" className="w-4 h-4 text-amber-600" />
                      )}
                    </div>
                    <div className={`mt-1 ${promoDetails.isTigMet ? 'text-green-700' : 'text-amber-700'}`}>
                      {promoDetails.tigMonthsCurrent} / {promoDetails.tigMonthsRequired} months
                    </div>
                  </div>

                  <div className={`p-2 rounded border text-xs ${promoDetails.isLevelMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'}`}>
                    <div className="flex items-center justify-between">
                      <span className="font-medium text-slate-700">Education & Training</span>
                      {promoDetails.isLevelMet ? (
                        <Icon name="CheckCircle" className="w-4 h-4 text-green-600" />
                      ) : (
                        <Icon name="AlertCircle" className="w-4 h-4 text-amber-600" />
                      )}
                    </div>
                    <div className={`mt-1 ${promoDetails.isLevelMet ? 'text-green-700' : 'text-amber-700'}`}>
                      Required: {promoDetails.levelRequired}
                    </div>
                    <div className="text-slate-600 text-[11px]">
                      Current: {promoDetails.levelCurrent}
                    </div>
                  </div>

                  {promoDetails.dutyReq && (
                    <div className={`p-2 rounded border text-xs ${promoDetails.isDutyMet ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200'}`}>
                      <div className="flex items-center justify-between">
                        <span className="font-medium text-slate-700">Duty Requirement</span>
                        {promoDetails.isDutyMet ? (
                          <Icon name="CheckCircle" className="w-4 h-4 text-green-600" />
                        ) : (
                          <Icon name="AlertCircle" className="w-4 h-4 text-amber-600" />
                        )}
                      </div>
                      <div className={`mt-1 ${promoDetails.isDutyMet ? 'text-green-700' : 'text-amber-700'}`}>
                        Required: {promoDetails.dutyReq}
                      </div>
                      <div className="text-slate-600 text-[11px]">
                        {promoDetails.dutyStatusString}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            );
          })()}
        </div>

        {/* Duty Assignments */}
        <div className="border-t pt-4">
          <h4 className="font-bold mb-2 flex items-center gap-2">
            <Icon name="Briefcase" className="w-4 h-4 text-indigo-600" />
            Duty Assignments
          </h4>
          {member.duties.length > 0 ? (
            member.duties.map((d, i) => {
              const isCrossUnit = d.orgString !== member.memberUnitName;
              return (
                <div key={i} className={`text-sm mb-2 p-2 rounded border ${isCrossUnit ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-100'}`}>
                  <div className="font-medium flex items-center gap-2">
                    {d.displayName}
                    {isCrossUnit && (
                      <span className="text-[10px] font-bold text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded">CROSS-UNIT</span>
                    )}
                  </div>
                  <div className={`text-xs mt-1 ${isCrossUnit ? 'text-blue-700 font-medium' : 'text-slate-500'}`}>
                    Unit: {d.orgString} - Assigned: {d.date}
                  </div>
                </div>
              );
            })
          ) : (
            <div className="text-sm text-slate-400 italic">No duty assignments</div>
          )}
        </div>

        {/* Committee Assignments */}
        <div className="border-t pt-4">
          <h4 className="font-bold mb-2 flex items-center gap-2">
            <Icon name="Users" className="w-4 h-4 text-emerald-600" />
            Committee Assignments
          </h4>
          {(() => {
            const memberCommittees = dataFiles.committees ? dataFiles.committees.filter(c => c.CAPID === member.CAPID) : [];
            return memberCommittees.length > 0 ? (
              memberCommittees.map((c, i) => {
                const position = (c.Position || c.Role || c.Title || 'Member').trim();
                const isChair = c.Chair === "1" || position.toUpperCase().includes('CHAIR');
                return (
                  <div key={i} className={`text-sm mb-2 p-2 rounded border ${isChair ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 border-slate-100'}`}>
                    <div className="font-medium flex items-center gap-2">
                      {c.Committee}
                      {isChair && (
                        <span className="text-[10px] font-bold text-emerald-700 bg-emerald-100 px-1.5 py-0.5 rounded">CHAIR</span>
                      )}
                    </div>
                    <div className={`text-xs mt-1 ${isChair ? 'text-emerald-700 font-medium' : 'text-slate-500'}`}>
                      Position: {position}
                    </div>
                  </div>
                );
              })
            ) : (
              <div className="text-sm text-slate-400 italic">No committee assignments</div>
            );
          })()}
        </div>

        {/* Emergency Services Qualifications - Using shared component */}
        <div className="border-t pt-4">
          <ESQualificationsSection
            qualifications={member.esQualificationsAll || []}
            onQualificationClick={setSelectedESQualification}
            onViewSkillTree={() => setShowESTreeModal(true)}
            showSkillTreeButton={true}
            showSkillsEvaluator={true}
            ES_FUNCTIONAL_AREAS={ES_FUNCTIONAL_AREAS}
          />
        </div>
      </div>
    </Modal>
  );
};
</script>

<script type="text/babel">
// Cadet Profile Modal
// Comprehensive view of cadet's rank, requirements, phase progress, and ES quals
const CadetProfileModal = ({
  isOpen,
  onClose,
  cadet,
  // Helper functions
  getRankInsigniaUrl,
  getAchievementDisplayName,
  getCadetProtectionStatus,
  // Data
  dataFiles,
  configFiles,
  cadetDataService,
  esDataService,
  // Constants
  CADET_ACHIEVEMENT_TO_RANK,
  ES_FUNCTIONAL_AREAS
}) => {
  if (!isOpen || !cadet) return null;

  // State for ES modals
  const [selectedQualification, setSelectedQualification] = React.useState(null);
  const [showSkillTree, setShowSkillTree] = React.useState(false);

  // Handlers for ES qualifications
  const handleQualificationClick = (qualification) => {
    setSelectedQualification(qualification);
  };

  const handleViewSkillTree = () => {
    setShowSkillTree(true);
  };

  const handleCloseQualificationModal = () => {
    setSelectedQualification(null);
  };

  const handleCloseSkillTreeModal = () => {
    setShowSkillTree(false);
  };

  // Helper function to get duty position rank for sorting (command positions first)
  const CADET_DUTY_RANK = {
    'CADET COMMANDER': 1,
    'CADET DEPUTY COMMANDER FOR OPERATIONS': 2,
    'CADET DEPUTY COMMANDER FOR SUPPORT': 3,
    'CADET FIRST SERGEANT': 4,
    'CADET FLIGHT COMMANDER': 5,
    'CADET FLIGHT SERGEANT': 6,
    'CADET ADMINISTRATIVE OFFICER': 10,
    'CADET PUBLIC AFFAIRS OFFICER': 11,
    'CADET COMMUNICATIONS OFFICER': 12,
    'CADET SUPPLY OFFICER': 13,
    'CADET SAFETY OFFICER': 14,
    'CADET ELEMENT LEADER': 20
  };

  const getDutyRank = (dutyName) => {
    const normalizedDuty = (dutyName || '').toUpperCase().trim();
    return CADET_DUTY_RANK[normalizedDuty] || 99;
  };

  const nextRank = cadet.nextAchievement ? CADET_ACHIEVEMENT_TO_RANK[cadet.nextAchievement.toString()] : null;
  const cadetMember = dataFiles.members.find(m => m.CAPID === cadet.CAPID);
  const cadetAge = cadetMember && cadetMember.DOB ? Math.floor((new Date() - new Date(cadetMember.DOB)) / (1000 * 60 * 60 * 24 * 365.25)) : null;
  const isUnder18 = cadetAge !== null && cadetAge < 18;
  const cadetProtection = getCadetProtectionStatus ? getCadetProtectionStatus(cadetMember || cadet) : null;
  const cadetProtectionCourses = cadetProtection ? cadetProtection.displayCourses : [];

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={`${cadet.NameLast}, ${cadet.NameFirst}`}>
      <div className="space-y-6">
        {/* Header with Current and Next Rank */}
        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-100 shadow-sm">
          <div className="flex justify-between items-center mb-4">
            <div className="flex-1">
              <div className="text-xs uppercase text-blue-600 font-bold tracking-wider mb-2">Current Rank</div>
              <div className="flex items-center gap-3">
                {getRankInsigniaUrl(cadet.currentAchievement) && (
                  <img src={getRankInsigniaUrl(cadet.currentAchievement)} alt={cadet.currentRank} className="h-16 w-auto object-contain" />
                )}
                <div>
                  <div className="text-2xl font-bold text-slate-800">{cadet.currentRank}</div>
                  <div className="text-sm text-slate-600">{getAchievementDisplayName(cadet.currentAchievement)}</div>
                  {cadet.rankDate && cadet.rankDate !== '01/01/1900' && (
                    <div className="text-xs text-slate-500 mt-1">Date of Rank: {cadet.rankDate}</div>
                  )}
                </div>
              </div>
            </div>
            {cadet.nextAchievement && nextRank && (
              <div className="flex-1 text-right">
                <div className="text-xs uppercase text-indigo-600 font-bold tracking-wider mb-2">Next Rank</div>
                <div className="flex items-center gap-3 justify-end">
                  <div className="text-right">
                    <div className="text-2xl font-bold text-slate-800">{nextRank}</div>
                    <div className="text-sm text-slate-600">{getAchievementDisplayName(cadet.nextAchievement)}</div>
                    <div className={`text-xs font-bold mt-1 px-2 py-0.5 rounded-full inline-block ${
                      cadet.promotionStatus.status === 'READY' ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-600'
                    }`}>
                      {cadet.promotionStatus.status === 'READY' ? 'READY' : cadet.nextRequirements ? `${cadet.nextRequirements.completionPercent}% Complete` : 'In Progress'}
                    </div>
                  </div>
                  {getRankInsigniaUrl(cadet.nextAchievement) && (
                    <img src={getRankInsigniaUrl(cadet.nextAchievement)} alt={nextRank} className="h-16 w-auto object-contain" />
                  )}
                </div>
              </div>
            )}
          </div>

          {/* Cadet Info */}
          <div className="border-t border-blue-200 pt-3 mt-3">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div>
                <div className="text-xs text-slate-500 font-bold">CAPID</div>
                <div className="text-slate-700">{cadet.CAPID}</div>
              </div>
              <div>
                <div className="text-xs text-slate-500 font-bold">Phase</div>
                <div className="text-slate-700">Phase {cadet.phase}</div>
              </div>
              <div>
                <div className="text-xs text-slate-500 font-bold">Time in Grade</div>
                <div className="text-slate-700">{cadet.timeInGrade.weeks}w {cadet.timeInGrade.days % 7}d ({cadet.timeInGrade.days} days)</div>
              </div>
              <div>
                <div className="text-xs text-slate-500 font-bold">Promotion Eligible</div>
                <div className={`font-semibold ${cadet.timeInGrade.isEligible ? 'text-green-600' : 'text-slate-700'}`}>
                  {cadet.timeInGrade.eligibleDate || 'N/A'}
                  {cadet.timeInGrade.isEligible && ' âœ“'}
                </div>
              </div>
            </div>
            {/* Contact Information and Age */}
            {(cadetAge !== null || (dataFiles.contacts && dataFiles.contacts.length > 0)) && (() => {
              // Get cadet's primary email
              const cadetContacts = dataFiles.contacts ? dataFiles.contacts.filter(c => String(c.CAPID).trim() === String(cadet.CAPID).trim()) : [];
              const cadetPrimaryEmail = cadetContacts.find(c =>
                (c.Type || '').toUpperCase() === 'EMAIL' &&
                (c.Priority || '').toUpperCase() === 'PRIMARY'
              );
              const cadetEmail = cadetPrimaryEmail ? cadetPrimaryEmail.Contact : null;

              // Get parent/guardian email for cadets under 18
              let parentEmail = null;
              if (isUnder18) {
                const parentEmailContact = cadetContacts.find(c =>
                  (c.Type || '').toUpperCase() === 'CADET PARENT EMAIL' &&
                  (c.Priority || '').toUpperCase() === 'PRIMARY'
                );
                parentEmail = parentEmailContact ? parentEmailContact.Contact : null;
                // Don't show parent email if it's the same as cadet email
                if (parentEmail === cadetEmail) {
                  parentEmail = null;
                }
              }

              if (cadetEmail || parentEmail || cadetAge !== null) {
                return (
                  <div className="mt-3 pt-3 border-t border-blue-200">
                    <div className="grid grid-cols-2 gap-6">
                      {/* Left side - Contact Information */}
                      <div>
                        {cadetEmail && (
                          <div className="mb-2">
                            <div className="text-xs text-slate-500 font-bold mb-0.5">Cadet Email</div>
                            <a href={`mailto:${cadetEmail}`} className="text-sm text-blue-600 hover:text-blue-800 hover:underline">
                              {cadetEmail}
                            </a>
                          </div>
                        )}
                        {parentEmail && (
                          <div>
                            <div className="text-xs text-slate-500 font-bold mb-0.5">Parent/Guardian Email</div>
                            <a href={`mailto:${parentEmail}`} className="text-sm text-blue-600 hover:text-blue-800 hover:underline">
                              {parentEmail}
                            </a>
                          </div>
                        )}
                      </div>
                      {/* Right side - Age */}
                      {cadetAge !== null && (
                        <div className="text-right">
                          <div className="text-xs text-slate-500 font-bold mb-1">Age</div>
                          <div className="text-2xl font-bold text-slate-800">{cadetAge} years</div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              }
              return null;
            })()}
          </div>
        </div>

        {/* Cadet Protection Training */}
        {cadetProtection && cadetProtectionCourses.length > 0 && (
          <div>
            <h3 className="font-bold text-slate-900 mb-3 flex items-center gap-2">
              <Icon name="Shield" className="w-4 h-4 text-emerald-600" />
              Cadet Protection Training
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {cadetProtectionCourses.map(course => (
                <div key={course.id} className={`border ${course.borderClass} rounded-lg p-3 bg-white`}>
                  <div className="flex items-center justify-between">
                    <div className="font-semibold text-slate-800">{course.label}</div>
                    <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${course.badgeClass}`}>{course.statusLabel}</span>
                  </div>
                  <div className="mt-2 text-xs text-slate-600 space-y-1">
                    <div>Last completion: {course.lastCompleted ? course.lastCompleted.toLocaleDateString() : 'Not completed'}</div>
                    <div>Expiration: {course.expirationDate ? course.expirationDate.toLocaleDateString() : 'N/A'}</div>
                    <div>Days: {course.daysText}</div>
                  </div>
                  {course.note && <div className="text-[11px] text-slate-500 mt-2">{course.note}</div>}
                </div>
              ))}
            </div>
            {cadetProtection.requiredCourses.length > 0 && (
              <div className="text-xs text-slate-500 mt-2">Required courses: {cadetProtection.summaryLabel}</div>
            )}
          </div>
        )}

        {/* Duty Positions */}
        {cadet.cadetDuties && cadet.cadetDuties.length > 0 && (() => {
          // Sort duty positions with command positions first (using same logic as card)
          const sortedDuties = [...cadet.cadetDuties].sort((a, b) => {
            const rankA = getDutyRank(a.name);
            const rankB = getDutyRank(b.name);
            return rankA - rankB;
          });

          return (
            <div>
              <h3 className="font-bold text-slate-900 mb-3">Duty Positions</h3>
              <div className="flex flex-wrap gap-2">
                {sortedDuties.map((duty, idx) => (
                  <Badge
                    key={idx}
                    color="gray"
                    title={`Assigned: ${duty.date || 'Unknown'}`}
                  >
                    {duty.name} ({duty.orgString || 'Unknown'})
                  </Badge>
                ))}
              </div>
            </div>
          );
        })()}

        {/* Next Achievement Requirements */}
        {cadet.nextRequirements && (
          <div>
            <h3 className="font-bold text-slate-900 mb-3">Next Achievement Requirements</h3>
            <RequirementsChecklist requirements={cadet.nextRequirements} />
          </div>
        )}

        {/* Honor Credit Opportunity */}
        {cadet.nextHonorCreditStatus && !cadet.nextHonorCreditStatus.earned && !String(cadet.nextHonorCreditStatus.reason || '').startsWith('N/A') && (
          <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div className="flex items-center gap-2 mb-2">
              <svg className="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7-6.3-4.6-6.3 4.6 2.3-7-6-4.6h7.6z"/>
              </svg>
              <h4 className="font-bold text-amber-900">Honor Credit Opportunity</h4>
            </div>
            <p className="text-sm text-amber-800 mb-3">
              Complete BOTH interactive modules AND written tests for your next achievement to earn a silver star on your achievement ribbon!
            </p>
            <div className="grid grid-cols-2 gap-2 text-xs">
              <div className={`flex items-center gap-1 ${cadet.nextHonorCreditStatus.details.leadershipModule ? 'text-green-700 font-semibold' : 'text-slate-600'}`}>
                {cadet.nextHonorCreditStatus.details.leadershipModule ? 'âœ“' : 'â—‹'} Leadership Module
              </div>
              <div className={`flex items-center gap-1 ${cadet.nextHonorCreditStatus.details.aerospaceModule ? 'text-green-700 font-semibold' : 'text-slate-600'}`}>
                {cadet.nextHonorCreditStatus.details.aerospaceModule ? 'âœ“' : 'â—‹'} Aerospace Module
              </div>
              <div className={`flex items-center gap-1 ${cadet.nextHonorCreditStatus.details.leadershipTest ? 'text-green-700 font-semibold' : 'text-slate-600'}`}>
                {cadet.nextHonorCreditStatus.details.leadershipTest ? 'âœ“' : 'â—‹'} Leadership Test (80%+)
              </div>
              <div className={`flex items-center gap-1 ${cadet.nextHonorCreditStatus.details.aerospaceTest ? 'text-green-700 font-semibold' : 'text-slate-600'}`}>
                {cadet.nextHonorCreditStatus.details.aerospaceTest ? 'âœ“' : 'â—‹'} Aerospace Test (80%+)
              </div>
            </div>
          </div>
        )}

        {/* Phase Progress */}
        <div>
          <h3 className="font-bold text-slate-900 mb-3">Phase Progression</h3>
          <PhaseProgressTimeline
            currentAchievement={cadet.currentAchievement}
            approvedAchievements={cadet.approvedAchievements}
            honorCreditAchievements={cadet.honorCreditAchievements || []}
            cadet={cadet}
            cadetDataService={cadetDataService}
            dataFiles={dataFiles}
          />
        </div>

        {/* Milestone Awards */}
        <div>
          <h3 className="font-bold text-slate-900 mb-3">Milestone Awards</h3>
          <MilestoneAwardsCard
            milestoneAwards={cadet.milestoneAwards}
            currentAchievement={cadet.currentAchievement}
          />
        </div>

        {/* Orientation Flights */}
        <div>
          <h3 className="font-bold text-slate-900 mb-3 flex items-center gap-2">
            <Icon name="Plane" className="w-4 h-4 text-sky-600" />
            Orientation Flights
          </h3>
          <OrientationFlightsCard
            oFlights={dataFiles.oFlights || []}
            capid={cadet.CAPID}
          />
        </div>

        {/* Emergency Services Qualifications - Using shared component */}
        <div>
          <ESQualificationsSection
            qualifications={cadet.esQualifications || []}
            onQualificationClick={handleQualificationClick}
            onViewSkillTree={handleViewSkillTree}
            showSkillTreeButton={true}
            showSkillsEvaluator={true}
            ES_FUNCTIONAL_AREAS={ES_FUNCTIONAL_AREAS}
            headerClassName="font-bold text-slate-900 mb-3 flex items-center justify-between"
          />
        </div>
      </div>

      {/* ES Qualification Detail Modal */}
      {selectedQualification && esDataService && (
        <ESQualificationDetailModal
          isOpen={!!selectedQualification}
          onClose={handleCloseQualificationModal}
          qualification={selectedQualification}
          member={cadet}
          dataService={esDataService}
        />
      )}

      {/* ES Skill Tree Modal */}
      {esDataService && configFiles && configFiles.esAchievements && (
        <ESQualificationTreeModal
          isOpen={showSkillTree}
          onClose={handleCloseSkillTreeModal}
          member={cadet}
          dataService={esDataService}
          allQualifications={configFiles.esAchievements}
        />
      )}
    </Modal>
  );
};
</script>

<script type="text/babel">
// Drill Down Position Modal
// Shows all members holding a specific duty position across all sub-units
const DrillDownPositionModal = ({
  isOpen,
  onClose,
  position,
  // Helper functions
  getDescendantOrgIds,
  buildMemberProfileData,
  // Data
  unitFilter,
  dataFiles,
  processedData,
  // State setters
  setSelectedMemberProfile,
  setDrillDownPosition
}) => {
  if (!isOpen || !position) return null;

  const validOrgIds = getDescendantOrgIds(unitFilter);
  const allDuties = dataFiles.duty.filter(d => validOrgIds.includes(d.ORGID));
  const allCadetDuties = dataFiles.cadetDuty ? dataFiles.cadetDuty.filter(d => validOrgIds.includes(d.ORGID)) : [];

  // Find all members with this duty position across all descendant units
  const positionTitle = position.title.toUpperCase();
  const isCadet = position.type === 'cadet';
  const dataSource = isCadet ? allCadetDuties : allDuties;

  const holdersWithUnits = dataSource
    .filter(d => d.Duty.toUpperCase().includes(positionTitle) || positionTitle.includes(d.Duty.toUpperCase()))
    .map(d => {
      const member = dataFiles.members.find(m => m.CAPID === d.CAPID);
      if (!member) return null;
      const org = dataFiles.organization.find(o => o.ORGID === d.ORGID);
      const orgString = org ? `${org.Region}-${org.Wing}-${org.Unit} ${org.Name}` : "Unknown Unit";
      return {
        ...member,
        dutyDate: d.DateMod,
        isAsst: d.Asst === "1",
        orgString,
        orgId: d.ORGID
      };
    })
    .filter(Boolean);

  // Group by unit
  const byUnit = {};
  holdersWithUnits.forEach(h => {
    if (!byUnit[h.orgString]) byUnit[h.orgString] = [];
    byUnit[h.orgString].push(h);
  });

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={`${position.title} - All Sub-Units`}>
      <div className="space-y-4">
        <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
          <p className="text-sm text-blue-900">
            <strong>Showing all members holding "{position.title}" across {Object.keys(byUnit).length} unit(s)</strong>
          </p>
          <p className="text-xs text-blue-700 mt-1">Total: {holdersWithUnits.length} member(s)</p>
        </div>

        {Object.keys(byUnit).length === 0 ? (
          <div className="text-center py-8 text-slate-400">
            <Icon name="Users" className="w-16 h-16 mx-auto mb-3 opacity-20" />
            <p className="font-medium">No members found in this position across subordinate units</p>
          </div>
        ) : (
          <div className="space-y-3">
            {Object.entries(byUnit).sort((a, b) => a[0].localeCompare(b[0])).map(([unit, members]) => (
              <div key={unit} className="border border-slate-200 rounded-lg overflow-hidden">
                <div className="bg-slate-100 px-4 py-2 font-bold text-sm text-slate-800 border-b border-slate-200">
                  {unit}
                </div>
                <div className="p-3 space-y-2">
                  {members.map((m, idx) => (
                    <div
                      key={idx}
                      className="flex items-center justify-between p-2 bg-white border border-slate-100 rounded hover:bg-blue-50 cursor-pointer transition-colors"
                      onClick={() => {
                        const foundMember = processedData.find(pm => pm.CAPID === m.CAPID);
                        const fallbackMember = buildMemberProfileData(dataFiles.members.find(mem => mem.CAPID === m.CAPID));
                        const finalMember = foundMember || fallbackMember;
                        if (finalMember) {
                          setSelectedMemberProfile(finalMember);
                          setDrillDownPosition(null);
                        }
                      }}
                    >
                      <div>
                        <div className="font-medium text-sm text-slate-800">
                          {m.Rank} {m.NameLast}, {m.NameFirst}
                          {m.isAsst && <span className="text-xs text-amber-600 ml-2">(Assistant)</span>}
                        </div>
                        <div className="text-xs text-slate-500 mt-0.5">
                          CAPID: {m.CAPID} - Assigned: {m.dutyDate}
                        </div>
                      </div>
                      <Icon name="ChevronRight" className="w-4 h-4 text-slate-400" />
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </Modal>
  );
};
</script>

<script type="text/babel">
// Recursive prerequisite tree component
// Displays the hierarchical structure of prerequisite qualifications
const PrereqTreeView = ({ node, memberQuals, member, dataService, depth, showSelf = true }) => {
  if (!node) return null;

  // Check if prerequisite is completed
  let hasPrereq = false;
  let displayName = node.name;

  // Special handling for Achievement 1 (Curry - ID '95') vs Level 1 (ID '96')
  // Seniors need Level 1, Cadets need Achievement 1
  const memberType = String(member?.Type || member?.TYPE || '').toUpperCase();
  const isCadet = memberType === 'CADET';
  const isSenior = !isCadet;

  if (node.achvID === '95' || node.achvID === '96') {
    // '95' = Achievement 1 (Curry) for cadets
    // '96' = Level 1 for seniors

    if (isSenior) {
      // For senior members, check Level 1 completion and display "Level 1"
      hasPrereq = member?.levelsProgress?.L1?.status === 'completed';
      displayName = 'Level 1';
    } else {
      // For cadets, check Achievement 1 and display "Achievement 1 (Curry)"
      if (dataService) {
        const rawData = dataService.rawData();
        hasPrereq = (rawData.esMbrAchievements || []).some(a =>
          a.CAPID === member?.CAPID &&
          a.AchvID === '95' &&
          String(a.Status || '').toUpperCase() === 'ACTIVE'
        );
      } else {
        hasPrereq = memberQuals?.some(q =>
          q.achvID === '95' && q.status === 'Active'
        );
      }
      displayName = 'Achievement 1 (Curry)';
    }
  } else {
    // Regular ES qualification check - use raw data from dataService if available
    // This ensures IS courses and other filtered achievements are still checked
    if (dataService) {
      const rawData = dataService.rawData();
      hasPrereq = (rawData.esMbrAchievements || []).some(a =>
        a.CAPID === member?.CAPID &&
        a.AchvID === node.achvID &&
        String(a.Status || '').toUpperCase() === 'ACTIVE'
      );
    } else {
      // Fallback to filtered qualifications if no dataService
      hasPrereq = memberQuals?.some(q =>
        q.achvID === node.achvID && q.status === 'Active'
      );
    }
  }

  const indentClass = depth > 0 ? 'ml-4 pl-3 border-l-2 border-slate-200' : '';

  // If showSelf is false, only render the prerequisites (skip the root node itself)
  if (!showSelf && depth === 0) {
    // Filter out duplicate Achievement 1/Level 1 entries (IDs '95' and '96' are equivalent)
    let filteredPrereqs = node.prerequisites || [];
    const hasAchv95 = filteredPrereqs.some(p => p.achvID === '95');
    const hasAchv96 = filteredPrereqs.some(p => p.achvID === '96');

    if (hasAchv95 && hasAchv96) {
      // Remove '96' (Level 1) and keep '95' (Achievement 1) - the display logic will handle member type
      filteredPrereqs = filteredPrereqs.filter(p => p.achvID !== '96');
    }

    return (
      <div>
        {filteredPrereqs.length > 0 ? (
          filteredPrereqs.map((prereq, idx) => (
            <PrereqTreeView
              key={idx}
              node={prereq}
              memberQuals={memberQuals}
              member={member}
              dataService={dataService}
              depth={0}
              showSelf={true}
            />
          ))
        ) : (
          <div className="text-sm text-slate-500 italic">
            No prerequisite qualifications required
          </div>
        )}
      </div>
    );
  }

  return (
    <div className={indentClass}>
      <div className={`flex items-start gap-2 py-1 ${depth > 0 ? 'text-xs' : 'text-sm'}`}>
        <div className="mt-0.5">
          {hasPrereq ? (
            <Icon name="CheckCircle2" className="w-4 h-4 text-emerald-600" />
          ) : (
            <Icon name="Circle" className="w-4 h-4 text-slate-300" />
          )}
        </div>
        <span className={hasPrereq ? 'text-emerald-700 font-medium' : 'text-slate-600'}>
          {displayName}
        </span>
      </div>

      {node.prerequisites && node.prerequisites.length > 0 && (() => {
        // Filter out duplicate Achievement 1/Level 1 entries (IDs '95' and '96' are equivalent)
        let filteredPrereqs = node.prerequisites;
        const hasAchv95 = filteredPrereqs.some(p => p.achvID === '95');
        const hasAchv96 = filteredPrereqs.some(p => p.achvID === '96');

        if (hasAchv95 && hasAchv96) {
          // Remove '96' (Level 1) and keep '95' (Achievement 1) - the display logic will handle member type
          filteredPrereqs = filteredPrereqs.filter(p => p.achvID !== '96');
        }

        return (
          <div className="mt-1">
            {filteredPrereqs.map((prereq, idx) => (
              <PrereqTreeView
                key={idx}
                node={prereq}
                memberQuals={memberQuals}
                member={member}
                dataService={dataService}
                depth={depth + 1}
                showSelf={true}
              />
            ))}
          </div>
        );
      })()}
    </div>
  );
};

// ES Qualification Detail Modal
// Shows detailed information about a specific qualification including tasks grouped by step/phase
const ESQualificationDetailModal = ({ isOpen, onClose, qualification, member, dataService }) => {
  if (!isOpen || !qualification) return null;

  const [tasksByStep, setTasksByStep] = React.useState([]);
  const [eligibilityInfo, setEligibilityInfo] = React.useState(null);
  const [prereqTree, setPrereqTree] = React.useState(null);

  React.useEffect(() => {
    if (qualification && member && dataService) {
      const tasks = dataService.getESAchievementTasks(qualification.achvID, member.CAPID);
      setTasksByStep(tasks);

      // Get eligibility information including prerequisites
      const eligibility = dataService.checkESQualificationEligibility(qualification.achvID, member);
      setEligibilityInfo(eligibility);

      // ALWAYS build the prerequisite tree directly, regardless of eligibility
      // This ensures we show the full tree even when special prerequisites (age, tasks) are not met
      const tree = dataService.buildESPrerequisiteTree(qualification.achvID);
      setPrereqTree(tree);
    }
  }, [qualification, member]);

  // Calculate completion stats
  const totalTasks = tasksByStep.reduce((sum, step) => sum + step.tasks.length, 0);
  const completedTasks = tasksByStep.reduce((sum, step) =>
    sum + step.tasks.filter(t => t.completed).length, 0);
  const completionPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

  // Status color
  const statusColors = {
    'Active': 'text-emerald-700 bg-emerald-50 border border-emerald-200',
    'Training': 'text-amber-700 bg-amber-50 border border-amber-200',
    'Expired': 'text-rose-700 bg-rose-50 border border-rose-200',
    'Not Approved': 'text-slate-700 bg-slate-50 border border-slate-200'
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={qualification.name} maxWidthClass="max-w-4xl">
      {/* Header Info */}
      <div className="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <div className="text-xs font-bold text-slate-500 uppercase mb-1">Status</div>
            <div className={`text-sm font-semibold px-3 py-1 rounded inline-block ${statusColors[qualification.status]}`}>
              {qualification.status}
            </div>
          </div>

          <div>
            <div className="text-xs font-bold text-slate-500 uppercase mb-1">Completed</div>
            <div className="text-sm text-slate-800">
              {qualification.completed && qualification.completed !== '01/01/1900'
                ? qualification.completed
                : 'N/A'}
            </div>
          </div>

          <div>
            <div className="text-xs font-bold text-slate-500 uppercase mb-1">Expiration</div>
            <div className="text-sm text-slate-800">
              {qualification.expiration && qualification.expiration !== '01/01/1900'
                ? qualification.expiration
                : 'None'}
            </div>
          </div>

          <div>
            <div className="text-xs font-bold text-slate-500 uppercase mb-1">Completion</div>
            <div className="text-sm font-semibold text-slate-800">
              {completedTasks} / {totalTasks} ({completionPercent}%)
            </div>
          </div>
        </div>

        {qualification.isSkillsEvaluator && (
          <div className="mt-3 pt-3 border-t border-slate-200">
            <div className="flex items-center gap-2 text-amber-700">
              <Icon name="Star" className="w-4 h-4 fill-current" />
              <span className="text-sm font-semibold">Skills Evaluator Qualified</span>
            </div>
            <div className="text-xs text-slate-600 mt-1">
              Held for 1+ year with active SET achievement
              {qualification.achvID === '217' && (
                <span className="block mt-1 text-blue-700 font-medium">
                  + Communications staff position required for ICUT
                </span>
              )}
            </div>
          </div>
        )}
      </div>

      {/* Age Requirement (if applicable) */}
      {(() => {
        const requiredAge = ES_AGE_REQUIREMENTS[qualification.achvID];
        if (!requiredAge) return null;

        const memberAge = member?.DOB ? Math.floor((new Date() - new Date(member.DOB)) / (1000 * 60 * 60 * 24 * 365.25)) : null;
        const meetsAge = memberAge !== null && memberAge >= requiredAge;

        return (
          <div className="mb-6">
            <h3 className="text-lg font-bold text-slate-800 mb-3">Age Requirement</h3>
            <div className={`border rounded-lg p-4 ${meetsAge ? 'bg-emerald-50 border-emerald-200' : 'bg-amber-50 border-amber-200'}`}>
              <div className="flex items-center gap-2">
                {meetsAge ? (
                  <Icon name="CheckCircle2" className="w-5 h-5 text-emerald-600" />
                ) : (
                  <Icon name="AlertCircle" className="w-5 h-5 text-amber-600" />
                )}
                <div>
                  <div className={`text-sm font-semibold ${meetsAge ? 'text-emerald-700' : 'text-amber-700'}`}>
                    Minimum Age: {requiredAge} years
                  </div>
                  {memberAge !== null && (
                    <div className="text-xs text-slate-600 mt-1">
                      {meetsAge
                        ? `Member meets requirement (${memberAge} years old)`
                        : `Member does not meet requirement (${memberAge} years old)`
                      }
                    </div>
                  )}
                  {memberAge === null && (
                    <div className="text-xs text-slate-600 mt-1">
                      Date of birth required for verification
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      })()}

      {/* Prerequisites Section - ALWAYS SHOW if there are ANY prerequisites */}
      {(() => {
        // Check if there are achievement prerequisites
        const hasAchievementPrereqs = prereqTree?.prerequisites?.length > 0;

        // Check if there are special prerequisites (tasks, age, etc.)
        const hasSpecialPrereqs = eligibilityInfo?.reasons && eligibilityInfo.reasons.length > 0;

        // Only show section if there are either achievement or special prerequisites
        if (!hasAchievementPrereqs && !hasSpecialPrereqs) return null;

        return (
          <div className="mb-6">
            <h3 className="text-lg font-bold text-slate-800 mb-3">Prerequisites</h3>
            <div className="border border-slate-200 rounded-lg p-4 bg-slate-50">

              {/* Achievement Prerequisites Tree */}
              {hasAchievementPrereqs && (
                <div>
                  <div className="text-sm font-semibold text-slate-700 mb-2">Prerequisite Qualifications</div>
                  <PrereqTreeView
                    node={prereqTree}
                    memberQuals={member.esQualificationsAll || member.esQualifications}
                    member={member}
                    dataService={dataService}
                    depth={0}
                    showSelf={false}
                  />
                </div>
              )}

              {/* Special Prerequisites (Tasks, etc.) from eligibility check */}
              {hasSpecialPrereqs && (
                <div className={hasAchievementPrereqs ? "mt-3 pt-3 border-t border-slate-300" : ""}>
                  <div className="text-sm font-semibold text-slate-700 mb-2">Additional Requirements</div>
                  <div className="space-y-2">
                    {eligibilityInfo.reasons.map((reason, idx) => (
                      <div key={idx} className="flex items-start gap-2 text-sm">
                        <Icon name="AlertCircle" className="w-4 h-4 text-rose-600 mt-0.5 flex-shrink-0" />
                        <span className="text-rose-700">{reason}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* All prerequisites met message */}
              {eligibilityInfo?.eligible && (hasAchievementPrereqs || hasSpecialPrereqs) && (
                <div className="mt-3 pt-3 border-t border-slate-300">
                  <div className="flex items-center gap-2 text-emerald-700">
                    <Icon name="CheckCircle2" className="w-5 h-5" />
                    <span className="text-sm font-semibold">All prerequisites are met</span>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      })()}

      {/* Tasks by Step/Phase */}
      <div className="space-y-4">
        <h3 className="text-lg font-bold text-slate-800 mb-3">
          {tasksByStep.length === 0 ? 'Requirements' : 'Task Requirements by Category'}
        </h3>

        {tasksByStep.length === 0 && (
          <div className="text-sm text-slate-500 italic text-center py-8 border border-slate-200 rounded-lg bg-slate-50">
            <p>No specific tasks are required for this qualification.</p>
            <p className="mt-2 text-xs">Check the prerequisite qualifications above to see what must be completed first.</p>
          </div>
        )}

        {tasksByStep.map((step, idx) => {
          const stepCompleted = step.tasks.filter(t => t.completed).length;
          const stepTotal = step.tasks.length;
          const stepPercent = Math.round((stepCompleted / stepTotal) * 100);

          return (
            <div key={idx} className="border border-slate-200 rounded-lg overflow-hidden">
              {/* Step Header */}
              <div className="bg-slate-100 px-4 py-2 border-b border-slate-200">
                <div className="flex justify-between items-center">
                  <h4 className="font-semibold text-slate-800">{step.stepName}</h4>
                  <span className="text-xs text-slate-600">
                    {stepCompleted} / {stepTotal} tasks ({stepPercent}%)
                  </span>
                </div>
              </div>

              {/* Tasks */}
              <div className="divide-y divide-slate-100">
                {step.tasks.map((task, taskIdx) => (
                  <div
                    key={taskIdx}
                    className={`px-4 py-3 flex items-start gap-3 ${
                      task.completed ? 'bg-emerald-50/50' : 'bg-white'
                    }`}
                  >
                    {/* Checkbox */}
                    <div className="mt-0.5">
                      {task.completed ? (
                        <CheckCircleFilled />
                      ) : (
                        <CircleEmpty />
                      )}
                    </div>

                    {/* Task Details */}
                    <div className="flex-1 min-w-0">
                      <div className="font-medium text-sm text-slate-800">
                        {task.taskName}
                      </div>
                      {task.functionalArea && (
                        <div className="text-xs text-slate-500 mt-0.5">
                          {ES_FUNCTIONAL_AREAS[task.functionalArea] || task.functionalArea}
                        </div>
                      )}
                      {task.completed && (
                        <div className="text-xs text-emerald-700 mt-1 flex items-center gap-2">
                          <span>Completed: {task.completedDate}</span>
                          {task.expiration && task.expiration !== '01/01/1900' && (
                            <span className="text-amber-600">
                              Expires: {task.expiration}
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );
        })}
      </div>

      {/* Metadata Footer */}
      {(qualification.originallyAccomplished || qualification.source) && (
        <div className="mt-6 pt-4 border-t border-slate-200 text-xs text-slate-500">
          <div className="grid grid-cols-2 gap-2">
            {qualification.originallyAccomplished && (
              <div>
                <span className="font-semibold">Originally Accomplished:</span> {qualification.originallyAccomplished}
              </div>
            )}
            {qualification.source && (
              <div>
                <span className="font-semibold">Source:</span> {qualification.source}
              </div>
            )}
          </div>
        </div>
      )}
    </Modal>
  );
};
</script>

<script type="text/babel">
// Recursive prerequisite tree component (shared with ModalESQualification)
// Displays the hierarchical structure of prerequisite qualifications
const PrereqTreeView = ({ node, memberQuals, member, dataService, depth, showSelf = true }) => {
  if (!node) return null;

  // Check if prerequisite is completed
  let hasPrereq = false;
  let displayName = node.name;

  // Special handling for Achievement 1 (Curry - ID '95') vs Level 1 (ID '96')
  // Seniors need Level 1, Cadets need Achievement 1
  const memberType = String(member?.Type || member?.TYPE || '').toUpperCase();
  const isCadet = memberType === 'CADET';
  const isSenior = !isCadet;

  if (node.achvID === '95' || node.achvID === '96') {
    // '95' = Achievement 1 (Curry) for cadets
    // '96' = Level 1 for seniors

    if (isSenior) {
      // For senior members, check Level 1 completion and display "Level 1"
      hasPrereq = member?.levelsProgress?.L1?.status === 'completed';
      displayName = 'Level 1';
    } else {
      // For cadets, check Achievement 1 and display "Achievement 1 (Curry)"
      if (dataService) {
        const rawData = dataService.rawData();
        hasPrereq = (rawData.esMbrAchievements || []).some(a =>
          a.CAPID === member?.CAPID &&
          a.AchvID === '95' &&
          String(a.Status || '').toUpperCase() === 'ACTIVE'
        );
      } else {
        hasPrereq = memberQuals?.some(q =>
          q.achvID === '95' && q.status === 'Active'
        );
      }
      displayName = 'Achievement 1 (Curry)';
    }
  } else {
    // Regular ES qualification check - use raw data from dataService if available
    // This ensures IS courses and other filtered achievements are still checked
    if (dataService) {
      const rawData = dataService.rawData();
      hasPrereq = (rawData.esMbrAchievements || []).some(a =>
        a.CAPID === member?.CAPID &&
        a.AchvID === node.achvID &&
        String(a.Status || '').toUpperCase() === 'ACTIVE'
      );
    } else {
      // Fallback to filtered qualifications if no dataService
      hasPrereq = memberQuals?.some(q =>
        q.achvID === node.achvID && q.status === 'Active'
      );
    }
  }

  const indentClass = depth > 0 ? 'ml-4 pl-3 border-l-2 border-slate-200' : '';

  // If showSelf is false, only render the prerequisites (skip the root node itself)
  if (!showSelf && depth === 0) {
    // Filter out duplicate Achievement 1/Level 1 entries (IDs '95' and '96' are equivalent)
    let filteredPrereqs = node.prerequisites || [];
    const hasAchv95 = filteredPrereqs.some(p => p.achvID === '95');
    const hasAchv96 = filteredPrereqs.some(p => p.achvID === '96');

    if (hasAchv95 && hasAchv96) {
      // Remove '96' (Level 1) and keep '95' (Achievement 1) - the display logic will handle member type
      filteredPrereqs = filteredPrereqs.filter(p => p.achvID !== '96');
    }

    return (
      <div>
        {filteredPrereqs.length > 0 ? (
          filteredPrereqs.map((prereq, idx) => (
            <PrereqTreeView
              key={idx}
              node={prereq}
              memberQuals={memberQuals}
              member={member}
              dataService={dataService}
              depth={0}
              showSelf={true}
            />
          ))
        ) : (
          <div className="text-sm text-slate-500 italic">
            No prerequisite qualifications required
          </div>
        )}
      </div>
    );
  }

  return (
    <div className={indentClass}>
      <div className={`flex items-start gap-2 py-1 ${depth > 0 ? 'text-xs' : 'text-sm'}`}>
        <div className="mt-0.5">
          {hasPrereq ? (
            <Icon name="CheckCircle2" className="w-4 h-4 text-emerald-600" />
          ) : (
            <Icon name="Circle" className="w-4 h-4 text-slate-300" />
          )}
        </div>
        <span className={hasPrereq ? 'text-emerald-700 font-medium' : 'text-slate-600'}>
          {displayName}
        </span>
      </div>

      {node.prerequisites && node.prerequisites.length > 0 && (() => {
        // Filter out duplicate Achievement 1/Level 1 entries (IDs '95' and '96' are equivalent)
        let filteredPrereqs = node.prerequisites;
        const hasAchv95 = filteredPrereqs.some(p => p.achvID === '95');
        const hasAchv96 = filteredPrereqs.some(p => p.achvID === '96');

        if (hasAchv95 && hasAchv96) {
          // Remove '96' (Level 1) and keep '95' (Achievement 1) - the display logic will handle member type
          filteredPrereqs = filteredPrereqs.filter(p => p.achvID !== '96');
        }

        return (
          <div className="mt-1">
            {filteredPrereqs.map((prereq, idx) => (
              <PrereqTreeView
                key={idx}
                node={prereq}
                memberQuals={memberQuals}
                member={member}
                dataService={dataService}
                depth={depth + 1}
                showSelf={true}
              />
            ))}
          </div>
        );
      })()}
    </div>
  );
};

// ES Qualification Tree Modal
// Shows visual skill tree of qualifications with prerequisites and eligibility
const ESQualificationTreeModal = ({ isOpen, onClose, member, dataService, allQualifications }) => {
  if (!isOpen || !member) return null;

  const [selectedQual, setSelectedQual] = React.useState(null);
  const [eligibilityMap, setEligibilityMap] = React.useState({});
  const [selectedQualTasks, setSelectedQualTasks] = React.useState([]);
  const [viewMode, setViewMode] = React.useState('progression'); // 'progression' or 'all'
  const [detailModalOpen, setDetailModalOpen] = React.useState(false);

  // Build eligibility map for all qualifications
  React.useEffect(() => {
    if (dataService && member && allQualifications) {
      const map = {};
      allQualifications.forEach(qual => {
        const eligibility = dataService.checkESQualificationEligibility(qual.AchvID || qual.achvID, member);
        map[qual.AchvID || qual.achvID] = eligibility;
      });
      setEligibilityMap(map);
    }
  }, [member, dataService, allQualifications]);

  // Load tasks when a qualification is selected
  React.useEffect(() => {
    if (selectedQual && dataService && member) {
      const achvID = selectedQual.AchvID || selectedQual.achvID;
      const tasks = dataService.getESAchievementTasks(achvID, member.CAPID);
      setSelectedQualTasks(tasks);
    } else {
      setSelectedQualTasks([]);
    }
  }, [selectedQual, dataService, member]);

  // Filter qualifications for the skill tree (show IS/ICS courses here, but exclude them from profile)
  // In skill tree, we want to show IS/ICS courses so members can see they've completed them
  const filteredQualifications = React.useMemo(() => {
    if (!allQualifications) return [];
    return allQualifications.filter(qual => {
      const achvID = qual.AchvID || qual.achvID;
      const functionalArea = qual.FunctionalArea || qual.functionalArea;

      // Create a modified exclusion set that doesn't include IS/ICS courses for skill tree
      const IS_ICS_COURSE_IDS = new Set([
        '176', '177', '178', '179', '180', '181', '267', '268', '270', '271', '272', '273'
      ]);

      // For skill tree, exclude everything EXCEPT IS/ICS courses
      const excludeAchvIDs = new Set([...ES_EXCLUDED_ACHIEVEMENT_IDS]);
      IS_ICS_COURSE_IDS.forEach(id => excludeAchvIDs.delete(id)); // Remove IS/ICS from exclusions

      if (excludeAchvIDs.has(achvID) || ES_EXCLUDED_FUNCTIONAL_AREAS.has(functionalArea)) {
        return false;
      }
      return true;
    });
  }, [allQualifications]);

  // Group qualifications by functional area
  const qualsByArea = React.useMemo(() => {
    if (!filteredQualifications) return {};

    const grouped = {};
    filteredQualifications.forEach(qual => {
      const area = qual.FunctionalArea || qual.functionalArea || 'Other';
      if (!grouped[area]) {
        grouped[area] = [];
      }
      grouped[area].push(qual);
    });

    return grouped;
  }, [filteredQualifications]);

  // Progression tree structure - showing career paths after GES
  const progressionTree = React.useMemo(() => {
    if (!filteredQualifications) return null;

    const findQual = (achvID) => filteredQualifications.find(q => (q.AchvID || q.achvID) === achvID);

    return {
      foundation: findQual('53'), // GES
      paths: {
        field: {
          title: 'Field Operations',
          description: 'Ground-based field work and search operations',
          qualifications: [
            { qual: findQual('70'), next: ['69', '126'] }, // GTM3 -> GTL, GTM2
            { qual: findQual('71'), next: ['68'] },        // UDF -> GBD
            { qual: findQual('69'), next: ['68', '126'] }, // GTL -> GBD, GTM2
            { qual: findQual('126'), next: ['127'] },      // GTM2 -> GTM1
            { qual: findQual('127'), next: [] },           // GTM1
            { qual: findQual('68'), next: ['64'] },        // GBD -> PSC
            { qual: findQual('258'), next: [] },           // UAS Technician
            { qual: findQual('257'), next: [] },           // UAS Mission Pilot
          ]
        },
        missionBase: {
          title: 'Mission Base Operations',
          description: 'Support operations at the mission base',
          qualifications: [
            { qual: findQual('80'), next: ['72', '66', '78', '77', '75', '65'] }, // MSA -> PIO, FASC, LO, MSO, CUL, LSC
            { qual: findQual('76'), next: ['75'] },        // MRO -> CUL
            { qual: findQual('75'), next: ['65'] },        // CUL -> LSC (requires MSA too)
            { qual: findQual('74'), next: ['73'] },        // FLM -> FLS
            { qual: findQual('73'), next: [] },            // FLS
            { qual: findQual('72'), next: [] },            // PIO
            { qual: findQual('66'), next: [] },            // FASC
            { qual: findQual('78'), next: [] },            // LO
            { qual: findQual('77'), next: [] },            // MSO
            { qual: findQual('65'), next: [] },            // LSC
          ]
        },
        flight: {
          title: 'Flight Operations',
          description: 'Airborne mission operations',
          qualifications: [
            { qual: findQual('55'), next: ['193', '81', '56', '57'] }, // MS -> AP, MO, TMP, MP
            { qual: findQual('193'), next: [] },           // AP
            { qual: findQual('81'), next: ['67'] },        // MO -> AOBD
            { qual: findQual('56'), next: [] },            // TMP
            { qual: findQual('57'), next: [] },            // MP
            { qual: findQual('67'), next: ['64'] },        // AOBD -> PSC
          ]
        },
        leadership: {
          title: 'Advanced Leadership',
          description: 'Incident command and management',
          qualifications: [
            { qual: findQual('64'), next: ['63'] },        // PSC -> OSC
            { qual: findQual('63'), next: ['61'] },        // OSC -> IC3
            { qual: findQual('61'), next: ['125'] },       // IC3 -> IC2
            { qual: findQual('125'), next: ['128'] },      // IC2 -> IC1
            { qual: findQual('128'), next: [] },           // IC1
          ]
        }
      }
    };
  }, [filteredQualifications]);

  // Determine if member has this qualification
  const hasQualification = (achvID) => {
    const quals = member.esQualificationsAll || member.esQualifications || [];
    return quals.some(q =>
      q.achvID === achvID && q.status === 'Active'
    );
  };

  // Render a single qualification node
  const QualNode = ({ qual }) => {
    const achvID = qual.AchvID || qual.achvID;
    const qualName = qual.Achv || qual.name;

    const hasQual = hasQualification(achvID);
    const eligibility = eligibilityMap[achvID];
    const isEligible = eligibility?.eligible ?? true;
    const isSelected = selectedQual && (selectedQual.AchvID === achvID || selectedQual.achvID === achvID);

    let statusClass = '';
    let icon = null;

    if (hasQual) {
      statusClass = 'bg-emerald-100 border-emerald-400 text-emerald-800';
      icon = <Icon name="Check" className="w-4 h-4" />;
    } else if (!isEligible) {
      statusClass = 'bg-slate-100 border-slate-300 text-slate-500 opacity-60';
      icon = <Icon name="Lock" className="w-4 h-4" />;
    } else {
      statusClass = 'bg-white border-slate-300 text-slate-700 hover:border-blue-400';
    }

    if (isSelected) {
      statusClass += ' ring-2 ring-blue-500 ring-offset-2';
    }

    return (
      <div
        className={`p-3 rounded-lg border-2 cursor-pointer transition-all ${statusClass}`}
        onClick={() => setSelectedQual(qual)}
        title={qualName}
      >
        <div className="flex items-center gap-2">
          {icon}
          <div className="flex-1 min-w-0">
            <div className="text-sm font-semibold truncate">{qualName}</div>
            {!isEligible && eligibility && eligibility.reasons && eligibility.reasons.length > 0 && (
              <div className="text-xs text-rose-600 mt-1">
                Missing: {eligibility.reasons.join(', ')}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  // Render a path section in progression view
  const PathSection = ({ title, description, qualifications }) => {
    return (
      <div className="mb-6 p-4 bg-white rounded-lg border-2 border-slate-200">
        <h4 className="text-md font-bold text-slate-800 mb-1">{title}</h4>
        <p className="text-xs text-slate-600 mb-3">{description}</p>
        <div className="grid grid-cols-2 gap-3">
          {qualifications.map(({ qual }, idx) => {
            if (!qual) return null;
            return <QualNode key={idx} qual={qual} />;
          })}
        </div>
      </div>
    );
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="ES Qualification Career Path" maxWidthClass="max-w-6xl">
      {/* View Mode Toggle */}
      <div className="flex gap-2 mb-4">
        <button
          onClick={() => setViewMode('progression')}
          className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${
            viewMode === 'progression'
              ? 'bg-blue-600 text-white'
              : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
          }`}
        >
          Career Progression
        </button>
        <button
          onClick={() => setViewMode('all')}
          className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${
            viewMode === 'all'
              ? 'bg-blue-600 text-white'
              : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
          }`}
        >
          All Qualifications
        </button>
      </div>

      <div className="grid md:grid-cols-3 gap-4">
        {/* Left: Qualification Tree */}
        <div className="md:col-span-2 space-y-4">
          <div className="flex items-center justify-between mb-2">
            <h3 className="text-lg font-bold text-slate-800">
              {viewMode === 'progression' ? 'Your Career Path' : 'Available Qualifications'}
            </h3>
            <div className="flex items-center gap-3 text-xs">
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 rounded bg-emerald-400"></div>
                <span>Active</span>
              </div>
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 rounded bg-slate-300"></div>
                <span>Locked</span>
              </div>
            </div>
          </div>

          {viewMode === 'progression' && progressionTree ? (
            <div className="space-y-4">
              {/* Foundation: GES */}
              <div className="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-300">
                <h4 className="text-md font-bold text-blue-900 mb-2">Foundation</h4>
                <p className="text-xs text-blue-700 mb-3">All ES qualifications require General Emergency Services</p>
                {progressionTree.foundation && <QualNode qual={progressionTree.foundation} />}
              </div>

              {/* Career Paths */}
              {Object.entries(progressionTree.paths).map(([key, path]) => (
                <PathSection
                  key={key}
                  title={path.title}
                  description={path.description}
                  qualifications={path.qualifications}
                />
              ))}
            </div>
          ) : (
            <div className="space-y-6">
              {Object.entries(qualsByArea).map(([area, quals]) => (
                <div key={area} className="space-y-2">
                  <h4 className="text-sm font-bold text-slate-600 uppercase tracking-wide">
                    {ES_FUNCTIONAL_AREAS[area] || area}
                  </h4>
                  <div className="grid grid-cols-2 gap-3">
                    {quals.map(qual => (
                      <QualNode key={qual.AchvID || qual.achvID} qual={qual} />
                    ))}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Right: Selected Qualification Details */}
        <div className="md:col-span-1">
          {selectedQual ? (
            <div className="sticky top-0 space-y-4">
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h4 className="font-bold text-blue-900 mb-2">{selectedQual.Achv || selectedQual.name}</h4>
                <div className="text-xs text-blue-800 space-y-1">
                  <div>
                    <span className="font-semibold">Area:</span> {ES_FUNCTIONAL_AREAS[selectedQual.FunctionalArea || selectedQual.functionalArea] || selectedQual.FunctionalArea || selectedQual.functionalArea}
                  </div>
                  {(() => {
                    const requiredAge = ES_AGE_REQUIREMENTS[selectedQual.AchvID || selectedQual.achvID];
                    if (requiredAge) {
                      return (
                        <div className="mt-2 pt-2 border-t border-blue-300">
                          <span className="font-semibold">Min Age:</span> {requiredAge} years
                        </div>
                      );
                    }
                  })()}
                </div>
              </div>

              {/* Prerequisites */}
              {(() => {
                const achvID = selectedQual.AchvID || selectedQual.achvID;
                const eligibility = eligibilityMap[achvID];

                // ALWAYS build the prerequisite tree directly, regardless of eligibility
                // This ensures we show the full tree even when special prerequisites (age, tasks) are not met
                const prereqTree = dataService ? dataService.buildESPrerequisiteTree(achvID) : null;
                const hasAchievementPrereqs = prereqTree?.prerequisites?.length > 0;

                // Check if there are missing prerequisites (includes special prereqs from eligibility check)
                const hasMissingPrereqs = eligibility?.reasons && eligibility.reasons.length > 0;

                // Always show prerequisites section
                return (
                  <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h5 className="font-semibold text-slate-800 mb-2 text-sm">Prerequisites</h5>

                    {/* Achievement Prerequisites Tree - ALWAYS SHOW if they exist */}
                    {hasAchievementPrereqs && (
                      <div className={hasMissingPrereqs ? "mb-3" : ""}>
                        <PrereqTreeView
                          node={prereqTree}
                          memberQuals={member.esQualificationsAll || member.esQualifications}
                          member={member}
                          dataService={dataService}
                          depth={0}
                          showSelf={false}
                        />
                      </div>
                    )}

                    {/* Missing Prerequisites (from eligibility check - includes tasks, age, etc.) */}
                    {hasMissingPrereqs && (
                      <div>
                        {hasAchievementPrereqs && <div className="border-t border-slate-300 my-2"></div>}
                        <div className="text-xs font-semibold text-slate-600 mb-1">Missing Requirements:</div>
                        <div className="space-y-1">
                          {eligibility.reasons.map((reason, idx) => (
                            <div key={`missing-${idx}`} className="flex items-start gap-2 py-1 text-sm">
                              <Icon name="AlertCircle" className="w-4 h-4 text-rose-600 mt-0.5" />
                              <span className="text-rose-700">{reason}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* No prerequisites message */}
                    {!hasAchievementPrereqs && !hasMissingPrereqs && (
                      <div className="text-sm text-slate-500 italic">
                        No prerequisites required
                      </div>
                    )}

                    {/* All prerequisites met message */}
                    {eligibility?.eligible && (hasAchievementPrereqs || !hasMissingPrereqs) && (
                      <div className="mt-2 pt-2 border-t border-slate-300">
                        <div className="flex items-center gap-2 text-sm text-emerald-700">
                          <Icon name="CheckCircle2" className="w-4 h-4" />
                          <span className="font-medium">All prerequisites met</span>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })()}

              {/* Task Summary */}
              {selectedQualTasks.length > 0 && (
                <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                  <h5 className="font-semibold text-slate-800 mb-2 text-sm">Task Requirements</h5>
                  {selectedQualTasks.map((step, idx) => {
                    const stepCompleted = step.tasks.filter(t => t.completed).length;
                    const stepTotal = step.tasks.length;
                    const stepPercent = stepTotal > 0 ? Math.round((stepCompleted / stepTotal) * 100) : 0;

                    return (
                      <div key={idx} className="mb-2">
                        <div className="flex justify-between items-center text-xs">
                          <span className="font-medium text-slate-700">{step.stepName}</span>
                          <span className={`font-semibold ${stepPercent === 100 ? 'text-emerald-600' : 'text-slate-600'}`}>
                            {stepCompleted}/{stepTotal}
                          </span>
                        </div>
                        {stepTotal > 0 && (
                          <div className="w-full bg-slate-200 rounded-full h-1.5 mt-1">
                            <div
                              className={`h-1.5 rounded-full transition-all ${
                                stepPercent === 100 ? 'bg-emerald-500' : 'bg-blue-500'
                              }`}
                              style={{ width: `${stepPercent}%` }}
                            ></div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}

              {selectedQualTasks.length === 0 && (
                <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-xs text-slate-500 italic">
                  No specific tasks required for this qualification
                </div>
              )}

              {/* View Full Details Button */}
              <button
                onClick={() => setDetailModalOpen(true)}
                className="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm font-medium flex items-center justify-center gap-2"
              >
                <Icon name="FileText" className="w-4 h-4" />
                View Full Details
              </button>
            </div>
          ) : (
            <div className="text-sm text-slate-500 italic text-center py-8">
              Select a qualification to view details
            </div>
          )}
        </div>
      </div>

      {/* Full Details Modal - nested modal for viewing complete task requirements */}
      {selectedQual && typeof ESQualificationDetailModal !== 'undefined' && (() => {
        // Get the member's actual qualification object (with completion data)
        // selectedQual is just the achievement definition, we need the member's version
        const achvID = selectedQual.AchvID || selectedQual.achvID;
        const memberQual = (member.esQualificationsAll || member.esQualifications || []).find(q =>
          (q.achvID || q.AchvID) === achvID
        );

        // If member doesn't have this qual yet, create a minimal object for the modal
        const qualForModal = memberQual || {
          achvID: achvID,
          name: selectedQual.Achv || selectedQual.name,
          functionalArea: selectedQual.FunctionalArea || selectedQual.functionalArea,
          status: 'Not Started',
          statusRaw: null,
          completed: null,
          expiration: null
        };

        return (
          <ESQualificationDetailModal
            isOpen={detailModalOpen}
            onClose={() => setDetailModalOpen(false)}
            qualification={qualForModal}
            member={member}
            dataService={dataService}
          />
        );
      })()}
    </Modal>
  );
};
</script>

<script type="text/babel">
/**
 * ModalESReadiness.html
 *
 * Deep-dive modal for Emergency Services readiness analysis.
 * Provides 6 tabs: Overview, Roster, Qualifications, Expirations, Pipeline, Insights
 */

/**
 * ESReadinessModal - Main modal component for ES deep dive
 */
const ESReadinessModal = ({
  isOpen,
  onClose,
  esAnalysis,
  dataFiles,
  unitFilter
}) => {
  const [activeTab, setActiveTab] = useState('overview');

  if (!isOpen || !esAnalysis) return null;

  const tabs = [
    { id: 'overview', label: 'Overview', icon: 'LayoutDashboard' },
    { id: 'roster', label: 'ES Roster', icon: 'Users' },
    { id: 'qualifications', label: 'Qualifications', icon: 'Award' },
    { id: 'expirations', label: 'Expirations', icon: 'Calendar' },
    { id: 'pipeline', label: 'Pipeline', icon: 'TrendingUp' },
    { id: 'insights', label: 'Insights', icon: 'Lightbulb' }
  ];

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Emergency Services Readiness" maxWidthClass="max-w-6xl">
      {/* Tab Navigation */}
      <div className="flex gap-1 mb-4 overflow-x-auto pb-1 border-b border-slate-200">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap ${
              activeTab === tab.id
                ? 'bg-blue-50 text-blue-700 border-b-2 border-blue-500'
                : 'text-slate-600 hover:bg-slate-50'
            }`}
          >
            <Icon name={tab.icon} className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* Tab Content */}
      <div className="min-h-[500px]">
        {activeTab === 'overview' && (
          <ESModalOverviewTab esAnalysis={esAnalysis} />
        )}
        {activeTab === 'roster' && (
          <ESModalRosterTab esAnalysis={esAnalysis} />
        )}
        {activeTab === 'qualifications' && (
          <ESModalQualificationsTab esAnalysis={esAnalysis} />
        )}
        {activeTab === 'expirations' && (
          <ESModalExpirationsTab esAnalysis={esAnalysis} />
        )}
        {activeTab === 'pipeline' && (
          <ESModalPipelineTab esAnalysis={esAnalysis} />
        )}
        {activeTab === 'insights' && (
          <ESModalInsightsTab esAnalysis={esAnalysis} />
        )}
      </div>
    </Modal>
  );
};

/**
 * Overview Tab - Summary dashboard
 */
const ESModalOverviewTab = ({ esAnalysis }) => {
  const getColorClass = (rating) => {
    switch (rating) {
      case 'excellent': return 'text-emerald-700 bg-emerald-50 border-emerald-200';
      case 'good': return 'text-blue-700 bg-blue-50 border-blue-200';
      case 'fair': return 'text-amber-700 bg-amber-50 border-amber-200';
      default: return 'text-rose-700 bg-rose-50 border-rose-200';
    }
  };

  return (
    <div className="space-y-6">
      {/* Readiness Score Hero */}
      <div className="bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl p-6 border border-slate-200">
        <div className="flex items-center justify-between">
          <div>
            <h3 className="text-lg font-bold text-slate-800">Overall ES Readiness</h3>
            <p className="text-sm text-slate-600 mt-1">{esAnalysis.quickSummary}</p>
          </div>
          <div className={`text-center px-6 py-4 rounded-xl border ${getColorClass(esAnalysis.readinessRating)}`}>
            <div className="text-4xl font-bold">{esAnalysis.readinessScore}</div>
            <div className="text-sm font-medium capitalize">{esAnalysis.readinessRating}</div>
          </div>
        </div>

        {/* Score Components */}
        {esAnalysis.readinessComponents && (
          <div className="grid grid-cols-5 gap-4 mt-6">
            <div className="text-center p-3 bg-white rounded-lg border border-slate-200">
              <div className="text-2xl font-bold text-slate-800">{esAnalysis.readinessComponents.teamScore}</div>
              <div className="text-xs text-slate-500">Team Capability</div>
            </div>
            <div className="text-center p-3 bg-white rounded-lg border border-slate-200">
              <div className="text-2xl font-bold text-slate-800">{esAnalysis.readinessComponents.qualScore}</div>
              <div className="text-xs text-slate-500">Qual Health</div>
            </div>
            <div className="text-center p-3 bg-white rounded-lg border border-slate-200">
              <div className="text-2xl font-bold text-slate-800">{esAnalysis.readinessComponents.evaluatorScore}</div>
              <div className="text-xs text-slate-500">Evaluator Coverage</div>
            </div>
            <div className="text-center p-3 bg-white rounded-lg border border-slate-200">
              <div className="text-2xl font-bold text-slate-800">{esAnalysis.readinessComponents.riskScore}</div>
              <div className="text-xs text-slate-500">Risk Mitigation</div>
            </div>
            <div className="text-center p-3 bg-white rounded-lg border border-slate-200">
              <div className="text-2xl font-bold text-slate-800">{esAnalysis.readinessComponents.pipelineScore}</div>
              <div className="text-xs text-slate-500">Pipeline</div>
            </div>
          </div>
        )}
      </div>

      {/* Team Capabilities Summary */}
      <div>
        <h4 className="text-sm font-semibold text-slate-700 mb-3">Team Capabilities</h4>
        <div className="grid grid-cols-5 gap-4">
          {Object.entries(esAnalysis.teams).map(([key, team]) => {
            const colorStyles = {
              green: 'bg-emerald-50 border-emerald-200 text-emerald-700',
              blue: 'bg-blue-50 border-blue-200 text-blue-700',
              amber: 'bg-amber-50 border-amber-200 text-amber-700',
              red: 'bg-rose-50 border-rose-200 text-rose-700'
            };

            // Determine display values based on team type
            let mainValue, subText;
            if (key === 'fieldOps') {
              // Field Ops shows combined ground + UDF teams
              const groundTeams = team.groundTeamsFieldable || 0;
              const udfTeams = team.udfTeamsFieldable || 0;
              mainValue = groundTeams + udfTeams;
              subText = `${groundTeams} ground, ${udfTeams} UDF`;
            } else if (team.isStaffing) {
              // Staffing positions (Mission Base, Command)
              mainValue = team.qualifiedCount || 0;
              subText = `${team.positionsCovered || 0}/${team.totalPositionTypes || 0} position types`;
            } else if (team.teamsFieldable !== undefined) {
              // Standard team-based (Aircrew, sUAS)
              mainValue = team.teamsFieldable;
              subText = 'teams';
            } else {
              mainValue = 0;
              subText = 'teams';
            }

            return (
              <div key={key} className={`p-4 rounded-lg border ${colorStyles[team.color] || colorStyles.red}`}>
                <div className="flex items-center justify-between mb-2">
                  <Icon name={team.icon || 'Users'} className="w-5 h-5" />
                  {(team.canField || (team.isStaffing && team.qualifiedCount > 0)) && <Icon name="CheckCircle" className="w-5 h-5" />}
                </div>
                <div className="font-semibold">{team.name}</div>
                <div className="text-2xl font-bold mt-1">{mainValue}</div>
                <div className="text-xs opacity-75">{subText}</div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Quick Stats */}
      <div className="grid grid-cols-4 gap-4">
        <div className="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
          <div className="text-3xl font-bold text-emerald-700">{esAnalysis.qualifications.byStatus.active}</div>
          <div className="text-sm text-emerald-600">Active Operational Quals</div>
        </div>
        <div className="p-4 bg-amber-50 rounded-lg border border-amber-200">
          <div className="text-3xl font-bold text-amber-700">{esAnalysis.qualifications.byStatus.training}</div>
          <div className="text-sm text-amber-600">In Training</div>
        </div>
        <div className="p-4 bg-rose-50 rounded-lg border border-rose-200">
          <div className="text-3xl font-bold text-rose-700">{esAnalysis.qualifications.expiringWithin90Days.length}</div>
          <div className="text-sm text-rose-600">Expiring in 90 Days</div>
        </div>
        <div className="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
          <div className="text-3xl font-bold text-indigo-700">{esAnalysis.evaluators.evaluatorCount || esAnalysis.evaluators.available?.length || 0}</div>
          <div className="text-sm text-indigo-600">Potential Evaluators*</div>
        </div>
      </div>
      <p className="text-xs text-slate-500 mt-2">
        *Potential evaluators are identified based on SET qualification and 1+ year holding a qual. Verify actual evaluator status in eServices.
      </p>
    </div>
  );
};

/**
 * Roster Tab - Member-by-member ES qualification table
 * Shows Skills Evaluator status with green border on qualifications they can evaluate
 */
const ESModalRosterTab = ({ esAnalysis }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterPosition, setFilterPosition] = useState('all');

  // Build lookup of which qualifications each member can evaluate
  const evaluatorLookup = useMemo(() => {
    const lookup = new Map();
    (esAnalysis.evaluators?.available || []).forEach(evaluator => {
      // Get position codes for qualifications they can evaluate
      const canEvaluatePositions = (evaluator.canEvaluate || []).map(qual => {
        // Convert achvID to position code
        return ES_ACHV_TO_POSITION[qual.achvID] || qual.name;
      });
      lookup.set(evaluator.capid, new Set(canEvaluatePositions));
    });
    return lookup;
  }, [esAnalysis.evaluators]);

  // Collect all qualified members from all teams
  const allMembers = useMemo(() => {
    const memberMap = new Map();

    Object.entries(esAnalysis.teams).forEach(([teamKey, team]) => {
      (team.qualifiedMembers || []).forEach(member => {
        if (!memberMap.has(member.capid)) {
          memberMap.set(member.capid, {
            ...member,
            positions: [...member.positions],
            isEvaluator: evaluatorLookup.has(member.capid),
            canEvaluate: evaluatorLookup.get(member.capid) || new Set()
          });
        } else {
          const existing = memberMap.get(member.capid);
          member.positions.forEach(pos => {
            if (!existing.positions.includes(pos)) {
              existing.positions.push(pos);
            }
          });
        }
      });
    });

    return Array.from(memberMap.values());
  }, [esAnalysis.teams, evaluatorLookup]);

  // Get unique positions for filter
  const allPositions = useMemo(() => {
    const positions = new Set();
    allMembers.forEach(m => m.positions.forEach(p => positions.add(p)));
    return Array.from(positions).sort();
  }, [allMembers]);

  // Filter members
  const filteredMembers = useMemo(() => {
    return allMembers.filter(m => {
      const matchesSearch = searchTerm === '' ||
        m.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        m.capid.includes(searchTerm);
      const matchesPosition = filterPosition === 'all' ||
        m.positions.includes(filterPosition);
      return matchesSearch && matchesPosition;
    });
  }, [allMembers, searchTerm, filterPosition]);

  return (
    <div className="space-y-4">
      {/* Legend and Disclaimer */}
      <div className="space-y-2">
        <div className="flex items-center gap-4 text-xs text-slate-500 bg-slate-50 p-2 rounded-lg">
          <div className="flex items-center gap-1">
            <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 font-medium rounded-full">GTL</span>
            <span>= Active qualification</span>
          </div>
          <div className="flex items-center gap-1">
            <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 font-medium rounded-full ring-2 ring-emerald-500 ring-offset-1">GTL</span>
            <span>= Potential evaluator for this qualification</span>
          </div>
        </div>
        <div className="text-xs text-amber-700 bg-amber-50 border border-amber-200 p-2 rounded-lg">
          <Icon name="AlertTriangle" className="w-3 h-3 inline mr-1" />
          <strong>Note:</strong> Potential evaluators are identified based on having SET qualification and holding a qualification for 1+ year.
          This is an estimate only â€” verify actual evaluator status in eServices, as members must be keyed in as evaluators for specific qualifications.
        </div>
      </div>

      {/* Filters */}
      <div className="flex gap-4 items-center">
        <div className="flex-1">
          <input
            type="text"
            placeholder="Search by name or CAPID..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <select
          value={filterPosition}
          onChange={(e) => setFilterPosition(e.target.value)}
          className="px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="all">All Positions</option>
          {allPositions.map(pos => (
            <option key={pos} value={pos}>{pos}</option>
          ))}
        </select>
      </div>

      {/* Member count */}
      <div className="text-sm text-slate-500">
        Showing {filteredMembers.length} of {allMembers.length} ES-qualified members
        {esAnalysis.evaluators?.available?.length > 0 && (
          <span className="ml-2">â€¢ {esAnalysis.evaluators.available.length} Potential Evaluator{esAnalysis.evaluators.available.length !== 1 ? 's' : ''}</span>
        )}
      </div>

      {/* Table */}
      <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
        <table className="w-full">
          <thead className="bg-slate-50 border-b border-slate-200">
            <tr>
              <th className="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Member</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">CAPID</th>
              <th className="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">ES Qualifications</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {filteredMembers.map((member, idx) => (
              <tr key={member.capid} className={idx % 2 === 0 ? 'bg-white' : 'bg-slate-25'}>
                <td className="px-4 py-3">
                  <div className="flex items-center gap-2">
                    <span className="font-medium text-slate-800">{member.rank} {member.name}</span>
                    {member.isEvaluator && (
                      <span className="px-1.5 py-0.5 bg-emerald-600 text-white text-[10px] font-bold rounded" title="Has SET qualification - potential evaluator (verify in eServices)">SET</span>
                    )}
                  </div>
                </td>
                <td className="px-4 py-3 text-sm text-slate-600">{member.capid}</td>
                <td className="px-4 py-3">
                  <div className="flex flex-wrap gap-1">
                    {member.positions.map(pos => {
                      const canEvaluateThis = member.canEvaluate.has(pos);
                      return (
                        <span
                          key={pos}
                          className={`px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-medium rounded-full ${
                            canEvaluateThis ? 'ring-2 ring-emerald-500 ring-offset-1' : ''
                          }`}
                          title={canEvaluateThis ? `Potential evaluator for ${pos} (verify in eServices)` : pos}
                        >
                          {pos}
                        </span>
                      );
                    })}
                  </div>
                </td>
              </tr>
            ))}
            {filteredMembers.length === 0 && (
              <tr>
                <td colSpan={3} className="px-4 py-8 text-center text-slate-500">
                  No members match the current filters
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

/**
 * Qualifications Tab - Status breakdown by functional area
 */
const ESModalQualificationsTab = ({ esAnalysis }) => {
  const qualStats = esAnalysis.qualifications;

  // Group by team type - using the correct keys that match positionCounts
  // Note: positionCounts counts MEMBERS with each qual, not total qual records
  const teamQuals = [
    {
      name: 'Field Operations',
      // Map display name to positionCounts key - individual GTM levels
      positions: [
        { display: 'GTL', key: 'GTL' },
        { display: 'GTM1', key: 'GTM1' },
        { display: 'GTM2', key: 'GTM2' },
        { display: 'GTM3', key: 'GTM3' },
        { display: 'UDF', key: 'UDF' },
        { display: 'GBD', key: 'GBD' }
      ],
      teamKey: 'fieldOps',
      color: 'emerald'
    },
    {
      name: 'Air Operations',
      // Individual aircrew positions: MP, TMP, MS, MO, AP, AOBD
      positions: [
        { display: 'MP', key: 'MP' },
        { display: 'TMP', key: 'TMP' },
        { display: 'MS', key: 'MS' },
        { display: 'MO', key: 'MO' },
        { display: 'AP', key: 'AP' },
        { display: 'AOBD', key: 'AOBD' }
      ],
      teamKey: 'aircrew',
      color: 'blue'
    },
    {
      name: 'sUAS Operations',
      positions: [
        { display: 'sUASMP', key: 'UASMP' },
        { display: 'sUAST', key: 'UAST' }
      ],
      teamKey: 'suas',
      color: 'indigo'
    },
    {
      name: 'Mission Base',
      positions: [
        { display: 'MSA', key: 'MSA' },
        { display: 'MRO', key: 'MRO' },
        { display: 'CUL', key: 'CUL' },
        { display: 'FLM', key: 'FLM' },
        { display: 'FLS', key: 'FLS' },
        { display: 'PIO', key: 'PIO' },
        { display: 'LO', key: 'LO' },
        { display: 'MSO', key: 'MSO' }
      ],
      teamKey: 'missionBase',
      color: 'amber'
    },
    {
      name: 'Command Staff',
      positions: [
        { display: 'IC3', key: 'IC3' },
        { display: 'IC2', key: 'IC2' },
        { display: 'IC1', key: 'IC1' },
        { display: 'OSC', key: 'OSC' },
        { display: 'PSC', key: 'PSC' },
        { display: 'LSC', key: 'LSC' },
        { display: 'FASC', key: 'FASC' }
      ],
      teamKey: 'command',
      color: 'purple'
    }
  ];

  // Get position count from the specific team's positionCounts
  const getPositionCount = (teamKey, positionKey) => {
    const team = esAnalysis.teams[teamKey];
    if (team && team.positionCounts && team.positionCounts[positionKey] !== undefined) {
      return team.positionCounts[positionKey];
    }
    return 0;
  };

  // Calculate total members shown in breakdown
  const totalMembersInBreakdown = useMemo(() => {
    let total = 0;
    teamQuals.forEach(category => {
      category.positions.forEach(pos => {
        total += getPositionCount(category.teamKey, pos.key);
      });
    });
    return total;
  }, [esAnalysis.teams]);

  return (
    <div className="space-y-6">
      {/* Overall Status - Total operational qualification records across all members */}
      <div className="grid grid-cols-3 gap-4">
        <div className="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
          <div className="flex items-center gap-2 mb-2">
            <Icon name="CheckCircle" className="w-5 h-5 text-emerald-600" />
            <span className="font-semibold text-emerald-700">Active</span>
          </div>
          <div className="text-3xl font-bold text-emerald-800">{qualStats.byStatus.active}</div>
          <div className="text-sm text-emerald-600">Operational qualifications</div>
        </div>
        <div className="p-4 bg-amber-50 rounded-lg border border-amber-200">
          <div className="flex items-center gap-2 mb-2">
            <Icon name="Clock" className="w-5 h-5 text-amber-600" />
            <span className="font-semibold text-amber-700">Training</span>
          </div>
          <div className="text-3xl font-bold text-amber-800">{qualStats.byStatus.training}</div>
          <div className="text-sm text-amber-600">In progress</div>
        </div>
        <div className="p-4 bg-rose-50 rounded-lg border border-rose-200">
          <div className="flex items-center gap-2 mb-2">
            <Icon name="XCircle" className="w-5 h-5 text-rose-600" />
            <span className="font-semibold text-rose-700">Expired</span>
          </div>
          <div className="text-3xl font-bold text-rose-800">{qualStats.byStatus.expired}</div>
          <div className="text-sm text-rose-600">Expired records</div>
        </div>
      </div>
      <p className="text-xs text-slate-500">
        Note: Counts include operational qualifications only (team positions, not GES/SET).
        One member can hold multiple qualifications.
      </p>

      {/* By Team Type - Shows MEMBERS per position (not total qual records) */}
      <div className="space-y-4">
        <h4 className="text-sm font-semibold text-slate-700">Members by Position Type</h4>
        {teamQuals.map(category => {
          const colorStyles = {
            emerald: 'bg-emerald-50 border-emerald-200',
            blue: 'bg-blue-50 border-blue-200',
            indigo: 'bg-indigo-50 border-indigo-200',
            amber: 'bg-amber-50 border-amber-200',
            purple: 'bg-purple-50 border-purple-200'
          };

          return (
            <div key={category.name} className={`p-4 rounded-lg border ${colorStyles[category.color]}`}>
              <h5 className="font-semibold text-slate-700 mb-3">{category.name}</h5>
              <div className="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                {category.positions.map(pos => {
                  const count = getPositionCount(category.teamKey, pos.key);
                  return (
                    <div key={pos.key} className="text-center p-2 bg-white rounded border border-slate-200">
                      <div className="text-lg font-bold text-slate-800">{count}</div>
                      <div className="text-xs text-slate-500">{pos.display}</div>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>

      {/* Missing GES Warning */}
      {qualStats.missingGES && qualStats.missingGES.length > 0 && (
        <div className="p-4 bg-rose-50 rounded-lg border border-rose-200">
          <div className="flex items-center gap-2 mb-3">
            <Icon name="AlertTriangle" className="w-5 h-5 text-rose-600" />
            <h5 className="font-semibold text-rose-700">Members Without GES</h5>
          </div>
          <p className="text-sm text-rose-600 mb-3">
            These members cannot participate in ES operations without General Emergency Services (GES) qualification.
          </p>
          <div className="space-y-1">
            {qualStats.missingGES.slice(0, 10).map(m => (
              <div key={m.capid} className="text-sm text-rose-800">
                {m.rank} {m.name}
              </div>
            ))}
            {qualStats.missingGES.length > 10 && (
              <div className="text-sm text-rose-600">+{qualStats.missingGES.length - 10} more</div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

/**
 * Expirations Tab - Calendar/timeline view of upcoming expirations
 */
const ESModalExpirationsTab = ({ esAnalysis }) => {
  const expiring = esAnalysis.qualifications.expiringWithin90Days;

  // Group by urgency
  const critical = expiring.filter(e => e.urgency === 'critical');
  const warning = expiring.filter(e => e.urgency === 'warning');
  const notice = expiring.filter(e => e.urgency === 'notice');

  const ExpirationList = ({ items, urgencyLabel, bgColor, textColor, borderColor }) => (
    <div className={`p-4 rounded-lg border ${bgColor} ${borderColor}`}>
      <div className="flex items-center justify-between mb-3">
        <h5 className={`font-semibold ${textColor}`}>{urgencyLabel}</h5>
        <span className={`text-sm font-bold ${textColor}`}>{items.length}</span>
      </div>
      {items.length === 0 ? (
        <p className="text-sm text-slate-500">None</p>
      ) : (
        <div className="space-y-2">
          {items.map((e, idx) => (
            <div key={`${e.capid}-${e.achvID}-${idx}`} className="flex items-center justify-between p-2 bg-white rounded border border-slate-200">
              <div>
                <div className="font-medium text-slate-800">{e.rank} {e.name}</div>
                <div className="text-xs text-slate-500">{e.qualification}</div>
              </div>
              <div className="text-right">
                <div className={`font-bold ${textColor}`}>{e.daysUntil} days</div>
                <div className="text-xs text-slate-500">{e.expiration}</div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );

  return (
    <div className="space-y-6">
      {/* Summary */}
      <div className="flex items-center gap-4 p-4 bg-slate-50 rounded-lg">
        <Icon name="Calendar" className="w-8 h-8 text-slate-400" />
        <div>
          <div className="text-lg font-bold text-slate-800">
            {expiring.length} Qualification{expiring.length !== 1 ? 's' : ''} Expiring
          </div>
          <div className="text-sm text-slate-600">Within the next 90 days</div>
        </div>
      </div>

      {/* By Urgency */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <ExpirationList
          items={critical}
          urgencyLabel="Critical (0-30 days)"
          bgColor="bg-rose-50"
          textColor="text-rose-700"
          borderColor="border-rose-200"
        />
        <ExpirationList
          items={warning}
          urgencyLabel="Warning (31-60 days)"
          bgColor="bg-amber-50"
          textColor="text-amber-700"
          borderColor="border-amber-200"
        />
        <ExpirationList
          items={notice}
          urgencyLabel="Notice (61-90 days)"
          bgColor="bg-yellow-50"
          textColor="text-yellow-700"
          borderColor="border-yellow-200"
        />
      </div>

      {/* No Expirations */}
      {expiring.length === 0 && (
        <div className="text-center py-8">
          <Icon name="CheckCircle" className="w-12 h-12 mx-auto mb-3 text-emerald-500" />
          <h4 className="text-lg font-semibold text-slate-800">All Clear</h4>
          <p className="text-sm text-slate-600">No qualifications expiring in the next 90 days</p>
        </div>
      )}
    </div>
  );
};

/**
 * Pipeline Tab - Members in training, near qualification
 */
const ESModalPipelineTab = ({ esAnalysis }) => {
  const pipeline = esAnalysis.pipeline;

  // Group training by position
  const trainingByPosition = useMemo(() => {
    const byPos = {};
    (pipeline.activeTraining || []).forEach(t => {
      if (!byPos[t.position]) {
        byPos[t.position] = [];
      }
      byPos[t.position].push(t);
    });
    return byPos;
  }, [pipeline.activeTraining]);

  return (
    <div className="space-y-6">
      {/* Summary */}
      <div className="flex items-center gap-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
        <Icon name="TrendingUp" className="w-8 h-8 text-indigo-600" />
        <div>
          <div className="text-lg font-bold text-indigo-800">
            {pipeline.activeTraining?.length || 0} Member{(pipeline.activeTraining?.length || 0) !== 1 ? 's' : ''} in Training
          </div>
          <div className="text-sm text-indigo-600">Actively working toward ES qualifications</div>
        </div>
      </div>

      {/* By Position */}
      {Object.keys(trainingByPosition).length > 0 ? (
        <div className="space-y-4">
          <h4 className="text-sm font-semibold text-slate-700">Training by Qualification</h4>
          {Object.entries(trainingByPosition).map(([position, members]) => (
            <div key={position} className="p-4 bg-white rounded-lg border border-slate-200">
              <div className="flex items-center justify-between mb-3">
                <h5 className="font-semibold text-slate-700">{position}</h5>
                <span className="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-bold rounded-full">
                  {members.length} training
                </span>
              </div>
              <div className="space-y-2">
                {members.map((m, idx) => (
                  <div key={`${m.capid}-${idx}`} className="flex items-center justify-between p-2 bg-slate-50 rounded">
                    <div>
                      <span className="font-medium text-slate-800">{m.rank} {m.name}</span>
                      <span className="text-xs text-slate-500 ml-2">({m.capid})</span>
                    </div>
                    <span className="text-xs text-indigo-600">Training for: {m.qualification}</span>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div className="text-center py-8">
          <Icon name="BookOpen" className="w-12 h-12 mx-auto mb-3 text-slate-300" />
          <h4 className="text-lg font-semibold text-slate-800">No Active Training</h4>
          <p className="text-sm text-slate-600">No members are currently training for ES qualifications</p>
          <p className="text-sm text-slate-500 mt-2">Consider starting training for positions with gaps</p>
        </div>
      )}

      {/* Training Recommendations */}
      <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
        <div className="flex items-center gap-2 mb-3">
          <Icon name="Lightbulb" className="w-5 h-5 text-slate-600" />
          <h5 className="font-semibold text-slate-700">Training Priorities</h5>
        </div>
        <div className="space-y-2 text-sm text-slate-600">
          {esAnalysis.teams.fieldOps?.gaps?.length > 0 && (
            <div className="flex items-center gap-2">
              <Icon name="ArrowRight" className="w-4 h-4 text-slate-400" />
              <span>Field Ops: {esAnalysis.teams.fieldOps.gaps.join(', ')}</span>
            </div>
          )}
          {esAnalysis.teams.aircrew?.gaps?.length > 0 && (
            <div className="flex items-center gap-2">
              <Icon name="ArrowRight" className="w-4 h-4 text-slate-400" />
              <span>Aircrew: {esAnalysis.teams.aircrew.gaps.join(', ')}</span>
            </div>
          )}
          {esAnalysis.teams.suas?.gaps?.length > 0 && (
            <div className="flex items-center gap-2">
              <Icon name="ArrowRight" className="w-4 h-4 text-slate-400" />
              <span>sUAS: {esAnalysis.teams.suas.gaps.join(', ')}</span>
            </div>
          )}
          {esAnalysis.evaluators.gaps.length > 0 && (
            <div className="flex items-center gap-2">
              <Icon name="ArrowRight" className="w-4 h-4 text-slate-400" />
              <span>Need evaluators for: {esAnalysis.evaluators.gaps.slice(0, 3).join(', ')}</span>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

/**
 * Insights Tab - SAREX planning recommendations, training priorities
 */
const ESModalInsightsTab = ({ esAnalysis }) => {
  const recommendations = esAnalysis.risks.recommendations || [];

  // Priority color mapping
  const priorityStyles = {
    critical: { bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-700', badge: 'bg-rose-100 text-rose-800' },
    high: { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700', badge: 'bg-amber-100 text-amber-800' },
    medium: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', badge: 'bg-blue-100 text-blue-800' },
    low: { bg: 'bg-slate-50', border: 'border-slate-200', text: 'text-slate-700', badge: 'bg-slate-100 text-slate-800' }
  };

  return (
    <div className="space-y-6">
      {/* Key Insights */}
      <div className="grid grid-cols-2 gap-4">
        <div className="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
          <Icon name="ThumbsUp" className="w-6 h-6 text-emerald-600 mb-2" />
          <h5 className="font-semibold text-emerald-700 mb-2">Strengths</h5>
          <ul className="space-y-1 text-sm text-emerald-600">
            {esAnalysis.teams.fieldOps?.canFieldGround && <li>âœ“ Can field ground team</li>}
            {esAnalysis.teams.fieldOps?.canFieldUDF && <li>âœ“ Can field UDF team</li>}
            {esAnalysis.teams.aircrew?.canField && <li>âœ“ Can field aircrew</li>}
            {esAnalysis.teams.suas?.canField && <li>âœ“ sUAS capability</li>}
            {esAnalysis.teams.command?.hasIC && <li>âœ“ IC available</li>}
            {esAnalysis.evaluators?.coverage >= 50 && <li>âœ“ Good potential evaluator coverage</li>}
            {esAnalysis.qualifications?.expiringWithin90Days?.length === 0 && <li>âœ“ No expiring qualifications</li>}
          </ul>
        </div>
        <div className="p-4 bg-amber-50 rounded-lg border border-amber-200">
          <Icon name="AlertTriangle" className="w-6 h-6 text-amber-600 mb-2" />
          <h5 className="font-semibold text-amber-700 mb-2">Areas for Improvement</h5>
          <ul className="space-y-1 text-sm text-amber-600">
            {!esAnalysis.teams.fieldOps?.canField && <li>â€¢ Cannot field ground/UDF team</li>}
            {!esAnalysis.teams.aircrew?.canField && <li>â€¢ Cannot field aircrew</li>}
            {!esAnalysis.teams.suas?.canField && <li>â€¢ No sUAS capability</li>}
            {esAnalysis.risks?.singlePointsOfFailure?.length > 0 && <li>â€¢ Single points of failure</li>}
            {esAnalysis.evaluators?.coverage < 50 && <li>â€¢ Limited potential evaluator coverage</li>}
            {esAnalysis.qualifications?.missingGES?.length > 0 && <li>â€¢ Members without GES</li>}
          </ul>
        </div>
      </div>

      {/* Recommendations */}
      <div>
        <h4 className="text-sm font-semibold text-slate-700 mb-3">Recommendations</h4>
        {recommendations.length > 0 ? (
          <div className="space-y-3">
            {recommendations.map((rec, idx) => {
              const style = priorityStyles[rec.priority] || priorityStyles.medium;
              return (
                <div key={idx} className={`p-4 rounded-lg border ${style.bg} ${style.border}`}>
                  <div className="flex items-start gap-3">
                    <span className={`px-2 py-0.5 text-xs font-bold rounded ${style.badge}`}>
                      {rec.priority.toUpperCase()}
                    </span>
                    <div className="flex-1">
                      <div className={`font-medium ${style.text}`}>{rec.recommendation}</div>
                      {rec.impact && (
                        <div className="text-sm text-slate-500 mt-1">
                          <span className="font-medium">Impact:</span> {rec.impact}
                        </div>
                      )}
                      {rec.area && (
                        <div className="text-xs text-slate-400 mt-1">Area: {rec.area}</div>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        ) : (
          <div className="text-center py-8">
            <Icon name="CheckCircle" className="w-12 h-12 mx-auto mb-3 text-emerald-500" />
            <h4 className="text-lg font-semibold text-slate-800">Looking Good!</h4>
            <p className="text-sm text-slate-600">No critical recommendations at this time</p>
          </div>
        )}
      </div>

      {/* SAREX Planning */}
      <div className="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
        <div className="flex items-center gap-2 mb-3">
          <Icon name="Target" className="w-5 h-5 text-indigo-600" />
          <h5 className="font-semibold text-indigo-700">SAREX Planning Suggestions</h5>
        </div>
        <div className="space-y-2 text-sm text-indigo-600">
          {esAnalysis.pipeline.activeTraining.length > 0 && (
            <div className="flex items-start gap-2">
              <Icon name="CheckSquare" className="w-4 h-4 mt-0.5" />
              <span>Include training scenarios for {esAnalysis.pipeline.activeTraining.length} member(s) in training</span>
            </div>
          )}
          {esAnalysis.evaluators.gaps.length > 0 && (
            <div className="flex items-start gap-2">
              <Icon name="CheckSquare" className="w-4 h-4 mt-0.5" />
              <span>Request external evaluators for: {esAnalysis.evaluators.gaps.slice(0, 2).join(', ')}</span>
            </div>
          )}
          {esAnalysis.risks.singlePointsOfFailure.length > 0 && (
            <div className="flex items-start gap-2">
              <Icon name="CheckSquare" className="w-4 h-4 mt-0.5" />
              <span>Cross-train backup personnel for SPOF positions</span>
            </div>
          )}
          <div className="flex items-start gap-2">
            <Icon name="CheckSquare" className="w-4 h-4 mt-0.5" />
            <span>Focus exercises on team types unit can field: {
              [
                esAnalysis.teams.fieldOps?.canFieldGround && 'Ground',
                esAnalysis.teams.fieldOps?.canFieldUDF && 'UDF',
                esAnalysis.teams.aircrew?.canField && 'Air',
                esAnalysis.teams.suas?.canField && 'sUAS'
              ].filter(Boolean).join(', ') || 'None currently'
            }</span>
          </div>
        </div>
      </div>
    </div>
  );
};
</script>

<script type="text/babel">
/**
 * ModalRecruitingRetention - Detailed Recruiting & Retention Analysis Modal
 *
 * Features:
 * - Time series charts (membership trend, recruiting/renewal breakdown)
 * - Seasonality analysis
 * - Component breakdown of sustainability score
 * - Risk indicators
 * - Commander-friendly insights
 */
const { useRef: useRefRR, useCallback: useCallbackRR } = React;

/**
 * ModalHelpTooltip - Tooltip that works reliably in modals with proper z-index
 */
const ModalHelpTooltip = ({ explanation, children, position = 'top' }) => {
  const [isVisible, setIsVisible] = useState(false);
  const [coords, setCoords] = useState({ top: 0, left: 0 });
  const triggerRef = useRefRR(null);

  const handleMouseEnter = () => {
    if (triggerRef.current) {
      const rect = triggerRef.current.getBoundingClientRect();
      // Position above the trigger element
      setCoords({
        top: rect.top - 8,
        left: rect.left + rect.width / 2
      });
    }
    setIsVisible(true);
  };

  if (!explanation) return children || null;

  return (
    <>
      <span
        ref={triggerRef}
        className="inline-flex items-center cursor-help ml-1"
        onMouseEnter={handleMouseEnter}
        onMouseLeave={() => setIsVisible(false)}
      >
        <Icon name="HelpCircle" className="w-3.5 h-3.5 text-slate-400 hover:text-slate-600" />
      </span>
      {isVisible && (
        <div
          className="fixed z-[100] transform -translate-x-1/2 -translate-y-full pointer-events-none"
          style={{ top: coords.top, left: coords.left }}
        >
          <div className="bg-slate-800 text-white text-xs rounded-lg shadow-xl p-3 max-w-xs">
            <div className="font-bold mb-1">{explanation.label}</div>
            <div className="text-slate-300 mb-2">{explanation.fullDesc || explanation.shortDesc}</div>
            {explanation.goodValue && (
              <div className="text-emerald-300 text-[10px]">
                Target: {explanation.goodValue}
              </div>
            )}
            {explanation.formula && (
              <div className="text-slate-400 text-[10px] mt-1 pt-1 border-t border-slate-600">
                {explanation.formula}
              </div>
            )}
          </div>
          <div className="w-3 h-3 bg-slate-800 transform rotate-45 mx-auto -mt-1.5"></div>
        </div>
      )}
    </>
  );
};

const RecruitingRetentionModal = ({
  isOpen,
  onClose,
  metrics,
  unitFilter,
  showAllDescendants,
  timeRange,
  orgStatsService,
  descendantOrgIds,
  dataFiles
}) => {
  const [activeTab, setActiveTab] = useState('overview');
  const [mbrTypeFilter, setMbrTypeFilter] = useState('combined');
  const [localTimeRange, setLocalTimeRange] = useState(timeRange || 12);
  const [unitTableSort, setUnitTableSort] = useState({ field: 'sustainabilityScore', direction: 'desc' });
  const chartRefs = useRefRR({});

  // Get unit name helper
  const getUnitName = useCallbackRR((orgId) => {
    const org = (dataFiles?.organization || []).find(o =>
      String(o.ORGID || '').trim() === String(orgId || '').trim()
    );
    if (!org) return `Unit ${orgId}`;
    const cleanUnit = org.Unit ? org.Unit.replace(/^0+/, '').padStart(3, '0') : '000';
    return `${org.Region || ''}-${org.Wing || ''}-${cleanUnit}`;
  }, [dataFiles?.organization]);

  // Get metrics for all subordinate units (for "By Unit" tab)
  const subordinateUnitMetrics = useMemo(() => {
    if (!showAllDescendants || !orgStatsService || !descendantOrgIds?.length) return [];

    // Filter to only operational units (exclude command HQs)
    const operationalUnits = descendantOrgIds.filter(orgId => {
      const org = (dataFiles?.organization || []).find(o =>
        String(o.ORGID || '').trim() === String(orgId || '').trim()
      );
      const type = String(org?.Type || '').toUpperCase();
      const isHQ = type.includes('GROUP') || type.includes('WING') ||
                   type.includes('REGION') || type.includes('NATIONAL');
      return !isHQ;
    });

    return orgStatsService.getMetricsForMultipleUnits(operationalUnits, {
      timeRangeMonths: localTimeRange
    });
  }, [showAllDescendants, orgStatsService, descendantOrgIds, dataFiles?.organization, localTimeRange]);

  // Sort unit metrics
  const sortedUnitMetrics = useMemo(() => {
    if (!subordinateUnitMetrics.length) return [];

    return [...subordinateUnitMetrics].sort((a, b) => {
      let aVal, bVal;

      if (unitTableSort.field === 'name') {
        aVal = getUnitName(a.orgId);
        bVal = getUnitName(b.orgId);
      } else {
        aVal = a[unitTableSort.field] ?? -Infinity;
        bVal = b[unitTableSort.field] ?? -Infinity;
      }

      if (typeof aVal === 'string') {
        return unitTableSort.direction === 'asc'
          ? aVal.localeCompare(bVal)
          : bVal.localeCompare(aVal);
      }

      return unitTableSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
    });
  }, [subordinateUnitMetrics, unitTableSort, getUnitName]);

  const handleUnitTableSort = (field) => {
    setUnitTableSort(prev => ({
      field,
      direction: prev.field === field && prev.direction === 'desc' ? 'asc' : 'desc'
    }));
  };

  // Recalculate metrics when filters change
  const displayMetrics = useMemo(() => {
    if (!orgStatsService || !unitFilter) return metrics;

    return orgStatsService.getMetricsForUnit(unitFilter, {
      includeDescendants: showAllDescendants,
      descendantOrgIds: descendantOrgIds || [],
      timeRangeMonths: localTimeRange,
      mbrType: mbrTypeFilter
    });
  }, [orgStatsService, unitFilter, showAllDescendants, descendantOrgIds, localTimeRange, mbrTypeFilter, metrics]);

  // Destroy charts on close or filter change
  const destroyCharts = useCallbackRR(() => {
    Object.values(chartRefs.current).forEach(chart => {
      if (chart && typeof chart.destroy === 'function') {
        chart.destroy();
      }
    });
    chartRefs.current = {};
  }, []);

  // Initialize charts when modal opens or tab changes
  useEffect(() => {
    if (!isOpen || !displayMetrics?.monthlyData?.length) {
      destroyCharts();
      return;
    }

    destroyCharts();

    // Small delay to ensure DOM is ready
    const timer = setTimeout(() => {
      if (activeTab === 'overview' || activeTab === 'trends') {
        initializeMembershipTrendChart();
      }
      if (activeTab === 'trends') {
        initializeRecruitingBreakdownChart();
      }
      if (activeTab === 'seasonality') {
        initializeSeasonalityChart();
      }
      if (activeTab === 'overview') {
        initializeComponentsChart();
      }
    }, 150);

    return () => {
      clearTimeout(timer);
    };
  }, [isOpen, displayMetrics, activeTab, mbrTypeFilter]);

  // Cleanup on unmount
  useEffect(() => {
    return () => destroyCharts();
  }, [destroyCharts]);

  const initializeMembershipTrendChart = () => {
    const canvas = document.getElementById('chart-membership-trend');
    if (!canvas || !displayMetrics?.monthlyData || !window.Chart) return;

    const ctx = canvas.getContext('2d');
    const data = displayMetrics.monthlyData;

    chartRefs.current.trend = new window.Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => d.label || d.date),
        datasets: [
          {
            label: 'Total Members',
            data: data.map(d => d[mbrTypeFilter]?.total || 0),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              afterBody: (context) => {
                const idx = context[0].dataIndex;
                const d = data[idx];
                return [
                  `New: ${d[mbrTypeFilter]?.new || 0}`,
                  `Renewed: ${d[mbrTypeFilter]?.renew || 0}`,
                  `Rejoined: ${d[mbrTypeFilter]?.rejoin || 0}`
                ];
              }
            }
          }
        },
        scales: {
          y: { beginAtZero: false },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45,
              font: { size: 10 }
            }
          }
        }
      }
    });
  };

  const initializeRecruitingBreakdownChart = () => {
    const canvas = document.getElementById('chart-recruiting-breakdown');
    if (!canvas || !displayMetrics?.monthlyData || !window.Chart) return;

    const ctx = canvas.getContext('2d');
    const data = displayMetrics.monthlyData;

    chartRefs.current.breakdown = new window.Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.map(d => d.label || d.date),
        datasets: [
          {
            label: 'New Members',
            data: data.map(d => d[mbrTypeFilter]?.new || 0),
            backgroundColor: '#22c55e',
            stack: 'recruiting'
          },
          {
            label: 'Rejoins',
            data: data.map(d => d[mbrTypeFilter]?.rejoin || 0),
            backgroundColor: '#eab308',
            stack: 'recruiting'
          },
          {
            label: 'Renewals',
            data: data.map(d => d[mbrTypeFilter]?.renew || 0),
            backgroundColor: '#3b82f6',
            stack: 'retention'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' }
        },
        scales: {
          x: {
            stacked: true,
            ticks: {
              maxRotation: 45,
              minRotation: 45,
              font: { size: 10 }
            }
          },
          y: { stacked: true, beginAtZero: true }
        }
      }
    });
  };

  const initializeSeasonalityChart = () => {
    const canvas = document.getElementById('chart-seasonality');
    if (!canvas || !displayMetrics?.metrics?.seasonality || !window.Chart) return;

    const ctx = canvas.getContext('2d');
    const patterns = displayMetrics.metrics.seasonality.patterns;

    chartRefs.current.seasonality = new window.Chart(ctx, {
      type: 'bar',
      data: {
        labels: patterns.map(p => p.month),
        datasets: [
          {
            label: 'Avg Recruiting',
            data: patterns.map(p => p.avgRecruiting.toFixed(1)),
            backgroundColor: '#22c55e'
          },
          {
            label: 'Avg Renewals',
            data: patterns.map(p => p.avgRenewals.toFixed(1)),
            backgroundColor: '#3b82f6'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  };

  const initializeComponentsChart = () => {
    const canvas = document.getElementById('chart-sustainability-components');
    if (!canvas || !displayMetrics?.metrics?.sustainability || !window.Chart) return;

    const ctx = canvas.getContext('2d');
    const components = displayMetrics.metrics.sustainability.components;

    chartRefs.current.components = new window.Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['Recruiting', 'Retention', 'Growth', 'Stability'],
        datasets: [{
          label: 'Score',
          data: [components.recruiting, components.retention, components.growth, components.stability],
          backgroundColor: 'rgba(59, 130, 246, 0.2)',
          borderColor: '#3b82f6',
          borderWidth: 2,
          pointBackgroundColor: '#3b82f6'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            beginAtZero: true,
            max: 100,
            ticks: { stepSize: 20 }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  };

  // Tabs - include "By Unit" tab when showing aggregate data
  // NOTE: Must be defined before conditional return to comply with React hooks rules
  const tabs = useMemo(() => {
    const baseTabs = [
      { id: 'overview', label: 'Overview', icon: 'LayoutDashboard' },
      { id: 'trends', label: 'Trends', icon: 'TrendingUp' },
      { id: 'seasonality', label: 'Seasonality', icon: 'Calendar' },
      { id: 'insights', label: 'Insights', icon: 'Lightbulb' }
    ];

    // Add "By Unit" tab when in aggregate mode with subordinate units
    if (showAllDescendants && subordinateUnitMetrics.length > 0) {
      baseTabs.splice(1, 0, { id: 'byunit', label: 'By Unit', icon: 'LayoutList' });
    }

    return baseTabs;
  }, [showAllDescendants, subordinateUnitMetrics.length]);

  const timeRangeOptions = [
    { value: 6, label: '6 Months' },
    { value: 12, label: '12 Months' },
    { value: 24, label: '2 Years' },
    { value: 60, label: '5 Years' },
    { value: 120, label: '10 Years' },
    { value: 0, label: 'All Time' }
  ];

  if (!isOpen) return null;

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Recruiting & Retention Analysis" maxWidthClass="max-w-6xl">
      <div className="space-y-6">
        {/* Filters */}
        <div className="flex flex-wrap items-center justify-between gap-4 pb-4 border-b border-slate-200">
          <div className="flex items-center gap-4">
            <div>
              <label className="text-xs font-semibold text-slate-500 uppercase block mb-1">Time Range</label>
              <select
                value={localTimeRange}
                onChange={(e) => setLocalTimeRange(parseInt(e.target.value))}
                className="block w-full rounded-lg border-slate-300 text-sm py-1.5 px-2 bg-white border"
              >
                {timeRangeOptions.map(opt => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="text-xs font-semibold text-slate-500 uppercase block mb-1">Member Type</label>
              <select
                value={mbrTypeFilter}
                onChange={(e) => setMbrTypeFilter(e.target.value)}
                className="block w-full rounded-lg border-slate-300 text-sm py-1.5 px-2 bg-white border"
              >
                <option value="combined">All Members</option>
                <option value="senior">Senior Only</option>
                <option value="cadet">Cadets Only</option>
              </select>
            </div>
          </div>
          <div className="flex gap-1">
            {tabs.map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                  activeTab === tab.id
                    ? 'bg-slate-800 text-white'
                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                }`}
              >
                <Icon name={tab.icon} className="w-4 h-4" />
                <span className="hidden sm:inline">{tab.label}</span>
              </button>
            ))}
          </div>
        </div>

        {/* Tab Content */}
        {activeTab === 'overview' && displayMetrics && (
          <div className="space-y-6">
            {/* What This Shows - Explanation Box */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div className="flex items-start gap-3">
                <Icon name="Info" className="w-5 h-5 text-blue-600 mt-0.5 shrink-0" />
                <div className="text-sm text-blue-800">
                  <p className="font-medium mb-1">What does this dashboard show?</p>
                  <p className="text-blue-700">
                    This analysis tracks your unit's membership health over time. The Sustainability Score combines
                    <strong> recruiting</strong> (how many new members join),
                    <strong> retention</strong> (how many stay),
                    <strong> growth</strong> (net change), and
                    <strong> stability</strong> (consistency) into a single health indicator.
                    Hover over the <Icon name="HelpCircle" className="inline w-3 h-3 mx-0.5" /> icons for more details on each metric.
                  </p>
                </div>
              </div>
            </div>

            {/* Sustainability Score Hero */}
            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6">
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div>
                  <h3 className="text-lg font-bold text-slate-800">Sustainability Score</h3>
                  <p className="text-sm text-slate-600 mt-1">
                    {displayMetrics.metrics.sustainability?.summary || 'Analyzing membership health...'}
                  </p>
                  {displayMetrics.metrics.sustainability?.focusArea && displayMetrics.metrics.sustainability.focusArea.score < 70 && (
                    <p className="text-sm text-amber-700 mt-2 font-medium">
                      <Icon name="Lightbulb" className="inline w-4 h-4 mr-1" />
                      Focus on improving <strong>{displayMetrics.metrics.sustainability.focusArea.label}</strong> (your lowest component) for the biggest impact.
                    </p>
                  )}
                </div>
                <div className="text-right">
                  <div className="text-5xl font-bold text-slate-900">
                    {displayMetrics.metrics.sustainability?.overallScore ?? '--'}
                  </div>
                  <div className="text-sm font-medium text-slate-500">out of 100</div>
                </div>
              </div>
              <div className="mt-4">
                <SustainabilityGauge
                  score={displayMetrics.metrics.sustainability?.overallScore}
                  rating={displayMetrics.metrics.sustainability?.rating}
                />
              </div>
            </div>

            {/* Component Scores - with explanations */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="bg-white rounded-lg border border-slate-200 p-4 group relative">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-xs font-semibold text-slate-500 uppercase flex items-center">
                      Recruiting
                      <ModalHelpTooltip explanation={displayMetrics.metrics.recruiting?.explanation} />
                    </div>
                    <div className="text-2xl font-bold text-slate-900 mt-1">
                      {displayMetrics.metrics.sustainability?.components?.recruiting ?? '--'}
                    </div>
                  </div>
                  <div className="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                    <Icon name="UserPlus" className="w-5 h-5" />
                  </div>
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  {displayMetrics.metrics.recruiting?.monthlyAverage || '0'} new/mo avg
                </p>
                <p className="text-[10px] text-emerald-600 mt-1">
                  Target: 2+ per month
                </p>
              </div>

              <div className="bg-white rounded-lg border border-slate-200 p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-xs font-semibold text-slate-500 uppercase flex items-center">
                      Retention
                      <ModalHelpTooltip explanation={displayMetrics.metrics.retention?.explanation} />
                    </div>
                    <div className="text-2xl font-bold text-slate-900 mt-1">
                      {displayMetrics.metrics.sustainability?.components?.retention ?? '--'}
                    </div>
                  </div>
                  <div className="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                    <Icon name="Users" className="w-5 h-5" />
                  </div>
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  {displayMetrics.metrics.retention?.retentionRate !== null ? `${displayMetrics.metrics.retention.retentionRate}%` : '--'} renewal rate
                </p>
                <p className="text-[10px] text-emerald-600 mt-1">
                  Target: 80%+
                </p>
              </div>

              <div className="bg-white rounded-lg border border-slate-200 p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-xs font-semibold text-slate-500 uppercase flex items-center">
                      Growth
                      <ModalHelpTooltip explanation={displayMetrics.metrics.growth?.explanation} />
                    </div>
                    <div className="text-2xl font-bold text-slate-900 mt-1">
                      {displayMetrics.metrics.sustainability?.components?.growth ?? '--'}
                    </div>
                  </div>
                  <div className="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center">
                    <Icon name="TrendingUp" className="w-5 h-5" />
                  </div>
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  {(displayMetrics.metrics.growth?.netChangeInPeriod || 0) > 0 ? '+' : ''}
                  {displayMetrics.metrics.growth?.netChangeInPeriod || 0} members
                </p>
                <p className="text-[10px] text-emerald-600 mt-1">
                  Target: Positive growth
                </p>
              </div>

              <div className="bg-white rounded-lg border border-slate-200 p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-xs font-semibold text-slate-500 uppercase flex items-center">
                      Stability
                      <ModalHelpTooltip explanation={displayMetrics.metrics.volatility?.explanation} />
                    </div>
                    <div className="text-2xl font-bold text-slate-900 mt-1">
                      {displayMetrics.metrics.sustainability?.components?.stability ?? '--'}
                    </div>
                  </div>
                  <div className="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center">
                    <Icon name="Activity" className="w-5 h-5" />
                  </div>
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  {displayMetrics.metrics.volatility?.stabilityRating
                    ? displayMetrics.metrics.volatility.stabilityRating.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())
                    : 'Unknown'}
                </p>
                <p className="text-[10px] text-emerald-600 mt-1">
                  Target: &lt;10% variation
                </p>
              </div>
            </div>

            {/* Charts Row */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              {/* Trend Chart */}
              <div className="bg-white rounded-lg border border-slate-200 p-4">
                <h4 className="font-semibold text-slate-800 mb-4">Membership Trend</h4>
                <div className="h-64">
                  <canvas id="chart-membership-trend"></canvas>
                </div>
              </div>

              {/* Radar Chart */}
              <div className="bg-white rounded-lg border border-slate-200 p-4">
                <h4 className="font-semibold text-slate-800 mb-4">Component Analysis</h4>
                <div className="h-64">
                  <canvas id="chart-sustainability-components"></canvas>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* By Unit Tab - shows individual unit metrics in aggregate mode */}
        {activeTab === 'byunit' && showAllDescendants && sortedUnitMetrics.length > 0 && (
          <div className="space-y-6">
            {/* Explanation */}
            <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
              <div className="flex items-start gap-3">
                <Icon name="LayoutList" className="w-5 h-5 text-indigo-600 mt-0.5 shrink-0" />
                <div className="text-sm text-indigo-800">
                  <p className="font-medium mb-1">Unit-by-Unit Breakdown</p>
                  <p className="text-indigo-700">
                    This table shows recruiting and retention metrics for each subordinate unit.
                    Click column headers to sort. Use this to identify which units need support
                    and which are performing well.
                  </p>
                </div>
              </div>
            </div>

            {/* Summary Stats */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="bg-blue-50 rounded-lg p-4 border border-blue-100">
                <div className="text-xs font-semibold text-blue-700 uppercase">Total Units</div>
                <div className="text-2xl font-bold text-blue-900 mt-1">{sortedUnitMetrics.length}</div>
              </div>
              <div className="bg-emerald-50 rounded-lg p-4 border border-emerald-100">
                <div className="text-xs font-semibold text-emerald-700 uppercase">Growing Units</div>
                <div className="text-2xl font-bold text-emerald-900 mt-1">
                  {sortedUnitMetrics.filter(u => u.growthStatus === 'growing').length}
                </div>
              </div>
              <div className="bg-rose-50 rounded-lg p-4 border border-rose-100">
                <div className="text-xs font-semibold text-rose-700 uppercase">Declining Units</div>
                <div className="text-2xl font-bold text-rose-900 mt-1">
                  {sortedUnitMetrics.filter(u => u.growthStatus === 'declining').length}
                </div>
              </div>
              <div className="bg-amber-50 rounded-lg p-4 border border-amber-100">
                <div className="text-xs font-semibold text-amber-700 uppercase">Needs Attention</div>
                <div className="text-2xl font-bold text-amber-900 mt-1">
                  {sortedUnitMetrics.filter(u => u.sustainabilityRating === 'needs-attention' || u.sustainabilityRating === 'fair').length}
                </div>
              </div>
            </div>

            {/* Unit Comparison Table */}
            <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-slate-50 border-b border-slate-200">
                    <tr>
                      {[
                        { field: 'name', label: 'Unit', className: 'min-w-[180px]' },
                        { field: 'currentTotal', label: 'Members' },
                        { field: 'sustainabilityScore', label: 'Score' },
                        { field: 'retentionRate', label: 'Retention' },
                        { field: 'recruitingRate', label: 'Recruiting' },
                        { field: 'netChange', label: 'Growth' }
                      ].map(col => (
                        <th
                          key={col.field}
                          className={`px-3 py-2.5 text-left text-xs font-bold text-slate-600 uppercase tracking-wide cursor-pointer hover:bg-slate-100 transition-colors ${col.className || ''}`}
                          onClick={() => handleUnitTableSort(col.field)}
                        >
                          <div className="flex items-center gap-1">
                            {col.label}
                            {unitTableSort.field === col.field && (
                              <Icon
                                name={unitTableSort.direction === 'asc' ? 'ChevronUp' : 'ChevronDown'}
                                className="w-3 h-3"
                              />
                            )}
                          </div>
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {sortedUnitMetrics.map((unit, idx) => {
                      const getSustainabilityColor = (rating) => {
                        switch (rating) {
                          case 'excellent': return 'text-emerald-700 bg-emerald-100';
                          case 'good': return 'text-blue-700 bg-blue-100';
                          case 'fair': return 'text-amber-700 bg-amber-100';
                          case 'needs-attention': return 'text-rose-700 bg-rose-100';
                          default: return 'text-slate-500 bg-slate-100';
                        }
                      };
                      const getGrowthIcon = (status) => {
                        switch (status) {
                          case 'growing': return { icon: 'TrendingUp', color: 'text-emerald-600' };
                          case 'declining': return { icon: 'TrendingDown', color: 'text-rose-600' };
                          default: return { icon: 'Minus', color: 'text-slate-400' };
                        }
                      };
                      const growth = getGrowthIcon(unit.growthStatus);
                      const unitName = getUnitName(unit.orgId);

                      return (
                        <tr
                          key={unit.orgId}
                          className={`hover:bg-slate-50 transition-colors ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-25'}`}
                        >
                          <td className="px-3 py-2.5">
                            <div className="font-medium text-slate-800 text-sm">{unitName}</div>
                            <div className="text-xs text-slate-500">
                              {unit.memberBreakdown && `${unit.memberBreakdown.senior} Sr / ${unit.memberBreakdown.cadet} Cdt`}
                            </div>
                          </td>
                          <td className="px-3 py-2.5 text-sm font-semibold text-slate-800">
                            {unit.currentTotal}
                          </td>
                          <td className="px-3 py-2.5">
                            <span className={`inline-flex px-2 py-0.5 rounded-full text-xs font-bold ${getSustainabilityColor(unit.sustainabilityRating)}`}>
                              {unit.sustainabilityScore ?? '--'}
                            </span>
                          </td>
                          <td className="px-3 py-2.5 text-sm">
                            {unit.retentionRate !== null ? (
                              <span className={unit.retentionRate >= 80 ? 'text-emerald-600' : unit.retentionRate >= 60 ? 'text-amber-600' : 'text-rose-600'}>
                                {unit.retentionRate}%
                              </span>
                            ) : (
                              <span className="text-slate-400">--</span>
                            )}
                          </td>
                          <td className="px-3 py-2.5 text-sm text-slate-700">
                            {unit.recruitingRate !== null ? `${unit.recruitingRate}/mo` : '--'}
                          </td>
                          <td className="px-3 py-2.5">
                            <div className="flex items-center gap-1">
                              <Icon name={growth.icon} className={`w-4 h-4 ${growth.color}`} />
                              <span className={`text-sm font-medium ${growth.color}`}>
                                {unit.netChange !== null ? (unit.netChange > 0 ? '+' : '') + unit.netChange : '--'}
                              </span>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Best and Worst Performers */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-emerald-50 rounded-lg border border-emerald-200 p-4">
                <h5 className="font-semibold text-emerald-800 mb-3 flex items-center gap-2">
                  <Icon name="Award" className="w-5 h-5" />
                  Top Performing Units
                </h5>
                <div className="space-y-2">
                  {sortedUnitMetrics.slice(0, 3).map((unit, idx) => (
                    <div key={unit.orgId} className="flex items-center justify-between bg-white rounded-lg px-3 py-2">
                      <div className="flex items-center gap-2">
                        <span className="w-6 h-6 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center text-xs font-bold">
                          {idx + 1}
                        </span>
                        <span className="text-sm font-medium text-slate-800">{getUnitName(unit.orgId)}</span>
                      </div>
                      <span className="text-sm font-bold text-emerald-700">{unit.sustainabilityScore}</span>
                    </div>
                  ))}
                </div>
              </div>
              <div className="bg-rose-50 rounded-lg border border-rose-200 p-4">
                <h5 className="font-semibold text-rose-800 mb-3 flex items-center gap-2">
                  <Icon name="AlertCircle" className="w-5 h-5" />
                  Units Needing Support
                </h5>
                <div className="space-y-2">
                  {[...sortedUnitMetrics].reverse().slice(0, 3).map((unit, idx) => (
                    <div key={unit.orgId} className="flex items-center justify-between bg-white rounded-lg px-3 py-2">
                      <div className="flex items-center gap-2">
                        <span className="w-6 h-6 rounded-full bg-rose-100 text-rose-700 flex items-center justify-center text-xs font-bold">
                          {sortedUnitMetrics.length - idx}
                        </span>
                        <span className="text-sm font-medium text-slate-800">{getUnitName(unit.orgId)}</span>
                      </div>
                      <span className="text-sm font-bold text-rose-700">{unit.sustainabilityScore ?? '--'}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'trends' && displayMetrics && (
          <div className="space-y-6">
            {/* Membership Trend Chart */}
            <div className="bg-white rounded-lg border border-slate-200 p-4">
              <h4 className="font-semibold text-slate-800 mb-4">Membership Trend</h4>
              <div className="h-72">
                <canvas id="chart-membership-trend"></canvas>
              </div>
            </div>

            {/* Recruiting Breakdown Chart */}
            <div className="bg-white rounded-lg border border-slate-200 p-4">
              <h4 className="font-semibold text-slate-800 mb-4">Recruiting & Retention Breakdown</h4>
              <div className="h-72">
                <canvas id="chart-recruiting-breakdown"></canvas>
              </div>
            </div>

            {/* Summary Stats */}
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
              <div className="bg-emerald-50 rounded-lg p-4 border border-emerald-100">
                <div className="text-xs font-semibold text-emerald-700 uppercase flex items-center">
                  New Members
                  <ModalHelpTooltip explanation={{
                    label: 'New Members',
                    fullDesc: 'Total count of brand new members who joined plus former members who rejoined during the selected time period.',
                    goodValue: 'At least 2 per month for squadrons',
                    formula: 'New Joins + Rejoins'
                  }} />
                </div>
                <div className="text-2xl font-bold text-emerald-900 mt-1">
                  {displayMetrics.metrics.recruiting?.totalInPeriod || 0}
                </div>
                <div className="text-xs text-emerald-600 mt-1">
                  {displayMetrics.metrics.recruiting?.monthlyAverage || 0}/mo avg
                </div>
              </div>
              <div className="bg-blue-50 rounded-lg p-4 border border-blue-100">
                <div className="text-xs font-semibold text-blue-700 uppercase flex items-center">
                  Renewals
                  <ModalHelpTooltip explanation={{
                    label: 'Renewals',
                    fullDesc: 'Count of existing members who renewed their annual membership during the time period. High renewals indicate member satisfaction.',
                    goodValue: 'Higher than attrition',
                    formula: 'Sum of all membership renewals'
                  }} />
                </div>
                <div className="text-2xl font-bold text-blue-900 mt-1">
                  {displayMetrics.metrics.retention?.renewalsInPeriod || 0}
                </div>
                <div className="text-xs text-blue-600 mt-1">
                  {displayMetrics.metrics.retention?.retentionRate || 0}% retention
                </div>
              </div>
              <div className="bg-amber-50 rounded-lg p-4 border border-amber-100">
                <div className="text-xs font-semibold text-amber-700 uppercase flex items-center">
                  Est. Attrition
                  <ModalHelpTooltip explanation={{
                    label: 'Estimated Attrition',
                    fullDesc: 'The estimated number of members your unit lost during this period through non-renewal, transfer, or other reasons. This is calculated from the difference between recruiting and net growth.',
                    goodValue: 'Lower than new members recruited',
                    formula: 'New Members Recruited - Net Growth'
                  }} />
                </div>
                <div className="text-2xl font-bold text-amber-900 mt-1">
                  {displayMetrics.metrics.retention?.estimatedAttrition || 0}
                </div>
                <div className="text-xs text-amber-600 mt-1">
                  members lost
                </div>
              </div>
              <div className="bg-rose-50 rounded-lg p-4 border border-rose-100">
                <div className="text-xs font-semibold text-rose-700 uppercase flex items-center">
                  Attrition Rate
                  <ModalHelpTooltip explanation={{
                    label: 'Annualized Attrition Rate',
                    fullDesc: 'The percentage of your membership lost annually. This helps predict how many new members you need to recruit each year just to maintain your current size.',
                    goodValue: 'Below 20% is healthy',
                    formula: '(Attrition Ã· Starting Total) Ã— 100%'
                  }} />
                </div>
                <div className="text-2xl font-bold text-rose-900 mt-1">
                  {displayMetrics.metrics.retention?.annualizedAttritionRate !== null
                    ? `${displayMetrics.metrics.retention.annualizedAttritionRate}%`
                    : '--'}
                </div>
                <div className="text-xs text-rose-600 mt-1">
                  per year
                </div>
              </div>
              <div className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <div className="text-xs font-semibold text-slate-600 uppercase flex items-center">
                  Data Points
                  <ModalHelpTooltip explanation={{
                    label: 'Data Points',
                    fullDesc: 'The number of monthly data points included in this analysis. More data points provide more reliable trends and seasonality patterns.',
                    goodValue: '24+ months for seasonality analysis'
                  }} />
                </div>
                <div className="text-2xl font-bold text-slate-900 mt-1">
                  {displayMetrics.summary?.dataPointCount || 0}
                </div>
                <div className="text-xs text-slate-500 mt-1">
                  months of data
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'seasonality' && displayMetrics?.metrics?.seasonality && (
          <div className="space-y-6">
            {/* Seasonality Chart */}
            <div className="bg-white rounded-lg border border-slate-200 p-4">
              <h4 className="font-semibold text-slate-800 mb-4">Seasonal Patterns (Historical Averages)</h4>
              <div className="h-72">
                <canvas id="chart-seasonality"></canvas>
              </div>
            </div>

            {/* Peak/Low Months */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-emerald-50 rounded-lg border border-emerald-200 p-4">
                <h5 className="font-semibold text-emerald-800 mb-3 flex items-center gap-2">
                  <Icon name="TrendingUp" className="w-5 h-5" />
                  Peak Recruiting Months
                </h5>
                <div className="flex gap-2 mb-3">
                  {displayMetrics.metrics.seasonality.peakMonths.map(month => (
                    <span key={month} className="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-sm font-medium">
                      {month}
                    </span>
                  ))}
                </div>
                <p className="text-sm text-emerald-700">
                  Plan recruiting drives during these months for maximum impact.
                </p>
              </div>
              <div className="bg-amber-50 rounded-lg border border-amber-200 p-4">
                <h5 className="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                  <Icon name="TrendingDown" className="w-5 h-5" />
                  Low Activity Months
                </h5>
                <div className="flex gap-2 mb-3">
                  {displayMetrics.metrics.seasonality.lowMonths.map(month => (
                    <span key={month} className="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium">
                      {month}
                    </span>
                  ))}
                </div>
                <p className="text-sm text-amber-700">
                  Focus on retention and engagement during these months.
                </p>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'seasonality' && !displayMetrics?.metrics?.seasonality && (
          <div className="text-center py-12 text-slate-500">
            <Icon name="Calendar" className="w-12 h-12 mx-auto mb-3 text-slate-300" />
            <h4 className="font-semibold text-slate-700 mb-1">Insufficient Data for Seasonality</h4>
            <p className="text-sm">At least 24 months of data is required to identify seasonal patterns.</p>
          </div>
        )}

        {activeTab === 'insights' && displayMetrics && (
          <div className="space-y-4">
            {/* What Are Insights - Explanation */}
            <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
              <div className="flex items-start gap-3">
                <Icon name="Lightbulb" className="w-5 h-5 text-indigo-600 mt-0.5 shrink-0" />
                <div className="text-sm text-indigo-800">
                  <p className="font-medium mb-1">How to use these insights</p>
                  <p className="text-indigo-700">
                    These insights highlight areas that need attention and provide specific recommendations.
                    Green cards indicate strengths to maintain. Amber and red cards show opportunities for improvement
                    with suggested actions you can take.
                  </p>
                </div>
              </div>
            </div>

            <h4 className="font-semibold text-slate-800">Commander Insights</h4>

            {/* Generated Insights */}
            <div className="space-y-3">
              {/* Growth vs Replacement */}
              {displayMetrics.metrics.growth && (
                <div className={`p-4 rounded-lg border ${
                  displayMetrics.metrics.growth.status === 'growing'
                    ? 'bg-emerald-50 border-emerald-200'
                    : displayMetrics.metrics.growth.status === 'declining'
                    ? 'bg-rose-50 border-rose-200'
                    : 'bg-slate-50 border-slate-200'
                }`}>
                  <div className="flex items-start gap-3">
                    <Icon
                      name={displayMetrics.metrics.growth.status === 'growing' ? 'TrendingUp' :
                            displayMetrics.metrics.growth.status === 'declining' ? 'TrendingDown' : 'Minus'}
                      className={`w-5 h-5 mt-0.5 ${
                        displayMetrics.metrics.growth.status === 'growing' ? 'text-emerald-600' :
                        displayMetrics.metrics.growth.status === 'declining' ? 'text-rose-600' : 'text-slate-500'
                      }`}
                    />
                    <div>
                      <h5 className="font-semibold text-slate-800">Growth Analysis</h5>
                      <p className="text-sm text-slate-600 mt-1">
                        Your unit {displayMetrics.metrics.growth.status === 'growing' ? 'grew by' :
                                   displayMetrics.metrics.growth.status === 'declining' ? 'declined by' : 'changed by'} {' '}
                        <strong>{Math.abs(displayMetrics.metrics.growth.netChangeInPeriod)} members</strong> over the selected time period.
                        {displayMetrics.metrics.growth.totalRecruited > 0 && (
                          <span> Of the {displayMetrics.metrics.growth.totalRecruited} members recruited, {displayMetrics.metrics.growth.growthRatio}% contributed to growth while {100 - displayMetrics.metrics.growth.growthRatio}% replaced members who left.</span>
                        )}
                      </p>
                      {displayMetrics.metrics.growth.status === 'declining' && (
                        <div className="mt-2 pt-2 border-t border-slate-200">
                          <p className="text-xs font-semibold text-slate-700">What you can do:</p>
                          <ul className="text-xs text-slate-600 mt-1 space-y-0.5">
                            <li>â€¢ Increase recruiting efforts to offset losses</li>
                            <li>â€¢ Focus equally on retention to slow attrition</li>
                            <li>â€¢ Partner with local schools and community groups</li>
                            <li>â€¢ Host open house events and public activities</li>
                          </ul>
                        </div>
                      )}
                      {displayMetrics.metrics.growth.status === 'growing' && (
                        <p className="text-xs text-emerald-700 mt-2 font-medium">
                          Great work! Your recruiting efforts are successfully growing the unit.
                        </p>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* Retention Health */}
              {displayMetrics.metrics.retention && (
                <div className={`p-4 rounded-lg border ${
                  displayMetrics.metrics.retention.healthIndicator === 'healthy'
                    ? 'bg-emerald-50 border-emerald-200'
                    : displayMetrics.metrics.retention.healthIndicator === 'moderate'
                    ? 'bg-amber-50 border-amber-200'
                    : 'bg-rose-50 border-rose-200'
                }`}>
                  <div className="flex items-start gap-3">
                    <Icon
                      name={displayMetrics.metrics.retention.healthIndicator === 'healthy' ? 'Shield' :
                            displayMetrics.metrics.retention.healthIndicator === 'at-risk' ? 'AlertTriangle' : 'Info'}
                      className={`w-5 h-5 mt-0.5 ${
                        displayMetrics.metrics.retention.healthIndicator === 'healthy' ? 'text-emerald-600' :
                        displayMetrics.metrics.retention.healthIndicator === 'at-risk' ? 'text-rose-600' : 'text-amber-600'
                      }`}
                    />
                    <div>
                      <h5 className="font-semibold text-slate-800">Retention Status</h5>
                      <p className="text-sm text-slate-600 mt-1">
                        {displayMetrics.metrics.retention.retentionRate !== null
                          ? `${displayMetrics.metrics.retention.retentionRate}% estimated retention rate over the past 12 months.`
                          : 'Retention rate could not be calculated with available data.'}
                        {displayMetrics.metrics.retention.healthIndicator === 'healthy' &&
                          ' Your unit has strong retention - keep up the good work!'}
                      </p>
                      {displayMetrics.metrics.retention.healthIndicator !== 'healthy' && (
                        <div className="mt-2 pt-2 border-t border-slate-200">
                          <p className="text-xs font-semibold text-slate-700">What you can do:</p>
                          <ul className="text-xs text-slate-600 mt-1 space-y-0.5">
                            <li>â€¢ Call members before their renewal date to check in</li>
                            <li>â€¢ Survey members who don't renew to understand why</li>
                            <li>â€¢ Ensure every member has meaningful activities</li>
                            <li>â€¢ Recognize member achievements regularly</li>
                          </ul>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* Volatility Warning */}
              {displayMetrics.metrics.volatility && (displayMetrics.metrics.volatility.stabilityRating === 'volatile' || displayMetrics.metrics.volatility.stabilityRating === 'moderate') && (
                <div className="p-4 rounded-lg border bg-amber-50 border-amber-200">
                  <div className="flex items-start gap-3">
                    <Icon name="Activity" className="w-5 h-5 mt-0.5 text-amber-600" />
                    <div>
                      <h5 className="font-semibold text-slate-800">Membership Volatility</h5>
                      <p className="text-sm text-slate-600 mt-1">
                        Your unit experiences {displayMetrics.metrics.volatility.stabilityRating === 'volatile' ? 'significant' : 'moderate'} month-to-month membership swings
                        (up to <strong>{displayMetrics.metrics.volatility.maxMonthlySwing} members</strong> change in a single month, {displayMetrics.metrics.volatility.coefficientOfVariation}% variation).
                      </p>
                      {displayMetrics.metrics.volatility.stabilityRating === 'volatile' && (
                        <div className="mt-2 pt-2 border-t border-slate-200">
                          <p className="text-xs font-semibold text-slate-700">What you can do:</p>
                          <ul className="text-xs text-slate-600 mt-1 space-y-0.5">
                            <li>â€¢ Spread recruiting throughout the year instead of bursts</li>
                            <li>â€¢ Send renewal reminders well before expiration dates</li>
                            <li>â€¢ Identify why members leave in waves (end of school year?)</li>
                            <li>â€¢ Create engagement programs to keep members active year-round</li>
                          </ul>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* Recruiting Trend */}
              {displayMetrics.metrics.recruiting && displayMetrics.metrics.recruiting.trend !== 'stable' && (
                <div className={`p-4 rounded-lg border ${
                  displayMetrics.metrics.recruiting.trend === 'increasing'
                    ? 'bg-emerald-50 border-emerald-200'
                    : 'bg-amber-50 border-amber-200'
                }`}>
                  <div className="flex items-start gap-3">
                    <Icon
                      name={displayMetrics.metrics.recruiting.trend === 'increasing' ? 'ArrowUpCircle' : 'ArrowDownCircle'}
                      className={`w-5 h-5 mt-0.5 ${
                        displayMetrics.metrics.recruiting.trend === 'increasing' ? 'text-emerald-600' : 'text-amber-600'
                      }`}
                    />
                    <div>
                      <h5 className="font-semibold text-slate-800">Recruiting Trend</h5>
                      <p className="text-sm text-slate-600 mt-1">
                        Recruiting is {displayMetrics.metrics.recruiting.trend} compared to the previous 12-month period
                        ({displayMetrics.metrics.recruiting.trendPercent > 0 ? '+' : ''}{displayMetrics.metrics.recruiting.trendPercent}%).
                        You're averaging <strong>{displayMetrics.metrics.recruiting.monthlyAverage} new members per month</strong>.
                      </p>
                      {displayMetrics.metrics.recruiting.trend === 'increasing' && (
                        <p className="text-xs text-emerald-700 mt-2 font-medium">
                          Keep momentum going with current recruiting strategies!
                        </p>
                      )}
                      {displayMetrics.metrics.recruiting.trend === 'decreasing' && (
                        <div className="mt-2 pt-2 border-t border-slate-200">
                          <p className="text-xs font-semibold text-slate-700">What you can do:</p>
                          <ul className="text-xs text-slate-600 mt-1 space-y-0.5">
                            <li>â€¢ Review what worked in your stronger recruiting months</li>
                            <li>â€¢ Try new outreach channels (social media, community events)</li>
                            <li>â€¢ Ask current members to bring friends to activities</li>
                            <li>â€¢ Schedule recruiting events during peak months (check Seasonality tab)</li>
                          </ul>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* No Issues Message */}
              {displayMetrics.metrics.sustainability?.rating === 'excellent' && (
                <div className="p-4 rounded-lg border bg-emerald-50 border-emerald-200">
                  <div className="flex items-start gap-3">
                    <Icon name="CheckCircle" className="w-5 h-5 mt-0.5 text-emerald-600" />
                    <div>
                      <h5 className="font-semibold text-slate-800">Excellent Overall Health</h5>
                      <p className="text-sm text-slate-600 mt-1">
                        Your unit is performing well across all membership health metrics.
                        Continue current practices and monitor for any changes in trends.
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* No Data State */}
        {!displayMetrics && (
          <div className="text-center py-12 text-slate-500">
            <Icon name="BarChart3" className="w-12 h-12 mx-auto mb-3 text-slate-300" />
            <h4 className="font-semibold text-slate-700 mb-1">No Data Available</h4>
            <p className="text-sm">Unable to load recruiting and retention metrics for this unit.</p>
          </div>
        )}
      </div>
    </Modal>
  );
};
</script>

<script type="text/babel">
// Feedback Tab Component
// Allows users to submit feedback/issues to GitHub
const FeedbackTab = ({
  activeTab,
  unitFilter,
  showAllDescendants,
  lastUpdated,
  dataFiles,
  availableUnits,
  onClose
}) => {
  const [category, setCategory] = useState('bug');
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitResult, setSubmitResult] = useState(null);

  // Reset form when component mounts
  React.useEffect(() => {
    setCategory('bug');
    setTitle('');
    setDescription('');
    setSubmitResult(null);
  }, []);

  // Collect diagnostic data
  const collectDiagnostics = () => {
    const selectedUnitObj = availableUnits?.find(u => u.id === unitFilter);
    const members = dataFiles?.members || [];

    return {
      appVersion: typeof APP_VERSION !== 'undefined' ? APP_VERSION : 'Unknown',
      browser: getBrowserInfo(),
      platform: navigator.platform || 'Unknown',
      screenSize: `${window.innerWidth}x${window.innerHeight}`,
      userAgent: navigator.userAgent,
      currentView: activeTab || 'Unknown',
      selectedUnit: unitFilter || 'None',
      selectedUnitName: selectedUnitObj?.name || 'Unknown',
      showAllDescendants: showAllDescendants || false,
      lastUpdated: lastUpdated || 'Unknown',
      memberCount: members.length || 0,
      seniorCount: members.filter(m =>
        (m.Type || m.TYPE || '').toUpperCase() === 'SENIOR' ||
        (m.Type || m.TYPE || '').toUpperCase() === 'LIFE'
      ).length || 0,
      cadetCount: members.filter(m =>
        (m.Type || m.TYPE || '').toUpperCase() === 'CADET'
      ).length || 0,
      orgCount: dataFiles?.organization?.length || 0
    };
  };

  const getBrowserInfo = () => {
    const ua = navigator.userAgent;
    if (ua.includes('Chrome') && !ua.includes('Edg')) return 'Chrome';
    if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
    if (ua.includes('Firefox')) return 'Firefox';
    if (ua.includes('Edg')) return 'Edge';
    return 'Unknown';
  };

  const handleSubmit = (e) => {
    e.preventDefault();

    if (!title.trim() || !description.trim()) {
      setSubmitResult({
        success: false,
        message: 'Please fill in both the title and description.'
      });
      return;
    }

    setIsSubmitting(true);
    setSubmitResult(null);

    const issueData = {
      title: title.trim(),
      description: description.trim(),
      category: category,
      diagnostics: collectDiagnostics()
    };

    if (window.google && window.google.script) {
      window.google.script.run
        .withSuccessHandler((result) => {
          setIsSubmitting(false);
          if (result.success) {
            setSubmitResult({
              success: true,
              message: 'Your feedback has been submitted successfully!',
              issueUrl: result.issueUrl,
              issueNumber: result.issueNumber
            });
            setTitle('');
            setDescription('');
          } else {
            setSubmitResult({
              success: false,
              message: result.error || 'Failed to submit feedback. Please try again.'
            });
          }
        })
        .withFailureHandler((error) => {
          setIsSubmitting(false);
          setSubmitResult({
            success: false,
            message: 'Error: ' + (error.message || error.toString())
          });
        })
        .createGitHubIssue(issueData);
    } else {
      setIsSubmitting(false);
      setSubmitResult({
        success: false,
        message: 'Unable to connect to server. Please refresh and try again.'
      });
    }
  };

  const selectedCategory = FEEDBACK_CATEGORIES.find(c => c.id === category);

  // Success state
  if (submitResult?.success) {
    return (
      <div className="text-center py-8">
        <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <Icon name="CheckCircle" className="w-10 h-10 text-green-600" />
        </div>
        <h3 className="text-xl font-bold text-slate-800 mb-2">Thank You!</h3>
        <p className="text-slate-600 mb-4">{submitResult.message}</p>
        {submitResult.issueUrl && (
          <a
            href={submitResult.issueUrl}
            target="_blank"
            rel="noopener noreferrer"
            className="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium"
          >
            <Icon name="ExternalLink" className="w-4 h-4" />
            View Issue #{submitResult.issueNumber} on GitHub
          </a>
        )}
        <div className="mt-6">
          <button
            onClick={() => setSubmitResult(null)}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            Submit Another
          </button>
        </div>
      </div>
    );
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-5">
      {/* Category Selection */}
      <div>
        <label className="block text-sm font-medium text-slate-700 mb-2">
          What type of feedback is this?
        </label>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
          {FEEDBACK_CATEGORIES.map(cat => (
            <button
              key={cat.id}
              type="button"
              onClick={() => setCategory(cat.id)}
              className={`p-3 rounded-lg border text-left transition-all ${
                category === cat.id
                  ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200'
                  : 'border-slate-200 hover:border-slate-300 hover:bg-slate-50'
              }`}
            >
              <div className="flex items-center gap-2">
                <Icon name={cat.icon} className={`w-5 h-5 ${category === cat.id ? 'text-blue-600' : 'text-slate-400'}`} />
                <span className={`font-medium text-sm ${category === cat.id ? 'text-blue-700' : 'text-slate-700'}`}>
                  {cat.label}
                </span>
              </div>
              <p className="text-xs text-slate-500 mt-1 ml-7">{cat.description}</p>
            </button>
          ))}
        </div>
      </div>

      {/* Title */}
      <div>
        <label htmlFor="feedback-title" className="block text-sm font-medium text-slate-700 mb-1">
          Brief Summary
        </label>
        <input
          id="feedback-title"
          type="text"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          placeholder="e.g., 'Cadet dashboard not showing all members'"
          className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          maxLength={100}
          required
        />
        <p className="text-xs text-slate-500 mt-1">{title.length}/100 characters</p>
      </div>

      {/* Description */}
      <div>
        <label htmlFor="feedback-description" className="block text-sm font-medium text-slate-700 mb-1">
          Detailed Description
        </label>
        <textarea
          id="feedback-description"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
          placeholder="Please describe what you observed, what you expected, and any steps to reproduce the issue..."
          rows={4}
          className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y"
          required
        />
      </div>

      {/* Diagnostic Info Notice */}
      <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
        <div className="flex items-start gap-3">
          <Icon name="Info" className="w-5 h-5 text-slate-400 mt-0.5 flex-shrink-0" />
          <div className="text-sm text-slate-600">
            <p className="font-medium text-slate-700 mb-1">Automatic Diagnostic Data</p>
            <p className="text-xs">The following will be included to help diagnose issues:</p>
            <ul className="mt-1 space-y-0.5 text-xs text-slate-500">
              <li>Current view: <span className="font-mono bg-slate-200 px-1 rounded">{activeTab}</span></li>
              <li>Selected unit: <span className="font-mono bg-slate-200 px-1 rounded">{unitFilter || 'None'}</span></li>
              <li>Browser, screen size, and app version</li>
            </ul>
          </div>
        </div>
      </div>

      {/* Error Message */}
      {submitResult && !submitResult.success && (
        <div className="bg-red-50 border border-red-200 rounded-lg p-3 flex items-start gap-3">
          <Icon name="AlertCircle" className="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0" />
          <div>
            <p className="font-medium text-red-800">Submission Failed</p>
            <p className="text-sm text-red-700">{submitResult.message}</p>
          </div>
        </div>
      )}

      {/* Submit Button */}
      <div className="flex justify-end pt-2">
        <button
          type="submit"
          disabled={isSubmitting || !title.trim() || !description.trim()}
          className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        >
          {isSubmitting ? (
            <>
              <span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
              Submitting...
            </>
          ) : (
            <>
              <Icon name="Send" className="w-4 h-4" />
              Submit Feedback
            </>
          )}
        </button>
      </div>
    </form>
  );
};

// Reference & Help Modal
// Displays context-aware help with tabs for each app section
const ReferenceModal = ({
  isOpen,
  onClose,
  activeTab,
  DUTY_TO_TRACK_MAP,
  // Props for feedback functionality
  unitFilter,
  showAllDescendants,
  lastUpdated,
  dataFiles,
  availableUnits
}) => {
  const [activeReferenceTab, setActiveReferenceTab] = useState(activeTab || 'home');

  // Sync with activeTab when modal opens
  React.useEffect(() => {
    if (isOpen && activeTab) {
      setActiveReferenceTab(activeTab);
    }
  }, [isOpen, activeTab]);

  if (!isOpen) return null;

  const tabs = [
    { id: 'home', label: 'Home', icon: 'Home' },
    { id: 'unit', label: 'Unit Overview', icon: 'Building' },
    { id: 'senior', label: 'Senior Dashboard', icon: 'Users' },
    { id: 'cadet', label: 'Cadet Dashboard', icon: 'GraduationCap' },
    { id: 'reports', label: 'Reports', icon: 'FileText' },
    { id: 'org', label: 'Org Chart', icon: 'Network' },
    { id: 'feedback', label: 'Feedback', icon: 'MessageSquare' }
  ];

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Help & Reference" maxWidthClass="max-w-4xl">
      {/* Tab Navigation */}
      <div className="flex gap-1 mb-4 border-b border-slate-200 overflow-x-auto pb-1">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveReferenceTab(tab.id)}
            className={`flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-t-lg whitespace-nowrap transition-colors ${
              activeReferenceTab === tab.id
                ? 'bg-blue-50 text-blue-700 border-b-2 border-blue-600'
                : 'text-slate-600 hover:text-slate-800 hover:bg-slate-50'
            }`}
          >
            <Icon name={tab.icon} className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* Tab Content */}
      <div className="space-y-6 max-h-[60vh] overflow-y-auto pr-2">

        {/* HOME TAB */}
        {activeReferenceTab === 'home' && (
          <>
            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Home" className="w-4 h-4 mr-2 text-blue-600" />
                Welcome to Michigan Wing Readiness Hub
              </h3>
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-slate-700">
                <p className="mb-2">The Michigan Wing Readiness Hub is your one-stop dashboard for monitoring unit readiness, training status, and personnel metrics. It provides role-specific views for commanders, senior members, and cadets.</p>
                <p>Use the navigation buttons or tab bar at the top to switch between different views.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="LayoutGrid" className="w-4 h-4 mr-2 text-indigo-600" />
                Quick Access Cards
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                <div className="bg-slate-50 p-3 rounded border border-slate-100">
                  <span className="font-bold block text-slate-800">For Commanders</span>
                  <p className="text-slate-600 mt-1">Opens Unit Overview with staffing, readiness metrics, and expiration alerts.</p>
                </div>
                <div className="bg-slate-50 p-3 rounded border border-slate-100">
                  <span className="font-bold block text-slate-800">Senior Members</span>
                  <p className="text-slate-600 mt-1">Opens Senior Dashboard showing E&T levels, specialty tracks, and duty assignments.</p>
                </div>
                <div className="bg-slate-50 p-3 rounded border border-slate-100">
                  <span className="font-bold block text-slate-800">Cadets</span>
                  <p className="text-slate-600 mt-1">Opens Cadet Dashboard with milestones, phases, and promotion readiness.</p>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="BarChart3" className="w-4 h-4 mr-2 text-green-600" />
                Statistics Summary
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div className="bg-slate-50 p-3 rounded border border-slate-100">
                  <span className="font-bold block text-slate-800">Total Strength</span>
                  <p className="text-slate-600 mt-1">All active members (seniors + cadets) in the selected unit scope.</p>
                </div>
                <div className="bg-slate-50 p-3 rounded border border-slate-100">
                  <span className="font-bold block text-slate-800">Units in Scope</span>
                  <p className="text-slate-600 mt-1">"This Unit" shows only the selected unit. "Unit + Sub" includes all subordinate units.</p>
                </div>
              </div>
            </section>
          </>
        )}

        {/* UNIT OVERVIEW TAB */}
        {activeReferenceTab === 'unit' && (
          <>
            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Building" className="w-4 h-4 mr-2 text-blue-600" />
                Commander Dashboard Overview
              </h3>
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-slate-700">
                <p>The Unit Overview provides commanders with a high-level snapshot of unit health, staffing, and upcoming requirements. Click any accordion section header to expand/collapse for more details.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Activity" className="w-4 h-4 mr-2 text-green-600" />
                Key Metrics Explained
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div className="bg-emerald-50 p-3 rounded border border-emerald-100">
                  <span className="font-bold block text-emerald-800">Sustainability Score</span>
                  <p className="text-slate-600 mt-1">A composite score (0-100) based on retention rate, recruiting rate, member tenure, and growth trends. Higher is better.</p>
                </div>
                <div className="bg-blue-50 p-3 rounded border border-blue-100">
                  <span className="font-bold block text-blue-800">Retention Rate</span>
                  <p className="text-slate-600 mt-1">Percentage of members who renewed their membership over the tracking period. Target: 80%+.</p>
                </div>
                <div className="bg-indigo-50 p-3 rounded border border-indigo-100">
                  <span className="font-bold block text-indigo-800">Recruiting Rate</span>
                  <p className="text-slate-600 mt-1">Average new members joining per month. Compare against losses to assess growth.</p>
                </div>
                <div className="bg-amber-50 p-3 rounded border border-amber-100">
                  <span className="font-bold block text-amber-800">Net Change</span>
                  <p className="text-slate-600 mt-1">Total members gained minus lost. Positive = growing, negative = declining.</p>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Shield" className="w-4 h-4 mr-2 text-purple-600" />
                Compliance Metrics
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div className="bg-purple-50 p-3 rounded border border-purple-100">
                  <span className="font-bold block text-purple-800">Cadet Protection (CP)</span>
                  <p className="text-slate-600 mt-1">Percentage of members compliant with required Cadet Protection training. All members working with cadets must maintain current CP certification.</p>
                </div>
                <div className="bg-orange-50 p-3 rounded border border-orange-100">
                  <span className="font-bold block text-orange-800">TLC Credit</span>
                  <p className="text-slate-600 mt-1">Training Leaders of Cadets - units need 2+ qualified senior members. This metric shows qualified count vs. requirement.</p>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Clock" className="w-4 h-4 mr-2 text-rose-600" />
                Expiration Alerts
              </h3>
              <div className="bg-rose-50 p-4 rounded-lg border border-rose-100 text-sm text-slate-700">
                <p className="mb-2">The Upcoming Expirations section shows members whose memberships, training, or certifications expire within 90 days.</p>
                <ul className="list-disc list-inside space-y-1 ml-1">
                  <li><span className="font-bold text-rose-700">Critical (â‰¤30 days):</span> Requires immediate attention</li>
                  <li><span className="font-bold text-amber-700">Warning (31-60 days):</span> Plan to address soon</li>
                  <li><span className="font-bold text-blue-700">Notice (61-90 days):</span> Be aware and monitor</li>
                </ul>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Users" className="w-4 h-4 mr-2 text-slate-600" />
                HQ Staff Insights (Wing/Group)
              </h3>
              <div className="bg-slate-50 p-4 rounded-lg border border-slate-100 text-sm text-slate-700">
                <p>When viewing a Wing or Group HQ, you'll see staff-specific metrics including average tenure, experience distribution, and rank breakdown. This helps assess organizational knowledge and succession planning.</p>
              </div>
            </section>
          </>
        )}

        {/* SENIOR DASHBOARD TAB */}
        {activeReferenceTab === 'senior' && (
          <>
            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Filter" className="w-4 h-4 mr-2 text-blue-600" />
                Dashboard Filters
              </h3>
              <div className="text-sm text-slate-700 space-y-3">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="bg-blue-50 p-3 rounded border border-blue-100">
                    <span className="font-bold block text-blue-800">Rank Category</span>
                    <p className="mt-1">OFFICER (Lt through Col), NCO (MSgt through CMSgt), FLIGHT (FO), SM (Senior Member - no grade).</p>
                  </div>
                  <div className="bg-purple-50 p-3 rounded border border-purple-100">
                    <span className="font-bold block text-purple-800">Track Level</span>
                    <p className="mt-1">MASTER (highest), SENIOR, TECHNICIAN (entry level), or NONE (not enrolled in any track).</p>
                  </div>
                  <div className="bg-indigo-50 p-3 rounded border border-indigo-100">
                    <span className="font-bold block text-indigo-800">Functional Area</span>
                    <p className="mt-1">Groups duties by function: Operations, Cadet Programs, Aerospace Education, Administration, etc.</p>
                  </div>
                  <div className="bg-slate-50 p-3 rounded border border-slate-200">
                    <span className="font-bold block text-slate-800">Duty Position</span>
                    <p className="mt-1">Filter by specific assigned duties like Commander, Operations Officer, etc.</p>
                  </div>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="BarChart3" className="w-4 h-4 mr-2 text-blue-600" />
                Education & Training Levels
              </h3>
              <div className="text-sm text-slate-700 space-y-3">
                <div className="bg-blue-50 p-3 rounded border border-blue-100">
                  <span className="font-bold block text-blue-800 mb-2">Level Indicators (L1, L2.1, L2.2, L3, L4, L5)</span>
                  <p className="mb-2">Circles show member counts at each E&T level. Click any circle to filter the list:</p>
                  <ul className="list-disc list-inside space-y-1 ml-1">
                    <li><span className="font-bold text-green-700">1st Click (Green):</span> Show members who have <strong>Completed</strong> this level.</li>
                    <li><span className="font-bold text-amber-600">2nd Click (Amber):</span> Show members who are <strong>In Progress/Incomplete</strong> for this level.</li>
                    <li><span className="font-bold text-slate-600">3rd Click:</span> Clear the filter.</li>
                  </ul>
                </div>
                <div className="bg-amber-50 p-4 rounded-lg border border-amber-100">
                  <span className="font-bold block text-amber-800 mb-1">Amber Dots on Member Cards</span>
                  <p>An amber dot on a level indicator means all modules are done but the path is waiting to be submitted or approved in eServices.</p>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="AlertCircle" className="w-4 h-4 mr-2 text-amber-500" />
                Education & Training Discrepancies
              </h3>
              <div className="bg-amber-50 p-4 rounded-lg border border-amber-100 text-sm text-slate-700 space-y-2">
                <p>You may notice discrepancies where a member shows a higher Level completed (e.g., Level 3) but Levels 1 or 2 are incomplete. This is expected behavior due to historical changes in the CAP Professional Development program.</p>
                <p><strong>Why this happens:</strong> When CAP transitioned to the "Education & Training" (Volunteer University) model, members with existing achievements were grandfathered in. They did not have to retroactively complete the new modular requirements for levels they had already earned.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Award" className="w-4 h-4 mr-2 text-purple-600" />
                Specialty Tracks
              </h3>
              <div className="text-sm text-slate-700 space-y-2">
                <p>Specialty tracks show professional development in specific functional areas. Rating levels progress from Technician â†’ Senior â†’ Master.</p>
                <div className="flex flex-wrap gap-2 mt-2">
                  <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold">TECH</span>
                  <span className="text-slate-400">â†’</span>
                  <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">SENIOR</span>
                  <span className="text-slate-400">â†’</span>
                  <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold">MASTER</span>
                </div>
                <p className="mt-2 text-amber-700"><strong>Warning icons</strong> on duty badges indicate the member holds a duty but lacks the recommended specialty track enrollment.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="TrendingUp" className="w-4 h-4 mr-2 text-green-600" />
                Promotion Eligibility
              </h3>
              <div className="bg-green-50 p-3 rounded border border-green-100 text-sm text-slate-700">
                <p className="mb-2"><strong>Promotable</strong> count shows members who meet <strong>both</strong> requirements:</p>
                <ul className="list-disc list-inside space-y-1 ml-1">
                  <li><strong>Time-in-Grade (TIG):</strong> Minimum months in current rank (varies by rank)</li>
                  <li><strong>E&T Level:</strong> Required education & training level for next rank</li>
                </ul>
                <p className="mt-2 text-xs text-slate-500">Click the Promotable count to filter the dashboard, or click any member's rank to see detailed promotion criteria.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Shield" className="w-4 h-4 mr-2 text-rose-600" />
                Training Indicators
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div className="bg-emerald-50 p-3 rounded border border-emerald-100">
                  <span className="font-bold block text-emerald-800">Green Avatar Ring</span>
                  <p className="text-slate-600 mt-1">Cadet Protection training is current and not expiring soon.</p>
                </div>
                <div className="bg-amber-50 p-3 rounded border border-amber-100">
                  <span className="font-bold block text-amber-800">Amber Avatar Ring</span>
                  <p className="text-slate-600 mt-1">Training expires within 90 days - renewal needed soon.</p>
                </div>
                <div className="bg-rose-50 p-3 rounded border border-rose-100">
                  <span className="font-bold block text-rose-800">Red Avatar Ring</span>
                  <p className="text-slate-600 mt-1">Training is expired or missing - immediate action required.</p>
                </div>
                <div className="bg-slate-50 p-3 rounded border border-slate-200">
                  <span className="font-bold block text-slate-800">Gray Avatar Ring</span>
                  <p className="text-slate-600 mt-1">No Cadet Protection data available or not required.</p>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 border-b pb-2">Duty Position to Specialty Track Map</h3>
              <div className="max-h-48 overflow-y-auto">
                <table className="w-full text-left text-sm border-collapse">
                  <thead className="bg-slate-100 sticky top-0">
                    <tr>
                      <th className="p-2 font-bold text-slate-600 border-b">Duty Position</th>
                      <th className="p-2 font-bold text-slate-600 border-b">Required Track</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {Object.entries(DUTY_TO_TRACK_MAP).sort((a, b) => a[0].localeCompare(b[0])).map(([d, t]) => (
                      <tr key={d} className="hover:bg-slate-50">
                        <td className="p-2 capitalize text-slate-700">{d.toLowerCase()}</td>
                        <td className="p-2 text-blue-600 font-mono text-xs">{t}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>
          </>
        )}

        {/* CADET DASHBOARD TAB */}
        {activeReferenceTab === 'cadet' && (
          <>
            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="GraduationCap" className="w-4 h-4 mr-2 text-blue-600" />
                Cadet Program Overview
              </h3>
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-slate-700">
                <p>The Cadet Dashboard tracks cadet progression through the 16-achievement program, organized into 5 phases. Each cadet card shows current rank, next achievement requirements, and promotion status.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Layers" className="w-4 h-4 mr-2 text-indigo-600" />
                Phases Explained
              </h3>
              <div className="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                <div className="bg-blue-50 p-3 rounded border border-blue-100 text-center">
                  <span className="font-bold block text-blue-800">Phase I</span>
                  <p className="text-xs text-slate-600 mt-1">Learning (Curry â†’ Mitchell)</p>
                </div>
                <div className="bg-blue-50 p-3 rounded border border-blue-100 text-center">
                  <span className="font-bold block text-blue-800">Phase II</span>
                  <p className="text-xs text-slate-600 mt-1">Leadership (Mitchell â†’ Earhart)</p>
                </div>
                <div className="bg-blue-50 p-3 rounded border border-blue-100 text-center">
                  <span className="font-bold block text-blue-800">Phase III</span>
                  <p className="text-xs text-slate-600 mt-1">Command (Earhart â†’ Eaker)</p>
                </div>
                <div className="bg-blue-50 p-3 rounded border border-blue-100 text-center">
                  <span className="font-bold block text-blue-800">Phase IV</span>
                  <p className="text-xs text-slate-600 mt-1">Executive (Eaker â†’ Spaatz)</p>
                </div>
                <div className="bg-purple-50 p-3 rounded border border-purple-100 text-center">
                  <span className="font-bold block text-purple-800">Phase V</span>
                  <p className="text-xs text-slate-600 mt-1">Spaatz (Complete)</p>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Target" className="w-4 h-4 mr-2 text-green-600" />
                Promotion Status
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div className="bg-green-50 p-3 rounded border border-green-100">
                  <span className="font-bold block text-green-800">READY</span>
                  <p className="text-slate-600 mt-1">All requirements complete - eligible for promotion.</p>
                </div>
                <div className="bg-amber-50 p-3 rounded border border-amber-100">
                  <span className="font-bold block text-amber-800">TIME_PENDING</span>
                  <p className="text-slate-600 mt-1">Requirements complete but waiting for TIG eligibility date.</p>
                </div>
                <div className="bg-blue-50 p-3 rounded border border-blue-100">
                  <span className="font-bold block text-blue-800">NEARLY_READY</span>
                  <p className="text-slate-600 mt-1">Most requirements done - just a few items remaining.</p>
                </div>
                <div className="bg-slate-50 p-3 rounded border border-slate-200">
                  <span className="font-bold block text-slate-800">IN_PROGRESS</span>
                  <p className="text-slate-600 mt-1">Working on achievement requirements.</p>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Clock" className="w-4 h-4 mr-2 text-orange-600" />
                Time in Grade (TIG)
              </h3>
              <div className="bg-orange-50 p-4 rounded-lg border border-orange-100 text-sm text-slate-700">
                <p className="mb-2">Cadets must wait a minimum number of days in their current grade before promotion. The "Eligible" date shows when TIG is met.</p>
                <p><strong>90+ Days Indicator:</strong> An amber dot appears when a cadet has been in grade 90+ days without promotion - may indicate a stalled advancement or missing requirements.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Star" className="w-4 h-4 mr-2 text-purple-600" />
                Honor Credits
              </h3>
              <div className="bg-purple-50 p-4 rounded-lg border border-purple-100 text-sm text-slate-700">
                <p>Honor credits are earned when cadets complete extra activities beyond the minimum requirements. The count shows total honor credit achievements earned across all cadets.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Briefcase" className="w-4 h-4 mr-2 text-slate-600" />
                Cadet Duty Positions
              </h3>
              <div className="text-sm text-slate-700 space-y-2">
                <p>Leadership billets displayed on cadet cards in order of seniority:</p>
                <div className="grid grid-cols-2 gap-2 mt-2">
                  <div className="text-xs">1. Cadet Commander</div>
                  <div className="text-xs">2. Cadet Deputy Cmdr (Ops)</div>
                  <div className="text-xs">3. Cadet Deputy Cmdr (Spt)</div>
                  <div className="text-xs">4. Cadet First Sergeant</div>
                  <div className="text-xs">5. Cadet Flight Commander</div>
                  <div className="text-xs">6. Cadet Flight Sergeant</div>
                </div>
              </div>
            </section>
          </>
        )}

        {/* REPORTS TAB */}
        {activeReferenceTab === 'reports' && (
          <>
            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="FileText" className="w-4 h-4 mr-2 text-blue-600" />
                Reports Overview
              </h3>
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-slate-700">
                <p>The Reports section generates actionable insights and analysis. Use tag filters to find specific report types. Click "Generate" to view a report or "PDF" to export directly.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="BookOpen" className="w-4 h-4 mr-2 text-indigo-600" />
                Report Types
              </h3>
              <div className="space-y-3 text-sm">
                <div className="bg-blue-50 p-3 rounded border border-blue-100">
                  <span className="font-bold block text-blue-800">Most Needed Training Analysis</span>
                  <p className="text-slate-600 mt-1">Identifies moderated-only E&T modules that Volunteer University instructors should prioritize teaching. Self-paced modules are excluded since members can complete those online.</p>
                </div>
                <div className="bg-amber-50 p-3 rounded border border-amber-100">
                  <span className="font-bold block text-amber-800">Track/Duty Discrepancies</span>
                  <p className="text-slate-600 mt-1">Lists members with duty assignments who are missing the required specialty track enrollment. Use as an action list for eServices corrections.</p>
                </div>
                <div className="bg-green-50 p-3 rounded border border-green-100">
                  <span className="font-bold block text-green-800">Levels Awaiting Approval</span>
                  <p className="text-slate-600 mt-1">Members who have completed all modules for a level and need submission/approval (or have pending/disapproved submissions).</p>
                </div>
                <div className="bg-emerald-50 p-3 rounded border border-emerald-100">
                  <span className="font-bold block text-emerald-800">Promotion Eligibility</span>
                  <p className="text-slate-600 mt-1">Senior members meeting all promotion requirements (TIG, E&T Level, and Duty Position). Lt Cols excluded as Col promotion is restricted to wing command positions.</p>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Tag" className="w-4 h-4 mr-2 text-purple-600" />
                Report Tags
              </h3>
              <div className="text-sm text-slate-700">
                <p className="mb-2">Tags categorize reports by topic area. Select multiple tags to narrow your search:</p>
                <div className="flex flex-wrap gap-2">
                  <span className="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs border border-slate-200">training</span>
                  <span className="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs border border-slate-200">senior</span>
                  <span className="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs border border-slate-200">cadet</span>
                  <span className="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs border border-slate-200">promotion</span>
                  <span className="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs border border-slate-200">compliance</span>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Download" className="w-4 h-4 mr-2 text-green-600" />
                Exporting Reports
              </h3>
              <div className="bg-green-50 p-4 rounded-lg border border-green-100 text-sm text-slate-700">
                <p className="mb-2">Two ways to export:</p>
                <ul className="list-disc list-inside space-y-1 ml-1">
                  <li><strong>PDF button on report card:</strong> Exports without generating on-screen first</li>
                  <li><strong>Export PDF in report view:</strong> Exports the currently displayed report</li>
                </ul>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Users" className="w-4 h-4 mr-2 text-slate-600" />
                Member Lists
              </h3>
              <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-sm text-slate-700">
                <p>On training reports, click the member count number to see names and CAP IDs of specific members needing that training module.</p>
              </div>
            </section>
          </>
        )}

        {/* ORG CHART TAB */}
        {activeReferenceTab === 'org' && (
          <>
            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Network" className="w-4 h-4 mr-2 text-blue-600" />
                Organization Chart Features
              </h3>
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-slate-700">
                <p>The org chart displays unit structure with position holders. Click any member name to view their full profile. Use the toolbar controls to customize the view.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Settings" className="w-4 h-4 mr-2 text-slate-600" />
                View Options
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div className="bg-slate-50 p-3 rounded border border-slate-200">
                  <span className="font-bold block text-slate-800">Hide Vacant Positions</span>
                  <p className="text-slate-600 mt-1">Toggle to show/hide unfilled duty positions.</p>
                </div>
                <div className="bg-slate-50 p-3 rounded border border-slate-200">
                  <span className="font-bold block text-slate-800">Command Chain Only</span>
                  <p className="text-slate-600 mt-1">Show only command positions (Commander, Deputy Commanders, Cadet Commander).</p>
                </div>
                <div className="bg-green-50 p-3 rounded border border-green-100">
                  <span className="font-bold block text-green-800">Expand/Collapse All</span>
                  <p className="text-slate-600 mt-1">Quick toggle to expand or collapse all sections at once.</p>
                </div>
                <div className="bg-purple-50 p-3 rounded border border-purple-100">
                  <span className="font-bold block text-purple-800">Committees</span>
                  <p className="text-slate-600 mt-1">Opens sidebar showing committee memberships (CAC, WCAC, GCAC, etc.).</p>
                </div>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Circle" className="w-4 h-4 mr-2 text-blue-500" />
                Cross-Unit Duty Assignments
              </h3>
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-slate-700">
                <p className="mb-2">Members with duty assignments in units other than their home unit are marked with a <span className="inline-block w-2.5 h-2.5 bg-blue-500 rounded-full border-2 border-white"></span> blue indicator dot on their duty badge.</p>
                <p className="text-xs">This helps identify members supporting multiple units or holding positions above/below their assigned unit.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Eye" className="w-4 h-4 mr-2 text-purple-600" />
                Drill-Down View (Sub-Units Mode)
              </h3>
              <div className="bg-purple-50 p-4 rounded-lg border border-purple-100 text-sm text-slate-700">
                <p className="mb-2">When viewing with "Sub-Units" enabled, click the <svg className="inline w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd"/></svg> eye icon on any position title to view all members holding that position across all subordinate units.</p>
                <p className="text-xs">Perfect for Wing/Group commanders to see all squadron commanders, operations officers, etc. at a glance.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Users" className="w-4 h-4 mr-2 text-indigo-600" />
                Committees Sidebar
              </h3>
              <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100 text-sm text-slate-700 space-y-2">
                <p>When committees exist in the unit, they appear in a sidebar overlay. Committee types include:</p>
                <ul className="list-disc list-inside ml-1 space-y-1">
                  <li><strong>CAC:</strong> Cadet Advisory Council (squadron level)</li>
                  <li><strong>GCAC:</strong> Group Cadet Advisory Council</li>
                  <li><strong>WCAC:</strong> Wing Cadet Advisory Council</li>
                </ul>
                <p className="text-xs mt-2">Committee chairs are marked with a "CHAIR" badge. Senior advisors in CAC committees are marked with an "ADVISOR" badge.</p>
              </div>
            </section>

            <section>
              <h3 className="font-bold text-slate-800 mb-3 flex items-center border-b pb-2">
                <Icon name="Download" className="w-4 h-4 mr-2 text-slate-600" />
                Export Options
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div className="bg-slate-50 p-3 rounded border border-slate-200">
                  <span className="font-bold block text-slate-800">PNG Export</span>
                  <p className="text-slate-600 mt-1">Downloads the org chart as a high-resolution image file.</p>
                </div>
                <div className="bg-blue-50 p-3 rounded border border-blue-100">
                  <span className="font-bold block text-blue-800">PDF Export</span>
                  <p className="text-slate-600 mt-1">Downloads the org chart as a PDF document, suitable for printing.</p>
                </div>
              </div>
            </section>
          </>
        )}

        {/* FEEDBACK TAB */}
        {activeReferenceTab === 'feedback' && (
          <FeedbackTab
            activeTab={activeTab}
            unitFilter={unitFilter}
            showAllDescendants={showAllDescendants}
            lastUpdated={lastUpdated}
            dataFiles={dataFiles}
            availableUnits={availableUnits}
            onClose={onClose}
          />
        )}

      </div>
    </Modal>
  );
};
</script>

<script type="text/babel">
// Home Section
// Landing page with welcome banner and quick access cards
function HomeSection({
  activeTab,
  setActiveTab,
  baseUnitStats,
  showAllDescendants
}) {
  return (
    <div className="space-y-6">
      <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl p-6 flex flex-col gap-3 xl:flex-row xl:items-center xl:justify-between">
        <div>
          <p className="text-sm uppercase tracking-wide opacity-80">Welcome to Michigan Wing Readiness Hub</p>
          <h1 className="text-2xl font-bold">Michigan Wing Readiness Hub</h1>
          <p className="text-sm text-blue-100 max-w-xl">
            One place for commanders, senior members, and cadets to monitor readiness, training, and staffing.
          </p>
          <div className="mt-4 flex gap-3 flex-wrap">
            <button onClick={() => setActiveTab('senior')} className="px-4 py-2 bg-white text-blue-700 rounded-lg font-semibold hover:shadow">
              Senior Dashboard
            </button>
            <button onClick={() => setActiveTab('cadet')} className="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold border border-white/30 hover:bg-blue-400">
              Cadet Dashboard
            </button>
            <button onClick={() => setActiveTab('unit')} className="px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold border border-white/30 hover:bg-indigo-400">
              Unit Overview
            </button>
          </div>
        </div>
        <div className="grid grid-cols-2 gap-3 min-w-[240px]">
          {[
            { label: 'Total Strength', value: baseUnitStats ? baseUnitStats.total : 0 },
            { label: 'Senior Members', value: baseUnitStats ? baseUnitStats.seniors : 0 },
            { label: 'Cadets', value: baseUnitStats ? baseUnitStats.cadets : 0 },
            { label: 'Units in Scope', value: showAllDescendants ? 'Unit + Sub' : 'This Unit' },
          ].map(card => (
            <div key={card.label} className="bg-white/10 rounded-lg p-3">
              <div className="text-xs uppercase opacity-80">{card.label}</div>
              <div className="text-xl font-bold">{card.value}</div>
            </div>
          ))}
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="bg-white rounded-lg border border-slate-200 p-4">
          <h3 className="font-bold text-slate-900">For Commanders</h3>
          <p className="text-sm text-slate-600 mt-1">Snapshot of readiness, staffing, and upcoming expirations.</p>
          <button onClick={() => setActiveTab('unit')} className="mt-3 text-blue-600 text-sm font-semibold hover:underline">
            Open Unit Overview
          </button>
        </div>
        <div className="bg-white rounded-lg border border-slate-200 p-4">
          <h3 className="font-bold text-slate-900">Senior Members</h3>
          <p className="text-sm text-slate-600 mt-1">Education & training, promotions, duty coverage.</p>
          <button onClick={() => setActiveTab('senior')} className="mt-3 text-blue-600 text-sm font-semibold hover:underline">
            Go to Senior Dashboard
          </button>
        </div>
        <div className="bg-white rounded-lg border border-slate-200 p-4">
          <h3 className="font-bold text-slate-900">Cadets</h3>
          <p className="text-sm text-slate-600 mt-1">Milestones, leadership billets, participation.</p>
          <button onClick={() => setActiveTab('cadet')} className="mt-3 text-blue-600 text-sm font-semibold hover:underline">
            Go to Cadet Dashboard
          </button>
        </div>
      </div>
    </div>
  );
}
</script>

<script type="text/babel">
function SeniorDashboard(props) {
  const {
    showSeniorFilters, setShowSeniorFilters, activeFiltersCount, filterPromoReady, levelFilter,
    searchQuery, clearFilters, activeFilterMenu, setActiveFilterMenu, filters, toggleFilter,
    trackSearchQuery, setTrackSearchQuery, dutySearchQuery, setDutySearchQuery,
    availableTracks, availableDuties, availableFunctionalAreas, availableRanks, processedData,
    setSelectedMemberProfile, setSelectedMember, setDetailLevel, setPromotionMember,
    getPromotionDetails, setReportsCollapsed, reportsCollapsed,
    unitStats, baseUnitStats, paginatedData, isMobile, currentPage, setCurrentPage,
    totalPages, handleLevelFilterClick, getEtSummary, displayData, DATA_CONSTANTS,
    LEVEL_DISPLAY_MAP, LEVELS, setFilterPromoReady, getTrainingIndicator,
    filterTlcQualified, setFilterTlcQualified
  } = props;

  const TRAINING_INDICATOR_STYLES = {
    good: { gradient: 'from-emerald-400 to-emerald-600', border: 'border-emerald-200', text: 'text-white' },
    warn: { gradient: 'from-amber-300 to-amber-500', border: 'border-amber-200', text: 'text-amber-900' },
    bad: { gradient: 'from-rose-400 to-rose-600', border: 'border-rose-200', text: 'text-white' },
    none: { gradient: 'from-slate-100 to-slate-200', border: 'border-slate-200', text: 'text-slate-500' }
  };

  return (
    <div className="space-y-4">
    {/* METRICS & FILTERS ROW */}
    <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col xl:flex-row gap-4 items-center justify-between">
        <div className="flex flex-wrap gap-3 items-center mb-4">
          <div className="flex items-center gap-2">
            <span className="text-xs font-bold text-slate-500 uppercase">Filters:</span>
            <button
              onClick={() => setShowSeniorFilters(v => !v)}
              className="text-xs px-2 py-1 rounded border border-slate-200 bg-slate-50 text-slate-700 hover:bg-slate-100"
            >
              {showSeniorFilters ? 'Hide' : 'Show'}
            </button>
          </div>
          {(activeFiltersCount > 0 || filterPromoReady || levelFilter.level !== null || searchQuery) && (
              <button onClick={clearFilters} className="text-xs text-red-600 bg-red-50 hover:bg-red-100 border border-red-200 px-3 py-1.5 rounded-lg font-medium transition-colors whitespace-nowrap">Reset All</button>
          )}

          {showSeniorFilters && (
            <>
          <FilterButton label="Rank Category" active={activeFilterMenu === 'rankCat'} onClick={() => setActiveFilterMenu(activeFilterMenu === 'rankCat' ? null : 'rankCat')}>
              <div className="text-[10px] uppercase font-bold text-slate-400 mb-1 px-2">By Category</div>
              {['OFFICER', 'NCO', 'FLIGHT', 'SM'].map(r => (
                  <div key={r} onClick={() => toggleFilter('rankCategories', r)} className={`px-2 py-1.5 rounded cursor-pointer flex justify-between items-center text-xs ${filters.rankCategories.includes(r) ? 'bg-blue-50 text-blue-600 font-medium' : 'hover:bg-slate-50 text-slate-600'}`}>
                  {r === 'SM' ? 'Senior Member' : r} {filters.rankCategories.includes(r) && <Icon name="Check" className="w-3 h-3 text-blue-600 inline-block" />}
                  </div>
              ))}
          </FilterButton>

          <FilterButton label="Specific Rank" active={activeFilterMenu === 'rank'} onClick={() => setActiveFilterMenu(activeFilterMenu === 'rank' ? null : 'rank')}>
              <div className="text-[10px] uppercase font-bold text-slate-400 mb-1 px-2">Individual Ranks</div>
              {availableRanks.map(r => (
                  <div key={r} onClick={() => toggleFilter('ranks', r)} className={`px-2 py-1.5 rounded cursor-pointer flex justify-between items-center text-xs ${filters.ranks.includes(r) ? 'bg-blue-50 text-blue-600 font-medium' : 'hover:bg-slate-50 text-slate-600'}`}>
                      {r} {filters.ranks.includes(r) && <Icon name="Check" className="w-3 h-3 text-blue-600 inline-block" />}
                  </div>
              ))}
          </FilterButton>

          <FilterButton label="Track Level" active={activeFilterMenu === 'trackLevel'} onClick={() => setActiveFilterMenu(activeFilterMenu === 'trackLevel' ? null : 'trackLevel')}>
              <div className="text-[10px] uppercase font-bold text-slate-400 mb-1 px-2">By Rating Level</div>
              {['MASTER', 'SENIOR', 'TECHNICIAN', 'NONE'].map(t => (
                  <div key={t} onClick={() => toggleFilter('trackLevels', t)} className={`px-2 py-1.5 rounded cursor-pointer flex justify-between items-center text-xs ${filters.trackLevels.includes(t) ? 'bg-purple-50 text-purple-600 font-medium' : 'hover:bg-slate-50 text-slate-600'}`}>
                      {t} {filters.trackLevels.includes(t) && <Icon name="Check" className="w-3 h-3 text-purple-600 inline-block" />}
                  </div>
              ))}
          </FilterButton>

          <FilterButton label="Specific Track" active={activeFilterMenu === 'tracks'} onClick={() => setActiveFilterMenu(activeFilterMenu === 'tracks' ? null : 'tracks')}>
              <div className="sticky top-0 bg-white z-10 pb-2 border-b border-slate-200 mb-2">
                <input
                  type="text"
                  placeholder="Search tracks..."
                  value={trackSearchQuery}
                  onChange={(e) => setTrackSearchQuery(e.target.value)}
                  onClick={(e) => e.stopPropagation()}
                  className="w-full px-2 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:border-blue-400"
                />
              </div>
              <div className="text-[10px] uppercase font-bold text-slate-400 mb-1 px-2">Specialty Tracks</div>
              <div className="max-h-48 overflow-y-auto">
                {availableTracks.filter(t => t.toLowerCase().includes(trackSearchQuery.toLowerCase())).map(t => (
                    <div key={t} onClick={() => toggleFilter('tracks', t)} className={`px-2 py-1.5 rounded cursor-pointer flex justify-between items-center text-xs ${filters.tracks.includes(t) ? 'bg-purple-50 text-purple-600 font-medium' : 'hover:bg-slate-50 text-slate-600'}`}>
                        {t} {filters.tracks.includes(t) && <Icon name="Check" className="w-3 h-3 text-purple-600 inline-block" />}
                    </div>
                ))}
                {availableTracks.filter(t => t.toLowerCase().includes(trackSearchQuery.toLowerCase())).length === 0 && (
                  <div className="text-xs text-slate-400 italic px-2 py-2 text-center">No matching tracks</div>
                )}
              </div>
          </FilterButton>

          <FilterButton label="Functional Area" active={activeFilterMenu === 'func'} onClick={() => setActiveFilterMenu(activeFilterMenu === 'func' ? null : 'func')}>
              <div className="text-[10px] uppercase font-bold text-slate-400 mb-1 px-2">By Functional Area</div>
              {Array.from(new Set(Object.values(DUTY_TO_TRACK_MAP))).sort().map(f => (
                  <div key={f} onClick={() => toggleFilter('functionalAreas', f)} className={`px-2 py-1.5 rounded cursor-pointer flex justify-between items-center text-xs ${filters.functionalAreas.includes(f) ? 'bg-indigo-50 text-indigo-600 font-medium' : 'hover:bg-slate-50 text-slate-600'}`}>
                      {f} {filters.functionalAreas.includes(f) && <Icon name="Check" className="w-3 h-3 text-indigo-600 inline-block" />}
                  </div>
              ))}
          </FilterButton>

          <FilterButton label="Duty Position" active={activeFilterMenu === 'duty'} onClick={() => setActiveFilterMenu(activeFilterMenu === 'duty' ? null : 'duty')}>
              <div className="sticky top-0 bg-white z-10 pb-2 border-b border-slate-200 mb-2">
                <input
                  type="text"
                  placeholder="Search duties..."
                  value={dutySearchQuery}
                  onChange={(e) => setDutySearchQuery(e.target.value)}
                  onClick={(e) => e.stopPropagation()}
                  className="w-full px-2 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:border-blue-400"
                />
              </div>
              <div className="text-[10px] uppercase font-bold text-slate-400 mb-1 px-2">Specific Positions</div>
              <div className="max-h-48 overflow-y-auto">
                {availableDuties.filter(d => d.toLowerCase().includes(dutySearchQuery.toLowerCase())).map(d => (
                    <div key={d} onClick={() => toggleFilter('duties', d)} className={`px-2 py-1.5 rounded cursor-pointer flex justify-between items-center text-xs ${filters.duties.includes(d) ? 'bg-indigo-50 text-indigo-600 font-medium' : 'hover:bg-slate-50 text-slate-600'}`}>
                        {d} {filters.duties.includes(d) && <Icon name="Check" className="w-3 h-3 text-indigo-600 inline-block" />}
                    </div>
                ))}
                {availableDuties.filter(d => d.toLowerCase().includes(dutySearchQuery.toLowerCase())).length === 0 && (
                  <div className="text-xs text-slate-400 italic px-2 py-2 text-center">No matching duties</div>
                )}
              </div>
              <div className="border-t border-slate-200 mt-2 pt-2">
                <div className="text-[10px] uppercase font-bold text-slate-400 mb-1 px-2">Assignment Type</div>
                {['PRIMARY', 'ASSISTANT'].map(dt => (
                  <div key={dt} onClick={() => toggleFilter('dutyTypes', dt)} className={`px-2 py-1.5 rounded cursor-pointer flex justify-between items-center text-xs ${filters.dutyTypes.includes(dt) ? 'bg-indigo-50 text-indigo-600 font-medium' : 'hover:bg-slate-50 text-slate-600'}`}>
                      {dt} {filters.dutyTypes.includes(dt) && <Icon name="Check" className="w-3 h-3 text-indigo-600 inline-block" />}
                  </div>
                ))}
              </div>
          </FilterButton>

          {/* Active filter pills */}
          {filters.rankCategories.map(r => <span key={`cat-${r}`} onClick={() => toggleFilter('rankCategories', r)} className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full cursor-pointer hover:bg-blue-200 flex items-center text-xs whitespace-nowrap">{r} <span className="ml-1">x</span></span>)}
          {filters.ranks.map(r => <span key={r} onClick={() => toggleFilter('ranks', r)} className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full cursor-pointer hover:bg-blue-200 flex items-center text-xs whitespace-nowrap">{r} <span className="ml-1">x</span></span>)}
          {filters.trackLevels.map(t => <span key={`level-${t}`} onClick={() => toggleFilter('trackLevels', t)} className="px-2 py-1 bg-purple-100 text-purple-700 rounded-full cursor-pointer hover:bg-purple-200 flex items-center text-xs whitespace-nowrap">{t} <span className="ml-1">x</span></span>)}
          {filters.tracks.map(t => <span key={t} onClick={() => toggleFilter('tracks', t)} className="px-2 py-1 bg-purple-100 text-purple-700 rounded-full cursor-pointer hover:bg-purple-200 flex items-center text-xs whitespace-nowrap">{t.length > 20 ? t.substring(0, 20) + '...' : t} <span className="ml-1">x</span></span>)}
          {filters.functionalAreas.map(f => <span key={f} onClick={() => toggleFilter('functionalAreas', f)} className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full cursor-pointer hover:bg-indigo-200 flex items-center text-xs whitespace-nowrap">{f} <span className="ml-1">x</span></span>)}
          {filters.duties.map(d => <span key={d} onClick={() => toggleFilter('duties', d)} className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full cursor-pointer hover:bg-indigo-200 flex items-center text-xs whitespace-nowrap">{d.length > 20 ? d.substring(0, 20) + '...' : d} <span className="ml-1">x</span></span>)}
          {filters.dutyTypes.map(dt => <span key={dt} onClick={() => toggleFilter('dutyTypes', dt)} className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full cursor-pointer hover:bg-indigo-200 flex items-center text-xs whitespace-nowrap">{dt} <span className="ml-1">x</span></span>)}
            </>
          )}
      </div>

      {unitStats && (
        <div className="flex flex-wrap justify-center gap-4 text-sm flex-1">
           {/* Base stats when no filters, filtered count when filters active */}
           {baseUnitStats && activeFiltersCount === 0 && (
             <>
               <div className="flex flex-col items-center leading-tight">
                  <span className="font-bold text-xl text-slate-800">{baseUnitStats.total}</span>
                  <span className="text-[10px] uppercase font-bold text-slate-400">Total</span>
               </div>
               <div className="h-8 w-px bg-slate-100"></div>
               <div className="flex flex-col items-center leading-tight">
                  <span className="font-bold text-xl text-blue-600">{baseUnitStats.seniors}</span>
                  <span className="text-[10px] uppercase font-bold text-slate-400">Seniors</span>
               </div>
               <div className="flex flex-col items-center leading-tight">
                  <span className="font-bold text-xl text-slate-600">{baseUnitStats.cadets}</span>
                  <span className="text-[10px] uppercase font-bold text-slate-400">Cadets</span>
               </div>
               <div className="h-8 w-px bg-slate-100"></div>
             </>
           )}

           {activeFiltersCount > 0 && (
             <>
               <div className="flex flex-col items-center leading-tight">
                  <span className="font-bold text-xl text-blue-600">{unitStats.filtered}</span>
                  <span className="text-[10px] uppercase font-bold text-slate-400">Filtered</span>
               </div>
               <div className="h-8 w-px bg-slate-100"></div>
             </>
           )}

           <div onClick={()=>setFilterPromoReady(!filterPromoReady)} className={`flex flex-col items-center cursor-pointer transition-colors leading-tight px-2 rounded ${filterPromoReady ? 'bg-green-50' : 'hover:bg-slate-50'}`}>
              <span className="font-bold text-xl text-green-600 flex items-center">{unitStats.promoReady} {filterPromoReady && <Icon name="Check" className="w-3 h-3 ml-1" />}</span>
              <span className="text-[10px] uppercase font-bold text-slate-400">Promotable</span>
           </div>

           <div className="h-8 w-px bg-slate-100"></div>

           {/* Level Stats */}
           <div className="flex gap-1.5 items-center">
              {LEVELS.map(l => {
                const isActive = levelFilter.level === l.id;
                let bgClass = 'bg-slate-500';
                let ringClass = '';
                if (isActive) {
                    if (levelFilter.state === 'complete') { bgClass = 'bg-green-600'; ringClass = 'ring-2 ring-green-400 ring-offset-2'; }
                    else if (levelFilter.state === 'incomplete') { bgClass = 'bg-amber-500'; ringClass = 'ring-2 ring-amber-400 ring-offset-2'; }
                }
                return (
                  <div key={l.id} className="flex flex-col items-center cursor-pointer group" onClick={() => handleLevelFilterClick(l.id)}>
                     <div className={`w-6 h-6 rounded-full flex items-center justify-center text-[11px] font-bold text-white shadow-sm transition-all ${bgClass} ${ringClass} group-hover:opacity-90`}>{unitStats.levelCounts[l.id] || 0}</div>
                     <span className="text-[9px] font-bold text-slate-300 mt-0.5 group-hover:text-slate-500">L{l.label}</span>
                  </div>
                )
              })}
           </div>

           <div className="h-8 w-px bg-slate-100"></div>

           {/* Enhanced Statistics */}
           <div className="flex flex-col items-center leading-tight cursor-help group relative" title="Average Time in Current Grade">
              <span className="font-bold text-lg text-amber-600">{unitStats.avgTIG}m</span>
              <span className="text-[10px] uppercase font-bold text-slate-400">Avg TIG</span>
              <div className="absolute bottom-full mb-2 hidden group-hover:block z-50 w-max bg-slate-800 text-white text-xs rounded py-1 px-2 shadow-lg">
                Average Time in Grade: {unitStats.avgTIG} months
              </div>
           </div>

           <div className="flex flex-col items-center leading-tight cursor-help group relative" title="Members with Duty Assignments">
              <span className="font-bold text-lg text-indigo-600">{unitStats.dutyAssignmentRate}%</span>
              <span className="text-[10px] uppercase font-bold text-slate-400">W/ Duty</span>
              <div className="absolute bottom-full mb-2 hidden group-hover:block z-50 w-max bg-slate-800 text-white text-xs rounded py-1 px-2 shadow-lg">
                {unitStats.withDuties} / {unitStats.filtered} with duty assignments ({unitStats.dutyAssignmentRate}%)
              </div>
           </div>

           <div className="flex flex-col items-center leading-tight cursor-help group relative" title="Specialty Track Enrollment">
              <span className="font-bold text-lg text-purple-600">{unitStats.trackEnrollmentRate}%</span>
              <span className="text-[10px] uppercase font-bold text-slate-400">Enrolled</span>
              <div className="absolute bottom-full mb-2 hidden group-hover:block z-50 w-max bg-slate-800 text-white text-xs rounded py-1 px-2 shadow-lg">
                Track Enrollment: {unitStats.withTracks} / {unitStats.filtered} ({unitStats.trackEnrollmentRate}%)
                <div className="text-[10px] text-slate-300 mt-1 pt-1 border-t border-slate-600">
                  Master: {unitStats.withMasterTrack} | Senior: {unitStats.withSeniorTrack} | Tech: {unitStats.withTechTrack}
                </div>
              </div>
           </div>

           {unitStats.cadetProtection && (
             <>
               <div className="h-8 w-px bg-slate-100"></div>
               <div className="flex flex-col items-center leading-tight cursor-help group relative" title="Cadet Protection Compliance">
                 <span className={`font-bold text-lg ${
                   unitStats.cadetProtection.nonCompliant > 0 ? 'text-rose-600' :
                   unitStats.cadetProtection.dueSoon > 0 ? 'text-amber-600' :
                   'text-emerald-600'
                 }`}>
                   {unitStats.cadetProtection.percent}%
                 </span>
                 <span className="text-[10px] uppercase font-bold text-slate-400">CP Compliant</span>
                 <div className="absolute bottom-full mb-2 hidden group-hover:block z-50 w-max bg-slate-800 text-white text-xs rounded py-1 px-2 shadow-lg">
                   Compliant: {unitStats.cadetProtection.compliant} / {unitStats.cadetProtection.requiredMembers}
                   <div className="text-[10px] text-slate-300 mt-1 pt-1 border-t border-slate-600">
                     Due Soon: {unitStats.cadetProtection.dueSoon} | Overdue: {unitStats.cadetProtection.overdue} | Missing: {unitStats.cadetProtection.missing}
                   </div>
                 </div>
               </div>
             </>
           )}

           {unitStats.tlcCompliance && (
             <>
               <div className="h-8 w-px bg-slate-100"></div>
               <div
                 onClick={() => { setFilterTlcQualified(!filterTlcQualified); setCurrentPage(1); }}
                 className={`flex flex-col items-center leading-tight cursor-pointer group relative px-2 rounded transition-colors ${filterTlcQualified ? 'bg-amber-50' : 'hover:bg-slate-50'}`}
                 title="Training Leaders of Cadets Compliance"
               >
                 <span className={`font-bold text-lg ${
                   unitStats.tlcCompliance.isCompliant ? 'text-emerald-600' :
                   unitStats.tlcCompliance.qualified > 0 ? 'text-amber-600' :
                   'text-rose-600'
                 }`}>
                   {unitStats.tlcCompliance.qualified}/{unitStats.tlcCompliance.required}
                 </span>
                 <span className="text-[10px] uppercase font-bold text-slate-400">
                   TLC Credit {filterTlcQualified && <Icon name="Check" className="w-3 h-3 ml-1 inline-block text-amber-600" />}
                 </span>
                 <div className="absolute bottom-full mb-2 hidden group-hover:block z-50 w-max bg-slate-800 text-white text-xs rounded py-1 px-2 shadow-lg">
                   Qualified: {unitStats.tlcCompliance.qualified} / {unitStats.tlcCompliance.required}
                 </div>
               </div>
             </>
           )}
        </div>
      )}
    </div>

    {isMobile ? (
      <div className="space-y-3">
        {paginatedData.length === 0 && (
          <div className="bg-white border border-slate-200 rounded-lg p-8 text-center text-slate-400">
            No members match the filters.
          </div>
        )}
        {paginatedData.map((m) => {
          const et = getEtSummary(m);
          const etLabel = et.nextId ? (LEVEL_DISPLAY_MAP[et.nextId]?.name || et.nextId) : 'All Levels Complete';
          const etPct = et.nextStatus ? et.nextStatus.percent || 0 : 100;
          const promo = getPromotionDetails(m);
          const promoReady = promo && promo.isTigMet && promo.isLevelMet && (!promo.dutyReq || promo.isDutyMet);
          const tracksPreview = m.tracks.slice(0, 2);
          const dutiesPreview = m.duties.slice(0, 2);
          const extraTracks = Math.max(0, m.tracks.length - tracksPreview.length);
          const extraDuties = Math.max(0, m.duties.length - dutiesPreview.length);
          const trainingIndicator = getTrainingIndicator ? getTrainingIndicator(m) : null;
          const indicatorTone = trainingIndicator?.tone || 'none';
          const indicatorStyle = TRAINING_INDICATOR_STYLES[indicatorTone] || TRAINING_INDICATOR_STYLES.none;
          const indicatorTitle = trainingIndicator?.title || 'Cadet Protection: No data';
          return (
            <div key={m.CAPID} className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
              <div className="flex items-start gap-3">
                <div
                  onClick={()=>setSelectedMemberProfile(m)}
                  className={`relative w-12 h-12 rounded-full bg-gradient-to-br ${indicatorStyle.gradient} ${indicatorStyle.text} flex items-center justify-center font-bold leading-none border-2 ${indicatorStyle.border} shadow-sm shrink-0 cursor-pointer transition-all`}
                  title={`${indicatorTitle}\nClick to view full profile`}
                >
                  {m.NameLast.charAt(0)}
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex flex-col">
                    <button
                      onClick={()=>setSelectedMemberProfile(m)}
                      className="text-base font-bold text-slate-900 text-left hover:text-blue-600"
                    >
                      {m.NameLast}, {m.NameFirst}
                    </button>
                    <div className="text-xs text-slate-500 font-mono">{m.memberUnitName} â€¢ #{m.CAPID}</div>
                    <div className="text-xs text-slate-600 mt-1 flex items-center gap-2">
                      <span className="font-semibold text-blue-700">{m.Rank}</span>
                      {promo && (
                        <span className={`px-2 py-0.5 rounded-full text-[11px] font-bold ${promoReady ? 'bg-green-100 text-green-700' : 'bg-amber-50 text-amber-700'}`}>
                          {promoReady ? 'Eligible' : 'Next: ' + promo.nextRank}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
                <button
                  onClick={()=>setPromotionMember(m)}
                  className="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 bg-blue-50 border border-blue-100 rounded-lg"
                >
                  Promo
                </button>
              </div>

              <div className="mt-3 space-y-2">
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-2">
                  <div className="flex items-center justify-between text-xs text-slate-700">
                    <span className="font-semibold">Education & Training</span>
                    <span className="text-[11px] text-slate-500">{etLabel}</span>
                  </div>
                  <div className="mt-2 h-2 bg-white rounded-full border border-slate-200 overflow-hidden">
                    <div className={`${etPct === 100 ? 'bg-green-500' : 'bg-blue-500'} h-full`} style={{ width: `${etPct}%` }}></div>
                  </div>
                  {et.nextStatus && et.nextStatus.status === 'pending' && (
                    <div className="text-[11px] text-amber-600 mt-1">Submitted / Awaiting approval</div>
                  )}
                </div>

                {tracksPreview.length > 0 && (
                  <div className="flex flex-wrap gap-1.5">
                    {tracksPreview.map((t, i) => {
                      const badgeClass = t.level==='MASTER'?'bg-purple-100 text-purple-700':t.level==='SENIOR'?'bg-blue-100 text-blue-700': t.level==='TECHNICIAN'?'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600';
                      return (
                        <span key={i} className={`text-[11px] font-semibold px-2 py-1 rounded border border-slate-200 ${badgeClass}`}>
                          {normalizeTrackDisplayName(t.name)} â€¢ {t.level}
                        </span>
                      );
                    })}
                    {extraTracks > 0 && (
                      <span className="text-[11px] font-semibold px-2 py-1 rounded bg-slate-100 text-slate-700 border border-slate-200">
                        +{extraTracks} more
                      </span>
                    )}
                  </div>
                )}

                {dutiesPreview.length > 0 && (
                  <div className="flex flex-wrap gap-1.5">
                    {dutiesPreview.map((d, i) => (
                      <Badge key={i} color="gray" warning={!d.hasTrack} isRed={['COMMANDER','CHAPLAIN','CHARACTER DEVELOPMENT INSTRUCTOR'].includes(d.name.toUpperCase().trim())}>
                        {d.displayName}
                      </Badge>
                    ))}
                    {extraDuties > 0 && (
                      <span className="text-[11px] font-semibold px-2 py-1 rounded bg-slate-100 text-slate-700 border border-slate-200">
                        +{extraDuties} more
                      </span>
                    )}
                  </div>
                )}

                {m.esQualifications && m.esQualifications.length > 0 && (
                  <div className="mt-3 pt-3 border-t border-slate-100">
                    <div className="text-xs font-semibold text-slate-600 mb-2">ES Qualifications</div>
                    <div className="flex flex-wrap gap-1.5">
                      {m.esQualifications.slice(0, 3).map((qual, idx) => (
                        <ESBadge
                          key={idx}
                          qualification={qual}
                          onClick={() => setSelectedMemberProfile(m)}
                          size="small"
                        />
                      ))}
                      {m.esQualifications.length > 3 && (
                        <span className="text-[11px] text-slate-500">
                          +{m.esQualifications.length - 3} more
                        </span>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        })}

        {totalPages > 1 && (
          <div className="flex justify-between items-center p-3 bg-white border border-slate-200 rounded-lg">
            <span className="text-xs text-slate-500">Page {currentPage} of {totalPages}</span>
            <div className="flex gap-2">
              <button disabled={currentPage === 1} onClick={() => setCurrentPage(c => c - 1)} className="px-3 py-1 bg-white border rounded text-xs disabled:opacity-50 hover:bg-slate-50">Prev</button>
              <button disabled={currentPage === totalPages} onClick={() => setCurrentPage(c => c + 1)} className="px-3 py-1 bg-white border rounded text-xs disabled:opacity-50 hover:bg-slate-50">Next</button>
            </div>
          </div>
        )}
      </div>
    ) : (
      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative">
        <div className="overflow-x-auto">
          <table className="w-full min-w-[880px] text-left text-sm">
            <thead className="bg-slate-50 border-b border-slate-200 sticky top-0 z-20">
              <tr className="text-left text-xs font-bold uppercase text-slate-500">
                <th className="px-4 sm:px-6 py-3 tracking-wider min-w-[200px]">Member</th>
                <th className="px-4 sm:px-6 py-3 text-center tracking-wider min-w-[170px]">ET Level</th>
                <th className="px-4 sm:px-6 py-3 tracking-wider min-w-[220px]">Specialty Tracks</th>
                <th className="px-4 sm:px-6 py-3 tracking-wider min-w-[220px]">Duty Assignments</th>
                <th className="px-4 sm:px-6 py-3 tracking-wider min-w-[220px]">ES Qualifications</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {paginatedData.map(m => (
                <tr
                  key={m.CAPID}
                  className="hover:bg-slate-50 transition-colors cursor-pointer"
                  onClick={() => setSelectedMemberProfile(m)}
                >
                  <td className="px-4 sm:px-6 py-4 align-top">
                    <div className="flex items-start gap-3">
                    {(() => {
                      const trainingIndicator = getTrainingIndicator ? getTrainingIndicator(m) : null;
                      const indicatorTone = trainingIndicator?.tone || 'none';
                      const indicatorStyle = TRAINING_INDICATOR_STYLES[indicatorTone] || TRAINING_INDICATOR_STYLES.none;
                      const indicatorTitle = trainingIndicator?.title || 'Cadet Protection: No data';
                      return (
                    <div
                      onClick={(e) => { e.stopPropagation(); setSelectedMemberProfile(m); }}
                      className={`relative w-10 h-10 rounded-full bg-gradient-to-br ${indicatorStyle.gradient} ${indicatorStyle.text} flex items-center justify-center font-bold leading-none border-2 ${indicatorStyle.border} shadow-sm shrink-0 cursor-pointer hover:shadow-md transition-all hover:scale-105`}
                      title={`${indicatorTitle}\nClick to view full profile`}
                    >
                      {m.NameLast.charAt(0)}
                    </div>
                      );
                    })()}
                    <div className="flex-1">
                      <div
                        onClick={(e) => { e.stopPropagation(); setSelectedMemberProfile(m); }}
                        className="font-bold text-slate-900 cursor-pointer hover:text-blue-600 hover:underline decoration-2 underline-offset-2 transition-all flex items-center gap-1.5 w-max group"
                        title="Click to view full profile"
                      >
                        {m.NameLast}, {m.NameFirst}
                        <Icon name="User" className="w-3.5 h-3.5 opacity-0 group-hover:opacity-100 text-blue-600 transition-opacity" />
                      </div>
                      <div className="text-xs text-slate-400 font-mono mt-0.5">{m.memberUnitName}</div>
                      <div onClick={(e) => { e.stopPropagation(); setPromotionMember(m); }} className="text-xs text-blue-600 cursor-pointer hover:text-blue-800 font-medium flex items-center mt-0.5 group w-max">
                              {m.Rank} | #{m.CAPID} <Icon name="ChevronRight" className="w-3 h-3 ml-0.5 opacity-0 group-hover:opacity-100 transition-opacity" />
                      </div>
                    </div>
                  </div>
                  </td>
                  <td className="px-4 sm:px-6 py-4 align-top">
                    <div className="flex justify-center gap-1.5">
                      {LEVELS.map(lvl => (
                        <LevelIndicator key={lvl.id} level={lvl.id} label={lvl.label} name={lvl.name} progress={m.levelsProgress[lvl.id] || { percent: 0, status: 'not-started' }} onClick={(e)=>{e.stopPropagation(); setSelectedMember(m); setDetailLevel(lvl.id)}} />
                      ))}
                    </div>
                    {LEVEL_ORDER.some(id => m.levelsProgress[id] && (m.levelsProgress[id].status === 'ready' || m.levelsProgress[id].status === 'pending')) && (
                      <div className="text-[10px] text-amber-600 font-semibold text-center mt-1">Needs approval/submission</div>
                    )}
                  </td>
                  <td className="px-4 sm:px-6 py-4 align-top space-y-1.5">
                    {m.tracks.length > 0 ? m.tracks.map((t,i) => {
                      const isNone = t.level === 'NONE';
                      const badgeClass = t.level==='MASTER'?'bg-purple-100 text-purple-700':t.level==='SENIOR'?'bg-blue-100 text-blue-700': t.level==='TECHNICIAN'?'bg-green-100 text-green-700' : 'text-slate-400 font-normal';
                      return (
                      <div key={i} className="text-xs flex items-center justify-between bg-slate-50 px-2 py-1 rounded border border-slate-100 group hover:border-blue-200 transition-colors relative cursor-help">
                        <div className="flex items-center font-medium text-slate-700">
                          {t.warningMsg && <div className="mr-1.5" title={t.warningMsg}><WarningTriangle /></div>}
                          {normalizeTrackDisplayName(t.name)}
                        </div>
                        <div className={`ml-2 text-[10px] font-bold px-1.5 rounded ${badgeClass}`}>{t.level.substring(0,4)}</div>
                        <div className="absolute left-0 bottom-full mb-1 hidden group-hover:block w-max bg-slate-800 text-white text-xs rounded py-1 px-2 z-50 shadow-lg border border-slate-600">
                           <div className="font-bold border-b border-slate-600 pb-1 mb-1">{normalizeTrackDisplayName(t.name)}</div>
                           <div>Awarded: {t.date}</div>
                           {t.warningMsg && <div className="text-amber-300 mt-1 pt-1 border-t border-slate-600 font-bold flex items-center"><WarningTriangle /> {t.warningMsg}</div>}
                        </div>
                      </div>
                    )}) : <span className="text-xs text-slate-400 italic">No tracks recorded</span>}
                  </td>
                  <td className="px-4 sm:px-6 py-4 align-top">
                    <div className="flex flex-wrap gap-1.5">
                      {m.duties.length > 0 ? m.duties.map((d,i) => {
                         const isRed = ['COMMANDER', 'CHAPLAIN', 'CHARACTER DEVELOPMENT INSTRUCTOR'].includes(d.name.toUpperCase().trim());
                         const isCrossUnit = d.orgString !== m.memberUnitName;
                         return (
                           <div key={i} className="relative group/duty">
                             <div className="relative">
                               <Badge warning={!d.hasTrack} color="gray" isRed={isRed}>{d.displayName}</Badge>
                               {isCrossUnit && (
                                 <span className="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 border-2 border-white rounded-full" title="Cross-unit assignment"></span>
                               )}
                             </div>
                             <div className="absolute left-0 bottom-full mb-1 hidden group-hover/duty:block w-max bg-slate-800 text-white text-xs rounded py-1 px-2 z-50 shadow-lg border border-slate-600">
                                <div className="font-bold border-b border-slate-600 pb-1 mb-1">{d.displayName}</div>
                                <div>Assigned: {d.date}</div>
                                <div className={isCrossUnit ? "text-blue-300 font-bold" : ""}>Unit: {d.orgString}</div>
                                {isCrossUnit && <div className="text-blue-300 text-[10px] mt-1 flex items-center"><svg className="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/></svg> Cross-Unit Assignment</div>}
                                {!d.hasTrack && <div className="text-amber-300 mt-1 pt-1 border-t border-slate-600 font-bold flex items-center"><WarningTriangle /> {d.warningMsg}</div>}
                             </div>
                           </div>
                         );
                      }) : <span className="text-xs text-slate-400 italic">No duties assigned</span>}
                    </div>
                  </td>
                  <td className="px-4 sm:px-6 py-4 align-top">
                    <div className="flex flex-wrap gap-1.5">
                      {m.esQualifications && m.esQualifications.length > 0 ? (
                        m.esQualifications.map((qual, idx) => (
                          <ESBadge
                            key={idx}
                            qualification={qual}
                            onClick={(e) => {
                              e.stopPropagation();
                              setSelectedMemberProfile(m);
                            }}
                            size="small"
                          />
                        ))
                      ) : (
                        <span className="text-xs text-slate-400 italic">None</span>
                      )}
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        
        {/* PAGINATION CONTROLS */}
        {totalPages > 1 && (
          <div className="flex justify-between items-center p-4 bg-slate-50 border-t border-slate-200">
            <span className="text-xs text-slate-500">Showing {((currentPage - 1) * DATA_CONSTANTS.ITEMS_PER_PAGE) + 1} to {Math.min(currentPage * DATA_CONSTANTS.ITEMS_PER_PAGE, displayData.length)} of {displayData.length} members</span>
            <div className="flex gap-2">
               <button disabled={currentPage === 1} onClick={() => setCurrentPage(c => c - 1)} className="px-3 py-1 bg-white border rounded text-xs disabled:opacity-50 hover:bg-slate-50">Previous</button>
               <button disabled={currentPage === totalPages} onClick={() => setCurrentPage(c => c + 1)} className="px-3 py-1 bg-white border rounded text-xs disabled:opacity-50 hover:bg-slate-50">Next</button>
            </div>
          </div>
        )}
      </div>
    )}
    </div>
  );
}
</script>

<script type="text/babel">
function CadetDashboard(props) {
  const {
    phaseFilter, setPhaseFilter, cadetSearchQuery, setCadetSearchQuery,
    cadetData, setSelectedCadetProfile, selectedCadetProfile,
    setSelectedMemberProfile, processedCadets, searchQuery, filterStatus,
    setFilterStatus, filters, toggleFilter, setFilters, showCadetFilters,
    setShowCadetFilters, getRankInsigniaUrl, getAchievementDisplayName,
    filterPhase, setFilterPhase, filter90Days, setFilter90Days, isMobile,
    activeFilterMenu, setActiveFilterMenu, dutySearchQuery, setDutySearchQuery,
    setSelectedCadet, selectedCadet, CADET_ACHIEVEMENT_TO_RANK, dataFiles, cadetDataService,
    getCadetProtectionStatus
  } = props;

  // Cadet duty position ranking for ordering
  const CADET_DUTY_RANK = {
    'CADET COMMANDER': 1,
    'CADET DEPUTY COMMANDER FOR OPERATIONS': 2,
    'CADET DEPUTY COMMANDER FOR SUPPORT': 3,
    'CADET FIRST SERGEANT': 4,
    'CADET FLIGHT COMMANDER': 5,
    'CADET FLIGHT SERGEANT': 6,
    'CADET ADMINISTRATIVE OFFICER': 10,
    'CADET PUBLIC AFFAIRS OFFICER': 11,
    'CADET COMMUNICATIONS OFFICER': 12,
    'CADET SUPPLY OFFICER': 13,
    'CADET SAFETY OFFICER': 14,
    'CADET ELEMENT LEADER': 20
  };

  const getDutyRank = (dutyName) => {
    const normalizedDuty = (dutyName || '').toUpperCase().trim();
    return CADET_DUTY_RANK[normalizedDuty] || 99;
  };

  const TRAINING_INDICATOR_STYLES = {
    good: 'border-l-4 border-l-transparent',
    warn: 'border-l-4 border-l-amber-400',
    bad: 'border-l-4 border-l-rose-500',
    none: 'border-l-4 border-l-transparent'
  };

  const TRAINING_TONE_SEVERITY = { bad: 3, warn: 2, good: 1, none: 0 };

  const getTrainingIndicatorSummary = (cadetProtectionStatus) => {
    const indicators = [];
    if (cadetProtectionStatus && cadetProtectionStatus.indicator && cadetProtectionStatus.indicator.tone !== 'none') {
      indicators.push({
        id: 'cp',
        tone: cadetProtectionStatus.indicator?.tone || 'none',
        title: cadetProtectionStatus.indicator?.title || 'Cadet Protection'
      });
    }

    if (indicators.length === 0) {
      return { tone: 'none', title: 'Training: Not required', indicators: [] };
    }

    const worst = indicators.reduce((current, item) => (
      (TRAINING_TONE_SEVERITY[item.tone] || 0) > (TRAINING_TONE_SEVERITY[current.tone] || 0) ? item : current
    ), indicators[0]);

    return {
      tone: worst.tone,
      title: indicators.map(item => item.title).join('\n'),
      indicators
    };
  };

  const sortedCadets = [...processedCadets].sort((a, b) => (a.NameLast || '').localeCompare(b.NameLast || ''));
  const promotionReady = processedCadets.filter(c => c.promotionStatus && c.promotionStatus.status === 'READY').length;
  const nearlyReady = processedCadets.filter(c => c.promotionStatus && (c.promotionStatus.status === 'NEARLY_READY' || c.promotionStatus.status === 'TIME_PENDING')).length;
  const totalHonorCredits = processedCadets.reduce((sum, c) => sum + (c.honorCreditAchievements?.length || 0), 0);

  // Get unique cadet ranks and duty positions for filters
  const uniqueRanks = [...new Set(sortedCadets.map(c => c.currentRank))].filter(Boolean).sort();
  const uniqueDuties = [...new Set(sortedCadets.flatMap(c => c.cadetDuties?.map(d => d.name) || []))].filter(Boolean).sort();

  // Apply filters
  let filteredCadets = sortedCadets;

  // Search filter
  if (searchQuery) {
    const search = searchQuery.toLowerCase();
    filteredCadets = filteredCadets.filter(c => {
      const nameMatch = ((c.NameLast || '') + (c.NameFirst || '') + (c.CAPID || '')).toLowerCase().includes(search);
      const rankMatch = (c.currentRank || '').toLowerCase().includes(search);
      const dutyMatch = (c.cadetDuties || []).some(d => (d.name || '').toLowerCase().includes(search));
      return nameMatch || rankMatch || dutyMatch;
    });
  }

  // Status filter
  if (filterStatus !== 'ALL') {
    filteredCadets = filteredCadets.filter(c => c.promotionStatus && c.promotionStatus.status === filterStatus);
  }

  // Rank filter (using filters.ranks from state)
  if (filters.ranks.length > 0) {
    filteredCadets = filteredCadets.filter(c => filters.ranks.includes(c.currentRank));
  }

  // Duty filter (using filters.duties from state)
  if (filters.duties.length > 0) {
    filteredCadets = filteredCadets.filter(c => {
      return (c.cadetDuties || []).some(d => {
        const cleanDuty = (d.name || '').toUpperCase().trim();
        return filters.duties.some(filterDuty => cleanDuty.includes(filterDuty.toUpperCase()));
      });
    });
  }

  // Phase filter
  if (filterPhase !== null) {
    filteredCadets = filteredCadets.filter(c => c.phase === filterPhase);
  }

  // 90+ days without promotion filter
  if (filter90Days) {
    filteredCadets = filteredCadets.filter(c => c.timeInGrade?.days >= 90);
  }

  // Calculate stats for filtered results
  const filteredStats = {
    total: filteredCadets.length,
    ready: filteredCadets.filter(c => c.promotionStatus?.status === 'READY').length,
    nearlyReady: filteredCadets.filter(c => c.promotionStatus && (c.promotionStatus.status === 'NEARLY_READY' || c.promotionStatus.status === 'TIME_PENDING')).length,
    honorCredits: filteredCadets.reduce((sum, c) => sum + (c.honorCreditAchievements?.length || 0), 0),
    days90Plus: filteredCadets.filter(c => c.timeInGrade?.days >= 90).length,
    phases: {
      1: filteredCadets.filter(c => c.phase === 1).length,
      2: filteredCadets.filter(c => c.phase === 2).length,
      3: filteredCadets.filter(c => c.phase === 3).length,
      4: filteredCadets.filter(c => c.phase === 4).length,
      5: filteredCadets.filter(c => c.phase === 5).length,
    }
  };

  const cadetProtectionStats = (() => {
    if (!getCadetProtectionStatus) return null;
    let requiredMembers = 0;
    let compliant = 0;
    let dueSoon = 0;
    let overdue = 0;
    let missing = 0;

    filteredCadets.forEach(cadet => {
      const status = getCadetProtectionStatus(cadet);
      if (!status || status.requiredCourses.length === 0) return;
      requiredMembers += 1;
      if (status.isCompliant) {
        compliant += 1;
        if (status.indicator?.status === 'due-soon') {
          dueSoon += 1;
        }
      } else if (status.indicator?.status === 'overdue') {
        overdue += 1;
      } else {
        missing += 1;
      }
    });

    const percent = requiredMembers ? Math.round((compliant / requiredMembers) * 100) : 100;
    return {
      requiredMembers,
      compliant,
      dueSoon,
      overdue,
      missing,
      nonCompliant: requiredMembers - compliant,
      percent
    };
  })();

  const activeFiltersCount = filters.ranks.length + filters.duties.length + (filterStatus !== 'ALL' ? 1 : 0) + (filterPhase !== null ? 1 : 0) + (filter90Days ? 1 : 0);

  return (
    <div className="space-y-4">
      {/* Compact Toolbar - Similar to Senior Dashboard */}
      <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col xl:flex-row gap-4 items-center justify-between">
        {/* Filters Row */}
        <div className="flex flex-wrap gap-3 items-center">
          <div className="flex items-center gap-2">
            <span className="text-xs font-bold text-slate-500 uppercase">Filters:</span>
            <button
              onClick={() => setShowCadetFilters(v => !v)}
              className="text-xs px-2 py-1 rounded border border-slate-200 bg-slate-50 text-slate-700 hover:bg-slate-100"
            >
              {showCadetFilters ? 'Hide' : 'Show'}
            </button>
          </div>
          {activeFiltersCount > 0 && (
            <button
              onClick={() => {
                setFilters({ ...filters, ranks: [], duties: [] });
                setFilterStatus('ALL');
                setFilterPhase(null);
                setFilter90Days(false);
              }}
              className="text-xs text-red-600 bg-red-50 hover:bg-red-100 border border-red-200 px-3 py-1.5 rounded-lg font-medium transition-colors whitespace-nowrap"
            >
              Reset All
            </button>
          )}

          {showCadetFilters && (
            <>
              {/* Status Filter */}
              <FilterButton label="Promotion Status" active={activeFilterMenu === 'cadetStatus'} onClick={() => setActiveFilterMenu(activeFilterMenu === 'cadetStatus' ? null : 'cadetStatus')}>
                <div className="text-[10px] uppercase font-bold text-slate-400 mb-1 px-2">Status</div>
                {['ALL', 'READY', 'TIME_PENDING', 'NEARLY_READY', 'IN_PROGRESS', 'NOT_STARTED'].map(status => (
                  <div
                    key={status}
                    onClick={() => setFilterStatus(status)}
                    className={`px-2 py-1.5 rounded cursor-pointer flex justify-between items-center text-xs ${
                      filterStatus === status ? 'bg-blue-50 text-blue-600 font-medium' : 'hover:bg-slate-50 text-slate-600'
                    }`}
                  >
                    {status.replace('_', ' ')} {filterStatus === status && <Icon name="Check" className="w-3 h-3 text-blue-600 inline-block" />}
                  </div>
                ))}
              </FilterButton>

              {/* Rank Filter */}
              <FilterButton label="Cadet Rank" active={activeFilterMenu === 'cadetRank'} onClick={() => setActiveFilterMenu(activeFilterMenu === 'cadetRank' ? null : 'cadetRank')}>
                <div className="text-[10px] uppercase font-bold text-slate-400 mb-1 px-2">Cadet Ranks</div>
                <div className="max-h-48 overflow-y-auto">
                  {uniqueRanks.map(rank => (
                    <div
                      key={rank}
                      onClick={() => toggleFilter('ranks', rank)}
                      className={`px-2 py-1.5 rounded cursor-pointer flex justify-between items-center text-xs ${
                        filters.ranks.includes(rank) ? 'bg-blue-50 text-blue-600 font-medium' : 'hover:bg-slate-50 text-slate-600'
                      }`}
                    >
                      {rank} {filters.ranks.includes(rank) && <Icon name="Check" className="w-3 h-3 text-blue-600 inline-block" />}
                    </div>
                  ))}
                </div>
              </FilterButton>

              {/* Duty Position Filter */}
              <FilterButton label="Duty Position" active={activeFilterMenu === 'cadetDuty'} onClick={() => setActiveFilterMenu(activeFilterMenu === 'cadetDuty' ? null : 'cadetDuty')}>
                <div className="sticky top-0 bg-white z-10 pb-2 border-b border-slate-200 mb-2">
                  <input
                    type="text"
                    placeholder="Search duties..."
                    value={dutySearchQuery}
                    onChange={(e) => setDutySearchQuery(e.target.value)}
                    onClick={(e) => e.stopPropagation()}
                    className="w-full px-2 py-1.5 text-xs border border-slate-300 rounded focus:outline-none focus:border-blue-400"
                  />
                </div>
                <div className="text-[10px] uppercase font-bold text-slate-400 mb-1 px-2">Cadet Positions</div>
                <div className="max-h-48 overflow-y-auto">
                  {uniqueDuties.filter(d => d.toLowerCase().includes(dutySearchQuery.toLowerCase())).map(duty => (
                    <div
                      key={duty}
                      onClick={() => toggleFilter('duties', duty)}
                      className={`px-2 py-1.5 rounded cursor-pointer flex justify-between items-center text-xs ${
                        filters.duties.includes(duty) ? 'bg-indigo-50 text-indigo-600 font-medium' : 'hover:bg-slate-50 text-slate-600'
                      }`}
                    >
                      {duty} {filters.duties.includes(duty) && <Icon name="Check" className="w-3 h-3 text-indigo-600 inline-block" />}
                    </div>
                  ))}
                </div>
              </FilterButton>
            </>
          )}

          {/* Active filter pills */}
          {filterStatus !== 'ALL' && (
            <span
              onClick={() => setFilterStatus('ALL')}
              className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full cursor-pointer hover:bg-blue-200 flex items-center text-xs whitespace-nowrap"
            >
              {filterStatus.replace('_', ' ')} <span className="ml-1">x</span>
            </span>
          )}
          {filterPhase !== null && (
            <span
              onClick={() => setFilterPhase(null)}
              className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full cursor-pointer hover:bg-blue-200 flex items-center text-xs whitespace-nowrap"
            >
              Phase {filterPhase} <span className="ml-1">x</span>
            </span>
          )}
          {filter90Days && (
            <span
              onClick={() => setFilter90Days(false)}
              className="px-2 py-1 bg-orange-100 text-orange-700 rounded-full cursor-pointer hover:bg-orange-200 flex items-center text-xs whitespace-nowrap"
            >
              90+ Days <span className="ml-1">x</span>
            </span>
          )}
          {filters.ranks.map(r => (
            <span
              key={r}
              onClick={() => toggleFilter('ranks', r)}
              className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full cursor-pointer hover:bg-blue-200 flex items-center text-xs whitespace-nowrap"
            >
              {r} <span className="ml-1">x</span>
            </span>
          ))}
          {filters.duties.map(d => (
            <span
              key={d}
              onClick={() => toggleFilter('duties', d)}
              className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full cursor-pointer hover:bg-indigo-200 flex items-center text-xs whitespace-nowrap"
            >
              {d.length > 20 ? d.substring(0, 20) + '...' : d} <span className="ml-1">x</span>
            </span>
          ))}
        </div>

        {/* Statistics Row */}
        <div className="flex flex-wrap justify-center gap-4 text-sm flex-1">
          <div className="flex flex-col items-center leading-tight">
            <span className="font-bold text-xl text-slate-800">{filteredStats.total}</span>
            <span className="text-[10px] uppercase font-bold text-slate-400">Total</span>
          </div>
          <div className="h-8 w-px bg-slate-100"></div>
          <div
            onClick={() => setFilterStatus(filterStatus === 'READY' ? 'ALL' : 'READY')}
            className={`flex flex-col items-center cursor-pointer transition-colors leading-tight px-2 rounded ${filterStatus === 'READY' ? 'bg-green-50' : 'hover:bg-slate-50'}`}
          >
            <span className="font-bold text-xl text-green-600 flex items-center">
              {filteredStats.ready} {filterStatus === 'READY' && <Icon name="Check" className="w-3 h-3 ml-1" />}
            </span>
            <span className="text-[10px] uppercase font-bold text-slate-400">Ready</span>
          </div>
          <div
            onClick={() => setFilterStatus(filterStatus === 'NEARLY_READY' ? 'ALL' : 'NEARLY_READY')}
            className={`flex flex-col items-center cursor-pointer transition-colors leading-tight px-2 rounded ${filterStatus === 'NEARLY_READY' ? 'bg-amber-50' : 'hover:bg-slate-50'}`}
          >
            <span className="font-bold text-xl text-amber-600 flex items-center">
              {filteredStats.nearlyReady} {filterStatus === 'NEARLY_READY' && <Icon name="Check" className="w-3 h-3 ml-1" />}
            </span>
            <span className="text-[10px] uppercase font-bold text-slate-400">Close</span>
          </div>
          <div
            onClick={() => setFilter90Days(!filter90Days)}
            className={`flex flex-col items-center cursor-pointer transition-colors leading-tight px-2 rounded ${filter90Days ? 'bg-orange-50' : 'hover:bg-slate-50'}`}
          >
            <span className="font-bold text-xl text-orange-600 flex items-center">
              {filteredStats.days90Plus} {filter90Days && <Icon name="Check" className="w-3 h-3 ml-1" />}
            </span>
            <span className="text-[10px] uppercase font-bold text-slate-400">90+ Days</span>
          </div>
          <div className="flex flex-col items-center leading-tight cursor-help group relative">
            <span className="font-bold text-xl text-purple-600">{filteredStats.honorCredits}</span>
            <span className="text-[10px] uppercase font-bold text-slate-400">Honor â­</span>
            <div className="absolute bottom-full mb-2 hidden group-hover:block z-50 max-w-xs bg-slate-800 text-white text-xs rounded py-2 px-3 shadow-lg">
              <div className="font-bold mb-1">Total Honor Credits Earned</div>
              <div className="text-[10px] opacity-90">Honor credit earned when PL_MemberPathCredit shows ExtraCreditEarned.CreditEarned = true for the achievement</div>
            </div>
          </div>
          {cadetProtectionStats && (
            <div className="flex flex-col items-center leading-tight cursor-help group relative" title="Cadet Protection Compliance">
              <span className={`font-bold text-xl ${
                cadetProtectionStats.nonCompliant > 0 ? 'text-rose-600' :
                cadetProtectionStats.dueSoon > 0 ? 'text-amber-600' :
                'text-emerald-600'
              }`}>
                {cadetProtectionStats.percent}%
              </span>
              <span className="text-[10px] uppercase font-bold text-slate-400">CP Compliant</span>
              <div className="absolute bottom-full mb-2 hidden group-hover:block z-50 w-max bg-slate-800 text-white text-xs rounded py-1 px-2 shadow-lg">
                Compliant: {cadetProtectionStats.compliant} / {cadetProtectionStats.requiredMembers}
                <div className="text-[10px] text-slate-300 mt-1 pt-1 border-t border-slate-600">
                  Due Soon: {cadetProtectionStats.dueSoon} | Overdue: {cadetProtectionStats.overdue} | Missing: {cadetProtectionStats.missing}
                </div>
              </div>
            </div>
          )}
          <div className="h-8 w-px bg-slate-100"></div>
          {/* Phase Distribution */}
          <div className="flex gap-2 items-center">
            <span className="text-[9px] uppercase font-bold text-slate-400">Phases:</span>
            <div className="flex gap-1.5 items-center">
              {[1, 2, 3, 4, 5].map(phase => (
                <div
                  key={phase}
                  onClick={() => setFilterPhase(filterPhase === phase ? null : phase)}
                  className={`flex flex-col items-center cursor-pointer group transition-all ${filterPhase === phase ? 'scale-110' : ''}`}
                >
                  <div className={`w-6 h-6 rounded-full flex items-center justify-center text-[11px] font-bold text-white shadow-sm ${
                    filterPhase === phase ? 'bg-blue-700 ring-2 ring-blue-300' : 'bg-blue-500 group-hover:bg-blue-600'
                  }`}>
                    {filteredStats.phases[phase] || 0}
                  </div>
                  <span className={`text-[9px] font-bold mt-0.5 ${
                    filterPhase === phase ? 'text-blue-700' : 'text-slate-300 group-hover:text-slate-500'
                  }`}>{['I', 'II', 'III', 'IV', 'V'][phase - 1]}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* Cadets Grid */}
      {filteredCadets.length === 0 ? (
        <div className="bg-white border border-slate-200 rounded-lg p-12 text-center">
          <p className="text-slate-400 italic">No cadets found with selected filters.</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
          {filteredCadets.map((cadet) => {
            // Sort and limit duty positions
            const sortedDuties = [...(cadet.cadetDuties || [])].sort((a, b) => {
              const rankA = getDutyRank(a.name);
              const rankB = getDutyRank(b.name);
              return rankA - rankB;
            });
            const displayDuties = sortedDuties.slice(0, 3);
            const hiddenDutiesCount = Math.max(0, sortedDuties.length - 3);
            const cadetProtection = getCadetProtectionStatus ? getCadetProtectionStatus(cadet) : null;
            const trainingIndicator = getTrainingIndicatorSummary(cadetProtection);
            const trainingIndicatorClass = TRAINING_INDICATOR_STYLES[trainingIndicator.tone] || TRAINING_INDICATOR_STYLES.none;
            const showCadetProtectionAlert = cadetProtection && cadetProtection.requiredCourses.length > 0 && !cadetProtection.isCompliant;
            const cpStatus = showCadetProtectionAlert ? (cadetProtection.indicator?.status || 'missing') : null;
            const cpTone = showCadetProtectionAlert ? (cadetProtection.indicator?.tone || 'bad') : null;
            const cpBadgeClass = cpTone === 'warn'
              ? 'bg-amber-100 text-amber-700 border-amber-200'
              : 'bg-rose-100 text-rose-700 border-rose-200';
            const cpStatusLabelMap = { overdue: 'Overdue', missing: 'Missing', 'due-soon': 'Due Soon' };
            const cpBadgeText = cpStatusLabelMap[cpStatus] ? `CP: ${cpStatusLabelMap[cpStatus]}` : 'CP: Needs Attention';

            return (
              <div key={cadet.CAPID} className="cursor-pointer" onClick={() => setSelectedCadet(cadet)}>
                {/* Redesigned Cadet Card */}
                <div className={`border rounded-lg p-4 bg-white hover:shadow-md transition-shadow ${
                  cadet.promotionStatus?.status === 'READY' ? 'border-green-200 bg-green-50' : 'border-slate-200'
                } ${trainingIndicatorClass}`} title={trainingIndicator.title}>
                  <div className="flex items-center gap-3 mb-3">
                    {/* Left: Rank Image and Rank */}
                    <div className="flex flex-col items-center shrink-0">
                      {getRankInsigniaUrl(cadet.currentAchievement) && (
                        <img
                          src={getRankInsigniaUrl(cadet.currentAchievement)}
                          alt={cadet.currentRank}
                          className="h-12 w-auto object-contain"
                        />
                      )}
                      <span className="text-[10px] font-bold text-slate-600 mt-1 text-center">{cadet.currentRank}</span>
                    </div>

                    {/* Left-Center: Name and Basic Info */}
                    <div className="flex flex-col min-w-0 shrink-0">
                      <h3 className="font-bold text-slate-900 truncate">{cadet.NameLast}, {cadet.NameFirst}</h3>
                      <p className="text-xs text-slate-500 font-mono">CAPID: {cadet.CAPID}</p>
                      {cadet.timeInGrade && (
                        <p className={`text-xs font-semibold ${cadet.timeInGrade.isEligible ? 'text-green-600' : 'text-slate-600'}`}>
                          Eligible: {cadet.timeInGrade.eligibleDate || 'N/A'}
                          {cadet.timeInGrade.isEligible && ' âœ“'}
                          {cadet.timeInGrade.days >= 90 && (
                            <span className="ml-1 inline-flex items-center" title="90+ days since last promotion">
                              <span className="w-1.5 h-1.5 rounded-full bg-amber-400"></span>
                            </span>
                          )}
                        </p>
                      )}
                    </div>

                    {/* Center-Right: Duty Positions */}
                    {!isMobile && displayDuties.length > 0 && (
                      <div className="flex flex-wrap gap-1.5 flex-1 min-w-0 items-center">
                        {displayDuties.map((duty, idx) => (
                          <Badge
                            key={idx}
                            color="gray"
                            title={`${duty.orgString || 'Unknown'} - Assigned: ${duty.date || 'Unknown'}`}
                          >
                            {duty.name}
                          </Badge>
                        ))}
                        {hiddenDutiesCount > 0 && (
                          <span className="text-xs text-blue-600 font-semibold px-2 py-1 bg-blue-50 rounded border border-blue-200">
                            +{hiddenDutiesCount} more
                          </span>
                        )}
                      </div>
                    )}
                    {isMobile && displayDuties.length > 0 && (
                      <div className="text-[11px] text-slate-600 font-medium ml-auto">
                        Duties: {displayDuties.map(d => d.name).join(', ')}
                        {hiddenDutiesCount > 0 && ` +${hiddenDutiesCount} more`}
                      </div>
                    )}

                    {/* Right: Status Badge */}
                    <div className="shrink-0 ml-auto flex flex-col items-end gap-1">
                      {showCadetProtectionAlert && (
                        <span className={`text-[10px] font-bold px-2 py-1 rounded-full border ${cpBadgeClass}`}>
                          {cpBadgeText}
                        </span>
                      )}
                      <span className={`text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap ${
                        cadet.promotionStatus?.status === 'READY' ? 'bg-green-100 text-green-700' :
                        cadet.promotionStatus?.status === 'TIME_PENDING' ? 'bg-amber-100 text-amber-700' :
                        cadet.promotionStatus?.status === 'NEARLY_READY' ? 'bg-blue-100 text-blue-700' :
                        'bg-slate-100 text-slate-600'
                      }`}>
                        {cadet.promotionStatus?.message || 'N/A'}
                      </span>
                    </div>
                  </div>

                  {/* Next Achievement Progress */}
                  {cadet.nextRequirements && (
                    <div className="border-t border-slate-100 pt-3 mt-3">
                      <div className="text-xs font-medium text-slate-700 mb-2">
                        Next: {getAchievementDisplayName(cadet.nextAchievement)}
                      </div>
                      <ComponentProgressBar requirements={cadet.nextRequirements} />
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* All modals are now rendered at app level in Index.html */}
    </div>
  );
}
</script>

<script type="text/babel">
/**
 * UnitOverviewSection - Redesigned Unit Overview Dashboard
 *
 * Features:
 * - Accordion-style expandable sections
 * - Key data visible in collapsed state
 * - Deep dive modals for detailed insights
 * - Modular architecture for future sections
 */
const { useRef: useRefLocal } = React;

/**
 * HelpTooltip - Shows help information on hover
 * Used to explain metrics and provide actionable advice
 */
const HelpTooltip = ({ title, children, position = 'top' }) => {
  const [isVisible, setIsVisible] = useState(false);

  const positionClasses = {
    top: 'bottom-full left-1/2 -translate-x-1/2 mb-2',
    bottom: 'top-full left-1/2 -translate-x-1/2 mt-2',
    left: 'right-full top-1/2 -translate-y-1/2 mr-2',
    right: 'left-full top-1/2 -translate-y-1/2 ml-2'
  };

  return (
    <span
      className="relative inline-flex items-center cursor-help"
      onMouseEnter={() => setIsVisible(true)}
      onMouseLeave={() => setIsVisible(false)}
    >
      <Icon name="HelpCircle" className="w-4 h-4 text-slate-400 hover:text-slate-600" />
      {isVisible && (
        <div className={`absolute z-50 ${positionClasses[position]} w-64 p-3 bg-slate-800 text-white text-xs rounded-lg shadow-lg`}>
          {title && <div className="font-bold mb-1">{title}</div>}
          <div>{children}</div>
        </div>
      )}
    </span>
  );
};

/**
 * MetricWithHelp - Displays a metric value with hover help text
 */
const MetricWithHelp = ({ label, value, subValue, explanation, color = 'blue', trend, trendDirection }) => {
  const colorStyles = {
    blue: 'bg-blue-50 border-blue-100',
    green: 'bg-emerald-50 border-emerald-100',
    amber: 'bg-amber-50 border-amber-100',
    red: 'bg-rose-50 border-rose-100',
    slate: 'bg-slate-50 border-slate-100'
  };

  const trendColors = {
    up: 'text-emerald-600',
    down: 'text-rose-600',
    stable: 'text-slate-500'
  };

  return (
    <div className={`px-3 py-2.5 rounded-lg border ${colorStyles[color] || colorStyles.blue} relative group`}>
      <div className="flex items-center justify-between gap-1">
        <div className="text-[10px] uppercase font-bold text-slate-500 tracking-wide">{label}</div>
        {explanation && (
          <HelpTooltip title={explanation.label} position="top">
            <p className="mb-1">{explanation.shortDesc}</p>
            <p className="text-slate-300">{explanation.howToImprove}</p>
            {explanation.goodValue && (
              <p className="mt-1 text-emerald-300">Target: {explanation.goodValue}</p>
            )}
          </HelpTooltip>
        )}
      </div>
      <div className="flex items-baseline gap-2">
        <span className="text-xl font-bold text-slate-800">{value}</span>
        {trend && (
          <span className={`text-xs font-medium ${trendColors[trendDirection] || trendColors.stable}`}>
            {trendDirection === 'up' && '+'}
            {trend}
          </span>
        )}
      </div>
      {subValue && <div className="text-xs text-slate-500">{subValue}</div>}
    </div>
  );
};

/**
 * UnitComparisonTable - Shows recruiting/retention metrics for all subordinate units
 * Used in Mode C (Command + Sub-Units view)
 */
const UnitComparisonTable = ({ unitMetrics, getUnitName, onUnitClick, sortConfig, onSort }) => {
  const getSustainabilityColor = (rating) => {
    switch (rating) {
      case 'excellent': return 'text-emerald-700 bg-emerald-100';
      case 'good': return 'text-blue-700 bg-blue-100';
      case 'fair': return 'text-amber-700 bg-amber-100';
      case 'needs-attention': return 'text-rose-700 bg-rose-100';
      default: return 'text-slate-500 bg-slate-100';
    }
  };

  const getGrowthIcon = (status) => {
    switch (status) {
      case 'growing': return { icon: 'TrendingUp', color: 'text-emerald-600' };
      case 'declining': return { icon: 'TrendingDown', color: 'text-rose-600' };
      default: return { icon: 'Minus', color: 'text-slate-400' };
    }
  };

  // Sortable column header
  const SortableHeader = ({ field, label, className = '' }) => (
    <th
      className={`px-3 py-2 text-left text-xs font-bold text-slate-600 uppercase tracking-wide cursor-pointer hover:bg-slate-100 transition-colors ${className}`}
      onClick={() => onSort(field)}
    >
      <div className="flex items-center gap-1">
        {label}
        {sortConfig.field === field && (
          <Icon
            name={sortConfig.direction === 'asc' ? 'ChevronUp' : 'ChevronDown'}
            className="w-3 h-3"
          />
        )}
      </div>
    </th>
  );

  return (
    <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
      <div className="overflow-x-auto">
        <table className="w-full">
          <thead className="bg-slate-50 border-b border-slate-200">
            <tr>
              <SortableHeader field="name" label="Unit" className="min-w-[180px]" />
              <SortableHeader field="currentTotal" label="Members" />
              <SortableHeader field="sustainabilityScore" label="Score" />
              <SortableHeader field="retentionRate" label="Retention" />
              <SortableHeader field="recruitingRate" label="Recruiting" />
              <SortableHeader field="netChange" label="Growth" />
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {unitMetrics.map((unit, idx) => {
              const growth = getGrowthIcon(unit.growthStatus);
              const unitName = getUnitName(unit.orgId);
              return (
                <tr
                  key={unit.orgId}
                  className={`hover:bg-slate-50 cursor-pointer transition-colors ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-25'}`}
                  onClick={() => onUnitClick(unit.orgId)}
                >
                  <td className="px-3 py-2.5">
                    <div className="font-medium text-slate-800 text-sm">{unitName}</div>
                    <div className="text-xs text-slate-500">
                      {unit.memberBreakdown && `${unit.memberBreakdown.senior} Sr / ${unit.memberBreakdown.cadet} Cdt`}
                    </div>
                  </td>
                  <td className="px-3 py-2.5 text-sm font-semibold text-slate-800">
                    {unit.currentTotal}
                  </td>
                  <td className="px-3 py-2.5">
                    <span className={`inline-flex px-2 py-0.5 rounded-full text-xs font-bold ${getSustainabilityColor(unit.sustainabilityRating)}`}>
                      {unit.sustainabilityScore ?? '--'}
                    </span>
                  </td>
                  <td className="px-3 py-2.5 text-sm">
                    {unit.retentionRate !== null ? (
                      <span className={unit.retentionRate >= 80 ? 'text-emerald-600' : unit.retentionRate >= 60 ? 'text-amber-600' : 'text-rose-600'}>
                        {unit.retentionRate}%
                      </span>
                    ) : (
                      <span className="text-slate-400">--</span>
                    )}
                  </td>
                  <td className="px-3 py-2.5 text-sm text-slate-700">
                    {unit.recruitingRate !== null ? `${unit.recruitingRate}/mo` : '--'}
                  </td>
                  <td className="px-3 py-2.5">
                    <div className="flex items-center gap-1">
                      <Icon name={growth.icon} className={`w-4 h-4 ${growth.color}`} />
                      <span className={`text-sm font-medium ${growth.color}`}>
                        {unit.netChange !== null ? (unit.netChange > 0 ? '+' : '') + unit.netChange : '--'}
                      </span>
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  );
};

/**
 * HQStaffInsights - Recruiting & Retention section for command HQ units
 * Shows staff-focused metrics: tenure, experience, turnover, upcoming expirations
 */
const HQStaffInsights = ({
  unitType,
  staffMembers,
  isExpanded,
  onToggle,
  onDeepDive,
  getHQLabel
}) => {
  const [timeRange, setTimeRange] = useState(12);

  // Calculate staff metrics
  const staffMetrics = useMemo(() => {
    if (!staffMembers || staffMembers.length === 0) {
      return null;
    }

    const today = new Date();
    const parseDateSafe = (dateStr) => {
      if (!dateStr) return null;
      const d = new Date(dateStr);
      return isNaN(d.getTime()) ? null : d;
    };

    // Calculate tenure (time at CAP) for each staff member
    const staffWithTenure = staffMembers.map(m => {
      const joinDate = parseDateSafe(m.Joined);
      let tenureYears = null;
      if (joinDate && joinDate < today) {
        tenureYears = Math.round((today - joinDate) / (1000 * 60 * 60 * 24 * 365.25) * 10) / 10;
      }
      return { ...m, tenureYears, joinDate };
    }).filter(m => m.tenureYears !== null);

    // Average tenure
    const avgTenure = staffWithTenure.length > 0
      ? Math.round(staffWithTenure.reduce((sum, m) => sum + m.tenureYears, 0) / staffWithTenure.length * 10) / 10
      : null;

    // Tenure distribution
    const tenureDistribution = {
      under2: staffWithTenure.filter(m => m.tenureYears < 2).length,
      twoToFive: staffWithTenure.filter(m => m.tenureYears >= 2 && m.tenureYears < 5).length,
      fiveToTen: staffWithTenure.filter(m => m.tenureYears >= 5 && m.tenureYears < 10).length,
      tenPlus: staffWithTenure.filter(m => m.tenureYears >= 10).length
    };

    // Experience level (based on tenure)
    const experienceScore = avgTenure !== null
      ? (avgTenure >= 10 ? 100 : avgTenure >= 5 ? 80 : avgTenure >= 3 ? 60 : avgTenure >= 1 ? 40 : 20)
      : null;

    const experienceRating = experienceScore >= 80 ? 'excellent' :
                             experienceScore >= 60 ? 'good' :
                             experienceScore >= 40 ? 'fair' : 'developing';

    // Members expiring soon (within 90 days)
    const membersExpiringSoon = staffMembers.filter(m => {
      if (!m.Expiration || m.Expiration === '12/31/9998' || m.Expiration === '12/31/9999') return false;
      const expDate = parseDateSafe(m.Expiration);
      if (!expDate) return false;
      const daysUntil = Math.floor((expDate - today) / (1000 * 60 * 60 * 24));
      return daysUntil >= 0 && daysUntil <= 90;
    }).map(m => {
      const expDate = parseDateSafe(m.Expiration);
      const daysUntil = Math.floor((expDate - today) / (1000 * 60 * 60 * 24));
      return {
        ...m,
        daysUntil,
        urgency: daysUntil <= 30 ? 'critical' : daysUntil <= 60 ? 'warning' : 'notice'
      };
    }).sort((a, b) => a.daysUntil - b.daysUntil);

    // New staff (joined within selected time range)
    const timeRangeDate = new Date();
    timeRangeDate.setMonth(timeRangeDate.getMonth() - timeRange);
    const newStaff = staffWithTenure.filter(m => m.joinDate && m.joinDate >= timeRangeDate);

    // Rank distribution for experience indicator
    const rankDistribution = {};
    staffMembers.forEach(m => {
      const rank = m.Rank || 'Unknown';
      rankDistribution[rank] = (rankDistribution[rank] || 0) + 1;
    });

    // Count field-grade officers (Lt Col+) and senior NCOs (CMSgt, SMSgt)
    const fieldGradeCount = staffMembers.filter(m => {
      const rank = (m.Rank || '').toUpperCase();
      return rank.includes('COL') || rank.includes('GEN') || rank.includes('BRIG');
    }).length;

    const seniorNCOCount = staffMembers.filter(m => {
      const rank = (m.Rank || '').toUpperCase();
      return rank.includes('CMSGT') || rank.includes('SMSGT') || rank.includes('CHIEF');
    }).length;

    // Staff stability score (composite)
    const stabilityComponents = {
      tenure: experienceScore || 50,
      retention: membersExpiringSoon.length === 0 ? 100 :
                 membersExpiringSoon.length <= 2 ? 80 :
                 membersExpiringSoon.length <= 4 ? 60 : 40,
      depth: staffMembers.length >= 10 ? 100 :
             staffMembers.length >= 5 ? 80 :
             staffMembers.length >= 3 ? 60 : 40
    };

    const stabilityScore = Math.round(
      stabilityComponents.tenure * 0.4 +
      stabilityComponents.retention * 0.35 +
      stabilityComponents.depth * 0.25
    );

    const stabilityRating = stabilityScore >= 80 ? 'excellent' :
                            stabilityScore >= 65 ? 'good' :
                            stabilityScore >= 50 ? 'fair' : 'needs-attention';

    return {
      totalStaff: staffMembers.length,
      avgTenure,
      tenureDistribution,
      experienceScore,
      experienceRating,
      membersExpiringSoon,
      newStaff,
      fieldGradeCount,
      seniorNCOCount,
      stabilityScore,
      stabilityRating,
      stabilityComponents
    };
  }, [staffMembers, timeRange]);

  // Time range options
  const timeRangeOptions = [
    { value: 6, label: '6 mo' },
    { value: 12, label: '12 mo' },
    { value: 24, label: '2 yr' }
  ];

  if (!staffMetrics) {
    return (
      <div className="bg-slate-50 rounded-xl border border-slate-200 p-6 text-center">
        <Icon name="Users" className="w-8 h-8 mx-auto mb-2 text-slate-400" />
        <p className="text-sm text-slate-500">No staff data available for analysis.</p>
      </div>
    );
  }

  const keyData = (
    <div className="flex items-center gap-4 flex-wrap">
      <span className="font-semibold">{staffMetrics.totalStaff} staff assigned</span>
      {staffMetrics.avgTenure !== null && (
        <>
          <span className="text-slate-400">|</span>
          <span>{staffMetrics.avgTenure} yr avg tenure</span>
        </>
      )}
      {staffMetrics.membersExpiringSoon.length > 0 && (
        <>
          <span className="text-slate-400">|</span>
          <span className="text-amber-600">{staffMetrics.membersExpiringSoon.length} expiring soon</span>
        </>
      )}
    </div>
  );

  return (
    <DashboardSection
      id="hq-staff"
      title={`${getHQLabel()} Staff Insights`}
      icon="Building2"
      isExpanded={isExpanded}
      onToggle={() => onToggle('hq-staff')}
      onDeepDive={onDeepDive}
      accentColor={staffMetrics.stabilityRating === 'excellent' ? 'green' :
                   staffMetrics.stabilityRating === 'good' ? 'blue' :
                   staffMetrics.stabilityRating === 'fair' ? 'amber' : 'rose'}
      keyData={keyData}
    >
      <div className="space-y-4 pt-4">
        {/* Time Range Selector */}
        <div className="flex items-center justify-between bg-slate-50 rounded-lg p-3">
          <div className="flex items-center gap-2">
            <span className="text-sm font-medium text-slate-600">Analysis Period:</span>
            <HelpTooltip position="bottom">
              <p>Select time period to analyze staff changes and new assignments.</p>
            </HelpTooltip>
          </div>
          <div className="flex gap-1">
            {timeRangeOptions.map(opt => (
              <button
                key={opt.value}
                onClick={() => setTimeRange(opt.value)}
                className={`px-3 py-1.5 text-sm font-medium rounded-lg transition-colors ${
                  timeRange === opt.value
                    ? 'bg-slate-800 text-white'
                    : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200'
                }`}
              >
                {opt.label}
              </button>
            ))}
          </div>
        </div>

        {/* Staff Stability Score */}
        <div className="bg-slate-50 rounded-lg p-4">
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-2">
              <h4 className="font-semibold text-slate-800">Staff Stability Score</h4>
              <HelpTooltip title="What is this?" position="right">
                <p className="mb-2">A composite score (0-100) measuring your HQ's staff continuity and experience.</p>
                <p className="text-slate-300 mb-1">Components:</p>
                <ul className="text-slate-300 text-[10px] space-y-0.5">
                  <li>â€¢ 40% Staff Experience (tenure)</li>
                  <li>â€¢ 35% Retention Risk (expirations)</li>
                  <li>â€¢ 25% Staff Depth (headcount)</li>
                </ul>
                <p className="mt-2 text-emerald-300">80+ Excellent | 65+ Good | 50+ Fair</p>
              </HelpTooltip>
            </div>
            <span className="text-2xl font-bold text-slate-900">
              {staffMetrics.stabilityScore}
            </span>
          </div>
          <SustainabilityGauge
            score={staffMetrics.stabilityScore}
            rating={staffMetrics.stabilityRating}
          />
          <p className="text-sm text-slate-600 mt-2">
            {staffMetrics.stabilityRating === 'excellent' ? 'HQ staff is highly experienced and stable.' :
             staffMetrics.stabilityRating === 'good' ? 'HQ staff has solid experience with good continuity.' :
             staffMetrics.stabilityRating === 'fair' ? 'Consider focusing on staff retention and development.' :
             'HQ may benefit from additional experienced staff or improved retention.'}
          </p>
        </div>

        {/* Key Metrics Grid */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <MetricWithHelp
            label="Staff Assigned"
            value={staffMetrics.totalStaff}
            subValue="HQ personnel"
            color="blue"
            explanation={{
              label: 'HQ Staff Count',
              shortDesc: 'Total personnel assigned to headquarters',
              howToImprove: 'Request additional staff through proper channels as mission requirements grow.',
              goodValue: 'Varies by HQ level and mission'
            }}
          />
          <MetricWithHelp
            label="Avg Tenure"
            value={staffMetrics.avgTenure !== null ? `${staffMetrics.avgTenure} yr` : '--'}
            subValue={staffMetrics.experienceRating ? staffMetrics.experienceRating.charAt(0).toUpperCase() + staffMetrics.experienceRating.slice(1) : ''}
            color={staffMetrics.experienceRating === 'excellent' ? 'green' :
                   staffMetrics.experienceRating === 'good' ? 'blue' :
                   staffMetrics.experienceRating === 'fair' ? 'amber' : 'slate'}
            explanation={{
              label: 'Average Tenure',
              shortDesc: 'Mean years of CAP service across HQ staff',
              howToImprove: 'Balance recruiting new talent with retaining experienced members.',
              goodValue: '5+ years indicates deep institutional knowledge'
            }}
          />
          <MetricWithHelp
            label="New Staff"
            value={staffMetrics.newStaff.length}
            subValue={`joined in ${timeRange} mo`}
            color="indigo"
            explanation={{
              label: 'New Staff Members',
              shortDesc: `Staff who joined within the selected ${timeRange}-month period`,
              howToImprove: 'Ensure proper onboarding and mentorship for new HQ staff.',
              goodValue: 'Some turnover is healthy; too much can affect continuity'
            }}
          />
          <MetricWithHelp
            label="Expiring Soon"
            value={staffMetrics.membersExpiringSoon.length}
            subValue="within 90 days"
            color={staffMetrics.membersExpiringSoon.length === 0 ? 'green' :
                   staffMetrics.membersExpiringSoon.length <= 2 ? 'amber' : 'red'}
            explanation={{
              label: 'Memberships Expiring',
              shortDesc: 'Staff with memberships expiring within 90 days',
              howToImprove: 'Proactively reach out to staff approaching expiration to encourage renewal.',
              goodValue: '0 - all staff actively renewed'
            }}
          />
        </div>

        {/* Tenure Distribution */}
        <div className="bg-white rounded-lg border border-slate-200 p-4">
          <div className="flex items-center gap-2 mb-3">
            <h4 className="text-sm font-semibold text-slate-700">Staff Experience Distribution</h4>
            <HelpTooltip position="right">
              <p>Shows how staff tenure is distributed across experience levels.</p>
              <p className="mt-1 text-slate-300">A healthy mix includes both experienced mentors and developing leaders.</p>
            </HelpTooltip>
          </div>
          <div className="grid grid-cols-4 gap-2">
            <div className="text-center p-2 bg-rose-50 rounded-lg">
              <div className="text-lg font-bold text-rose-700">{staffMetrics.tenureDistribution.under2}</div>
              <div className="text-xs text-slate-600">&lt; 2 years</div>
              <div className="text-[10px] text-slate-400">Developing</div>
            </div>
            <div className="text-center p-2 bg-amber-50 rounded-lg">
              <div className="text-lg font-bold text-amber-700">{staffMetrics.tenureDistribution.twoToFive}</div>
              <div className="text-xs text-slate-600">2-5 years</div>
              <div className="text-[10px] text-slate-400">Established</div>
            </div>
            <div className="text-center p-2 bg-blue-50 rounded-lg">
              <div className="text-lg font-bold text-blue-700">{staffMetrics.tenureDistribution.fiveToTen}</div>
              <div className="text-xs text-slate-600">5-10 years</div>
              <div className="text-[10px] text-slate-400">Experienced</div>
            </div>
            <div className="text-center p-2 bg-emerald-50 rounded-lg">
              <div className="text-lg font-bold text-emerald-700">{staffMetrics.tenureDistribution.tenPlus}</div>
              <div className="text-xs text-slate-600">10+ years</div>
              <div className="text-[10px] text-slate-400">Veteran</div>
            </div>
          </div>
        </div>

        {/* Leadership Depth */}
        {(staffMetrics.fieldGradeCount > 0 || staffMetrics.seniorNCOCount > 0) && (
          <div className="bg-white rounded-lg border border-slate-200 p-4">
            <div className="flex items-center gap-2 mb-3">
              <h4 className="text-sm font-semibold text-slate-700">Leadership Depth</h4>
              <HelpTooltip position="right">
                <p>Senior leaders (field-grade officers and senior NCOs) provide mentorship and strategic guidance.</p>
              </HelpTooltip>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div className="flex items-center justify-between px-3 py-2 bg-indigo-50 rounded-lg">
                <span className="text-sm text-slate-600">Field Grade Officers</span>
                <span className="font-bold text-indigo-700">{staffMetrics.fieldGradeCount}</span>
              </div>
              <div className="flex items-center justify-between px-3 py-2 bg-slate-100 rounded-lg">
                <span className="text-sm text-slate-600">Senior NCOs</span>
                <span className="font-bold text-slate-700">{staffMetrics.seniorNCOCount}</span>
              </div>
            </div>
          </div>
        )}

        {/* Expiring Memberships Alert */}
        {staffMetrics.membersExpiringSoon.length > 0 && (
          <div className="bg-amber-50 rounded-lg border border-amber-200 p-4">
            <div className="flex items-center gap-2 mb-3">
              <Icon name="AlertTriangle" className="w-5 h-5 text-amber-600" />
              <h4 className="text-sm font-semibold text-amber-800">Staff Memberships Expiring Soon</h4>
            </div>
            <div className="space-y-2">
              {staffMetrics.membersExpiringSoon.slice(0, 5).map((m, idx) => (
                <div
                  key={m.CAPID || idx}
                  className={`flex items-center justify-between px-3 py-2 rounded-lg ${
                    m.urgency === 'critical' ? 'bg-rose-100 border border-rose-200' :
                    m.urgency === 'warning' ? 'bg-amber-100 border border-amber-200' :
                    'bg-yellow-50 border border-yellow-200'
                  }`}
                >
                  <div>
                    <span className="font-medium text-slate-800">
                      {m.Rank} {m.NameFirst} {m.NameLast}
                    </span>
                    <span className="text-xs text-slate-500 ml-2">({m.CAPID})</span>
                  </div>
                  <div className={`text-sm font-semibold ${
                    m.urgency === 'critical' ? 'text-rose-700' :
                    m.urgency === 'warning' ? 'text-amber-700' : 'text-yellow-700'
                  }`}>
                    {m.daysUntil} days
                  </div>
                </div>
              ))}
              {staffMetrics.membersExpiringSoon.length > 5 && (
                <p className="text-xs text-amber-600 mt-2">
                  + {staffMetrics.membersExpiringSoon.length - 5} more expiring within 90 days
                </p>
              )}
            </div>
          </div>
        )}
      </div>
    </DashboardSection>
  );
};

/**
 * ESTeamStatusIcon - Mini status icon for a team type
 */
const ESTeamStatusIcon = ({ shortName, color, tooltip }) => {
  const colorStyles = {
    green: 'bg-emerald-500',
    blue: 'bg-blue-500',
    amber: 'bg-amber-500',
    red: 'bg-rose-400'
  };

  return (
    <div className="flex items-center gap-1 group relative">
      <span className="text-xs font-medium text-slate-600">{shortName}</span>
      <span className={`w-2.5 h-2.5 rounded-full ${colorStyles[color] || 'bg-slate-300'}`} />
      {tooltip && (
        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover:block z-50">
          <div className="bg-slate-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap">
            {tooltip}
          </div>
        </div>
      )}
    </div>
  );
};

/**
 * ESTeamCapabilityCard - Card showing capability for a specific team type
 * Handles both team-based (fieldOps, aircrew, suas) and staffing-based (missionBase, command)
 */
const ESTeamCapabilityCard = ({ team }) => {
  const colorStyles = {
    green: { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-700', icon: 'text-emerald-600' },
    blue: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', icon: 'text-blue-600' },
    amber: { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700', icon: 'text-amber-600' },
    red: { bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-700', icon: 'text-rose-600' }
  };

  const style = colorStyles[team.color] || colorStyles.red;

  // Staffing-based display (Mission Base, Command)
  if (team.isStaffing) {
    return (
      <div className={`${style.bg} ${style.border} border rounded-lg p-3 transition-all hover:shadow-md`}>
        <div className="flex items-center justify-between mb-2">
          <div className="flex items-center gap-2">
            <Icon name={team.icon || 'Users'} className={`w-4 h-4 ${style.icon}`} />
            <h5 className={`font-semibold text-sm ${style.text}`}>{team.name}</h5>
          </div>
          {team.hasIC || team.positionsCovered >= 4 ? (
            <Icon name="CheckCircle" className={`w-5 h-5 ${style.icon}`} />
          ) : (
            <Icon name="AlertCircle" className="w-5 h-5 text-slate-400" />
          )}
        </div>
        <div className="flex items-baseline gap-1">
          <span className="text-2xl font-bold text-slate-800">{team.qualifiedCount || 0}</span>
          <span className="text-xs text-slate-500">qualified</span>
        </div>
        <div className="text-xs text-slate-500 mt-1">
          {team.positionsCovered}/{team.totalPositionTypes} position types
        </div>
        {team.gaps && team.gaps.length > 0 && (
          <div className="mt-2 text-xs text-slate-600">
            {team.gaps.slice(0, 2).map((gap, i) => (
              <div key={i} className="flex items-center gap-1">
                <Icon name="AlertTriangle" className="w-3 h-3 text-amber-500" />
                <span>{gap}</span>
              </div>
            ))}
          </div>
        )}
      </div>
    );
  }

  // Team-based display (standard)
  return (
    <div className={`${style.bg} ${style.border} border rounded-lg p-3 transition-all hover:shadow-md`}>
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <Icon name={team.icon || 'Users'} className={`w-4 h-4 ${style.icon}`} />
          <h5 className={`font-semibold text-sm ${style.text}`}>{team.name}</h5>
        </div>
        {team.canField ? (
          <Icon name="CheckCircle" className={`w-5 h-5 ${style.icon}`} />
        ) : (
          <Icon name="AlertCircle" className="w-5 h-5 text-slate-400" />
        )}
      </div>
      <div className="flex items-baseline gap-1">
        <span className="text-2xl font-bold text-slate-800">
          {team.teamsFieldable !== undefined ? team.teamsFieldable : 0}
        </span>
        <span className="text-xs text-slate-500">
          {team.canField ? 'teams' : 'available'}
        </span>
      </div>
      {team.gaps && team.gaps.length > 0 && (
        <div className="mt-2 text-xs text-slate-600">
          {team.gaps.slice(0, 2).map((gap, i) => (
            <div key={i} className="flex items-center gap-1">
              <Icon name="AlertTriangle" className="w-3 h-3 text-amber-500" />
              <span>{gap}</span>
            </div>
          ))}
          {team.gaps.length > 2 && (
            <span className="text-slate-400">+{team.gaps.length - 2} more</span>
          )}
        </div>
      )}
    </div>
  );
};

/**
 * FieldOpsCapabilityCard - Special card for combined Field Operations (Ground + UDF)
 */
const FieldOpsCapabilityCard = ({ fieldOps }) => {
  const colorStyles = {
    green: { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-700', icon: 'text-emerald-600' },
    blue: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', icon: 'text-blue-600' },
    amber: { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700', icon: 'text-amber-600' },
    red: { bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-700', icon: 'text-rose-600' }
  };

  const style = colorStyles[fieldOps.color] || colorStyles.red;
  const totalTeams = (fieldOps.groundTeamsFieldable || 0) + (fieldOps.udfTeamsFieldable || 0);

  return (
    <div className={`${style.bg} ${style.border} border rounded-lg p-3 transition-all hover:shadow-md`}>
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <Icon name={fieldOps.icon || 'Users'} className={`w-4 h-4 ${style.icon}`} />
          <h5 className={`font-semibold text-sm ${style.text}`}>{fieldOps.name}</h5>
        </div>
        {fieldOps.canField ? (
          <Icon name="CheckCircle" className={`w-5 h-5 ${style.icon}`} />
        ) : (
          <Icon name="AlertCircle" className="w-5 h-5 text-slate-400" />
        )}
      </div>
      {/* Show breakdown of GT and UDF teams */}
      <div className="space-y-1">
        <div className="flex items-center justify-between">
          <span className="text-xs text-slate-600">Ground Teams:</span>
          <span className={`text-sm font-bold ${fieldOps.canFieldGround ? style.text : 'text-slate-400'}`}>
            {fieldOps.groundTeamsFieldable || 0}
          </span>
        </div>
        <div className="flex items-center justify-between">
          <span className="text-xs text-slate-600">UDF Teams:</span>
          <span className={`text-sm font-bold ${fieldOps.canFieldUDF ? style.text : 'text-slate-400'}`}>
            {fieldOps.udfTeamsFieldable || 0}
          </span>
        </div>
      </div>
      {/* Personnel breakdown */}
      <div className="mt-2 pt-2 border-t border-slate-200/50 text-xs text-slate-500">
        {fieldOps.positionCounts.GTL || 0} GTL â€¢ {fieldOps.positionCounts.GTM || 0} GTM â€¢ {fieldOps.positionCounts.UDF || 0} UDF
      </div>
      {fieldOps.gaps && fieldOps.gaps.length > 0 && (
        <div className="mt-2 text-xs text-slate-600">
          {fieldOps.gaps.slice(0, 2).map((gap, i) => (
            <div key={i} className="flex items-center gap-1">
              <Icon name="AlertTriangle" className="w-3 h-3 text-amber-500" />
              <span>{gap}</span>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

/**
 * ESReadinessScoreCard - Displays the overall ES readiness score with gauge
 */
const ESReadinessScoreCard = ({ score, rating, components }) => {
  const [showScoreDetails, setShowScoreDetails] = useState(false);

  return (
    <div className="bg-slate-50 rounded-lg p-4">
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <h4 className="font-semibold text-slate-800">ES Readiness Score</h4>
          <HelpTooltip title="What is this?" position="right">
            <p className="mb-2">A composite score (0-100) measuring your unit's Emergency Services readiness.</p>
            <p className="text-slate-300 mb-1">Click "How is this calculated?" below for details.</p>
            <p className="mt-2 text-emerald-300">80+ Excellent | 65+ Good | 50+ Fair</p>
          </HelpTooltip>
        </div>
        <span className="text-2xl font-bold text-slate-900">{score}</span>
      </div>
      <SustainabilityGauge score={score} rating={rating} />
      <p className="text-sm text-slate-600 mt-2">
        {rating === 'excellent' ? 'Unit is well-positioned for operational missions.' :
         rating === 'good' ? 'Unit has solid ES capability with room for growth.' :
         rating === 'fair' ? 'Unit can participate in missions but has capability gaps.' :
         'Unit needs focused training and qualification efforts.'}
      </p>
      {components && (
        <div className="mt-3 grid grid-cols-5 gap-1 text-xs">
          <div className="text-center">
            <div className="font-bold text-slate-700">{components.teamScore}</div>
            <div className="text-slate-400">Teams</div>
          </div>
          <div className="text-center">
            <div className="font-bold text-slate-700">{components.qualScore}</div>
            <div className="text-slate-400">Quals</div>
          </div>
          <div className="text-center">
            <div className="font-bold text-slate-700">{components.evaluatorScore}</div>
            <div className="text-slate-400">SET</div>
          </div>
          <div className="text-center">
            <div className="font-bold text-slate-700">{components.riskScore}</div>
            <div className="text-slate-400">Risk</div>
          </div>
          <div className="text-center">
            <div className="font-bold text-slate-700">{components.pipelineScore}</div>
            <div className="text-slate-400">Pipeline</div>
          </div>
        </div>
      )}

      {/* Expandable calculation details */}
      <button
        onClick={() => setShowScoreDetails(!showScoreDetails)}
        className="mt-3 flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800"
      >
        <Icon name={showScoreDetails ? 'ChevronUp' : 'ChevronDown'} className="w-3 h-3" />
        <span>How is this calculated?</span>
      </button>

      {showScoreDetails && (
        <div className="mt-3 p-3 bg-white rounded-lg border border-slate-200 text-xs space-y-3">
          <p className="text-slate-600">
            The readiness score is a weighted average of five components, each measuring a different aspect of ES capability:
          </p>

          <div className="space-y-2">
            <div className="p-2 bg-blue-50 rounded">
              <div className="flex items-center justify-between mb-1">
                <span className="font-bold text-blue-800">Team Capability (35%)</span>
                <span className="font-bold text-blue-800">{components?.teamScore || 0}</span>
              </div>
              <p className="text-slate-600">
                Can your unit field operational teams? Measures field ops (30%), aircrew (30%), sUAS (10%), mission base (15%), and command (15%).
                Full points for 2+ teams, partial for 1 team, lower if missing key positions.
              </p>
            </div>

            <div className="p-2 bg-emerald-50 rounded">
              <div className="flex items-center justify-between mb-1">
                <span className="font-bold text-emerald-800">Qualification Health (25%)</span>
                <span className="font-bold text-emerald-800">{components?.qualScore || 0}</span>
              </div>
              <p className="text-slate-600">
                Ratio of active vs expired qualifications. Score = (Active Ã· (Active + Expired)) Ã— 100.
                Higher is better - expired quals pull down the score.
              </p>
            </div>

            <div className="p-2 bg-indigo-50 rounded">
              <div className="flex items-center justify-between mb-1">
                <span className="font-bold text-indigo-800">Potential Evaluator Coverage (15%)</span>
                <span className="font-bold text-indigo-800">{components?.evaluatorScore || 0}</span>
              </div>
              <p className="text-slate-600">
                Estimates potential internal evaluation capability based on SET qualification + 1yr tenure.
                Low coverage suggests may need external evaluators. <em>Verify actual status in eServices.</em>
              </p>
            </div>

            <div className="p-2 bg-amber-50 rounded">
              <div className="flex items-center justify-between mb-1">
                <span className="font-bold text-amber-800">Risk Mitigation (15%)</span>
                <span className="font-bold text-amber-800">{components?.riskScore || 0}</span>
              </div>
              <p className="text-slate-600">
                Do you have backup personnel? Starts at 100, subtracts 25 per single point of failure (SPOF).
                SPOFs include: single GTL, single pilot, single scanner, single IC.
              </p>
            </div>

            <div className="p-2 bg-purple-50 rounded">
              <div className="flex items-center justify-between mb-1">
                <span className="font-bold text-purple-800">Pipeline Strength (10%)</span>
                <span className="font-bold text-purple-800">{components?.pipelineScore || 0}</span>
              </div>
              <p className="text-slate-600">
                Is the unit actively training new ES members? Base of 30 if no active training, +10 per trainee up to 100.
                More trainees = stronger future capability.
              </p>
            </div>
          </div>

          <div className="p-2 bg-slate-100 rounded">
            <p className="text-slate-700 font-medium">Score Thresholds:</p>
            <ul className="mt-1 space-y-0.5 text-slate-600">
              <li>â€¢ <span className="font-bold text-emerald-700">80+</span> Excellent - Ready for operational missions</li>
              <li>â€¢ <span className="font-bold text-blue-700">65-79</span> Good - Solid capability with room to grow</li>
              <li>â€¢ <span className="font-bold text-amber-700">50-64</span> Fair - Can participate but has gaps</li>
              <li>â€¢ <span className="font-bold text-rose-700">&lt;50</span> Needs Attention - Focus on training</li>
            </ul>
          </div>
        </div>
      )}
    </div>
  );
};

/**
 * ESQualificationHealthCard - Shows qualification status breakdown
 */
const ESQualificationHealthCard = ({ qualifications }) => {
  const total = qualifications.byStatus.active + qualifications.byStatus.training + qualifications.byStatus.expired;

  return (
    <div className="bg-white rounded-lg border border-slate-200 p-4">
      <div className="flex items-center gap-2 mb-3">
        <h4 className="text-sm font-semibold text-slate-700">Qualification Health</h4>
        <HelpTooltip position="right">
          <p>Distribution of ES qualifications across your unit members.</p>
          <p className="mt-1 text-slate-300">Active qualifications are current and valid for operations.</p>
        </HelpTooltip>
      </div>
      <div className="grid grid-cols-3 gap-3">
        <div className="text-center p-2 bg-emerald-50 rounded-lg">
          <div className="text-xl font-bold text-emerald-700">{qualifications.byStatus.active}</div>
          <div className="text-xs text-slate-600">Active</div>
        </div>
        <div className="text-center p-2 bg-amber-50 rounded-lg">
          <div className="text-xl font-bold text-amber-700">{qualifications.byStatus.training}</div>
          <div className="text-xs text-slate-600">Training</div>
        </div>
        <div className="text-center p-2 bg-rose-50 rounded-lg">
          <div className="text-xl font-bold text-rose-700">{qualifications.byStatus.expired}</div>
          <div className="text-xs text-slate-600">Expired</div>
        </div>
      </div>
      {qualifications.missingGES && qualifications.missingGES.length > 0 && (
        <div className="mt-3 p-2 bg-rose-50 border border-rose-200 rounded-lg">
          <div className="flex items-center gap-1 text-xs text-rose-700">
            <Icon name="AlertTriangle" className="w-3 h-3" />
            <span className="font-medium">{qualifications.missingGES.length} member(s) without GES</span>
          </div>
        </div>
      )}
    </div>
  );
};

/**
 * ESAlertsCard - Shows expiring qualifications and SPOF warnings
 */
const ESAlertsCard = ({ risks, expiring }) => {
  if ((!expiring || expiring.length === 0) && (!risks?.singlePointsOfFailure || risks.singlePointsOfFailure.length === 0)) {
    return null;
  }

  return (
    <div className="bg-amber-50 rounded-lg border border-amber-200 p-4">
      <div className="flex items-center gap-2 mb-3">
        <Icon name="AlertTriangle" className="w-5 h-5 text-amber-600" />
        <h4 className="text-sm font-semibold text-amber-800">Attention Required</h4>
      </div>

      {/* Expiring Qualifications */}
      {expiring && expiring.length > 0 && (
        <div className="mb-3">
          <div className="text-xs font-medium text-amber-700 mb-2">Qualifications Expiring Within 90 Days</div>
          <div className="space-y-1">
            {expiring.slice(0, 4).map((e, idx) => (
              <div
                key={`${e.capid}-${e.achvID}-${idx}`}
                className={`flex items-center justify-between px-2 py-1.5 rounded text-xs ${
                  e.urgency === 'critical' ? 'bg-rose-100 text-rose-800' :
                  e.urgency === 'warning' ? 'bg-amber-100 text-amber-800' :
                  'bg-yellow-50 text-yellow-800'
                }`}
              >
                <span className="font-medium">{e.rank} {e.name}</span>
                <span>{e.qualification} - {e.daysUntil}d</span>
              </div>
            ))}
            {expiring.length > 4 && (
              <div className="text-xs text-amber-600 mt-1">+{expiring.length - 4} more</div>
            )}
          </div>
        </div>
      )}

      {/* Single Points of Failure */}
      {risks?.singlePointsOfFailure && risks.singlePointsOfFailure.length > 0 && (
        <div>
          <div className="text-xs font-medium text-amber-700 mb-2">Single Points of Failure</div>
          <div className="space-y-1">
            {risks.singlePointsOfFailure.map((spof, idx) => (
              <div
                key={`${spof.capid}-${idx}`}
                className="flex items-center justify-between px-2 py-1.5 bg-orange-100 text-orange-800 rounded text-xs"
              >
                <span className="font-medium">{spof.positionName}</span>
                <span>{spof.member}</span>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

/**
 * ESEvaluatorCard - Shows potential Skills Evaluator availability
 * Note: These are estimates based on SET qual + 1yr holding requirement - actual evaluator status must be verified in eServices
 */
const ESEvaluatorCard = ({ evaluators }) => {
  return (
    <div className="bg-white rounded-lg border border-slate-200 p-4">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <h4 className="text-sm font-semibold text-slate-700">Potential Evaluators</h4>
          <HelpTooltip position="right">
            <p>Members who may be eligible to evaluate ES qualifications.</p>
            <p className="mt-1 text-slate-300">Based on SET qualification + holding a qual for 1+ year.</p>
            <p className="mt-1 text-amber-300">âš ï¸ This is an estimate only. Verify actual evaluator status in eServices.</p>
          </HelpTooltip>
        </div>
        <span className={`text-sm font-bold ${
          evaluators.coverage >= 80 ? 'text-emerald-600' :
          evaluators.coverage >= 50 ? 'text-amber-600' : 'text-rose-600'
        }`}>
          {evaluators.coverage}% coverage
        </span>
      </div>
      <div className="flex items-center gap-4">
        <div className="text-center">
          <div className="text-2xl font-bold text-slate-800">{evaluators.evaluatorCount || evaluators.available?.length || 0}</div>
          <div className="text-xs text-slate-500">Potential</div>
        </div>
        <div className="flex-1">
          <div className="w-full bg-slate-100 rounded-full h-2">
            <div
              className={`h-2 rounded-full ${
                evaluators.coverage >= 80 ? 'bg-emerald-500' :
                evaluators.coverage >= 50 ? 'bg-amber-500' : 'bg-rose-500'
              }`}
              style={{ width: `${evaluators.coverage}%` }}
            />
          </div>
        </div>
      </div>
      {evaluators.gaps && evaluators.gaps.length > 0 && (
        <div className="mt-3 text-xs text-slate-500">
          <span className="font-medium">Gaps:</span> {evaluators.gaps.slice(0, 3).join(', ')}
          {evaluators.gaps.length > 3 && ` +${evaluators.gaps.length - 3} more`}
        </div>
      )}
      <div className="mt-2 text-[10px] text-slate-400">
        *Verify evaluator status in eServices
      </div>
    </div>
  );
};

/**
 * ESReadinessSection - Emergency Services readiness dashboard section
 */
const ESReadinessSection = ({ esAnalysis, isExpanded, onToggle, onDeepDive }) => {
  if (!esAnalysis) return null;

  // Build field ops tooltip
  const fieldOpsTooltip = (() => {
    const parts = [];
    if (esAnalysis.teams.fieldOps.canFieldGround) {
      parts.push(`${esAnalysis.teams.fieldOps.groundTeamsFieldable} GT`);
    }
    if (esAnalysis.teams.fieldOps.canFieldUDF) {
      parts.push(`${esAnalysis.teams.fieldOps.udfTeamsFieldable} UDF`);
    }
    return parts.length > 0 ? parts.join(', ') : 'Cannot field';
  })();

  // Key data for collapsed state with mini team icons
  const keyData = (
    <div className="flex items-center gap-4 flex-wrap">
      {/* Mini team status icons */}
      <div className="flex items-center gap-3">
        <ESTeamStatusIcon
          shortName="Field"
          color={esAnalysis.teams.fieldOps.color}
          tooltip={fieldOpsTooltip}
        />
        <ESTeamStatusIcon
          shortName="Air"
          color={esAnalysis.teams.aircrew.color}
          tooltip={esAnalysis.teams.aircrew.canField ? `${esAnalysis.teams.aircrew.teamsFieldable} crew(s)` : 'Cannot field'}
        />
        <ESTeamStatusIcon
          shortName="sUAS"
          color={esAnalysis.teams.suas.color}
          tooltip={esAnalysis.teams.suas.canField ? 'Available' : 'Not available'}
        />
        <ESTeamStatusIcon
          shortName="Base"
          color={esAnalysis.teams.missionBase.color}
          tooltip={`${esAnalysis.teams.missionBase.qualifiedCount} qualified`}
        />
        <ESTeamStatusIcon
          shortName="Cmd"
          color={esAnalysis.teams.command.color}
          tooltip={esAnalysis.teams.command.hasIC ? `${esAnalysis.teams.command.qualifiedCount} qualified, IC available` : `${esAnalysis.teams.command.qualifiedCount} qualified, no IC`}
        />
      </div>
      {/* Score badge */}
      <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
        esAnalysis.readinessRating === 'excellent' ? 'bg-emerald-100 text-emerald-700' :
        esAnalysis.readinessRating === 'good' ? 'bg-blue-100 text-blue-700' :
        esAnalysis.readinessRating === 'fair' ? 'bg-amber-100 text-amber-700' :
        'bg-rose-100 text-rose-700'
      }`}>
        {esAnalysis.readinessScore}
      </span>
      {/* Expiring count */}
      {esAnalysis.qualifications.expiringWithin90Days.length > 0 && (
        <>
          <span className="text-slate-400">|</span>
          <span className="text-amber-600 text-sm">
            {esAnalysis.qualifications.expiringWithin90Days.length} expiring
          </span>
        </>
      )}
    </div>
  );

  return (
    <DashboardSection
      id="emergency-services"
      title="Emergency Services Readiness"
      icon="Activity"
      isExpanded={isExpanded}
      onToggle={() => onToggle('emergency-services')}
      onDeepDive={onDeepDive}
      accentColor={esAnalysis.readinessRating === 'excellent' ? 'green' :
                   esAnalysis.readinessRating === 'good' ? 'blue' :
                   esAnalysis.readinessRating === 'fair' ? 'amber' : 'rose'}
      keyData={keyData}
    >
      <div className="space-y-4 pt-4">
        {/* ES Readiness Score */}
        <ESReadinessScoreCard
          score={esAnalysis.readinessScore}
          rating={esAnalysis.readinessRating}
          components={esAnalysis.readinessComponents}
        />

        {/* Team Capability Cards Grid */}
        <div>
          <div className="flex items-center gap-2 mb-3">
            <h4 className="text-sm font-semibold text-slate-700">Team Capabilities</h4>
            <HelpTooltip position="right">
              <p>Shows what operational teams your unit can field based on CAPR 60-3 requirements.</p>
              <p className="mt-1 text-slate-300">Green = fully capable, Amber = partial, Red = cannot field</p>
            </HelpTooltip>
          </div>
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
            <FieldOpsCapabilityCard fieldOps={esAnalysis.teams.fieldOps} />
            <ESTeamCapabilityCard team={esAnalysis.teams.aircrew} />
            <ESTeamCapabilityCard team={esAnalysis.teams.suas} />
            <ESTeamCapabilityCard team={esAnalysis.teams.missionBase} />
            <ESTeamCapabilityCard team={esAnalysis.teams.command} />
          </div>
        </div>

        {/* Qualification Health Summary */}
        <ESQualificationHealthCard qualifications={esAnalysis.qualifications} />

        {/* Alerts for expirations/gaps */}
        <ESAlertsCard
          risks={esAnalysis.risks}
          expiring={esAnalysis.qualifications.expiringWithin90Days}
        />

        {/* Evaluator availability */}
        <ESEvaluatorCard evaluators={esAnalysis.evaluators} />

        {/* Training Pipeline Summary */}
        {esAnalysis.pipeline.activeTraining.length > 0 && (
          <div className="bg-indigo-50 rounded-lg border border-indigo-200 p-4">
            <div className="flex items-center gap-2 mb-2">
              <Icon name="TrendingUp" className="w-5 h-5 text-indigo-600" />
              <h4 className="text-sm font-semibold text-indigo-800">Training Pipeline</h4>
            </div>
            <p className="text-sm text-indigo-700">
              {esAnalysis.pipeline.activeTraining.length} member(s) actively training for ES qualifications
            </p>
            <div className="mt-2 flex flex-wrap gap-1">
              {[...new Set(esAnalysis.pipeline.activeTraining.map(t => t.position))].map(pos => (
                <span key={pos} className="px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs rounded-full">
                  {pos}
                </span>
              ))}
            </div>
          </div>
        )}

        {/* Recommendations Preview */}
        {esAnalysis.risks.recommendations && esAnalysis.risks.recommendations.length > 0 && (
          <div className="bg-slate-50 rounded-lg border border-slate-200 p-4">
            <div className="flex items-center gap-2 mb-2">
              <Icon name="Lightbulb" className="w-5 h-5 text-slate-600" />
              <h4 className="text-sm font-semibold text-slate-700">Top Recommendation</h4>
            </div>
            <p className="text-sm text-slate-600">
              {esAnalysis.risks.recommendations[0].recommendation}
            </p>
            {esAnalysis.risks.recommendations.length > 1 && (
              <p className="text-xs text-slate-400 mt-1">
                +{esAnalysis.risks.recommendations.length - 1} more recommendations in detailed view
              </p>
            )}
          </div>
        )}
      </div>
    </DashboardSection>
  );
};

/**
 * ESUnitComparisonTable - Shows ES readiness for subordinate units (aggregate view)
 */
const ESUnitComparisonTable = ({ unitMetrics, getUnitName, sortConfig, onSort }) => {
  const TeamDot = ({ color }) => {
    const colorStyles = {
      green: 'bg-emerald-500',
      blue: 'bg-blue-500',
      amber: 'bg-amber-500',
      red: 'bg-rose-400'
    };
    return <span className={`w-2.5 h-2.5 rounded-full inline-block ${colorStyles[color] || 'bg-slate-300'}`} />;
  };

  const SortableHeader = ({ field, label, className = '' }) => (
    <th
      className={`px-3 py-2 text-left text-xs font-bold text-slate-600 uppercase tracking-wide cursor-pointer hover:bg-slate-100 transition-colors ${className}`}
      onClick={() => onSort(field)}
    >
      <div className="flex items-center gap-1">
        {label}
        {sortConfig.field === field && (
          <Icon
            name={sortConfig.direction === 'asc' ? 'ChevronUp' : 'ChevronDown'}
            className="w-3 h-3"
          />
        )}
      </div>
    </th>
  );

  return (
    <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
      <div className="overflow-x-auto">
        <table className="w-full">
          <thead className="bg-slate-50 border-b border-slate-200">
            <tr>
              <SortableHeader field="name" label="Unit" className="min-w-[140px]" />
              <SortableHeader field="readinessScore" label="Score" />
              <th className="px-3 py-2 text-center text-xs font-bold text-slate-600 uppercase">Field</th>
              <th className="px-3 py-2 text-center text-xs font-bold text-slate-600 uppercase">Air</th>
              <th className="px-3 py-2 text-center text-xs font-bold text-slate-600 uppercase">sUAS</th>
              <SortableHeader field="expiringCount" label="Expiring" />
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {unitMetrics.map((unit, idx) => {
              const unitName = getUnitName(unit.orgId);
              return (
                <tr
                  key={unit.orgId}
                  className={`hover:bg-slate-50 transition-colors ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-25'}`}
                >
                  <td className="px-3 py-2">
                    <div className="font-medium text-slate-800 text-sm">{unitName}</div>
                    <div className="text-xs text-slate-500">{unit.memberCount} members</div>
                  </td>
                  <td className="px-3 py-2">
                    <span className={`inline-flex px-2 py-0.5 rounded-full text-xs font-bold ${
                      unit.readinessRating === 'excellent' ? 'bg-emerald-100 text-emerald-700' :
                      unit.readinessRating === 'good' ? 'bg-blue-100 text-blue-700' :
                      unit.readinessRating === 'fair' ? 'bg-amber-100 text-amber-700' :
                      'bg-rose-100 text-rose-700'
                    }`}>
                      {unit.readinessScore}
                    </span>
                  </td>
                  <td className="px-3 py-2 text-center">
                    <TeamDot color={unit.teamStatus?.fieldOps} />
                  </td>
                  <td className="px-3 py-2 text-center">
                    <TeamDot color={unit.teamStatus?.aircrew} />
                  </td>
                  <td className="px-3 py-2 text-center">
                    <TeamDot color={unit.teamStatus?.suas} />
                  </td>
                  <td className="px-3 py-2 text-sm">
                    {unit.expiringCount > 0 ? (
                      <span className="text-amber-600 font-medium">{unit.expiringCount}</span>
                    ) : (
                      <span className="text-slate-400">0</span>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  );
};

/**
 * AggregateStatsHeader - Summary header for Mode C (aggregate view)
 */
const AggregateStatsHeader = ({ aggregateMetrics, unitCount, rrMetrics }) => {
  // Calculate averages and aggregates
  const avgSustainability = aggregateMetrics.length > 0
    ? Math.round(aggregateMetrics.reduce((sum, u) => sum + (u.sustainabilityScore || 0), 0) / aggregateMetrics.filter(u => u.sustainabilityScore).length)
    : null;

  const avgRetention = aggregateMetrics.length > 0
    ? Math.round(aggregateMetrics.reduce((sum, u) => sum + (u.retentionRate || 0), 0) / aggregateMetrics.filter(u => u.retentionRate).length * 10) / 10
    : null;

  const growingUnits = aggregateMetrics.filter(u => u.growthStatus === 'growing').length;
  const decliningUnits = aggregateMetrics.filter(u => u.growthStatus === 'declining').length;

  const totalMembers = rrMetrics?.summary?.currentTotal || 0;

  return (
    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
      <div className="p-3 rounded-lg bg-blue-50 border border-blue-100">
        <div className="text-[10px] uppercase text-blue-700 font-bold">Total Members</div>
        <div className="text-2xl font-bold text-blue-900">{totalMembers}</div>
      </div>
      <div className="p-3 rounded-lg bg-indigo-50 border border-indigo-100">
        <div className="text-[10px] uppercase text-indigo-700 font-bold">Subordinate Units</div>
        <div className="text-2xl font-bold text-indigo-900">{unitCount}</div>
      </div>
      <div className="p-3 rounded-lg bg-emerald-50 border border-emerald-100">
        <div className="text-[10px] uppercase text-emerald-700 font-bold">Avg Sustainability</div>
        <div className="text-xl font-bold text-emerald-900">{avgSustainability ?? '--'}</div>
      </div>
      <div className="p-3 rounded-lg bg-amber-50 border border-amber-100">
        <div className="text-[10px] uppercase text-amber-700 font-bold">Avg Retention</div>
        <div className="text-xl font-bold text-amber-900">{avgRetention !== null ? `${avgRetention}%` : '--'}</div>
      </div>
      <div className="p-3 rounded-lg bg-slate-50 border border-slate-200">
        <div className="text-[10px] uppercase text-slate-600 font-bold">Growth Trend</div>
        <div className="flex items-center gap-2 mt-1">
          <span className="text-sm font-bold text-emerald-600">{growingUnits} â†‘</span>
          <span className="text-sm font-bold text-rose-600">{decliningUnits} â†“</span>
        </div>
      </div>
    </div>
  );
};

function UnitOverviewSection({
  baseUnitStats,
  showAllDescendants,
  processedData,
  cadetData,
  orgChartData,
  setActiveTab,
  // New props
  unitFilter,
  descendantOrgIds,
  orgStatsService,
  esUnitAnalysisService,
  dataFiles,
  // Modal handlers
  setRecruitingRetentionModal,
  setESReadinessModal
}) {
  const [expandedSection, setExpandedSection] = useState(null);
  const [timeRange, setTimeRange] = useState(12); // Default 12 months
  const chartRef = useRefLocal(null);
  const chartInstanceRef = useRefLocal(null);
  const [tableSortConfig, setTableSortConfig] = useState({ field: 'sustainabilityScore', direction: 'desc' });

  // === UNIT TYPE DETECTION ===
  const unitType = useMemo(() => {
    const org = (dataFiles.organization || []).find(o =>
      String(o.ORGID || '').trim() === String(unitFilter || '').trim()
    );
    return String(org?.Type || '').toUpperCase();
  }, [dataFiles.organization, unitFilter]);

  // Check if this is a command/admin HQ unit
  const isCommandHQ = useMemo(() => {
    return unitType.includes('GROUP') || unitType.includes('WING') ||
           unitType.includes('REGION') || unitType.includes('NATIONAL');
  }, [unitType]);

  // === VIEW MODE DETERMINATION ===
  // Mode A: Operational Unit (squadron/flight) - standard metrics view
  // Mode B: Command Unit Only (HQ without sub-units) - prompt to enable sub-units
  // Mode C: Command + Sub-Units (aggregate view) - unit comparison table
  const viewMode = useMemo(() => {
    if (!isCommandHQ) return 'operational'; // Mode A
    if (!showAllDescendants) return 'command-only'; // Mode B
    return 'aggregate'; // Mode C
  }, [isCommandHQ, showAllDescendants]);

  // === UNIT NAME LOOKUP ===
  const getUnitName = useCallback((orgId) => {
    const org = (dataFiles.organization || []).find(o =>
      String(o.ORGID || '').trim() === String(orgId || '').trim()
    );
    if (!org) return `Unit ${orgId}`;
    const cleanUnit = org.Unit ? org.Unit.replace(/^0+/, '').padStart(3, '0') : '000';
    return `${org.Region || ''}-${org.Wing || ''}-${cleanUnit}`;
  }, [dataFiles.organization]);

  // === UNIT METRICS FOR COMPARISON TABLE (Mode C) ===
  const subordinateUnitMetrics = useMemo(() => {
    if (viewMode !== 'aggregate' || !orgStatsService || !descendantOrgIds) return [];

    // Filter to only operational units (exclude command HQs from the comparison)
    const operationalUnits = descendantOrgIds.filter(orgId => {
      const org = (dataFiles.organization || []).find(o =>
        String(o.ORGID || '').trim() === String(orgId || '').trim()
      );
      const type = String(org?.Type || '').toUpperCase();
      // Include squadrons and flights, exclude groups/wings/regions
      const isHQ = type.includes('GROUP') || type.includes('WING') ||
                   type.includes('REGION') || type.includes('NATIONAL');
      return !isHQ;
    });

    return orgStatsService.getMetricsForMultipleUnits(operationalUnits, {
      timeRangeMonths: timeRange
    });
  }, [viewMode, orgStatsService, descendantOrgIds, dataFiles.organization, timeRange]);

  // Sort unit metrics for table
  const sortedUnitMetrics = useMemo(() => {
    if (!subordinateUnitMetrics.length) return [];

    return [...subordinateUnitMetrics].sort((a, b) => {
      let aVal, bVal;

      if (tableSortConfig.field === 'name') {
        aVal = getUnitName(a.orgId);
        bVal = getUnitName(b.orgId);
      } else {
        aVal = a[tableSortConfig.field] ?? -Infinity;
        bVal = b[tableSortConfig.field] ?? -Infinity;
      }

      if (typeof aVal === 'string') {
        return tableSortConfig.direction === 'asc'
          ? aVal.localeCompare(bVal)
          : bVal.localeCompare(aVal);
      }

      return tableSortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
    });
  }, [subordinateUnitMetrics, tableSortConfig, getUnitName]);

  const handleTableSort = (field) => {
    setTableSortConfig(prev => ({
      field,
      direction: prev.field === field && prev.direction === 'desc' ? 'asc' : 'desc'
    }));
  };

  const handleUnitClick = (orgId) => {
    // Placeholder for future functionality: navigate to unit detail or open modal
    // Currently a no-op - the click handler is wired up for future use
  };

  // Get recruiting/retention metrics
  const rrMetrics = useMemo(() => {
    if (!orgStatsService || !unitFilter) return null;

    return orgStatsService.getMetricsForUnit(unitFilter, {
      includeDescendants: showAllDescendants,
      descendantOrgIds: descendantOrgIds || [],
      timeRangeMonths: timeRange
    });
  }, [orgStatsService, unitFilter, showAllDescendants, descendantOrgIds, timeRange]);

  const rrKeyData = useMemo(() => {
    if (!orgStatsService || !unitFilter) return null;

    return orgStatsService.getKeyDataForUnit(unitFilter, {
      includeDescendants: showAllDescendants,
      descendantOrgIds: descendantOrgIds || []
    });
  }, [orgStatsService, unitFilter, showAllDescendants, descendantOrgIds]);

  // === EMERGENCY SERVICES ANALYSIS ===
  const esAnalysis = useMemo(() => {
    if (!esUnitAnalysisService || !unitFilter) return null;

    return esUnitAnalysisService.analyzeUnit(unitFilter, {
      includeDescendants: showAllDescendants,
      descendantOrgIds: descendantOrgIds || []
    });
  }, [esUnitAnalysisService, unitFilter, showAllDescendants, descendantOrgIds]);

  // ES metrics for aggregate view (subordinate units)
  const esSubordinateMetrics = useMemo(() => {
    if (viewMode !== 'aggregate' || !esUnitAnalysisService || !descendantOrgIds) return [];

    const operationalUnits = descendantOrgIds.filter(orgId => {
      const org = (dataFiles.organization || []).find(o =>
        String(o.ORGID || '').trim() === String(orgId || '').trim()
      );
      const type = String(org?.Type || '').toUpperCase();
      const isHQ = type.includes('GROUP') || type.includes('WING') ||
                   type.includes('REGION') || type.includes('NATIONAL');
      return !isHQ;
    });

    return esUnitAnalysisService.getMetricsForMultipleUnits(operationalUnits);
  }, [viewMode, esUnitAnalysisService, descendantOrgIds, dataFiles.organization]);

  // Sort ES metrics for table
  const [esTableSortConfig, setESTableSortConfig] = useState({ field: 'readinessScore', direction: 'desc' });

  const sortedESMetrics = useMemo(() => {
    if (!esSubordinateMetrics.length) return [];

    return [...esSubordinateMetrics].sort((a, b) => {
      let aVal, bVal;

      if (esTableSortConfig.field === 'name') {
        aVal = getUnitName(a.orgId);
        bVal = getUnitName(b.orgId);
      } else {
        aVal = a[esTableSortConfig.field] ?? -Infinity;
        bVal = b[esTableSortConfig.field] ?? -Infinity;
      }

      if (typeof aVal === 'string') {
        return esTableSortConfig.direction === 'asc'
          ? aVal.localeCompare(bVal)
          : bVal.localeCompare(aVal);
      }

      return esTableSortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
    });
  }, [esSubordinateMetrics, esTableSortConfig, getUnitName]);

  const handleESTableSort = (field) => {
    setESTableSortConfig(prev => ({
      field,
      direction: prev.field === field && prev.direction === 'desc' ? 'asc' : 'desc'
    }));
  };

  // Initialize mini chart when section expands
  useEffect(() => {
    if (expandedSection !== 'recruiting' || !rrMetrics?.monthlyData?.length) return;

    // Cleanup previous chart
    if (chartInstanceRef.current) {
      chartInstanceRef.current.destroy();
      chartInstanceRef.current = null;
    }

    // Wait for DOM
    const timer = setTimeout(() => {
      const canvas = document.getElementById('chart-recruiting-mini');
      if (!canvas || !window.Chart) return;

      const ctx = canvas.getContext('2d');
      const data = rrMetrics.monthlyData;

      chartInstanceRef.current = new window.Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.label || d.date),
          datasets: [
            {
              label: 'Total Members',
              data: data.map(d => d.combined?.total || 0),
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                afterBody: (context) => {
                  const idx = context[0].dataIndex;
                  const d = data[idx];
                  return [
                    `New: ${d.combined?.new || 0}`,
                    `Renewed: ${d.combined?.renew || 0}`,
                    `Rejoined: ${d.combined?.rejoin || 0}`
                  ];
                }
              }
            }
          },
          scales: {
            y: { beginAtZero: false },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: { size: 10 }
              }
            }
          }
        }
      });
    }, 100);

    return () => {
      clearTimeout(timer);
      if (chartInstanceRef.current) {
        chartInstanceRef.current.destroy();
        chartInstanceRef.current = null;
      }
    };
  }, [expandedSection, rrMetrics]);

  // Toggle section expansion (accordion behavior - one at a time)
  const handleToggleSection = (sectionId) => {
    setExpandedSection(prev => prev === sectionId ? null : sectionId);
  };

  // Open deep dive modal
  const handleDeepDive = (sectionId) => {
    if (sectionId === 'recruiting') {
      setRecruitingRetentionModal({
        isOpen: true,
        metrics: rrMetrics,
        unitFilter,
        showAllDescendants,
        timeRange
      });
    }
  };

  // Time range options
  const timeRangeOptions = [
    { value: 6, label: '6 mo' },
    { value: 12, label: '12 mo' },
    { value: 24, label: '2 yr' },
    { value: 60, label: '5 yr' },
    { value: 0, label: 'All' }
  ];

  // Check if org stats data is available
  const hasOrgStatsData = orgStatsService && orgStatsService.hasDataForUnit(
    unitFilter,
    showAllDescendants,
    descendantOrgIds || []
  );

  // Get HQ unit label
  const getHQLabel = () => {
    return unitType.includes('WING') ? 'Wing' :
           unitType.includes('GROUP') ? 'Group' :
           unitType.includes('REGION') ? 'Region' : 'Headquarters';
  };

  // Get HQ staff members for command-only view (Mode B)
  const hqStaffMembers = useMemo(() => {
    if (viewMode !== 'command-only' || !dataFiles.members || !unitFilter) return [];

    // Filter to active members assigned to this HQ unit
    return dataFiles.members.filter(m => {
      const status = String(m.MbrStatus || '').toUpperCase();
      const memberOrgId = String(m.ORGID || '').trim();
      const targetOrgId = String(unitFilter || '').trim();
      return status === 'ACTIVE' && memberOrgId === targetOrgId;
    });
  }, [viewMode, dataFiles.members, unitFilter]);

  // Dynamic header text based on view mode
  const getHeaderInfo = () => {
    if (viewMode === 'aggregate') {
      return {
        label: `${getHQLabel()} Dashboard`,
        description: `Aggregate view of membership health across ${sortedUnitMetrics.length} subordinate units.`
      };
    }
    if (viewMode === 'command-only') {
      return {
        label: 'Headquarters View',
        description: 'Command/administrative unit staff overview.'
      };
    }
    return {
      label: 'Unit Overview',
      description: `Combined view of membership health and readiness for ${showAllDescendants ? 'unit + subordinates' : 'selected unit'}.`
    };
  };

  const headerInfo = getHeaderInfo();

  return (
    <div className="space-y-4">
      {/* Header Card - adapts to view mode */}
      <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
        <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <div className="flex items-center gap-2">
              <p className="text-xs uppercase text-slate-500 font-bold tracking-wide">Commander Snapshot</p>
              {viewMode === 'aggregate' && (
                <span className="px-2 py-0.5 text-[10px] font-bold uppercase bg-indigo-100 text-indigo-700 rounded-full">
                  Aggregate View
                </span>
              )}
            </div>
            <h2 className="text-xl font-bold text-slate-900">{headerInfo.label}</h2>
            <p className="text-sm text-slate-600 mt-1">{headerInfo.description}</p>
            {/* Include Sub-Units instruction for command HQ units */}
            {viewMode === 'command-only' && (
              <p className="text-sm text-indigo-600 mt-2 flex items-center gap-1">
                <Icon name="Info" className="w-4 h-4" />
                Use the <strong className="mx-1">"Include Sub-Units"</strong> toggle in the header to view aggregate data for all subordinate squadrons.
              </p>
            )}
          </div>
          {/* Stats cards - different for aggregate view */}
          {viewMode === 'aggregate' ? (
            <AggregateStatsHeader
              aggregateMetrics={sortedUnitMetrics}
              unitCount={sortedUnitMetrics.length}
              rrMetrics={rrMetrics}
            />
          ) : (
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 min-w-[240px]">
              <div className="p-3 rounded-lg bg-blue-50 border border-blue-100">
                <div className="text-[10px] uppercase text-blue-700 font-bold">Total Members</div>
                <div className="text-2xl font-bold text-blue-900">{baseUnitStats ? baseUnitStats.total : 0}</div>
              </div>
              <div className="p-3 rounded-lg bg-emerald-50 border border-emerald-100">
                <div className="text-[10px] uppercase text-emerald-700 font-bold">Senior</div>
                <div className="text-xl font-bold text-emerald-900">{processedData.length}</div>
              </div>
              <div className="p-3 rounded-lg bg-amber-50 border border-amber-100">
                <div className="text-[10px] uppercase text-amber-700 font-bold">Cadets</div>
                <div className="text-xl font-bold text-amber-900">{cadetData.length}</div>
              </div>
              <div className="p-3 rounded-lg bg-indigo-50 border border-indigo-100">
                <div className="text-[10px] uppercase text-indigo-700 font-bold">View</div>
                <div className="text-sm font-bold text-indigo-900">{showAllDescendants ? 'Unit + Sub' : 'This Unit'}</div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Dashboard Sections */}
      <div className="space-y-3">

        {/* MODE B: Command Unit Only - Show HQ Staff Insights section */}
        {viewMode === 'command-only' && (
          <HQStaffInsights
            unitType={unitType}
            staffMembers={hqStaffMembers}
            isExpanded={expandedSection === 'hq-staff'}
            onToggle={handleToggleSection}
            onDeepDive={handleDeepDive}
            getHQLabel={getHQLabel}
          />
        )}

        {/* MODE A & C: Show recruiting/retention section for operational units and aggregate view */}
        {(viewMode === 'operational' || viewMode === 'aggregate') && hasOrgStatsData && (
          <DashboardSection
            id="recruiting"
            title={viewMode === 'aggregate' ? 'Aggregate Recruiting & Retention' : 'Recruiting & Retention'}
            icon="UserPlus"
            isExpanded={expandedSection === 'recruiting'}
            onToggle={handleToggleSection}
            onDeepDive={handleDeepDive}
            accentColor={rrKeyData?.sustainabilityRating === 'excellent' ? 'green' :
                         rrKeyData?.sustainabilityRating === 'good' ? 'blue' :
                         rrKeyData?.sustainabilityRating === 'fair' ? 'amber' : 'rose'}
            keyData={rrKeyData && (
              <div className="flex items-center gap-4 flex-wrap">
                <span className="font-semibold">
                  {rrKeyData.currentTotal} members
                  {rrKeyData.yearOverYearChange !== null && (
                    <span className={`ml-2 ${
                      rrKeyData.yearOverYearChange > 0 ? 'text-emerald-600' :
                      rrKeyData.yearOverYearChange < 0 ? 'text-rose-600' : 'text-slate-500'
                    }`}>
                      ({rrKeyData.yearOverYearChange > 0 ? '+' : ''}{rrKeyData.yearOverYearChange} YoY)
                    </span>
                  )}
                </span>
                {rrKeyData.retentionRate !== null && (
                  <>
                    <span className="text-slate-400">|</span>
                    <span>{rrKeyData.retentionRate}% retention</span>
                  </>
                )}
              </div>
            )}
          >
            {/* Expanded Content */}
            {rrMetrics && (
              <div className="space-y-4 pt-4">
                {/* Time Range Selector - scoped to R&R section */}
                <div className="flex items-center justify-between bg-slate-50 rounded-lg p-3">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium text-slate-600">Analysis Time Range:</span>
                    <HelpTooltip position="bottom">
                      <p>Choose how far back to analyze membership trends.</p>
                      <p className="mt-1 text-slate-300">Shorter ranges show recent changes. Longer ranges reveal patterns and seasonality.</p>
                    </HelpTooltip>
                  </div>
                  <div className="flex gap-1">
                    {timeRangeOptions.map(opt => (
                      <button
                        key={opt.value}
                        onClick={() => setTimeRange(opt.value)}
                        className={`px-3 py-1.5 text-sm font-medium rounded-lg transition-colors ${
                          timeRange === opt.value
                            ? 'bg-slate-800 text-white'
                            : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200'
                        }`}
                      >
                        {opt.label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Subordinate Units Table - only for aggregate view */}
                {viewMode === 'aggregate' && sortedUnitMetrics.length > 0 && (
                  <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
                    <div className="p-3 border-b border-slate-200 bg-indigo-50">
                      <div className="flex items-center gap-2">
                        <Icon name="LayoutList" className="w-4 h-4 text-indigo-600" />
                        <h4 className="font-semibold text-sm text-indigo-800">Subordinate Units Performance</h4>
                        <span className="text-xs text-indigo-600 ml-auto">{sortedUnitMetrics.length} units</span>
                      </div>
                    </div>
                    <div className="p-3">
                      <UnitComparisonTable
                        unitMetrics={sortedUnitMetrics}
                        getUnitName={getUnitName}
                        onUnitClick={handleUnitClick}
                        sortConfig={tableSortConfig}
                        onSort={handleTableSort}
                      />
                    </div>
                  </div>
                )}

                {/* Sustainability Score - with explanation */}
                <div className="bg-slate-50 rounded-lg p-4">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <h4 className="font-semibold text-slate-800">Sustainability Score</h4>
                      <HelpTooltip title="What is this?" position="right">
                        <p className="mb-2">A composite score (0-100) measuring your unit's overall membership health.</p>
                        <p className="text-slate-300 mb-1">Components:</p>
                        <ul className="text-slate-300 text-[10px] space-y-0.5">
                          <li>â€¢ 25% Recruiting Rate</li>
                          <li>â€¢ 35% Retention Rate</li>
                          <li>â€¢ 25% Net Growth</li>
                          <li>â€¢ 15% Stability</li>
                        </ul>
                        <p className="mt-2 text-emerald-300">80+ Excellent | 65+ Good | 50+ Fair</p>
                      </HelpTooltip>
                    </div>
                    {rrMetrics.metrics.sustainability && (
                      <span className="text-2xl font-bold text-slate-900">
                        {rrMetrics.metrics.sustainability.overallScore}
                      </span>
                    )}
                  </div>
                  <SustainabilityGauge
                    score={rrMetrics.metrics.sustainability?.overallScore}
                    rating={rrMetrics.metrics.sustainability?.rating}
                  />
                  {rrMetrics.metrics.sustainability?.summary && (
                    <p className="text-sm text-slate-600 mt-2">
                      {rrMetrics.metrics.sustainability.summary}
                    </p>
                  )}
                  {/* Focus Area Recommendation */}
                  {rrMetrics.metrics.sustainability?.focusArea && rrMetrics.metrics.sustainability.focusArea.score < 70 && (
                    <div className="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                      <div className="flex items-start gap-2">
                        <Icon name="Lightbulb" className="w-4 h-4 text-amber-600 mt-0.5 shrink-0" />
                        <div>
                          <p className="text-sm font-medium text-amber-800">
                            Focus Area: {rrMetrics.metrics.sustainability.focusArea.label}
                          </p>
                          <p className="text-xs text-amber-700 mt-1">
                            Your {rrMetrics.metrics.sustainability.focusArea.label.toLowerCase()} score ({rrMetrics.metrics.sustainability.focusArea.score}) is your lowest component. Improving this will have the biggest impact on your overall score.
                          </p>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                {/* Key Metrics Grid - with help tooltips */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <MetricWithHelp
                    label="Recruiting Rate"
                    value={rrMetrics.metrics.recruiting?.monthlyAverage || '--'}
                    subValue="avg new members/month"
                    trend={rrMetrics.metrics.recruiting?.trendPercent
                      ? `${rrMetrics.metrics.recruiting.trendPercent}%`
                      : null}
                    trendDirection={rrMetrics.metrics.recruiting?.trend === 'increasing' ? 'up' :
                                    rrMetrics.metrics.recruiting?.trend === 'decreasing' ? 'down' : 'stable'}
                    color="blue"
                    explanation={rrMetrics.metrics.recruiting?.explanation}
                  />
                  <MetricWithHelp
                    label="Retention Rate"
                    value={rrMetrics.metrics.retention?.retentionRate !== null
                      ? `${rrMetrics.metrics.retention.retentionRate}%`
                      : '--'}
                    subValue={rrMetrics.metrics.retention?.healthIndicator === 'healthy' ? 'Healthy' :
                              rrMetrics.metrics.retention?.healthIndicator === 'moderate' ? 'Moderate' :
                              rrMetrics.metrics.retention?.healthIndicator === 'at-risk' ? 'Needs Attention' : ''}
                    color={rrMetrics.metrics.retention?.healthIndicator === 'healthy' ? 'green' :
                           rrMetrics.metrics.retention?.healthIndicator === 'moderate' ? 'amber' : 'red'}
                    explanation={rrMetrics.metrics.retention?.explanation}
                  />
                  <MetricWithHelp
                    label="Net Growth"
                    value={rrMetrics.metrics.growth?.netChangeInPeriod !== undefined
                      ? (rrMetrics.metrics.growth.netChangeInPeriod > 0 ? '+' : '') + rrMetrics.metrics.growth.netChangeInPeriod
                      : '--'}
                    subValue={`${timeRange === 0 ? 'All-time' : timeRange + '-month'} change`}
                    trendDirection={rrMetrics.metrics.growth?.status === 'growing' ? 'up' :
                                    rrMetrics.metrics.growth?.status === 'declining' ? 'down' : 'stable'}
                    color={rrMetrics.metrics.growth?.status === 'growing' ? 'green' :
                           rrMetrics.metrics.growth?.status === 'declining' ? 'red' : 'slate'}
                    explanation={rrMetrics.metrics.growth?.explanation}
                  />
                  <MetricWithHelp
                    label="Stability"
                    value={rrMetrics.metrics.volatility?.stabilityRating
                      ? rrMetrics.metrics.volatility.stabilityRating.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())
                      : '--'}
                    subValue={rrMetrics.metrics.volatility?.coefficientOfVariation !== undefined
                      ? `${rrMetrics.metrics.volatility.coefficientOfVariation}% variation`
                      : ''}
                    color={rrMetrics.metrics.volatility?.stabilityRating === 'very-stable' ? 'green' :
                           rrMetrics.metrics.volatility?.stabilityRating === 'stable' ? 'blue' :
                           rrMetrics.metrics.volatility?.stabilityRating === 'moderate' ? 'amber' : 'red'}
                    explanation={rrMetrics.metrics.volatility?.explanation}
                  />
                </div>

                {/* Member Type Breakdown */}
                {rrMetrics.summary?.memberBreakdown && (
                  <div className="bg-white rounded-lg border border-slate-200 p-4">
                    <div className="flex items-center gap-2 mb-3">
                      <h4 className="text-sm font-semibold text-slate-700">Member Breakdown</h4>
                      <HelpTooltip position="right">
                        <p className="mb-1">How members are categorized:</p>
                        <ul className="text-[10px] text-slate-300 space-y-0.5">
                          <li>â€¢ <strong>Senior:</strong> SENIOR, FIFTY YEAR, LIFE members</li>
                          <li>â€¢ <strong>Cadet:</strong> Youth members 12-18</li>
                          <li>â€¢ <strong>Cadet Sponsor:</strong> Adults supporting cadet program only</li>
                        </ul>
                        <p className="mt-1 text-slate-300">Operational Total = Senior + Cadet</p>
                      </HelpTooltip>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                      <div className="flex justify-between items-center px-2 py-1 bg-emerald-50 rounded">
                        <span className="text-slate-600">Senior Program</span>
                        <span className="font-bold text-emerald-700">{rrMetrics.summary.memberBreakdown.senior}</span>
                      </div>
                      <div className="flex justify-between items-center px-2 py-1 bg-amber-50 rounded">
                        <span className="text-slate-600">Cadets</span>
                        <span className="font-bold text-amber-700">{rrMetrics.summary.memberBreakdown.cadet}</span>
                      </div>
                      {rrMetrics.summary.memberBreakdown.cadetSponsor > 0 && (
                        <div className="flex justify-between items-center px-2 py-1 bg-blue-50 rounded">
                          <span className="text-slate-600">Cadet Sponsors</span>
                          <span className="font-bold text-blue-700">{rrMetrics.summary.memberBreakdown.cadetSponsor}</span>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Mini Trend Chart */}
                <div className="bg-white rounded-lg border border-slate-200 p-4">
                  <h4 className="text-sm font-semibold text-slate-700 mb-3">Membership Trend</h4>
                  <div className="h-48">
                    <canvas id="chart-recruiting-mini"></canvas>
                  </div>
                </div>
              </div>
            )}

            {!rrMetrics && (
              <div className="text-center py-8 text-slate-500">
                <Icon name="BarChart3" className="w-8 h-8 mx-auto mb-2 text-slate-300" />
                <p>Loading recruiting and retention data...</p>
              </div>
            )}
          </DashboardSection>
        )}

        {/* No Org Stats Data Message */}
        {!hasOrgStatsData && orgStatsService && (
          <div className="bg-slate-50 rounded-xl border border-slate-200 p-6 text-center">
            <Icon name="FileQuestion" className="w-10 h-10 mx-auto mb-3 text-slate-400" />
            <h3 className="font-semibold text-slate-700 mb-1">No Historical Data Available</h3>
            <p className="text-sm text-slate-500">
              Organization statistics data is not available for the selected unit.
            </p>
          </div>
        )}

        {/* Emergency Services Section - Show for all view modes
            For command-only mode, shows ES qualifications of staff assigned to the HQ unit */}
        {esAnalysis && (
          <ESReadinessSection
            esAnalysis={esAnalysis}
            isExpanded={expandedSection === 'emergency-services'}
            onToggle={handleToggleSection}
            onDeepDive={() => setESReadinessModal && setESReadinessModal({ isOpen: true, analysis: esAnalysis })}
          />
        )}

        {/* ES Unit Comparison Table (Aggregate View) */}
        {viewMode === 'aggregate' && sortedESMetrics.length > 0 && expandedSection === 'emergency-services' && (
          <div className="bg-white rounded-lg border border-slate-200 overflow-hidden mt-3">
            <div className="p-3 border-b border-slate-200 bg-emerald-50">
              <div className="flex items-center gap-2">
                <Icon name="Activity" className="w-4 h-4 text-emerald-600" />
                <h4 className="font-semibold text-sm text-emerald-800">ES Readiness by Unit</h4>
                <span className="text-xs text-emerald-600 ml-auto">{sortedESMetrics.length} units</span>
              </div>
            </div>
            <div className="p-3">
              <ESUnitComparisonTable
                unitMetrics={sortedESMetrics}
                getUnitName={getUnitName}
                sortConfig={esTableSortConfig}
                onSort={handleESTableSort}
              />
            </div>
          </div>
        )}

        {/* Quick Navigation Cards (for non-accordion dashboards) */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 pt-2">
          <div className="bg-white border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div className="flex items-center gap-3 mb-2">
              <div className="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center">
                <Icon name="Users" className="w-4 h-4" />
              </div>
              <div className="text-xs uppercase text-slate-500 font-bold">Senior Members</div>
            </div>
            <div className="text-3xl font-bold text-slate-900">{processedData.length}</div>
            <p className="text-sm text-slate-600 mt-1">Promotion-ready, training, and duty coverage.</p>
            <button
              onClick={() => setActiveTab('senior')}
              className="mt-3 text-blue-600 text-sm font-semibold hover:underline"
            >
              Open Senior Dashboard
            </button>
          </div>

          <div className="bg-white border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div className="flex items-center gap-3 mb-2">
              <div className="w-8 h-8 rounded-lg bg-amber-100 text-amber-600 flex items-center justify-center">
                <Icon name="GraduationCap" className="w-4 h-4" />
              </div>
              <div className="text-xs uppercase text-slate-500 font-bold">Cadets</div>
            </div>
            <div className="text-3xl font-bold text-slate-900">{cadetData.length}</div>
            <p className="text-sm text-slate-600 mt-1">Leadership billets, milestones, participation.</p>
            <button
              onClick={() => setActiveTab('cadet')}
              className="mt-3 text-blue-600 text-sm font-semibold hover:underline"
            >
              Open Cadet Dashboard
            </button>
          </div>

          <div className="bg-white border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div className="flex items-center gap-3 mb-2">
              <div className="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center">
                <Icon name="Network" className="w-4 h-4" />
              </div>
              <div className="text-xs uppercase text-slate-500 font-bold">Organization</div>
            </div>
            <div className="text-3xl font-bold text-slate-900">
              {orgChartData ? orgChartData.children.length + 1 : '-'}
            </div>
            <p className="text-sm text-slate-600 mt-1">Visualize the org chart and key billets.</p>
            <button
              onClick={() => setActiveTab('org')}
              className="mt-3 text-blue-600 text-sm font-semibold hover:underline"
            >
              View Org Chart
            </button>
          </div>
        </div>

        {/* Future Sections Placeholder */}
        <div className="mt-4 p-4 bg-slate-50 rounded-lg border border-dashed border-slate-300">
          <div className="flex items-center gap-2 text-slate-500">
            <Icon name="Construction" className="w-5 h-5" />
            <span className="text-sm font-medium">Coming Soon: Training Progress, Upcoming Due Dates</span>
          </div>
        </div>
      </div>
    </div>
  );
}
</script>

<script type="text/babel">
function OrgChartSection(props) {
  // Get OrgNode from window (defined in separate script block)
  const OrgNode = window.OrgNode;

  const {
    orgChartData, expandedSections, setExpandedSections, showCommandChainOnly,
    setShowCommandChainOnly, drillDownPosition, setDrillDownPosition,
    showAllDescendants, toggleExpandCollapse, getAllNodeIds, hideVacant,
    setHideVacant, hasCommittees, showCommittees, setShowCommittees,
    handleDownloadImage, dataFiles, unitFilter, getDescendantOrgIds,
    processedData, buildMemberProfileData, setSelectedMemberProfile
  } = props;

  return (
    <div className="space-y-4">
      <div className="bg-white p-3 sm:p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between sticky top-20 z-40">
        <div className="flex items-center gap-2">
          <Icon name="Network" className="w-5 h-5 text-blue-600" />
          <h2 className="font-bold text-lg text-slate-800 whitespace-nowrap">Organizational Chart</h2>
        </div>
        <div className="flex flex-wrap gap-2 sm:gap-3 md:gap-4 items-center justify-start lg:justify-end w-full">
           <label className="flex items-center space-x-2 text-xs sm:text-sm text-slate-600 font-medium cursor-pointer select-none">
             <input type="checkbox" checked={hideVacant} onChange={e => setHideVacant(e.target.checked)} className="rounded text-blue-600 focus:ring-blue-500" />
             <span>Hide Vacant Positions</span>
           </label>
           <label className="flex items-center space-x-2 text-xs sm:text-sm text-slate-600 font-medium cursor-pointer select-none">
             <input type="checkbox" checked={showCommandChainOnly} onChange={e => setShowCommandChainOnly(e.target.checked)} className="rounded text-blue-600 focus:ring-blue-500" />
             <span>Command Chain Only</span>
           </label>
           <button
             onClick={toggleExpandCollapse}
             className="flex items-center px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 text-xs font-medium transition-colors shadow-sm"
             title="Toggle expand/collapse"
           >
             <Icon name={orgChartData && expandedSections.size === getAllNodeIds(orgChartData).length ? 'ChevronUp' : 'ChevronDown'} className="w-3 h-3 mr-1" />
             {orgChartData && expandedSections.size === getAllNodeIds(orgChartData).length ? 'Collapse All' : 'Expand All'}
           </button>
           {hasCommittees && (
             <button
               onClick={() => setShowCommittees(!showCommittees)}
               className={`flex items-center px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg text-sm font-medium transition-colors shadow-sm ${showCommittees ? 'bg-purple-600 text-white hover:bg-purple-700' : 'bg-white text-purple-600 border border-purple-600 hover:bg-purple-50'}`}
             >
               <Icon name="Users" className="w-4 h-4 mr-2" /> Committees
             </button>
           )}
           <div className="h-6 w-px bg-slate-200"></div>
           <button onClick={() => handleDownloadImage('png')} className="flex items-center px-3 sm:px-4 py-1.5 sm:py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 text-sm font-medium transition-colors shadow-sm">
              <Icon name="Download" className="w-4 h-4 mr-2" /> PNG
            </button>
            <button onClick={() => handleDownloadImage('pdf')} className="flex items-center px-3 sm:px-4 py-1.5 sm:py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors shadow-sm">
              <Icon name="FileText" className="w-4 h-4 mr-2" /> PDF
            </button>
        </div>
      </div>

      {/* Org Chart Container */}
      <div className="relative">
        {/* Committees Overlay Panel */}
        {showCommittees && hasCommittees && (
          <div className="absolute left-2 right-2 sm:left-4 sm:right-auto sm:w-80 top-4 z-50 bg-white rounded-xl border-2 border-purple-300 shadow-2xl max-h-[calc(100vh-200px)] overflow-hidden">
            <div className="flex items-center justify-between gap-2 p-4 bg-gradient-to-r from-purple-50 to-purple-100 border-b border-purple-200">
              <div className="flex items-center gap-2">
                <Icon name="Users" className="w-5 h-5 text-purple-600" />
                <h3 className="font-bold text-base text-slate-800">Committees</h3>
              </div>
              <button
                onClick={() => setShowCommittees(false)}
                className="text-slate-400 hover:text-slate-600 p-1 rounded hover:bg-white/50 transition-colors"
                title="Close"
              >
                <Icon name="X" className="w-5 h-5" />
              </button>
            </div>
            <div className="p-4 space-y-3 overflow-y-auto max-h-[calc(100vh-280px)]">
              {(() => {
                let validOrgIds = [unitFilter];
                if (showAllDescendants) {
                  validOrgIds = getDescendantOrgIds(unitFilter);
                }

                // Determine current org type
                const currentOrg = dataFiles.organization.find(o => o.ORGID === unitFilter);
                const currentType = currentOrg ? (currentOrg.Type || '').toUpperCase() : '';
                const isWingLevel = currentType.includes('WING');
                const isGroupLevel = currentType.includes('GROUP');
                const isSquadronLevel = !isWingLevel && !isGroupLevel;

                // Helper: Get direct children (not all descendants)
                const getDirectChildren = (orgId) => {
                  return dataFiles.organization
                    .filter(o => String(o.NextLevel || '').trim() === String(orgId).trim())
                    .map(o => String(o.ORGID).trim());
                };

                // Helper: Get CAC scope based on current level
                const getCACOrgIds = () => {
                  if (isWingLevel) {
                    // Wing: Include ALL descendants to capture all WCAC members
                    // This ensures Wing CAC reps/assistants from any squadron show up
                    return getDescendantOrgIds(unitFilter);
                  } else if (isGroupLevel) {
                    // Group: Include ALL descendants to capture all GCAC members
                    return getDescendantOrgIds(unitFilter);
                  } else {
                    // Squadron: Include only this squadron to show its members' CAC participation
                    return [unitFilter];
                  }
                };

                const cacOrgIds = getCACOrgIds();
                const unitCommittees = (dataFiles.committees || []).filter(c => validOrgIds.includes(c.ORGID));

                const positionOrder = { CHAIR: 1, VICE: 2, RECORDER: 3, REPRESENTATIVE: 4, ALTERNATE: 5 };
                const getPositionType = (text, isChairFlag = false) => {
                  const t = (text || '').toUpperCase();
                  if ((isChairFlag || t.includes('CHAIR')) && !t.includes('VICE')) return 'CHAIR';
                  if (t.includes('VICE')) return 'VICE';
                  if (t.includes('RECORDER') || t.includes('SECRETARY')) return 'RECORDER';
                  if (t.includes('ASSISTANT') || t.includes('ALTERNATE')) return 'ALTERNATE';
                  return 'REPRESENTATIVE';
                };

                // Group by committee name
                const committeeGroups = {};
                unitCommittees.forEach(c => {
                  let name = c.Committee || 'Unknown Committee';

                  // Normalize Cadet Advisory Council names to match wing/group level
                  const nameUpper = name.toUpperCase();
                  if (nameUpper.includes('CADET ADVISORY COUNCIL')) {
                    if (isWingLevel && !nameUpper.includes('GROUP')) {
                      name = 'Wing Cadet Advisory Council';
                    } else if (isGroupLevel && !nameUpper.includes('WING')) {
                      name = 'Group Cadet Advisory Council';
                    }
                  }

                  if (!committeeGroups[name]) {
                    committeeGroups[name] = [];
                  }
                  const positionType = getPositionType(c.Position || c.Role || c.Title, c.Chair === "1");
                  committeeGroups[name].push({ ...c, positionType, sortOrder: positionOrder[positionType] || 99 });
                });

                // Add CAC members from cadetDuty data
                if (dataFiles.cadetDuty && dataFiles.cadetDuty.length > 0) {
                  const cacDuties = dataFiles.cadetDuty
                    .filter(d => cacOrgIds.includes(d.ORGID))
                    .filter(d => {
                      const dutyUpper = (d.Duty || '').toUpperCase();
                      if (!dutyUpper.includes('CAC')) return false;

                      // Wing level: Only show WCAC duties
                      if (isWingLevel) {
                        return dutyUpper.includes('WCAC');
                      }

                      // Group level: Only show GCAC duties
                      if (isGroupLevel) {
                        return dutyUpper.includes('GCAC');
                      }

                      // Squadron level: Show both WCAC and GCAC for members from this squadron
                      return dutyUpper.includes('WCAC') || dutyUpper.includes('GCAC');
                    });

                  cacDuties.forEach(d => {
                    const dutyUpper = (d.Duty || '').toUpperCase();
                    let committeeName = 'Cadet Advisory Council';

                    // Determine committee name based on duty title
                    if (dutyUpper.includes('WCAC')) {
                      committeeName = 'Wing Cadet Advisory Council';
                    } else if (dutyUpper.includes('GCAC')) {
                      committeeName = 'Group Cadet Advisory Council';
                    }

                    const positionType = getPositionType(dutyUpper, d.Chair === "1");
                    const sortOrder = positionOrder[positionType] || 99;

                    if (!committeeGroups[committeeName]) {
                      committeeGroups[committeeName] = [];
                    }

                    // Check if this member already exists in this committee (avoid duplicates)
                    const existingEntry = committeeGroups[committeeName].find(m => m.CAPID === d.CAPID);
                    if (!existingEntry) {
                      // Add as committee entry
                      committeeGroups[committeeName].push({
                        CAPID: d.CAPID,
                        Chair: positionType === 'CHAIR' ? "1" : "0",
                        Position: positionType,
                        ORGID: d.ORGID,
                        positionType,
                        sortOrder
                      });
                    }
                  });
                }

                return Object.entries(committeeGroups).map(([name, members]) => {
                  // Sort members: Senior advisors first (for CAC), then by position, then by name
                  const isCACCommittee = name.toUpperCase().includes('CADET ADVISORY COUNCIL');
                  const sortedMembers = [...members].sort((a, b) => {
                    // Get member data
                    const memA = dataFiles.members.find(mem => mem.CAPID === a.CAPID);
                    const memB = dataFiles.members.find(mem => mem.CAPID === b.CAPID);

                    // Check if members are senior advisors in CAC
                    if (isCACCommittee && memA && memB) {
                      const isSeniorA = (memA.Type || memA.TYPE) === "SENIOR" || (memA.Type || memA.TYPE) === "LIFE";
                      const isSeniorB = (memB.Type || memB.TYPE) === "SENIOR" || (memB.Type || memB.TYPE) === "LIFE";

                      // Senior advisors always come first in CAC
                      if (isSeniorA && !isSeniorB) return -1;
                      if (!isSeniorA && isSeniorB) return 1;
                    }

                    // Then sort by position order (Chair, Vice, Recorder, etc.)
                    const orderA = a.sortOrder || 99;
                    const orderB = b.sortOrder || 99;
                    if (orderA !== orderB) return orderA - orderB;

                    // Finally sort by name
                    const nameA = memA ? `${memA.NameLast} ${memA.NameFirst}` : '';
                    const nameB = memB ? `${memB.NameLast} ${memB.NameFirst}` : '';
                    return nameA.localeCompare(nameB);
                  });
                  return (
                  <div key={name} className="bg-slate-50 rounded-lg p-3 border border-slate-200 hover:border-purple-300 transition-colors">
                    <div className="font-bold text-xs text-purple-700 mb-2 uppercase tracking-wide">{name}</div>
                    <div className="space-y-1">
                      {sortedMembers.map((m, idx) => {
                        const member = dataFiles.members.find(mem => mem.CAPID === m.CAPID);
                        if (!member) return null;
                        const position = ((m.positionType || m.Position || m.Role || m.Title || '') + '').toUpperCase();
                        const isChair = position.includes('CHAIR') && !position.includes('VICE') || m.Chair === "1";
                        const isViceChair = position.includes('VICE');
                        const isRecorder = position.includes('RECORDER') || position.includes('SECRETARY');
                        const isAlternate = position.includes('ASSISTANT') || position.includes('ALT');

                        // Check if this is a senior member in a Cadet Advisory Council
                        const isSeniorMember = (member.Type || member.TYPE) === "SENIOR" || (member.Type || member.TYPE) === "LIFE";
                        const isCACCommittee = name.toUpperCase().includes('CADET ADVISORY COUNCIL');
                        const isSeniorAdvisor = isSeniorMember && isCACCommittee;

                        return (
                          <div
                            key={idx}
                            className="text-xs text-slate-700 flex items-center justify-between hover:bg-white px-2 py-1.5 rounded cursor-pointer transition-colors"
                            onClick={() => {
                              const foundMember = processedData.find(pm => pm.CAPID === member.CAPID);
                              const fallbackMember = buildMemberProfileData(member);
                              const finalMember = foundMember || fallbackMember;
                              if (finalMember) {
                                setSelectedMemberProfile(finalMember);
                                setShowCommittees(false);
                              }
                            }}
                          >
                            <span className="font-medium">
                              {member.Rank} {member.NameLast}, {member.NameFirst}{isAlternate ? ' (A)' : ''}
                            </span>
                            <div className="flex gap-1">
                              {isSeniorAdvisor && <span className="text-[10px] font-bold text-orange-600 bg-orange-100 px-1.5 py-0.5 rounded">ADVISOR</span>}
                              {(isChair || position.includes('CHAIR')) && <span className="text-[10px] font-bold text-purple-600 bg-purple-100 px-1.5 py-0.5 rounded">CHAIR</span>}
                              {isViceChair && <span className="text-[10px] font-bold text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded">VICE</span>}
                              {isRecorder && <span className="text-[10px] font-bold text-green-600 bg-green-100 px-1.5 py-0.5 rounded">RECORDER</span>}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                  );
                });
              })()}
            </div>
          </div>
        )}

        {/* Org Chart - Full Width */}
        <div className="overflow-x-auto overflow-y-auto pb-6 sm:pb-10 pt-6 sm:pt-10 px-3 sm:px-6 lg:px-10 bg-white rounded-xl border border-slate-200 shadow-inner min-h-[400px] sm:min-h-[600px]" id="org-chart-canvas" style={{background: 'radial-gradient(#e5e7eb 1px, transparent 1px)', backgroundSize: '20px 20px', touchAction: 'pan-x pan-y'}}>
           <div className="inline-block min-w-full">
             {orgChartData ? (
               <div className="flex flex-col items-center">
                   <OrgNode
                    node={orgChartData}
                    hideVacant={hideVacant}
                    expandedSections={expandedSections}
                    setExpandedSections={setExpandedSections}
                    showCommandChainOnly={showCommandChainOnly}
                    onMemberClick={(memberName) => {
                      let cap = null;
                      let displayName = memberName;
                      if (memberName.includes('||')) {
                        const parts = memberName.split('||');
                        displayName = parts[0];
                        cap = parts[1];
                      }
                      if (cap) {
                        const found = processedData.find(m => String(m.CAPID).trim() === String(cap).trim());
                        const fallback = buildMemberProfileData(dataFiles.members.find(m => String(m.CAPID).trim() === String(cap).trim()));
                        if (found || fallback) setSelectedMemberProfile(found || fallback);
                        return;
                      }
                      const nameParts = displayName.split(' ');
                      if (nameParts.length >= 3) {
                        const lastName = nameParts[1].replace(',', '');
                        const firstName = nameParts[2];
                        const member = processedData.find(m =>
                         m.NameLast === lastName && m.NameFirst === firstName
                       );
                       if (member) {
                         setSelectedMemberProfile(member);
                       } else {
                         const rawMember = dataFiles.members.find(m => m.NameLast === lastName && m.NameFirst === firstName);
                         const built = buildMemberProfileData(rawMember);
                         if (built) setSelectedMemberProfile(built);
                       }
                     }
                    }}
        onDrillDown={showAllDescendants ? (node) => setDrillDownPosition(node) : null}
      />
   </div>
 ) : (
               <div className="text-center text-slate-400 mt-20 flex flex-col items-center">
                 <Icon name="Network" className="w-16 h-16 mb-4 opacity-20" />
                 <p>No Organization Data Available</p>
               </div>
             )}
           </div>
        </div>
      </div>
    </div>
  );
}

const PME_COURSE_DEFS = [
  { key: 'ncoa', label: 'NCOA', matches: ({ courseKey, howKey }) => courseKey === 'ncoa' || (howKey.includes('nco academy') && !howKey.includes('senior')) },
  { key: 'sncoa', label: 'SNCOA', matches: ({ courseKey, howKey }) => courseKey === 'sncoa' || howKey.includes('senior nco academy') },
  { key: 'sos', label: 'SOS', matches: ({ courseKey, howKey }) => courseKey === 'sos' || howKey.includes('squadron officer school') },
  { key: 'acsc', label: 'ACSC', matches: ({ courseKey, howKey }) => courseKey === 'acsc' || howKey.includes('air command') || howKey.includes('command and general staff') },
  { key: 'awc', label: 'AWC', matches: ({ courseKey, howKey }) => courseKey === 'awc' || howKey.includes('war college') }
];

const CAP_LEADERSHIP_COURSE_DEFS = [
  { key: 'squadron-command', label: 'Squadron Command', matches: ({ courseKey }) => courseKey.includes('squadron command course') },
  { key: 'group-command', label: 'Group Command', matches: ({ courseKey }) => courseKey.includes('group command course') },
  { key: 'region-command', label: 'Region Command', matches: ({ courseKey }) => courseKey.includes('region command course') },
  { key: 'volu', label: 'VOLU Instructor', matches: ({ courseKey }) => courseKey.includes('volu instructor') }
];

const LEGACY_LEADERSHIP_COURSE_DEFS = [
  { key: 'sls', label: 'SLS', matches: ({ courseKey }) => courseKey === 'sls' },
  { key: 'clc', label: 'CLC', matches: ({ courseKey }) => courseKey === 'clc' },
  { key: 'ucc', label: 'UCC', matches: ({ courseKey }) => courseKey === 'ucc' },
  { key: 'rsc', label: 'RSC', matches: ({ courseKey }) => courseKey === 'rsc' },
  { key: 'nsc', label: 'NSC', matches: ({ courseKey }) => courseKey === 'nsc' },
  { key: 'wcc', label: 'WCC', matches: ({ courseKey }) => courseKey.includes('wing chaplain course') || courseKey === 'wcc' }
];

function FloatingHelpAndModals(props) {
  const {
    showReference, setShowReference, selectedMember, detailLevel,
    setSelectedMember, setDetailLevel, getLevelBreakdown, LEVEL_DISPLAY_MAP,
    promotionMember, setPromotionMember, getPromotionDetails,
    selectedMemberProfile, setSelectedMemberProfile, getMemberEmail,
    dataFiles, drillDownPosition, setDrillDownPosition, unitFilter,
    getDescendantOrgIds, processedData, buildMemberProfileData,
    DUTY_TO_TRACK_MAP, LEVELS, getCadetProtectionStatus, getTlcStatus,
    dataService, activeTab
  } = props;

  const getLevelStatusDisplay = (meta = {}) => {
    const status = meta.status || 'not-started';
    const statusMap = {
      completed: { label: 'Completed', badge: 'bg-emerald-100 text-emerald-700 border-emerald-200', bar: 'bg-emerald-500' },
      pending: { label: 'Submitted', badge: 'bg-amber-100 text-amber-700 border-amber-200', bar: 'bg-amber-500' },
      ready: { label: 'Ready to Submit', badge: 'bg-amber-100 text-amber-700 border-amber-200', bar: 'bg-amber-500' },
      'in-progress': { label: 'In Progress', badge: 'bg-blue-100 text-blue-700 border-blue-200', bar: 'bg-blue-500' },
      'not-started': { label: 'Not Started', badge: 'bg-slate-100 text-slate-600 border-slate-200', bar: 'bg-slate-400' }
    };
    return statusMap[status] || statusMap['not-started'];
  };

  const trainingRecords = React.useMemo(() => {
    if (Array.isArray(dataFiles.training)) return dataFiles.training;
    if (typeof parseCSV === 'function') return parseCSV(dataFiles.training);
    return [];
  }, [dataFiles.training]);

  const trainingCourseIndex = React.useMemo(() => {
    const map = new Map();
    if (!trainingRecords || trainingRecords.length === 0) return map;

    const normalizeText = (value) => String(value || '').trim().replace(/\s+/g, ' ').toLowerCase();
    const parseDateValue = (value) => {
      if (!value) return null;
      const raw = String(value).trim();
      if (!raw || raw === '01/01/1900') return null;
      const parsed = new Date(raw);
      if (Number.isNaN(parsed.getTime())) return null;
      return { raw, date: parsed };
    };
    const getRecordDate = (record) => parseDateValue(record.Completed) || parseDateValue(record.DateMod);
    const upsert = (bucket, key, dateValue) => {
      const current = bucket[key];
      if (!current || dateValue.date > current.date) {
        bucket[key] = dateValue;
      }
    };

    trainingRecords.forEach(record => {
      const capid = String(record.CAPID || '').trim();
      if (!capid) return;
      const courseKey = normalizeText(record.TypeCrs);
      const howKey = normalizeText(record.HowComplete);
      if (!courseKey && !howKey) return;
      const dateValue = getRecordDate(record);
      if (!dateValue) return;
      const bucket = map.get(capid) || { pme: {}, leadership: {}, legacyLeadership: {} };
      const context = { courseKey, howKey };
      PME_COURSE_DEFS.forEach(def => {
        if (def.matches(context)) upsert(bucket.pme, def.key, dateValue);
      });
      CAP_LEADERSHIP_COURSE_DEFS.forEach(def => {
        if (def.matches(context)) upsert(bucket.leadership, def.key, dateValue);
      });
      LEGACY_LEADERSHIP_COURSE_DEFS.forEach(def => {
        if (def.matches(context)) upsert(bucket.legacyLeadership, def.key, dateValue);
      });
      if (!map.has(capid)) map.set(capid, bucket);
    });

    return map;
  }, [trainingRecords]);

  return (
    <>
{/* FLOATING ACTION BUTTON FOR REFERENCE */}
<button 
    onClick={() => setShowReference(true)} 
    className="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-110 z-50"
    title="Help & Reference"
>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
        <line x1="12" y1="17" x2="12.01" y2="17"/>
    </svg>
</button>

{/* All modals are now rendered at app level in Index.html */}
    </>
  );
}
</script>

<script type="text/babel">
function ReportsSection(props) {
  const {
    reportTagFilter, setReportTagFilter, selectedReport, setSelectedReport,
    allReports, processedData, cadetData, reportsCollapsed, setReportsCollapsed,
    availableReportTags, toggleReportTag, formatReportTagLabel, reportTagClasses,
    filteredReports, handleGenerateReport, handleRegenerateReport, handleExportReportPDF,
    handleExportCurrentReportPDF, setSelectedTaskMembers, selectedTaskMembers,
    getMemberEmail, LEVEL_DISPLAY_MAP, setSelectedMemberTaskDetails,
    selectedMemberTaskDetails, isMobile
  } = props;

  // Time range options for recruiting/retention reports
  const timeRangeOptions = [
    { value: 6, label: '6 mo' },
    { value: 12, label: '12 mo' },
    { value: 24, label: '24 mo' },
    { value: 60, label: '5 yr' },
    { value: 0, label: 'All' }
  ];

  const renderRequirementIndicator = (value) => {
    if (value === null || value === undefined) {
      return <span className="text-[10px] font-semibold text-slate-400">N/A</span>;
    }
    return (
      <Icon
        name={value ? 'CheckCircle' : 'Circle'}
        className={`w-4 h-4 mx-auto ${value ? 'text-green-600' : 'text-slate-300'}`}
      />
    );
  };

  return (
    <div className="space-y-4">
    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
      <div className="flex items-start justify-between gap-4 mb-4 flex-wrap">
        <div className="flex items-center gap-3">
          <Icon name="FileText" className="w-6 h-6 text-blue-600" />
          <div>
            <h2 className="font-bold text-2xl text-slate-800">Unit Reports & Analysis</h2>
            <p className="text-sm text-slate-500 mt-1">Generate insights and identify action items for unit improvement</p>
          </div>
        </div>
        <button
          onClick={() => setReportsCollapsed(prev => !prev)}
          className="px-3 py-2 text-sm font-semibold rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 flex items-center gap-2 transition-colors"
        >
          <Icon name={reportsCollapsed ? 'ChevronDown' : 'ChevronUp'} className="w-4 h-4" />
          {reportsCollapsed ? 'Show report catalog' : 'Collapse catalog'}
        </button>
      </div>

      <div className="mt-2 border-t border-slate-100 pt-4">
        <div className="flex items-center justify-between gap-3 flex-wrap">
          <div className="flex items-center gap-2">
            <span className="text-xs font-semibold uppercase text-slate-500">Filter by tag</span>
            {reportTagFilter.length > 0 && (
              <span className="text-[11px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                {reportTagFilter.length} active
              </span>
            )}
          </div>
          <button
            onClick={() => setReportTagFilter([])}
            disabled={reportTagFilter.length === 0}
            className={`px-3 py-1.5 text-sm rounded-lg border transition-colors ${
              reportTagFilter.length === 0
                ? 'border-slate-200 text-slate-300 cursor-not-allowed'
                : 'border-slate-200 text-slate-600 hover:bg-slate-50'
            }`}
          >
            Clear tags
          </button>
        </div>

        <div className="flex flex-wrap gap-2 mt-3">
          {availableReportTags.map(tag => {
            const active = reportTagFilter.includes(tag);
            return (
              <button
                key={tag}
                onClick={() => toggleReportTag(tag)}
                className={`px-3 py-1 rounded-full text-xs font-semibold border transition-colors ${
                  active
                    ? 'bg-slate-900 text-white border-slate-900 shadow-sm'
                    : 'bg-slate-50 text-slate-700 border-slate-200 hover:border-slate-300'
                }`}
              >
                {formatReportTagLabel(tag)}
              </button>
            );
          })}
        </div>
      </div>

      {!reportsCollapsed && (
        <>
          {filteredReports.length ? (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              {filteredReports.map(report => {
                const accentBg = report.accent === 'amber' ? 'from-amber-50' : 'from-blue-50';
                const badgeBg = report.accent === 'amber' ? 'bg-amber-100 text-amber-600' : 'bg-blue-100 text-blue-600';
                return (
                  <div key={report.id} className="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-white">
                    <div className="flex items-start gap-3 mb-3">
                      <div className="w-10 h-10 rounded-lg bg-slate-100 text-slate-600 flex items-center justify-center shrink-0">
                        <Icon name={report.icon} className="w-5 h-5" />
                      </div>
                      <div className="flex-1">
                        <h3 className="font-bold text-lg text-slate-800">{report.title}</h3>
                        <p className="text-xs text-slate-600 mt-1">{report.description}</p>
                        <div className="flex flex-wrap gap-1 mt-2">
                          {report.tags.map(tag => (
                            <span key={`${report.id}-${tag}`} className={`text-[10px] px-2 py-0.5 rounded-full font-semibold ${reportTagClasses[tag] || 'bg-slate-100 text-slate-700 border border-slate-200'}`}>
                              {formatReportTagLabel(tag)}
                            </span>
                          ))}
                        </div>
                      </div>
                    </div>
                    <div className="flex gap-2 mt-3">
                      <button
                        onClick={() => handleGenerateReport(report)}
                        className="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-medium text-sm transition-colors flex items-center justify-center gap-2"
                      >
                        <Icon name="BarChart3" className="w-4 h-4" />
                        Generate
                      </button>
                      <button
                        onClick={() => handleExportReportPDF(report)}
                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-colors flex items-center justify-center gap-2"
                        title="Export to PDF"
                      >
                        <Icon name="Download" className="w-4 h-4" />
                        PDF
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div className="mt-4 border border-dashed border-slate-200 rounded-lg p-6 text-center text-slate-500">
              <Icon name="Filter" className="w-6 h-6 mx-auto mb-2 text-slate-400" />
              <p className="text-sm">No reports match the selected tags. Clear or adjust tags to see more options.</p>
            </div>
          )}
        </>
      )}
    </div>

    {/* Report Display Area */}
    {selectedReport && (
      <div id="report-output" className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
        <div className="flex justify-between items-start mb-4 gap-3">
          <div>
            <h3 className="font-bold text-xl text-slate-800">
              {selectedReport.title || (selectedReport.type === 'training' ? 'Most Needed Training Analysis' : 'Track/Duty Discrepancies')}
            </h3>
            {selectedReport.tags && (
              <div className="flex flex-wrap gap-2 mt-2">
                {selectedReport.tags.map(tag => (
                  <span key={`selected-${tag}`} className={`text-[11px] px-2 py-0.5 rounded-full font-semibold ${reportTagClasses[tag] || 'bg-slate-100 text-slate-700 border border-slate-200'}`}>
                    {formatReportTagLabel(tag)}
                  </span>
                ))}
              </div>
            )}
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={() => handleExportCurrentReportPDF()}
              className="px-3 py-1.5 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2"
            >
              <Icon name="Download" className="w-4 h-4" />
              Export PDF
            </button>
            <button
              onClick={() => setReportsCollapsed(false)}
              className="px-3 py-1.5 text-sm text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-colors"
            >
              Show Report Catalog
            </button>
            <button
              onClick={() => { setSelectedReport(null); setSelectedTaskMembers(null); }}
              className="px-3 py-1.5 text-sm text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors"
            >
              Clear Report
            </button>
          </div>
        </div>

        {selectedReport.type === 'training' && (
          <div>
                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
              <p className="text-sm text-blue-900">
                <strong>Analysis:</strong> Moderated-only ET demand â€” what Volunteer University instructors should teach next. Members are only counted for moderated modules in their current working level/part (lowest incomplete). Level 2 track split is respected, and self-paced/automated modules are excluded since members can complete those online. Click the member count to see names and CAP IDs.
              </p>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">All members have completed all required training!</p>
              </div>
            ) : (
              <div className="space-y-2">
                {selectedReport.data.map((item, idx) => (
                  <div key={idx} className="border border-slate-200 rounded-lg p-4 hover:bg-slate-50 transition-colors">
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex-1">
                        <h4 className="font-bold text-slate-800">{item.taskName}</h4>
                        <p className="text-xs text-slate-500 mt-1">{item.description || 'No description available'}</p>
                        <div className="flex items-center gap-2 mt-2">
                          <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-medium">Level {LEVEL_DISPLAY_MAP[item.level]?.label || item.level}</span>
                          <span className="text-xs bg-slate-100 text-slate-700 px-2 py-0.5 rounded">{item.groupName}</span>
                        </div>
                      </div>
                      <div className="text-right ml-4">
                        <button
                          onClick={() => setSelectedTaskMembers(item)}
                          className="text-2xl font-bold text-blue-600 hover:text-blue-700 hover:underline cursor-pointer transition-colors"
                          title="Click to see member list"
                        >
                          {item.neededByCount}
                        </button>
                        <div className="text-xs text-slate-500">members need</div>
                        <div className="text-xs font-medium text-slate-600 mt-1">{item.percentageOfUnit}% of unit</div>
                        <div className="text-xs font-bold text-blue-700 mt-1">{item.percentageOfLevel}% of Level {LEVEL_DISPLAY_MAP[item.level]?.label || item.level}</div>
                        <div className="text-[10px] text-slate-400">({item.workingOnLevel} working this level)</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {selectedReport.type === 'discrepancies' && (
          <div>
            <div className="bg-amber-50 p-4 rounded-lg border border-amber-200 mb-4">
              <p className="text-sm text-amber-900">
                <strong>Task List:</strong> These members have duty assignments but are missing the required specialty track enrollment.
                Use this as an action list to correct discrepancies in eServices.
              </p>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No track/duty discrepancies found!</p>
              </div>
            ) : (
              <div className="space-y-2">
                {selectedReport.data.map((item, idx) => (
                  <div key={idx} className="border border-amber-200 rounded-lg p-4 hover:bg-amber-50 transition-colors">
                    <div className="flex justify-between items-start">
                      <div>
                        <h4 className="font-bold text-slate-800">{item.memberName}</h4>
                        <p className="text-xs text-slate-500 mt-1">CAPID: {item.capid} - {item.rank}</p>
                        <div className="mt-2 space-y-1">
                          {item.issues.map((issue, issueIdx) => (
                            <div key={issueIdx} className="flex items-start gap-2">
                              <Icon name="AlertCircle" className="w-4 h-4 text-amber-600 mt-0.5 shrink-0" />
                              <div className="text-xs">
                                <span className="font-medium text-amber-800">{issue.duty}</span>
                                <span className="text-slate-600"> requires </span>
                                <span className="font-medium text-blue-700">{issue.requiredTrack}</span>
                                <span className="text-slate-600"> track</span>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="text-right">
                        <span className="inline-block px-2 py-1 bg-amber-100 text-amber-800 rounded text-xs font-bold">
                          {item.issues.length} {item.issues.length === 1 ? 'issue' : 'issues'}
                        </span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {selectedReport.type === 'approval' && (
          <div>
            <div className="bg-green-50 p-4 rounded-lg border border-green-200 mb-4">
              <p className="text-sm text-green-900">
                Members below have completed all modules for a level and need submission/approval (or have a pending/disapproved submission).
              </p>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No levels awaiting approval!</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                    <tr>
                      <th className="px-3 py-2 text-left">Member</th>
                      <th className="px-3 py-2 text-left">CAPID</th>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-left">Level</th>
                      <th className="px-3 py-2 text-left">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {selectedReport.data.map((row, idx) => (
                      <tr key={idx} className="hover:bg-slate-50">
                        <td className="px-3 py-2">
                          <div className="font-bold text-slate-900">{row.memberName}</div>
                          <div className="text-xs text-slate-500">{row.rank}</div>
                        </td>
                        <td className="px-3 py-2 font-mono text-xs text-slate-700">{row.capid}</td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                        <td className="px-3 py-2 text-xs text-slate-800">
                          {row.levelName} (L{row.levelLabel})
                        </td>
                        <td className="px-3 py-2 text-xs font-semibold">
                          <span className={`px-2 py-1 rounded-full border ${row.status.includes('Pending') ? 'bg-amber-50 border-amber-200 text-amber-800' : 'bg-green-50 border-green-200 text-green-800'}`}>
                            {row.status}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {selectedReport.type === 'promotion' && (
          <div>
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
              <p className="text-sm text-blue-900">
                <strong>Promotion Eligibility Report:</strong> Senior members who meet all requirements for promotion to the next rank (Time in Grade, Education & Training Level, and Duty Position requirements).
              </p>
              <p className="text-xs text-blue-800 mt-2">
                <strong>Note:</strong> Lt Cols are excluded from this report as promotion to Col is restricted to those holding wing command positions only.
              </p>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No members currently eligible for promotion!</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                    <tr>
                      <th className="px-3 py-2 text-left">Member</th>
                      <th className="px-3 py-2 text-left">CAPID</th>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-left">Current Rank</th>
                      <th className="px-3 py-2 text-left">Next Rank</th>
                      <th className="px-3 py-2 text-left">TIG</th>
                      <th className="px-3 py-2 text-left">ET Level</th>
                      <th className="px-3 py-2 text-left">Duty Req</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {selectedReport.data.map((row, idx) => (
                      <tr key={idx} className="hover:bg-slate-50">
                        <td className="px-3 py-2">
                          <div className="font-bold text-slate-900">{row.memberName}</div>
                        </td>
                        <td className="px-3 py-2 font-mono text-xs text-slate-700">{row.capid}</td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                        <td className="px-3 py-2">
                          <span className="text-xs font-semibold text-slate-800">{row.rank}</span>
                        </td>
                        <td className="px-3 py-2">
                          <span className="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold">
                            <Icon name="TrendingUp" className="w-3 h-3" />
                            {row.nextRank}
                          </span>
                        </td>
                        <td className="px-3 py-2 text-xs">
                          <div className="flex items-center gap-1">
                            <Icon name="CheckCircle" className="w-3 h-3 text-green-600" />
                            <span className="text-green-700 font-medium">{row.tigMonths}m</span>
                          </div>
                          <div className="text-[10px] text-slate-500">({row.tigRequired}m req)</div>
                        </td>
                        <td className="px-3 py-2 text-xs">
                          <div className="flex items-center gap-1">
                            <Icon name="CheckCircle" className="w-3 h-3 text-green-600" />
                            <span className="text-green-700 font-medium">{row.levelCurrent}</span>
                          </div>
                          <div className="text-[10px] text-slate-500">({row.levelRequired} req)</div>
                        </td>
                        <td className="px-3 py-2 text-xs">
                          <span className={`px-2 py-0.5 rounded ${row.dutyStatus === 'N/A' ? 'bg-slate-100 text-slate-600' : 'bg-green-100 text-green-700'}`}>
                            {row.dutyStatus}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {selectedReport.type === 'near-promotion' && (
          <div>
            <div className="bg-amber-50 p-4 rounded-lg border border-amber-200 mb-4">
              <p className="text-sm text-amber-900">
                <strong>Near Promotion Report:</strong> Senior members who are close to promotion eligibility but not quite there yet. Use this to identify focus areas for training, duty assignments, or members who just need more time in grade.
              </p>
              <div className="mt-2 text-xs text-amber-800">
                <strong>Thresholds:</strong> Within 6 months of TIG requirement, 5 or fewer tasks remaining for required level, or within 6 months of duty time requirement.
              </div>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No members are currently near promotion eligibility!</p>
              </div>
            ) : (
              <div>
                <div className="mb-4 p-3 bg-slate-50 rounded-lg border border-slate-200">
                  <div className="flex items-center gap-2 text-xs text-slate-600">
                    <Icon name="Info" className="w-4 h-4" />
                    <span>Sorted by priority (most urgent first), then by next rank and name. Members are grouped by what's blocking their promotion.</span>
                  </div>
                </div>

                <div className="space-y-2">
                  {selectedReport.data.map((row, idx) => {
                    const isHighPriority = row.priority <= 2;
                    const borderColor = isHighPriority ? 'border-orange-200' : 'border-slate-200';
                    const bgHover = isHighPriority ? 'hover:bg-orange-50' : 'hover:bg-slate-50';

                    return (
                      <div key={idx} className={`border ${borderColor} rounded-lg p-4 ${bgHover} transition-colors`}>
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              <h4 className="font-bold text-slate-900">{row.memberName}</h4>
                              {isHighPriority && (
                                <span className="px-2 py-0.5 bg-orange-100 text-orange-700 text-[10px] font-bold uppercase rounded">High Priority</span>
                              )}
                            </div>
                            <div className="flex items-center gap-3 text-xs text-slate-600">
                              <span className="font-mono">{row.capid}</span>
                              <span>{row.unit}</span>
                              <span className="font-semibold">{row.rank} â†’ {row.nextRank}</span>
                            </div>
                          </div>
                          <div className="text-right">
                            <span className={`inline-block px-2 py-1 rounded text-xs font-bold ${
                              row.category.includes('Near')
                                ? 'bg-orange-100 text-orange-700 border border-orange-200'
                                : 'bg-amber-100 text-amber-700 border border-amber-200'
                            }`}>
                              {row.category}
                            </span>
                          </div>
                        </div>

                        <div className="flex items-start gap-2 mb-3">
                          <Icon name="AlertCircle" className="w-4 h-4 text-amber-600 mt-0.5 shrink-0" />
                          <div className="text-sm text-slate-700">
                            <span className="font-medium">Blocking factors:</span> {row.blockingFactors}
                          </div>
                        </div>

                        <div className="grid grid-cols-3 gap-3 text-xs">
                          <div className={`p-2 rounded ${row.isTigMet ? 'bg-green-50' : row.isNearTIG ? 'bg-orange-50' : 'bg-slate-50'}`}>
                            <div className="flex items-center gap-1 mb-1">
                              <Icon name={row.isTigMet ? 'CheckCircle' : 'Clock'} className={`w-3 h-3 ${row.isTigMet ? 'text-green-600' : row.isNearTIG ? 'text-orange-600' : 'text-slate-400'}`} />
                              <span className="font-bold text-slate-700">Time in Grade</span>
                            </div>
                            <div className={`${row.isTigMet ? 'text-green-700' : row.isNearTIG ? 'text-orange-700' : 'text-slate-600'}`}>
                              {row.tigMonthsCurrent} / {row.tigMonthsRequired} months
                            </div>
                            {!row.isTigMet && (
                              <div className="text-[10px] text-slate-500 mt-0.5">
                                {row.tigMonthsRemaining}m remaining
                              </div>
                            )}
                          </div>

                          <div className={`p-2 rounded ${row.isLevelMet ? 'bg-green-50' : row.isNearLevel ? 'bg-orange-50' : 'bg-slate-50'}`}>
                            <div className="flex items-center gap-1 mb-1">
                              <Icon name={row.isLevelMet ? 'CheckCircle' : 'Book'} className={`w-3 h-3 ${row.isLevelMet ? 'text-green-600' : row.isNearLevel ? 'text-orange-600' : 'text-slate-400'}`} />
                              <span className="font-bold text-slate-700">ET Level</span>
                            </div>
                            <div className={`${row.isLevelMet ? 'text-green-700' : row.isNearLevel ? 'text-orange-700' : 'text-slate-600'}`}>
                              {row.levelCurrent} / {row.levelRequired}
                            </div>
                            {!row.isLevelMet && row.tasksRemaining > 0 && (
                              <button
                                onClick={() => setSelectedMemberTaskDetails({
                                  memberName: row.memberName,
                                  capid: row.capid,
                                  taskDetails: row.taskDetails
                                })}
                                className="text-[10px] text-blue-600 hover:text-blue-800 hover:underline cursor-pointer mt-0.5 font-medium"
                              >
                                {row.tasksRemaining} task{row.tasksRemaining !== 1 ? 's' : ''} left â†’
                              </button>
                            )}
                          </div>

                          <div className={`p-2 rounded ${row.isDutyMet || row.dutyStatus === 'N/A' ? 'bg-green-50' : row.isNearDuty ? 'bg-orange-50' : 'bg-slate-50'}`}>
                            <div className="flex items-center gap-1 mb-1">
                              <Icon name={row.isDutyMet || row.dutyStatus === 'N/A' ? 'CheckCircle' : 'Briefcase'} className={`w-3 h-3 ${row.isDutyMet || row.dutyStatus === 'N/A' ? 'text-green-600' : row.isNearDuty ? 'text-orange-600' : 'text-slate-400'}`} />
                              <span className="font-bold text-slate-700">Duty Req</span>
                            </div>
                            <div className={`text-[11px] ${row.isDutyMet || row.dutyStatus === 'N/A' ? 'text-green-700' : row.isNearDuty ? 'text-orange-700' : 'text-slate-600'}`}>
                              {row.dutyStatus}
                            </div>
                            {!row.isDutyMet && row.dutyMonthsRemaining > 0 && (
                              <div className="text-[10px] text-slate-500 mt-0.5">
                                {row.dutyMonthsRemaining}m remaining
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Cadet Report: No Promotion in 120 Days */}
        {selectedReport.type === 'cadet-no-promotion' && (
          <div>
            <div className="bg-amber-50 p-4 rounded-lg border border-amber-200 mb-4">
              <p className="text-sm text-amber-900">
                <strong>No Promotion Report:</strong> Cadets who have not been promoted in the last 120 days. These cadets may need assistance with achievement requirements or motivation.
              </p>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">All cadets have been promoted within the last 120 days!</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                    <tr>
                      <th className="px-3 py-2 text-left">Cadet Name</th>
                      <th className="px-3 py-2 text-left">CAPID</th>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-left">Current Rank</th>
                      <th className="px-3 py-2 text-left">Last Promotion</th>
                      <th className="px-3 py-2 text-left">Days Since</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {selectedReport.data.map((row, idx) => (
                      <tr key={idx} className="hover:bg-slate-50">
                        <td className="px-3 py-2">
                          <div className="font-bold text-slate-900">{row.memberName}</div>
                        </td>
                        <td className="px-3 py-2 font-mono text-xs text-slate-700">{row.capid}</td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                        <td className="px-3 py-2">
                          <span className="text-xs font-semibold text-slate-800">{row.rank}</span>
                        </td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.lastPromotion}</td>
                        <td className="px-3 py-2">
                          <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-bold ${
                            row.daysSince > 180 ? 'bg-red-100 text-red-800' : 'bg-amber-100 text-amber-800'
                          }`}>
                            {row.daysSince} days
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {selectedReport.type === 'cadet-protection' && (() => {
          const counts = selectedReport.data.reduce((acc, row) => {
            if (row.status === 'Due Soon') acc.dueSoon += 1;
            if (row.status === 'Overdue') acc.overdue += 1;
            if (row.status === 'Missing') acc.missing += 1;
            if ((row.memberType || '').toUpperCase() === 'CADET') acc.cadets += 1;
            else acc.seniors += 1;
            return acc;
          }, { dueSoon: 0, overdue: 0, missing: 0, cadets: 0, seniors: 0 });

          return (
            <div>
              <div className="bg-amber-50 p-4 rounded-lg border border-amber-200 mb-4">
                <p className="text-sm text-amber-900">
                  <strong>Cadet Protection Training Report:</strong> Members who are overdue or due soon on annual Cadet Protection training. Cadets eligible at 17 are flagged as due soon to encourage completion before turning 18.
                </p>
              </div>

              {selectedReport.data.length === 0 ? (
                <div className="text-center py-8 text-slate-400">
                  <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                  <p className="font-medium">All members are current on Cadet Protection training!</p>
                </div>
              ) : (
                <div className="space-y-3">
                  <div className="flex flex-wrap gap-2 text-xs font-semibold">
                    <span className="px-2 py-1 rounded-full bg-amber-100 text-amber-800">Due Soon: {counts.dueSoon}</span>
                    <span className="px-2 py-1 rounded-full bg-rose-100 text-rose-800">Overdue: {counts.overdue}</span>
                    <span className="px-2 py-1 rounded-full bg-rose-100 text-rose-800">Missing: {counts.missing}</span>
                    <span className="px-2 py-1 rounded-full bg-slate-100 text-slate-700">Cadets: {counts.cadets}</span>
                    <span className="px-2 py-1 rounded-full bg-slate-100 text-slate-700">Seniors: {counts.seniors}</span>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                      <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                        <tr>
                          <th className="px-3 py-2 text-left">Member</th>
                          <th className="px-3 py-2 text-left">CAPID</th>
                          <th className="px-3 py-2 text-left">Unit</th>
                          <th className="px-3 py-2 text-left">Type</th>
                          <th className="px-3 py-2 text-left">Rank</th>
                          <th className="px-3 py-2 text-left">Course</th>
                          <th className="px-3 py-2 text-left">Requirement</th>
                          <th className="px-3 py-2 text-left">Status</th>
                          <th className="px-3 py-2 text-left">Last Completed</th>
                          <th className="px-3 py-2 text-left">Expiration</th>
                          <th className="px-3 py-2 text-left">Days</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100">
                        {selectedReport.data.map((row, idx) => {
                          const typeBadge = row.memberType === 'CADET'
                            ? 'bg-blue-100 text-blue-800'
                            : 'bg-purple-100 text-purple-800';
                          const requirementBadge = row.requirement === 'Required'
                            ? 'bg-slate-100 text-slate-700 border border-slate-200'
                            : 'bg-blue-100 text-blue-700 border border-blue-200';
                          const statusBadge = (row.status === 'Overdue' || row.status === 'Missing')
                            ? 'bg-rose-100 text-rose-800 border border-rose-200'
                            : 'bg-amber-100 text-amber-800 border border-amber-200';

                          return (
                            <tr key={idx} className="hover:bg-slate-50">
                              <td className="px-3 py-2">
                                <div className="font-bold text-slate-900">{row.memberName}</div>
                              </td>
                              <td className="px-3 py-2 font-mono text-xs text-slate-700">{row.capid}</td>
                              <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                              <td className="px-3 py-2">
                                <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-semibold ${typeBadge}`}>
                                  {row.memberType}
                                </span>
                              </td>
                              <td className="px-3 py-2 text-xs font-semibold text-slate-800">{row.rank}</td>
                              <td className="px-3 py-2 text-xs text-slate-700">{row.course}</td>
                              <td className="px-3 py-2 text-xs">
                                <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-semibold ${requirementBadge}`}>
                                  {row.requirement}
                                </span>
                              </td>
                              <td className="px-3 py-2 text-xs font-semibold">
                                <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-bold ${statusBadge}`}>
                                  {row.status}
                                </span>
                              </td>
                              <td className="px-3 py-2 text-xs text-slate-700">{row.lastCompleted}</td>
                              <td className="px-3 py-2 text-xs text-slate-700">{row.expiration}</td>
                              <td className="px-3 py-2 text-xs text-slate-700">{row.daysText}</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          );
          })()}

          {selectedReport.type === 'tlc-compliance' && (() => {
            const rows = selectedReport.data || [];
            const requiredCount = selectedReport.meta?.required || 2;
            const isUnitSummary = selectedReport.meta?.view === 'unit-summary';
            const isExemptScope = !!selectedReport.meta?.isExempt;
            const statusStyles = {
              current: 'bg-emerald-100 text-emerald-800 border-emerald-200',
              'due-soon': 'bg-amber-100 text-amber-800 border-amber-200',
              expired: 'bg-rose-100 text-rose-800 border-rose-200',
              missing: 'bg-slate-100 text-slate-700 border-slate-200'
            };

              if (isUnitSummary) {
                const totals = rows.reduce((acc, row) => {
                  acc.units += 1;
                  acc.qualified += row.qualified || 0;
                  acc.current += row.current || 0;
                  acc.dueSoon += row.dueSoon || 0;
                  acc.expired += row.expired || 0;
                  acc.missing += row.missing || 0;
                  acc.totalMembers += row.totalMembers || 0;
                  if (row.complianceStatus === 'compliant') acc.compliant += 1;
                  else if (row.complianceStatus === 'exempt') acc.exempt += 1;
                  else acc.nonCompliant += 1;
                  return acc;
                }, { units: 0, compliant: 0, nonCompliant: 0, exempt: 0, qualified: 0, current: 0, dueSoon: 0, expired: 0, missing: 0, totalMembers: 0 });

              return (
                <div>
                  <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-4">
                    <p className="text-sm text-indigo-900">
                      <strong>TLC Compliance by Unit:</strong> Summary view because sub-units are included. Units meet the requirement with at least {requiredCount} TLC-qualified senior members (Current or Due Soon).
                    </p>
                  </div>

                  {rows.length === 0 ? (
                    <div className="text-center py-8 text-slate-400">
                      <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                      <p className="font-medium">No unit TLC data available for this scope.</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      <div className="flex flex-wrap gap-2 text-xs font-semibold">
                        <span className="px-2 py-1 rounded-full bg-emerald-100 text-emerald-800">Compliant Units: {totals.compliant}</span>
                        <span className="px-2 py-1 rounded-full bg-rose-100 text-rose-800">Needs TLC: {totals.nonCompliant}</span>
                        <span className="px-2 py-1 rounded-full bg-slate-100 text-slate-700">Exempt Units: {totals.exempt}</span>
                        <span className="px-2 py-1 rounded-full bg-blue-100 text-blue-800">Qualified Members: {totals.qualified}</span>
                        <span className="px-2 py-1 rounded-full bg-slate-100 text-slate-700">Units: {totals.units}</span>
                        <span className="px-2 py-1 rounded-full bg-slate-100 text-slate-700">Total Seniors: {totals.totalMembers}</span>
                      </div>

                      <div className="overflow-x-auto">
                        <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                          <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                            <tr>
                              <th className="px-3 py-2 text-left">Unit</th>
                              <th className="px-3 py-2 text-center">Qualified</th>
                              <th className="px-3 py-2 text-center">Required</th>
                              <th className="px-3 py-2 text-center">Status</th>
                              <th className="px-3 py-2 text-center">Current</th>
                              <th className="px-3 py-2 text-center">Due Soon</th>
                              <th className="px-3 py-2 text-center">Expired</th>
                              <th className="px-3 py-2 text-center">Missing</th>
                              <th className="px-3 py-2 text-center">Total Seniors</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-slate-100">
                            {rows.map((row, idx) => {
                              const compliantBadge = row.complianceStatus === 'compliant'
                                ? 'bg-emerald-100 text-emerald-800 border-emerald-200'
                                : row.complianceStatus === 'exempt'
                                  ? 'bg-slate-100 text-slate-700 border-slate-200'
                                  : 'bg-rose-100 text-rose-800 border-rose-200';
                              return (
                                <tr key={idx} className="hover:bg-slate-50">
                                  <td className="px-3 py-2">
                                    <div className="font-bold text-slate-900">{row.unit}</div>
                                  </td>
                                  <td className="px-3 py-2 text-center text-xs font-semibold text-slate-800">{row.qualified}</td>
                                  <td className="px-3 py-2 text-center text-xs text-slate-700">{row.required}</td>
                                  <td className="px-3 py-2 text-center">
                                    <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-bold border ${compliantBadge}`}>
                                      {row.compliance}
                                    </span>
                                  </td>
                                  <td className="px-3 py-2 text-center text-xs text-slate-700">{row.current}</td>
                                  <td className="px-3 py-2 text-center text-xs text-slate-700">{row.dueSoon}</td>
                                  <td className="px-3 py-2 text-center text-xs text-slate-700">{row.expired}</td>
                                  <td className="px-3 py-2 text-center text-xs text-slate-700">{row.missing}</td>
                                  <td className="px-3 py-2 text-center text-xs text-slate-700">{row.totalMembers}</td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              );
            }

            const counts = rows.reduce((acc, row) => {
              const key = row.statusKey || 'missing';
              acc[key] = (acc[key] || 0) + 1;
              if (row.isQualified) acc.qualified += 1;
              return acc;
            }, { current: 0, 'due-soon': 0, expired: 0, missing: 0, qualified: 0 });

              return (
                <div>
                  <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-4">
                    <p className="text-sm text-indigo-900">
                      <strong>TLC Status (Training Leaders of Cadets):</strong> Shows who has and does not have TLC in the selected unit. TLC is counted as qualified when Current or Due Soon.{isExemptScope ? ' This unit is exempt from the TLC compliance threshold.' : ` Unit requirement is ${requiredCount} qualified members.`}
                    </p>
                  </div>

                {rows.length === 0 ? (
                  <div className="text-center py-8 text-slate-400">
                    <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                    <p className="font-medium">No TLC data available for this unit.</p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    <div className="flex flex-wrap gap-2 text-xs font-semibold">
                      <span className="px-2 py-1 rounded-full bg-emerald-100 text-emerald-800">Current: {counts.current}</span>
                      <span className="px-2 py-1 rounded-full bg-amber-100 text-amber-800">Due Soon: {counts['due-soon']}</span>
                      <span className="px-2 py-1 rounded-full bg-rose-100 text-rose-800">Expired: {counts.expired}</span>
                      <span className="px-2 py-1 rounded-full bg-slate-100 text-slate-700">Missing: {counts.missing}</span>
                      {isExemptScope ? (
                        <span className="px-2 py-1 rounded-full bg-slate-100 text-slate-700">Exempt from TLC compliance</span>
                      ) : (
                        <span className="px-2 py-1 rounded-full bg-blue-100 text-blue-800">Qualified: {counts.qualified} / {requiredCount}</span>
                      )}
                    </div>

                    <div className="overflow-x-auto">
                      <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                        <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                          <tr>
                            <th className="px-3 py-2 text-left">Member</th>
                            <th className="px-3 py-2 text-left">CAPID</th>
                            <th className="px-3 py-2 text-left">Unit</th>
                            <th className="px-3 py-2 text-left">Rank</th>
                            <th className="px-3 py-2 text-left">Duties</th>
                            <th className="px-3 py-2 text-left">TLC Course</th>
                            <th className="px-3 py-2 text-left">Status</th>
                            <th className="px-3 py-2 text-left">Completed</th>
                            <th className="px-3 py-2 text-left">Expires</th>
                            <th className="px-3 py-2 text-left">Days</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {rows.map((row, idx) => {
                            const statusBadge = statusStyles[row.statusKey] || statusStyles.missing;
                            return (
                              <tr key={idx} className="hover:bg-slate-50">
                                <td className="px-3 py-2">
                                  <div className="font-bold text-slate-900">{row.memberName}</div>
                                </td>
                                <td className="px-3 py-2 font-mono text-xs text-slate-700">{row.capid}</td>
                                <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                                <td className="px-3 py-2 text-xs font-semibold text-slate-800">{row.rank}</td>
                                <td className="px-3 py-2 text-xs text-slate-600" title={row.dutyFull || row.dutySummary}>{row.dutySummary}</td>
                                <td className="px-3 py-2 text-xs text-slate-700">{row.course}</td>
                                <td className="px-3 py-2 text-xs font-semibold">
                                  <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-bold border ${statusBadge}`}>
                                    {row.status}
                                  </span>
                                </td>
                                <td className="px-3 py-2 text-xs text-slate-700">{row.completed}</td>
                                <td className="px-3 py-2 text-xs text-slate-700">{row.expiration}</td>
                                <td className="px-3 py-2 text-xs text-slate-700">{row.daysText}</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            );
          })()}

          {/* Cadet Report: Membership Lapse */}
          {selectedReport.type === 'membership-lapse' && (
            <div>
            <div className="bg-amber-50 p-4 rounded-lg border border-amber-200 mb-4">
              <p className="text-sm text-amber-900">
                <strong>Membership Expiring Soon:</strong> All members (seniors and cadets) whose membership will expire in 90 days or less. Take action to ensure renewals are processed on time.
              </p>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No memberships expiring in the next 90 days!</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                    <tr>
                      <th className="px-3 py-2 text-left">Member Name</th>
                      <th className="px-3 py-2 text-left">CAPID</th>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-left">Type</th>
                      <th className="px-3 py-2 text-left">Rank</th>
                      <th className="px-3 py-2 text-left">Expiration</th>
                      <th className="px-3 py-2 text-left">Days Remaining</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {selectedReport.data.map((row, idx) => (
                      <tr key={idx} className="hover:bg-slate-50">
                        <td className="px-3 py-2">
                          <div className="font-bold text-slate-900">{row.memberName}</div>
                        </td>
                        <td className="px-3 py-2 font-mono text-xs text-slate-700">{row.capid}</td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                        <td className="px-3 py-2">
                          <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-semibold ${
                            row.memberType === 'CADET' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'
                          }`}>
                            {row.memberType}
                          </span>
                        </td>
                        <td className="px-3 py-2 text-xs font-semibold text-slate-800">{row.rank}</td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.expiration}</td>
                        <td className="px-3 py-2">
                          <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-bold ${
                            row.urgency === 'critical' ? 'bg-red-100 text-red-800' :
                            row.urgency === 'warning' ? 'bg-orange-100 text-orange-800' :
                            'bg-amber-100 text-amber-800'
                          }`}>
                            <Icon name="Clock" className="w-3 h-3 mr-1" />
                            {row.daysUntil} days
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {/* Cadet Report: Aerospace Education */}
        {selectedReport.type === 'aerospace-education' && (
          <div>
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
              <p className="text-sm text-blue-900">
                <strong>Aerospace Education Completion:</strong> Shows all cadets and their completion of the 7 Aerospace Dimensions modules.
                Each module cell is split: left side shows interactive module completion, right side shows written test completion.
              </p>
              <div className="mt-2 flex gap-4 text-xs">
                <div className="flex items-center gap-1">
                  <div className="w-3 h-3 bg-green-500 rounded"></div>
                  <span>Completed</span>
                </div>
                <div className="flex items-center gap-1">
                  <div className="w-3 h-3 bg-slate-200 rounded"></div>
                  <span>Not Started</span>
                </div>
              </div>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="Users" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No cadet data available!</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-xs border border-slate-200 rounded-lg overflow-hidden">
                  <thead className="bg-slate-50">
                    <tr>
                      <th className="px-3 py-2 text-left font-bold text-slate-700 border-r border-slate-200 sticky left-0 bg-slate-50 z-10">
                        Cadet Name
                      </th>
                      <th className="px-3 py-2 text-left font-bold text-slate-700 border-r border-slate-200">CAPID</th>
                      <th className="px-3 py-2 text-left font-bold text-slate-700 border-r border-slate-200">Rank</th>
                      {[1, 2, 3, 4, 5, 6, 7].map(num => (
                        <th key={num} className="px-2 py-2 text-center font-bold text-slate-700 border-r border-slate-200 min-w-[140px]">
                          <div className="text-xs">Module {num}</div>
                          <div className="grid grid-cols-2 gap-px mt-1 text-[10px] font-normal text-slate-500">
                            <div className="text-center">Interactive</div>
                            <div className="text-center">Test</div>
                          </div>
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-200 bg-white">
                    {selectedReport.data.map((row, idx) => (
                      <tr key={idx} className="hover:bg-slate-50">
                        <td className="px-3 py-2 font-semibold text-slate-900 border-r border-slate-200 sticky left-0 bg-white">
                          <div className="whitespace-nowrap">{row.memberName}</div>
                        </td>
                        <td className="px-3 py-2 font-mono text-slate-600 border-r border-slate-200 whitespace-nowrap">
                          {row.capid}
                        </td>
                        <td className="px-3 py-2 text-slate-700 border-r border-slate-200 whitespace-nowrap">
                          {row.rank}
                        </td>
                        {[1, 2, 3, 4, 5, 6, 7].map(num => {
                          const module = row[`module${num}`];
                          return (
                            <td key={num} className="p-0 border-r border-slate-200 relative">
                              {module.honorCredit && (
                                <div className="absolute -top-1 -right-1 z-10 text-yellow-500 text-sm">â­</div>
                              )}
                              <div className="grid grid-cols-2 gap-px min-h-[60px]">
                                {/* Interactive Module (Left) */}
                                <div className={`p-2 flex flex-col justify-center items-center ${
                                  module.interactiveCompleted ? 'bg-green-100' : 'bg-slate-50'
                                }`}>
                                  {module.interactiveCompleted ? (
                                    <>
                                      <div className="text-green-800 font-semibold mb-1">âœ“</div>
                                      {module.interactiveDate && (
                                        <div className="text-[10px] text-green-700 text-center leading-tight">
                                          {module.interactiveDate}
                                        </div>
                                      )}
                                    </>
                                  ) : (
                                    <div className="text-slate-400 text-xl">â€”</div>
                                  )}
                                </div>
                                {/* Written Test (Right) */}
                                <div className={`p-2 flex flex-col justify-center items-center border-l border-slate-200 ${
                                  module.testCompleted ? 'bg-green-100' : 'bg-slate-50'
                                }`}>
                                  {module.testCompleted ? (
                                    <>
                                      <div className="text-green-800 font-bold mb-1">{module.testScore}%</div>
                                      {module.testDate && (
                                        <div className="text-[10px] text-green-700 text-center leading-tight">
                                          {module.testDate}
                                        </div>
                                      )}
                                    </>
                                  ) : (
                                    <div className="text-slate-400 text-xl">â€”</div>
                                  )}
                                </div>
                              </div>
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {/* Cadet Report: Encampment Status */}
        {selectedReport.type === 'encampment-status' && (
          <div>
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
              <p className="text-sm text-blue-900">
                <strong>Encampment Completion Status:</strong> Shows all cadets in the unit and whether they have completed an encampment.
              </p>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="Users" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No cadet data available!</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                    <tr>
                      <th className="px-3 py-2 text-left">Cadet Name</th>
                      <th className="px-3 py-2 text-left">CAPID</th>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-left">Rank</th>
                      <th className="px-3 py-2 text-center">Status</th>
                      <th className="px-3 py-2 text-center">Count</th>
                      <th className="px-3 py-2 text-left">Details</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {selectedReport.data.map((row, idx) => (
                      <tr key={idx} className="hover:bg-slate-50">
                        <td className="px-3 py-2">
                          <div className="font-bold text-slate-900">{row.memberName}</div>
                        </td>
                        <td className="px-3 py-2 font-mono text-xs text-slate-700">{row.capid}</td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                        <td className="px-3 py-2 text-xs font-semibold text-slate-800">{row.rank}</td>
                        <td className="px-3 py-2 text-center">
                          <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-bold ${
                            row.hasEncampment ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-600'
                          }`}>
                            <Icon name={row.hasEncampment ? 'CheckCircle' : 'X'} className="w-3 h-3 mr-1" />
                            {row.hasEncampment ? 'Completed' : 'None'}
                          </span>
                        </td>
                        <td className="px-3 py-2 text-center text-xs font-semibold text-slate-700">
                          {row.count}
                        </td>
                        <td className="px-3 py-2 text-xs text-slate-600">
                          {row.encampments.length > 0 ? (
                            <div className="space-y-1">
                              {row.encampments.slice(0, 2).map((enc, i) => (
                                <div key={i} className="truncate max-w-md">
                                  {enc.type} - {enc.completed}
                                </div>
                              ))}
                              {row.encampments.length > 2 && (
                                <div className="text-blue-600 font-medium">+{row.encampments.length - 2} more</div>
                              )}
                            </div>
                          ) : (
                            <span className="text-slate-400 italic">No encampments</span>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {/* Cadet Report: Orientation Flights Status */}
        {selectedReport.type === 'oflight-status' && (() => {
          const stats = selectedReport.data.reduce((acc, row) => {
            acc.totalCadets += 1;
            if (!row.hasAnyFlight) acc.noFlights += 1;
            if (row.completedSyllabi === 5) acc.allComplete += 1;
            acc.totalPoweredFlights += row.totalPoweredFlights || 0;
            acc.totalBackSeat += row.backSeatRides || 0;
            // Track syllabus completion
            for (let i = 6; i <= 10; i++) {
              if (row[`syllabus${i}`]?.completed) acc[`syl${i}`] = (acc[`syl${i}`] || 0) + 1;
            }
            return acc;
          }, { totalCadets: 0, noFlights: 0, allComplete: 0, totalPoweredFlights: 0, totalBackSeat: 0, syl6: 0, syl7: 0, syl8: 0, syl9: 0, syl10: 0 });

          const participationRate = stats.totalCadets > 0 ? Math.round(((stats.totalCadets - stats.noFlights) / stats.totalCadets) * 100) : 0;
          const completionRate = stats.totalCadets > 0 ? Math.round((stats.allComplete / stats.totalCadets) * 100) : 0;

          return (
          <div>
            <div className="bg-sky-50 p-4 rounded-lg border border-sky-200 mb-4">
              <p className="text-sm text-sky-900">
                <strong>Orientation Flights Status:</strong> Shows powered O-Flight syllabus completion (syllabi 6-10) for all cadets. Cadets with no O-Flights are highlighted at the top of the list.
              </p>
              <div className="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                <div className="flex items-center gap-1">
                  <span className="font-semibold">6:</span> Ground Handling, Preflight, Takeoff & Landing
                </div>
                <div className="flex items-center gap-1">
                  <span className="font-semibold">7:</span> Normal Flight Maneuvers
                </div>
                <div className="flex items-center gap-1">
                  <span className="font-semibold">8:</span> Advanced Flight Maneuvers
                </div>
                <div className="flex items-center gap-1">
                  <span className="font-semibold">9:</span> Use of Instruments in Flight
                </div>
                <div className="flex items-center gap-1">
                  <span className="font-semibold">10:</span> Weather
                </div>
              </div>
            </div>

            {/* Summary Statistics */}
            {selectedReport.data.length > 0 && (
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-4">
                <div className="bg-white border border-slate-200 rounded-lg p-3 text-center">
                  <div className="text-2xl font-bold text-slate-800">{stats.totalCadets}</div>
                  <div className="text-xs text-slate-500">Total Cadets</div>
                </div>
                <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-center">
                  <div className="text-2xl font-bold text-amber-700">{stats.noFlights}</div>
                  <div className="text-xs text-amber-600">No O-Flights</div>
                </div>
                <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3 text-center">
                  <div className="text-2xl font-bold text-emerald-700">{stats.allComplete}</div>
                  <div className="text-xs text-emerald-600">All 5 Complete</div>
                </div>
                <div className="bg-sky-50 border border-sky-200 rounded-lg p-3 text-center">
                  <div className="text-2xl font-bold text-sky-700">{participationRate}%</div>
                  <div className="text-xs text-sky-600">Participation Rate</div>
                </div>
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                  <div className="text-2xl font-bold text-blue-700">{stats.totalPoweredFlights}</div>
                  <div className="text-xs text-blue-600">Total Powered Flights</div>
                </div>
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 text-center">
                  <div className="text-2xl font-bold text-slate-700">{stats.totalBackSeat}</div>
                  <div className="text-xs text-slate-500">Back Seat Rides</div>
                </div>
              </div>
            )}

            {/* Syllabus Breakdown */}
            {selectedReport.data.length > 0 && (
              <div className="bg-white border border-slate-200 rounded-lg p-3 mb-4">
                <div className="text-xs font-semibold text-slate-600 mb-2">Syllabus Completion Breakdown</div>
                <div className="grid grid-cols-5 gap-2">
                  {[6, 7, 8, 9, 10].map(num => {
                    const count = stats[`syl${num}`] || 0;
                    const pct = stats.totalCadets > 0 ? Math.round((count / stats.totalCadets) * 100) : 0;
                    return (
                      <div key={num} className="text-center">
                        <div className="text-lg font-bold text-slate-800">{count}</div>
                        <div className="text-[10px] text-slate-500">Syllabus {num}</div>
                        <div className="w-full bg-slate-200 rounded-full h-1.5 mt-1">
                          <div className="bg-emerald-500 h-1.5 rounded-full" style={{width: `${pct}%`}}></div>
                        </div>
                        <div className="text-[10px] text-slate-400 mt-0.5">{pct}%</div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="Plane" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No cadet data available!</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                    <tr>
                      <th className="px-3 py-2 text-left">Cadet Name</th>
                      <th className="px-3 py-2 text-left">CAPID</th>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-left">Join Date</th>
                      <th className="px-3 py-2 text-center">Age</th>
                      <th className="px-3 py-2 text-center" title="Syllabus 6: Ground Handling, Preflight, Takeoff & Landing">6</th>
                      <th className="px-3 py-2 text-center" title="Syllabus 7: Normal Flight Maneuvers">7</th>
                      <th className="px-3 py-2 text-center" title="Syllabus 8: Advanced Flight Maneuvers">8</th>
                      <th className="px-3 py-2 text-center" title="Syllabus 9: Use of Instruments in Flight">9</th>
                      <th className="px-3 py-2 text-center" title="Syllabus 10: Weather">10</th>
                      <th className="px-3 py-2 text-center">Total</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {selectedReport.data.map((row, idx) => (
                      <tr key={idx} className={`hover:bg-slate-50 ${!row.hasAnyFlight ? 'bg-amber-50' : ''}`}>
                        <td className="px-3 py-2">
                          <div className="flex items-center gap-2">
                            {!row.hasAnyFlight && (
                              <Icon name="AlertCircle" className="w-4 h-4 text-amber-500" title="No O-Flights yet" />
                            )}
                            <span className="font-bold text-slate-900">{row.memberName}</span>
                          </div>
                        </td>
                        <td className="px-3 py-2 font-mono text-xs text-slate-700">{row.capid}</td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                        <td className="px-3 py-2 text-xs text-slate-600">{row.joinDate}</td>
                        <td className="px-3 py-2 text-xs text-slate-600 text-center">{row.age}</td>
                        {[6, 7, 8, 9, 10].map(num => {
                          const data = row[`syllabus${num}`];
                          return (
                            <td key={num} className="px-3 py-2 text-center">
                              {data && data.completed ? (
                                <div className="flex flex-col items-center">
                                  <Icon name="CheckCircle" className="w-5 h-5 text-emerald-500" />
                                  <span className="text-[9px] text-slate-500 mt-0.5">{data.date}</span>
                                </div>
                              ) : (
                                <Icon name="Circle" className="w-5 h-5 text-slate-300 mx-auto" />
                              )}
                            </td>
                          );
                        })}
                        <td className="px-3 py-2 text-center">
                          <div className="flex flex-col items-center">
                            <span className="font-bold text-slate-900">{row.totalPoweredFlights}</span>
                            {row.backSeatRides > 0 && (
                              <span className="text-[9px] text-slate-500">+{row.backSeatRides} back</span>
                            )}
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                <div className="mt-3 flex items-center gap-4 text-xs text-slate-500">
                  <div className="flex items-center gap-1">
                    <div className="w-4 h-4 bg-amber-50 border border-amber-200 rounded"></div>
                    <span>No O-Flights yet</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <Icon name="CheckCircle" className="w-4 h-4 text-emerald-500" />
                    <span>Syllabus completed</span>
                  </div>
                </div>
              </div>
            )}
          </div>
          );
        })()}

        {/* Cadet Report: Recent Promotions */}
        {selectedReport.type === 'recent-promotions' && (
          <div>
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
              <p className="text-sm text-blue-900">
                <strong>Recent Promotions:</strong> Cadets who have been promoted in the past 30 or 60 days. Great for recognition and tracking unit progress.
              </p>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="TrendingUp" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No cadets promoted in the last 60 days!</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                    <tr>
                      <th className="px-3 py-2 text-left">Cadet Name</th>
                      <th className="px-3 py-2 text-left">CAPID</th>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-left">Previous Rank</th>
                      <th className="px-3 py-2 text-left">Current Rank</th>
                      <th className="px-3 py-2 text-left">Promotion Date</th>
                      <th className="px-3 py-2 text-left">Days Ago</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {selectedReport.data.map((row, idx) => (
                      <tr key={idx} className="hover:bg-slate-50">
                        <td className="px-3 py-2">
                          <div className="font-bold text-slate-900">{row.memberName}</div>
                        </td>
                        <td className="px-3 py-2 font-mono text-xs text-slate-700">{row.capid}</td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                        <td className="px-3 py-2 text-xs text-slate-600">{row.previousRank}</td>
                        <td className="px-3 py-2">
                          <span className="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold">
                            <Icon name="TrendingUp" className="w-3 h-3" />
                            {row.currentRank}
                          </span>
                        </td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.rankDate}</td>
                        <td className="px-3 py-2">
                          <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-bold ${
                            row.timeframe === '30-day' ? 'bg-blue-100 text-blue-800' : 'bg-sky-100 text-sky-800'
                          }`}>
                            {row.daysSincePromotion} days
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {/* Cadet Report: Promotion Requirements */}
        {selectedReport.type === 'promotion-requirements' && (
          <div>
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
              <p className="text-sm text-blue-900">
                <strong>Cadet Promotion Requirements:</strong> Comprehensive table showing each cadet's current achievement, next achievement, and progress on promotion requirements.
              </p>
            </div>

            {selectedReport.data.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="Users" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No cadet data available!</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                    <tr>
                      <th className="px-3 py-2 text-left">Cadet Name</th>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-left">Rank</th>
                      <th className="px-3 py-2 text-left">Current Achievement</th>
                      <th className="px-3 py-2 text-left">Next Achievement</th>
                      <th className="px-3 py-2 text-center">Leadership</th>
                      <th className="px-3 py-2 text-center">Aerospace</th>
                      <th className="px-3 py-2 text-center">Fitness</th>
                      <th className="px-3 py-2 text-center">Character</th>
                      <th className="px-3 py-2 text-center">Activity/Special</th>
                      <th className="px-3 py-2 text-center">Progress</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {selectedReport.data.map((row, idx) => (
                      <tr key={idx} className="hover:bg-slate-50">
                        <td className="px-3 py-2">
                          <div className="font-bold text-slate-900">{row.memberName}</div>
                          <div className="font-mono text-xs text-slate-500">{row.capid}</div>
                        </td>
                        <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                        <td className="px-3 py-2 text-xs font-semibold text-slate-800">{row.rank}</td>
                        <td className="px-3 py-2">
                          <div className="text-xs font-semibold text-slate-800">{row.currentAchievement}</div>
                          <div className="text-[10px] text-slate-500">{row.currentPhase}</div>
                        </td>
                        <td className="px-3 py-2">
                          <div className="text-xs font-semibold text-blue-800">{row.nextAchievement}</div>
                          <div className="text-[10px] text-slate-500">{row.nextPhase}</div>
                        </td>
                        <td className="px-3 py-2 text-center">
                          {renderRequirementIndicator(row.leadership)}
                        </td>
                        <td className="px-3 py-2 text-center">
                          {renderRequirementIndicator(row.aerospace)}
                        </td>
                        <td className="px-3 py-2 text-center">
                          {renderRequirementIndicator(row.fitness)}
                        </td>
                        <td className="px-3 py-2 text-center">
                          {renderRequirementIndicator(row.character)}
                        </td>
                        <td className="px-3 py-2 text-center">
                          {renderRequirementIndicator(row.activity)}
                        </td>
                        <td className="px-3 py-2 text-center">
                          <div className="flex flex-col items-center gap-1">
                            <span className="text-xs font-bold text-slate-700">{row.progress}</span>
                            <div className="w-12 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                              <div className={`h-full ${row.percentComplete === 100 ? 'bg-green-500' : 'bg-blue-500'}`} style={{width: `${row.percentComplete}%`}}></div>
                            </div>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {/* Cadet Report: Approaching Age 18 or 21 */}
        {selectedReport.type === 'approaching-age-milestone' && (() => {
          const rows = selectedReport.data || [];
          const stats = rows.reduce((acc, row) => {
            acc.total += 1;
            if (row.milestone === 18) acc.age18 += 1;
            if (row.milestone === 21) acc.age21 += 1;
            if (row.urgency === 'critical') acc.critical += 1;
            if (row.urgency === 'warning') acc.warning += 1;
            return acc;
          }, { total: 0, age18: 0, age21: 0, critical: 0, warning: 0 });

          return (
            <div>
              <div className="bg-amber-50 p-4 rounded-lg border border-amber-200 mb-4">
                <p className="text-sm text-amber-900">
                  <strong>Age Milestone Report:</strong> Cadets approaching significant age milestones within the next 6 months. Use this report to plan for cadet transitions to senior membership (age 18) and cadet program age-outs (age 21).
                </p>
                <div className="mt-2 text-xs text-amber-800">
                  <strong>Key dates:</strong> Age 18 = eligible to become Senior Member | Age 21 = maximum cadet program age
                </div>
              </div>

              {rows.length === 0 ? (
                <div className="text-center py-8 text-slate-400">
                  <Icon name="Calendar" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                  <p className="font-medium">No cadets approaching age 18 or 21 in the next 6 months!</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {/* Summary Statistics */}
                  <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <div className="bg-white border border-slate-200 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold text-slate-800">{stats.total}</div>
                      <div className="text-xs text-slate-500">Total Approaching</div>
                    </div>
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold text-blue-700">{stats.age18}</div>
                      <div className="text-xs text-blue-600">Turning 18</div>
                    </div>
                    <div className="bg-purple-50 border border-purple-200 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold text-purple-700">{stats.age21}</div>
                      <div className="text-xs text-purple-600">Turning 21</div>
                    </div>
                    <div className="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold text-red-700">{stats.critical}</div>
                      <div className="text-xs text-red-600">Within 30 Days</div>
                    </div>
                    <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold text-orange-700">{stats.warning}</div>
                      <div className="text-xs text-orange-600">Within 90 Days</div>
                    </div>
                  </div>

                  {/* Table view */}
                  <div className="overflow-x-auto">
                    <table className="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                      <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                        <tr>
                          <th className="px-3 py-2 text-left">Cadet Name</th>
                          <th className="px-3 py-2 text-left">CAPID</th>
                          <th className="px-3 py-2 text-left">Unit</th>
                          <th className="px-3 py-2 text-left">Rank</th>
                          <th className="px-3 py-2 text-left">DOB</th>
                          <th className="px-3 py-2 text-center">Current Age</th>
                          <th className="px-3 py-2 text-center">Milestone</th>
                          <th className="px-3 py-2 text-left">Milestone Date</th>
                          <th className="px-3 py-2 text-center">Days Until</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100">
                        {rows.map((row, idx) => {
                          const urgencyBadge = {
                            critical: 'bg-red-100 text-red-800 border-red-200',
                            warning: 'bg-orange-100 text-orange-800 border-orange-200',
                            notice: 'bg-blue-100 text-blue-800 border-blue-200'
                          };
                          const milestoneBadge = row.milestone === 18
                            ? 'bg-blue-100 text-blue-800'
                            : 'bg-purple-100 text-purple-800';

                          return (
                            <tr key={idx} className="hover:bg-slate-50">
                              <td className="px-3 py-2">
                                <div className="font-bold text-slate-900">{row.memberName}</div>
                              </td>
                              <td className="px-3 py-2 font-mono text-xs text-slate-700">{row.capid}</td>
                              <td className="px-3 py-2 text-xs text-slate-700">{row.unit}</td>
                              <td className="px-3 py-2 text-xs font-semibold text-slate-800">{row.rank}</td>
                              <td className="px-3 py-2 text-xs text-slate-700">{row.dob}</td>
                              <td className="px-3 py-2 text-center text-xs font-semibold text-slate-800">{row.currentAge}</td>
                              <td className="px-3 py-2 text-center">
                                <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-bold ${milestoneBadge}`}>
                                  {row.milestoneLabel}
                                </span>
                              </td>
                              <td className="px-3 py-2 text-xs text-slate-700">{row.milestoneDate}</td>
                              <td className="px-3 py-2 text-center">
                                <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-bold border ${urgencyBadge[row.urgency]}`}>
                                  {row.daysUntil} days
                                </span>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          );
        })()}

        {/* QCUA (Quality Cadet Unit Award) Report */}
        {selectedReport.type === 'qcua' && (() => {
          const rows = selectedReport.data || [];
          const meta = selectedReport.meta || {};
          const isMultiUnit = meta.view === 'multi-unit';

          const statusBadgeStyles = {
            'On Track': 'bg-emerald-100 text-emerald-800 border-emerald-200',
            'Potentially Eligible': 'bg-amber-100 text-amber-800 border-amber-200',
            'Not On Track': 'bg-rose-100 text-rose-800 border-rose-200',
            'Ineligible (< 10 cadets)': 'bg-slate-100 text-slate-600 border-slate-200'
          };

          const criterionStatusIcon = (criterion) => {
            if (!criterion.trackable) {
              return <Icon name="CircleHelp" className="w-4 h-4 text-slate-400" title="Not trackable in this app" />;
            }
            if (criterion.met === null) {
              return <Icon name="Minus" className="w-4 h-4 text-slate-400" title="N/A" />;
            }
            if (criterion.met) {
              return <Icon name="CheckCircle" className="w-4 h-4 text-emerald-600" />;
            }
            return <Icon name="XCircle" className="w-4 h-4 text-rose-500" />;
          };

          const formatCriterionValue = (criterion) => {
            if (!criterion.trackable) {
              return <span className="text-slate-400 italic text-xs">{criterion.notTrackableReason}</span>;
            }
            if (criterion.noNewCadets) {
              return <span className="text-slate-500 text-xs">No new cadets in cycle</span>;
            }
            if (criterion.isCountBased) {
              return (
                <span className={`text-xs font-semibold ${criterion.met ? 'text-emerald-700' : 'text-rose-600'}`}>
                  {criterion.count} / {criterion.threshold} required
                </span>
              );
            }
            if (criterion.percent !== null) {
              return (
                <div className="flex items-center gap-2">
                  <span className={`text-xs font-semibold ${criterion.met ? 'text-emerald-700' : 'text-rose-600'}`}>
                    {criterion.percent}%
                  </span>
                  <span className="text-xs text-slate-500">({criterion.count}/{criterion.total})</span>
                  <div className="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                    <div
                      className={`h-full ${criterion.percent >= criterion.threshold ? 'bg-emerald-500' : 'bg-rose-400'}`}
                      style={{ width: `${Math.min(criterion.percent, 100)}%` }}
                    />
                  </div>
                </div>
              );
            }
            return <span className="text-slate-400">â€”</span>;
          };

          // Single unit detailed view
          const renderSingleUnit = (unit) => {
            const criteriaOrder = [
              'cadetAchievement', 'encampment', 'enrollment', 'emergencyServices',
              'onboarding', 'orientationFlights', 'tlcGraduates',
              'aerospace', 'localAction', 'stemTeam'
            ];

            return (
              <div key={unit.unitName} className="space-y-4">
                {/* Unit Header */}
                <div className="flex items-center justify-between flex-wrap gap-3">
                  <div>
                    <h4 className="text-lg font-bold text-slate-800">{unit.unitName}</h4>
                    <div className="text-xs text-slate-500 mt-1">
                      {unit.totalCadets} cadets | {unit.totalSeniors} seniors | Cycle: {meta.cycleStart} to {meta.cycleEnd}
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className={`px-3 py-1.5 rounded-lg text-sm font-bold border ${statusBadgeStyles[unit.awardStatus]}`}>
                      {unit.awardStatus}
                    </span>
                    <div className="text-center">
                      <div className="text-2xl font-bold text-slate-800">{unit.criteriaMet}/10</div>
                      <div className="text-[10px] text-slate-500 uppercase">Criteria Met</div>
                    </div>
                  </div>
                </div>

                {/* Eligibility Warning */}
                {!unit.isEligible && (
                  <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                    <div className="flex items-center gap-2 text-amber-800">
                      <Icon name="AlertTriangle" className="w-4 h-4" />
                      <span className="text-sm font-medium">Unit needs at least 10 cadets to be eligible for QCUA</span>
                    </div>
                  </div>
                )}

                {/* Criteria Grid */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {criteriaOrder.map(key => {
                    const criterion = unit.criteria[key];
                    if (!criterion) return null;

                    const bgColor = !criterion.trackable
                      ? 'bg-slate-50 border-slate-200'
                      : criterion.met === null
                        ? 'bg-slate-50 border-slate-200'
                        : criterion.met
                          ? 'bg-emerald-50 border-emerald-200'
                          : 'bg-rose-50 border-rose-200';

                    return (
                      <div key={key} className={`p-3 rounded-lg border ${bgColor}`}>
                        <div className="flex items-start justify-between gap-2">
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              {criterionStatusIcon(criterion)}
                              <span className="font-semibold text-slate-800 text-sm">{criterion.name}</span>
                            </div>
                            <div className="text-xs text-slate-600 mt-1">{criterion.description}</div>
                          </div>
                          <div className="text-right">
                            {formatCriterionValue(criterion)}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Non-trackable notice */}
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 mt-4">
                  <div className="flex items-start gap-2">
                    <Icon name="Info" className="w-4 h-4 text-slate-500 mt-0.5" />
                    <div className="text-xs text-slate-600">
                      <strong>Note:</strong> 3 criteria (Aerospace, Local Action, STEM Team) cannot be tracked in this app due to lack of data in the available downloads.
                      Units showing "Potentially Eligible" may qualify if they meet these manual-verification criteria.
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          // Multi-unit summary table
          const renderMultiUnitSummary = () => {
            const criteriaHeaders = [
              { key: 'cadetAchievement', short: 'WB', title: 'Wright Brothers (45%)' },
              { key: 'encampment', short: 'ENC', title: 'Encampment (50%)' },
              { key: 'enrollment', short: 'ENR', title: 'Enrollment (25+)' },
              { key: 'emergencyServices', short: 'GES', title: 'GES (60%)' },
              { key: 'onboarding', short: 'ONB', title: 'Onboarding (70%)' },
              { key: 'orientationFlights', short: 'OFL', title: 'O-Flights (70%)' },
              { key: 'tlcGraduates', short: 'TLC', title: 'TLC (3+)' }
            ];

            return (
              <div className="space-y-4">
                {/* Summary Stats */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div className="bg-white border border-slate-200 rounded-lg p-3 text-center">
                    <div className="text-2xl font-bold text-slate-800">{meta.totalUnits}</div>
                    <div className="text-xs text-slate-500">Total Units</div>
                  </div>
                  <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3 text-center">
                    <div className="text-2xl font-bold text-emerald-700">{meta.onTrackUnits}</div>
                    <div className="text-xs text-emerald-600">On Track</div>
                  </div>
                  <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-center">
                    <div className="text-2xl font-bold text-amber-700">{rows.filter(r => r.awardStatus === 'Potentially Eligible').length}</div>
                    <div className="text-xs text-amber-600">Potentially Eligible</div>
                  </div>
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                    <div className="text-2xl font-bold text-blue-700">{meta.eligibleUnits}</div>
                    <div className="text-xs text-blue-600">10+ Cadets</div>
                  </div>
                </div>

                {/* Summary Table */}
                <div className="overflow-x-auto">
                  <table className="min-w-full text-xs border border-slate-200 rounded-lg overflow-hidden">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="px-3 py-2 text-left font-bold text-slate-700 border-b border-slate-200">Unit</th>
                        <th className="px-2 py-2 text-center font-bold text-slate-700 border-b border-slate-200">Cadets</th>
                        <th className="px-2 py-2 text-center font-bold text-slate-700 border-b border-slate-200">Status</th>
                        <th className="px-2 py-2 text-center font-bold text-slate-700 border-b border-slate-200">Score</th>
                        {criteriaHeaders.map(h => (
                          <th key={h.key} className="px-2 py-2 text-center font-bold text-slate-600 border-b border-slate-200" title={h.title}>
                            {h.short}
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 bg-white">
                      {rows.map((unit, idx) => (
                        <tr key={idx} className="hover:bg-slate-50">
                          <td className="px-3 py-2 font-semibold text-slate-800 whitespace-nowrap">{unit.unitName}</td>
                          <td className="px-2 py-2 text-center text-slate-600">{unit.totalCadets}</td>
                          <td className="px-2 py-2 text-center">
                            <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold border ${statusBadgeStyles[unit.awardStatus]}`}>
                              {unit.awardStatus === 'Ineligible (< 10 cadets)' ? '<10' : unit.awardStatus.replace('Potentially ', 'Pot. ')}
                            </span>
                          </td>
                          <td className="px-2 py-2 text-center font-bold text-slate-700">{unit.criteriaMet}/10</td>
                          {criteriaHeaders.map(h => {
                            const c = unit.criteria[h.key];
                            return (
                              <td key={h.key} className="px-2 py-2 text-center">
                                {!c.trackable ? (
                                  <span className="text-slate-300">?</span>
                                ) : c.met === null ? (
                                  <span className="text-slate-300">â€”</span>
                                ) : c.met ? (
                                  <Icon name="Check" className="w-3.5 h-3.5 text-emerald-600 mx-auto" />
                                ) : (
                                  <Icon name="X" className="w-3.5 h-3.5 text-rose-500 mx-auto" />
                                )}
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                {/* Legend */}
                <div className="flex flex-wrap gap-4 text-xs text-slate-600 mt-2">
                  <div className="flex items-center gap-1">
                    <Icon name="Check" className="w-3 h-3 text-emerald-600" />
                    <span>Met</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <Icon name="X" className="w-3 h-3 text-rose-500" />
                    <span>Not Met</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <span className="text-slate-400">?</span>
                    <span>Not Trackable</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <span className="text-slate-400">â€”</span>
                    <span>N/A</span>
                  </div>
                </div>

                {/* Criteria Legend */}
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                  <div className="text-xs font-semibold text-slate-700 mb-2">Criteria Key:</div>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-slate-600">
                    {criteriaHeaders.map(h => (
                      <div key={h.key}><strong>{h.short}:</strong> {h.title}</div>
                    ))}
                  </div>
                  <div className="mt-2 text-xs text-slate-500">
                    + 3 non-trackable: Aerospace (AEX/STEM Kit), Local Action (4 events), STEM Team
                  </div>
                </div>
              </div>
            );
          };

          return (
            <div>
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                <p className="text-sm text-blue-900">
                  <strong>Quality Cadet Unit Award (QCUA):</strong> Units with 10+ cadets that meet at least 6 of 10 criteria earn the award.
                  Award cycle: {meta.cycleStart} to {meta.cycleEnd}. This report tracks 7 criteria automatically; 3 require manual verification.
                </p>
              </div>

              {rows.length === 0 ? (
                <div className="text-center py-8 text-slate-400">
                  <Icon name="Award" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                  <p className="font-medium">No unit data available!</p>
                </div>
              ) : isMultiUnit ? (
                renderMultiUnitSummary()
              ) : (
                <div className="space-y-6">
                  {rows.map(unit => renderSingleUnit(unit))}
                </div>
              )}
            </div>
          );
        })()}
      </div>
    )}

    {/* QUA (Quality Unit Award) Report */}
    {selectedReport && selectedReport.type === 'qua' && (() => {
      const rows = selectedReport.data || [];
      const meta = selectedReport.meta || {};
      const isMultiUnit = meta.view === 'multi-unit';

      const statusBadgeStyles = {
        'On Track': 'bg-emerald-100 text-emerald-800 border-emerald-200',
        'Potentially Eligible': 'bg-amber-100 text-amber-800 border-amber-200',
        'Not On Track': 'bg-rose-100 text-rose-800 border-rose-200',
        'Required Criteria Not Met': 'bg-red-100 text-red-800 border-red-200',
        'Not Eligible': 'bg-slate-100 text-slate-600 border-slate-200'
      };

      const criterionStatusIcon = (criterion) => {
        if (!criterion.trackable) {
          return <Icon name="Square" className="w-4 h-4 text-slate-400" title="Manual verification required" />;
        }
        if (criterion.met === null) {
          return <Icon name="CircleHelp" className="w-4 h-4 text-slate-400" title="Data not available" />;
        }
        if (criterion.met) {
          return <Icon name="CheckCircle" className="w-4 h-4 text-emerald-600" />;
        }
        return <Icon name="XCircle" className="w-4 h-4 text-rose-500" />;
      };

      const formatSubCriteria = (subCriteria, criterionKey) => {
        if (!subCriteria) return null;

        // Special handling for Professional Development criteria
        if (criterionKey === 'professionalDevelopment') {
          return (
            <div className="mt-2 space-y-2 text-xs">
              {subCriteria.newLevels && (
                <div className={`p-2 rounded ${subCriteria.newLevels.met ? 'bg-emerald-50' : 'bg-rose-50'}`}>
                  <div className={`flex items-center gap-2 font-medium ${subCriteria.newLevels.met ? 'text-emerald-700' : 'text-rose-600'}`}>
                    {subCriteria.newLevels.met ? <Icon name="Check" className="w-3 h-3" /> : <Icon name="X" className="w-3 h-3" />}
                    <span>New Professional Level Completions (Level II-V)</span>
                  </div>
                  <div className="ml-5 mt-1 text-slate-600">
                    <span className="font-semibold">{subCriteria.newLevels.count}</span> members ({subCriteria.newLevels.percent}%) achieved a new level this FY
                    <span className="text-slate-500 ml-1">(10% required)</span>
                  </div>
                </div>
              )}
              {subCriteria.smPromotion && (
                <div className={`p-2 rounded ${subCriteria.smPromotion.met ? 'bg-emerald-50' : 'bg-rose-50'}`}>
                  <div className={`flex items-center gap-2 font-medium ${subCriteria.smPromotion.met ? 'text-emerald-700' : 'text-rose-600'}`}>
                    {subCriteria.smPromotion.met ? <Icon name="Check" className="w-3 h-3" /> : <Icon name="X" className="w-3 h-3" />}
                    <span>Senior Member Promotion Compliance</span>
                  </div>
                  <div className="ml-5 mt-1 text-slate-600">
                    {subCriteria.smPromotion.met
                      ? 'All SM have been promoted within 1 year of eligibility'
                      : <span><span className="font-semibold text-rose-600">{subCriteria.smPromotion.violations}</span> SM have been eligible for promotion &gt; 1 year without action</span>
                    }
                  </div>
                </div>
              )}
            </div>
          );
        }

        // Default handling for other criteria
        return (
          <div className="mt-2 space-y-1 text-xs">
            {Object.entries(subCriteria).map(([key, sub]) => {
              if (key === 'smPromotion') {
                return (
                  <div key={key} className={`flex items-center gap-2 ${sub.met ? 'text-emerald-700' : 'text-rose-600'}`}>
                    {sub.met ? <Icon name="Check" className="w-3 h-3" /> : <Icon name="X" className="w-3 h-3" />}
                    <span>No SM &gt; 1 year without promotion</span>
                    {sub.violations > 0 && <span className="text-rose-600">({sub.violations} violations)</span>}
                  </div>
                );
              }
              const hasPercent = sub.percent !== undefined;
              const hasCount = sub.count !== undefined;
              return (
                <div key={key} className={`flex items-center gap-2 ${sub.met ? 'text-emerald-700' : 'text-rose-600'}`}>
                  {sub.met ? <Icon name="Check" className="w-3 h-3" /> : <Icon name="X" className="w-3 h-3" />}
                  <span>{sub.name}:</span>
                  {hasPercent && <span className="font-semibold">{sub.percent}%</span>}
                  {hasCount && !hasPercent && <span className="font-semibold">{sub.count}</span>}
                  {sub.threshold && <span className="text-slate-500">({hasPercent ? `${sub.threshold}% req` : `${sub.threshold} req`})</span>}
                </div>
              );
            })}
          </div>
        );
      };

      const formatCriterionValue = (criterion) => {
        if (!criterion.trackable) {
          return <span className="text-slate-400 italic text-xs">{criterion.notTrackableReason || 'Manual verification'}</span>;
        }
        if (criterion.met === null && criterion.notTrackableReason) {
          return <span className="text-slate-400 italic text-xs">{criterion.notTrackableReason}</span>;
        }
        // Retention criterion with growth/retention data
        if (criterion.growth !== undefined || criterion.retention !== undefined) {
          return (
            <div className="text-xs">
              {criterion.growth !== null && (
                <div className={`font-semibold ${criterion.growth >= 5 ? 'text-emerald-700' : 'text-slate-600'}`}>
                  Growth: {criterion.growth}% {criterion.growth >= 5 && <span className="text-emerald-600">(5% met)</span>}
                </div>
              )}
              {criterion.retention !== null && (
                <div className={`font-semibold ${criterion.retention >= 75 ? 'text-emerald-700' : 'text-slate-600'}`}>
                  Retention: {criterion.retention}% {criterion.retention >= 75 && <span className="text-emerald-600">(75% met)</span>}
                </div>
              )}
            </div>
          );
        }
        // Standard percentage-based criterion
        if (criterion.percent !== undefined && criterion.percent !== null) {
          return (
            <div className="flex items-center gap-2">
              <span className={`text-xs font-semibold ${criterion.met ? 'text-emerald-700' : 'text-rose-600'}`}>
                {criterion.percent}%
              </span>
              <span className="text-xs text-slate-500">({criterion.count}/{criterion.total})</span>
              <div className="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                <div
                  className={`h-full ${criterion.percent >= criterion.threshold ? 'bg-emerald-500' : 'bg-rose-400'}`}
                  style={{ width: `${Math.min(criterion.percent, 100)}%` }}
                />
              </div>
            </div>
          );
        }
        // Count-based criterion
        if (criterion.count !== undefined) {
          return (
            <span className={`text-xs font-semibold ${criterion.met ? 'text-emerald-700' : 'text-rose-600'}`}>
              {criterion.count} / {criterion.threshold} required
            </span>
          );
        }
        return <span className="text-slate-400">â€”</span>;
      };

      // Component to render expandable member details table
      const MemberDetailsTable = ({ members, title, showQuals = false, showCourses = false, showActivities = false, showStatus = false, showLevel = false, showReason = false, colorClass = 'border-slate-200' }) => {
        const [expanded, setExpanded] = React.useState(false);
        if (!members || members.length === 0) return null;

        return (
          <div className={`mt-2 border rounded ${colorClass}`}>
            <button
              onClick={() => setExpanded(!expanded)}
              className="w-full flex items-center justify-between px-2 py-1.5 bg-slate-50 hover:bg-slate-100 text-xs font-medium text-slate-700"
            >
              <span>{title} ({members.length})</span>
              <Icon name={expanded ? 'ChevronUp' : 'ChevronDown'} className="w-3 h-3" />
            </button>
            {expanded && (
              <div className="max-h-48 overflow-y-auto">
                <table className="w-full text-xs">
                  <thead className="bg-slate-50 sticky top-0">
                    <tr>
                      <th className="px-2 py-1 text-left font-semibold text-slate-600">Name</th>
                      <th className="px-2 py-1 text-left font-semibold text-slate-600">CAPID</th>
                      <th className="px-2 py-1 text-left font-semibold text-slate-600">Rank</th>
                      {showStatus && <th className="px-2 py-1 text-left font-semibold text-slate-600">Status</th>}
                      {showLevel && <th className="px-2 py-1 text-left font-semibold text-slate-600">Level</th>}
                      {showReason && <th className="px-2 py-1 text-left font-semibold text-slate-600">Details</th>}
                      {showQuals && <th className="px-2 py-1 text-left font-semibold text-slate-600">Qualifications</th>}
                      {showCourses && <th className="px-2 py-1 text-left font-semibold text-slate-600">Courses</th>}
                      {showActivities && <th className="px-2 py-1 text-left font-semibold text-slate-600">Activities</th>}
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {members.map((m, idx) => (
                      <tr key={idx} className="hover:bg-slate-50">
                        <td className="px-2 py-1 text-slate-700">{m.memberName}</td>
                        <td className="px-2 py-1 text-slate-500">{m.capid}</td>
                        <td className="px-2 py-1 text-slate-500">{m.rank}</td>
                        {showStatus && <td className={`px-2 py-1 ${m.status === 'current' || m.status === 'exempt' ? 'text-emerald-600' : m.status === 'due-soon' ? 'text-amber-600' : 'text-rose-600'}`}>{m.status}{m.reason ? ` - ${m.reason}` : ''}</td>}
                        {showLevel && <td className="px-2 py-1 text-slate-600">{m.levelAchieved || 'â€”'}</td>}
                        {showReason && <td className="px-2 py-1 text-slate-600">{m.reason || (m.joinDate ? `Joined: ${m.joinDate}` : 'â€”')}</td>}
                        {showQuals && <td className="px-2 py-1 text-slate-600 max-w-xs truncate" title={m.qualifications?.join(', ') || m.qualName}>{m.qualifications?.join(', ') || m.qualName || 'â€”'}</td>}
                        {showCourses && <td className="px-2 py-1 text-slate-600 max-w-xs truncate" title={m.courses?.join(', ')}>{m.courses?.join(', ') || 'â€”'}</td>}
                        {showActivities && <td className="px-2 py-1 text-slate-600 max-w-xs truncate" title={m.activities?.map(a => a.type).join(', ')}>{m.activities?.map(a => a.type).join(', ') || 'â€”'}</td>}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        );
      };

      // Render retention details with percentages
      const renderRetentionDetails = (criterion) => {
        if (criterion.growth === null && criterion.retention === null) return null;
        return (
          <div className="mt-2 text-xs bg-slate-50 rounded p-2 space-y-1">
            <div className="font-semibold text-slate-700 mb-1">Current Status:</div>
            {criterion.growth !== null && (
              <div className="flex justify-between items-center">
                <span className="text-slate-600">Growth Rate:</span>
                <div className="flex items-center gap-2">
                  <span className={`font-bold ${criterion.growth >= 5 ? 'text-emerald-600' : criterion.growth >= 0 ? 'text-amber-600' : 'text-rose-600'}`}>
                    {criterion.growth >= 0 ? '+' : ''}{criterion.growth}%
                  </span>
                  {criterion.growth >= 5 ? (
                    <span className="text-[10px] px-1.5 py-0.5 bg-emerald-100 text-emerald-700 rounded">5% met</span>
                  ) : (
                    <span className="text-[10px] px-1.5 py-0.5 bg-slate-200 text-slate-600 rounded">5% req</span>
                  )}
                </div>
              </div>
            )}
            {criterion.retention !== null && (
              <div className="flex justify-between items-center">
                <span className="text-slate-600">Retention Rate:</span>
                <div className="flex items-center gap-2">
                  <span className={`font-bold ${criterion.retention >= 75 ? 'text-emerald-600' : criterion.retention >= 60 ? 'text-amber-600' : 'text-rose-600'}`}>
                    {criterion.retention}%
                  </span>
                  {criterion.retention >= 75 ? (
                    <span className="text-[10px] px-1.5 py-0.5 bg-emerald-100 text-emerald-700 rounded">75% met</span>
                  ) : (
                    <span className="text-[10px] px-1.5 py-0.5 bg-slate-200 text-slate-600 rounded">75% req</span>
                  )}
                </div>
              </div>
            )}
            {criterion.startTotal !== null && criterion.currentTotal !== null && (
              <div className="flex justify-between items-center pt-1 border-t border-slate-200 mt-1">
                <span className="text-slate-500">Members:</span>
                <span className="text-slate-600">{criterion.startTotal} â†’ {criterion.currentTotal}</span>
              </div>
            )}
          </div>
        );
      };

      // Render member details for a criterion
      const renderCriterionMemberDetails = (criterion, criterionKey) => {
        const details = [];

        if (criterionKey === 'cadetProtection') {
          if (criterion.compliantMembers?.length > 0) {
            details.push(
              <MemberDetailsTable
                key="compliant"
                members={criterion.compliantMembers}
                title="Compliant Members"
                showStatus={true}
                colorClass="border-emerald-200"
              />
            );
          }
          if (criterion.nonCompliantMembers?.length > 0) {
            details.push(
              <MemberDetailsTable
                key="noncompliant"
                members={criterion.nonCompliantMembers}
                title="Non-Compliant Members"
                showStatus={true}
                colorClass="border-rose-200"
              />
            );
          }
        }

        if (criterionKey === 'professionalDevelopment') {
          if (criterion.completedMembers?.length > 0) {
            details.push(
              <MemberDetailsTable
                key="completed"
                members={criterion.completedMembers}
                title="New Level Completions (FY)"
                showLevel={true}
                colorClass="border-emerald-200"
              />
            );
          }
          if (criterion.subCriteria?.smPromotion?.members?.length > 0) {
            details.push(
              <MemberDetailsTable
                key="smviolation"
                members={criterion.subCriteria.smPromotion.members}
                title="SM Promotion Violations (>1yr)"
                showReason={true}
                colorClass="border-rose-200"
              />
            );
          }
        }

        if (criterionKey === 'retention') {
          details.push(renderRetentionDetails(criterion));
        }

        if (criterionKey === 'encampmentSupport' && criterion.members?.length > 0) {
          details.push(
            <MemberDetailsTable
              key="encampment"
              members={criterion.members}
              title="Encampment Participants"
              showActivities={true}
              colorClass="border-blue-200"
            />
          );
        }

        return details.length > 0 ? <div className="mt-2">{details}</div> : null;
      };

      // Render member details for sub-criteria (ES, Command & Leadership)
      // Note: Skip 'newLevels' and 'smPromotion' for professionalDevelopment - they're already handled by renderCriterionMemberDetails
      const renderSubCriteriaMemberDetails = (subCriteria) => {
        if (!subCriteria) return null;
        const details = [];

        // Keys to skip - these are already rendered elsewhere
        const skipKeys = ['newLevels', 'smPromotion'];

        Object.entries(subCriteria).forEach(([key, sub]) => {
          // Skip keys that are handled separately
          if (skipKeys.includes(key)) return;

          if (sub.members?.length > 0 && sub.name) {
            const showQuals = key === 'ges' || key === 'icut' || key === 'operational';
            const showCourses = key === 'volu';
            details.push(
              <MemberDetailsTable
                key={key}
                members={sub.members}
                title={`${sub.name} Members`}
                showQuals={showQuals}
                showCourses={showCourses}
                colorClass={sub.met ? 'border-emerald-200' : 'border-amber-200'}
              />
            );
          }
        });

        return details.length > 0 ? <div className="mt-2">{details}</div> : null;
      };

      // Single unit detailed view
      const renderSingleUnit = (unit) => {
        const requiredCriteriaOrder = ['cadetProtection', 'professionalDevelopment', 'retention'];
        const missionCriteriaOrder = ['esReadiness', 'commandLeadership', 'encampmentSupport', 'aerospaceEducation', 'communityEngagement', 'flyingExcellence', 'innovationCyber'];

        return (
          <div key={unit.unitName} className="space-y-4">
            {/* Unit Header */}
            <div className="flex items-center justify-between flex-wrap gap-3">
              <div>
                <h4 className="text-lg font-bold text-slate-800">{unit.unitName}</h4>
                <div className="text-xs text-slate-500 mt-1">
                  {unit.unitCategoryLabel} | {unit.totalSeniors} senior members | {meta.fyLabel} ({meta.fyStart} to {meta.fyEnd})
                </div>
              </div>
              <div className="flex items-center gap-3">
                <span className={`px-3 py-1.5 rounded-lg text-sm font-bold border ${statusBadgeStyles[unit.awardStatus]}`}>
                  {unit.awardStatus}
                </span>
                <div className="text-center">
                  <div className="text-2xl font-bold text-slate-800">{unit.criteriaMet}/10</div>
                  <div className="text-[10px] text-slate-500 uppercase">Criteria Met</div>
                </div>
              </div>
            </div>

            {/* Required Criteria Section */}
            <div>
              <div className="flex items-center gap-2 mb-2">
                <Icon name="ShieldCheck" className="w-4 h-4 text-blue-600" />
                <span className="text-sm font-bold text-slate-700">Required Criteria (All Must Be Met)</span>
                {unit.allRequiredMet ? (
                  <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-semibold rounded">All Met</span>
                ) : (
                  <span className="px-2 py-0.5 bg-rose-100 text-rose-700 text-xs font-semibold rounded">Not Met</span>
                )}
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                {requiredCriteriaOrder.map(key => {
                  const criterion = unit.criteria[key];
                  if (!criterion) return null;

                  const bgColor = !criterion.trackable
                    ? 'bg-slate-50 border-slate-200'
                    : criterion.met === null
                      ? 'bg-slate-50 border-slate-200'
                      : criterion.met
                        ? 'bg-emerald-50 border-emerald-200'
                        : 'bg-rose-50 border-rose-200';

                  return (
                    <div key={key} className={`p-3 rounded-lg border ${bgColor}`}>
                      <div className="flex items-start justify-between gap-2">
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            {criterionStatusIcon(criterion)}
                            <span className="font-semibold text-slate-800 text-sm">{criterion.name}</span>
                          </div>
                          <div className="text-xs text-slate-600 mt-1">{criterion.description}</div>
                        </div>
                      </div>
                      <div className="mt-2">
                        {formatCriterionValue(criterion)}
                        {criterion.subCriteria && formatSubCriteria(criterion.subCriteria, key)}
                        {renderCriterionMemberDetails(criterion, key)}
                        {criterion.subCriteria && renderSubCriteriaMemberDetails(criterion.subCriteria)}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Mission-Specific Criteria Section */}
            <div>
              <div className="flex items-center gap-2 mb-2">
                <Icon name="Target" className="w-4 h-4 text-purple-600" />
                <span className="text-sm font-bold text-slate-700">Mission-Specific Criteria (Choose Any 4)</span>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {missionCriteriaOrder.map(key => {
                  const criterion = unit.criteria[key];
                  if (!criterion) return null;

                  const bgColor = !criterion.trackable
                    ? 'bg-slate-50 border-slate-200 border-dashed'
                    : criterion.met === null
                      ? 'bg-slate-50 border-slate-200'
                      : criterion.met
                        ? 'bg-emerald-50 border-emerald-200'
                        : 'bg-rose-50 border-rose-200';

                  return (
                    <div key={key} className={`p-3 rounded-lg border ${bgColor}`}>
                      <div className="flex items-start justify-between gap-2">
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            {criterionStatusIcon(criterion)}
                            <span className="font-semibold text-slate-800 text-sm">{criterion.name}</span>
                            {!criterion.trackable && <span className="text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded">Manual</span>}
                          </div>
                          <div className="text-xs text-slate-600 mt-1">{criterion.description}</div>
                        </div>
                      </div>
                      <div className="mt-2">
                        {formatCriterionValue(criterion)}
                        {criterion.subCriteria && formatSubCriteria(criterion.subCriteria, key)}
                        {renderCriterionMemberDetails(criterion, key)}
                        {criterion.subCriteria && renderSubCriteriaMemberDetails(criterion.subCriteria)}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Non-trackable notice */}
            <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 mt-4">
              <div className="flex items-start gap-2">
                <Icon name="Info" className="w-4 h-4 text-slate-500 mt-0.5" />
                <div className="text-xs text-slate-600">
                  <strong>Note:</strong> 4 criteria (AE Events, Community Engagement, Flying Excellence, Innovation/Cyber) cannot be tracked in this app.
                  Units showing "Potentially Eligible" may qualify if they meet these manual-verification criteria.
                  Check the box mentally for criteria your unit has completed.
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Multi-unit summary table
      const renderMultiUnitSummary = () => {
        const criteriaHeaders = [
          { key: 'cadetProtection', short: 'CP', title: 'Cadet Protection (100%)' },
          { key: 'professionalDevelopment', short: 'PD', title: 'Professional Development' },
          { key: 'retention', short: 'RET', title: 'Retention (5% growth OR 75% retention)' },
          { key: 'esReadiness', short: 'ES', title: 'ES Readiness (50% GES, 25% ICUT, 15% Ops)' },
          { key: 'commandLeadership', short: 'CMD', title: 'Command & Leadership' },
          { key: 'encampmentSupport', short: 'ENC', title: 'Encampment Support (15%)' }
        ];

        return (
          <div className="space-y-4">
            {/* Summary Stats */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div className="bg-white border border-slate-200 rounded-lg p-3 text-center">
                <div className="text-2xl font-bold text-slate-800">{meta.totalUnits}</div>
                <div className="text-xs text-slate-500">Total Units</div>
              </div>
              <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3 text-center">
                <div className="text-2xl font-bold text-emerald-700">{meta.onTrackUnits}</div>
                <div className="text-xs text-emerald-600">On Track</div>
              </div>
              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-center">
                <div className="text-2xl font-bold text-amber-700">{meta.potentialUnits}</div>
                <div className="text-xs text-amber-600">Potentially Eligible</div>
              </div>
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                <div className="text-2xl font-bold text-blue-700">{rows.filter(r => r.allRequiredMet).length}</div>
                <div className="text-xs text-blue-600">Required Met</div>
              </div>
            </div>

            {/* Summary Table */}
            <div className="overflow-x-auto">
              <table className="min-w-full text-xs border border-slate-200 rounded-lg overflow-hidden">
                <thead className="bg-slate-50">
                  <tr>
                    <th className="px-3 py-2 text-left font-bold text-slate-700 border-b border-slate-200">Unit</th>
                    <th className="px-2 py-2 text-center font-bold text-slate-700 border-b border-slate-200">Type</th>
                    <th className="px-2 py-2 text-center font-bold text-slate-700 border-b border-slate-200">Seniors</th>
                    <th className="px-2 py-2 text-center font-bold text-slate-700 border-b border-slate-200">Status</th>
                    <th className="px-2 py-2 text-center font-bold text-slate-700 border-b border-slate-200">Score</th>
                    {criteriaHeaders.map(h => (
                      <th key={h.key} className="px-2 py-2 text-center font-bold text-slate-600 border-b border-slate-200" title={h.title}>
                        {h.short}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-100 bg-white">
                  {rows.map((unit, idx) => (
                    <tr key={idx} className="hover:bg-slate-50">
                      <td className="px-3 py-2 font-semibold text-slate-800 whitespace-nowrap">{unit.unitName}</td>
                      <td className="px-2 py-2 text-center text-slate-600 text-[10px]">{unit.unitCategoryLabel}</td>
                      <td className="px-2 py-2 text-center text-slate-600">{unit.totalSeniors}</td>
                      <td className="px-2 py-2 text-center">
                        <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold border ${statusBadgeStyles[unit.awardStatus]}`}>
                          {unit.awardStatus === 'Required Criteria Not Met' ? 'Req Fail' : unit.awardStatus.replace('Potentially ', 'Pot. ')}
                        </span>
                      </td>
                      <td className="px-2 py-2 text-center font-bold text-slate-700">{unit.criteriaMet}/10</td>
                      {criteriaHeaders.map(h => {
                        const c = unit.criteria[h.key];
                        return (
                          <td key={h.key} className="px-2 py-2 text-center">
                            {!c.trackable ? (
                              <span className="text-slate-300">?</span>
                            ) : c.met === null ? (
                              <span className="text-slate-300">â€”</span>
                            ) : c.met ? (
                              <Icon name="Check" className="w-3.5 h-3.5 text-emerald-600 mx-auto" />
                            ) : (
                              <Icon name="X" className="w-3.5 h-3.5 text-rose-500 mx-auto" />
                            )}
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Legend */}
            <div className="flex flex-wrap gap-4 text-xs text-slate-600 mt-2">
              <div className="flex items-center gap-1">
                <Icon name="Check" className="w-3 h-3 text-emerald-600" />
                <span>Met</span>
              </div>
              <div className="flex items-center gap-1">
                <Icon name="X" className="w-3 h-3 text-rose-500" />
                <span>Not Met</span>
              </div>
              <div className="flex items-center gap-1">
                <span className="text-slate-400">?</span>
                <span>Not Trackable</span>
              </div>
              <div className="flex items-center gap-1">
                <span className="text-slate-400">â€”</span>
                <span>No Data</span>
              </div>
            </div>

            {/* Criteria Legend */}
            <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
              <div className="text-xs font-semibold text-slate-700 mb-2">Criteria Key:</div>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs text-slate-600">
                {criteriaHeaders.map(h => (
                  <div key={h.key}><strong>{h.short}:</strong> {h.title}</div>
                ))}
              </div>
              <div className="mt-2 text-xs text-slate-500">
                + 4 non-trackable: Aerospace Education, Community Engagement, Flying Excellence, Innovation/Cyber
              </div>
            </div>
          </div>
        );
      };

      return (
        <div>
          <div className="bg-emerald-50 p-4 rounded-lg border border-emerald-200 mb-4">
            <p className="text-sm text-emerald-900">
              <strong>Quality Unit Award (QUA):</strong> Great Lakes Region award for Groups, Senior Squadrons, and Composite Squadrons.
              Units must meet 7 of 10 criteria (3 required + 4 mission-specific). Fiscal Year: {meta.fyStart} to {meta.fyEnd}.
              This report tracks 6 criteria automatically; 4 require manual verification.
            </p>
          </div>

          {rows.length === 0 ? (
            <div className="text-center py-8 text-slate-400">
              <Icon name="Award" className="w-16 h-16 mx-auto mb-3 opacity-20" />
              <p className="font-medium">No eligible units found</p>
              <p className="text-xs mt-1">QUA applies to Groups, Senior Squadrons, and Composite Squadrons only</p>
            </div>
          ) : isMultiUnit ? (
            renderMultiUnitSummary()
          ) : (
            <div className="space-y-6">
              {rows.map(unit => renderSingleUnit(unit))}
            </div>
          )}
        </div>
      );
    })()}

    {/* Recruiting Trends Report */}
    {selectedReport && selectedReport.type === 'recruiting-trends' && (() => {
      const meta = selectedReport.meta || {};
      const rows = selectedReport.data || [];

      if (meta.error) {
        return (
          <div className="text-center py-8 text-slate-400">
            <Icon name="AlertCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
            <p className="font-medium">{meta.error}</p>
          </div>
        );
      }

      const trendColor = meta.trend === 'increasing' ? 'text-emerald-600' :
                         meta.trend === 'decreasing' ? 'text-rose-600' : 'text-slate-500';
      const trendIcon = meta.trend === 'increasing' ? 'TrendingUp' :
                        meta.trend === 'decreasing' ? 'TrendingDown' : 'Minus';

      const currentTimeRange = selectedReport.options?.timeRange || meta.timeRange || 12;

      return (
        <div>
          <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
            <div className="flex items-start justify-between gap-4 flex-wrap">
              <div>
                <p className="text-sm text-blue-900">
                  <strong>Recruiting Trends Analysis:</strong> Monthly patterns of new member acquisition including first-time joins and returning members.
                  {meta.isAggregate && ' Showing aggregate data for all subordinate units.'}
                </p>
                <p className="text-xs text-blue-700 mt-1">
                  {meta.dataPoints} data points analyzed
                </p>
              </div>
              <div className="flex items-center gap-1">
                <span className="text-xs font-semibold text-blue-700 mr-2">Time Range:</span>
                {timeRangeOptions.map(opt => (
                  <button
                    key={opt.value}
                    onClick={() => handleRegenerateReport({ timeRange: opt.value })}
                    className={`px-2 py-1 text-xs font-semibold rounded transition-colors ${
                      currentTimeRange === opt.value
                        ? 'bg-blue-600 text-white'
                        : 'bg-white text-blue-700 border border-blue-300 hover:bg-blue-100'
                    }`}
                  >
                    {opt.label}
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* Summary Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div className="bg-white border border-slate-200 rounded-lg p-4">
              <div className="text-[10px] uppercase text-slate-500 font-bold mb-1">Total Recruited</div>
              <div className="text-2xl font-bold text-slate-800">{meta.totalRecruited}</div>
              <div className="text-xs text-slate-500">in period</div>
            </div>
            <div className="bg-white border border-slate-200 rounded-lg p-4">
              <div className="text-[10px] uppercase text-slate-500 font-bold mb-1">Monthly Avg</div>
              <div className="text-2xl font-bold text-slate-800">{meta.monthlyAverage}</div>
              <div className={`text-xs flex items-center gap-1 ${trendColor}`}>
                <Icon name={trendIcon} className="w-3 h-3" />
                {meta.trendPercent > 0 ? '+' : ''}{meta.trendPercent}% vs prior
              </div>
            </div>
            <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
              <div className="text-[10px] uppercase text-emerald-700 font-bold mb-1">New Members</div>
              <div className="text-xl font-bold text-emerald-800">{meta.newTotal}</div>
              <div className="text-xs text-emerald-600">{meta.totalRecruited > 0 ? Math.round((meta.newTotal / meta.totalRecruited) * 100) : 0}% of total</div>
            </div>
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div className="text-[10px] uppercase text-blue-700 font-bold mb-1">Rejoins</div>
              <div className="text-xl font-bold text-blue-800">{meta.rejoinTotal}</div>
              <div className="text-xs text-blue-600">{meta.totalRecruited > 0 ? Math.round((meta.rejoinTotal / meta.totalRecruited) * 100) : 0}% of total</div>
            </div>
          </div>

          {/* Member Type Breakdown */}
          <div className="grid grid-cols-2 gap-3 mb-6">
            <div className="bg-white border border-slate-200 rounded-lg p-4">
              <div className="text-[10px] uppercase text-slate-500 font-bold mb-2">Senior Members</div>
              <div className="text-xl font-bold text-slate-800">{meta.seniorTotal}</div>
              <div className="text-xs text-slate-500">recruited in period</div>
            </div>
            <div className="bg-white border border-slate-200 rounded-lg p-4">
              <div className="text-[10px] uppercase text-slate-500 font-bold mb-2">Cadets</div>
              <div className="text-xl font-bold text-slate-800">{meta.cadetTotal}</div>
              <div className="text-xs text-slate-500">recruited in period</div>
            </div>
          </div>

          {/* Seasonality */}
          {meta.seasonality && (
            <div className="bg-white border border-slate-200 rounded-lg p-4 mb-6">
              <div className="text-sm font-semibold text-slate-700 mb-3">Seasonal Patterns</div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="text-xs text-emerald-700 font-semibold mb-1">Peak Recruiting Months</div>
                  <div className="flex gap-2">
                    {meta.seasonality.peakMonths.map(m => (
                      <span key={m} className="px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs font-medium">{m}</span>
                    ))}
                  </div>
                </div>
                <div>
                  <div className="text-xs text-rose-700 font-semibold mb-1">Low Recruiting Months</div>
                  <div className="flex gap-2">
                    {meta.seasonality.lowMonths.map(m => (
                      <span key={m} className="px-2 py-1 bg-rose-100 text-rose-700 rounded text-xs font-medium">{m}</span>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Subordinate Unit Breakdown (aggregate mode) */}
          {meta.isAggregate && meta.unitBreakdown && meta.unitBreakdown.length > 0 && (
            <div className="bg-white border border-slate-200 rounded-lg p-4 mb-6">
              <div className="text-sm font-semibold text-slate-700 mb-3">Unit Recruiting Rates</div>
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500">
                    <tr>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-right">Members</th>
                      <th className="px-3 py-2 text-right">Avg/Month</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {meta.unitBreakdown.slice(0, 10).map((unit, idx) => (
                      <tr key={unit.orgId} className="hover:bg-slate-50">
                        <td className="px-3 py-2 font-medium text-slate-800">{unit.unitName}</td>
                        <td className="px-3 py-2 text-right text-slate-600">{unit.currentTotal}</td>
                        <td className="px-3 py-2 text-right font-semibold text-slate-800">{unit.recruitingRate || '--'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Monthly Breakdown Table */}
          <div className="bg-white border border-slate-200 rounded-lg overflow-hidden">
            <div className="p-3 border-b border-slate-200 bg-slate-50">
              <div className="text-sm font-semibold text-slate-700">Monthly Breakdown</div>
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-50 text-xs uppercase text-slate-500 border-b border-slate-200">
                  <tr>
                    <th className="px-3 py-2 text-left">Month</th>
                    <th className="px-3 py-2 text-right">New</th>
                    <th className="px-3 py-2 text-right">Rejoin</th>
                    <th className="px-3 py-2 text-right">Total</th>
                    <th className="px-3 py-2 text-right">Members</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-100">
                  {rows.slice(0, 24).map((row, idx) => (
                    <tr key={idx} className="hover:bg-slate-50">
                      <td className="px-3 py-2 font-medium text-slate-800">{row.month}</td>
                      <td className="px-3 py-2 text-right text-emerald-600">{row.totalNew || 0}</td>
                      <td className="px-3 py-2 text-right text-blue-600">{row.totalRejoin || 0}</td>
                      <td className="px-3 py-2 text-right font-semibold text-slate-800">{row.totalRecruited || 0}</td>
                      <td className="px-3 py-2 text-right text-slate-500">{row.totalMembers || 0}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    })()}

    {/* Retention Analysis Report */}
    {selectedReport && selectedReport.type === 'retention-analysis' && (() => {
      const meta = selectedReport.meta || {};
      const rows = selectedReport.data || [];

      if (meta.error) {
        return (
          <div className="text-center py-8 text-slate-400">
            <Icon name="AlertCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
            <p className="font-medium">{meta.error}</p>
          </div>
        );
      }

      const healthColor = meta.healthIndicator === 'healthy' ? 'bg-emerald-100 text-emerald-800 border-emerald-200' :
                          meta.healthIndicator === 'moderate' ? 'bg-amber-100 text-amber-800 border-amber-200' :
                          meta.healthIndicator === 'at-risk' ? 'bg-rose-100 text-rose-800 border-rose-200' :
                          'bg-slate-100 text-slate-600 border-slate-200';
      const healthLabel = meta.healthIndicator === 'healthy' ? 'Healthy' :
                          meta.healthIndicator === 'moderate' ? 'Moderate' :
                          meta.healthIndicator === 'at-risk' ? 'At Risk' : 'Unknown';

      const growthColor = meta.growthStatus === 'growing' ? 'text-emerald-600' :
                          meta.growthStatus === 'declining' ? 'text-rose-600' : 'text-slate-500';
      const growthIcon = meta.growthStatus === 'growing' ? 'TrendingUp' :
                         meta.growthStatus === 'declining' ? 'TrendingDown' : 'Minus';

      const currentTimeRange = selectedReport.options?.timeRange || meta.timeRange || 12;

      return (
        <div>
          <div className="bg-amber-50 p-4 rounded-lg border border-amber-200 mb-4">
            <div className="flex items-start justify-between gap-4 flex-wrap">
              <div>
                <p className="text-sm text-amber-900">
                  <strong>Retention & Renewal Analysis:</strong> Tracks renewal rates, attrition patterns, and identifies members approaching membership expiration.
                  {meta.isAggregate && ' Showing aggregate data for all subordinate units.'}
                </p>
              </div>
              <div className="flex items-center gap-1">
                <span className="text-xs font-semibold text-amber-700 mr-2">Time Range:</span>
                {timeRangeOptions.map(opt => (
                  <button
                    key={opt.value}
                    onClick={() => handleRegenerateReport({ timeRange: opt.value })}
                    className={`px-2 py-1 text-xs font-semibold rounded transition-colors ${
                      currentTimeRange === opt.value
                        ? 'bg-amber-600 text-white'
                        : 'bg-white text-amber-700 border border-amber-300 hover:bg-amber-100'
                    }`}
                  >
                    {opt.label}
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* Health Status Banner */}
          <div className={`flex items-center justify-between p-4 rounded-lg border mb-6 ${healthColor}`}>
            <div className="flex items-center gap-3">
              <Icon name={meta.healthIndicator === 'healthy' ? 'CheckCircle' : meta.healthIndicator === 'at-risk' ? 'AlertTriangle' : 'AlertCircle'} className="w-6 h-6" />
              <div>
                <div className="font-bold text-lg">Retention Rate: {meta.retentionRate !== null ? `${meta.retentionRate}%` : '--'}</div>
                <div className="text-sm opacity-80">Status: {healthLabel}</div>
              </div>
            </div>
            <div className={`px-3 py-1.5 rounded-full font-bold text-sm border ${healthColor}`}>
              {healthLabel}
            </div>
          </div>

          {/* Summary Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div className="bg-white border border-slate-200 rounded-lg p-4">
              <div className="text-[10px] uppercase text-slate-500 font-bold mb-1">Current Members</div>
              <div className="text-2xl font-bold text-slate-800">{meta.currentTotal}</div>
              {meta.memberBreakdown && (
                <div className="text-xs text-slate-500">
                  {meta.memberBreakdown.senior} Sr / {meta.memberBreakdown.cadet} Cdt
                </div>
              )}
            </div>
            <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
              <div className="text-[10px] uppercase text-emerald-700 font-bold mb-1">Renewals</div>
              <div className="text-xl font-bold text-emerald-800">{meta.renewalsInPeriod}</div>
              <div className="text-xs text-emerald-600">in period</div>
            </div>
            <div className="bg-rose-50 border border-rose-200 rounded-lg p-4">
              <div className="text-[10px] uppercase text-rose-700 font-bold mb-1">Est. Attrition</div>
              <div className="text-xl font-bold text-rose-800">{meta.estimatedAttrition}</div>
              <div className="text-xs text-rose-600">{meta.annualizedAttritionRate !== null ? `${meta.annualizedAttritionRate}%/yr` : ''}</div>
            </div>
            <div className="bg-white border border-slate-200 rounded-lg p-4">
              <div className="text-[10px] uppercase text-slate-500 font-bold mb-1">Net Change</div>
              <div className={`text-xl font-bold flex items-center gap-1 ${growthColor}`}>
                <Icon name={growthIcon} className="w-5 h-5" />
                {meta.netChange > 0 ? '+' : ''}{meta.netChange}
              </div>
              <div className="text-xs text-slate-500 capitalize">{meta.growthStatus}</div>
            </div>
          </div>

          {/* Subordinate Unit Breakdown (aggregate mode) */}
          {meta.isAggregate && meta.unitBreakdown && meta.unitBreakdown.length > 0 && (
            <div className="bg-white border border-slate-200 rounded-lg p-4 mb-6">
              <div className="text-sm font-semibold text-slate-700 mb-3">Unit Retention Rates</div>
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500">
                    <tr>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-right">Members</th>
                      <th className="px-3 py-2 text-right">Retention</th>
                      <th className="px-3 py-2 text-right">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {meta.unitBreakdown.slice(0, 10).map((unit, idx) => (
                      <tr key={unit.orgId} className="hover:bg-slate-50">
                        <td className="px-3 py-2 font-medium text-slate-800">{unit.unitName}</td>
                        <td className="px-3 py-2 text-right text-slate-600">{unit.currentTotal}</td>
                        <td className="px-3 py-2 text-right font-semibold">
                          <span className={unit.retentionRate >= 80 ? 'text-emerald-600' : unit.retentionRate >= 60 ? 'text-amber-600' : 'text-rose-600'}>
                            {unit.retentionRate !== null ? `${unit.retentionRate}%` : '--'}
                          </span>
                        </td>
                        <td className="px-3 py-2 text-right">
                          <span className={`text-xs font-medium ${unit.growthStatus === 'growing' ? 'text-emerald-600' : unit.growthStatus === 'declining' ? 'text-rose-600' : 'text-slate-500'}`}>
                            {unit.growthStatus}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Members Due for Renewal */}
          <div className="bg-white border border-slate-200 rounded-lg overflow-hidden mb-6">
            <div className="p-3 border-b border-slate-200 bg-amber-50">
              <div className="flex items-center justify-between">
                <div className="text-sm font-semibold text-amber-800">Members Due for Renewal</div>
                <div className="flex gap-2 text-xs">
                  <span className="px-2 py-0.5 bg-rose-100 text-rose-700 rounded">{meta.expiringIn30Days} in 30 days</span>
                  <span className="px-2 py-0.5 bg-amber-100 text-amber-700 rounded">{meta.expiringIn60Days} in 60 days</span>
                  <span className="px-2 py-0.5 bg-slate-100 text-slate-600 rounded">{meta.expiringIn90Days} in 90 days</span>
                </div>
              </div>
            </div>
            {rows.length === 0 ? (
              <div className="text-center py-8 text-slate-400">
                <Icon name="CheckCircle" className="w-12 h-12 mx-auto mb-2 opacity-20" />
                <p className="font-medium">No members expiring in the next 90 days!</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead className="bg-slate-50 text-xs uppercase text-slate-500 border-b border-slate-200">
                    <tr>
                      <th className="px-3 py-2 text-left">Member</th>
                      <th className="px-3 py-2 text-left">CAPID</th>
                      <th className="px-3 py-2 text-left">Type</th>
                      <th className="px-3 py-2 text-left">Unit</th>
                      <th className="px-3 py-2 text-right">Expires</th>
                      <th className="px-3 py-2 text-right">Days</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {rows.map((member, idx) => (
                      <tr key={idx} className={`hover:bg-slate-50 ${member.urgency === 'critical' ? 'bg-rose-50' : member.urgency === 'warning' ? 'bg-amber-50' : ''}`}>
                        <td className="px-3 py-2">
                          <div className="font-medium text-slate-800">{member.memberName}</div>
                          <div className="text-xs text-slate-500">{member.rank}</div>
                        </td>
                        <td className="px-3 py-2 font-mono text-xs text-slate-600">{member.capid}</td>
                        <td className="px-3 py-2 text-xs">
                          <span className={`px-2 py-0.5 rounded ${member.memberType === 'Cadet' ? 'bg-sky-100 text-sky-700' : 'bg-blue-100 text-blue-700'}`}>
                            {member.memberType}
                          </span>
                        </td>
                        <td className="px-3 py-2 text-xs text-slate-600">{member.unit}</td>
                        <td className="px-3 py-2 text-right text-xs text-slate-600">{member.expiration}</td>
                        <td className="px-3 py-2 text-right">
                          <span className={`font-bold ${member.urgency === 'critical' ? 'text-rose-600' : member.urgency === 'warning' ? 'text-amber-600' : 'text-slate-600'}`}>
                            {member.daysUntil}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      );
    })()}

    {/* Member List Modal */}
    {selectedTaskMembers && (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" onClick={() => setSelectedTaskMembers(null)}>
    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
      <div className="flex justify-between items-center p-6 border-b border-slate-200">
        <div>
          <h2 className="text-xl font-bold text-slate-900">{selectedTaskMembers.taskName}</h2>
          <p className="text-sm text-slate-600 mt-1">
            Level {LEVEL_DISPLAY_MAP[selectedTaskMembers.level]?.label || selectedTaskMembers.level} - {selectedTaskMembers.neededByCount} members need this module
          </p>
        </div>
        <button onClick={() => setSelectedTaskMembers(null)} className="text-slate-400 hover:text-slate-600 p-2">
          <Icon name="X" className="w-6 h-6" />
        </button>
      </div>
      <div className="p-6 overflow-y-auto">
        {(() => {
          const emails = Array.from(new Set(
            (selectedTaskMembers.neededBy || [])
              .map(member => getMemberEmail(member.capid))
              .filter(Boolean)
          ));
          if (!emails.length) return null;
          return (
            <div className="mb-4">
              <div className="flex items-center justify-between mb-1">
                <span className="text-sm font-semibold text-slate-700">Emails ({emails.length})</span>
                <span className="text-[11px] text-slate-500">Copy/paste to email all</span>
              </div>
              <textarea
                className="w-full text-xs font-mono text-slate-700 border border-slate-200 rounded-lg p-2 bg-slate-50 focus:outline-none focus:ring-1 focus:ring-blue-400"
                rows="2"
                readOnly
                value={emails.join('; ')}
              />
            </div>
          );
        })()}
        <div className="space-y-2">
          {selectedTaskMembers.neededBy && selectedTaskMembers.neededBy.length > 0 ? (
            selectedTaskMembers.neededBy.map((member, idx) => (
              <div key={idx} className="flex justify-between items-center p-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">
                <div>
                  <div className="font-medium text-slate-800">{member.name}</div>
                  <div className="text-xs text-slate-500 mt-0.5">
                    {member.rank}
                    {(() => {
                      const email = getMemberEmail(member.capid);
                      return email ? <span className="text-slate-600 font-mono ml-2">{email}</span> : <span className="text-slate-400 italic ml-2">No email</span>;
                    })()}
                  </div>
                </div>
                <div className="text-sm font-mono text-slate-600 bg-slate-100 px-3 py-1 rounded">
                  {member.capid}
                </div>
              </div>
                ))
              ) : (
                <div className="text-center py-8 text-slate-400">
                  <p>No members found</p>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    )}

    {/* Member Task Details Modal */}
    {selectedMemberTaskDetails && (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" onClick={() => setSelectedMemberTaskDetails(null)}>
        <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
          <div className="flex justify-between items-center p-6 border-b border-slate-200">
            <div>
              <h2 className="text-xl font-bold text-slate-900">{selectedMemberTaskDetails.memberName}</h2>
              <p className="text-sm text-slate-600 mt-1">
                Remaining Training Tasks - CAPID: {selectedMemberTaskDetails.capid}
              </p>
            </div>
            <button onClick={() => setSelectedMemberTaskDetails(null)} className="text-slate-400 hover:text-slate-600 p-2">
              <Icon name="X" className="w-6 h-6" />
            </button>
          </div>
          <div className="p-6 overflow-y-auto">
            {selectedMemberTaskDetails.taskDetails && selectedMemberTaskDetails.taskDetails.length > 0 ? (
              <div className="space-y-3">
                {selectedMemberTaskDetails.taskDetails.map((detail, idx) => {
                  const totalRemaining = detail.required - detail.completed;
                  return (
                    <div key={idx} className="border rounded-lg overflow-hidden shadow-sm">
                      <div className={`px-4 py-2.5 text-sm font-bold flex justify-between items-center ${totalRemaining === 0 ? 'bg-green-50 text-green-800 border-b border-green-100' : 'bg-amber-50 text-amber-800 border-b border-amber-200'}`}>
                        <div>
                          <span className="block">{detail.groupName}</span>
                          <span className="text-xs font-normal opacity-75">{detail.levelName}</span>
                        </div>
                        <span className="text-xs px-2 py-0.5 bg-white rounded border ml-2">{detail.completed} / {detail.required}</span>
                      </div>
                      <div className="p-4 bg-white space-y-2">
                        {detail.tasks && detail.tasks.length > 0 ? (
                          detail.tasks.map((task, taskIdx) => (
                            <div key={taskIdx} className="flex items-start text-xs group">
                              <div className="mr-3 mt-0.5">
                                <CircleEmpty />
                              </div>
                              <div>
                                <div className="flex items-center gap-2">
                                  <span className="font-medium text-slate-600">{task.TaskName || task.name || 'Unnamed Task'}</span>
                                  {(() => {
                                    const trackTags = (task.appliesTo || []).filter(tag => tag !== 'ALL');
                                    if (!trackTags.length) return null;
                                    return (
                                      <div className="flex gap-1">
                                        {trackTags.map(tag => (
                                          <span key={`${task.TaskID || taskIdx}-${tag}`} className="text-[10px] px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-600 border border-slate-200">{tag}</span>
                                        ))}
                                      </div>
                                    );
                                  })()}
                                </div>
                                {(task.Description || task.description) && (
                                  <p className="text-slate-400 mt-0.5 leading-tight">{task.Description || task.description}</p>
                                )}
                              </div>
                            </div>
                          ))
                        ) : (
                          <div className="text-center py-4 text-slate-400 text-sm italic">
                            All tasks in this group are complete
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-center py-8 text-slate-400">
                <Icon name="CheckCircle" className="w-16 h-16 mx-auto mb-3 opacity-20" />
                <p className="font-medium">No remaining tasks found</p>
              </div>
            )}
          </div>
        </div>
      </div>
    )}
    </div>
  );
}
</script>


  <!-- Main Application (Modified for Offline) -->
  <script type="text/babel">
  
      const { useState, useMemo, useEffect, useCallback } = React;

      function App() {
        const [activeTab, setActiveTab] = useState('home');
        const [showReference, setShowReference] = useState(false);
        const [unitFilter, setUnitFilter] = useState("");
        const [showAllDescendants, setShowAllDescendants] = useState(false);
        const [isAggregating, setIsAggregating] = useState(false);
        const [searchQuery, setSearchQuery] = useState("");
        const [loading, setLoading] = useState(true);
        const [showZipImportModal, setShowZipImportModal] = useState(false);
        const [loadingStatus, setLoadingStatus] = useState("Checking local cache...");
        const [lastUpdated, setLastUpdated] = useState("");
        
        const [configFiles, setConfigFiles] = useState({ paths: [], groups: [], tasks: [], assignments: [], lookups: [], cadetAchvEnum: [] });
        const [dataFiles, setDataFiles] = useState({
          members: [], duty: [], tracks: [], memberTasks: [], memberPaths: [], organization: [],
          cadetDuty: [], seniorLevels: [], committees: [], contacts: [],
          cadetRank: [], cadetAchv: [], cadetAchvAprs: [], cadetAchvFullReport: [],
          cadetPhase: [], cadetAwards: [], cadetHFZ: [], cadetActivities: [],
          training: [], seniorAwards: [], oFlights: [], voluInstructors: []
        });
        
        const [selectedMember, setSelectedMember] = useState(null);
        const [detailLevel, setDetailLevel] = useState(null);
        const [promotionMember, setPromotionMember] = useState(null);
        const [filterPromoReady, setFilterPromoReady] = useState(false);
        const [filterTlcQualified, setFilterTlcQualified] = useState(false);
        const [activeFilterMenu, setActiveFilterMenu] = useState(null);
        const [dutySearchQuery, setDutySearchQuery] = useState("");
        const [trackSearchQuery, setTrackSearchQuery] = useState("");
        const [selectedReport, setSelectedReport] = useState(null);
        const [reportTagFilter, setReportTagFilter] = useState([]);
        const [isNavOpen, setIsNavOpen] = useState(false);
        const [showSeniorFilters, setShowSeniorFilters] = useState(true);
        const [reportsCollapsed, setReportsCollapsed] = useState(false);
        const [selectedTaskMembers, setSelectedTaskMembers] = useState(null);
        const [selectedMemberTaskDetails, setSelectedMemberTaskDetails] = useState(null);
        const [filters, setFilters] = useState({
          ranks: [],           // Individual ranks like "2D LT", "CAPT", etc.
          rankCategories: [],  // Categories: OFFICER, NCO, FLIGHT
          functionalAreas: [], // Like LOGISTICS, COMMUNICATIONS, etc.
          tracks: [],          // Specific track names
          trackLevels: [],     // MASTER, SENIOR, TECHNICIAN, NONE
          duties: [],          // Specific duty position names
          dutyTypes: [],       // PRIMARY or ASSISTANT
          memberTypes: []      // SENIOR, LIFE
        });
        const [levelFilter, setLevelFilter] = useState({ level: null, state: null });

        const [orgChartData, setOrgChartData] = useState(null);
        const [hideVacant, setHideVacant] = useState(true);
        const [draggedNode, setDraggedNode] = useState(null);
        const [expandedSections, setExpandedSections] = useState(new Set());
        const [drillDownPosition, setDrillDownPosition] = useState(null);
        const [showCommandChainOnly, setShowCommandChainOnly] = useState(false);
        const [showCommittees, setShowCommittees] = useState(false);
        const [selectedMemberProfile, setSelectedMemberProfile] = useState(null);
        const [selectedESQualification, setSelectedESQualification] = useState(null);
        const [showESTreeModal, setShowESTreeModal] = useState(false);
        const [dataService, setDataService] = useState(null);
        const [orgStatsService, setOrgStatsService] = useState(null);
        const [recruitingRetentionModal, setRecruitingRetentionModal] = useState({ isOpen: false });
        const [esReadinessModal, setESReadinessModal] = useState({ isOpen: false, analysis: null });
        const [currentPage, setCurrentPage] = useState(1);
        const [selectedCadet, setSelectedCadet] = useState(null);
        const [filterStatus, setFilterStatus] = useState('ALL');
        const [filterPhase, setFilterPhase] = useState(null);
        const [phaseFilter, setPhaseFilter] = useState(null);
        const [cadetSearchQuery, setCadetSearchQuery] = useState("");
        const [selectedCadetProfile, setSelectedCadetProfile] = useState(null);
        const [filter90Days, setFilter90Days] = useState(false);
        const [showCadetFilters, setShowCadetFilters] = useState(true);
        const [isMobile, setIsMobile] = useState(() => window.matchMedia('(max-width: 768px)').matches);

        // Handle ZIP import completion
        const handleZipImport = useCallback((payload) => {
          setShowZipImportModal(false);
          setLoading(true);
          setLoadingStatus("Processing imported data...");
          processPayload(payload);
          setLoading(false);
        }, [processPayload]);

        const hasCommittees = (dataFiles.committees && dataFiles.committees.length > 0) || (dataFiles.cadetDuty && dataFiles.cadetDuty.length > 0);
        const navItems = [
          { id: 'home', label: 'Home' },
          { id: 'unit', label: 'Unit Overview' },
          { id: 'senior', label: 'Senior Dashboard' },
          { id: 'cadet', label: 'Cadet Dashboard' },
          { id: 'reports', label: 'Reports' },
          { id: 'org', label: 'Org Chart' },
        ];

        useEffect(() => {
            const handleClickOutside = () => setActiveFilterMenu(null);
            document.addEventListener('click', handleClickOutside);
            return () => document.removeEventListener('click', handleClickOutside);
        }, []);

        useEffect(() => {
          const mq = window.matchMedia('(max-width: 768px)');
          const handleResize = (e) => setIsMobile(e.matches);
          mq.addEventListener('change', handleResize);
          return () => mq.removeEventListener('change', handleResize);
        }, []);

        const persistCache = useCallback((rawString, meta = {}) => {
          try {
            localStorage.setItem(DATA_CONSTANTS.CACHE_KEY, JSON.stringify({
              payload: rawString,
              savedAt: Date.now(),
              lastUpdated: meta.lastUpdated || null
            }));
          } catch (e) {
            // localStorage may be full or unavailable - fail silently as cache is optional
          }
        }, []);

        const processPayload = useCallback((result) => {
          setLoadingStatus("Building data indexes...");
          const service = createDataService();
          service.initialize(result);
          setDataService(service);
          setDataFiles(service.rawData());
          setConfigFiles(service.rawConfig());
          if (result.meta && result.meta.lastUpdated) {
            setLastUpdated(result.meta.lastUpdated);
          }
          // Initialize OrgStats service for recruiting/retention metrics
          if (result.data && result.data.orgStats) {
            const orgStats = createOrgStatsDataService();
            orgStats.initialize(result.data.orgStats);
            setOrgStatsService(orgStats);
          }
        }, []);

        const fetchFromServer = useCallback((lastKnownTimestamp = null) => {
          if (false /* Disabled for offline mode */) {
            setLoadingStatus("Fetching latest updates...");
            window.google.script.run
              .withSuccessHandler((response) => {
                const result = JSON.parse(response);
                const serverTimestamp = result.meta && result.meta.lastUpdated ? result.meta.lastUpdated : null;
                const isNewer = serverTimestamp && lastKnownTimestamp ? new Date(serverTimestamp) > new Date(lastKnownTimestamp) : true;
                if (isNewer) {
                  processPayload(result);
                }
                persistCache(response, result.meta || {});
                setLoadingStatus("Finalizing dashboard...");
                setLoading(false);
              })
              .withFailureHandler((error) => {
                if (loading) { alert("Error fetching data: " + error); setLoading(false); }
              })
              .getAppData();
          } else { setLoading(false); }
        }, [loading, persistCache, processPayload]);

        useEffect(() => {
          if (!loading) return;
          const rotation = [
            "Reviewing the local ops log...",
            "Unpacking the latest duty rosters...",
            "Checking in with headquarters...",
            "Syncing personnel and training records...",
            "Lining up the promotion requirements...",
            "Forming up your dashboards..."
          ];
          let index = 0;
          const intervalId = setInterval(() => {
            setLoadingStatus((current) => {
              if (!loading) return current;
              index = (index + 1) % rotation.length;
              return rotation[index];
            });
          }, 1800);
          return () => clearInterval(intervalId);
        }, [loading]);

        useEffect(() => {
                    const loadData = async () => {
            // First, check IndexedDB for cached data
            const cached = await window.CapwatchDB.load();
            if (cached && cached.payload) {
              setLoadingStatus("Loading cached data...");
              processPayload(cached.payload);
              setLoading(false);
              return;
            }

            // No cached data - show ZIP import modal
            setLoading(false);
            setShowZipImportModal(true);
          };
          loadData();
        }, [fetchFromServer, processPayload]);

        const levelPathMap = useMemo(() => deriveLevelPathMap(configFiles.paths || []), [configFiles.paths]);

        const unitChildrenMap = useMemo(() => {
           const map = new Map();
           if(dataFiles.organization.length) {
              dataFiles.organization.forEach(o => {
                 const parentId = String(o.NextLevel).trim();
                 const childId = String(o.ORGID).trim();
                 if(parentId && parentId !== childId) {
                    if(!map.has(parentId)) map.set(parentId, []);
                    map.get(parentId).push(childId);
                 }
              });
           }
           return map;
        }, [dataFiles.organization]);

        const getDescendantOrgIds = (rootId) => {
           const root = String(rootId).trim();
           let results = [root];
           const queue = [root];
           const visited = new Set([root]); 
           while(queue.length > 0){
             const curr = queue.shift();
             const kids = unitChildrenMap.get(curr) || [];
             kids.forEach(k => {
               if(!visited.has(k)){
                 visited.add(k); results.push(k); queue.push(k);
               }
             });
           }
           return results;
        };

        const availableUnits = useMemo(() => {
          if (!dataFiles.members.length) return [];
          const units = new Map();

          dataFiles.members.forEach(m => {
            if (m.ORGID && m.Unit && !isNaN(parseInt(m.Unit)) && /^\d+$/.test(m.Unit.trim())) {
               const cleanUnit = m.Unit.replace(/^0+/, '').padStart(3, '0');
               if (cleanUnit === '000' || cleanUnit === '004') return;
               if(!units.has(m.ORGID)){
                  units.set(m.ORGID, { id: m.ORGID, unitNum: cleanUnit, name: `Unit ${cleanUnit}` }); 
               }
            }
          });
          
          if(dataFiles.organization.length){
             dataFiles.organization.forEach(o => {
                if(units.has(o.ORGID)) {
                   const entry = units.get(o.ORGID);
                   const cleanUnit = o.Unit ? o.Unit.replace(/^0+/, '').padStart(3, '0') : entry.unitNum;
                   entry.name = `${o.Region}-${o.Wing}-${cleanUnit} ${o.Name}`;
                   entry.unitNum = cleanUnit;
                }
             });
          }

          return Array.from(units.values()).sort((a, b) => parseInt(a.unitNum) - parseInt(b.unitNum));
        }, [dataFiles.members, dataFiles.organization]);

        useEffect(() => { 
            if (!unitFilter && availableUnits.length > 0) {
                setUnitFilter(availableUnits[0].id); 
            }
        }, [availableUnits]);

        useEffect(() => {
          setSelectedReport(null);
          setSelectedTaskMembers(null);
          setSelectedCadet(null);
          setFilterStatus('ALL');
          setReportsCollapsed(false);
        }, [unitFilter]);
        
        // --- HANDLE SUB-UNIT TOGGLE ---
        const handleShowSubUnits = (e) => {
            if (e.target.checked) {
                setIsAggregating(true);
                // Slight delay to allow UI to render loading state before heavy calculation
                setTimeout(() => {
                    setShowAllDescendants(true);
                    setIsAggregating(false);
                }, 100);
            } else {
                setShowAllDescendants(false);
            }
        };

        const buildMemberProfileData = (member) => {
          if (!member) return null;
          const id = member.CAPID;

          const rawDuties = dataFiles.duty.filter(d => d.CAPID === id);
          const duties = rawDuties.map(d => {
              const org = dataFiles.organization.find(o => o.ORGID === d.ORGID);
              const orgString = org ? `${org.Region}-${org.Wing}-${org.Unit}` : "Unknown";
              return { 
                  name: d.Duty, 
                  isAsst: d.Asst === "1", 
                  date: d.DateMod, 
                  orgString,
                  displayName: `${d.Duty}${d.Asst === "1" ? " (A)" : ""}` 
              };
          });
          const rawTracks = dataFiles.tracks.filter(t => t.CAPID === id);
          const tracks = rawTracks.map(t => ({ name: t.Track, level: t.TrackLevel, date: t.DateMod }));
          
          const dutiesWithStatus = duties.map(duty => {
            const cleanDuty = duty.name.toUpperCase().trim();
            const requiredTrack = DUTY_TO_TRACK_MAP[cleanDuty];
            let hasTrack = true, warningMsg = "";
            if (requiredTrack) {
              const hasEnrolled = tracks.some(t => {
                  const trackName = t.name.toUpperCase().trim();
                  return trackName.includes(requiredTrack) || requiredTrack.includes(trackName);
              });
              if (!hasEnrolled) { hasTrack = false; warningMsg = `Missing Track: ${requiredTrack}`; }
            }
            return { ...duty, hasTrack, warningMsg };
          });

          const tracksWithStatus = tracks.map(track => {
            const isNone = track.level === "NONE";
            let hasDuty = true, warningMsg = "";
            if (isNone) {
              const trackNameUpper = track.name.toUpperCase().trim();
              const relevantDutyExists = duties.some(d => {
                const mappedTrack = DUTY_TO_TRACK_MAP[d.name.toUpperCase().trim()];
                return mappedTrack === trackNameUpper;
              });
              if (!relevantDutyExists) { hasDuty = false; warningMsg = "Enrolled (NONE) but no Duty Position assigned."; }
            }
            return { ...track, hasDuty, warningMsg };
          });

          const { progress: levelsProgress, currentLevel: highestLevel } = calculateLevelsProgress(member, configFiles, dataFiles, levelPathMap);
          const level2Track = determineLevel2Track(dataFiles.memberTasks ? dataFiles.memberTasks.filter(mt => mt.CAPID === id) : []);

          let memberUnitName = "Unknown";
          if (dataFiles.organization) {
              const memOrg = dataFiles.organization.find(o => o.ORGID === member.ORGID);
              if (memOrg) {
                  const r = memOrg.Region || "";
                  const w = memOrg.Wing || "";
                  const u = memOrg.Unit ? memOrg.Unit.replace(/^0+/, '').padStart(3,'0') : "000";
                  memberUnitName = `${r}-${w}-${u}`;
              }
          }

          return { ...member, memberUnitName, duties: dutiesWithStatus, tracks: tracksWithStatus, levelsProgress, level2Track, rankDate: member.RankDate, currentLevel: highestLevel };
        };

        const processedData = useMemo(() => {
          if (!dataService || !unitFilter) return [];
          // Now the component just asks the service for the data it needs.
          return dataService.getProcessedMembers(unitFilter, showAllDescendants);
        }, [dataService, unitFilter, showAllDescendants]);

        const cadetData = useMemo(() => {
          if (!dataFiles.members.length) return [];

          let validOrgIds = [unitFilter];
          if (showAllDescendants) {
            validOrgIds = getDescendantOrgIds(unitFilter);
          }

          const cadets = dataFiles.members.filter(m => {
            const type = String(m.Type || m.TYPE || "").toUpperCase();
            const status = String(m.MbrStatus || "").toUpperCase();
            return validOrgIds.includes(m.ORGID) && type === "CADET" && status === "ACTIVE";
          });

          return cadets.map(cadet => {
            let memberUnitName = "Unknown";
            if (dataFiles.organization) {
              const memOrg = dataFiles.organization.find(o => o.ORGID === cadet.ORGID);
              if (memOrg) {
                const r = memOrg.Region || "";
                const w = memOrg.Wing || "";
                const u = memOrg.Unit ? memOrg.Unit.replace(/^0+/, '').padStart(3,'0') : "000";
                memberUnitName = `${r}-${w}-${u}`;
              }
            }

            const cadetDuties = dataFiles.cadetDuty
              ? dataFiles.cadetDuty
                  .filter(d => d.CAPID === cadet.CAPID && d.Duty && !d.Duty.toUpperCase().includes('#REF'))
                  .map(d => {
                  const org = dataFiles.organization.find(o => o.ORGID === d.ORGID);
                  const orgString = org ? `${org.Region}-${org.Wing}-${org.Unit ? org.Unit.replace(/^0+/, '').padStart(3,'0') : '000'}` : "Unknown";
                  return { name: d.Duty, date: d.DateMod, orgString };
                })
              : [];

            return { ...cadet, memberUnitName, cadetDuties };
          });
        }, [dataFiles, unitFilter, showAllDescendants]);

        // Cadet Data Service for Promotion Tracker
        const [cadetDataService, setCadetDataService] = useState(null);

        useEffect(() => {
          const service = createCadetDataService();
          setCadetDataService(service);
        }, []);

        useEffect(() => {
          if (cadetDataService && Object.keys(dataFiles).length > 0) {
            const payload = { data: dataFiles, config: configFiles };
            cadetDataService.initialize(payload);
          }
        }, [cadetDataService, dataFiles, configFiles]);

        const processedCadets = useMemo(() => {
          if (!cadetDataService || !unitFilter) return [];
          try {
            return cadetDataService.getProcessedCadets(unitFilter, showAllDescendants);
          } catch (error) {
            console.error('Error processing cadets:', error);
            return [];
          }
        }, [cadetDataService, unitFilter, showAllDescendants, dataFiles.members, dataFiles.organization, dataFiles.cadetRank, dataFiles.cadetAchvAprs]);

        // Course definitions for PME and Leadership training
        const PME_COURSE_DEFS = [
          { key: 'ncoa', label: 'NCOA', matches: ({ courseKey, howKey }) => courseKey === 'ncoa' || (howKey.includes('nco academy') && !howKey.includes('senior')) },
          { key: 'sncoa', label: 'SNCOA', matches: ({ courseKey, howKey }) => courseKey === 'sncoa' || howKey.includes('senior nco academy') },
          { key: 'sos', label: 'SOS', matches: ({ courseKey, howKey }) => courseKey === 'sos' || howKey.includes('squadron officer school') },
          { key: 'acsc', label: 'ACSC', matches: ({ courseKey, howKey }) => courseKey === 'acsc' || howKey.includes('air command') || howKey.includes('command and general staff') },
          { key: 'awc', label: 'AWC', matches: ({ courseKey, howKey }) => courseKey === 'awc' || howKey.includes('war college') }
        ];

        const CAP_LEADERSHIP_COURSE_DEFS = [
          { key: 'squadron-command', label: 'Squadron Command', matches: ({ courseKey }) => courseKey.includes('squadron command course') },
          { key: 'group-command', label: 'Group Command', matches: ({ courseKey }) => courseKey.includes('group command course') },
          { key: 'region-command', label: 'Region Command', matches: ({ courseKey }) => courseKey.includes('region command course') },
          { key: 'volu', label: 'VOLU Instructor', matches: ({ courseKey }) => courseKey.includes('volu instructor') }
        ];

        const LEGACY_LEADERSHIP_COURSE_DEFS = [
          { key: 'sls', label: 'SLS', matches: ({ courseKey }) => courseKey === 'sls' },
          { key: 'clc', label: 'CLC', matches: ({ courseKey }) => courseKey === 'clc' },
          { key: 'ucc', label: 'UCC', matches: ({ courseKey }) => courseKey === 'ucc' },
          { key: 'rsc', label: 'RSC', matches: ({ courseKey }) => courseKey === 'rsc' },
          { key: 'nsc', label: 'NSC', matches: ({ courseKey }) => courseKey === 'nsc' },
          { key: 'wcc', label: 'WCC', matches: ({ courseKey }) => courseKey.includes('wing chaplain course') || courseKey === 'wcc' }
        ];

        // Training course index for PME and Leadership course tracking
        const trainingRecords = useMemo(() => {
          if (Array.isArray(dataFiles.training)) return dataFiles.training;
          if (typeof parseCSV === 'function') return parseCSV(dataFiles.training);
          return [];
        }, [dataFiles.training]);

        const trainingCourseIndex = useMemo(() => {
          const map = new Map();
          if (!trainingRecords || trainingRecords.length === 0) return map;

          const normalizeText = (value) => String(value || '').trim().replace(/\s+/g, ' ').toLowerCase();
          const parseDateValue = (value) => {
            if (!value) return null;
            const raw = String(value).trim();
            if (!raw || raw === '01/01/1900') return null;
            const parsed = new Date(raw);
            if (Number.isNaN(parsed.getTime())) return null;
            return { raw, date: parsed };
          };
          const getRecordDate = (record) => parseDateValue(record.Completed) || parseDateValue(record.DateMod);
          const upsert = (bucket, key, dateValue) => {
            const current = bucket[key];
            if (!current || dateValue.date > current.date) {
              bucket[key] = dateValue;
            }
          };

          trainingRecords.forEach(record => {
            const capid = String(record.CAPID || '').trim();
            if (!capid) return;
            const courseKey = normalizeText(record.TypeCrs);
            const howKey = normalizeText(record.HowComplete);
            if (!courseKey && !howKey) return;
            const dateValue = getRecordDate(record);
            if (!dateValue) return;
            const bucket = map.get(capid) || { pme: {}, leadership: {}, legacyLeadership: {} };
            const context = { courseKey, howKey };
            PME_COURSE_DEFS.forEach(def => {
              if (def.matches(context)) upsert(bucket.pme, def.key, dateValue);
            });
            CAP_LEADERSHIP_COURSE_DEFS.forEach(def => {
              if (def.matches(context)) upsert(bucket.leadership, def.key, dateValue);
            });
            LEGACY_LEADERSHIP_COURSE_DEFS.forEach(def => {
              if (def.matches(context)) upsert(bucket.legacyLeadership, def.key, dateValue);
            });
            if (!map.has(capid)) map.set(capid, bucket);
          });

          return map;
        }, [trainingRecords]);

        // Build VOLU instructor index - maps CAPID to their instructor qualifications
        // Structure: Map<CAPID, { courses: Map<PathName, { online: boolean, faceToFace: boolean }>, isChair: boolean }>
        const voluInstructorIndex = useMemo(() => {
          const map = new Map();
          if (!dataFiles.voluInstructors || dataFiles.voluInstructors.length === 0) return map;

          dataFiles.voluInstructors.forEach(record => {
            const capid = String(record.CAPID || '').trim();
            if (!capid) return;

            const pathName = String(record.PathName || '').trim();
            const category = String(record.Category || '').trim().toLowerCase();
            const instructorType = String(record.InstructorType || '').trim().toLowerCase();

            if (!pathName) return;

            if (!map.has(capid)) {
              map.set(capid, { courses: new Map(), isChair: false });
            }

            const entry = map.get(capid);

            // Track if this person is a Chair for any course
            if (instructorType === 'chair') {
              entry.isChair = true;
            }

            if (!entry.courses.has(pathName)) {
              entry.courses.set(pathName, { online: false, faceToFace: false });
            }

            const course = entry.courses.get(pathName);
            if (category === 'online') {
              course.online = true;
            } else if (category === 'facetoface') {
              course.faceToFace = true;
            }
          });

          return map;
        }, [dataFiles.voluInstructors]);

        const getLevelBreakdown = (member, levelKey) => {
          const pathId = levelPathMap[levelKey];
          if (!pathId) return null;
          const chosenTrack = member.level2Track || determineLevel2Track(dataFiles.memberTasks ? dataFiles.memberTasks.filter(mt => mt.CAPID === member.CAPID) : []);
          const groups = configFiles.groups.filter(g => g.PathID === pathId);
          const validGroups = groups.filter(g => (parseInt(g.NumberOfRequiredTasks)||0) > 0);

          const mappedGroups = validGroups.map(group => {
            const taskAssignments = configFiles.assignments.filter(a => a.GroupID === group.GroupID);
            let tasks = taskAssignments.map(ta => {
              const taskDef = configFiles.tasks.find(t => t.TaskID === ta.TaskID);
              if (!taskDef) return null;
              const isDone = dataFiles.memberTasks.some(mt => mt.CAPID === member.CAPID && mt.TaskID === ta.TaskID && mt.StatusID === "8");
              const appliesTo = LEVEL2_TASK_TRACKS[taskDef.TaskID] || ["ALL"];
              return { ...taskDef, isDone, appliesTo };
            }).filter(Boolean);

            if ((levelKey === 'L2P1' || levelKey === 'L2P2') && chosenTrack) {
              tasks = tasks.filter(t => (t.appliesTo || []).includes("ALL") || (t.appliesTo || []).includes(chosenTrack));
            }

            const completedCount = tasks.filter(t => t.isDone).length;
            const required = parseInt(group.NumberOfRequiredTasks);
            return { groupName: group.GroupName, required, completedCount, isGroupDone: completedCount >= required, tasks };
          });

          return { groups: mappedGroups, track: chosenTrack };
        };

        const getPromotionDetails = (member) => {
            const normRank = normalizeRank(member.Rank);
            const rules = PROMOTION_RULES[normRank];
            if (!rules) return null;
            const rankDate = new Date(member.rankDate);
            const today = new Date();
            const diffMonths = Math.floor(Math.abs(today - rankDate) / (1000 * 60 * 60 * 24 * 30.44)); 
            const eligibleDate = new Date(rankDate);
            eligibleDate.setMonth(eligibleDate.getMonth() + rules.tigMonths);
            let isDutyMet = true, dutyStatusString = "", currentDutyMonths = 0;
            if (rules.dutyReq) {
               isDutyMet = false;
               const matchingDuties = member.duties.filter(d => {
                   const name = d.name.toUpperCase();
                   if (rules.dutyReq === "Unit NCO") return name.includes("NCO") || name.includes("SERGEANT");
                   if (rules.dutyReq === "NCO Advisor") return name.includes("NCO ADVISOR");
                   if (rules.dutyReq === "Command NCO") return name.includes("COMMAND NCO") || name.includes("SENIOR ENLISTED LEADER");
                   return false;
               });
               if (matchingDuties.length > 0) {
                   let maxMonths = 0;
                   matchingDuties.forEach(d => {
                       const assigned = new Date(d.date);
                       const months = Math.floor(Math.abs(today - assigned) / (1000 * 60 * 60 * 24 * 30.44));
                       if (months > maxMonths) maxMonths = months;
                   });
                   currentDutyMonths = maxMonths;
                   isDutyMet = maxMonths >= rules.dutyMonths;
                   dutyStatusString = isDutyMet ? `Completed (${maxMonths} months)` : `In Progress (${maxMonths} / ${rules.dutyMonths} months)`;
               } else { dutyStatusString = `Missing Assignment: ${rules.dutyReq}`; }
            }
            let levelRequiredLabel = rules.level ? `Level ${rules.level}` : '';
            let levelCurrentLabel = member.currentLevel ? `Level ${member.currentLevel}` : 'Not Started';
            let isLevelMet = rules.level ? member.currentLevel >= rules.level : true;

            if (rules.requiredParts && rules.requiredParts.length > 0) {
               levelRequiredLabel = rules.requiredParts.map(p => LEVEL_DISPLAY_MAP[p]?.name || p).join(' + ');
               isLevelMet = rules.requiredParts.every(p => member.levelsProgress && member.levelsProgress[p] && member.levelsProgress[p].status === 'completed');
               levelCurrentLabel = rules.requiredParts.map(p => {
                  const status = member.levelsProgress && member.levelsProgress[p];
                  const short = LEVEL_DISPLAY_MAP[p]?.label || p;
                  if (status?.status === 'completed') return `${short}: Done`;
                  if (status?.status === 'ready') return `${short}: Ready to submit`;
                  if (status?.status === 'pending') return `${short}: Pending`;
                  return `${short}: Incomplete`;
               }).join(' | ');
            }

            return {
              currentRank: member.Rank,
              nextRank: rules.next,
              rankDate: member.rankDate,
              tigMonthsCurrent: diffMonths,
              tigMonthsRequired: rules.tigMonths,
              eligibleDate: eligibleDate.toLocaleDateString(),
              isTigMet: diffMonths >= rules.tigMonths,
              levelRequired: levelRequiredLabel,
              levelCurrent: levelCurrentLabel,
              isLevelMet,
              dutyReq: rules.dutyReq,
              isDutyMet,
              dutyStatusString
            };
        };

        const getEtSummary = (member) => {
            const progress = member.levelsProgress || {};
            const completedIds = LEVEL_ORDER.filter(id => progress[id] && progress[id].status === 'completed');
            const highestCompleted = completedIds.length ? completedIds[completedIds.length - 1] : null;
            const nextId = LEVEL_ORDER.find(id => !progress[id] || progress[id].status !== 'completed') || null;
            const nextStatus = nextId ? progress[nextId] || { status: 'not-started', percent: 0 } : null;
            return { highestCompleted, nextId, nextStatus };
        };

        const getMemberEmail = (capid) => {
          if (!dataFiles.contacts) return null;
          const cap = String(capid).trim();
          const contactsUpper = dataFiles.contacts.map(c => ({
            ...c,
            TypeU: (c.Type || '').toUpperCase(),
            PriorityU: (c.Priority || '').toUpperCase(),
            CAPIDU: String(c.CAPID || '').trim()
          }));
          const primaryEmail = contactsUpper.find(c =>
            c.CAPIDU === cap &&
            c.TypeU === 'EMAIL' &&
            c.PriorityU === 'PRIMARY'
          );
          if (primaryEmail) return primaryEmail.Contact;
          const anyEmail = contactsUpper.find(c => c.CAPIDU === cap && c.TypeU === 'EMAIL');
          return anyEmail ? anyEmail.Contact : null;
        };

        const CADET_PROTECTION_CONFIG = {
          renewalDays: 365,
          dueSoonDays: 60
        };

        const TLC_CONFIG = {
          renewalMonths: 36,
          warningDays: 365,
          graceDays: 365
        };

        const parseDateSafe = (value) => {
          if (!value || value === '01/01/1900') return null;
          if (value instanceof Date) {
            return Number.isNaN(value.getTime()) ? null : value;
          }
          const raw = String(value).trim();
          const mdyMatch = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
          if (mdyMatch) {
            const month = Number(mdyMatch[1]);
            const day = Number(mdyMatch[2]);
            const year = Number(mdyMatch[3]);
            if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
              const parsed = new Date(year, month - 1, day);
              return Number.isNaN(parsed.getTime()) ? null : parsed;
            }
          }
          const parsed = new Date(raw);
          return Number.isNaN(parsed.getTime()) ? null : parsed;
        };

        const formatShortDate = (value) => {
          if (!value) return 'N/A';
          return value.toLocaleDateString();
        };

        const getAgeYears = (dob) => {
          const date = parseDateSafe(dob);
          if (!date) return null;
          const now = new Date();
          return Math.floor((now - date) / (1000 * 60 * 60 * 24 * 365.25));
        };

        const orgTypeMap = useMemo(() => {
          const map = new Map();
          (dataFiles.organization || []).forEach(org => {
            map.set(String(org.ORGID || '').trim(), String(org.Type || '').toUpperCase());
          });
          return map;
        }, [dataFiles.organization]);

        const unitType = useMemo(() => {
          const org = (dataFiles.organization || []).find(o => String(o.ORGID || '').trim() === String(unitFilter || '').trim());
          return String(org?.Type || '').toUpperCase();
        }, [dataFiles.organization, unitFilter]);

        const unitScope = useMemo(() => {
          const org = (dataFiles.organization || []).find(o => String(o.ORGID || '').trim() === String(unitFilter || '').trim());
          return String(org?.Scope || '').toUpperCase();
        }, [dataFiles.organization, unitFilter]);

        const showTlcCompliance = useMemo(() => {
          if (!unitFilter) return false;
          const type = (unitType || '').toUpperCase();
          const scope = (unitScope || '').toUpperCase();
          const isHigherHq = type.includes('GROUP') || type.includes('WING') || type.includes('REGION') || type.includes('NATIONAL');
          if (isHigherHq) return false;
          if (type.includes('SENIOR')) return false;
          const isCadetComposite = type.includes('CADET') || type.includes('COMPOSITE');
          const isUnitScope = scope === 'UNIT';
          return isCadetComposite && isUnitScope;
        }, [unitFilter, unitType, unitScope]);

        const trainingIndex = useMemo(() => {
          const map = new Map();
          const trainingRecords = Array.isArray(dataFiles.training)
            ? dataFiles.training
            : parseCSV(dataFiles.training);
          (trainingRecords || []).forEach(record => {
            const capid = String(record.CAPID || '').trim();
            if (!capid) return;
            const courseName = String(record.TypeCrs || '').trim();
            const courseKey = courseName.replace(/\s+/g, ' ').trim().toLowerCase();
            let courseType = null;
            if (courseKey === 'cadet protection - basic course') courseType = 'basic';
            if (courseKey === 'cadet protection - cadet course') courseType = 'basic';
            if (courseKey === 'cadet protection - advanced course') courseType = 'advanced';
            if (courseKey === 'cppt') courseType = 'basic';
            const isTlc = /\btlc\b/.test(courseKey)
              || courseKey.includes('training leaders of cadets');
            const tlcLabel = (() => {
              if (!isTlc) return null;
              if (courseKey.includes('on-demand') || courseKey.includes('on demand')) return 'TLC On-Demand';
              if (courseKey.includes('basic')) return 'TLC Basic';
              if (courseKey.includes('intermediate')) return 'TLC Intermediate';
              if (courseKey.includes('advanced')) return 'TLC Advanced';
              return 'TLC';
            })();
            if (!courseType && !tlcLabel) return;
            const completed = parseDateSafe(record.Completed) || parseDateSafe(record.DateMod);
            if (!completed) return;
            if (!map.has(capid)) map.set(capid, { basic: [], advanced: [], tlc: [] });
            if (courseType) {
              map.get(capid)[courseType].push(completed);
            }
            if (tlcLabel) {
              map.get(capid).tlc.push({ date: completed, label: tlcLabel });
            }
          });
          map.forEach(entry => {
            const pickLatest = (dates) => {
              if (!dates || dates.length === 0) return null;
              return dates.reduce((latest, date) => (date > latest ? date : latest), dates[0]);
            };
            const pickLatestRecord = (records) => {
              if (!records || records.length === 0) return null;
              return records.reduce((latest, record) => (record.date > latest.date ? record : latest), records[0]);
            };
            entry.basic = pickLatest(entry.basic);
            entry.advanced = pickLatest(entry.advanced);
            entry.tlc = pickLatestRecord(entry.tlc);
          });
          return map;
        }, [dataFiles.training]);

        const getCadetProtectionStatus = useCallback((member) => {
          if (!member) return null;
          const capid = String(member.CAPID || '').trim();
          const memberType = String(member.Type || member.TYPE || '').toUpperCase();
          const isCadet = memberType === 'CADET';
          const isSenior = memberType === 'SENIOR' || memberType === 'LIFE';
          const age = getAgeYears(member.DOB);
          const basicRequired = isSenior || (isCadet && age !== null && age >= 18);
          const basicEligible = isCadet && age !== null && age >= 17;

          const isGroupOrHigher = (orgId) => {
            const type = orgTypeMap.get(String(orgId || '').trim()) || '';
            return type.includes('GROUP') || type.includes('WING') || type.includes('REGION') || type.includes('NATIONAL');
          };

          const dutyRecords = (dataFiles.duty || []).filter(d => String(d.CAPID || '').trim() === capid);
          const advancedRequired = isSenior && dutyRecords.some(duty => {
            const dutyName = String(duty.Duty || '').toUpperCase().replace(/\s+/g, ' ').trim();
            if (!dutyName) return false;
            const commanderTitles = [
              'COMMANDER',
              'SQUADRON COMMANDER',
              'GROUP COMMANDER',
              'WING COMMANDER',
              'REGION COMMANDER',
              'UNIT COMMANDER'
            ];
            const isCommander = commanderTitles.includes(dutyName);
            const isDeputyCommanderGroupPlus = dutyName.includes('DEPUTY COMMANDER') && isGroupOrHigher(duty.ORGID);
            const isDeputyCommanderCadets = dutyName.includes('DEPUTY COMMANDER') && dutyName.includes('CADET');
            const isDirectorCadetPrograms = dutyName.includes('DIRECTOR') && dutyName.includes('CADET PROGRAM');
            const isChiefOfStaff = dutyName.includes('CHIEF OF STAFF');
            const isLegalOfficer = dutyName.includes('LEGAL OFFICER');
            const isInspectorGeneral = dutyName.includes('INSPECTOR GENERAL');
            return (
              isCommander ||
              isDeputyCommanderGroupPlus ||
              isDeputyCommanderCadets ||
              isDirectorCadetPrograms ||
              isChiefOfStaff ||
              isLegalOfficer ||
              isInspectorGeneral
            );
          });

          const completion = trainingIndex.get(capid) || {};
          const effectiveBasicRequired = basicRequired && !advancedRequired;
          const effectiveBasicEligible = basicEligible && !advancedRequired;
          const now = new Date();
          const statusStyles = {
            current: { tone: 'good', badge: 'bg-emerald-100 text-emerald-700', border: 'border-emerald-200', text: 'text-emerald-700' },
            'due-soon': { tone: 'warn', badge: 'bg-amber-100 text-amber-700', border: 'border-amber-200', text: 'text-amber-700' },
            overdue: { tone: 'bad', badge: 'bg-rose-100 text-rose-700', border: 'border-rose-200', text: 'text-rose-700' },
            missing: { tone: 'bad', badge: 'bg-rose-100 text-rose-700', border: 'border-rose-200', text: 'text-rose-700' },
            eligible: { tone: 'info', badge: 'bg-blue-100 text-blue-700', border: 'border-blue-200', text: 'text-blue-700' },
            'not-required': { tone: 'muted', badge: 'bg-slate-100 text-slate-600', border: 'border-slate-200', text: 'text-slate-600' }
          };

          const buildCourseStatus = ({ id, label, lastCompleted, required, eligible, note }) => {
            let status = 'not-required';
            let expirationDate = null;
            let daysRemaining = null;
            if (lastCompleted) {
              expirationDate = new Date(lastCompleted);
              expirationDate.setDate(expirationDate.getDate() + CADET_PROTECTION_CONFIG.renewalDays);
              daysRemaining = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));
            }
            if (required) {
              if (!lastCompleted) {
                status = 'missing';
              } else if (daysRemaining < 0) {
                status = 'overdue';
              } else if (daysRemaining <= CADET_PROTECTION_CONFIG.dueSoonDays) {
                status = 'due-soon';
              } else {
                status = 'current';
              }
            } else if (eligible) {
              status = 'eligible';
            }

            const statusLabelMap = {
              current: 'Current',
              'due-soon': 'Due soon',
              overdue: 'Overdue',
              missing: 'Missing',
              eligible: 'Eligible',
              'not-required': 'Not required'
            };
            const styles = statusStyles[status] || statusStyles['not-required'];
            const daysText = daysRemaining === null ? 'N/A' : daysRemaining >= 0 ? `${daysRemaining} days remaining` : `${Math.abs(daysRemaining)} days overdue`;
            return {
              id,
              label,
              required,
              eligible,
              lastCompleted,
              expirationDate,
              daysRemaining,
              daysText,
              status,
              statusLabel: statusLabelMap[status] || 'Unknown',
              tone: styles.tone,
              badgeClass: styles.badge,
              borderClass: styles.border,
              textClass: styles.text,
              note
            };
          };

          const basicNote = !effectiveBasicRequired && effectiveBasicEligible
            ? 'Eligible at 17; required annually at 18.'
            : null;
          const basicLabel = isCadet ? 'Cadet Protection - Cadet Course' : 'Cadet Protection - Basic Course';
          const advancedLabel = 'Cadet Protection - Advanced Course';
          const basic = buildCourseStatus({
            id: 'basic',
            label: basicLabel,
            lastCompleted: completion.basic || null,
            required: effectiveBasicRequired,
            eligible: effectiveBasicEligible,
            note: basicNote
          });
          const advanced = buildCourseStatus({
            id: 'advanced',
            label: advancedLabel,
            lastCompleted: completion.advanced || null,
            required: advancedRequired,
            eligible: advancedRequired,
            note: null
          });

          const requiredCourses = [basic, advanced].filter(course => course.required);
          const displayCourses = [basic, advanced].filter(course => course.required || course.eligible);

          const indicator = (() => {
            if (!requiredCourses.length) {
              if (effectiveBasicEligible && !completion.basic) {
                return {
                  tone: 'warn',
                  status: 'due-soon',
                  label: 'Cadet Protection due soon',
                  title: `${basic.label}: Eligible at 17`,
                  items: [{ id: basic.id, label: basic.label, status: 'eligible', statusLabel: 'Eligible' }]
                };
              }
              return {
                tone: 'none',
                status: 'not-required',
                label: 'Cadet Protection not required',
                title: 'Cadet Protection: Not required',
                items: []
              };
            }
            const severity = { missing: 3, overdue: 3, 'due-soon': 2, current: 1 };
            let worst = requiredCourses[0].status;
            requiredCourses.forEach(course => {
              if ((severity[course.status] || 0) > (severity[worst] || 0)) {
                worst = course.status;
              }
            });
            const toneMap = { current: 'good', 'due-soon': 'warn', overdue: 'bad', missing: 'bad' };
            const titleLines = requiredCourses.map(course => {
              const dateInfo = course.lastCompleted ? ` (exp ${formatShortDate(course.expirationDate)})` : '';
              return `${course.label}: ${course.statusLabel}${dateInfo}`;
            });
            return {
              tone: toneMap[worst] || 'none',
              status: worst,
              label: `Cadet Protection ${worst.replace('-', ' ')}`,
              title: titleLines.join('\n'),
              items: requiredCourses.map(course => ({
                id: course.id,
                label: course.label,
                status: course.status,
                statusLabel: course.statusLabel
              }))
            };
          })();

          const summaryLabel = requiredCourses.length
            ? requiredCourses.map(course => course.label).join(' + ')
            : 'None';
          const isCompliant = requiredCourses.length
            ? requiredCourses.every(course => course.status === 'current' || course.status === 'due-soon')
            : true;

          return {
            memberType,
            age,
            basic,
            advanced,
            requiredCourses,
            displayCourses,
            summaryLabel,
            isCompliant,
            indicator
          };
        }, [dataFiles.duty, orgTypeMap, trainingIndex]);

        const getTlcStatus = useCallback((member) => {
          if (!member) return null;
          const capid = String(member.CAPID || '').trim();
          const tlcRecord = trainingIndex.get(capid)?.tlc;
          if (!tlcRecord || !tlcRecord.date) return null;

          const completed = tlcRecord.date;
          const expirationDate = new Date(completed);
          expirationDate.setMonth(expirationDate.getMonth() + TLC_CONFIG.renewalMonths);
          const now = new Date();
          const daysRemaining = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));
          if (daysRemaining < -TLC_CONFIG.graceDays) return null;

          let status = 'current';
          if (daysRemaining < 0) status = 'expired';
          else if (daysRemaining <= TLC_CONFIG.warningDays) status = 'due-soon';

          const statusStyles = {
            current: { badge: 'bg-emerald-100 text-emerald-700', border: 'border-emerald-200', text: 'text-emerald-700' },
            'due-soon': { badge: 'bg-amber-100 text-amber-700', border: 'border-amber-200', text: 'text-amber-700' },
            expired: { badge: 'bg-rose-100 text-rose-700', border: 'border-rose-200', text: 'text-rose-700' }
          };
          const statusLabelMap = { current: 'Current', 'due-soon': 'Due soon', expired: 'Expired' };
          const styles = statusStyles[status] || statusStyles.current;
          const daysText = daysRemaining >= 0
            ? `${daysRemaining} days remaining`
            : `${Math.abs(daysRemaining)} days overdue`;

          return {
            course: tlcRecord.label || 'TLC',
            completed,
            expirationDate,
            daysRemaining,
            daysText,
            status,
            statusLabel: statusLabelMap[status] || status,
            badgeClass: styles.badge,
            borderClass: styles.border,
            textClass: styles.text
          };
        }, [trainingIndex]);

        const getTrainingIndicator = useCallback((member) => {
          const cpStatus = getCadetProtectionStatus(member);
          const tlcStatus = getTlcStatus(member);
          const titleLines = [];

          if (cpStatus?.indicator?.title) {
            titleLines.push(...cpStatus.indicator.title.split('\n'));
          }

          if (tlcStatus) {
            const expLabel = tlcStatus.expirationDate ? ` (exp ${formatShortDate(tlcStatus.expirationDate)})` : '';
            titleLines.push(`TLC (${tlcStatus.course}): ${tlcStatus.statusLabel}${expLabel}`);
          }

          const toneSeverity = { bad: 3, warn: 2, good: 1, none: 0 };
          const cpTone = cpStatus?.indicator?.tone || 'none';
          const tlcTone = tlcStatus
            ? (tlcStatus.status === 'expired' ? 'bad' : tlcStatus.status === 'due-soon' ? 'warn' : 'good')
            : 'none';
          const tone = (toneSeverity[cpTone] || 0) >= (toneSeverity[tlcTone] || 0) ? cpTone : tlcTone;

          return {
            tone: tone || 'none',
            title: titleLines.length ? titleLines.join('\n') : 'Training: No data',
            items: []
          };
        }, [getCadetProtectionStatus, getTlcStatus]);

        // Base unit stats (filtered by ACTIVE status only)
        const baseUnitStats = useMemo(() => {
          if (!dataFiles.members.length) return null;

          let validOrgIds = [unitFilter];
          if (showAllDescendants) validOrgIds = getDescendantOrgIds(unitFilter);

          // Filter to only ACTIVE members
          const unitMembers = dataFiles.members.filter(m => {
            const status = String(m.MbrStatus || "").toUpperCase();
            return validOrgIds.includes(m.ORGID) && status === "ACTIVE";
          });
          const seniors = unitMembers.filter(m => (m.Type || m.TYPE) === "SENIOR" || (m.Type || m.TYPE) === "LIFE").length;
          const cadets = unitMembers.filter(m => (m.Type || m.TYPE) === "CADET").length;
          return { total: unitMembers.length, seniors, cadets };
        }, [dataFiles.members, unitFilter, showAllDescendants]);

        const displayData = useMemo(() => {
            let filtered = processedData.filter(m => {
                const search = searchQuery.toLowerCase();
                const nameMatch = (m.NameLast + m.NameFirst + m.CAPID).toLowerCase().includes(search);
                const dutyMatch = m.duties.some(d => d.name.toLowerCase().includes(search));
                return nameMatch || dutyMatch;
            });

            if (filterPromoReady) {
                filtered = filtered.filter(m => { const d = getPromotionDetails(m); return d && d.isTigMet && d.isLevelMet && (!d.dutyReq || d.isDutyMet); });
            }

            if (levelFilter.level !== null) {
                filtered = filtered.filter(m => {
                    const status = m.levelsProgress[levelFilter.level];
                    if (!status) return false;
                    return levelFilter.state === 'complete' ? status.status === 'completed' : status.status !== 'completed';
                });
            }

            // Filter by individual ranks
            if (filters.ranks.length > 0) {
               filtered = filtered.filter(m => {
                   const r = normalizeRank(m.Rank);
                   return filters.ranks.includes(r);
               });
            }

            // Filter by rank categories
            if (filters.rankCategories.length > 0) {
               filtered = filtered.filter(m => {
                   const r = normalizeRank(m.Rank);
                   for (const cat of filters.rankCategories) {
                     if (cat === 'OFFICER' && ["2D LT","1ST LT","CAPT","MAJ","LT COL","COL"].includes(r)) return true;
                     if (cat === 'NCO' && ["SSGT","TSGT","MSGT","SMSGT","CMSGT"].includes(r)) return true;
                     if (cat === 'FLIGHT' && ["FO","TFO","SFO"].includes(r)) return true;
                     if (cat === 'SM' && r === "SM") return true;
                   }
                   return false;
               });
            }

            // Filter by specific track names AND/OR track rating levels
            // When both are selected, use AND logic (must match both criteria)
            if (filters.tracks.length > 0 || filters.trackLevels.length > 0) {
              filtered = filtered.filter(m => {
                  // Handle NONE level special case
                  if (filters.trackLevels.includes('NONE') && m.tracks.length === 0) {
                    return filters.tracks.length === 0; // Only match if no specific tracks selected
                  }

                  // If both track name and level filters are active, must match BOTH (AND logic)
                  if (filters.tracks.length > 0 && filters.trackLevels.length > 0) {
                    return m.tracks.some(t => {
                      const trackNameUpper = t.name.toUpperCase().trim();
                      const matchesName = filters.tracks.some(filterTrack => trackNameUpper.includes(filterTrack));
                      const matchesLevel = filters.trackLevels.includes(t.level);
                      return matchesName && matchesLevel; // AND logic
                    });
                  }

                  // If only track name filter is active
                  if (filters.tracks.length > 0) {
                    return m.tracks.some(t => {
                      const trackNameUpper = t.name.toUpperCase().trim();
                      return filters.tracks.some(filterTrack => trackNameUpper.includes(filterTrack));
                    });
                  }

                  // If only track level filter is active
                  if (filters.trackLevels.length > 0) {
                    return m.tracks.some(t => filters.trackLevels.includes(t.level));
                  }

                  return true;
              });
            }

            // Filter by functional areas
            if (filters.functionalAreas.length > 0) {
               filtered = filtered.filter(m => {
                  return m.duties.some(d => {
                      const cleanDuty = d.name.toUpperCase().trim();
                      const track = DUTY_TO_TRACK_MAP[cleanDuty];
                      return filters.functionalAreas.includes(track);
                  });
               });
            }

            // Filter by specific duties
            if (filters.duties.length > 0) {
               filtered = filtered.filter(m => {
                  return m.duties.some(d => {
                      const cleanDuty = d.name.toUpperCase().trim();
                      return filters.duties.some(filterDuty => cleanDuty.includes(filterDuty.toUpperCase()));
                  });
               });
            }

            // Filter by duty type (Primary vs Assistant)
            if (filters.dutyTypes.length > 0) {
               filtered = filtered.filter(m => {
                  return m.duties.some(d => {
                      if (filters.dutyTypes.includes('PRIMARY') && !d.isAsst) return true;
                      if (filters.dutyTypes.includes('ASSISTANT') && d.isAsst) return true;
                      return false;
                  });
               });
            }

            // Filter by member type
            if (filters.memberTypes.length > 0) {
               filtered = filtered.filter(m => {
                  const memberType = (m.Type || m.TYPE);
                  return filters.memberTypes.includes(memberType);
               });
            }

            if (filterTlcQualified) {
              filtered = filtered.filter(m => {
                const tlc = getTlcStatus(m);
                return tlc && tlc.status !== 'expired';
              });
            }

            return filtered;
        }, [processedData, searchQuery, filterPromoReady, levelFilter, filters, filterTlcQualified, getTlcStatus]);

        const paginatedData = useMemo(() => {
           const startIndex = (currentPage - 1) * DATA_CONSTANTS.ITEMS_PER_PAGE;
           return displayData.slice(startIndex, startIndex + DATA_CONSTANTS.ITEMS_PER_PAGE);
        }, [displayData, currentPage]);

        const totalPages = Math.ceil(displayData.length / DATA_CONSTANTS.ITEMS_PER_PAGE);

        // Dynamic statistics based on filtered data
        const unitStats = useMemo(() => {
          if (!displayData || displayData.length === 0) return null;

          const promoReady = displayData.filter(m => {
            const d = getPromotionDetails(m);
            return d && d.isTigMet && d.isLevelMet && (!d.dutyReq || d.isDutyMet);
          }).length;

          const levelCounts = LEVEL_ORDER.reduce((acc, id) => { acc[id] = 0; return acc; }, {});
          displayData.forEach(m => {
            LEVEL_ORDER.forEach(id => {
              if (m.levelsProgress && m.levelsProgress[id] && m.levelsProgress[id].status === 'completed') {
                levelCounts[id] = (levelCounts[id] || 0) + 1;
              }
            });
          });

          // Enhanced statistics
          const withDuties = displayData.filter(m => m.duties.length > 0).length;
          const withTracks = displayData.filter(m => m.tracks.length > 0).length;
          const withMasterTrack = displayData.filter(m => m.tracks.some(t => t.level === 'MASTER')).length;
          const withSeniorTrack = displayData.filter(m => m.tracks.some(t => t.level === 'SENIOR')).length;
          const withTechTrack = displayData.filter(m => m.tracks.some(t => t.level === 'TECHNICIAN')).length;

          // Average time in grade calculation
          let totalTIG = 0;
          let tigCount = 0;
          displayData.forEach(m => {
            if (m.rankDate) {
              const rankDate = new Date(m.rankDate);
              const today = new Date();
              const months = Math.floor(Math.abs(today - rankDate) / (1000 * 60 * 60 * 24 * 30.44));
              totalTIG += months;
              tigCount++;
            }
          });
          const avgTIG = tigCount > 0 ? Math.round(totalTIG / tigCount) : 0;

          // Duty assignment statistics
          const primaryDuties = displayData.filter(m => m.duties.some(d => !d.isAsst)).length;
          const assistantDuties = displayData.filter(m => m.duties.some(d => d.isAsst)).length;

          const cadetProtectionStats = (() => {
            const summary = {
              requiredMembers: 0,
              compliant: 0,
              nonCompliant: 0,
              dueSoon: 0,
              overdue: 0,
              missing: 0,
              percent: 0
            };
            displayData.forEach(member => {
              const status = getCadetProtectionStatus(member);
              if (!status || status.requiredCourses.length === 0) return;
              summary.requiredMembers += 1;
              const hasOverdue = status.requiredCourses.some(course => course.status === 'overdue');
              const hasMissing = status.requiredCourses.some(course => course.status === 'missing');
              const hasDueSoon = status.requiredCourses.some(course => course.status === 'due-soon');
              if (hasOverdue) summary.overdue += 1;
              if (hasMissing) summary.missing += 1;
              if (hasDueSoon) summary.dueSoon += 1;
              if (hasOverdue || hasMissing) summary.nonCompliant += 1;
              else summary.compliant += 1;
            });
            summary.percent = summary.requiredMembers > 0
              ? Math.round((summary.compliant / summary.requiredMembers) * 100)
              : 0;
            return summary;
          })();

          const tlcCompliance = (() => {
            if (!showTlcCompliance) return null;
            const required = 2;
            const qualified = displayData.filter(member => {
              const tlc = getTlcStatus(member);
              return tlc && tlc.status !== 'expired';
            }).length;
            return {
              required,
              qualified,
              percent: Math.min(100, Math.round((qualified / required) * 100)),
              isCompliant: qualified >= required
            };
          })();

          return {
            filtered: displayData.length,
            promoReady,
            levelCounts,
            withDuties,
            withTracks,
            withMasterTrack,
            withSeniorTrack,
            withTechTrack,
            avgTIG,
            primaryDuties,
            assistantDuties,
            dutyAssignmentRate: displayData.length > 0 ? Math.round((withDuties / displayData.length) * 100) : 0,
            trackEnrollmentRate: displayData.length > 0 ? Math.round((withTracks / displayData.length) * 100) : 0,
            cadetProtection: cadetProtectionStats,
            tlcCompliance
          };
        }, [displayData, getCadetProtectionStatus, getTlcStatus, showTlcCompliance]);

        const handleLevelFilterClick = (lvl) => {
            if (levelFilter.level === lvl) {
                if (levelFilter.state === 'complete') setLevelFilter({ level: lvl, state: 'incomplete' });
                else if (levelFilter.state === 'incomplete') setLevelFilter({ level: null, state: null });
                else setLevelFilter({ level: lvl, state: 'complete' }); 
            } else { setLevelFilter({ level: lvl, state: 'complete' }); }
        };

        const toggleFilter = (category, value) => {
            setFilters(prev => {
                const current = prev[category];
                const updated = current.includes(value)
                   ? current.filter(item => item !== value)
                   : [...current, value];
                return { ...prev, [category]: updated };
            });
            setCurrentPage(1);
        };

        const clearFilters = () => {
          setFilters({
            ranks: [],
            rankCategories: [],
            functionalAreas: [],
            tracks: [],
            trackLevels: [],
            duties: [],
            dutyTypes: [],
            memberTypes: []
          });
          setSearchQuery("");
          setFilterPromoReady(false);
          setFilterTlcQualified(false);
          setLevelFilter({ level: null, state: null });
        };

        // Extract unique values from data for filter options
        const availableRanks = useMemo(() => {
          const ranks = new Set();
          processedData.forEach(m => {
            const r = normalizeRank(m.Rank);
            if (r) ranks.add(r);
          });
          return Array.from(ranks).sort();
        }, [processedData]);

        const availableTracks = useMemo(() => {
          const tracks = new Set();
          processedData.forEach(m => {
            m.tracks.forEach(t => {
              tracks.add(t.name.toUpperCase().trim());
            });
          });
          return Array.from(tracks).sort();
        }, [processedData]);

        const availableDuties = useMemo(() => {
          const duties = new Set();
          processedData.forEach(m => {
            m.duties.forEach(d => {
              duties.add(d.name.toUpperCase().trim());
            });
          });
          return Array.from(duties).sort();
        }, [processedData]);

        const availableFunctionalAreas = useMemo(() => {
          const functionalAreas = new Set();
          processedData.forEach(m => {
            m.duties.forEach(d => {
              const cleanDuty = d.name.toUpperCase().trim();
              const functionalArea = DUTY_TO_TRACK_MAP[cleanDuty];
              if (functionalArea) {
                functionalAreas.add(functionalArea);
              }
            });
          });
          return Array.from(functionalAreas).sort();
        }, [processedData]);

        // Report Generation Functions
        const generateMostNeededTraining = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length || !configFiles.groups.length) return [];

          const isModeratedTaskForLevel = (levelId, taskName) => {
            const normalized = normalizeTaskName(taskName);
            const allowed = MODERATED_LOOKUP[levelId] || new Set();
            if (!allowed.size) return false; // No moderated modules for this level (e.g., Level 1)
            if (allowed.has(normalized)) return true;
            // Allow loose matching when names vary slightly between PDFs and task catalog
            return Array.from(allowed).some(entry => normalized.includes(entry) || entry.includes(normalized));
          };

          // Helper function to determine a member's current working level (lowest incomplete)
          const getCurrentWorkingLevel = (member) => {
            for (const levelId of LEVEL_ORDER) {
              const levelProgress = member.levelsProgress[levelId];
              if (levelProgress && levelProgress.status !== 'completed') {
                return levelId;
              }
            }
            return null; // All complete or no data
          };

          const taskNeedCount = new Map();
          const membersWorkingOnLevel = {}; // Track how many are actively working each level

          // First, count how many members are actively working on each level (current working level only)
          LEVEL_ORDER.forEach(levelId => {
            membersWorkingOnLevel[levelId] = memberPool.filter(m => getCurrentWorkingLevel(m) === levelId).length;
          });

          // For each level
          LEVEL_ORDER.forEach(levelId => {
            const pathId = levelPathMap[levelId];
            if (!pathId) return;

            const moderatedList = MODERATED_LOOKUP[levelId];
            if (!moderatedList || moderatedList.size === 0) return;

            const groups = configFiles.groups.filter(g => g.PathID === pathId);
            const validGroups = groups.filter(g => (parseInt(g.NumberOfRequiredTasks)||0) > 0);

            validGroups.forEach(group => {
              const taskAssignments = configFiles.assignments.filter(a => a.GroupID === group.GroupID);

              taskAssignments.forEach(ta => {
                const taskDef = configFiles.tasks.find(t => t.TaskID === ta.TaskID);
                if (!taskDef || !isModeratedTaskForLevel(levelId, taskDef.TaskName)) return;

                const taskKey = `${levelId}|${taskDef.TaskID}`;

                if (!taskNeedCount.has(taskKey)) {
                  taskNeedCount.set(taskKey, {
                    taskId: taskDef.TaskID,
                    taskName: taskDef.TaskName,
                    description: taskDef.Description,
                    level: levelId,
                    groupName: group.GroupName,
                    neededBy: []
                  });
                }

                // Check each member - only if this level is their CURRENT working level
                memberPool.forEach(member => {
                  const currentWorkingLevel = getCurrentWorkingLevel(member);
                  if (currentWorkingLevel !== levelId) return;

                  // Level 2: honor track-specific applicability
                  if (levelId === 'L2P1' || levelId === 'L2P2') {
                    const memberTrack = member.level2Track || determineLevel2Track(dataFiles.memberTasks ? dataFiles.memberTasks.filter(mt => mt.CAPID === member.CAPID) : []);
                    const appliesTo = LEVEL2_TASK_TRACKS[taskDef.TaskID] || ["ALL"];
                    if (memberTrack && !(appliesTo.includes("ALL") || appliesTo.includes(memberTrack))) return;
                  }

                  const isDone = dataFiles.memberTasks.some(mt =>
                    mt.CAPID === member.CAPID && mt.TaskID === taskDef.TaskID && mt.StatusID === "8"
                  );
                  if (!isDone) {
                    taskNeedCount.get(taskKey).neededBy.push({
                      capid: member.CAPID,
                      name: `${member.NameLast}, ${member.NameFirst}`,
                      rank: member.Rank
                    });
                  }
                });
              });
            });
          });

          // Convert to array and rank by overall need (moderated-only)
          const allResults = Array.from(taskNeedCount.values())
            .map(item => {
              const workingOnLevel = membersWorkingOnLevel[item.level] || 0;
              const neededByCount = item.neededBy.length;
              const percentageOfLevelPopulation = workingOnLevel > 0 ? Math.round((neededByCount / workingOnLevel) * 100) : 0;
              const percentageOfUnit = memberPool.length > 0 ? Math.round((neededByCount / memberPool.length) * 100) : 0;

              return {
                ...item,
                neededByCount,
                percentageOfUnit,
                percentageOfLevel: percentageOfLevelPopulation,
                workingOnLevel
              };
            })
            .filter(item => item.neededByCount > 0);

          return allResults.sort((a, b) => {
            if (b.neededByCount !== a.neededByCount) return b.neededByCount - a.neededByCount;
            if (b.percentageOfUnit !== a.percentageOfUnit) return b.percentageOfUnit - a.percentageOfUnit;
            return a.taskName.localeCompare(b.taskName);
          });
        };

        const generateDiscrepanciesReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length) return [];

          const discrepancies = [];

          memberPool.forEach(member => {
            const issues = [];

            member.duties.forEach(duty => {
              const cleanDuty = duty.name.toUpperCase().trim();
              const requiredTrack = DUTY_TO_TRACK_MAP[cleanDuty];

              if (requiredTrack) {
                const hasEnrolled = member.tracks.some(t => {
                  const trackName = t.name.toUpperCase().trim();
                  return trackName.includes(requiredTrack) || requiredTrack.includes(trackName);
                });

                if (!hasEnrolled) {
                  issues.push({
                    duty: duty.name,
                    requiredTrack
                  });
                }
              }
            });

            if (issues.length > 0) {
              discrepancies.push({
                capid: member.CAPID,
                memberName: `${member.NameLast}, ${member.NameFirst}`,
                rank: member.Rank,
                issues
              });
            }
          });

          // Sort by number of issues descending
          return discrepancies.sort((a, b) => b.issues.length - a.issues.length);
        };

        const generateApprovalNeededReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length) return [];

          const seniorsOnly = memberPool.filter(m => {
            const type = (m.Type || m.TYPE || '').toUpperCase();
            return type === 'SENIOR' || type === 'LIFE';
          });

          const rows = [];
          seniorsOnly.forEach(member => {
            LEVELS.forEach(lvl => {
              const status = member.levelsProgress && member.levelsProgress[lvl.id];
              if (!status) return;
              if (status.status === 'ready' || status.status === 'pending') {
                const statusLabel = status.status === 'pending'
                  ? (status.approvalStatus === 'disapproved' ? 'Submitted - Needs Update' : 'Submitted - Pending')
                  : 'Ready to Submit';
                rows.push({
                  capid: member.CAPID,
                  memberName: `${member.NameLast}, ${member.NameFirst}`,
                  rank: member.Rank,
                  unit: member.memberUnitName,
                  levelId: lvl.id,
                  levelLabel: lvl.label,
                  levelName: lvl.name,
                  status: statusLabel,
                  percent: status.percent || 0
                });
              }
            });
          });

          return rows.sort((a, b) => {
            const ln = a.memberName.localeCompare(b.memberName);
            if (ln !== 0) return ln;
            return (a.levelId || '').localeCompare(b.levelId || '');
          });
        };

        const generatePromotionEligibilityReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length) return [];

          const seniorsOnly = memberPool.filter(m => {
            const type = (m.Type || m.TYPE || '').toUpperCase();
            return type === 'SENIOR' || type === 'LIFE';
          });

          const rows = [];
          seniorsOnly.forEach(member => {
            const promoDetails = getPromotionDetails(member);
            if (!promoDetails) return;

            // Exclude Lt Cols - they can only be promoted to Col with wing command position
            const normRank = normalizeRank(member.Rank);
            if (normRank === 'LT COL') return;

            // Check if member is eligible for promotion
            const isEligible = promoDetails.isTigMet && promoDetails.isLevelMet && (!promoDetails.dutyReq || promoDetails.isDutyMet);

            if (isEligible) {
              rows.push({
                capid: member.CAPID,
                memberName: `${member.NameLast}, ${member.NameFirst}`,
                rank: member.Rank,
                unit: member.memberUnitName,
                nextRank: promoDetails.nextRank,
                tigMonths: promoDetails.tigMonthsCurrent,
                tigRequired: promoDetails.tigMonthsRequired,
                tigDisplay: `${promoDetails.tigMonthsCurrent}m (${promoDetails.tigMonthsRequired}m req)`,
                levelCurrent: promoDetails.levelCurrent,
                levelRequired: promoDetails.levelRequired,
                levelDisplay: `${promoDetails.levelCurrent} (${promoDetails.levelRequired} req)`,
                dutyStatus: promoDetails.dutyStatusString || 'N/A',
                eligibleDate: promoDetails.eligibleDate
              });
            }
          });

          return rows.sort((a, b) => {
            // Sort by next rank first (higher ranks first)
            const rankOrder = ["CMSgt", "SMSgt", "MSgt", "TSgt", "SSgt", "Col", "Lt Col", "Maj", "Capt", "1st Lt", "2d Lt", "SFO", "TFO", "FO"];
            const aRankIdx = rankOrder.indexOf(a.nextRank);
            const bRankIdx = rankOrder.indexOf(b.nextRank);
            if (aRankIdx !== bRankIdx) return aRankIdx - bRankIdx;
            // Then by name
            return a.memberName.localeCompare(b.memberName);
          });
        };

        const generateNearPromotionReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length) return [];

          const seniorsOnly = memberPool.filter(m => {
            const type = (m.Type || m.TYPE || '').toUpperCase();
            return type === 'SENIOR' || type === 'LIFE';
          });

          const rows = [];
          const NEAR_TIG_THRESHOLD = 6;
          const NEAR_DUTY_THRESHOLD = 6;
          const MAX_TASKS_REMAINING = 5;

          seniorsOnly.forEach(member => {
            const promoDetails = getPromotionDetails(member);
            if (!promoDetails) return;

            const normRank = normalizeRank(member.Rank);
            if (normRank === 'LT COL') return;

            const isFullyEligible = promoDetails.isTigMet && promoDetails.isLevelMet && (!promoDetails.dutyReq || promoDetails.isDutyMet);
            if (isFullyEligible) return;

            const tigMonthsRemaining = promoDetails.tigMonthsRequired - promoDetails.tigMonthsCurrent;
            const isNearTIG = tigMonthsRemaining > 0 && tigMonthsRemaining <= NEAR_TIG_THRESHOLD;

            let dutyMonthsRemaining = 0;
            let isNearDuty = false;
            if (promoDetails.dutyReq && !promoDetails.isDutyMet && promoDetails.currentDutyMonths > 0) {
              const rules = PROMOTION_RULES[normRank];
              if (rules && rules.dutyMonths) {
                dutyMonthsRemaining = rules.dutyMonths - promoDetails.currentDutyMonths;
                isNearDuty = dutyMonthsRemaining > 0 && dutyMonthsRemaining <= NEAR_DUTY_THRESHOLD;
              }
            }

            let tasksRemaining = 5;
            let taskDetails = [];
            if (!promoDetails.isLevelMet && promoDetails.levelRequired) {
              const rules = PROMOTION_RULES[normRank];
              if (rules) {
                if (rules.requiredParts && rules.requiredParts.length > 0) {
                  rules.requiredParts.forEach(partId => {
                    const levelProgress = member.levelsProgress && member.levelsProgress[partId];
                    if (levelProgress && levelProgress.status !== 'completed') {
                      const breakdown = getLevelBreakdown(member, partId);
                      if (breakdown && breakdown.groups) {
                        breakdown.groups.forEach(g => {
                          const remaining = Math.max(0, g.required - g.completedCount);
                          if (remaining > 0) {
                            const incompleteTasks = g.tasks.filter(t => !t.isDone);
                            taskDetails.push({
                              levelId: partId,
                              levelName: LEVEL_DISPLAY_MAP[partId]?.name || partId,
                              groupName: g.groupName,
                              required: g.required,
                              completed: g.completedCount,
                              tasks: incompleteTasks
                            });
                          }
                          tasksRemaining += remaining;
                        });
                      }
                    }
                  });
                } else if (rules.level) {
                  for (let lvl = 1; lvl <= rules.level; lvl++) {
                    const currentLvl = member.currentLevel || 0;
                    if (lvl > currentLvl) {
                      const levelKeys = LEVEL_ORDER.filter(lk => {
                        const def = LEVEL_DISPLAY_MAP[lk];
                        return def && def.baseLevel === lvl;
                      });
                      levelKeys.forEach(levelKey => {
                        const levelProgress = member.levelsProgress && member.levelsProgress[levelKey];
                        if (levelProgress && levelProgress.status !== 'completed') {
                          const breakdown = getLevelBreakdown(member, levelKey);
                          if (breakdown && breakdown.groups) {
                            breakdown.groups.forEach(g => {
                              const remaining = Math.max(0, g.required - g.completedCount);
                              if (remaining > 0) {
                                const incompleteTasks = g.tasks.filter(t => !t.isDone);
                                taskDetails.push({
                                  levelId: levelKey,
                                  levelName: LEVEL_DISPLAY_MAP[levelKey]?.name || levelKey,
                                  groupName: g.groupName,
                                  required: g.required,
                                  completed: g.completedCount,
                                  tasks: incompleteTasks
                                });
                              }
                              tasksRemaining += remaining;
                            });
                          }
                        }
                      });
                      break;
                    }
                  }
                }
              }
            }

            const isNearLevel = tasksRemaining > 0 && tasksRemaining <= MAX_TASKS_REMAINING;

            let category = '';
            let blockingFactors = [];
            let priority = 0;

            if (!promoDetails.isTigMet) {
              if (isNearTIG) {
                category = 'TIG Pending (Near)';
                blockingFactors.push(`${tigMonthsRemaining}m until TIG`);
                priority = 1;
              } else {
                category = 'TIG Pending';
                blockingFactors.push(`${tigMonthsRemaining}m until TIG`);
                priority = 4;
              }
            }

            if (!promoDetails.isLevelMet) {
              if (isNearLevel) {
                if (category) category += ' + Training';
                else category = 'Training Pending (Near)';
                blockingFactors.push(`${tasksRemaining} task${tasksRemaining !== 1 ? 's' : ''} remaining`);
                if (priority === 0 || priority > 2) priority = 2;
              } else if (tasksRemaining > 0) {
                if (category) category += ' + Training';
                else category = 'Training Pending';
                blockingFactors.push(`${tasksRemaining} tasks remaining`);
                if (priority === 0 || priority > 5) priority = 5;
              } else {
                if (category) category += ' + Training';
                else category = 'Training Pending';
                blockingFactors.push(`Level ${promoDetails.levelRequired} needed`);
                if (priority === 0 || priority > 6) priority = 6;
              }
            }

            if (promoDetails.dutyReq && !promoDetails.isDutyMet) {
              if (promoDetails.currentDutyMonths === 0) {
                if (category) category += ' + Duty';
                else category = 'Duty Assignment Needed';
                blockingFactors.push(`Needs ${promoDetails.dutyReq}`);
                if (priority === 0 || priority > 3) priority = 3;
              } else if (isNearDuty) {
                if (category) category += ' + Duty';
                else category = 'Duty Time Pending (Near)';
                blockingFactors.push(`${dutyMonthsRemaining}m until duty req`);
                if (priority === 0 || priority > 1) priority = 1;
              } else {
                if (category) category += ' + Duty';
                else category = 'Duty Time Pending';
                blockingFactors.push(`${dutyMonthsRemaining}m until duty req`);
                if (priority === 0 || priority > 4) priority = 4;
              }
            }

            if (isNearTIG || isNearLevel || isNearDuty || (blockingFactors.length > 0 && blockingFactors.length <= 2)) {
              rows.push({
                capid: member.CAPID,
                memberName: `${member.NameLast}, ${member.NameFirst}`,
                rank: member.Rank,
                unit: member.memberUnitName,
                nextRank: promoDetails.nextRank,
                category,
                blockingFactors: blockingFactors.join(', '),
                priority,
                tigMonthsCurrent: promoDetails.tigMonthsCurrent,
                tigMonthsRequired: promoDetails.tigMonthsRequired,
                tigMonthsRemaining,
                isTigMet: promoDetails.isTigMet,
                isNearTIG,
                tigStatus: promoDetails.isTigMet
                  ? 'Met'
                  : `${tigMonthsRemaining}m remaining (${promoDetails.tigMonthsCurrent}/${promoDetails.tigMonthsRequired})`,
                levelCurrent: promoDetails.levelCurrent,
                levelRequired: promoDetails.levelRequired,
                isLevelMet: promoDetails.isLevelMet,
                tasksRemaining,
                taskDetails,
                isNearLevel,
                dutyStatus: promoDetails.dutyStatusString || 'N/A',
                isDutyMet: promoDetails.isDutyMet,
                dutyMonthsRemaining,
                isNearDuty,
                eligibleDate: promoDetails.eligibleDate
              });
            }
          });

          return rows.sort((a, b) => {
            if (a.priority !== b.priority) return a.priority - b.priority;
            const rankOrder = ["CMSgt", "SMSgt", "MSgt", "TSgt", "SSgt", "Col", "Lt Col", "Maj", "Capt", "1st Lt", "2d Lt", "SFO", "TFO", "FO"];
            const aRankIdx = rankOrder.indexOf(a.nextRank);
            const bRankIdx = rankOrder.indexOf(b.nextRank);
            if (aRankIdx !== bRankIdx) return aRankIdx - bRankIdx;
            return a.memberName.localeCompare(b.memberName);
          });
        };

        // Cadet Report: No Promotion in Last 120 Days
        const generateCadetNoPromotionReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length || !dataFiles.cadetRank.length) {
            return [];
          }

          const cadets = memberPool.filter(m => {
            const memberType = (m.Type || m.TYPE || '').toUpperCase();
            return memberType === 'CADET';
          });

          const rows = [];
          const today = new Date();
          const threshold = 120;

          cadets.forEach(cadet => {
            const cadetRanks = dataFiles.cadetRank
              .filter(r => String(r.CAPID).trim() === String(cadet.CAPID).trim())
              .sort((a, b) => new Date(b.RankDate) - new Date(a.RankDate));

            if (cadetRanks.length === 0) return;

            const lastPromotion = cadetRanks[0];
            const rankDate = new Date(lastPromotion.RankDate);
            const daysSincePromotion = Math.floor((today - rankDate) / (1000 * 60 * 60 * 24));

            if (daysSincePromotion > threshold) {
              rows.push({
                capid: cadet.CAPID,
                memberName: `${cadet.NameLast}, ${cadet.NameFirst}`,
                unit: cadet.memberUnitName,
                rank: lastPromotion.Rank,
                lastPromotion: lastPromotion.RankDate,
                daysSince: daysSincePromotion
              });
            }
          });

          return rows.sort((a, b) => b.daysSince - a.daysSince);
        };

        // Cadet Report: Membership Lapsing in 90 Days or Less
        const generateMembershipLapseReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length) return [];

          // Include both seniors (including LIFE members) and cadets
          const activeMembers = memberPool.filter(m => {
            const memberType = (m.Type || m.TYPE || '').toUpperCase();
            return memberType === 'CADET' || memberType === 'SENIOR' || memberType === 'LIFE';
          });

          const rows = [];
          const today = new Date();
          const threshold = 90 * 24 * 60 * 60 * 1000;

          activeMembers.forEach(member => {
            if (!member.Expiration || member.Expiration === '12/31/9998' || member.Expiration === '12/31/9999') return;

            const expirationDate = new Date(member.Expiration);
            const daysUntilExpiration = Math.floor((expirationDate - today) / (1000 * 60 * 60 * 24));

            if (daysUntilExpiration >= 0 && daysUntilExpiration <= 90) {
              rows.push({
                capid: member.CAPID,
                memberName: `${member.NameLast}, ${member.NameFirst}`,
                unit: member.memberUnitName,
                memberType: member.Type || 'UNKNOWN',
                rank: member.Rank || 'N/A',
                expiration: member.Expiration,
                daysUntil: daysUntilExpiration,
                urgency: daysUntilExpiration <= 30 ? 'critical' : daysUntilExpiration <= 60 ? 'warning' : 'caution'
              });
            }
          });

          return rows.sort((a, b) => a.daysUntil - b.daysUntil);
        };

          const generateCadetProtectionReport = (membersOverride = null) => {
            const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
            if (!memberPool.length || !getCadetProtectionStatus) return [];

          const statusLabelMap = {
            'due-soon': 'Due Soon',
            overdue: 'Overdue',
            missing: 'Missing'
          };
          const severityMap = { missing: 3, overdue: 3, 'due-soon': 2 };
          const rows = [];
          const now = new Date();

          const pushRow = (member, course, statusKey, requirementLabel, daysTextOverride, expirationOverride, daysSortOverride) => {
            const rawType = String(member.Type || member.TYPE || '').toUpperCase();
            const memberType = rawType || (member.currentRank ? 'CADET' : 'UNKNOWN');
            const lastCompleted = course.lastCompleted || null;
            const expirationDate = expirationOverride || course.expirationDate || null;
            const daysText = daysTextOverride || course.daysText || 'N/A';
            const daysSort = Number.isFinite(daysSortOverride)
              ? daysSortOverride
              : Number.isFinite(course.daysRemaining)
                ? course.daysRemaining
                : statusKey === 'missing'
                  ? -9999
                  : 9999;

            rows.push({
              capid: member.CAPID,
              memberName: `${member.NameLast}, ${member.NameFirst}`,
              unit: member.memberUnitName || 'Unknown',
              memberType,
              rank: member.Rank || member.currentRank || 'N/A',
              course: course.label,
              requirement: requirementLabel,
              status: statusLabelMap[statusKey] || 'Due Soon',
              lastCompleted: lastCompleted ? formatShortDate(lastCompleted) : 'Not completed',
              expiration: expirationDate ? formatShortDate(expirationDate) : 'N/A',
              daysText,
              statusKey,
              daysSort
            });
          };

          memberPool.forEach(member => {
            const cpStatus = getCadetProtectionStatus(member);
            if (!cpStatus) return;

            const flaggedCourses = (cpStatus.requiredCourses || []).filter(course =>
              ['overdue', 'missing', 'due-soon'].includes(course.status)
            );

            flaggedCourses.forEach(course => {
              pushRow(member, course, course.status, 'Required', null, null, null);
            });

            const eligibleNeedsAttention = !flaggedCourses.length &&
              cpStatus.basic &&
              cpStatus.basic.eligible &&
              !cpStatus.basic.lastCompleted &&
              cpStatus.indicator?.status === 'due-soon';

            if (eligibleNeedsAttention) {
              let dueDate = null;
              let daysUntil = null;
              const dob = parseDateSafe(member.DOB);
              if (dob) {
                dueDate = new Date(dob);
                dueDate.setFullYear(dueDate.getFullYear() + 18);
                daysUntil = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
              }
              const daysText = Number.isFinite(daysUntil)
                ? `${daysUntil} days until 18`
                : 'By age 18';
              pushRow(member, cpStatus.basic, 'due-soon', 'Eligible', daysText, dueDate, daysUntil);
            }
          });

            return rows.sort((a, b) => {
              const severityDelta = (severityMap[b.statusKey] || 0) - (severityMap[a.statusKey] || 0);
              if (severityDelta !== 0) return severityDelta;
              return (a.daysSort || 0) - (b.daysSort || 0);
            });
          };

          const generateTlcComplianceReport = (membersOverride = null) => {
            const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
            const seniorsOnly = memberPool.filter(m => {
              const type = String(m.Type || m.TYPE || '').toUpperCase();
              return type === 'SENIOR' || type === 'LIFE';
            });
            const requiredCount = 2;
            const specialUnits = new Set(['000', '999']);
            const statusOrder = { missing: 0, expired: 1, 'due-soon': 2, current: 3 };
            const statusLabelMap = {
              current: 'Current',
              'due-soon': 'Due Soon',
              expired: 'Expired',
              missing: 'Missing'
            };
            const getUnitInfo = (orgId) => {
              const org = (dataFiles.organization || []).find(o => String(o.ORGID || '').trim() === String(orgId || '').trim());
              const unitNum = org && org.Unit ? org.Unit.replace(/^0+/, '').padStart(3, '0') : '';
              const unitType = String(org?.Type || '').toUpperCase();
              return { unitNum, unitType };
            };
            const summarizeDuties = (duties = []) => {
              if (!duties.length) return { summary: 'None', full: 'None' };
              const trimmed = duties.filter(Boolean).map(duty => String(duty).trim()).filter(Boolean);
              if (!trimmed.length) return { summary: 'None', full: 'None' };
              const shortList = trimmed.slice(0, 2);
              const summary = trimmed.length > 2
                ? `${shortList.join(', ')} +${trimmed.length - 2} more`
                : shortList.join(', ');
              return { summary, full: trimmed.join(', ') };
            };

            const buildMemberRow = (member) => {
              const tlc = getTlcStatus(member);
              const statusKey = tlc ? tlc.status : 'missing';
              const statusLabel = statusLabelMap[statusKey] || 'Missing';
              const dutyNames = (member.duties || []).map(d => d.displayName || d.name).filter(Boolean);
              const dutySummary = summarizeDuties(dutyNames);
              const isQualified = !!(tlc && tlc.status !== 'expired');
              const unitInfo = getUnitInfo(member.ORGID);

              return {
                capid: member.CAPID,
                memberName: `${member.NameLast}, ${member.NameFirst}`,
                unit: member.memberUnitName || 'Unknown',
                unitNum: unitInfo.unitNum || '',
                unitType: unitInfo.unitType || '',
                rank: member.Rank || 'N/A',
                dutySummary: dutySummary.summary,
                dutyFull: dutySummary.full,
                course: tlc ? (tlc.course || 'TLC') : 'None',
                status: statusLabel,
                statusKey,
                completed: tlc ? formatShortDate(tlc.completed) : 'N/A',
                expiration: tlc ? formatShortDate(tlc.expirationDate) : 'N/A',
                daysText: tlc ? tlc.daysText : 'N/A',
                isQualified
              };
            };

            if (!seniorsOnly.length) {
              return { rows: [], meta: { view: showAllDescendants ? 'unit-summary' : 'individual', required: requiredCount } };
            }

            if (showAllDescendants) {
              const unitMap = new Map();
              seniorsOnly.forEach(member => {
                const unit = member.memberUnitName || 'Unknown';
                const unitInfo = getUnitInfo(member.ORGID);
                if (!unitMap.has(unit)) {
                  unitMap.set(unit, {
                    unit,
                    unitNum: unitInfo.unitNum || '',
                    unitType: unitInfo.unitType || '',
                    totalMembers: 0,
                    current: 0,
                    dueSoon: 0,
                    expired: 0,
                    missing: 0
                  });
                }
                const bucket = unitMap.get(unit);
                bucket.totalMembers += 1;
                const tlc = getTlcStatus(member);
                const statusKey = tlc ? tlc.status : 'missing';
                if (statusKey === 'current') bucket.current += 1;
                else if (statusKey === 'due-soon') bucket.dueSoon += 1;
                else if (statusKey === 'expired') bucket.expired += 1;
                else bucket.missing += 1;
              });

              const rows = Array.from(unitMap.values()).map(row => {
                const qualified = row.current + row.dueSoon;
                const isGroup = row.unitType.includes('GROUP');
                const isSpecialUnit = specialUnits.has(row.unitNum);
                const isExempt = isGroup || isSpecialUnit;
                const isCompliant = isExempt ? true : qualified >= requiredCount;
                return {
                  unit: row.unit,
                  qualified,
                  required: isExempt ? 0 : requiredCount,
                  compliance: isExempt ? 'Exempt' : isCompliant ? 'Compliant' : 'Needs TLC',
                  complianceStatus: isExempt ? 'exempt' : isCompliant ? 'compliant' : 'non-compliant',
                  current: row.current,
                  dueSoon: row.dueSoon,
                  expired: row.expired,
                  missing: row.missing,
                  totalMembers: row.totalMembers,
                  unitNum: row.unitNum,
                  unitType: row.unitType
                };
              }).sort((a, b) => {
                if (a.complianceStatus !== b.complianceStatus) {
                  const order = { 'non-compliant': 0, exempt: 1, compliant: 2 };
                  return (order[a.complianceStatus] || 0) - (order[b.complianceStatus] || 0);
                }
                if (b.qualified !== a.qualified) return b.qualified - a.qualified;
                return a.unit.localeCompare(b.unit);
              });

              return { rows, meta: { view: 'unit-summary', required: requiredCount } };
            }

            const rows = seniorsOnly.map(buildMemberRow).sort((a, b) => {
              const statusDelta = (statusOrder[a.statusKey] || 0) - (statusOrder[b.statusKey] || 0);
              if (statusDelta !== 0) return statusDelta;
              return a.memberName.localeCompare(b.memberName);
            });

            const scopeInfo = getUnitInfo(unitFilter);
            const scopeIsGroup = scopeInfo.unitType.includes('GROUP');
            const scopeIsSpecial = specialUnits.has(scopeInfo.unitNum);
            const scopeIsExempt = scopeIsGroup || scopeIsSpecial;

            return { rows, meta: { view: 'individual', required: scopeIsExempt ? 0 : requiredCount, isExempt: scopeIsExempt } };
          };

        // Cadet Report: Aerospace Education Modules/Tests Completion
        const generateAerospaceEducationReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length) return [];

        const cadets = memberPool.filter(m => {
          const memberType = (m.Type || m.TYPE || '').toUpperCase();
          return memberType === 'CADET';
        });

          const rows = [];

          const normalizeDateValue = (dateString) => {
            if (!dateString) return null;
            const normalized = `${dateString}`.trim();
            if (!normalized || normalized === '01/01/1900' || normalized === '1900-01-01') return null;
            return normalized;
          };

          const selectBestModuleTask = (tasks = []) => {
            if (!tasks.length) return null;
            const taskWithDates = tasks.find(t => {
              const opts = parseAdditionalOptions(t.AdditionalOptions);
              return normalizeDateValue(opts.DateResult) || normalizeDateValue(opts.CadetInteractiveDate);
            });
            return taskWithDates || tasks[0];
          };

          cadets.forEach(cadet => {
            const capid = String(cadet.CAPID).trim();
            const achievements = dataFiles.cadetAchv.filter(a => String(a.CAPID).trim() === capid);
            const memberTasks = dataFiles.memberTasks.filter(mt => String(mt.CAPID).trim() === capid);

            const rowData = {
              capid: cadet.CAPID,
              memberName: `${cadet.NameLast}, ${cadet.NameFirst}`,
              unit: cadet.memberUnitName,
              rank: cadet.Rank,
              phase: cadet.CadetAchvID ? (parseInt(cadet.CadetAchvID) <= 9 ? 'Phase 1 or 2' : 'Phase 3+') : 'N/A'
            };

            let totalHonorCredits = 0;

            // Process each of the 7 modules
            AEROSPACE_DIMENSIONS_MODULES.forEach(module => {
              const moduleTasks = memberTasks.filter(mt =>
                mt.TaskID === module.taskId && mt.StatusID === '8'
              );
              const primaryTask = selectBestModuleTask(moduleTasks);
              const options = primaryTask ? parseAdditionalOptions(primaryTask.AdditionalOptions) : {};
              const achvRecord = achievements.find(a => a.CadetAchvID === module.achievementId);

              const interactiveDate = normalizeDateValue(options.CadetInteractiveDate) ||
                normalizeDateValue(primaryTask && primaryTask.Completed);
              const interactiveScore = options.CadetInteractiveScore !== undefined && options.CadetInteractiveScore !== null
                ? Number(options.CadetInteractiveScore)
                : null;
              const interactiveCompleted = !!(primaryTask && primaryTask.StatusID === '8' && (interactiveDate || options.CadetInteractive === true || Number.isFinite(interactiveScore)));

              const taskTestScoreRaw = options.ScoreResult;
              const taskTestScore = taskTestScoreRaw !== undefined && taskTestScoreRaw !== null && taskTestScoreRaw !== ''
                ? Number(taskTestScoreRaw)
                : null;
              const testScore = Number.isFinite(taskTestScore)
                ? taskTestScore
                : (achvRecord && achvRecord.AEScore ? parseInt(achvRecord.AEScore) : 0);
              const testDate = normalizeDateValue(options.DateResult) ||
                normalizeDateValue(achvRecord && achvRecord.AEDateP);
              const testCompleted = testScore >= CADET_MIN_TEST_SCORE && !!testDate;

              // Determine honor credit
              const honorCredit = interactiveCompleted && testCompleted;
              if (honorCredit) totalHonorCredits++;

              // Store module data in flattened format
              rowData[`module${module.moduleNum}`] = {
                moduleNum: module.moduleNum,
                achievementName: module.title,
                interactiveCompleted: interactiveCompleted,
                interactiveDate: interactiveDate,
                testCompleted: testCompleted,
                testScore: testScore,
                testDate: testDate,
                honorCredit: honorCredit
              };
            });

            rowData.totalHonorCredits = totalHonorCredits;
            rows.push(rowData);
          });

          return rows.sort((a, b) => a.memberName.localeCompare(b.memberName));
        };

        // Cadet Report: Encampment Completion Status
        const generateEncampmentReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length) return [];

          const cadets = memberPool.filter(m => {
            const memberType = (m.Type || m.TYPE || '').toUpperCase();
            return memberType === 'CADET';
          });

          const rows = [];

          cadets.forEach(cadet => {
            const activities = dataFiles.cadetActivities ? dataFiles.cadetActivities.filter(a =>
              String(a.CAPID).trim() === String(cadet.CAPID).trim() &&
              (a.Type || '').toUpperCase().includes('ENCAMP')
            ) : [];

            const encampments = activities.map(a => ({
              type: a.Type,
              location: a.Location || 'N/A',
              completed: a.Completed || 'N/A'
            }));

            rows.push({
              capid: cadet.CAPID,
              memberName: `${cadet.NameLast}, ${cadet.NameFirst}`,
              unit: cadet.memberUnitName,
              rank: cadet.Rank,
              encampmentStatus: encampments.length > 0 ? 'Completed' : 'Not Completed',
              completionDate: encampments.length > 0 ? (encampments[0].completed || 'N/A') : 'N/A',
              hasEncampment: encampments.length > 0,
              encampments,
              count: encampments.length
            });
          });

          return rows.sort((a, b) => {
            if (a.hasEncampment !== b.hasEncampment) return a.hasEncampment ? 1 : -1;
            return a.memberName.localeCompare(b.memberName);
          });
        };

        // Cadet Report: Orientation Flights Status
        const generateOFlightReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length) return [];

          const cadets = memberPool.filter(m => {
            const memberType = (m.Type || m.TYPE || '').toUpperCase();
            return memberType === 'CADET';
          });

          const oFlights = dataFiles.oFlights || [];

          // Powered flight syllabi (6-10)
          const poweredSyllabi = [
            { num: 6, name: 'Ground Handling', short: 'Ground' },
            { num: 7, name: 'Normal Maneuvers', short: 'Normal' },
            { num: 8, name: 'Advanced Maneuvers', short: 'Advanced' },
            { num: 9, name: 'Instruments', short: 'Instruments' },
            { num: 10, name: 'Weather', short: 'Weather' }
          ];

          const rows = [];

          cadets.forEach(cadet => {
            const cadetFlights = oFlights.filter(f =>
              String(f.CAPID || '').trim() === String(cadet.CAPID).trim()
            );

            // Get flights for each syllabus
            const syllabusData = {};
            let totalPoweredFlights = 0;
            let completedSyllabi = 0;

            poweredSyllabi.forEach(syllabus => {
              const flights = cadetFlights.filter(f => parseInt(f.Syllabus) === syllabus.num);
              const latestFlight = flights.sort((a, b) => new Date(b.FltDate) - new Date(a.FltDate))[0];
              syllabusData[`syllabus${syllabus.num}`] = {
                completed: flights.length > 0,
                date: latestFlight?.FltDate || null,
                count: flights.length
              };
              totalPoweredFlights += flights.length;
              if (flights.length > 0) completedSyllabi++;
            });

            // Calculate age from DOB
            let age = null;
            if (cadet.DOB) {
              const dob = parseDateSafe(cadet.DOB);
              if (dob) {
                const today = new Date();
                age = Math.floor((today - dob) / (1000 * 60 * 60 * 24 * 365.25));
              }
            }

            // Back seat rides (syllabus 99)
            const backSeatRides = cadetFlights.filter(f => parseInt(f.Syllabus) === 99).length;

            const hasAnyFlight = totalPoweredFlights > 0 || backSeatRides > 0;

            rows.push({
              capid: cadet.CAPID,
              memberName: `${cadet.NameLast}, ${cadet.NameFirst}`,
              unit: cadet.memberUnitName,
              joinDate: cadet.Joined || 'N/A',
              age: age !== null ? age : 'N/A',
              hasAnyFlight,
              totalPoweredFlights,
              backSeatRides,
              completedSyllabi,
              ...syllabusData
            });
          });

          // Sort: cadets with NO flights first (highlighted), then by name
          return rows.sort((a, b) => {
            if (a.hasAnyFlight !== b.hasAnyFlight) return a.hasAnyFlight ? 1 : -1;
            return a.memberName.localeCompare(b.memberName);
          });
        };

        // Cadet Report: Recent Promotions (30/60 Days)
        const generateRecentPromotionsReport = (membersOverride = null, days = 60) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length || !dataFiles.cadetRank.length) return [];

          const cadets = memberPool.filter(m => {
            const memberType = (m.Type || m.TYPE || '').toUpperCase();
            return memberType === 'CADET';
          });

          const rows = [];
          const today = new Date();

          cadets.forEach(cadet => {
            const cadetRanks = dataFiles.cadetRank
              .filter(r => String(r.CAPID).trim() === String(cadet.CAPID).trim())
              .sort((a, b) => new Date(b.RankDate) - new Date(a.RankDate));

            if (cadetRanks.length === 0) return;

            const lastPromotion = cadetRanks[0];
            const rankDate = new Date(lastPromotion.RankDate);
            const daysSincePromotion = Math.floor((today - rankDate) / (1000 * 60 * 60 * 24));

            if (daysSincePromotion >= 0 && daysSincePromotion <= days) {
              const previousRank = cadetRanks[1] ? cadetRanks[1].Rank : 'N/A';

              rows.push({
                capid: cadet.CAPID,
                memberName: `${cadet.NameLast}, ${cadet.NameFirst}`,
                unit: cadet.memberUnitName,
                rank: lastPromotion.Rank,
                promotionDate: lastPromotion.RankDate,
                previousRank,
                currentRank: lastPromotion.Rank,
                daysSincePromotion,
                timeframe: daysSincePromotion <= 30 ? '30-day' : '60-day'
              });
            }
          });

          return rows.sort((a, b) => a.daysSincePromotion - b.daysSincePromotion);
        };

        // Cadet Report: Promotion Requirements Table
        const generatePromotionRequirementsReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length) return [];

          const cadets = memberPool.filter(m => {
            const memberType = (m.Type || m.TYPE || '').toUpperCase();
            return memberType === 'CADET';
          });

          const requirementGroups = {
            leadership: ['leadershipTest', 'wrightBrothersLeadershipExam', 'mitchellLeadershipExam', 'earhartLeadershipExam', 'spaatzLeadershipExam'],
            aerospace: ['aerospaceTest', 'mitchellAerospaceExam', 'spaatzJOFExam'],
            fitness: ['physicalFitness', 'spaatzCFA'],
            character: ['characterDevelopment', 'cadetOath', 'leadershipExpectations', 'leadershipFeedback', 'uniformWear'],
            activity: ['activeParticipation', 'cadetWingmanCourse', 'encampment', 'cls', 'eakerSpeech', 'eakerEssay', 'spaatzEssay', 'drillTest', 'sdaService', 'sdaPresentation', 'sdaWriting']
          };

          const summarizeRequirementGroup = (requirements, keys) => {
            if (!requirements) return null;
            const applicable = keys.filter(key => requirements[key]);
            if (!applicable.length) return null;
            return applicable.every(key => requirements[key].completed);
          };

          const buildRequirementDetails = (requirements, orderedKeys = []) => {
            if (!requirements) return [];
            const keys = [];
            const seen = new Set();
            orderedKeys.forEach(key => {
              if (requirements[key]) {
                keys.push(key);
                seen.add(key);
              }
            });
            Object.keys(requirements).forEach(key => {
              if (!seen.has(key)) keys.push(key);
            });
            return keys.map(key => {
              const req = requirements[key];
              if (!req) return null;
              return {
                key,
                label: req.label || CADET_REQUIREMENT_LABELS[key] || key,
                completed: !!req.completed,
                value: req.value || ''
              };
            }).filter(Boolean);
          };

          const buildFallbackRequirementDetails = (summary) => {
            if (!summary) return [];
            return [
              { key: 'leadership', label: 'Leadership', completed: !!summary.leadership, value: '' },
              { key: 'aerospace', label: 'Aerospace', completed: !!summary.aerospace, value: '' },
              { key: 'fitness', label: 'Physical Fitness', completed: !!summary.fitness, value: '' },
              { key: 'character', label: 'Character Development', completed: !!summary.character, value: '' },
              { key: 'activity', label: 'Active Participation', completed: !!summary.activity, value: '' }
            ];
          };

          const formatRequirementDetail = (detail) => {
            if (!detail) return '';
            const label = detail.label || detail.key;
            if (detail.value) return `${label}: ${detail.value}`;
            return `${label}: ${detail.completed ? 'Completed' : 'Not completed'}`;
          };

          const getPhaseLabel = (achievementId) => {
            const phaseId = determinePhaseFromAchievement(achievementId);
            if (!phaseId) return 'Phase I';
            const phaseName = CADET_PHASES[phaseId]?.name || `Phase ${phaseId}`;
            return phaseName.split('(')[0].trim();
          };

          const getCurrentAchievementId = (cadet) => {
            const current = parseInt(cadet.currentAchievement);
            if (!isNaN(current)) return current;

            const approved = Array.isArray(cadet.approvedAchievements) ? cadet.approvedAchievements : [];
            if (approved.length) {
              const parsed = approved.map(a => parseInt(a)).filter(a => !isNaN(a));
              if (parsed.length) return Math.max(...parsed);
            }

            if (cadetDataService && typeof cadetDataService.getApprovedAchievements === 'function') {
              const serviceApproved = cadetDataService.getApprovedAchievements(cadet.CAPID) || [];
              if (serviceApproved.length) return Math.max(...serviceApproved);
            }

            if (dataFiles.cadetAchv && dataFiles.cadetAchv.length) {
              const achievements = dataFiles.cadetAchv.filter(a => String(a.CAPID).trim() === String(cadet.CAPID).trim());
              const completedAchievements = achievements.filter(a =>
                a.PhyFitTest && a.PhyFitTest !== '01/01/1900' &&
                a.LeadLabDateP && a.LeadLabDateP !== '01/01/1900' &&
                a.ActivePart && String(a.ActivePart).toUpperCase() === 'TRUE'
              );
              if (completedAchievements.length > 0) {
                return Math.max(...completedAchievements.map(a => parseInt(a.CadetAchvID) || 0));
              }
            }

            return 0;
          };

          const rows = [];

          cadets.forEach(cadet => {
            const capid = cadet.CAPID;
            const currentAchievementId = getCurrentAchievementId(cadet);
            let nextAchievementId = currentAchievementId + 1;
            if (nextAchievementId > 21) nextAchievementId = null;

            const requirementsData = cadet.nextRequirements
              || (cadetDataService && nextAchievementId
                ? cadetDataService.getAchievementRequirements(capid, String(nextAchievementId), cadet.timeInGrade || null)
                : null);

            const requirementMap = requirementsData && requirementsData.requirements ? requirementsData.requirements : null;
            const requirementKeys = nextAchievementId
              ? (CADET_ACHIEVEMENT_REQUIREMENTS[String(nextAchievementId)] || CADET_DEFAULT_REQUIREMENTS)
              : [];

            let fallbackSummary = null;
            if (!requirementMap && nextAchievementId && dataFiles.cadetAchv && dataFiles.cadetAchv.length) {
              const achievements = dataFiles.cadetAchv.filter(a => String(a.CAPID).trim() === String(cadet.CAPID).trim());
              const nextAchvData = achievements.find(a => parseInt(a.CadetAchvID) === nextAchievementId);
              if (nextAchvData) {
                fallbackSummary = {
                  leadership: nextAchvData.LeadLabDateP && nextAchvData.LeadLabDateP !== '01/01/1900',
                  aerospace: nextAchvData.AEDateP && nextAchvData.AEDateP !== '01/01/1900',
                  fitness: nextAchvData.PhyFitTest && nextAchvData.PhyFitTest !== '01/01/1900',
                  character: nextAchvData.MoralLDateP && nextAchvData.MoralLDateP !== '01/01/1900',
                  activity: nextAchvData.ActivePart && String(nextAchvData.ActivePart).toUpperCase() === 'TRUE'
                };
              }
            }

            const requirementDetails = requirementMap
              ? buildRequirementDetails(requirementMap, requirementKeys)
              : buildFallbackRequirementDetails(fallbackSummary);

            const leadership = requirementMap
              ? summarizeRequirementGroup(requirementMap, requirementGroups.leadership)
              : (fallbackSummary ? fallbackSummary.leadership : null);
            const aerospace = requirementMap
              ? summarizeRequirementGroup(requirementMap, requirementGroups.aerospace)
              : (fallbackSummary ? fallbackSummary.aerospace : null);
            const fitness = requirementMap
              ? summarizeRequirementGroup(requirementMap, requirementGroups.fitness)
              : (fallbackSummary ? fallbackSummary.fitness : null);
            const character = requirementMap
              ? summarizeRequirementGroup(requirementMap, requirementGroups.character)
              : (fallbackSummary ? fallbackSummary.character : null);
            const activity = requirementMap
              ? summarizeRequirementGroup(requirementMap, requirementGroups.activity)
              : (fallbackSummary ? fallbackSummary.activity : null);

            let progressLabel = 'N/A';
            let percentComplete = 0;
            if (!nextAchievementId) {
              progressLabel = 'Complete';
              percentComplete = 100;
            } else if (requirementMap) {
              const requirementEntries = Object.values(requirementMap);
              const total = requirementEntries.length;
              const completed = requirementEntries.filter(r => r.completed).length;
              progressLabel = total ? `${completed}/${total}` : 'N/A';
              percentComplete = total ? Math.round((completed / total) * 100) : 0;
            } else if (fallbackSummary) {
              const summaryValues = Object.values(fallbackSummary).filter(v => v !== null && v !== undefined);
              const total = summaryValues.length;
              const completed = summaryValues.filter(Boolean).length;
              progressLabel = total ? `${completed}/${total}` : 'N/A';
              percentComplete = total ? Math.round((completed / total) * 100) : 0;
            }

            const currentLabel = currentAchievementId > 0
              ? getAchievementDisplayName(currentAchievementId)
              : 'Not Started';
            const nextLabel = nextAchievementId
              ? getAchievementDisplayName(nextAchievementId)
              : 'Completed All';

            const requirementsDetailMessage = requirementDetails.length
              ? ''
              : (nextAchievementId ? 'Requirement details unavailable' : 'All achievements complete');
            const requirementsDetailText = requirementDetails.length
              ? requirementDetails.map(formatRequirementDetail).join('\n')
              : requirementsDetailMessage;

            rows.push({
              capid,
              memberName: `${cadet.NameLast}, ${cadet.NameFirst}`,
              unit: cadet.memberUnitName || cadet.Unit || 'Unknown',
              rank: cadet.currentRank || cadet.Rank || 'N/A',
              currentAchievement: currentLabel,
              currentPhase: currentAchievementId > 0 ? getPhaseLabel(currentAchievementId) : 'Phase I',
              nextAchievement: nextLabel,
              nextPhase: nextAchievementId ? getPhaseLabel(nextAchievementId) : 'Complete',
              leadership,
              aerospace,
              fitness,
              character,
              activity,
              requirementsDetails: requirementDetails,
              requirementsDetailText,
              requirementsDetailMessage,
              progress: progressLabel,
              percentComplete
            });
          });

          return rows.sort((a, b) => a.memberName.localeCompare(b.memberName));
        };

        // Cadet Report: Approaching Age Milestones (18 and 21)
        const generateApproachingAgeMilestoneReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : processedData;
          if (!memberPool.length) return [];

          const cadets = memberPool.filter(m => {
            const memberType = (m.Type || m.TYPE || '').toUpperCase();
            return memberType === 'CADET';
          });

          const rows = [];
          const today = new Date();
          const sixMonthsDays = 180;

          cadets.forEach(cadet => {
            const dob = parseDateSafe(cadet.DOB);
            if (!dob) return;

            // Calculate current age
            const currentAge = Math.floor((today - dob) / (1000 * 60 * 60 * 24 * 365.25));

            // Check age 18 milestone
            const age18Date = new Date(dob);
            age18Date.setFullYear(age18Date.getFullYear() + 18);
            const daysUntil18 = Math.ceil((age18Date - today) / (1000 * 60 * 60 * 24));

            if (daysUntil18 > 0 && daysUntil18 <= sixMonthsDays) {
              const monthsUntil = Math.floor(daysUntil18 / 30);
              const weeksUntil = Math.floor(daysUntil18 / 7);
              rows.push({
                capid: cadet.CAPID,
                memberName: `${cadet.NameLast}, ${cadet.NameFirst}`,
                unit: cadet.memberUnitName,
                rank: cadet.Rank,
                milestone: 18,
                milestoneLabel: 'Age 18',
                dob: formatShortDate(dob),
                currentAge,
                milestoneDate: formatShortDate(age18Date),
                daysUntil: daysUntil18,
                monthsUntil,
                weeksUntil,
                urgency: daysUntil18 <= 30 ? 'critical' : daysUntil18 <= 90 ? 'warning' : 'notice',
                significance: 'Transition to Senior Member eligibility'
              });
            }

            // Check age 21 milestone
            const age21Date = new Date(dob);
            age21Date.setFullYear(age21Date.getFullYear() + 21);
            const daysUntil21 = Math.ceil((age21Date - today) / (1000 * 60 * 60 * 24));

            if (daysUntil21 > 0 && daysUntil21 <= sixMonthsDays) {
              const monthsUntil = Math.floor(daysUntil21 / 30);
              const weeksUntil = Math.floor(daysUntil21 / 7);
              rows.push({
                capid: cadet.CAPID,
                memberName: `${cadet.NameLast}, ${cadet.NameFirst}`,
                unit: cadet.memberUnitName,
                rank: cadet.Rank,
                milestone: 21,
                milestoneLabel: 'Age 21',
                dob: formatShortDate(dob),
                currentAge,
                milestoneDate: formatShortDate(age21Date),
                daysUntil: daysUntil21,
                monthsUntil,
                weeksUntil,
                urgency: daysUntil21 <= 30 ? 'critical' : daysUntil21 <= 90 ? 'warning' : 'notice',
                significance: 'Maximum cadet program age'
              });
            }
          });

          // Sort by days until milestone (most urgent first), then by milestone age
          return rows.sort((a, b) => {
            if (a.daysUntil !== b.daysUntil) return a.daysUntil - b.daysUntil;
            return a.milestone - b.milestone;
          });
        };

        // QCUA (Quality Cadet Unit Award) Report Generator
        // Award cycle: 31 August to 31 August following year
        // Units with 10+ cadets that meet at least 6 of 10 criteria earn the award
        const generateQCUAReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : [...(processedData || []), ...(processedCadets || [])];
          if (!memberPool.length) return { rows: [], meta: {} };

          // Award cycle dates (configurable - currently 2025-2026 cycle)
          const cycleStartStr = '2025-08-31';
          const cycleEndStr = '2026-08-31';
          const cycleStart = new Date(cycleStartStr);
          const cycleEnd = new Date(cycleEndStr);
          const today = new Date();

          // Helper to get unit info
          const getUnitInfo = (orgId) => {
            const org = (dataFiles.organization || []).find(o => String(o.ORGID || '').trim() === String(orgId || '').trim());
            const unitNum = org && org.Unit ? org.Unit.replace(/^0+/, '').padStart(3, '0') : '';
            const unitType = String(org?.Type || '').toUpperCase();
            const region = org?.Region || '';
            const wing = org?.Wing || '';
            return { unitNum, unitType, region, wing, orgName: org?.Name || '' };
          };

          // Build unit-based groupings
          const unitMap = new Map();

          // Separate cadets and seniors
          const cadets = memberPool.filter(m => {
            const type = String(m.Type || m.TYPE || '').toUpperCase();
            return type === 'CADET';
          });
          const seniors = memberPool.filter(m => {
            const type = String(m.Type || m.TYPE || '').toUpperCase();
            return type === 'SENIOR' || type === 'LIFE';
          });

          // Group cadets by unit
          cadets.forEach(cadet => {
            const unitName = cadet.memberUnitName || 'Unknown';
            if (!unitMap.has(unitName)) {
              const unitInfo = getUnitInfo(cadet.ORGID);
              unitMap.set(unitName, {
                unitName,
                unitInfo,
                cadets: [],
                seniors: []
              });
            }
            unitMap.get(unitName).cadets.push(cadet);
          });

          // Add seniors to their units
          seniors.forEach(senior => {
            const unitName = senior.memberUnitName || 'Unknown';
            if (!unitMap.has(unitName)) {
              const unitInfo = getUnitInfo(senior.ORGID);
              unitMap.set(unitName, {
                unitName,
                unitInfo,
                cadets: [],
                seniors: []
              });
            }
            unitMap.get(unitName).seniors.push(senior);
          });

          // Calculate QCUA criteria for each unit
          const rows = [];

          unitMap.forEach((unitData, unitName) => {
            const { unitInfo } = unitData;
            const unitType = (unitInfo?.unitType || '').toUpperCase();
            const unitNum = unitInfo?.unitNum || '';

            // Skip units that are not eligible for QCUA:
            // - Senior Squadrons/Flights (no cadet program)
            // - Groups, Wings, Regions, National HQ (higher echelon)
            // - Units with charter numbers 000 or 999 (special/placeholder units)
            const isSeniorUnit = unitType.includes('SENIOR');
            const isHigherHQ = unitType.includes('GROUP') || unitType.includes('WING') ||
                               unitType.includes('REGION') || unitType.includes('NATIONAL');
            const isSpecialUnit = unitNum === '000' || unitNum === '999';

            if (isSeniorUnit || isHigherHQ || isSpecialUnit) {
              return; // Skip this unit
            }

            const unitCadets = unitData.cadets;
            const unitSeniors = unitData.seniors;
            const totalCadets = unitCadets.length;

            // Check eligibility: need 10+ cadets
            const isEligible = totalCadets >= 10;

            // 1. Cadet Achievement: 45% Wright Brothers (achievement 4+)
            const wrightBrothersCount = unitCadets.filter(c => {
              const approvedAchvs = c.approvedAchievements || [];
              const maxAchv = approvedAchvs.length > 0 ? Math.max(...approvedAchvs) : 0;
              return maxAchv >= 4;
            }).length;
            const wrightBrothersPercent = totalCadets > 0 ? Math.round((wrightBrothersCount / totalCadets) * 100) : 0;
            const wrightBrothersMet = wrightBrothersPercent >= 45;

            // 2. Encampment: 50% graduated
            const encampmentCount = unitCadets.filter(c => {
              // Check from cadet activities
              const activities = (dataFiles.cadetActivities || []).filter(a =>
                String(a.CAPID).trim() === String(c.CAPID).trim() &&
                (a.Type || '').toUpperCase().includes('ENCAMP') &&
                a.Completed && a.Completed !== '01/01/1900'
              );
              return activities.length > 0;
            }).length;
            const encampmentPercent = totalCadets > 0 ? Math.round((encampmentCount / totalCadets) * 100) : 0;
            const encampmentMet = encampmentPercent >= 50;

            // 3. Enrollment: 25+ cadets
            const enrollmentMet = totalCadets >= 25;

            // 4. Emergency Services: 60% GES certification
            const gesCount = unitCadets.filter(c => {
              const esQuals = c.esQualificationsAll || c.esQualifications || [];
              return esQuals.some(q => q.achvID === '53' && q.status === 'Active');
            }).length;
            const gesPercent = totalCadets > 0 ? Math.round((gesCount / totalCadets) * 100) : 0;
            const gesMet = gesPercent >= 60;

            // 5. Onboarding: 70% of new cadets (joined during cycle) earned Achievement 1 in 8 weeks
            const newCadets = unitCadets.filter(c => {
              if (!c.Joined) return false;
              const joinDate = parseDateSafe(c.Joined);
              return joinDate && joinDate >= cycleStart && joinDate <= cycleEnd;
            });
            const onboardingSuccessCount = newCadets.filter(c => {
              const joinDate = parseDateSafe(c.Joined);
              if (!joinDate) return false;

              // Find Achievement 1 approval date
              const achv1Approval = (dataFiles.cadetAchvAprs || []).find(a =>
                String(a.CAPID).trim() === String(c.CAPID).trim() &&
                String(a.CadetAchvID).trim() === '1' &&
                a.Status === 'APR'
              );

              if (!achv1Approval) return false;

              const achv1Date = parseDateSafe(achv1Approval.DateCreated || achv1Approval.DateMod);
              if (!achv1Date) return false;

              // Calculate weeks between join and Achievement 1
              const daysDiff = Math.floor((achv1Date - joinDate) / (1000 * 60 * 60 * 24));
              return daysDiff <= 56; // 8 weeks = 56 days
            }).length;
            const onboardingPercent = newCadets.length > 0 ? Math.round((onboardingSuccessCount / newCadets.length) * 100) : null;
            const onboardingMet = newCadets.length === 0 ? null : onboardingPercent >= 70;

            // 6. Orientation Flights: 70% first flight credit (any syllabus completed)
            const oFlights = dataFiles.oFlights || [];
            const firstFlightCount = unitCadets.filter(c => {
              const cadetFlights = oFlights.filter(f =>
                String(f.CAPID || '').trim() === String(c.CAPID).trim()
              );
              return cadetFlights.length > 0;
            }).length;
            const firstFlightPercent = totalCadets > 0 ? Math.round((firstFlightCount / totalCadets) * 100) : 0;
            const firstFlightMet = firstFlightPercent >= 70;

            // 7. TLC Graduates: 3+ current TLC senior members
            const tlcCount = unitSeniors.filter(s => {
              const tlcStatus = getTlcStatus(s);
              return tlcStatus && (tlcStatus.status === 'current' || tlcStatus.status === 'due-soon');
            }).length;
            const tlcMet = tlcCount >= 3;

            // Non-trackable criteria (always null)
            const aerospaceMet = null; // AEX/STEM Kit - not trackable
            const localActionMet = null; // Community engagement - not trackable
            const stemTeamMet = null; // STEM activities - not trackable

            // Calculate total criteria met
            const trackableCriteria = [
              wrightBrothersMet,
              encampmentMet,
              enrollmentMet,
              gesMet,
              onboardingMet,
              firstFlightMet,
              tlcMet
            ];
            const criteriaMet = trackableCriteria.filter(c => c === true).length;
            const criteriaNotMet = trackableCriteria.filter(c => c === false).length;
            const criteriaUnknown = trackableCriteria.filter(c => c === null).length + 3; // +3 for non-trackable

            // Award status
            // Need 6 of 10 criteria - with 3 non-trackable, we can confirm if:
            // - criteriaMet >= 6 -> Eligible (definitely meets requirement)
            // - criteriaMet + criteriaUnknown < 6 -> Not Eligible (can't meet requirement even with unknowns)
            // - Otherwise -> Potentially Eligible (depends on non-trackable criteria)
            let awardStatus = 'Not Eligible';
            if (!isEligible) {
              awardStatus = 'Ineligible (< 10 cadets)';
            } else if (criteriaMet >= 6) {
              awardStatus = 'On Track';
            } else if (criteriaMet + criteriaUnknown >= 6) {
              awardStatus = 'Potentially Eligible';
            } else {
              awardStatus = 'Not On Track';
            }

            rows.push({
              unitName,
              unitInfo: unitData.unitInfo,
              totalCadets,
              totalSeniors: unitSeniors.length,
              isEligible,
              awardStatus,
              criteriaMet,
              criteriaNotMet,
              criteriaUnknown,
              criteria: {
                cadetAchievement: {
                  name: 'Cadet Achievement',
                  description: '45% Wright Brothers Award',
                  count: wrightBrothersCount,
                  total: totalCadets,
                  percent: wrightBrothersPercent,
                  threshold: 45,
                  met: wrightBrothersMet,
                  trackable: true
                },
                encampment: {
                  name: 'Encampment',
                  description: '50% encampment graduates',
                  count: encampmentCount,
                  total: totalCadets,
                  percent: encampmentPercent,
                  threshold: 50,
                  met: encampmentMet,
                  trackable: true
                },
                enrollment: {
                  name: 'Enrollment',
                  description: '25+ cadets on roster',
                  count: totalCadets,
                  total: null,
                  percent: null,
                  threshold: 25,
                  met: enrollmentMet,
                  trackable: true,
                  isCountBased: true
                },
                emergencyServices: {
                  name: 'Emergency Services',
                  description: '60% GES certified',
                  count: gesCount,
                  total: totalCadets,
                  percent: gesPercent,
                  threshold: 60,
                  met: gesMet,
                  trackable: true
                },
                onboarding: {
                  name: 'Onboarding',
                  description: '70% new cadets earn Achv 1 in 8 weeks',
                  count: onboardingSuccessCount,
                  total: newCadets.length,
                  percent: onboardingPercent,
                  threshold: 70,
                  met: onboardingMet,
                  trackable: true,
                  noNewCadets: newCadets.length === 0
                },
                orientationFlights: {
                  name: 'Orientation Flights',
                  description: '70% first flight credit',
                  count: firstFlightCount,
                  total: totalCadets,
                  percent: firstFlightPercent,
                  threshold: 70,
                  met: firstFlightMet,
                  trackable: true
                },
                tlcGraduates: {
                  name: 'TLC Graduates',
                  description: '3+ TLC-qualified seniors',
                  count: tlcCount,
                  total: unitSeniors.length,
                  percent: null,
                  threshold: 3,
                  met: tlcMet,
                  trackable: true,
                  isCountBased: true
                },
                aerospace: {
                  name: 'Aerospace',
                  description: 'AEX Completion or STEM Kit',
                  count: null,
                  total: null,
                  percent: null,
                  threshold: null,
                  met: aerospaceMet,
                  trackable: false,
                  notTrackableReason: 'No data available in downloads'
                },
                localAction: {
                  name: 'Local Action',
                  description: '4 community events with 4+ cadets',
                  count: null,
                  total: null,
                  percent: null,
                  threshold: null,
                  met: localActionMet,
                  trackable: false,
                  notTrackableReason: 'No data available in downloads'
                },
                stemTeam: {
                  name: 'STEM Team',
                  description: 'Hosted qualifying STEM activity',
                  count: null,
                  total: null,
                  percent: null,
                  threshold: null,
                  met: stemTeamMet,
                  trackable: false,
                  notTrackableReason: 'No data available in downloads'
                }
              },
              cycleStart: cycleStartStr,
              cycleEnd: cycleEndStr
            });
          });

          // Sort by award status (On Track first), then by criteria met, then by unit name
          const statusOrder = { 'On Track': 0, 'Potentially Eligible': 1, 'Not On Track': 2, 'Ineligible (< 10 cadets)': 3 };
          rows.sort((a, b) => {
            const statusDiff = (statusOrder[a.awardStatus] || 99) - (statusOrder[b.awardStatus] || 99);
            if (statusDiff !== 0) return statusDiff;
            if (a.criteriaMet !== b.criteriaMet) return b.criteriaMet - a.criteriaMet;
            return a.unitName.localeCompare(b.unitName);
          });

          return {
            rows,
            meta: {
              cycleStart: cycleStartStr,
              cycleEnd: cycleEndStr,
              totalUnits: rows.length,
              eligibleUnits: rows.filter(r => r.isEligible).length,
              onTrackUnits: rows.filter(r => r.awardStatus === 'On Track').length,
              view: showAllDescendants ? 'multi-unit' : 'single-unit'
            }
          };
        };

        // =============================================
        // QUA (Quality Unit Award) REPORT GENERATOR
        // Great Lakes Region - Award cycle: Fiscal Year (1 October - 30 September)
        // Units must meet 7 of 10 criteria (3 required + 4 from mission-specific)
        // =============================================
        const generateQUAReport = (membersOverride = null) => {
          const memberPool = Array.isArray(membersOverride) ? membersOverride : [...(processedData || []), ...(processedCadets || [])];
          if (!memberPool.length) return { rows: [], meta: {} };

          // Fiscal year dates (Oct 1 - Sep 30)
          const today = new Date();
          const currentYear = today.getFullYear();
          const currentMonth = today.getMonth(); // 0-indexed (0=Jan, 9=Oct)
          // If we're in Oct-Dec, FY started this year; if Jan-Sep, FY started last year
          const fyStartYear = currentMonth >= 9 ? currentYear : currentYear - 1;
          const fyEndYear = fyStartYear + 1;
          const fyStartStr = `${fyStartYear}-10-01`;
          const fyEndStr = `${fyEndYear}-09-30`;
          const fyStart = new Date(fyStartStr);
          const fyEnd = new Date(fyEndStr);

          // Helper to get unit info
          const getUnitInfo = (orgId) => {
            const org = (dataFiles.organization || []).find(o => String(o.ORGID || '').trim() === String(orgId || '').trim());
            const unitNum = org && org.Unit ? org.Unit.replace(/^0+/, '').padStart(3, '0') : '';
            const unitType = String(org?.Type || '').toUpperCase();
            const region = org?.Region || '';
            const wing = org?.Wing || '';
            return { unitNum, unitType, region, wing, orgName: org?.Name || '', orgId: org?.ORGID };
          };

          // Determine if unit is Group, Senior Squadron/Flight, or Composite Squadron
          const getUnitCategory = (unitType) => {
            const type = (unitType || '').toUpperCase();
            // Groups
            if (type.includes('GROUP')) return 'GROUP';
            // Exclude higher HQ and cadet-only units
            if (type.includes('WING') || type.includes('REGION') || type.includes('NATIONAL')) return null;
            if (type.includes('CADET') && !type.includes('COMPOSITE')) return null; // Cadet-only squadron
            // Composite squadrons
            if (type.includes('COMPOSITE')) return 'COMPOSITE_SQUADRON';
            // Senior squadrons/flights - explicit or inferred
            // If it has 'SENIOR' in the name, it's a senior unit (squadron or flight)
            if (type.includes('SENIOR')) return 'SENIOR_SQUADRON';
            // Any remaining squadron/flight that isn't cadet-only is treated as senior
            if (type.includes('SQUADRON') || type.includes('FLIGHT')) return 'SENIOR_SQUADRON';
            return null; // Not eligible
          };

          // Build unit-based groupings - seniors only
          const unitMap = new Map();
          const seniors = memberPool.filter(m => {
            const type = String(m.Type || m.TYPE || '').toUpperCase();
            const status = String(m.MbrStatus || '').toUpperCase();
            return (type === 'SENIOR' || type === 'LIFE') && status === 'ACTIVE';
          });

          seniors.forEach(senior => {
            const unitName = senior.memberUnitName || 'Unknown';
            if (!unitMap.has(unitName)) {
              const unitInfo = getUnitInfo(senior.ORGID);
              unitMap.set(unitName, {
                unitName,
                unitInfo,
                seniors: []
              });
            }
            unitMap.get(unitName).seniors.push(senior);
          });

          // Calculate QUA criteria for each unit
          const rows = [];

          unitMap.forEach((unitData, unitName) => {
            const { unitInfo } = unitData;
            const unitType = (unitInfo?.unitType || '').toUpperCase();
            const unitNum = unitInfo?.unitNum || '';
            const unitCategory = getUnitCategory(unitType);

            // Skip units that are not eligible for QUA
            if (!unitCategory) return;
            const isSpecialUnit = unitNum === '000' || unitNum === '999';
            if (isSpecialUnit) return;

            const unitSeniors = unitData.seniors;
            const totalSeniors = unitSeniors.length;
            const pdThreshold = unitCategory === 'GROUP' ? 15 : 10;

            // ===== REQUIRED CRITERIA (All Must Be Met) =====

            // 1. Compliance & Administration - Cadet Protection Training
            // Use existing getCadetProtectionStatus function to check current status
            const cpResults = unitSeniors.map(s => {
              const cpStatus = getCadetProtectionStatus(s);
              if (!cpStatus) {
                return { member: s, status: 'unknown', reason: 'Unable to determine status', memberName: `${s.NameLast}, ${s.NameFirst}`, capid: s.CAPID, rank: s.Rank };
              }

              // Check if member has any required courses
              if (!cpStatus.requiredCourses || cpStatus.requiredCourses.length === 0) {
                // Not required for this member type
                return { member: s, status: 'exempt', reason: 'Not required', memberName: `${s.NameLast}, ${s.NameFirst}`, capid: s.CAPID, rank: s.Rank };
              }

              // Check the overall compliance status
              if (cpStatus.isCompliant) {
                return { member: s, status: 'current', reason: 'Current', memberName: `${s.NameLast}, ${s.NameFirst}`, capid: s.CAPID, rank: s.Rank };
              }

              // Find the worst status among required courses
              const worstCourse = cpStatus.requiredCourses.reduce((worst, course) => {
                const severity = { missing: 3, overdue: 2, 'due-soon': 1, current: 0 };
                return (severity[course.status] || 0) > (severity[worst.status] || 0) ? course : worst;
              }, cpStatus.requiredCourses[0]);

              return {
                member: s,
                status: worstCourse.status,
                reason: worstCourse.statusLabel || worstCourse.status,
                course: worstCourse.label,
                expiration: worstCourse.expirationDate,
                memberName: `${s.NameLast}, ${s.NameFirst}`,
                capid: s.CAPID,
                rank: s.Rank
              };
            });
            const cpCurrentCount = cpResults.filter(r => r.status === 'current' || r.status === 'exempt').length;
            const cpPercent = totalSeniors > 0 ? Math.round((cpCurrentCount / totalSeniors) * 100) : 0;
            const cpMet = cpPercent === 100;
            // Build detailed list for display
            const cpCompliantMembers = cpResults.filter(r => r.status === 'current' || r.status === 'exempt');
            const cpNonCompliantMembers = cpResults.filter(r => r.status !== 'current' && r.status !== 'exempt');

            // 2. Professional Development - New Level II-V completions during FY
            const pdResults = unitSeniors.map(s => {
              // Check seniorLevels for new level completions within FY
              const memberLevels = (dataFiles.seniorLevels || []).filter(sl =>
                String(sl.CAPID || '').trim() === String(s.CAPID).trim()
              );
              const newLevelInFY = memberLevels.find(sl => {
                const lvl = (sl.Lvl || '').toUpperCase();
                const isLevel2to5 = ['LV2', 'LV3', 'LV4', 'LV5', 'LEVEL II', 'LEVEL III', 'LEVEL IV', 'LEVEL V'].some(l => lvl.includes(l));
                if (!isLevel2to5) return false;
                const completedDate = parseDateSafe(sl.Completed);
                return completedDate && completedDate >= fyStart && completedDate <= fyEnd;
              });

              // Also check seniorAwards for level completions
              const memberAwards = (dataFiles.seniorAwards || []).filter(a =>
                String(a.CAPID || '').trim() === String(s.CAPID).trim()
              );
              const newAwardInFY = memberAwards.find(a => {
                const award = (a.Award || '').toUpperCase();
                const isLevel2to5 = ['LEVEL II', 'LEVEL III', 'LEVEL IV', 'LEVEL V', 'LV2', 'LV3', 'LV4', 'LV5'].some(l => award.includes(l));
                if (!isLevel2to5) return false;
                const completedDate = parseDateSafe(a.Completed);
                return completedDate && completedDate >= fyStart && completedDate <= fyEnd;
              });

              const levelAchieved = newLevelInFY ? (newLevelInFY.Lvl || '') : (newAwardInFY ? (newAwardInFY.Award || '') : null);
              const completionDate = newLevelInFY ? parseDateSafe(newLevelInFY.Completed) : (newAwardInFY ? parseDateSafe(newAwardInFY.Completed) : null);

              return {
                member: s,
                hasNewLevel: !!(newLevelInFY || newAwardInFY),
                levelAchieved,
                completionDate: completionDate ? completionDate.toLocaleDateString() : null,
                memberName: `${s.NameLast}, ${s.NameFirst}`,
                capid: s.CAPID,
                rank: s.Rank
              };
            });
            const pdNewLevelCount = pdResults.filter(r => r.hasNewLevel).length;
            const pdPercent = totalSeniors > 0 ? Math.round((pdNewLevelCount / totalSeniors) * 100) : 0;
            const pdMet = pdPercent >= pdThreshold;
            // Build member details
            const pdCompletedMembers = pdResults.filter(r => r.hasNewLevel);
            const pdPendingMembers = pdResults.filter(r => !r.hasNewLevel);

            // 2b. SM Promotion Check - No senior member at SM beyond 1 year without promoting
            const smPromotionResults = unitSeniors.map(s => {
              const rank = (s.Rank || '').toUpperCase().trim();
              const isSM = rank === 'SM' || rank === 'SENIOR MEMBER';
              if (!isSM) return { member: s, status: 'ok', reason: 'Not SM', memberName: `${s.NameLast}, ${s.NameFirst}`, capid: s.CAPID, rank: s.Rank };

              const joinDate = parseDateSafe(s.Joined);
              if (!joinDate) return { member: s, status: 'ok', reason: 'No join date', memberName: `${s.NameLast}, ${s.NameFirst}`, capid: s.CAPID, rank: s.Rank };

              const daysSinceJoin = Math.floor((today - joinDate) / (1000 * 60 * 60 * 24));
              if (daysSinceJoin <= 365) return { member: s, status: 'ok', reason: `SM for ${daysSinceJoin} days`, memberName: `${s.NameLast}, ${s.NameFirst}`, capid: s.CAPID, rank: s.Rank };

              // Check if they've achieved any officer or NCO rank
              const currentRankUpper = rank;

              // Check if current rank is officer (2d Lt or higher) or NCO
              const isOfficer = ['2D LT', '2ND LT', '1ST LT', 'CAPT', 'MAJ', 'LT COL', 'COL'].some(r => currentRankUpper.includes(r));
              const isNCO = QUA_NCO_RANKS.has(currentRankUpper);

              if (isOfficer || isNCO) return { member: s, status: 'ok', reason: 'Promoted', memberName: `${s.NameLast}, ${s.NameFirst}`, capid: s.CAPID, rank: s.Rank };

              return { member: s, status: 'violation', reason: `SM for ${daysSinceJoin} days (> 1 year)`, daysSinceJoin, memberName: `${s.NameLast}, ${s.NameFirst}`, capid: s.CAPID, rank: s.Rank, joinDate: joinDate.toLocaleDateString() };
            });
            const smViolationCount = smPromotionResults.filter(r => r.status === 'violation').length;
            const smPromotionMet = smViolationCount === 0;
            const smViolationMembers = smPromotionResults.filter(r => r.status === 'violation');

            // 3. Recruitment & Retention - Check org statistics if available
            let retentionMet = null;
            let retentionData = { growth: null, retention: null, currentTotal: null, startTotal: null, newMembers: null, renewals: null, attrition: null, netChange: null };
            if (orgStatsService && unitInfo.orgId) {
              const metrics = orgStatsService.getMetricsForUnit(unitInfo.orgId, {
                includeDescendants: false,
                timeRangeMonths: 12
              });
              if (metrics && metrics.metrics) {
                // Calculate growth rate percentage from net change and starting total
                const startTotal = metrics.summary?.yearAgoTotal || null;
                const currentTotal = metrics.summary?.currentTotal || null;
                const netChange = metrics.metrics?.growth?.netChangeInPeriod || null;
                let growthRate = null;
                if (startTotal !== null && startTotal > 0 && netChange !== null) {
                  growthRate = Math.round((netChange / startTotal) * 100 * 10) / 10;
                }
                // Retention rate is directly from the retention metrics
                const retentionRate = metrics.metrics?.retention?.retentionRate || null;

                retentionData = {
                  growth: growthRate,
                  retention: retentionRate,
                  currentTotal: currentTotal,
                  startTotal: startTotal,
                  newMembers: metrics.metrics?.recruiting?.totalInPeriod || null,
                  renewals: metrics.metrics?.retention?.renewalsInPeriod || null,
                  attrition: metrics.metrics?.retention?.estimatedAttrition || null,
                  netChange: netChange
                };
                // 5% growth OR 75% retention
                retentionMet = (growthRate !== null && growthRate >= 5) || (retentionRate !== null && retentionRate >= 75);
              }
            }

            // ===== MISSION-SPECIFIC CRITERIA (Choose Any 4) =====

            // 4. Emergency Services Readiness
            // 4a. 50% GES - Build member details
            const gesResults = unitSeniors.map(s => {
              const esQuals = s.esQualificationsAll || s.esQualifications || [];
              const gesQual = esQuals.find(q => q.achvID === '53' && q.status === 'Active');
              return {
                member: s,
                hasQual: !!gesQual,
                qualName: gesQual ? 'GES' : null,
                memberName: `${s.NameLast}, ${s.NameFirst}`,
                capid: s.CAPID,
                rank: s.Rank
              };
            });
            const gesCount = gesResults.filter(r => r.hasQual).length;
            const gesPercent = totalSeniors > 0 ? Math.round((gesCount / totalSeniors) * 100) : 0;
            const gesMet = gesPercent >= 50;
            const gesQualifiedMembers = gesResults.filter(r => r.hasQual);

            // 4b. 25% ICUT - Build member details
            const icutResults = unitSeniors.map(s => {
              const esQuals = s.esQualificationsAll || s.esQualifications || [];
              const icutQual = esQuals.find(q => q.achvID === '217' && q.status === 'Active');
              return {
                member: s,
                hasQual: !!icutQual,
                qualName: icutQual ? 'ICUT' : null,
                memberName: `${s.NameLast}, ${s.NameFirst}`,
                capid: s.CAPID,
                rank: s.Rank
              };
            });
            const icutCount = icutResults.filter(r => r.hasQual).length;
            const icutPercent = totalSeniors > 0 ? Math.round((icutCount / totalSeniors) * 100) : 0;
            const icutMet = icutPercent >= 25;
            const icutQualifiedMembers = icutResults.filter(r => r.hasQual);

            // 4c. 15% Operational Qualification - Build member details with specific quals
            const operationalResults = unitSeniors.map(s => {
              const esQuals = s.esQualificationsAll || s.esQualifications || [];
              const operationalQuals = esQuals.filter(q => QUA_OPERATIONAL_ES_ACHIEVEMENT_IDS.has(q.achvID) && q.status === 'Active');
              return {
                member: s,
                hasQual: operationalQuals.length > 0,
                qualifications: operationalQuals.map(q => q.name || q.achvName || `ID:${q.achvID}`),
                qualCount: operationalQuals.length,
                memberName: `${s.NameLast}, ${s.NameFirst}`,
                capid: s.CAPID,
                rank: s.Rank
              };
            });
            const operationalCount = operationalResults.filter(r => r.hasQual).length;
            const operationalPercent = totalSeniors > 0 ? Math.round((operationalCount / totalSeniors) * 100) : 0;
            const operationalMet = operationalPercent >= 15;
            const operationalQualifiedMembers = operationalResults.filter(r => r.hasQual);

            // ES Readiness overall: all three sub-criteria must be met
            const esReadinessMet = gesMet && icutMet && operationalMet;

            // 5. Command & Leadership Development
            // 5a. At least one VOLU Instructor - Count unique individuals only
            const voluInstructorResults = unitSeniors.map(s => {
              const capid = String(s.CAPID).trim();
              // Check if this member is a VOLU instructor (any course)
              const voluRecords = (dataFiles.voluInstructors || []).filter(v =>
                String(v.CAPID || '').trim() === capid
              );
              // Get unique course names they teach
              const courses = [...new Set(voluRecords.map(v => v.PathName || 'Unknown Course'))];
              return {
                member: s,
                isInstructor: voluRecords.length > 0,
                courses,
                courseCount: courses.length,
                memberName: `${s.NameLast}, ${s.NameFirst}`,
                capid: s.CAPID,
                rank: s.Rank
              };
            });
            // Count unique VOLU instructors (not duplicate records for multiple courses)
            const voluInstructorCount = voluInstructorResults.filter(r => r.isInstructor).length;
            const voluMet = voluInstructorCount >= 1;
            const voluInstructorMembers = voluInstructorResults.filter(r => r.isInstructor);

            // 5b. 25% Yeager Award
            const yeagerResults = unitSeniors.map(s => {
              const awards = s.seniorAwards || [];
              const yeagerAward = awards.find(a => (a.award || '').toUpperCase().includes(QUA_YEAGER_AWARD_NAME));
              return {
                member: s,
                hasAward: !!yeagerAward,
                awardDate: yeagerAward ? yeagerAward.date : null,
                memberName: `${s.NameLast}, ${s.NameFirst}`,
                capid: s.CAPID,
                rank: s.Rank
              };
            });
            const yeagerCount = yeagerResults.filter(r => r.hasAward).length;
            const yeagerPercent = totalSeniors > 0 ? Math.round((yeagerCount / totalSeniors) * 100) : 0;
            const yeagerMet = yeagerPercent >= 25;
            const yeagerAwardMembers = yeagerResults.filter(r => r.hasAward);

            // 5c. 25% Captain or higher
            const captainPlusResults = unitSeniors.map(s => {
              const rank = (s.Rank || '').toUpperCase().replace(/[^A-Z ]/g, '').trim();
              const isCaptainPlus = QUA_CAPTAIN_OR_HIGHER_RANKS.has(rank) ||
                     Array.from(QUA_CAPTAIN_OR_HIGHER_RANKS).some(r => rank.includes(r));
              return {
                member: s,
                isCaptainPlus,
                memberName: `${s.NameLast}, ${s.NameFirst}`,
                capid: s.CAPID,
                rank: s.Rank
              };
            });
            const captainPlusCount = captainPlusResults.filter(r => r.isCaptainPlus).length;
            const captainPlusPercent = totalSeniors > 0 ? Math.round((captainPlusCount / totalSeniors) * 100) : 0;
            const captainPlusMet = captainPlusPercent >= 25;
            const captainPlusMembers = captainPlusResults.filter(r => r.isCaptainPlus);

            // Command & Leadership overall: all three sub-criteria must be met
            const commandLeadershipMet = voluMet && yeagerMet && captainPlusMet;

            // 6. Encampment & Cadet Program Support - 15% seniors at encampment in FY
            const encampmentResults = unitSeniors.map(s => {
              const activities = (dataFiles.cadetActivities || []).filter(a =>
                String(a.CAPID || '').trim() === String(s.CAPID).trim() &&
                (a.Type || '').toUpperCase().includes('ENCAMP')
              );
              // Check if any encampment participation was within FY
              const fyActivities = activities.filter(a => {
                const actDate = parseDateSafe(a.Completed || a.StartDate || a.DateMod);
                return actDate && actDate >= fyStart && actDate <= fyEnd;
              });
              return {
                member: s,
                participated: fyActivities.length > 0,
                activityCount: fyActivities.length,
                activities: fyActivities.map(a => ({
                  type: a.Type,
                  location: a.Location,
                  date: a.Completed || a.StartDate
                })),
                memberName: `${s.NameLast}, ${s.NameFirst}`,
                capid: s.CAPID,
                rank: s.Rank
              };
            });
            const encampmentStaffCount = encampmentResults.filter(r => r.participated).length;
            const encampmentPercent = totalSeniors > 0 ? Math.round((encampmentStaffCount / totalSeniors) * 100) : 0;
            const encampmentMet = encampmentPercent >= 15;
            const encampmentParticipants = encampmentResults.filter(r => r.participated);

            // Non-trackable criteria (always null)
            const complianceAdminMet = null; // Inspections, financial submissions - not trackable
            const aeInternalMet = null; // AE internal events - not trackable
            const aeExternalMet = null; // AE external events - not trackable
            const communityEngagementMet = null; // Community/legislative outreach - not trackable
            const flyingExcellenceMet = null; // Flying unit operational excellence - not trackable
            const innovationCyberMet = null; // Cyber/comms/innovation - not trackable

            // Calculate criteria met/not met
            const requiredCriteria = [
              { key: 'cadetProtection', met: cpMet, trackable: true },
              { key: 'professionalDevelopment', met: pdMet && smPromotionMet, trackable: true },
              { key: 'retention', met: retentionMet, trackable: retentionMet !== null }
            ];
            const missionCriteria = [
              { key: 'esReadiness', met: esReadinessMet, trackable: true },
              { key: 'commandLeadership', met: commandLeadershipMet, trackable: true },
              { key: 'encampmentSupport', met: encampmentMet, trackable: true },
              { key: 'aerospaceEducation', met: null, trackable: false },
              { key: 'communityEngagement', met: null, trackable: false },
              { key: 'flyingExcellence', met: null, trackable: false },
              { key: 'innovationCyber', met: null, trackable: false }
            ];

            const allCriteria = [...requiredCriteria, ...missionCriteria];
            const criteriaMet = allCriteria.filter(c => c.met === true).length;
            const criteriaNotMet = allCriteria.filter(c => c.met === false).length;
            const criteriaUnknown = allCriteria.filter(c => c.met === null).length;

            // Required criteria check - all 3 required must be met (or unknown for retention)
            const requiredMet = requiredCriteria.filter(c => c.met === true).length;
            const requiredFailed = requiredCriteria.filter(c => c.met === false).length;
            const allRequiredMet = requiredFailed === 0 && requiredMet >= 2; // CP and PD must be met, retention can be unknown

            // Award status - need 7 of 10 total AND all required criteria met
            let awardStatus = 'Not Eligible';
            if (!allRequiredMet) {
              awardStatus = 'Required Criteria Not Met';
            } else if (criteriaMet >= 7) {
              awardStatus = 'On Track';
            } else if (criteriaMet + criteriaUnknown >= 7) {
              awardStatus = 'Potentially Eligible';
            } else {
              awardStatus = 'Not On Track';
            }

            rows.push({
              unitName,
              unitInfo: unitData.unitInfo,
              unitCategory,
              unitCategoryLabel: QUA_ELIGIBLE_UNIT_TYPES[unitCategory]?.label || unitCategory,
              totalSeniors,
              pdThreshold,
              awardStatus,
              criteriaMet,
              criteriaNotMet,
              criteriaUnknown,
              allRequiredMet,
              criteria: {
                // Required Criteria
                cadetProtection: {
                  name: 'Cadet Protection Training',
                  description: '100% current (within 1 year)',
                  shortName: 'CP',
                  count: cpCurrentCount,
                  total: totalSeniors,
                  percent: cpPercent,
                  threshold: 100,
                  met: cpMet,
                  trackable: true,
                  required: true,
                  compliantMembers: cpCompliantMembers,
                  nonCompliantMembers: cpNonCompliantMembers
                },
                professionalDevelopment: {
                  name: 'Professional Development',
                  description: `${pdThreshold}% new Level II-V`,
                  shortName: 'PD',
                  count: pdNewLevelCount,
                  total: totalSeniors,
                  percent: pdPercent,
                  threshold: pdThreshold,
                  met: pdMet && smPromotionMet,
                  trackable: true,
                  required: true,
                  completedMembers: pdCompletedMembers,
                  pendingMembers: pdPendingMembers,
                  subCriteria: {
                    newLevels: { count: pdNewLevelCount, percent: pdPercent, met: pdMet, members: pdCompletedMembers },
                    smPromotion: { violations: smViolationCount, met: smPromotionMet, members: smViolationMembers }
                  }
                },
                retention: {
                  name: 'Recruitment & Retention',
                  description: '5% growth OR 75% retention',
                  shortName: 'RET',
                  growth: retentionData.growth,
                  retention: retentionData.retention,
                  currentTotal: retentionData.currentTotal,
                  startTotal: retentionData.startTotal,
                  newMembers: retentionData.newMembers,
                  renewals: retentionData.renewals,
                  attrition: retentionData.attrition,
                  netChange: retentionData.netChange,
                  met: retentionMet,
                  trackable: retentionMet !== null,
                  required: true,
                  notTrackableReason: retentionMet === null ? 'Org statistics data not available' : null
                },
                // Mission-Specific Criteria
                esReadiness: {
                  name: 'Emergency Services Readiness',
                  description: '50% GES, 25% ICUT, 15% operational',
                  shortName: 'ES',
                  met: esReadinessMet,
                  trackable: true,
                  required: false,
                  subCriteria: {
                    ges: { count: gesCount, total: totalSeniors, percent: gesPercent, threshold: 50, met: gesMet, name: 'GES', members: gesQualifiedMembers },
                    icut: { count: icutCount, total: totalSeniors, percent: icutPercent, threshold: 25, met: icutMet, name: 'ICUT', members: icutQualifiedMembers },
                    operational: { count: operationalCount, total: totalSeniors, percent: operationalPercent, threshold: 15, met: operationalMet, name: 'Operational', members: operationalQualifiedMembers }
                  }
                },
                commandLeadership: {
                  name: 'Command & Leadership Development',
                  description: '1+ VOLU Instructor, 25% Yeager, 25% Capt+',
                  shortName: 'CMD',
                  met: commandLeadershipMet,
                  trackable: true,
                  required: false,
                  subCriteria: {
                    volu: { count: voluInstructorCount, threshold: 1, met: voluMet, name: 'VOLU Instructor', members: voluInstructorMembers },
                    yeager: { count: yeagerCount, total: totalSeniors, percent: yeagerPercent, threshold: 25, met: yeagerMet, name: 'Yeager Award', members: yeagerAwardMembers },
                    captainPlus: { count: captainPlusCount, total: totalSeniors, percent: captainPlusPercent, threshold: 25, met: captainPlusMet, name: 'Captain+', members: captainPlusMembers }
                  }
                },
                encampmentSupport: {
                  name: 'Encampment Support',
                  description: '15% seniors at encampment',
                  shortName: 'ENC',
                  count: encampmentStaffCount,
                  total: totalSeniors,
                  percent: encampmentPercent,
                  threshold: 15,
                  met: encampmentMet,
                  trackable: true,
                  required: false,
                  members: encampmentParticipants
                },
                aerospaceEducation: {
                  name: 'Aerospace Education',
                  description: 'Internal and external AE events',
                  shortName: 'AE',
                  met: null,
                  trackable: false,
                  required: false,
                  notTrackableReason: 'AE event data not available in downloads'
                },
                communityEngagement: {
                  name: 'Community Engagement',
                  description: 'Community or legislative outreach',
                  shortName: 'COM',
                  met: null,
                  trackable: false,
                  required: false,
                  notTrackableReason: 'Community event data not available in downloads'
                },
                flyingExcellence: {
                  name: 'Flying Unit Excellence',
                  description: 'Pilot currency or flight hours',
                  shortName: 'FLY',
                  met: null,
                  trackable: false,
                  required: false,
                  notTrackableReason: 'Flying metrics not available in downloads'
                },
                innovationCyber: {
                  name: 'Innovation & Cyber',
                  description: 'Cyber, comms, or innovation initiative',
                  shortName: 'CYB',
                  met: null,
                  trackable: false,
                  required: false,
                  notTrackableReason: 'Innovation/cyber data not available in downloads'
                }
              },
              fyStart: fyStartStr,
              fyEnd: fyEndStr
            });
          });

          // Sort by award status, then criteria met, then unit name
          const statusOrder = { 'On Track': 0, 'Potentially Eligible': 1, 'Not On Track': 2, 'Required Criteria Not Met': 3, 'Not Eligible': 4 };
          rows.sort((a, b) => {
            const statusDiff = (statusOrder[a.awardStatus] || 99) - (statusOrder[b.awardStatus] || 99);
            if (statusDiff !== 0) return statusDiff;
            if (a.criteriaMet !== b.criteriaMet) return b.criteriaMet - a.criteriaMet;
            return a.unitName.localeCompare(b.unitName);
          });

          return {
            rows,
            meta: {
              fyStart: fyStartStr,
              fyEnd: fyEndStr,
              fyLabel: `FY${fyEndYear}`,
              totalUnits: rows.length,
              onTrackUnits: rows.filter(r => r.awardStatus === 'On Track').length,
              potentialUnits: rows.filter(r => r.awardStatus === 'Potentially Eligible').length,
              view: showAllDescendants ? 'multi-unit' : 'single-unit'
            }
          };
        };

        // =============================================
        // RECRUITING TRENDS REPORT GENERATOR
        // =============================================
        const generateRecruitingTrendsReport = (membersOverride = null, options = {}) => {
          // This report uses orgStatsService, not member data
          if (!orgStatsService || !unitFilter) {
            return { rows: [], meta: { error: 'Org statistics data not available' } };
          }

          const timeRange = options.timeRange || 12;
          const descendantIds = showAllDescendants ? getDescendantOrgIds(unitFilter) : [];

          // Get metrics from the service
          const metrics = orgStatsService.getMetricsForUnit(unitFilter, {
            includeDescendants: showAllDescendants,
            descendantOrgIds: descendantIds,
            timeRangeMonths: timeRange
          });

          if (!metrics || !metrics.monthlyData || metrics.monthlyData.length === 0) {
            return { rows: [], meta: { error: 'No data available for selected unit' } };
          }

          // Build monthly breakdown rows
          const rows = metrics.monthlyData.map(m => ({
            month: m.label,
            date: m.date,
            newSenior: m.senior?.new || 0,
            newCadet: m.cadet?.new || 0,
            rejoinSenior: m.senior?.rejoin || 0,
            rejoinCadet: m.cadet?.rejoin || 0,
            totalNew: (m.combined?.new || 0),
            totalRejoin: (m.combined?.rejoin || 0),
            totalRecruited: (m.combined?.new || 0) + (m.combined?.rejoin || 0),
            totalMembers: m.combined?.total || 0
          })).reverse(); // Most recent first

          // Calculate seasonality if available
          const seasonality = metrics.metrics.seasonality;

          // Calculate year-over-year for same months if we have enough data
          const yoyData = [];
          if (metrics.monthlyData.length >= 12) {
            const recentMonths = metrics.monthlyData.slice(-12);
            recentMonths.forEach((m, idx) => {
              const monthIndex = m.dateObj?.getMonth();
              const priorYearMonth = metrics.monthlyData.find(pm => {
                if (!pm.dateObj) return false;
                const pmMonth = pm.dateObj.getMonth();
                const pmYear = pm.dateObj.getFullYear();
                const mYear = m.dateObj.getFullYear();
                return pmMonth === monthIndex && pmYear === mYear - 1;
              });

              if (priorYearMonth) {
                const current = (m.combined?.new || 0) + (m.combined?.rejoin || 0);
                const prior = (priorYearMonth.combined?.new || 0) + (priorYearMonth.combined?.rejoin || 0);
                yoyData.push({
                  month: m.label,
                  current,
                  prior,
                  change: current - prior
                });
              }
            });
          }

          // Get subordinate unit breakdown for aggregate view
          let unitBreakdown = [];
          if (showAllDescendants && descendantIds.length > 0) {
            const unitMetrics = orgStatsService.getMetricsForMultipleUnits(descendantIds, {
              timeRangeMonths: timeRange
            });

            unitBreakdown = unitMetrics.map(u => {
              const org = (dataFiles.organization || []).find(o =>
                String(o.ORGID || '').trim() === String(u.orgId || '').trim()
              );
              const unitNum = org?.Unit ? org.Unit.replace(/^0+/, '').padStart(3, '0') : '000';
              const unitName = `${org?.Region || ''}-${org?.Wing || ''}-${unitNum}`;

              return {
                orgId: u.orgId,
                unitName,
                recruitingRate: u.recruitingRate,
                currentTotal: u.currentTotal
              };
            }).sort((a, b) => (b.recruitingRate || 0) - (a.recruitingRate || 0));
          }

          return {
            rows,
            meta: {
              timeRange,
              totalRecruited: metrics.metrics.recruiting?.totalInPeriod || 0,
              monthlyAverage: metrics.metrics.recruiting?.monthlyAverage || 0,
              trend: metrics.metrics.recruiting?.trend || 'stable',
              trendPercent: metrics.metrics.recruiting?.trendPercent || 0,
              seniorTotal: rows.reduce((sum, r) => sum + r.newSenior + r.rejoinSenior, 0),
              cadetTotal: rows.reduce((sum, r) => sum + r.newCadet + r.rejoinCadet, 0),
              newTotal: rows.reduce((sum, r) => sum + r.totalNew, 0),
              rejoinTotal: rows.reduce((sum, r) => sum + r.totalRejoin, 0),
              seasonality: seasonality ? {
                peakMonths: seasonality.peakMonths,
                lowMonths: seasonality.lowMonths,
                patterns: seasonality.patterns
              } : null,
              yoyData,
              unitBreakdown,
              isAggregate: showAllDescendants,
              dataPoints: metrics.summary.dataPointCount
            }
          };
        };

        // =============================================
        // RETENTION ANALYSIS REPORT GENERATOR
        // =============================================
        const generateRetentionAnalysisReport = (membersOverride = null, options = {}) => {
          // This report uses both orgStatsService and member data
          if (!orgStatsService || !unitFilter) {
            return { rows: [], meta: { error: 'Org statistics data not available' } };
          }

          const timeRange = options.timeRange || 12;
          const descendantIds = showAllDescendants ? getDescendantOrgIds(unitFilter) : [];

          // Get metrics from the service
          const metrics = orgStatsService.getMetricsForUnit(unitFilter, {
            includeDescendants: showAllDescendants,
            descendantOrgIds: descendantIds,
            timeRangeMonths: timeRange
          });

          if (!metrics) {
            return { rows: [], meta: { error: 'No data available for selected unit' } };
          }

          // Build members expiring soon list from actual member data
          const memberPool = [...(processedData || []), ...(processedCadets || cadetData || [])];
          const today = new Date();
          const membersExpiringSoon = [];

          memberPool.forEach(member => {
            if (!member.Expiration || member.Expiration === '12/31/9998' || member.Expiration === '12/31/9999') return;

            const expirationDate = new Date(member.Expiration);
            const daysUntilExpiration = Math.floor((expirationDate - today) / (1000 * 60 * 60 * 24));

            // Include members expiring in next 90 days
            if (daysUntilExpiration >= 0 && daysUntilExpiration <= 90) {
              const memberType = (member.Type || member.TYPE || '').toUpperCase();
              membersExpiringSoon.push({
                capid: member.CAPID,
                memberName: `${member.NameLast}, ${member.NameFirst}`,
                rank: member.Rank || '',
                unit: member.memberUnitName || '',
                memberType: memberType === 'CADET' ? 'Cadet' : 'Senior',
                expiration: member.Expiration,
                expirationDate,
                daysUntil: daysUntilExpiration,
                urgency: daysUntilExpiration <= 30 ? 'critical' :
                         daysUntilExpiration <= 60 ? 'warning' : 'notice'
              });
            }
          });

          // Sort by expiration date (soonest first)
          membersExpiringSoon.sort((a, b) => a.daysUntil - b.daysUntil);

          // Monthly retention trend
          const monthlyTrend = (metrics.monthlyData || []).map(m => ({
            month: m.label,
            renewals: m.combined?.renew || 0,
            total: m.combined?.total || 0
          })).reverse();

          // Get subordinate unit breakdown for aggregate view
          let unitBreakdown = [];
          if (showAllDescendants && descendantIds.length > 0) {
            const unitMetrics = orgStatsService.getMetricsForMultipleUnits(descendantIds, {
              timeRangeMonths: timeRange
            });

            unitBreakdown = unitMetrics.map(u => {
              const org = (dataFiles.organization || []).find(o =>
                String(o.ORGID || '').trim() === String(u.orgId || '').trim()
              );
              const unitNum = org?.Unit ? org.Unit.replace(/^0+/, '').padStart(3, '0') : '000';
              const unitName = `${org?.Region || ''}-${org?.Wing || ''}-${unitNum}`;

              return {
                orgId: u.orgId,
                unitName,
                retentionRate: u.retentionRate,
                currentTotal: u.currentTotal,
                growthStatus: u.growthStatus
              };
            }).sort((a, b) => (b.retentionRate || 0) - (a.retentionRate || 0));
          }

          const retention = metrics.metrics.retention || {};
          const growth = metrics.metrics.growth || {};

          return {
            rows: membersExpiringSoon,
            meta: {
              timeRange,
              retentionRate: retention.retentionRate,
              healthIndicator: retention.healthIndicator || 'unknown',
              renewalsInPeriod: retention.renewalsInPeriod || 0,
              estimatedAttrition: retention.estimatedAttrition || 0,
              annualizedAttritionRate: retention.annualizedAttritionRate,
              netChange: growth.netChangeInPeriod || 0,
              growthStatus: growth.status || 'unknown',
              currentTotal: metrics.summary?.currentTotal || 0,
              memberBreakdown: metrics.summary?.memberBreakdown || null,
              monthlyTrend,
              unitBreakdown,
              isAggregate: showAllDescendants,
              expiringIn30Days: membersExpiringSoon.filter(m => m.daysUntil <= 30).length,
              expiringIn60Days: membersExpiringSoon.filter(m => m.daysUntil <= 60).length,
              expiringIn90Days: membersExpiringSoon.length
            }
          };
        };

        const normalizeReportTag = (tag) => (tag || "").toLowerCase();
        const formatReportTagLabel = (tag) => (tag || "").split(" ").map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(" ");

        const reportTagClasses = {
          senior: "bg-blue-100 text-blue-800 border border-blue-200",
          cadet: "bg-sky-100 text-sky-800 border border-sky-200",
          "education & training": "bg-indigo-100 text-indigo-800 border border-indigo-200",
          "duty assignment": "bg-amber-100 text-amber-800 border border-amber-200",
          "specialty track": "bg-violet-100 text-violet-800 border border-violet-200",
          readiness: "bg-emerald-100 text-emerald-800 border border-emerald-200",
          compliance: "bg-slate-100 text-slate-800 border border-slate-200",
          membership: "bg-rose-100 text-rose-800 border border-rose-200",
          achievements: "bg-purple-100 text-purple-800 border border-purple-200",
          activities: "bg-teal-100 text-teal-800 border border-teal-200",
          recruiting: "bg-green-100 text-green-800 border border-green-200",
          retention: "bg-orange-100 text-orange-800 border border-orange-200",
          analytics: "bg-cyan-100 text-cyan-800 border border-cyan-200"
        };

        const getMembersForReport = (tags = []) => {
          const normalizedTags = (tags || []).map(normalizeReportTag);

          // Use the appropriate data source based on report tags
          let pool;
          if (normalizedTags.includes("cadet") && normalizedTags.includes("senior")) {
            // For reports with both cadet and senior tags, combine both pools
            pool = [...(processedData || []), ...(processedCadets || cadetData || [])];
          } else if (normalizedTags.includes("cadet")) {
            // For cadet-only reports, use processedCadets which has all cadet data
            pool = processedCadets || cadetData || [];
          } else if (normalizedTags.includes("senior")) {
            // For senior-only reports, use processedData which has senior members
            pool = processedData || [];
          } else {
            // For mixed or untagged reports, combine both pools
            pool = [...(processedData || []), ...(processedCadets || cadetData || [])];
          }

          return pool;
        };

        const reportCatalog = [
          {
            id: 'training',
            title: 'Most Needed Training',
            description: 'Moderated ET modules only â€” what VU instructors should teach next',
            icon: 'GraduationCap',
            accent: 'blue',
            tags: ['senior', 'education & training', 'readiness'],
            generate: (members) => generateMostNeededTraining(members)
          },
          {
            id: 'discrepancies',
            title: 'Track/Duty Discrepancies',
            description: 'Find members with duty assignments but missing required specialty tracks',
            icon: 'AlertTriangle',
            accent: 'amber',
            tags: ['senior', 'duty assignment', 'specialty track', 'compliance'],
            generate: (members) => generateDiscrepanciesReport(members)
          },
          {
            id: 'approval',
            title: 'Levels Needing Approval',
            description: 'Members who have completed all modules and need submission/approval for ET levels',
            icon: 'Stamp',
            accent: 'green',
            tags: ['senior', 'education & training', 'readiness'],
            generate: (members) => generateApprovalNeededReport(members)
          },
          {
            id: 'promotion',
            title: 'Promotion Eligibility',
            description: 'Senior members eligible for promotion based on TIG, education level, and duty requirements',
            icon: 'TrendingUp',
            accent: 'blue',
            tags: ['senior', 'readiness'],
            generate: (members) => generatePromotionEligibilityReport(members)
          },
          {
            id: 'near-promotion',
            title: 'Near Promotion',
            description: 'Members close to promotion eligibility - within 6 months of TIG, 5 or fewer tasks remaining, or approaching duty requirements',
            icon: 'Target',
            accent: 'amber',
            tags: ['senior', 'readiness', 'education & training'],
            generate: (members) => generateNearPromotionReport(members)
          },
          {
            id: 'cadet-no-promotion',
            title: 'Cadets - No Promotion in 120 Days',
            description: 'Cadets who have not been promoted in the last 120 days',
            icon: 'AlertCircle',
            accent: 'amber',
            tags: ['cadet', 'achievements', 'readiness'],
            generate: (members) => generateCadetNoPromotionReport(members)
          },
          {
            id: 'membership-lapse',
            title: 'Membership Expiring Soon',
            description: 'All members (seniors and cadets) whose membership will lapse in 90 days or less',
            icon: 'Clock',
            accent: 'amber',
            tags: ['cadet', 'senior', 'membership', 'compliance'],
            generate: (members) => generateMembershipLapseReport(members)
          },
            {
              id: 'cadet-protection',
              title: 'Cadet Protection Training',
              description: 'Seniors and cadets who are overdue or due soon on Cadet Protection training',
              icon: 'Shield',
              accent: 'amber',
              tags: ['cadet', 'senior', 'compliance', 'education & training'],
              generate: (members) => generateCadetProtectionReport(members)
            },
            {
              id: 'tlc-compliance',
              title: 'TLC Compliance',
              description: 'Training Leaders of Cadets status for senior members (unit summary when sub-units are included)',
              icon: 'ShieldCheck',
              accent: 'blue',
              tags: ['senior', 'education & training', 'compliance'],
              generate: (members) => generateTlcComplianceReport(members)
            },
            {
              id: 'aerospace-education',
              title: 'Aerospace Education Completion',
            description: 'All cadets showing detailed completion of the 7 Aerospace Dimensions modules - includes which achievement each module was for, completion type (interactive/test/both), and honor credit status',
            icon: 'BookOpen',
            accent: 'blue',
            tags: ['cadet', 'achievements', 'education & training'],
            generate: (members) => generateAerospaceEducationReport(members)
          },
          {
            id: 'encampment-status',
            title: 'Encampment Completion Status',
            description: 'All cadets in unit showing whether they have completed an encampment',
            icon: 'Tent',
            accent: 'blue',
            tags: ['cadet', 'activities', 'readiness'],
            generate: (members) => generateEncampmentReport(members)
          },
          {
            id: 'oflight-status',
            title: 'Orientation Flights Status',
            description: 'Powered O-Flight syllabus completion for all cadets - highlights cadets who have not had any O-Flights',
            icon: 'Plane',
            accent: 'blue',
            tags: ['cadet', 'activities', 'readiness'],
            generate: (members) => generateOFlightReport(members)
          },
          {
            id: 'recent-promotions',
            title: 'Cadets - Recent Promotions',
            description: 'Cadets who have been promoted in the past 30 or 60 days',
            icon: 'TrendingUp',
            accent: 'blue',
            tags: ['cadet', 'achievements', 'readiness'],
            generate: (members) => generateRecentPromotionsReport(members)
          },
          {
            id: 'promotion-requirements',
            title: 'Cadet Promotion Requirements',
            description: 'Full table of cadet promotion requirements for the unit showing current and next achievements',
            icon: 'List',
            accent: 'blue',
            tags: ['cadet', 'achievements', 'readiness'],
            generate: (members) => generatePromotionRequirementsReport(members)
          },
          {
            id: 'approaching-age-milestone',
            title: 'Cadets - Approaching Age 18 or 21',
            description: 'Cadets who will turn 18 or 21 within the next 6 months - plan for transitions and age-outs',
            icon: 'Calendar',
            accent: 'amber',
            tags: ['cadet', 'membership', 'readiness'],
            generate: (members) => generateApproachingAgeMilestoneReport(members)
          },
          {
            id: 'qcua',
            title: 'Quality Cadet Unit Award (QCUA)',
            description: 'Track unit progress toward the 10 QCUA criteria - 7 trackable, 3 require manual verification',
            icon: 'Award',
            accent: 'blue',
            tags: ['cadet', 'senior', 'readiness', 'compliance'],
            generate: (members) => generateQCUAReport(members)
          },
          {
            id: 'qua',
            title: 'Quality Unit Award (QUA)',
            description: 'Great Lakes Region award for Groups and Senior/Composite Squadrons - 7 of 10 criteria required (FY Oct-Sep)',
            icon: 'Award',
            accent: 'emerald',
            tags: ['senior', 'readiness', 'compliance', 'leadership'],
            generate: (members) => generateQUAReport(members)
          },
          {
            id: 'recruiting-trends',
            title: 'Recruiting Trends Analysis',
            description: 'Monthly recruiting patterns, seasonal trends, and year-over-year comparison of new member acquisition',
            icon: 'UserPlus',
            accent: 'blue',
            tags: ['senior', 'cadet', 'membership', 'recruiting', 'analytics'],
            generate: (members, options) => generateRecruitingTrendsReport(members, options)
          },
          {
            id: 'retention-analysis',
            title: 'Retention & Renewal Analysis',
            description: 'Renewal rates, attrition patterns, and members approaching membership expiration',
            icon: 'RefreshCw',
            accent: 'amber',
            tags: ['senior', 'cadet', 'membership', 'retention', 'analytics'],
            generate: (members, options) => generateRetentionAnalysisReport(members, options)
          }
        ];

        const availableReportTags = useMemo(() => {
          const tags = new Set();
          reportCatalog.forEach(def => def.tags.forEach(tag => tags.add(tag)));
          return Array.from(tags).sort((a, b) => a.localeCompare(b));
        }, []);

        const toggleReportTag = (tag) => {
          setReportTagFilter(prev => prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag]);
        };

          const filteredReports = !reportTagFilter.length
            ? reportCatalog
            : reportCatalog.filter(def =>
                reportTagFilter.every(tag => def.tags.map(normalizeReportTag).includes(normalizeReportTag(tag)))
              );

          const buildReportPayload = (reportDef, result) => {
            if (result && !Array.isArray(result) && Array.isArray(result.rows)) {
              return {
                ...reportDef,
                type: reportDef.id,
                data: result.rows,
                meta: result.meta || {}
              };
            }
            return {
              ...reportDef,
              type: reportDef.id,
              data: Array.isArray(result) ? result : []
            };
          };

          const handleGenerateReport = (reportDef, options = {}) => {
            const scopedMembers = getMembersForReport(reportDef.tags);
            const result = reportDef.generate(scopedMembers, options);
            const reportPayload = buildReportPayload(reportDef, result);
            // Store the options used to generate this report for regeneration
            reportPayload.options = options;
            setSelectedTaskMembers(null);
            setSelectedReport(reportPayload);
            setReportsCollapsed(true);
            const output = document.getElementById('report-output');
            if (output) {
              output.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          };

          const handleRegenerateReport = (newOptions = {}) => {
            if (!selectedReport) return;
            // Find the report definition by type/id
            const reportDef = reportCatalog.find(r => r.id === selectedReport.type);
            if (!reportDef) return;
            // Merge existing options with new options
            const mergedOptions = { ...(selectedReport.options || {}), ...newOptions };
            handleGenerateReport(reportDef, mergedOptions);
        };

        useEffect(() => {
          if (!dataFiles.members.length || !unitFilter) {
            setOrgChartData(null);
            return;
          }

          const getMemberByCapid = (capid) => dataFiles.members.find(m => String(m.CAPID).trim() === String(capid).trim());
          
          const buildOrgChart = () => {
            let validOrgIds = unitFilter ? [unitFilter] : [];
            if (showAllDescendants && unitFilter) {
              const scopeIds = getDescendantOrgIds(unitFilter);
              validOrgIds = Array.isArray(scopeIds) ? scopeIds : validOrgIds;
            }
            
            const unitMembers = dataFiles.members.filter(m => validOrgIds.includes(m.ORGID));
            const unitOrg = dataFiles.organization.find(o => o.ORGID === unitFilter);
            const isComposite = unitOrg && unitOrg.Type && unitOrg.Type.toUpperCase().includes('COMPOSITE');
            const isCadetOnly = unitOrg && unitOrg.Type && unitOrg.Type.toUpperCase().includes('CADET');
            const isWing = unitOrg && unitOrg.Type && unitOrg.Type.toUpperCase().includes('WING');
            const isGroup = unitOrg && unitOrg.Type && unitOrg.Type.toUpperCase().includes('GROUP');

            // In command-chain view at Wing/Group level, always pull duty data for all descendant units
            const dutyOrgIds = (() => {
              if (showCommandChainOnly && (isWing || isGroup)) {
                const scope = getDescendantOrgIds(unitFilter);
                return Array.isArray(scope) ? scope : validOrgIds;
              }
              return validOrgIds;
            })();
            
            const orgStructure = {
              id: 'root',
              title: 'Commander',
              type: 'senior',
              members: [],
              children: []
            };
            // Build Cadet Advisory Council node helper (Wing/Group) using cadet duty titles, fallback to committees
            const buildCouncilNode = (keyword, nodeId, title, parentOrgIds, type = 'cadet', dutiesSource = null) => {
              const orgIds = Array.isArray(parentOrgIds) ? parentOrgIds : [];
              const keyUpper = keyword.toUpperCase();
              const chair = [];
              const vice = [];
              const recorder = [];
              const reps = [];

              const addFromCadetDuty = () => {
                const source = dutiesSource || allCadetDuties;
                if (!source) return;
                source
                  .filter(d => orgIds.includes(d.ORGID) && ((d.Duty || '').toUpperCase().includes(keyUpper)))
                  .forEach(d => {
                    const mem = getMemberByCapid(d.CAPID);
                    if (!mem) return;
                    const display = `${mem.Rank} ${mem.NameLast}, ${mem.NameFirst}||${mem.CAPID}`;
                    const dutyUpper = (d.Duty || '').toUpperCase();
                    if (dutyUpper.includes('VICE')) vice.push(display);
                    else if (dutyUpper.includes('RECORDER')) recorder.push(display);
                    else if (dutyUpper.includes('CHAIR')) chair.push(display);
                    else reps.push(display);
                  });
              };

              const addFromCommittees = () => {
                if (!dataFiles.committees || dataFiles.committees.length === 0) return;
                dataFiles.committees
                  .filter(c => orgIds.includes(c.ORGID) && (c.Committee || '').toUpperCase().includes(keyUpper))
                  .forEach(c => {
                    const mem = getMemberByCapid(c.CAPID);
                    if (!mem) return;
                    const display = `${mem.Rank} ${mem.NameLast}, ${mem.NameFirst}||${mem.CAPID}`;
                    const pos = ((c.Position || c.Role || c.Title || '') + '').toUpperCase();
                    if (c.Chair === "1" || pos.includes('CHAIR')) chair.push(display);
                    else if (pos.includes('VICE')) vice.push(display);
                    else if (pos.includes('RECORDER')) recorder.push(display);
                    else reps.push(display);
                  });
              };

              addFromCadetDuty();
              if (!chair.length && !vice.length && !recorder.length && !reps.length) addFromCommittees();

              const children = [];
              // Show vice/recorder/reps if they have members, or if hideVacant is false, or if there are reps (to show hierarchy)
              if (vice.length > 0 || (!hideVacant && chair.length > 0) || reps.length > 0) {
                children.push({ id: `${nodeId}_vice`, title: 'Vice Chair', type, members: vice, children: [] });
              }
              if (recorder.length > 0 || (!hideVacant && chair.length > 0) || reps.length > 0) {
                children.push({ id: `${nodeId}_rec`, title: 'Recorder', type, members: recorder, children: [] });
              }
              if (reps.length > 0 || !hideVacant) {
                children.push({ id: `${nodeId}_members`, title: 'Representatives', type, members: reps, children: [] });
              }

              const hasAny = chair.length || vice.length || recorder.length || reps.length;
              if (!hasAny && hideVacant) return null;

              return { id: nodeId, title, type, members: chair, children };
            };
            
            // Helper function to get direct squadrons only (excludes Groups)
            const getDirectSquadronOrgIds = (parentOrgId) => {
              const parent = String(parentOrgId).trim();
              const directChildren = unitChildrenMap.get(parent) || [];

              // Filter to only include squadrons (not Groups)
              const squadrons = directChildren.filter(childId => {
                const childOrg = dataFiles.organization.find(o => String(o.ORGID).trim() === childId);
                if (!childOrg) return false;
                const childType = (childOrg.Type || '').toUpperCase();
                // Exclude Groups - only include squadrons
                return !childType.includes('GROUP');
              });

              return [parent, ...squadrons];
            };

            // CAC scope always uses all descendants so reps/alternates show even without Sub-Units toggle
            const councilOrgIdsRaw = getDescendantOrgIds(unitFilter);
            const councilOrgIds = Array.isArray(councilOrgIdsRaw)
              ? councilOrgIdsRaw
              : (unitFilter ? [unitFilter] : []);

            // Wing CAC should only include Wing + direct squadrons (not Groups or their subordinates)
            const wingCouncilOrgIds = isWing ? getDirectSquadronOrgIds(unitFilter) : [];

            // Get duty assignments - FIXED: Use cadet duty file
            const allDuties = dataFiles.duty.filter(d => dutyOrgIds.includes(d.ORGID));
            const allCadetDuties = dataFiles.cadetDuty
              ? dataFiles.cadetDuty
                  .filter(d => dutyOrgIds.includes(d.ORGID))
                  .filter(d => d.Duty && !d.Duty.toUpperCase().includes('#REF'))
              : [];
            const councilCadetDuties = dataFiles.cadetDuty
              ? dataFiles.cadetDuty
                  .filter(d => councilOrgIds.includes(d.ORGID))
                  .filter(d => d.Duty && !d.Duty.toUpperCase().includes('#REF'))
              : [];
            const wingCouncilCadetDuties = dataFiles.cadetDuty
              ? dataFiles.cadetDuty
                  .filter(d => wingCouncilOrgIds.includes(d.ORGID))
                  .filter(d => d.Duty && !d.Duty.toUpperCase().includes('#REF'))
              : [];
            
            // Helper function with assistant marking
            const findMembersByTitles = (titles = [], options = {}) => {
              const { excludeWords = [], useCadetData = false, orgFilter = null } = options;
              const dataSource = useCadetData ? allCadetDuties : allDuties;
              const upperTitles = titles.map(t => t.toUpperCase());
              const upperExclude = excludeWords.map(e => e.toUpperCase());
              return dataSource
                .filter(d => {
                  const dutyUpper = (d.Duty || "").toUpperCase();
                  if (orgFilter && !orgFilter.includes(String(d.ORGID).trim())) return false;
                  const matches = upperTitles.some(t => dutyUpper.includes(t));
                  const excluded = upperExclude.some(word => dutyUpper.includes(word));
                  return matches && !excluded;
                })
                .map(d => {
                  const mem = getMemberByCapid(d.CAPID);
                  if (!mem) return null;
                  const asst = d.Asst === "1" ? " (A)" : "";
                  return `${mem.Rank} ${mem.NameLast}, ${mem.NameFirst}${asst}||${mem.CAPID}`;
                })
                .filter(Boolean);
            };
            const findMembersByDuty = (title, excludeWords = [], useCadetData = false) =>
              findMembersByTitles([title], { excludeWords, useCadetData });
            const findMembersByTitlesForOrgs = (titles = [], orgIds = []) =>
              findMembersByTitles(titles, { orgFilter: orgIds });
            
            // FIXED: Commander only - exclude deputies/advisors and scope strictly to the current unit
            const commanderExclude = ['DEPUTY', 'CADET', 'VICE', 'ADVISOR'];
            const commanderOnly = dataFiles.duty
              .filter(d => String(d.ORGID).trim() === String(unitFilter).trim())
              .filter(d => {
                const dutyUpper = (d.Duty || '').toUpperCase();
                if (!dutyUpper.includes('COMMANDER')) return false;
                return !commanderExclude.some(w => dutyUpper.includes(w));
              })
              .map(d => {
                const mem = getMemberByCapid(d.CAPID);
                if (!mem) return null;
                const asst = d.Asst === "1" ? " (A)" : "";
                return `${mem.Rank} ${mem.NameLast}, ${mem.NameFirst}${asst}||${mem.CAPID}`;
              })
              .filter(Boolean);
            orgStructure.members = commanderOnly;
            
            const stripAssistantMarker = (member = '') => member.replace(' (A)||', '||').replace(' (A)', '');
            const deputyCommanderMembers = findMembersByTitles(['DEPUTY COMMANDER'], { excludeWords: ['FOR SENIORS', 'FOR CADETS'] });
            const wingDeputyOpsMembers = deputyCommanderMembers.filter(m => !m.includes('(A)')).map(stripAssistantMarker);
            const wingDeputySupportMembers = deputyCommanderMembers.filter(m => m.includes('(A)')).map(stripAssistantMarker);

            const deputyNode = { 
              id: 'deputy', 
              title: 'Deputy Commander', 
              type: 'senior', 
              members: deputyCommanderMembers, 
              children: [] 
            };
            
            const deputyOpsNode = {
              id: 'deputy_ops',
              title: 'Deputy Commander for Operations',
              type: 'senior',
              members: wingDeputyOpsMembers,
              children: []
            };
            
            const deputySupportNode = {
              id: 'deputy_support',
              title: 'Deputy Commander for Support',
              type: 'senior',
              members: wingDeputySupportMembers,
              children: []
            };
            
            const deputySeniorNode = { 
              id: 'cds', 
              title: 'Deputy Commander for Seniors', 
              type: 'senior', 
              members: findMembersByTitles(['DEPUTY COMMANDER FOR SENIORS']), 
              children: [] 
            };
            
            const deputyCadetNode = {
              id: 'cdc',
              title: 'Deputy Commander for Cadets',
              type: 'senior',
              members: findMembersByTitles(['DEPUTY COMMANDER FOR CADETS']),
              children: []
            };

            // Wing-specific positions
            const communicationsNode = { id: 'comm', title: 'Communications', type: 'senior', members: findMembersByTitles(['DIRECTOR OF COMMUNICATIONS','COMMUNICATIONS OFFICER','COMMUNICATIONS ENGINEERING OFFICER','COMMUNICATIONS LICENSING OFFICER','COMMUNICATIONS TRAINING OFFICER','CIS OFFICER']) };
            // Chief of Staff oversees: Admin, Personnel, Historian, Health Services, IT, Logistics, PA, Plans & Programs, Recruiting, Chaplain
            const plansProgramsNode = { id: 'plans', title: 'Plans and Programs', type: 'senior', members: findMembersByTitles(['PLANS AND PROGRAMS OFFICER']) };
            const chiefOfStaffStaff = [
              { id: 'admin', title: 'Administration', type: 'senior', members: findMembersByTitles(['DIRECTOR OF ADMINISTRATION','ADMINISTRATIVE OFFICER'], { excludeWords: ['CADET'] }) },
              { id: 'personnel', title: 'Personnel', type: 'senior', members: findMembersByTitles(['PERSONNEL OFFICER']) },
              plansProgramsNode,
              { id: 'historian', title: 'Historian', type: 'senior', members: findMembersByTitles(['HISTORIAN']) },
              { id: 'health', title: 'Health Services', type: 'senior', members: findMembersByTitles(['HEALTH SERVICES OFFICER']) },
              { id: 'it', title: 'Information Technology', type: 'senior', members: findMembersByTitles(['DIRECTOR OF IT','INFORMATION TECHNOLOGIES OFFICER']), children: [
                  { id: 'websec', title: 'Web Security', type: 'senior', members: findMembersByTitles(['WEB SECURITY ADMIN']) }
              ]},
              {
                id: 'log',
                title: 'Logistics',
                type: 'senior',
                members: findMembersByTitles(['DIRECTOR OF LOGISTICS','LOGISTICS OFFICER']),
                children: [
                  { id: 'supply', title: 'Supply', type: 'senior', members: findMembersByTitles(['SUPPLY OFFICER'], { excludeWords: ['CADET'] }) },
                  { id: 'transport', title: 'Transportation', type: 'senior', members: findMembersByTitles(['TRANSPORTATION OFFICER']) },
                  { id: 'maint', title: 'Maintenance', type: 'senior', members: findMembersByTitles(['MAINTENANCE OFFICER']) },
                  communicationsNode
                ]
              },
              { id: 'pa', title: 'Public Affairs', type: 'senior', members: findMembersByTitles(['DIRECTOR OF PUBLIC AFFAIRS','PUBLIC AFFAIRS OFFICER'], { excludeWords: ['CADET'] }) },
              { id: 'recruiting', title: 'Recruiting', type: 'senior', members: findMembersByTitles(['DIRECTOR OF RECRUITING','RECRUITING OFFICER','CADET PROGRAMS OFFICER']) },
              { id: 'chaplain', title: 'Chaplain', type: 'senior', members: findMembersByTitles(['CHAPLAIN','WING CHAPLAIN COORDINATOR']), children: [
                  { id: 'cdi', title: 'Character Development', type: 'senior', members: findMembersByTitles(['CHARACTER DEVELOPMENT INSTRUCTOR']) }
              ] },
              { id: 'finance', title: 'Finance', type: 'senior', members: findMembersByTitles(['DIRECTOR OF FINANCE','FINANCE OFFICER']) }
            ];

            const chiefOfStaffNode = {
              id: 'chief_staff',
              title: 'Chief of Staff',
              type: 'senior',
              members: findMembersByTitles(['CHIEF OF STAFF']),
              children: isWing ? [...chiefOfStaffStaff, { id: 'dev', title: 'Development', type: 'senior', members: findMembersByTitles(['DIRECTOR OF DEVELOPMENT','DIVERSITY OFFICER']) }] : chiefOfStaffStaff
            };

            const seniorEnlistedLeaderNode = {
              id: 'senior_enlisted',
              title: 'Senior Enlisted Leader',
              type: 'senior',
              members: findMembersByTitles(['SENIOR ENLISTED LEADER']),
              children: []
            };
            if (isWing) {
              const ncoChildren = findMembersByTitles(['NCO ADVISOR','GROUP NCO']);
              if (ncoChildren.length > 0) seniorEnlistedLeaderNode.children.push({ id: 'nco', title: 'NCO Advisor', type: 'senior', members: ncoChildren, children: [] });
            }

            // Deputy Commander staff
            const educationTrainingNode = { id: 'pd', title: 'Education and Training', type: 'senior', members: findMembersByTitles(['DIRECTOR OF EDUCATION AND TRAINING','EDUCATION AND TRAINING OFFICER','PROFESSIONAL DEVELOPMENT OFFICER','DIRECTOR OF EDUCATION AND TRAINING']), children: isWing ? [
                { id: 'test', title: 'Testing', type: 'senior', members: findMembersByTitles(['TESTING OFFICER']) }
            ] : [] };
            const aerospaceEducationNode = { id: 'ae', title: 'Aerospace Education', type: 'senior', members: findMembersByTitles(['DIRECTOR OF AEROSPACE EDUCATION','AEROSPACE EDUCATION OFFICER','CYBER EDUCATION OFFICER']), children: isWing ? [
                { id: 'ae_internal', title: 'Internal Aerospace Education', type: 'senior', members: findMembersByTitles(['INTERNAL AEROSPACE EDUCATION OFFICER']) },
                { id: 'ae_external', title: 'External Aerospace Education', type: 'senior', members: findMembersByTitles(['EXTERNAL AEROSPACE EDUCATION OFFICER']) }
            ] : [] };
            const cadetProgramsNode = { id: 'dcp', title: 'Cadet Programs', type: 'senior', members: findMembersByTitles(['DIRECTOR OF CADET PROGRAMS','CADET PROGRAMS DEVELOPMENT OFFICER']), children: [
                { id: 'act', title: 'Activities', type: 'senior', members: findMembersByTitles(['ACTIVITIES OFFICER']) },
                { id: 'fitness', title: 'Fitness', type: 'senior', members: findMembersByTitles(['FITNESS OFFICER']) },
                { id: 'lead', title: 'Leadership', type: 'senior', members: findMembersByTitles(['LEADERSHIP OFFICER']) }
            ]};
            const stanevalNode = { id: 'staneval', title: 'Standardization/Evaluation', type: 'senior', members: findMembersByTitles(['STANDARDIZATION/EVALUATION OFFICER','STANDARDIZATION AND EVALUATION OFFICER']) };
            const homelandSecurityNode = { id: 'homeland', title: 'Homeland Security', type: 'senior', members: findMembersByTitles(['HOMELAND SECURITY OFFICER']) };
            const emergencyServicesNode = {
              id: 'es',
              title: 'Emergency Services',
              type: 'senior',
              members: findMembersByTitles(['DIRECTOR OF EMERGENCY SERVICES','EMERGENCY SERVICES OFFICER','DISASTER RELIEF OFFICER','DISASTER PREPAREDNESS OFFICER']),
              children: [
                { id: 'sar', title: 'Search and Rescue', type: 'senior', members: findMembersByTitles(['SEARCH AND RESCUE OFFICER']) },
                { id: 'training', title: 'Emergency Services Training', type: 'senior', members: findMembersByTitles(['EMERGENCY SERVICES TRAINING OFFICER']) },
                { id: 'disaster', title: 'Disaster Preparedness', type: 'senior', members: findMembersByTitles(['DISASTER PREPAREDNESS OFFICER']) },
                ...(isWing ? [] : [homelandSecurityNode])
              ]
            };
            const alertingNode = { id: 'alerting', title: 'Alerting', type: 'senior', members: findMembersByTitles(['ALERTING OFFICER']) };
            const operationsChildren = [
              stanevalNode,
              ...(isWing ? [] : [emergencyServicesNode]),
              alertingNode,
              ...(isWing ? [{ id: 'suas', title: 'Small Unmanned Aerial Systems', type: 'senior', members: findMembersByTitles(['SMALL UNMANNED AERIAL SYSTEMS OFFICER']) }] : [])
            ];
            const operationsNode = {
              id: 'ops',
              title: 'Operations',
              type: 'senior',
              members: findMembersByTitles(['DIRECTOR OF OPERATIONS','OPERATIONS OFFICER','COUNTERDRUG OFFICER']),
              children: operationsChildren
            };

            const wingDeputySupportStaff = [educationTrainingNode, cadetProgramsNode, aerospaceEducationNode];
            const wingDeputyOperationsStaff = [operationsNode, emergencyServicesNode, homelandSecurityNode];
            const deputyCommanderStaff = [...wingDeputySupportStaff, ...wingDeputyOperationsStaff];

            // For non-Wing units, use traditional direct staff structure
            const directStaff = [];
            directStaff.push({ id: 'legal', title: 'Legal', type: 'senior', members: findMembersByTitles(['LEGAL OFFICER']) });
            directStaff.push({ id: 'safety', title: 'Safety', type: 'senior', members: findMembersByTitles(['DIRECTOR OF SAFETY','SAFETY OFFICER'], { excludeWords: ['CADET'] }) });
            directStaff.push({ id: 'ig', title: 'Inspector General', type: 'senior', members: findMembersByTitles(['INSPECTOR GENERAL']) });
            if (!isWing) {
              directStaff.push({ id: 'nco', title: 'NCO Advisor', type: 'senior', members: findMembersByTitles(['NCO ADVISOR','GROUP NCO']) });
              directStaff.push({ id: 'chaplain', title: 'Chaplain', type: 'senior', members: findMembersByTitles(['CHAPLAIN','WING CHAPLAIN COORDINATOR']), children: [
                  { id: 'cdi', title: 'Character Development', type: 'senior', members: findMembersByTitles(['CHARACTER DEVELOPMENT INSTRUCTOR']) }
              ] });
              directStaff.push({ id: 'pa', title: 'Public Affairs', type: 'senior', members: findMembersByTitles(['PUBLIC AFFAIRS OFFICER','DIRECTOR OF PUBLIC AFFAIRS'], { excludeWords: ['CADET'] }) });
              directStaff.push({ id: 'admin', title: 'Administration', type: 'senior', members: findMembersByTitles(['ADMINISTRATIVE OFFICER','DIRECTOR OF ADMINISTRATION'], { excludeWords: ['CADET'] }) });
              directStaff.push({ id: 'finance', title: 'Finance', type: 'senior', members: findMembersByTitles(['FINANCE OFFICER','DIRECTOR OF FINANCE']) });
            }

            // For non-Wing units, traditional senior staff
            const seniorStaff = [
              {
                id: 'ops',
                title: 'Operations',
                type: 'senior',
                members: findMembersByTitles(['DIRECTOR OF OPERATIONS','OPERATIONS OFFICER'], { excludeWords: ['DEPUTY','CADET'] }),
                children: [
                  { id: 'staneval', title: 'Standardization/Evaluation', type: 'senior', members: findMembersByTitles(['STANDARDIZATION/EVALUATION OFFICER','STANDARDIZATION AND EVALUATION OFFICER']) },
                  {
                    id: 'es',
                    title: 'Emergency Services',
                    type: 'senior',
                    members: findMembersByTitles(['DIRECTOR OF EMERGENCY SERVICES','EMERGENCY SERVICES OFFICER','DISASTER RELIEF OFFICER']),
                    children: [
                      { id: 'sar', title: 'Search and Rescue', type: 'senior', members: findMembersByTitles(['SEARCH AND RESCUE OFFICER']) },
                      { id: 'training', title: 'Emergency Services Training', type: 'senior', members: findMembersByTitles(['EMERGENCY SERVICES TRAINING OFFICER']) },
                      { id: 'disaster', title: 'Disaster Preparedness', type: 'senior', members: findMembersByTitles(['DISASTER PREPAREDNESS OFFICER']) },
                      { id: 'homeland', title: 'Homeland Security', type: 'senior', members: findMembersByTitles(['HOMELAND SECURITY OFFICER']) }
                    ]
                  },
                  { id: 'alerting', title: 'Alerting', type: 'senior', members: findMembersByTitles(['ALERTING OFFICER']) }
                ]
              },
              {
                id: 'log',
                title: 'Logistics',
                type: 'senior',
                members: findMembersByTitles(['DIRECTOR OF LOGISTICS','LOGISTICS OFFICER']),
                children: [
                  { id: 'supply', title: 'Supply', type: 'senior', members: findMembersByTitles(['SUPPLY OFFICER'], { excludeWords: ['CADET'] }) },
                  { id: 'transport', title: 'Transportation', type: 'senior', members: findMembersByTitles(['TRANSPORTATION OFFICER']) },
                  { id: 'maint', title: 'Maintenance', type: 'senior', members: findMembersByTitles(['MAINTENANCE OFFICER']) }
                ]
              },
              communicationsNode,
              { id: 'pd', title: 'Education and Training', type: 'senior', members: findMembersByTitles(['DIRECTOR OF EDUCATION AND TRAINING','EDUCATION AND TRAINING OFFICER','PROFESSIONAL DEVELOPMENT OFFICER']) },
              { id: 'personnel', title: 'Personnel', type: 'senior', members: findMembersByTitles(['PERSONNEL OFFICER']) },
              { id: 'recruiting', title: 'Recruiting', type: 'senior', members: findMembersByTitles(['DIRECTOR OF RECRUITING','RECRUITING OFFICER']) },
              { id: 'it', title: 'Information Technology', type: 'senior', members: findMembersByTitles(['DIRECTOR OF IT','INFORMATION TECHNOLOGIES OFFICER']), children: [
                  { id: 'websec', title: 'Web Security', type: 'senior', members: findMembersByTitles(['WEB SECURITY ADMIN']) }
              ] }
            ];
            
            const cadetStaff = [
              { id: 'lead', title: 'Leadership', type: 'senior', members: findMembersByDuty('LEADERSHIP OFFICER') },
              { id: 'ae', title: 'Aerospace Education', type: 'senior', members: findMembersByDuty('AEROSPACE EDUCATION') },
              { id: 'act', title: 'Activities', type: 'senior', members: findMembersByDuty('ACTIVITIES OFFICER') },
              { id: 'fitness', title: 'Fitness', type: 'senior', members: findMembersByDuty('FITNESS OFFICER') }
            ];
            
            // FIXED: Use cadet duty data for cadet positions
            const cadetCommanders = findMembersByTitles(['CADET COMMANDER'], { useCadetData: true });
            const flightCommanders = findMembersByTitles(['CADET FLIGHT COMMANDER'], { useCadetData: true });
            const flightSergeants = findMembersByTitles(['CADET FLIGHT SERGEANT'], { useCadetData: true });
            
            // Calculate Flight Members - cadets without non-flight duty positions
            // Separate officers from NCOs/Airmen
            const flightMembersRaw = dataFiles.members
              .filter(m => {
                const isCadet = (m.Type || m.TYPE) === "CADET";
                const status = String(m.MbrStatus || "").toUpperCase();
                const isActive = status === "ACTIVE";
                if (!isCadet || !isActive) return false;
                // Only include cadets whose home unit is the current org (avoid wing-wide flooding)
                if (String(m.ORGID).trim() !== String(unitFilter).trim()) return false;

                const hasNonFlightDuty = allCadetDuties.some(d =>
                  d.CAPID === m.CAPID &&
                  !d.Duty.toUpperCase().includes('FLIGHT') &&
                  !d.Duty.toUpperCase().includes('ELEMENT')
                );

                return !hasNonFlightDuty;
              });

            // Officer ranks: C/2d Lt, C/1st Lt, C/Capt, C/Maj, C/Lt Col, C/Col
            const officerRanks = ['C/2DLT', 'C/1STLT', 'C/CAPT', 'C/MAJ', 'C/LTCOL', 'C/COL'];
            const flightOfficers = flightMembersRaw
              .filter(m => {
                const rankUpper = m.Rank.toUpperCase().replace(/\./g, '').trim();
                return officerRanks.includes(rankUpper);
              })
              .map(m => `${m.Rank} ${m.NameLast}, ${m.NameFirst}||${m.CAPID}`)
              .sort();

            const flightEnlisted = flightMembersRaw
              .filter(m => {
                const rankUpper = m.Rank.toUpperCase().replace(/\./g, '').trim();
                return !officerRanks.includes(rankUpper);
              })
              .map(m => `${m.Rank} ${m.NameLast}, ${m.NameFirst}||${m.CAPID}`)
              .sort();

            // Officer Flight Members node
            const flightOfficersNode = {
              id: 'flight_officers',
              title: 'Flight Member Officers',
              type: 'cadet',
              members: flightOfficers,
              children: []
            };

            // Enlisted Flight Members node
            const flightEnlistedNode = {
              id: 'flight_enlisted',
              title: 'Flight Member Airmen',
              type: 'cadet',
              members: flightEnlisted,
              children: []
            };

            const flightStructure = [];

            // Build flight structure with proper officer/enlisted separation
            if (flightCommanders.length > 0) {
              const flightCmdrChildren = [];

              // Officers report to Flight Commander
              if (flightOfficers.length > 0) {
                flightCmdrChildren.push(flightOfficersNode);
              }

              // Flight Sergeant reports to Flight Commander, enlisted report to Flight Sergeant
              if (flightSergeants.length > 0) {
                flightCmdrChildren.push({
                  id: 'flight_sgt',
                  title: 'Flight Sergeants',
                  type: 'cadet',
                  members: flightSergeants,
                  children: flightEnlisted.length > 0 ? [flightEnlistedNode] : []
                });
              } else if (flightEnlisted.length > 0) {
                // No Flight Sergeant, enlisted report directly to Flight Commander
                flightCmdrChildren.push(flightEnlistedNode);
              }

              flightStructure.push({
                id: 'flight_cmdr',
                title: 'Flight Commanders',
                type: 'cadet',
                members: flightCommanders,
                children: flightCmdrChildren
              });
            } else if (flightSergeants.length > 0) {
              // No Flight Commander, both report to Flight Sergeant (but officers should escalate to DC Ops)
              const flightSgtChildren = [];
              if (flightEnlisted.length > 0) {
                flightSgtChildren.push(flightEnlistedNode);
              }

              flightStructure.push({
                id: 'flight_sgt',
                title: 'Flight Sergeants',
                type: 'cadet',
                members: flightSergeants,
                children: flightSgtChildren
              });

              // Officers without Flight Commander report separately to DC Ops (will be added at DC Ops level)
              if (flightOfficers.length > 0) {
                flightStructure.push(flightOfficersNode);
              }
            } else {
              // No flight leadership - both types report directly to DC Ops
              if (flightOfficers.length > 0) {
                flightStructure.push(flightOfficersNode);
              }
              if (flightEnlisted.length > 0) {
                flightStructure.push(flightEnlistedNode);
              }
            }

            // Build cadet org children array dynamically
            const cadetOrgChildren = [
              { id: 'c_first', title: 'C/First Sergeant', type: 'cadet', members: findMembersByDuty('CADET FIRST SERGEANT', [], true) }
            ];

            // Build C/Dep Cmdr Support children array
            const cDepSupChildren = [
              { id: 'c_admin', title: 'C/Admin', type: 'cadet', members: findMembersByDuty('CADET ADMINISTRATIVE', [], true) },
              { id: 'c_pa', title: 'C/PA', type: 'cadet', members: findMembersByDuty('CADET PUBLIC AFFAIRS', [], true) },
              { id: 'c_comm', title: 'C/Communications', type: 'cadet', members: findMembersByDuty('CADET COMMUNICATIONS', [], true) },
              { id: 'c_supply', title: 'C/Supply', type: 'cadet', members: findMembersByDuty('CADET SUPPLY', [], true) },
              { id: 'c_safety', title: 'C/Safety', type: 'cadet', members: findMembersByDuty('CADET SAFETY', [], true) }
            ];

            cadetOrgChildren.push(
              {
                id: 'c_dep_ops',
                title: 'C/Dep Cmdr Operations',
                type: 'cadet',
                members: findMembersByDuty('CADET DEPUTY COMMANDER FOR OPERATIONS', [], true),
                children: flightStructure
              },
              {
                id: 'c_dep_sup',
                title: 'C/Dep Cmdr Support',
                type: 'cadet',
                members: findMembersByDuty('CADET DEPUTY COMMANDER FOR SUPPORT', [], true),
                children: cDepSupChildren
              }
            );

            const cadetOrg = {
              id: 'ccmdr',
              title: 'Cadet Commander',
              type: 'cadet',
              members: cadetCommanders,
              children: cadetOrgChildren
            };
            
            // Track all assigned members and find unassigned ones
            const assignedCAPIDs = new Set();
            [...allDuties, ...allCadetDuties].forEach(d => {
              if (d.CAPID) assignedCAPIDs.add(d.CAPID);
            });

            // Find unassigned senior members
            const unassignedSeniors = unitMembers
              .filter(m => {
                const isSenior = (m.Type || m.TYPE) === "SENIOR" || (m.Type || m.TYPE) === "LIFE";
                return isSenior && !assignedCAPIDs.has(m.CAPID);
              })
              .map(m => `${m.Rank} ${m.NameLast}, ${m.NameFirst}`)
              .sort();

            const additionalMembersNode = {
              id: 'additional_members',
              title: `Additional Members (${unassignedSeniors.length})`,
              type: 'senior',
              members: unassignedSeniors,
              children: []
            };

            const nodeHasAnyMembers = (node) => {
              if (node.members && node.members.length > 0) return true;
              return (node.children || []).some(child => nodeHasAnyMembers(child));
            };

            const buildWingDeputyNodes = () => {
              const nodes = [];
              const opsChildren = [...wingDeputyOperationsStaff];
              if (unassignedSeniors.length > 0) {
                opsChildren.push(additionalMembersNode);
              }
              const opsNode = { ...deputyOpsNode, children: opsChildren };
              const supportNode = { ...deputySupportNode, children: [...wingDeputySupportStaff] };

              const opsHasContent = nodeHasAnyMembers(opsNode) || !hideVacant;
              const supportHasContent = nodeHasAnyMembers(supportNode) || !hideVacant;

              if (opsHasContent) nodes.push(opsNode);
              if (supportHasContent) nodes.push(supportNode);

              return nodes;
            };

            // Build a minimal command-chain subtree for a specific unit (commander's immediate chain)
            const buildUnitCommandChain = (orgId) => {
              const chain = [];
              const orgScoped = [String(orgId).trim()];
              const orgEntry = dataFiles.organization.find(o => String(o.ORGID).trim() === String(orgId).trim());
              const orgType = (orgEntry?.Type || '').toUpperCase();
              const isGroupOrg = orgType.includes('GROUP');
              const isCompositeUnit = orgType.includes('COMPOSITE');
              const isCadetUnit = orgType.includes('CADET');
              const isSeniorUnit = orgType.includes('SENIOR') || (!isCompositeUnit && !isCadetUnit && !isGroupOrg && !orgType.includes('WING'));
              // Restrict vacant positions based on unit type (always, not just in command chain view)
              // Composite squadrons and groups should not show vacant "Deputy Commander"
              const restrictDeputyVacant = isCompositeUnit || isGroupOrg;
              // Cadet, senior squadrons, and groups should not show vacant "DC for Seniors/Cadets"
              const restrictDeputySpecialVacant = isCadetUnit || isSeniorUnit || isGroupOrg;
              // Groups should not show vacant cadet chain
              const restrictCadetChainVacant = isGroupOrg;
              const allowVacantCadetChain = !restrictCadetChainVacant;

              const commanderChildren = [];

              // Deputies
              const deputyChain = findMembersByTitles(['DEPUTY COMMANDER'], { excludeWords: ['FOR SENIORS', 'FOR CADETS'], orgFilter: orgScoped });
              const deputyNode = (deputyChain.length > 0 || (!hideVacant && !restrictDeputyVacant))
                ? { id: `${orgId}_deputy`, title: 'Deputy Commander', type: 'senior', members: deputyChain, children: [] }
                : null;

              // No Deputy Commander for Seniors / Cadets at Group level
              const includeDeputySeniors = !isGroupOrg;
              const includeDeputyCadets = !isGroupOrg;

              const deputySeniors = includeDeputySeniors ? findMembersByTitles(['DEPUTY COMMANDER FOR SENIORS'], { orgFilter: orgScoped }) : [];
              const deputyCadets = includeDeputyCadets ? findMembersByTitles(['DEPUTY COMMANDER FOR CADETS'], { orgFilter: orgScoped }) : [];

              const deputySeniorsNode = (deputySeniors.length > 0 || (!hideVacant && includeDeputySeniors && !restrictDeputySpecialVacant))
                ? { id: `${orgId}_cds`, title: 'Deputy Commander for Seniors', type: 'senior', members: deputySeniors, children: [] }
                : null;
              const deputyCadetsNode = (deputyCadets.length > 0 || (!hideVacant && includeDeputyCadets && !restrictDeputySpecialVacant))
                ? { id: `${orgId}_cdc`, title: 'Deputy Commander for Cadets', type: 'senior', members: deputyCadets, children: [] }
                : null;

              // Cadet chain
              const cadetCommander = findMembersByTitles(['CADET COMMANDER'], { useCadetData: true, orgFilter: orgScoped });
              const cadetFirstSgt = findMembersByTitles(['CADET FIRST SERGEANT'], { useCadetData: true, orgFilter: orgScoped });
              const cadetDepOps = findMembersByTitles(['CADET DEPUTY COMMANDER FOR OPERATIONS'], { useCadetData: true, orgFilter: orgScoped });
              const cadetDepSup = findMembersByTitles(['CADET DEPUTY COMMANDER FOR SUPPORT'], { useCadetData: true, orgFilter: orgScoped });
              const flightCommanders = findMembersByTitles(['CADET FLIGHT COMMANDER'], { useCadetData: true, orgFilter: orgScoped });
              const flightSergeants = findMembersByTitles(['CADET FLIGHT SERGEANT'], { useCadetData: true, orgFilter: orgScoped });

              // Build flight structure for command chain
              const flightChainChildren = [];
              if (flightSergeants.length > 0 || (!hideVacant && allowVacantCadetChain)) {
                flightChainChildren.push({ id: `${orgId}_flight_sgt`, title: 'Flight Sergeants', type: 'cadet', members: flightSergeants, children: [] });
              }

              // Build C/Dep Cmdr Operations with flight commanders
              const depOpsChildren = [];
              if (flightCommanders.length > 0 || (!hideVacant && allowVacantCadetChain)) {
                depOpsChildren.push({ id: `${orgId}_flight_cmdr`, title: 'Flight Commanders', type: 'cadet', members: flightCommanders, children: flightChainChildren });
              }

              const cadetChildren = [];
              // Add First Sergeant
              if (cadetFirstSgt.length > 0 || (!hideVacant && allowVacantCadetChain)) {
                cadetChildren.push({ id: `${orgId}_c_first`, title: 'C/First Sergeant', type: 'cadet', members: cadetFirstSgt, children: [] });
              }
              // Add Deputy Commanders
              if (cadetDepOps.length > 0 || depOpsChildren.length > 0 || (!hideVacant && allowVacantCadetChain)) {
                cadetChildren.push({ id: `${orgId}_c_dep_ops`, title: 'C/Dep Cmdr Operations', type: 'cadet', members: cadetDepOps, children: depOpsChildren });
              }
              if (cadetDepSup.length > 0 || (!hideVacant && allowVacantCadetChain)) {
                cadetChildren.push({ id: `${orgId}_c_dep_sup`, title: 'C/Dep Cmdr Support', type: 'cadet', members: cadetDepSup, children: [] });
              }

              const cadetCommanderNode = (cadetCommander.length > 0 || cadetChildren.length > 0 || (!hideVacant && allowVacantCadetChain))
                ? { id: `${orgId}_ccmdr`, title: 'Cadet Commander', type: 'cadet', members: cadetCommander, children: cadetChildren }
                : null;

              // Attach cadet commander under DCC if present, else Deputy Commander, else top-level
              if (deputyCadetsNode && cadetCommanderNode) {
                deputyCadetsNode.children.push(cadetCommanderNode);
              } else if (deputyNode && cadetCommanderNode) {
                deputyNode.children.push(cadetCommanderNode);
              } else if (cadetCommanderNode) {
                commanderChildren.push(cadetCommanderNode);
              }

              if (deputySeniorsNode) commanderChildren.push(deputySeniorsNode);
              if (deputyCadetsNode) commanderChildren.push(deputyCadetsNode);
              if (deputyNode) commanderChildren.unshift(deputyNode);

              return commanderChildren;
            };

            // Group Commanders (Wing-level chain)
            let groupCommandNodes = [];
            if (isWing) {
              const groupOrgs = dataFiles.organization
                .filter(o => o.Type && o.Type.toUpperCase().includes('GROUP') && String(o.NextLevel).trim() === String(unitFilter).trim());

              if (showCommandChainOnly) {
                // Command Chain Only: Create separate node for each group with squadron commanders
                groupOrgs.forEach((groupOrg, index) => {
                  const groupOrgId = String(groupOrg.ORGID).trim();
                  const groupName = groupOrg.Name || `Group ${index + 1}`;

                  // Find group commander
                  const groupCmdrs = dataFiles.duty
                    .filter(d => String(d.ORGID).trim() === groupOrgId)
                    .filter(d => {
                      const dutyUpper = (d.Duty || '').toUpperCase();
                      if (!dutyUpper.includes('COMMANDER')) return false;
                      return !['DEPUTY', 'CADET', 'VICE', 'ADVISOR'].some(w => dutyUpper.includes(w));
                    })
                    .map(d => {
                      const mem = getMemberByCapid(d.CAPID);
                      if (!mem) return null;
                      const asst = d.Asst === "1" ? " (A)" : "";
                      return `${mem.Rank} ${mem.NameLast}, ${mem.NameFirst}${asst}||${mem.CAPID}`;
                    })
                    .filter(Boolean);

                  // Find squadron commanders under this group
                  const squadronChildren = unitChildrenMap.get(groupOrgId) || [];
                  const squadronNodes = squadronChildren
                    .map(squadronOrgId => {
                      const squadronOrg = dataFiles.organization.find(o => String(o.ORGID).trim() === squadronOrgId);
                      if (!squadronOrg) return null;

                      const squadronName = squadronOrg.Name || 'Squadron';
                      const squadronCmdrs = dataFiles.duty
                        .filter(d => String(d.ORGID).trim() === squadronOrgId)
                        .filter(d => {
                          const dutyUpper = (d.Duty || '').toUpperCase();
                          if (!dutyUpper.includes('COMMANDER')) return false;
                          return !['DEPUTY', 'CADET', 'VICE', 'ADVISOR'].some(w => dutyUpper.includes(w));
                        })
                        .map(d => {
                          const mem = getMemberByCapid(d.CAPID);
                          if (!mem) return null;
                          const asst = d.Asst === "1" ? " (A)" : "";
                          return `${mem.Rank} ${mem.NameLast}, ${mem.NameFirst}${asst}||${mem.CAPID}`;
                        })
                        .filter(Boolean);

                  return {
                    id: `squadron_cmdr_${squadronOrgId}`,
                    title: `${squadronName} Commander`,
                    type: 'senior',
                    members: squadronCmdrs,
                    children: buildUnitCommandChain(squadronOrgId)
                  };
                })
                .filter(Boolean);

                  const groupChain = buildUnitCommandChain(groupOrgId);
                  groupCommandNodes.push({
                    id: `group_cmdr_${groupOrgId}`,
                    title: `${groupName} Commander`,
                    type: 'senior',
                    members: groupCmdrs,
                    children: [...groupChain, ...squadronNodes]
                  });
                });
              } else {
                // Normal view: All group commanders in one box
                const groupOrgIds = groupOrgs.map(o => String(o.ORGID).trim());
                const groupCmdrs = dataFiles.duty
                  .filter(d => groupOrgIds.includes(String(d.ORGID).trim()))
                  .filter(d => {
                    const dutyUpper = (d.Duty || '').toUpperCase();
                    if (!dutyUpper.includes('COMMANDER')) return false;
                    return !['DEPUTY', 'CADET', 'VICE', 'ADVISOR'].some(w => dutyUpper.includes(w));
                  })
                  .map(d => {
                    const mem = getMemberByCapid(d.CAPID);
                    if (!mem) return null;
                    const asst = d.Asst === "1" ? " (A)" : "";
                    return `${mem.Rank} ${mem.NameLast}, ${mem.NameFirst}${asst}||${mem.CAPID}`;
                  })
                  .filter(Boolean);
                if (groupCmdrs.length > 0) {
                  groupCommandNodes.push({ id: 'group_cmdr', title: 'Group Commander', type: 'senior', members: groupCmdrs, children: [] });
                }
              }
            }

            // Squadron Commanders (Group-level chain)
            let squadronCommandNodes = [];
            if (isGroup) {
              const squadronChildren = unitChildrenMap.get(String(unitFilter).trim()) || [];

              if (showCommandChainOnly) {
                squadronCommandNodes = squadronChildren
                  .map(squadronOrgId => {
                    const squadronOrg = dataFiles.organization.find(o => String(o.ORGID).trim() === squadronOrgId);
                    if (!squadronOrg) return null;

                    const squadronName = squadronOrg.Name || 'Squadron';
                    const squadronCmdrs = dataFiles.duty
                      .filter(d => String(d.ORGID).trim() === squadronOrgId)
                      .filter(d => {
                        const dutyUpper = (d.Duty || '').toUpperCase();
                        if (!dutyUpper.includes('COMMANDER')) return false;
                        return !['DEPUTY', 'CADET', 'VICE', 'ADVISOR'].some(w => dutyUpper.includes(w));
                      })
                      .map(d => {
                        const mem = getMemberByCapid(d.CAPID);
                        if (!mem) return null;
                        const asst = d.Asst === "1" ? " (A)" : "";
                        return `${mem.Rank} ${mem.NameLast}, ${mem.NameFirst}${asst}||${mem.CAPID}`;
                      })
                      .filter(Boolean);

                    const squadronChain = buildUnitCommandChain(squadronOrgId);
                    return {
                      id: `squadron_cmdr_${squadronOrgId}`,
                      title: `${squadronName} Commander`,
                      type: 'senior',
                      members: squadronCmdrs,
                      children: squadronChain
                    };
                  })
                  .filter(Boolean);
              } else {
                const squadronCmdrs = [];
                squadronChildren.forEach(squadronOrgId => {
                  const squadronOrg = dataFiles.organization.find(o => String(o.ORGID).trim() === squadronOrgId);
                  if (!squadronOrg) return;

                  const squadronName = squadronOrg.Name || 'Squadron';
                  const commanders = dataFiles.duty
                    .filter(d => String(d.ORGID).trim() === squadronOrgId)
                    .filter(d => {
                      const dutyUpper = (d.Duty || '').toUpperCase();
                      if (!dutyUpper.includes('COMMANDER')) return false;
                      return !['DEPUTY', 'CADET', 'VICE', 'ADVISOR'].some(w => dutyUpper.includes(w));
                    })
                    .map(d => {
                      const mem = getMemberByCapid(d.CAPID);
                      if (!mem) return null;
                      const asst = d.Asst === "1" ? " (A)" : "";
                      return `${mem.Rank} ${mem.NameLast}, ${mem.NameFirst}${asst}||${mem.CAPID}`;
                    })
                    .filter(Boolean);

                  if (commanders.length > 0) {
                    squadronCmdrs.push(...commanders);
                  } else if (!hideVacant) {
                    squadronCmdrs.push(`Vacant`);
                  }
                });

                if (squadronCmdrs.length > 0 || !hideVacant) {
                  squadronCommandNodes.push({
                    id: 'squadron_cmdr',
                    title: 'Squadron Commanders',
                    type: 'senior',
                    members: squadronCmdrs,
                    children: []
                  });
                }
              }
            }

            // Build structure based on unit type
            if (isComposite) {
              // Add Wing-specific positions for Wings
              if (isWing) {
                if (chiefOfStaffNode.members.length > 0 || !hideVacant) {
                  orgStructure.children.push(chiefOfStaffNode);
                }
                if (seniorEnlistedLeaderNode.members.length > 0 || !hideVacant) {
                  orgStructure.children.push(seniorEnlistedLeaderNode);
                }
              }

              // Note: CACs (WCAC/GCAC) are now shown in the Committees panel, not on the org chart

              if (isWing) {
                if (deputySeniorNode.members.length > 0) {
                  deputySeniorNode.children = deputyCommanderStaff;
                  orgStructure.children.push(deputySeniorNode);
                }

                const wingDeputyNodes = buildWingDeputyNodes();
                if (wingDeputyNodes.length > 0) {
                  orgStructure.children.push(...wingDeputyNodes);
                } else {
                  orgStructure.children.push(...wingDeputySupportStaff, ...wingDeputyOperationsStaff);
                }
              } else {
                if (deputySeniorNode.members.length > 0) {
                  deputySeniorNode.children = seniorStaff;
                  // Add unassigned seniors under Deputy Commander for Seniors
                  if (unassignedSeniors.length > 0) {
                    deputySeniorNode.children.push(additionalMembersNode);
                  }
                  orgStructure.children.push(deputySeniorNode);
                } else if (deputyNode.members.length > 0) {
                  deputyNode.children = seniorStaff;
                  // Add unassigned seniors under Deputy Commander
                  if (unassignedSeniors.length > 0) {
                    deputyNode.children.push(additionalMembersNode);
                  }
                  orgStructure.children.push(deputyNode);
                } else {
                  orgStructure.children.push(...seniorStaff);
                }
              }
              
              if (deputyCadetNode.members.length > 0) {
                deputyCadetNode.children = [...cadetStaff, cadetOrg];
                orgStructure.children.push(deputyCadetNode);
              } else {
                orgStructure.children.push(...cadetStaff, cadetOrg);
              }
            } else if (isCadetOnly) {
              // Note: CACs (WCAC/GCAC) are now shown in the Committees panel, not on the org chart

              if (deputyNode.members.length > 0) {
                deputyNode.children = [...cadetStaff, cadetOrg];
                orgStructure.children.push(deputyNode);
              } else {
                orgStructure.children.push(...cadetStaff, cadetOrg);
              }
            } else {
              // Senior-only unit
              // Add Wing-specific positions for Wings
              if (isWing) {
                if (chiefOfStaffNode.members.length > 0 || !hideVacant) {
                  orgStructure.children.push(chiefOfStaffNode);
                }
                if (seniorEnlistedLeaderNode.members.length > 0 || !hideVacant) {
                  orgStructure.children.push(seniorEnlistedLeaderNode);
                }
              }

              if (isWing) {
                const wingDeputyNodes = buildWingDeputyNodes();
                if (wingDeputyNodes.length > 0) {
                  orgStructure.children.push(...wingDeputyNodes);
                } else {
                  orgStructure.children.push(...wingDeputySupportStaff, ...wingDeputyOperationsStaff);
                }
              } else if (deputyNode.members.length > 0) {
                deputyNode.children = seniorStaff;
                // Add unassigned seniors under Deputy Commander
                if (unassignedSeniors.length > 0) {
                  deputyNode.children.push(additionalMembersNode);
                }
                orgStructure.children.push(deputyNode);
              } else {
                orgStructure.children.push(...seniorStaff);
              }
            }

            // Create Commander's Staff grouping node
            const advisorNode = {
              id: 'advisor',
              title: 'Advisor to the Commander',
              type: 'senior',
              members: findMembersByDuty('ADVISOR TO THE COMMANDER'),
              children: []
            };
            const govRelationsAdvisorNode = {
              id: 'gov_relations',
              title: 'Government Relations Advisor',
              type: 'senior',
              members: findMembersByTitles(['GOVERNMENT RELATIONS ADVISOR']),
              children: []
            };

            // Combine all commander's staff positions into children array
            const commanderStaffChildren = [];

            // Add direct staff positions (Legal, Safety, Inspector General, etc.)
            directStaff.forEach(staffNode => {
              if (!hideVacant || staffNode.members.length > 0) {
                commanderStaffChildren.push(staffNode);
              }
            });

            // Add advisor positions
            if (advisorNode.members.length > 0 || !hideVacant) {
              commanderStaffChildren.push(advisorNode);
            }
            if (govRelationsAdvisorNode.members.length > 0 || !hideVacant) {
              commanderStaffChildren.push(govRelationsAdvisorNode);
            }

            // Create the Commander's Staff parent node
            const commanderStaffNode = {
              id: 'commander_staff',
              title: "Commander's Staff",
              type: 'senior',
              members: [], // No direct members, just a grouping
              children: commanderStaffChildren
            };

            // Only add Commander's Staff node if it has children
            if (commanderStaffChildren.length > 0) {
              orgStructure.children.unshift(commanderStaffNode);
            }

            if (groupCommandNodes.length > 0) {
              orgStructure.children.unshift(...groupCommandNodes);
            }

            if (squadronCommandNodes.length > 0) {
              orgStructure.children.unshift(...squadronCommandNodes);
            }

            return orgStructure;
          };

          setOrgChartData(buildOrgChart());
        }, [dataFiles, unitFilter, showAllDescendants, hideVacant, showCommandChainOnly]);

        const getAllNodeIds = (node) => {
          if (!node) return [];
          const ids = [node.id];
          if (node.children) {
            node.children.forEach(child => {
              ids.push(...getAllNodeIds(child));
            });
          }
          return ids;
        };

        // Auto-expand nodes when org chart is built (special handling for wing/group command-chain view)
        useEffect(() => {
          if (!orgChartData) return;

          const currentOrg = dataFiles.organization.find(o => o.ORGID === unitFilter);
          const currentType = currentOrg ? (currentOrg.Type || '').toUpperCase() : '';
          const isWing = currentType.includes('WING');
          const isGroup = currentType.includes('GROUP');

          if (showCommandChainOnly && (isWing || isGroup)) {
            const ids = new Set([orgChartData.id]);

            if (isWing) {
              // Wing: Expand root AND group commanders (to show squadron commanders)
              // But do NOT expand squadron commanders (so their deputies/cadet chain stay hidden)
              (orgChartData.children || []).forEach(child => {
                if (child.id.startsWith('group_cmdr_')) {
                  ids.add(child.id);
                }
              });
            }
            // Group: Only expand root, leave squadron commanders collapsed

            setExpandedSections(ids);
          } else {
            const allIds = getAllNodeIds(orgChartData);
            setExpandedSections(new Set(allIds));
          }
        }, [orgChartData, dataFiles.organization, unitFilter, showCommandChainOnly]);

        const toggleExpandCollapse = () => {
          if (!orgChartData) return;
          const allIds = getAllNodeIds(orgChartData);
          const isFullyExpanded = expandedSections.size === allIds.length;
          if (isFullyExpanded) setExpandedSections(new Set());
          else setExpandedSections(new Set(allIds));
        };

        const handleDragStart = (e, node) => {
          setDraggedNode(node);
          e.dataTransfer.effectAllowed = 'move';
        };

        const handleDrop = (e, targetNode) => {
          e.preventDefault();
          if (!draggedNode || draggedNode.id === targetNode.id) return;
          // Future: Implement custom org chart reorganization
        };

        const addNode = (parentId) => {
          // Future: Implement adding custom positions
        };

        const deleteNode = (nodeId) => {
          // Future: Implement removing positions
        };

        // Format last updated (remove seconds)
        const formatSyncTime = (isoString) => {
            if (!isoString) return 'N/A';
            const d = new Date(isoString);
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + 
                   (d.toDateString() !== new Date().toDateString() ? ` (${d.toLocaleDateString()})` : '');
        };

        const handleDownloadImage = async (format = 'png') => {
          const canvas = document.getElementById('org-chart-canvas');
          if (!canvas) {
            alert('Unable to find organization chart to export');
            return;
          }

          // Show loading indicator
          const loadingMsg = document.createElement('div');
          loadingMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px 40px;border-radius:8px;z-index:10000;font-size:16px;';
          loadingMsg.textContent = `Generating ${format.toUpperCase()}...`;
          document.body.appendChild(loadingMsg);

          try {
            // Temporarily remove scroll bars and expand container for capture
            const originalOverflow = canvas.style.overflow;
            const originalWidth = canvas.style.width;
            const originalHeight = canvas.style.height;

            canvas.style.overflow = 'visible';
            canvas.style.width = 'auto';
            canvas.style.height = 'auto';

            // Wait for layout to settle
            await new Promise(resolve => setTimeout(resolve, 100));

            // Capture with high quality settings
            const htmlCanvas = await html2canvas(canvas, {
              backgroundColor: '#ffffff',
              scale: 3, // Higher quality
              logging: false,
              useCORS: true,
              allowTaint: false,
              scrollX: 0,
              scrollY: 0,
              windowWidth: canvas.scrollWidth,
              windowHeight: canvas.scrollHeight,
              onclone: (clonedDoc) => {
                // Ensure all styles are preserved in clone
                const clonedCanvas = clonedDoc.getElementById('org-chart-canvas');
                if (clonedCanvas) {
                  clonedCanvas.style.overflow = 'visible';
                  clonedCanvas.style.minHeight = 'auto';
                  clonedCanvas.style.width = 'auto';
                  clonedCanvas.style.height = 'auto';

                  // Ensure background pattern is visible
                  clonedCanvas.style.background = 'radial-gradient(#e5e7eb 1px, transparent 1px)';
                  clonedCanvas.style.backgroundSize = '20px 20px';
                }
              }
            });

            // Restore original styles
            canvas.style.overflow = originalOverflow;
            canvas.style.width = originalWidth;
            canvas.style.height = originalHeight;

            if (format === 'pdf') {
              await exportOrgChartToPDF(htmlCanvas);
            } else {
              exportOrgChartToPNG(htmlCanvas);
            }
          } catch (error) {
            console.error('Error generating export:', error);
            alert('Error generating export. Please try again.');
          } finally {
            document.body.removeChild(loadingMsg);
          }
        };

        const exportOrgChartToPNG = (htmlCanvas) => {
          // Create high-quality PNG
          const imgData = htmlCanvas.toDataURL('image/png', 1.0);
          const link = document.createElement('a');
          const currentUnit = availableUnits.find(u => u.id === unitFilter);
          const unitNum = currentUnit?.unitNum || '000';
          const date = new Date().toISOString().split('T')[0];
          link.download = `org-chart-unit-${unitNum}-${date}.png`;
          link.href = imgData;
          link.click();
        };

        const exportOrgChartToPDF = async (htmlCanvas) => {
          const { jsPDF } = window.jspdf;
          if (!jsPDF) {
            alert('PDF library not loaded. Please refresh and try again.');
            return;
          }

          const imgWidth = htmlCanvas.width;
          const imgHeight = htmlCanvas.height;

          // Constants for PDF sizing (in mm)
          const A4_WIDTH = 210;
          const A4_HEIGHT = 297;
          const MARGIN = 15;
          const HEADER_HEIGHT = 30;

          // Determine if we need landscape
          const isWide = imgWidth > imgHeight;
          const pageWidth = isWide ? A4_HEIGHT : A4_WIDTH;
          const pageHeight = isWide ? A4_WIDTH : A4_HEIGHT;

          const pdf = new jsPDF({
            orientation: isWide ? 'landscape' : 'portrait',
            unit: 'mm',
            format: 'a4',
            compress: true
          });

          // Add header with metadata
          const currentUnit = availableUnits.find(u => u.id === unitFilter);
          const unitText = currentUnit ? currentUnit.name : `Unit ${unitFilter}`;

          pdf.setFontSize(14);
          pdf.setFont(undefined, 'bold');
          pdf.text('Organization Chart', pageWidth / 2, MARGIN, { align: 'center' });

          pdf.setFontSize(10);
          pdf.setFont(undefined, 'normal');
          pdf.text(`${unitText}${showAllDescendants ? ' (with sub-units)' : ''}`, pageWidth / 2, MARGIN + 6, { align: 'center' });
          pdf.text(`Generated: ${new Date().toLocaleString()}`, pageWidth / 2, MARGIN + 11, { align: 'center' });

          // Calculate available space for chart
          const availableWidth = pageWidth - (2 * MARGIN);
          const availableHeight = pageHeight - HEADER_HEIGHT - (2 * MARGIN);

          // Convert image dimensions from pixels to mm (assuming 96 DPI)
          const pixelsToMm = 0.264583;
          const imgWidthMm = imgWidth * pixelsToMm;
          const imgHeightMm = imgHeight * pixelsToMm;

          // Determine if we need multiple pages
          const scaleToFitWidth = availableWidth / imgWidthMm;
          const scaleToFitHeight = availableHeight / imgHeightMm;
          const scale = Math.min(scaleToFitWidth, scaleToFitHeight, 1); // Don't scale up

          const finalWidth = imgWidthMm * scale;
          const finalHeight = imgHeightMm * scale;

          // Check if chart fits on one page
          const fitsOnOnePage = finalWidth <= availableWidth && finalHeight <= availableHeight;

          if (fitsOnOnePage) {
            // Single page - center the chart
            const xOffset = MARGIN + (availableWidth - finalWidth) / 2;
            const yOffset = HEADER_HEIGHT + MARGIN;

            const imgData = htmlCanvas.toDataURL('image/png', 0.95);
            pdf.addImage(imgData, 'PNG', xOffset, yOffset, finalWidth, finalHeight, undefined, 'FAST');
          } else {
            // Chart is too large - create tiled pages
            const pagesWide = Math.ceil(finalWidth / availableWidth);
            const pagesTall = Math.ceil(finalHeight / availableHeight);

            // Add warning on first page
            pdf.setFontSize(9);
            pdf.setTextColor(200, 0, 0);
            pdf.text(`Note: Chart spans ${pagesWide} Ã— ${pagesTall} pages`, pageWidth / 2, MARGIN + 16, { align: 'center' });
            pdf.setTextColor(0, 0, 0);

            const imgData = htmlCanvas.toDataURL('image/png', 0.95);

            // Create a temporary canvas for tiling
            const tileCanvas = document.createElement('canvas');
            const tileCtx = tileCanvas.getContext('2d');
            const img = new Image();

            await new Promise((resolve) => {
              img.onload = () => {
                for (let row = 0; row < pagesTall; row++) {
                  for (let col = 0; col < pagesWide; col++) {
                    if (row > 0 || col > 0) {
                      pdf.addPage();
                      // Add header on each page
                      pdf.setFontSize(10);
                      pdf.setFont(undefined, 'bold');
                      pdf.text(`${unitText} - Page ${row * pagesWide + col + 1} of ${pagesWide * pagesTall}`, pageWidth / 2, MARGIN, { align: 'center' });
                    }

                    // Calculate source rectangle in original image
                    const srcX = col * (imgWidth / pagesWide);
                    const srcY = row * (imgHeight / pagesTall);
                    const srcWidth = Math.min(imgWidth / pagesWide, imgWidth - srcX);
                    const srcHeight = Math.min(imgHeight / pagesTall, imgHeight - srcY);

                    // Set tile canvas size
                    tileCanvas.width = srcWidth;
                    tileCanvas.height = srcHeight;

                    // Draw the tile
                    tileCtx.drawImage(img, srcX, srcY, srcWidth, srcHeight, 0, 0, srcWidth, srcHeight);

                    // Convert tile to data URL and add to PDF
                    const tileData = tileCanvas.toDataURL('image/png', 0.95);
                    const tileWidthMm = (srcWidth * pixelsToMm * scale);
                    const tileHeightMm = (srcHeight * pixelsToMm * scale);

                    pdf.addImage(tileData, 'PNG', MARGIN, HEADER_HEIGHT + MARGIN, tileWidthMm, tileHeightMm, undefined, 'FAST');
                  }
                }
                resolve();
              };
              img.src = imgData;
            });
          }

          // Save PDF
          const unitNum = currentUnit?.unitNum || '000';
          const date = new Date().toISOString().split('T')[0];
          pdf.save(`org-chart-unit-${unitNum}-${date}.pdf`);
        };

        // PDF Export Functions for Reports
        const detectOrientation = (report) => {
            const landscapeReports = [
              'promotion-requirements',
              'aerospace-education',
              'encampment-status',
              'near-promotion',
              'promotion',
              'tlc-compliance'
            ];

          if (report.data && report.data.length > 0) {
            const columnCount = Object.keys(report.data[0]).length;
            if (columnCount > 6 || landscapeReports.includes(report.type)) {
              return 'landscape';
            }
          }
          return 'portrait';
        };

        const generateFilename = (report) => {
          const currentUnit = availableUnits.find(u => u.id === unitFilter);
          const unitNum = currentUnit?.unitNum || '000';
          const reportSlug = report.title
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
          const date = new Date().toISOString().split('T')[0];

          return `unit-${unitNum}-${reportSlug}-${date}.pdf`;
        };

        const addPDFHeader = (pdf, report) => {
          let yPos = 15;

          // Title
          pdf.setFontSize(16);
          pdf.setFont(undefined, 'bold');
          pdf.text(report.title, pdf.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
          yPos += 8;

          // Unit info
          pdf.setFontSize(10);
          pdf.setFont(undefined, 'normal');
          const currentUnit = availableUnits.find(u => u.id === unitFilter);
          const unitText = currentUnit ? currentUnit.name : unitFilter;
          const subUnitText = showAllDescendants ? ' (including sub-units)' : '';
          pdf.text(`Unit: ${unitText}${subUnitText}`, 15, yPos);
          yPos += 5;

          // Data sync timestamp
          pdf.text(`Data as of: ${formatSyncTime(lastUpdated)}`, 15, yPos);
          yPos += 5;

          // Generation timestamp
          pdf.text(`Generated: ${new Date().toLocaleString()}`, 15, yPos);

          return yPos + 10;
        };

        const renderTableReport = (pdf, report, startY) => {
          if (!report.data || report.data.length === 0) {
            pdf.setFontSize(12);
            pdf.text('No data to display', 15, startY);
            return;
          }

          const formatRequirementStatus = (value) => {
            if (value === null || value === undefined) return 'N/A';
            return value ? 'Yes' : 'No';
          };

          const formatAchievement = (name, phase) => {
            if (!name) return '';
            if (!phase || phase === 'Complete' || name === 'Completed All') return name;
            return `${name} (${phase})`;
          };

          const formatProgress = (row) => {
            if (!row || !row.progress) return '';
            if (row.progress === 'Complete' || row.progress === 'N/A') return row.progress;
            if (Number.isFinite(row.percentComplete)) return `${row.progress} (${row.percentComplete}%)`;
            return row.progress;
          };

          // Define column configurations for each report type
          const columnConfigs = {
            'approval': [
              { header: 'Member', dataKey: 'memberName' },
              { header: 'Rank', dataKey: 'rank' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'Level', dataKey: 'levelName' },
              { header: 'Status', dataKey: 'status' }
            ],
            'promotion': [
              { header: 'Member', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Current Rank', dataKey: 'rank' },
              { header: 'Next Rank', dataKey: 'nextRank' },
              { header: 'TIG', dataKey: 'tigDisplay' },
              { header: 'Level', dataKey: 'levelDisplay' },
              { header: 'Duty', dataKey: 'dutyStatus' }
            ],
            'near-promotion': [
              { header: 'Member', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Rank', dataKey: 'rank' },
              { header: 'Next Rank', dataKey: 'nextRank' },
              { header: 'TIG Status', dataKey: 'tigStatus' },
              { header: 'Tasks Remaining', dataKey: 'tasksRemaining' },
              { header: 'Duty Status', dataKey: 'dutyStatus' }
            ],
            'cadet-no-promotion': [
              { header: 'Cadet Name', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'Rank', dataKey: 'rank' },
              { header: 'Last Promotion', dataKey: 'lastPromotion' },
              { header: 'Days Since', dataKey: 'daysSince' }
            ],
            'membership-lapse': [
              { header: 'Member Name', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'Type', dataKey: 'memberType' },
              { header: 'Rank', dataKey: 'rank' },
              { header: 'Expiration', dataKey: 'expiration' },
              { header: 'Days Until', dataKey: 'daysUntil' }
            ],
            'cadet-protection': [
              { header: 'Member', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'Type', dataKey: 'memberType' },
              { header: 'Rank', dataKey: 'rank' },
              { header: 'Course', dataKey: 'course' },
              { header: 'Requirement', dataKey: 'requirement' },
              { header: 'Status', dataKey: 'status' },
              { header: 'Last Completed', dataKey: 'lastCompleted' },
              { header: 'Expiration', dataKey: 'expiration' },
              { header: 'Days', dataKey: 'daysText' }
            ],
            'aerospace-education': [
              { header: 'Cadet Name', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'Rank', dataKey: 'rank' },
              { header: 'M1 Interactive', dataKey: (row) => row.module1?.interactiveCompleted ? (row.module1.interactiveDate || 'âœ“') : '' },
              { header: 'M1 Test', dataKey: (row) => row.module1?.testCompleted ? `${row.module1.testScore}% (${row.module1.testDate})` : '' },
              { header: 'M2 Interactive', dataKey: (row) => row.module2?.interactiveCompleted ? (row.module2.interactiveDate || 'âœ“') : '' },
              { header: 'M2 Test', dataKey: (row) => row.module2?.testCompleted ? `${row.module2.testScore}% (${row.module2.testDate})` : '' },
              { header: 'M3 Interactive', dataKey: (row) => row.module3?.interactiveCompleted ? (row.module3.interactiveDate || 'âœ“') : '' },
              { header: 'M3 Test', dataKey: (row) => row.module3?.testCompleted ? `${row.module3.testScore}% (${row.module3.testDate})` : '' },
              { header: 'M4 Interactive', dataKey: (row) => row.module4?.interactiveCompleted ? (row.module4.interactiveDate || 'âœ“') : '' },
              { header: 'M4 Test', dataKey: (row) => row.module4?.testCompleted ? `${row.module4.testScore}% (${row.module4.testDate})` : '' },
              { header: 'M5 Interactive', dataKey: (row) => row.module5?.interactiveCompleted ? (row.module5.interactiveDate || 'âœ“') : '' },
              { header: 'M5 Test', dataKey: (row) => row.module5?.testCompleted ? `${row.module5.testScore}% (${row.module5.testDate})` : '' },
              { header: 'M6 Interactive', dataKey: (row) => row.module6?.interactiveCompleted ? (row.module6.interactiveDate || 'âœ“') : '' },
              { header: 'M6 Test', dataKey: (row) => row.module6?.testCompleted ? `${row.module6.testScore}% (${row.module6.testDate})` : '' },
              { header: 'M7 Interactive', dataKey: (row) => row.module7?.interactiveCompleted ? (row.module7.interactiveDate || 'âœ“') : '' },
              { header: 'M7 Test', dataKey: (row) => row.module7?.testCompleted ? `${row.module7.testScore}% (${row.module7.testDate})` : '' }
            ],
            'encampment-status': [
              { header: 'Cadet Name', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'Rank', dataKey: 'rank' },
              { header: 'Encampment', dataKey: 'encampmentStatus' },
              { header: 'Date', dataKey: 'completionDate' }
            ],
            'oflight-status': [
              { header: 'Cadet Name', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'Join Date', dataKey: 'joinDate' },
              { header: 'Age', dataKey: 'age' },
              { header: '6', dataKey: (row) => row.syllabus6?.completed ? (row.syllabus6.date || 'âœ“') : '' },
              { header: '7', dataKey: (row) => row.syllabus7?.completed ? (row.syllabus7.date || 'âœ“') : '' },
              { header: '8', dataKey: (row) => row.syllabus8?.completed ? (row.syllabus8.date || 'âœ“') : '' },
              { header: '9', dataKey: (row) => row.syllabus9?.completed ? (row.syllabus9.date || 'âœ“') : '' },
              { header: '10', dataKey: (row) => row.syllabus10?.completed ? (row.syllabus10.date || 'âœ“') : '' },
              { header: 'Total', dataKey: (row) => row.backSeatRides > 0 ? `${row.totalPoweredFlights} (+${row.backSeatRides})` : String(row.totalPoweredFlights) }
            ],
            'recent-promotions': [
              { header: 'Member Name', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'New Rank', dataKey: 'rank' },
              { header: 'Date', dataKey: 'promotionDate' }
            ],
            'promotion-requirements': [
              { header: 'Cadet', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'Rank', dataKey: 'rank' },
              { header: 'Current', dataKey: (row) => formatAchievement(row.currentAchievement, row.currentPhase) },
              { header: 'Next', dataKey: (row) => formatAchievement(row.nextAchievement, row.nextPhase) },
              { header: 'Leadership', dataKey: (row) => formatRequirementStatus(row.leadership) },
              { header: 'Aerospace', dataKey: (row) => formatRequirementStatus(row.aerospace) },
              { header: 'Fitness', dataKey: (row) => formatRequirementStatus(row.fitness) },
              { header: 'Character', dataKey: (row) => formatRequirementStatus(row.character) },
              { header: 'Activity/Special', dataKey: (row) => formatRequirementStatus(row.activity) },
              { header: 'Progress', dataKey: (row) => formatProgress(row) }
            ],
            'approaching-age-milestone': [
              { header: 'Cadet Name', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'Rank', dataKey: 'rank' },
              { header: 'DOB', dataKey: 'dob' },
              { header: 'Current Age', dataKey: 'currentAge' },
              { header: 'Milestone', dataKey: 'milestoneLabel' },
              { header: 'Milestone Date', dataKey: 'milestoneDate' },
              { header: 'Days Until', dataKey: 'daysUntil' }
            ],
            'tlc-compliance': (report) => {
              const isUnitSummary = report.meta && report.meta.view === 'unit-summary';
              if (isUnitSummary) {
                return [
                  { header: 'Unit', dataKey: 'unit' },
                  { header: 'Qualified', dataKey: 'qualified' },
                  { header: 'Required', dataKey: 'required' },
                  { header: 'Status', dataKey: 'compliance' },
                  { header: 'Current', dataKey: 'current' },
                  { header: 'Due Soon', dataKey: 'dueSoon' },
                  { header: 'Expired', dataKey: 'expired' },
                  { header: 'Missing', dataKey: 'missing' },
                  { header: 'Total Seniors', dataKey: 'totalMembers' }
                ];
              }
              return [
                { header: 'Member', dataKey: 'memberName' },
                { header: 'CAPID', dataKey: 'capid' },
                { header: 'Unit', dataKey: 'unit' },
                { header: 'Rank', dataKey: 'rank' },
                { header: 'Duties', dataKey: 'dutySummary' },
                { header: 'TLC Course', dataKey: 'course' },
                { header: 'Status', dataKey: 'status' },
                { header: 'Completed', dataKey: 'completed' },
                { header: 'Expires', dataKey: 'expiration' },
                { header: 'Days', dataKey: 'daysText' }
              ];
            },
            'recruiting-trends': [
              { header: 'Month', dataKey: 'month' },
              { header: 'New', dataKey: 'totalNew' },
              { header: 'Rejoin', dataKey: 'totalRejoin' },
              { header: 'Total', dataKey: 'totalRecruited' },
              { header: 'Members', dataKey: 'totalMembers' }
            ],
            'retention-analysis': [
              { header: 'Member', dataKey: 'memberName' },
              { header: 'CAPID', dataKey: 'capid' },
              { header: 'Type', dataKey: 'memberType' },
              { header: 'Unit', dataKey: 'unit' },
              { header: 'Expires', dataKey: 'expiration' },
              { header: 'Days', dataKey: 'daysUntil' }
            ]
            };

            const config = columnConfigs[report.type];
            const columns = (typeof config === 'function' ? config(report) : config) ||
              Object.keys(report.data[0]).map(key => ({
                header: key.replace(/([A-Z])/g, ' $1').trim(),
                dataKey: key
              }));

          pdf.autoTable({
            startY,
            head: [columns.map(c => c.header)],
            body: report.data.map(row => columns.map(c => {
              const value = typeof c.dataKey === 'function' ? c.dataKey(row) : row[c.dataKey];
              if (typeof value === 'boolean') return value ? 'âœ“' : 'â—‹';
              if (value === null || value === undefined) return '';
              return String(value);
            })),
            styles: {
              fontSize: 8,
              cellPadding: 2
            },
            headStyles: {
              fillColor: [71, 85, 105],
              textColor: 255,
              fontStyle: 'bold',
              fontSize: 9
            },
            alternateRowStyles: {
              fillColor: [248, 250, 252]
            },
            margin: { left: 15, right: 15 },
            theme: 'grid'
          });
        };

        const renderTrainingReport = (pdf, report, startY) => {
          let yPos = startY;

          report.data.forEach((item, idx) => {
            if (yPos > pdf.internal.pageSize.getHeight() - 40) {
              pdf.addPage();
              yPos = 20;
            }

            pdf.setFontSize(11);
            pdf.setFont(undefined, 'bold');
            pdf.text(`${idx + 1}. ${item.taskName}`, 15, yPos);
            yPos += 6;

            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Level: ${item.level} | Group: ${item.groupName}`, 20, yPos);
            yPos += 5;

            pdf.text(`Needed by: ${item.neededByCount} members (${item.percentageOfUnit}% of unit)`, 20, yPos);
            yPos += 5;

            if (item.description) {
              const descLines = pdf.splitTextToSize(item.description, 170);
              pdf.text(descLines, 20, yPos);
              yPos += descLines.length * 4;
            }

            yPos += 8;
          });
        };

        const renderDiscrepanciesReport = (pdf, report, startY) => {
          let yPos = startY;

          report.data.forEach((item, idx) => {
            if (yPos > pdf.internal.pageSize.getHeight() - 40) {
              pdf.addPage();
              yPos = 20;
            }

            pdf.setFontSize(10);
            pdf.setFont(undefined, 'bold');
            pdf.text(`${item.memberName} (${item.capid})`, 15, yPos);
            yPos += 5;

            pdf.setFontSize(8);
            pdf.setFont(undefined, 'normal');
            pdf.text(`Rank: ${item.rank}`, 20, yPos);
            yPos += 5;

            pdf.setFont(undefined, 'bold');
            pdf.text('Issues:', 20, yPos);
            yPos += 5;

            pdf.setFont(undefined, 'normal');
            if (item.issues && item.issues.length > 0) {
              item.issues.forEach(issue => {
                const issueText = `- ${issue.duty} requires ${issue.requiredTrack} track`;
                const issueLines = pdf.splitTextToSize(issueText, 165);
                pdf.text(issueLines, 25, yPos);
                yPos += issueLines.length * 5;
              });
            }

            yPos += 8;
          });
        };

        const renderAerospaceEducationReport = (pdf, report, startY) => {
          let yPos = startY;
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const marginLeft = 10;
          const marginRight = 10;
          const marginBottom = 15;
          const availableWidth = pageWidth - marginLeft - marginRight;
          const headerHeight = 12;
          const rowHeight = 12;
          const cellPaddingX = 1.5;
          const completeMark = 'OK';
          const incompleteMark = '--';
          const honorMark = '*';

          const colWidths = {
            name: 50,
            capid: 22,
            module: 0
          };
          const fixedWidth = colWidths.name + colWidths.capid;
          colWidths.module = (availableWidth - fixedWidth) / 7;

          const trimTextToWidth = (text, maxWidth) => {
            if (!text) return '';
            if (pdf.getTextWidth(text) <= maxWidth) return text;
            const ellipsis = '...';
            let trimmed = text;
            while (trimmed.length > 0 && pdf.getTextWidth(trimmed + ellipsis) > maxWidth) {
              trimmed = trimmed.slice(0, -1);
            }
            return trimmed ? trimmed + ellipsis : '';
          };

          const formatDateShort = (value) => {
            if (!value) return '';
            const raw = String(value).trim();
            if (!raw) return '';
            let match = raw.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
            let year;
            let month;
            let day;
            if (match) {
              year = Number(match[1]);
              month = Number(match[2]);
              day = Number(match[3]);
            } else {
              match = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
              if (match) {
                month = Number(match[1]);
                day = Number(match[2]);
                year = Number(match[3]);
              } else {
                const parsed = new Date(raw);
                if (Number.isNaN(parsed.getTime())) {
                  return raw;
                }
                month = parsed.getMonth() + 1;
                day = parsed.getDate();
                year = parsed.getFullYear();
              }
            }
            if (!year || !month || !day) return raw;
            const yy = String(year).slice(-2);
            const mm = String(month).padStart(2, '0');
            const dd = String(day).padStart(2, '0');
            return `${mm}/${dd}/${yy}`;
          };

          pdf.setFontSize(7);
          pdf.setFont(undefined, 'normal');
          pdf.text('Legend: I=Interactive, T=Test, OK=Completed, --=Not started, *=Honor credit, Dates=MM/DD/YY', marginLeft, yPos);
          yPos += 6;

          const drawHeader = (topY) => {
            let xPos = marginLeft;
            const headerBaseline = topY + 8;
            const subHeaderY = topY + 10;

            pdf.setFillColor(244, 247, 252);
            pdf.rect(marginLeft, topY, availableWidth, headerHeight, 'F');

            pdf.setFontSize(8);
            pdf.setFont(undefined, 'bold');
            pdf.text('Cadet Name', xPos + cellPaddingX, headerBaseline);
            xPos += colWidths.name;
            pdf.text('CAPID', xPos + cellPaddingX, headerBaseline);
            xPos += colWidths.capid;

            for (let i = 1; i <= 7; i++) {
              pdf.text(`M${i}`, xPos + colWidths.module / 2, headerBaseline, { align: 'center' });
              xPos += colWidths.module;
            }

            pdf.setFontSize(6);
            pdf.setFont(undefined, 'normal');
            xPos = marginLeft + colWidths.name + colWidths.capid;
            for (let i = 1; i <= 7; i++) {
              pdf.text('I', xPos + colWidths.module * 0.25, subHeaderY);
              pdf.text('T', xPos + colWidths.module * 0.75, subHeaderY);
              xPos += colWidths.module;
            }

            pdf.setDrawColor(210);
            pdf.line(marginLeft, topY + headerHeight, pageWidth - marginRight, topY + headerHeight);
            return topY + headerHeight + 2;
          };

          const drawModuleCell = (module, x, topY) => {
            const half = colWidths.module / 2;
            const primaryY = topY + 4.5;
            const secondaryY = topY + 8.5;
            const interactiveDate = formatDateShort(module.interactiveDate);
            const testDate = formatDateShort(module.testDate);
            const leftCenterX = x + half / 2;
            const rightCenterX = x + half + half / 2;

            pdf.setDrawColor(220);
            pdf.setFillColor(module.interactiveCompleted ? 221 : 248, module.interactiveCompleted ? 243 : 248, module.interactiveCompleted ? 236 : 248);
            pdf.rect(x, topY, half, rowHeight, 'F');
            pdf.setFillColor(module.testCompleted ? 224 : 248, module.testCompleted ? 231 : 248, module.testCompleted ? 255 : 248);
            pdf.rect(x + half, topY, half, rowHeight, 'F');

            pdf.setDrawColor(220);
            pdf.rect(x, topY, colWidths.module, rowHeight);
            pdf.line(x + half, topY, x + half, topY + rowHeight);

            pdf.setFontSize(6);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(module.interactiveCompleted ? 34 : 160, module.interactiveCompleted ? 139 : 160, module.interactiveCompleted ? 34 : 160);
            pdf.text(module.interactiveCompleted ? completeMark : incompleteMark, leftCenterX, primaryY, { align: 'center' });
            if (interactiveDate) {
              pdf.setFont(undefined, 'normal');
              pdf.text(trimTextToWidth(interactiveDate, half - 2), leftCenterX, secondaryY, { align: 'center' });
            }

            pdf.setFontSize(6);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(module.testCompleted ? 25 : 160, module.testCompleted ? 118 : 160, module.testCompleted ? 210 : 160);
            if (module.testCompleted) {
              pdf.text(`${module.testScore}%`, rightCenterX, primaryY, { align: 'center' });
            } else {
              pdf.text(incompleteMark, rightCenterX, primaryY, { align: 'center' });
            }
            if (testDate) {
              pdf.setFont(undefined, 'normal');
              pdf.text(trimTextToWidth(testDate, half - 2), rightCenterX, secondaryY, { align: 'center' });
            }

            pdf.setTextColor(0);
          };

          yPos = drawHeader(yPos);

          report.data.forEach((cadet, idx) => {
            if (yPos + rowHeight > pageHeight - marginBottom) {
              pdf.addPage();
              yPos = 20;
              yPos = drawHeader(yPos);
            }

            if (idx % 2 === 1) {
              pdf.setFillColor(250, 251, 252);
              pdf.rect(marginLeft, yPos, availableWidth, rowHeight, 'F');
            }

            let xPos = marginLeft;

            pdf.setFontSize(7);
            pdf.setFont(undefined, 'normal');
            const nameText = trimTextToWidth(cadet.memberName, colWidths.name - 2);
            pdf.text(nameText, xPos + cellPaddingX, yPos + 7);
            xPos += colWidths.name;

            pdf.setFontSize(6.5);
            pdf.text(trimTextToWidth(String(cadet.capid), colWidths.capid - 2), xPos + cellPaddingX, yPos + 7);
            xPos += colWidths.capid;

            for (let i = 1; i <= 7; i++) {
              const module = cadet[`module${i}`] || {
                interactiveCompleted: false,
                interactiveDate: '',
                testCompleted: false,
                testScore: '',
                testDate: '',
                honorCredit: false
              };
              drawModuleCell(module, xPos, yPos);
              if (module.honorCredit) {
                pdf.setTextColor(255, 191, 0);
                pdf.setFontSize(7);
                pdf.text(honorMark, xPos + colWidths.module - 3, yPos + 3);
                pdf.setTextColor(0);
              }
              xPos += colWidths.module;
            }

            pdf.setDrawColor(235);
            pdf.line(marginLeft, yPos + rowHeight, pageWidth - marginRight, yPos + rowHeight);
            yPos += rowHeight + 1;
          });
        };

        const renderOFlightReport = (pdf, report, startY) => {
          let yPos = startY;
          const pageWidth = pdf.internal.pageSize.getWidth();

          // Calculate statistics
          const stats = (report.data || []).reduce((acc, row) => {
            acc.totalCadets += 1;
            if (!row.hasAnyFlight) acc.noFlights += 1;
            if (row.completedSyllabi === 5) acc.allComplete += 1;
            acc.totalPoweredFlights += row.totalPoweredFlights || 0;
            acc.totalBackSeat += row.backSeatRides || 0;
            for (let i = 6; i <= 10; i++) {
              if (row[`syllabus${i}`]?.completed) acc[`syl${i}`] = (acc[`syl${i}`] || 0) + 1;
            }
            return acc;
          }, { totalCadets: 0, noFlights: 0, allComplete: 0, totalPoweredFlights: 0, totalBackSeat: 0, syl6: 0, syl7: 0, syl8: 0, syl9: 0, syl10: 0 });

          const participationRate = stats.totalCadets > 0 ? Math.round(((stats.totalCadets - stats.noFlights) / stats.totalCadets) * 100) : 0;

          // Help text / legend
          pdf.setFontSize(8);
          pdf.setFont(undefined, 'normal');
          pdf.text('Syllabus Legend:', 15, yPos);
          yPos += 4;
          pdf.setFontSize(7);
          pdf.text('6: Ground Handling, Preflight, Takeoff & Landing  |  7: Normal Flight Maneuvers  |  8: Advanced Flight Maneuvers', 15, yPos);
          yPos += 3.5;
          pdf.text('9: Use of Instruments in Flight  |  10: Weather  |  Highlighted rows = No O-Flights yet', 15, yPos);
          yPos += 6;

          // Summary statistics
          pdf.setFontSize(9);
          pdf.setFont(undefined, 'bold');
          pdf.text('Summary Statistics', 15, yPos);
          yPos += 5;

          pdf.setFontSize(8);
          pdf.setFont(undefined, 'normal');
          const statsLine1 = `Total Cadets: ${stats.totalCadets}  |  No O-Flights: ${stats.noFlights}  |  All 5 Complete: ${stats.allComplete}  |  Participation Rate: ${participationRate}%`;
          pdf.text(statsLine1, 15, yPos);
          yPos += 4;

          const statsLine2 = `Total Powered Flights: ${stats.totalPoweredFlights}  |  Back Seat Rides: ${stats.totalBackSeat}`;
          pdf.text(statsLine2, 15, yPos);
          yPos += 5;

          // Syllabus breakdown
          const sylBreakdown = `Syllabus Completion:  6: ${stats.syl6}  |  7: ${stats.syl7}  |  8: ${stats.syl8}  |  9: ${stats.syl9}  |  10: ${stats.syl10}`;
          pdf.text(sylBreakdown, 15, yPos);
          yPos += 8;

          // Table with centered syllabus columns
          if (!report.data || report.data.length === 0) {
            pdf.setFontSize(10);
            pdf.text('No cadet data available.', 15, yPos);
            return;
          }

          const columns = [
            { header: 'Cadet Name', dataKey: 'memberName' },
            { header: 'CAPID', dataKey: 'capid' },
            { header: 'Unit', dataKey: 'unit' },
            { header: 'Join Date', dataKey: 'joinDate' },
            { header: 'Age', dataKey: 'age' },
            { header: '6', dataKey: (row) => row.syllabus6?.completed ? (row.syllabus6.date || 'âœ“') : '' },
            { header: '7', dataKey: (row) => row.syllabus7?.completed ? (row.syllabus7.date || 'âœ“') : '' },
            { header: '8', dataKey: (row) => row.syllabus8?.completed ? (row.syllabus8.date || 'âœ“') : '' },
            { header: '9', dataKey: (row) => row.syllabus9?.completed ? (row.syllabus9.date || 'âœ“') : '' },
            { header: '10', dataKey: (row) => row.syllabus10?.completed ? (row.syllabus10.date || 'âœ“') : '' },
            { header: 'Total', dataKey: (row) => row.backSeatRides > 0 ? `${row.totalPoweredFlights} (+${row.backSeatRides})` : String(row.totalPoweredFlights) }
          ];

          pdf.autoTable({
            startY: yPos,
            head: [columns.map(c => c.header)],
            body: report.data.map(row => columns.map(c => {
              const value = typeof c.dataKey === 'function' ? c.dataKey(row) : row[c.dataKey];
              if (value === null || value === undefined) return '';
              return String(value);
            })),
            styles: {
              fontSize: 7,
              cellPadding: 1.5
            },
            headStyles: {
              fillColor: [14, 116, 144], // sky-700
              textColor: 255,
              fontStyle: 'bold',
              fontSize: 8,
              halign: 'center'
            },
            columnStyles: {
              0: { cellWidth: 'auto' }, // Cadet Name
              1: { cellWidth: 20 }, // CAPID
              2: { cellWidth: 22 }, // Unit
              3: { cellWidth: 18 }, // Join Date
              4: { cellWidth: 10, halign: 'center' }, // Age
              5: { cellWidth: 18, halign: 'center' }, // Syllabus 6
              6: { cellWidth: 18, halign: 'center' }, // Syllabus 7
              7: { cellWidth: 18, halign: 'center' }, // Syllabus 8
              8: { cellWidth: 18, halign: 'center' }, // Syllabus 9
              9: { cellWidth: 18, halign: 'center' }, // Syllabus 10
              10: { cellWidth: 14, halign: 'center' } // Total
            },
            alternateRowStyles: {
              fillColor: [248, 250, 252]
            },
            didParseCell: function(data) {
              // Highlight rows with no flights (amber background)
              if (data.section === 'body') {
                const rowData = report.data[data.row.index];
                if (rowData && !rowData.hasAnyFlight) {
                  data.cell.styles.fillColor = [254, 243, 199]; // amber-100
                }
              }
            },
            margin: { left: 15, right: 15 },
            theme: 'grid'
          });
        };

        const renderQCUAReport = (pdf, report, startY) => {
          const rows = report.data || [];
          const meta = report.meta || {};
          const isMultiUnit = meta.view === 'multi-unit';
          let yPos = startY;
          const pageHeight = pdf.internal.pageSize.getHeight();

          // Summary stats
          pdf.setFontSize(9);
          pdf.setFont(undefined, 'normal');
          pdf.text(`Award Cycle: ${meta.cycleStart || 'N/A'} to ${meta.cycleEnd || 'N/A'}`, 15, yPos);
          yPos += 5;
          pdf.text(`Total Units: ${meta.totalUnits || 0} | On Track: ${meta.onTrackUnits || 0} | Eligible (10+ cadets): ${meta.eligibleUnits || 0}`, 15, yPos);
          yPos += 8;

          if (isMultiUnit && rows.length > 0) {
            // Multi-unit summary table
            const tableHead = [['Unit', 'Cadets', 'Status', 'Score', 'WB', 'ENC', 'ENR', 'GES', 'ONB', 'OFL', 'TLC']];
            const tableBody = rows.map(unit => {
              const getSymbol = (c) => {
                if (!c.trackable) return '?';
                if (c.met === null) return '-';
                return c.met ? 'Y' : 'N';
              };
              return [
                unit.unitName,
                unit.totalCadets.toString(),
                unit.awardStatus === 'Ineligible (< 10 cadets)' ? '<10' : unit.awardStatus.replace('Potentially ', 'Pot. '),
                `${unit.criteriaMet}/10`,
                getSymbol(unit.criteria.cadetAchievement),
                getSymbol(unit.criteria.encampment),
                getSymbol(unit.criteria.enrollment),
                getSymbol(unit.criteria.emergencyServices),
                getSymbol(unit.criteria.onboarding),
                getSymbol(unit.criteria.orientationFlights),
                getSymbol(unit.criteria.tlcGraduates)
              ];
            });

            pdf.autoTable({
              head: tableHead,
              body: tableBody,
              startY: yPos,
              styles: { fontSize: 7, cellPadding: 2 },
              headStyles: { fillColor: [71, 85, 105], textColor: 255 },
              columnStyles: {
                0: { cellWidth: 35 },
                1: { cellWidth: 15, halign: 'center' },
                2: { cellWidth: 25, halign: 'center' },
                3: { cellWidth: 15, halign: 'center' },
                4: { cellWidth: 12, halign: 'center' },
                5: { cellWidth: 12, halign: 'center' },
                6: { cellWidth: 12, halign: 'center' },
                7: { cellWidth: 12, halign: 'center' },
                8: { cellWidth: 12, halign: 'center' },
                9: { cellWidth: 12, halign: 'center' },
                10: { cellWidth: 12, halign: 'center' }
              },
              margin: { left: 15, right: 15 },
              theme: 'grid'
            });

            yPos = pdf.lastAutoTable.finalY + 8;

            // Legend
            pdf.setFontSize(7);
            pdf.text('Legend: Y=Met, N=Not Met, ?=Not Trackable, -=N/A', 15, yPos);
            yPos += 4;
            pdf.text('WB=Wright Brothers, ENC=Encampment, ENR=Enrollment, GES=Emergency Services, ONB=Onboarding, OFL=O-Flights, TLC=TLC Graduates', 15, yPos);
            yPos += 4;
            pdf.text('+ 3 non-trackable: Aerospace (AEX/STEM Kit), Local Action (4 events), STEM Team', 15, yPos);
          } else {
            // Single unit detailed view
            rows.forEach((unit, idx) => {
              if (yPos > pageHeight - 60) {
                pdf.addPage();
                yPos = 20;
              }

              // Unit header
              pdf.setFontSize(12);
              pdf.setFont(undefined, 'bold');
              pdf.text(unit.unitName, 15, yPos);
              yPos += 6;

              pdf.setFontSize(9);
              pdf.setFont(undefined, 'normal');
              pdf.text(`Status: ${unit.awardStatus} | Criteria Met: ${unit.criteriaMet}/10 | Cadets: ${unit.totalCadets} | Seniors: ${unit.totalSeniors}`, 15, yPos);
              yPos += 8;

              // Criteria table for single unit
              const criteriaOrder = [
                ['cadetAchievement', 'Cadet Achievement (45% WB)'],
                ['encampment', 'Encampment (50%)'],
                ['enrollment', 'Enrollment (25+ cadets)'],
                ['emergencyServices', 'Emergency Services (60% GES)'],
                ['onboarding', 'Onboarding (70% in 8 wks)'],
                ['orientationFlights', 'Orientation Flights (70%)'],
                ['tlcGraduates', 'TLC Graduates (3+)'],
                ['aerospace', 'Aerospace (AEX/STEM Kit)'],
                ['localAction', 'Local Action (4 events)'],
                ['stemTeam', 'STEM Team']
              ];

              const tableBody = criteriaOrder.map(([key, label]) => {
                const c = unit.criteria[key];
                if (!c) return [label, '-', '-', '-'];

                const status = !c.trackable ? 'Not Trackable' : c.met === null ? 'N/A' : c.met ? 'MET' : 'NOT MET';
                let value = '';
                if (!c.trackable) {
                  value = c.notTrackableReason || 'N/A';
                } else if (c.noNewCadets) {
                  value = 'No new cadets';
                } else if (c.isCountBased) {
                  value = `${c.count}/${c.threshold}`;
                } else if (c.percent !== null) {
                  value = `${c.percent}% (${c.count}/${c.total})`;
                }

                return [label, status, value];
              });

              pdf.autoTable({
                head: [['Criterion', 'Status', 'Value']],
                body: tableBody,
                startY: yPos,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [71, 85, 105], textColor: 255 },
                columnStyles: {
                  0: { cellWidth: 70 },
                  1: { cellWidth: 30, halign: 'center' },
                  2: { cellWidth: 60 }
                },
                margin: { left: 15, right: 15 },
                theme: 'grid',
                didParseCell: function(data) {
                  if (data.section === 'body' && data.column.index === 1) {
                    const status = data.cell.raw;
                    if (status === 'MET') {
                      data.cell.styles.textColor = [22, 163, 74]; // emerald
                    } else if (status === 'NOT MET') {
                      data.cell.styles.textColor = [220, 38, 38]; // red
                    } else {
                      data.cell.styles.textColor = [100, 116, 139]; // slate
                    }
                  }
                }
              });

              yPos = pdf.lastAutoTable.finalY + 12;
            });
          }
        };

        // QUA (Quality Unit Award) PDF Report Renderer
        const renderQUAReport = (pdf, report, startY) => {
          const rows = report.data || [];
          const meta = report.meta || {};
          const isMultiUnit = meta.view === 'multi-unit';
          let yPos = startY;
          const pageHeight = pdf.internal.pageSize.getHeight();

          // Summary stats
          pdf.setFontSize(9);
          pdf.setFont(undefined, 'normal');
          pdf.text(`Award Cycle: ${meta.fyStart || 'N/A'} to ${meta.fyEnd || 'N/A'} (${meta.fyLabel || 'FY'})`, 15, yPos);
          yPos += 5;
          pdf.text(`Total Units: ${meta.totalUnits || 0} | On Track: ${meta.onTrackUnits || 0} | Potentially Eligible: ${meta.potentialUnits || 0}`, 15, yPos);
          yPos += 8;

          if (isMultiUnit && rows.length > 0) {
            // Multi-unit summary table
            const tableHead = [['Unit', 'Type', 'Seniors', 'Status', 'Score', 'CP', 'PD', 'RET', 'ES', 'CMD', 'ENC']];
            const tableBody = rows.map(unit => {
              const getSymbol = (c) => {
                if (!c || !c.trackable) return '?';
                if (c.met === null) return '-';
                return c.met ? 'Y' : 'N';
              };
              const getShortStatus = (status) => {
                if (status === 'On Track') return 'On Track';
                if (status === 'Potentially Eligible') return 'Pot. Elig';
                if (status === 'Required Criteria Not Met') return 'Req Not Met';
                if (status === 'Not On Track') return 'Not Track';
                return status;
              };
              return [
                unit.unitName,
                unit.unitCategoryLabel || unit.unitCategory,
                unit.totalSeniors.toString(),
                getShortStatus(unit.awardStatus),
                `${unit.criteriaMet}/10`,
                getSymbol(unit.criteria.cadetProtection),
                getSymbol(unit.criteria.professionalDevelopment),
                getSymbol(unit.criteria.retention),
                getSymbol(unit.criteria.esReadiness),
                getSymbol(unit.criteria.commandLeadership),
                getSymbol(unit.criteria.encampmentSupport)
              ];
            });

            pdf.autoTable({
              head: tableHead,
              body: tableBody,
              startY: yPos,
              styles: { fontSize: 7, cellPadding: 2 },
              headStyles: { fillColor: [71, 85, 105], textColor: 255 },
              columnStyles: {
                0: { cellWidth: 35 },
                1: { cellWidth: 22, halign: 'center' },
                2: { cellWidth: 15, halign: 'center' },
                3: { cellWidth: 22, halign: 'center' },
                4: { cellWidth: 15, halign: 'center' },
                5: { cellWidth: 12, halign: 'center' },
                6: { cellWidth: 12, halign: 'center' },
                7: { cellWidth: 12, halign: 'center' },
                8: { cellWidth: 12, halign: 'center' },
                9: { cellWidth: 12, halign: 'center' },
                10: { cellWidth: 12, halign: 'center' }
              },
              margin: { left: 15, right: 15 },
              theme: 'grid'
            });

            yPos = pdf.lastAutoTable.finalY + 8;

            // Legend
            pdf.setFontSize(7);
            pdf.text('Legend: Y=Met, N=Not Met, ?=Not Trackable, -=N/A', 15, yPos);
            yPos += 4;
            pdf.text('CP=Cadet Protection (Req), PD=Professional Development (Req), RET=Retention (Req), ES=ES Readiness, CMD=Command & Leadership, ENC=Encampment', 15, yPos);
            yPos += 4;
            pdf.text('+ 4 non-trackable: Aerospace Education, Community Engagement, Flying Excellence, Innovation & Cyber', 15, yPos);
          } else {
            // Single unit detailed view
            rows.forEach((unit, idx) => {
              if (yPos > pageHeight - 60) {
                pdf.addPage();
                yPos = 20;
              }

              // Unit header with colored status bar
              const statusColors = {
                'On Track': [22, 163, 74],           // emerald
                'Potentially Eligible': [234, 179, 8], // amber
                'Required Criteria Not Met': [220, 38, 38], // red
                'Not On Track': [100, 116, 139]      // slate
              };
              const statusColor = statusColors[unit.awardStatus] || [100, 116, 139];

              pdf.setFillColor(...statusColor);
              pdf.rect(15, yPos - 4, 180, 8, 'F');
              pdf.setTextColor(255, 255, 255);
              pdf.setFontSize(11);
              pdf.setFont(undefined, 'bold');
              pdf.text(unit.unitName, 17, yPos + 1);
              pdf.setFontSize(9);
              pdf.text(`${unit.criteriaMet}/10 Criteria`, 160, yPos + 1);
              yPos += 8;

              pdf.setTextColor(0, 0, 0);
              pdf.setFontSize(9);
              pdf.setFont(undefined, 'normal');
              pdf.text(`Status: ${unit.awardStatus} | Seniors: ${unit.totalSeniors} | Type: ${unit.unitCategoryLabel || unit.unitCategory}`, 15, yPos);
              yPos += 8;

              // Required Criteria Section
              pdf.setFillColor(239, 68, 68); // red-500
              pdf.rect(15, yPos - 3, 180, 6, 'F');
              pdf.setTextColor(255, 255, 255);
              pdf.setFontSize(9);
              pdf.setFont(undefined, 'bold');
              pdf.text('REQUIRED CRITERIA (Must meet all 3)', 17, yPos + 1);
              yPos += 7;
              pdf.setTextColor(0, 0, 0);

              // Required criteria table
              const requiredCriteria = [
                ['cadetProtection', 'Cadet Protection', '100% members with current training'],
                ['professionalDevelopment', 'Professional Development', `${unit.pdThreshold}% new Level II-V in FY + timely SM promotions`],
                ['retention', 'Recruitment & Retention', '5% growth OR 75% retention']
              ];

              const requiredBody = requiredCriteria.map(([key, name, desc]) => {
                const c = unit.criteria[key];
                if (!c) return [name, '-', '-', desc];

                const status = !c.trackable ? 'Manual' : c.met === null ? 'N/A' : c.met ? 'MET' : 'NOT MET';
                let value = '';

                if (!c.trackable) {
                  value = '-';
                } else if (key === 'retention') {
                  const growthStr = c.growth !== null ? `${c.growth >= 0 ? '+' : ''}${c.growth}%` : 'N/A';
                  const retStr = c.retention !== null ? `${c.retention}%` : 'N/A';
                  value = `Growth: ${growthStr} | Ret: ${retStr}`;
                } else if (key === 'professionalDevelopment' && c.subCriteria) {
                  const nl = c.subCriteria.newLevels;
                  const sm = c.subCriteria.smPromotion;
                  const nlStr = nl ? `${nl.count} (${nl.percent}%) new levels` : '';
                  const smStr = sm ? `${sm.violations} SM violations` : '';
                  value = [nlStr, smStr].filter(Boolean).join(' | ');
                } else if (c.percent !== null && c.percent !== undefined) {
                  value = `${c.percent}% (${c.count}/${c.total})`;
                }

                return [name, status, value, desc];
              });

              pdf.autoTable({
                head: [['Criterion', 'Status', 'Current Value', 'Requirement']],
                body: requiredBody,
                startY: yPos,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [254, 226, 226], textColor: [127, 29, 29] }, // red-100/red-900
                columnStyles: {
                  0: { cellWidth: 40 },
                  1: { cellWidth: 22, halign: 'center' },
                  2: { cellWidth: 50 },
                  3: { cellWidth: 68 }
                },
                margin: { left: 15, right: 15 },
                theme: 'grid',
                didParseCell: function(data) {
                  if (data.section === 'body') {
                    // Row background based on status
                    const status = data.row.raw[1];
                    if (status === 'MET') {
                      data.cell.styles.fillColor = [236, 253, 245]; // emerald-50
                    } else if (status === 'NOT MET') {
                      data.cell.styles.fillColor = [254, 242, 242]; // red-50
                    }
                    // Status text color
                    if (data.column.index === 1) {
                      if (status === 'MET') {
                        data.cell.styles.textColor = [22, 163, 74];
                        data.cell.styles.fontStyle = 'bold';
                      } else if (status === 'NOT MET') {
                        data.cell.styles.textColor = [220, 38, 38];
                        data.cell.styles.fontStyle = 'bold';
                      }
                    }
                  }
                }
              });

              yPos = pdf.lastAutoTable.finalY + 6;

              // Mission-Specific Criteria Section
              pdf.setFillColor(124, 58, 237); // purple-600
              pdf.rect(15, yPos - 3, 180, 6, 'F');
              pdf.setTextColor(255, 255, 255);
              pdf.setFontSize(9);
              pdf.setFont(undefined, 'bold');
              pdf.text('MISSION-SPECIFIC CRITERIA (Choose any 4 of 7)', 17, yPos + 1);
              yPos += 7;
              pdf.setTextColor(0, 0, 0);

              // Mission-specific criteria table
              const missionCriteria = [
                ['esReadiness', 'Emergency Services Readiness', '50% GES + 25% ICUT + 15% Op Eval'],
                ['commandLeadership', 'Command & Leadership', 'VOLU + 25% Yeager+ + 25% Capt+'],
                ['encampmentSupport', 'Encampment Support', '15% of seniors serving'],
                ['aerospaceEducation', 'Aerospace Education', 'AE programming events'],
                ['communityEngagement', 'Community Engagement', 'Community outreach activities'],
                ['flyingExcellence', 'Flying Excellence', 'Pilot currency maintained'],
                ['innovationCyber', 'Innovation & Cyber', 'Technology initiatives']
              ];

              const missionBody = missionCriteria.map(([key, name, desc]) => {
                const c = unit.criteria[key];
                if (!c) return [name, 'Manual', '-', desc];

                const status = !c.trackable ? 'Manual' : c.met === null ? 'N/A' : c.met ? 'MET' : 'NOT MET';
                let value = '-';

                if (c.trackable) {
                  if (c.subCriteria) {
                    const parts = [];
                    Object.entries(c.subCriteria).forEach(([subKey, sub]) => {
                      if (sub.percent !== undefined) {
                        const label = sub.name || subKey;
                        parts.push(`${label}: ${sub.percent}%`);
                      } else if (sub.count !== undefined) {
                        const label = sub.name || subKey;
                        parts.push(`${label}: ${sub.count}`);
                      }
                    });
                    value = parts.join(' | ') || '-';
                  } else if (c.percent !== null && c.percent !== undefined) {
                    value = `${c.percent}% (${c.count}/${c.total})`;
                  } else if (c.count !== undefined) {
                    value = `${c.count}`;
                  }
                }

                return [name, status, value, desc];
              });

              pdf.autoTable({
                head: [['Criterion', 'Status', 'Current Value', 'Requirement']],
                body: missionBody,
                startY: yPos,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [243, 232, 255], textColor: [88, 28, 135] }, // purple-100/purple-900
                columnStyles: {
                  0: { cellWidth: 40 },
                  1: { cellWidth: 22, halign: 'center' },
                  2: { cellWidth: 50 },
                  3: { cellWidth: 68 }
                },
                margin: { left: 15, right: 15 },
                theme: 'grid',
                didParseCell: function(data) {
                  if (data.section === 'body') {
                    const status = data.row.raw[1];
                    if (status === 'MET') {
                      data.cell.styles.fillColor = [236, 253, 245]; // emerald-50
                    } else if (status === 'NOT MET') {
                      data.cell.styles.fillColor = [254, 242, 242]; // red-50
                    } else if (status === 'Manual') {
                      data.cell.styles.fillColor = [248, 250, 252]; // slate-50
                    }
                    if (data.column.index === 1) {
                      if (status === 'MET') {
                        data.cell.styles.textColor = [22, 163, 74];
                        data.cell.styles.fontStyle = 'bold';
                      } else if (status === 'NOT MET') {
                        data.cell.styles.textColor = [220, 38, 38];
                        data.cell.styles.fontStyle = 'bold';
                      } else if (status === 'Manual') {
                        data.cell.styles.textColor = [100, 116, 139];
                        data.cell.styles.fontStyle = 'italic';
                      }
                    }
                  }
                }
              });

              yPos = pdf.lastAutoTable.finalY + 12;
            });
          }
        };

        const renderRecruitingTrendsReport = (pdf, report, startY) => {
          let yPos = startY;
          const meta = report.meta || {};
          const pageWidth = pdf.internal.pageSize.getWidth();

          // Time range header
          pdf.setFontSize(10);
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(71, 85, 105);
          const timeRangeText = meta.timeRange === 0 ? 'All time' : `Last ${meta.timeRange} months`;
          pdf.text(`Time Range: ${timeRangeText} | ${meta.dataPoints || 0} data points`, 15, yPos);
          yPos += 8;

          // Summary Statistics Box
          pdf.setFillColor(239, 246, 255); // blue-50
          pdf.rect(15, yPos, pageWidth - 30, 28, 'F');
          pdf.setDrawColor(191, 219, 254); // blue-200
          pdf.rect(15, yPos, pageWidth - 30, 28, 'S');

          const boxWidth = (pageWidth - 30) / 4;
          const statY = yPos + 10;
          const labelY = yPos + 18;

          // Stat 1: Total Recruited
          pdf.setFontSize(16);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(30, 41, 59);
          pdf.text(String(meta.totalRecruited || 0), 15 + boxWidth * 0.5, statY, { align: 'center' });
          pdf.setFontSize(7);
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(100, 116, 139);
          pdf.text('TOTAL RECRUITED', 15 + boxWidth * 0.5, labelY, { align: 'center' });

          // Stat 2: Monthly Avg
          pdf.setFontSize(16);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(30, 41, 59);
          pdf.text(String(meta.monthlyAverage || 0), 15 + boxWidth * 1.5, statY, { align: 'center' });
          pdf.setFontSize(7);
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(100, 116, 139);
          pdf.text('MONTHLY AVG', 15 + boxWidth * 1.5, labelY, { align: 'center' });

          // Stat 3: New Members
          pdf.setFontSize(16);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(22, 163, 74); // emerald
          pdf.text(String(meta.newTotal || 0), 15 + boxWidth * 2.5, statY, { align: 'center' });
          pdf.setFontSize(7);
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(100, 116, 139);
          pdf.text('NEW MEMBERS', 15 + boxWidth * 2.5, labelY, { align: 'center' });

          // Stat 4: Rejoins
          pdf.setFontSize(16);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(37, 99, 235); // blue
          pdf.text(String(meta.rejoinTotal || 0), 15 + boxWidth * 3.5, statY, { align: 'center' });
          pdf.setFontSize(7);
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(100, 116, 139);
          pdf.text('REJOINS', 15 + boxWidth * 3.5, labelY, { align: 'center' });

          yPos += 35;

          // Member Type Breakdown
          pdf.setFontSize(9);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(51, 65, 85);
          pdf.text('Member Type Breakdown:', 15, yPos);
          yPos += 5;
          pdf.setFont(undefined, 'normal');
          pdf.setFontSize(8);
          pdf.text(`Senior Members: ${meta.seniorTotal || 0}  |  Cadets: ${meta.cadetTotal || 0}`, 20, yPos);
          yPos += 8;

          // Seasonality if available
          if (meta.seasonality) {
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(51, 65, 85);
            pdf.text('Seasonal Patterns:', 15, yPos);
            yPos += 5;
            pdf.setFont(undefined, 'normal');
            pdf.setFontSize(8);
            const peakMonths = meta.seasonality.peakMonths?.join(', ') || 'N/A';
            const lowMonths = meta.seasonality.lowMonths?.join(', ') || 'N/A';
            pdf.setTextColor(22, 163, 74);
            pdf.text(`Peak Months: ${peakMonths}`, 20, yPos);
            yPos += 4;
            pdf.setTextColor(220, 38, 38);
            pdf.text(`Low Months: ${lowMonths}`, 20, yPos);
            yPos += 8;
          }

          // Unit Breakdown Table (if aggregate)
          if (meta.isAggregate && meta.unitBreakdown && meta.unitBreakdown.length > 0) {
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(51, 65, 85);
            pdf.text('Unit Recruiting Rates:', 15, yPos);
            yPos += 3;

            pdf.autoTable({
              startY: yPos,
              head: [['Unit', 'Members', 'Avg/Month']],
              body: meta.unitBreakdown.slice(0, 10).map(u => [
                u.unitName || u.orgId,
                String(u.currentTotal || 0),
                u.recruitingRate || '--'
              ]),
              styles: { fontSize: 7, cellPadding: 1.5 },
              headStyles: { fillColor: [71, 85, 105], textColor: 255, fontStyle: 'bold', fontSize: 7 },
              alternateRowStyles: { fillColor: [248, 250, 252] },
              margin: { left: 15, right: 15 },
              theme: 'grid'
            });
            yPos = pdf.lastAutoTable.finalY + 8;
          }

          // Monthly Breakdown Table
          pdf.setFontSize(9);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(51, 65, 85);
          pdf.text('Monthly Breakdown:', 15, yPos);
          yPos += 3;

          pdf.autoTable({
            startY: yPos,
            head: [['Month', 'New', 'Rejoin', 'Total', 'Members']],
            body: (report.data || []).slice(0, 24).map(row => [
              row.month || '',
              String(row.totalNew || 0),
              String(row.totalRejoin || 0),
              String(row.totalRecruited || 0),
              String(row.totalMembers || 0)
            ]),
            styles: { fontSize: 7, cellPadding: 1.5 },
            headStyles: { fillColor: [71, 85, 105], textColor: 255, fontStyle: 'bold', fontSize: 7 },
            alternateRowStyles: { fillColor: [248, 250, 252] },
            margin: { left: 15, right: 15 },
            theme: 'grid'
          });
        };

        const renderRetentionAnalysisReport = (pdf, report, startY) => {
          let yPos = startY;
          const meta = report.meta || {};
          const pageWidth = pdf.internal.pageSize.getWidth();

          // Time range header
          pdf.setFontSize(10);
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(71, 85, 105);
          const timeRangeText = meta.timeRange === 0 ? 'All time' : `Last ${meta.timeRange} months`;
          pdf.text(`Time Range: ${timeRangeText}`, 15, yPos);
          yPos += 8;

          // Health Status Banner
          const healthColor = meta.healthIndicator === 'healthy' ? [22, 163, 74] :
                              meta.healthIndicator === 'moderate' ? [217, 119, 6] :
                              meta.healthIndicator === 'at-risk' ? [220, 38, 38] : [100, 116, 139];
          const healthBg = meta.healthIndicator === 'healthy' ? [220, 252, 231] :
                           meta.healthIndicator === 'moderate' ? [254, 243, 199] :
                           meta.healthIndicator === 'at-risk' ? [254, 226, 226] : [241, 245, 249];
          const healthLabel = meta.healthIndicator === 'healthy' ? 'HEALTHY' :
                              meta.healthIndicator === 'moderate' ? 'MODERATE' :
                              meta.healthIndicator === 'at-risk' ? 'AT RISK' : 'UNKNOWN';

          pdf.setFillColor(...healthBg);
          pdf.rect(15, yPos, pageWidth - 30, 12, 'F');
          pdf.setFontSize(12);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(...healthColor);
          pdf.text(`Retention Rate: ${meta.retentionRate !== null ? meta.retentionRate + '%' : '--'}  [${healthLabel}]`, pageWidth / 2, yPos + 8, { align: 'center' });
          yPos += 18;

          // Summary Statistics Box
          pdf.setFillColor(255, 251, 235); // amber-50
          pdf.rect(15, yPos, pageWidth - 30, 28, 'F');
          pdf.setDrawColor(253, 230, 138); // amber-200
          pdf.rect(15, yPos, pageWidth - 30, 28, 'S');

          const boxWidth = (pageWidth - 30) / 4;
          const statY = yPos + 10;
          const labelY = yPos + 18;

          // Stat 1: Current Members
          pdf.setFontSize(16);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(30, 41, 59);
          pdf.text(String(meta.currentTotal || 0), 15 + boxWidth * 0.5, statY, { align: 'center' });
          pdf.setFontSize(7);
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(100, 116, 139);
          pdf.text('CURRENT MEMBERS', 15 + boxWidth * 0.5, labelY, { align: 'center' });

          // Stat 2: Renewals
          pdf.setFontSize(16);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(22, 163, 74);
          pdf.text(String(meta.renewalsInPeriod || 0), 15 + boxWidth * 1.5, statY, { align: 'center' });
          pdf.setFontSize(7);
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(100, 116, 139);
          pdf.text('RENEWALS', 15 + boxWidth * 1.5, labelY, { align: 'center' });

          // Stat 3: Est. Attrition
          pdf.setFontSize(16);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(220, 38, 38);
          pdf.text(String(meta.estimatedAttrition || 0), 15 + boxWidth * 2.5, statY, { align: 'center' });
          pdf.setFontSize(7);
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(100, 116, 139);
          pdf.text('EST. ATTRITION', 15 + boxWidth * 2.5, labelY, { align: 'center' });

          // Stat 4: Net Change
          const netChange = meta.netChange || 0;
          const netColor = netChange > 0 ? [22, 163, 74] : netChange < 0 ? [220, 38, 38] : [100, 116, 139];
          pdf.setFontSize(16);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(...netColor);
          pdf.text((netChange > 0 ? '+' : '') + String(netChange), 15 + boxWidth * 3.5, statY, { align: 'center' });
          pdf.setFontSize(7);
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(100, 116, 139);
          pdf.text('NET CHANGE', 15 + boxWidth * 3.5, labelY, { align: 'center' });

          yPos += 35;

          // Expiring Members Summary
          pdf.setFontSize(9);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(51, 65, 85);
          pdf.text('Members Due for Renewal:', 15, yPos);
          yPos += 5;
          pdf.setFont(undefined, 'normal');
          pdf.setFontSize(8);
          pdf.setTextColor(220, 38, 38);
          pdf.text(`30 days: ${meta.expiringIn30Days || 0}`, 20, yPos);
          pdf.setTextColor(217, 119, 6);
          pdf.text(`60 days: ${meta.expiringIn60Days || 0}`, 55, yPos);
          pdf.setTextColor(100, 116, 139);
          pdf.text(`90 days: ${meta.expiringIn90Days || 0}`, 90, yPos);
          yPos += 8;

          // Unit Breakdown Table (if aggregate)
          if (meta.isAggregate && meta.unitBreakdown && meta.unitBreakdown.length > 0) {
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(51, 65, 85);
            pdf.text('Unit Retention Rates:', 15, yPos);
            yPos += 3;

            pdf.autoTable({
              startY: yPos,
              head: [['Unit', 'Members', 'Retention', 'Status']],
              body: meta.unitBreakdown.slice(0, 10).map(u => [
                u.unitName || u.orgId,
                String(u.currentTotal || 0),
                u.retentionRate !== null ? u.retentionRate + '%' : '--',
                u.growthStatus || '--'
              ]),
              styles: { fontSize: 7, cellPadding: 1.5 },
              headStyles: { fillColor: [71, 85, 105], textColor: 255, fontStyle: 'bold', fontSize: 7 },
              alternateRowStyles: { fillColor: [248, 250, 252] },
              margin: { left: 15, right: 15 },
              theme: 'grid'
            });
            yPos = pdf.lastAutoTable.finalY + 8;
          }

          // Members Due for Renewal Table
          if (report.data && report.data.length > 0) {
            pdf.setFontSize(9);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(51, 65, 85);
            pdf.text('Members Expiring Soon:', 15, yPos);
            yPos += 3;

            pdf.autoTable({
              startY: yPos,
              head: [['Member', 'CAPID', 'Type', 'Unit', 'Expires', 'Days']],
              body: report.data.map(row => [
                row.memberName || '',
                row.capid || '',
                row.memberType || '',
                row.unit || '',
                row.expiration || '',
                String(row.daysUntil || '')
              ]),
              styles: { fontSize: 7, cellPadding: 1.5 },
              headStyles: { fillColor: [71, 85, 105], textColor: 255, fontStyle: 'bold', fontSize: 7 },
              alternateRowStyles: { fillColor: [248, 250, 252] },
              margin: { left: 15, right: 15 },
              theme: 'grid',
              didParseCell: function(data) {
                if (data.section === 'body' && data.column.index === 5) {
                  const days = parseInt(data.cell.raw);
                  if (!isNaN(days)) {
                    if (days <= 30) {
                      data.cell.styles.textColor = [220, 38, 38]; // red
                    } else if (days <= 60) {
                      data.cell.styles.textColor = [217, 119, 6]; // amber
                    }
                  }
                }
              }
            });
          } else {
            pdf.setFontSize(9);
            pdf.setTextColor(100, 116, 139);
            pdf.text('No members expiring in the next 90 days.', 15, yPos);
          }
        };

        const addReportContent = (pdf, report) => {
          const startY = 45;

          switch (report.type) {
            case 'training':
              return renderTrainingReport(pdf, report, startY);
            case 'discrepancies':
              return renderDiscrepanciesReport(pdf, report, startY);
            case 'aerospace-education':
              return renderAerospaceEducationReport(pdf, report, startY);
            case 'oflight-status':
              return renderOFlightReport(pdf, report, startY);
            case 'qcua':
              return renderQCUAReport(pdf, report, startY);
            case 'qua':
              return renderQUAReport(pdf, report, startY);
            case 'recruiting-trends':
              return renderRecruitingTrendsReport(pdf, report, startY);
            case 'retention-analysis':
              return renderRetentionAnalysisReport(pdf, report, startY);
            default:
              return renderTableReport(pdf, report, startY);
          }
        };

        const exportReportToPDF = async (report) => {
          try {
            const { jsPDF } = window.jspdf;

            if (!jsPDF) {
              alert('PDF library not loaded. Please refresh the page and try again.');
              return;
            }

            const orientation = detectOrientation(report);
            const pdf = new jsPDF({
              orientation,
              unit: 'mm',
              format: 'a4'
            });

            addPDFHeader(pdf, report);
            await addReportContent(pdf, report);
            pdf.save(generateFilename(report));
          } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF. Please try again.');
          }
        };

          const handleExportReportPDF = async (reportDef) => {
            try {
              const scopedMembers = getMembersForReport(reportDef.tags);
              const reportData = reportDef.generate(scopedMembers);
              const reportPayload = buildReportPayload(reportDef, reportData);
              await exportReportToPDF(reportPayload);
            } catch (error) {
              console.error('Error exporting report:', error);
              alert('Error exporting report. Please try again.');
            }
        };

        const handleExportCurrentReportPDF = async () => {
          if (!selectedReport) {
            alert('No report is currently displayed');
            return;
          }
          await exportReportToPDF(selectedReport);
        };

        if (loading) {
          return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50">
              <div className="spinner mb-4"></div>
              <h2 className="text-xl font-bold text-slate-800">Loading MIWG Readiness...</h2>
              <p className="text-slate-500 mt-2 text-sm">{loadingStatus}</p>
            </div>
          );
        }
        
        const activeFiltersCount = filters.ranks.length + filters.rankCategories.length + filters.functionalAreas.length + filters.tracks.length + filters.trackLevels.length + filters.duties.length + filters.dutyTypes.length + filters.memberTypes.length + (filterTlcQualified ? 1 : 0);

        return (
          <div className="min-h-screen bg-slate-50 font-sans text-slate-900 pb-20">
            <header className="bg-blue-900 text-white shadow sticky top-0 z-50 px-3 sm:px-4 py-2 md:py-3 flex flex-col md:flex-row justify-between items-center gap-2 md:gap-4">
              <div className="flex flex-col md:flex-row items-start md:items-center gap-2 md:gap-3 w-full md:w-auto">
                {/* Logo and title - hidden on mobile */}
                <div className="hidden md:flex items-center gap-3 min-w-0">
                    <img src="https://drive.google.com/thumbnail?id=1xQG2MsCTnmpRpuKaUdHchmXTZwBmcsig" alt="Logo" className="w-10 h-10 object-contain mr-2" />
                    <div className="min-w-0">
                      <h1 className="text-xl font-bold leading-tight">MIWG Readiness <span className="text-xs font-normal bg-green-600 text-white px-1.5 py-0.5 rounded ml-1">OFFLINE</span></h1>
                      <p className="text-xs text-blue-200">Data: {lastUpdated ? formatSyncTime(lastUpdated) : 'Not loaded'}</p>
                    </div>
                </div>

                <div className="h-8 w-px bg-blue-700 hidden md:block mx-2"></div>

                <div className="flex items-center gap-2 w-full md:w-auto flex-nowrap">
                     <div className="relative flex-1 min-w-[200px]">
                        <select value={unitFilter} onChange={(e) => setUnitFilter(e.target.value)} className="bg-blue-800 border border-blue-700 text-white rounded pl-2 pr-8 py-2 text-sm font-bold cursor-pointer focus:ring-1 focus:ring-blue-400 appearance-none w-full sm:max-w-[320px] truncate">
                            {availableUnits.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                        </select>
                        <Icon name="ChevronDown" className="w-4 h-4 text-blue-300 absolute right-2 top-2 pointer-events-none" />
                     </div>
                     <label
                       className="group relative flex items-center gap-2 shrink-0 cursor-pointer rounded-lg border border-blue-600 bg-blue-800/80 hover:bg-blue-800 px-3 py-2 text-xs font-semibold text-blue-50 shadow-sm transition-colors select-none"
                       title="Aggregate data from subordinate units"
                     >
                       <input
                         type="checkbox"
                         checked={showAllDescendants}
                         onChange={handleShowSubUnits}
                         className="sr-only"
                       />
                       <span className={`flex items-center justify-center w-4 h-4 rounded border ${showAllDescendants ? 'bg-green-500 border-green-400' : 'border-blue-300 bg-blue-900/60'}`}>
                         {showAllDescendants && <Icon name="Check" className="w-3 h-3 text-white" />}
                       </span>
                       <span className="flex-1 text-left whitespace-nowrap">{isAggregating ? "Loading..." : "Include Sub-Units"}</span>
                     </label>
                </div>
              </div>

              <div className="flex items-center gap-3 w-full md:w-auto flex-wrap md:flex-nowrap">
                 <div className="relative flex-1 min-w-[180px] md:w-64">
                    <Icon name="Search" className="absolute left-3 top-2 text-blue-300 w-4 h-4" />
                    <input type="text" placeholder="Search members, duties..." value={searchQuery} onChange={(e)=>setSearchQuery(e.target.value)} className="w-full pl-9 pr-3 py-1.5 bg-blue-800 border border-blue-700 text-white placeholder-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-400 text-sm" />
                 </div>

                 <button
                   className="md:hidden flex items-center gap-2 px-3 py-2 bg-blue-800 text-white rounded-lg border border-blue-700"
                   onClick={() => setIsNavOpen(v => !v)}
                 >
                   <Icon name="Menu" className="w-4 h-4" /> Menu
                 </button>

                 <nav className="hidden md:flex space-x-1 bg-blue-800 p-1 rounded-lg shrink-0 overflow-x-auto w-full md:w-auto max-w-full">
                    {navItems.map(tab => (
                       <button
                         key={tab.id}
                         onClick={() => setActiveTab(tab.id)}
                         className={`px-3 py-1.5 rounded text-sm font-semibold whitespace-nowrap transition-all ${
                           activeTab === tab.id ? 'bg-white text-blue-900 shadow-sm' : 'text-blue-200 hover:text-white'
                         }`}
                       >
                         {tab.label}
                       </button>
                   ))}
                   <button
                     onClick={() => setShowZipImportModal(true)}
                     className="px-3 py-1.5 rounded text-sm font-semibold whitespace-nowrap transition-all text-green-300 hover:text-white hover:bg-green-600 flex items-center gap-1"
                     title="Import new CAPWATCH data"
                   >
                     <Icon name="Upload" className="w-4 h-4" /> Import
                   </button>
                 </nav>
              </div>

              {isNavOpen && (
                <div className="md:hidden w-full bg-blue-800 rounded-lg p-2 flex flex-col gap-1">
                  {navItems.map(tab => (
                    <button
                      key={`mobile-${tab.id}`}
                      onClick={() => {
                        setActiveTab(tab.id);
                        setIsNavOpen(false);
                      }}
                      className={`px-3 py-2 rounded text-sm font-semibold text-left transition-colors ${
                        activeTab === tab.id ? 'bg-white text-blue-900' : 'text-blue-100 hover:bg-blue-700'
                      }`}
                    >
                      {tab.label}
                    </button>
                  ))}
                  <button
                    onClick={() => {
                      setShowZipImportModal(true);
                      setIsNavOpen(false);
                    }}
                    className="px-3 py-2 rounded text-sm font-semibold text-left transition-colors text-green-300 hover:bg-green-600 flex items-center gap-2"
                  >
                    <Icon name="Upload" className="w-4 h-4" /> Import Data
                  </button>
                </div>
              )}
            </header>

            <main className="max-w-[95%] mx-auto py-6">
              {activeTab === 'home' && (
                <HomeSection
                  activeTab={activeTab}
                  setActiveTab={setActiveTab}
                  baseUnitStats={baseUnitStats}
                  showAllDescendants={showAllDescendants}
                />
              )}

              {activeTab === 'unit' && (
                <UnitOverviewSection
                  baseUnitStats={baseUnitStats}
                  showAllDescendants={showAllDescendants}
                  processedData={processedData}
                  cadetData={cadetData}
                  orgChartData={orgChartData}
                  setActiveTab={setActiveTab}
                  unitFilter={unitFilter}
                  descendantOrgIds={getDescendantOrgIds(unitFilter)}
                  orgStatsService={orgStatsService}
                  esUnitAnalysisService={dataService?.getESUnitAnalysisService()}
                  dataFiles={dataFiles}
                  setRecruitingRetentionModal={setRecruitingRetentionModal}
                  setESReadinessModal={setESReadinessModal}
                />
              )}

              {activeTab === 'senior' && <SeniorDashboard {...{
                showSeniorFilters, setShowSeniorFilters, activeFiltersCount, filterPromoReady, levelFilter,
                searchQuery, clearFilters, activeFilterMenu, setActiveFilterMenu, filters, toggleFilter,
                trackSearchQuery, setTrackSearchQuery, dutySearchQuery, setDutySearchQuery,
                availableTracks, availableDuties, availableFunctionalAreas, availableRanks, processedData,
                setSelectedMemberProfile, setSelectedMember, setDetailLevel, setPromotionMember,
                getPromotionDetails, setReportsCollapsed, reportsCollapsed,
                unitStats, baseUnitStats, paginatedData, isMobile, currentPage, setCurrentPage,
                totalPages, handleLevelFilterClick, getEtSummary, displayData, DATA_CONSTANTS,
                LEVEL_DISPLAY_MAP, LEVELS, setFilterPromoReady, getTrainingIndicator,
                filterTlcQualified, setFilterTlcQualified
              }} />}

              {activeTab === 'cadet' && <CadetDashboard {...{
                phaseFilter, setPhaseFilter, cadetSearchQuery, setCadetSearchQuery,
                cadetData, setSelectedCadetProfile, selectedCadetProfile,
                setSelectedMemberProfile, processedCadets, searchQuery, filterStatus,
                setFilterStatus, filters, toggleFilter, setFilters, showCadetFilters,
                setShowCadetFilters, getRankInsigniaUrl, getAchievementDisplayName,
                filterPhase, setFilterPhase, filter90Days, setFilter90Days, isMobile,
                activeFilterMenu, setActiveFilterMenu, dutySearchQuery, setDutySearchQuery,
                setSelectedCadet, selectedCadet, CADET_ACHIEVEMENT_TO_RANK, dataFiles, cadetDataService,
                getCadetProtectionStatus
              }} />}

              {activeTab === 'reports' && <ReportsSection {...{
                reportTagFilter, setReportTagFilter, selectedReport, setSelectedReport,
                allReports: reportCatalog, processedData, cadetData,
                reportsCollapsed, setReportsCollapsed, availableReportTags, toggleReportTag,
                formatReportTagLabel, reportTagClasses, filteredReports,
                handleGenerateReport, handleRegenerateReport, handleExportReportPDF, handleExportCurrentReportPDF,
                setSelectedTaskMembers, selectedTaskMembers, getMemberEmail, LEVEL_DISPLAY_MAP,
                setSelectedMemberTaskDetails, selectedMemberTaskDetails, isMobile
              }} />}

              {activeTab === 'org' && <OrgChartSection {...{
                orgChartData, expandedSections, setExpandedSections, showCommandChainOnly,
                setShowCommandChainOnly, drillDownPosition, setDrillDownPosition,
                showAllDescendants, toggleExpandCollapse, getAllNodeIds,
                hideVacant, setHideVacant, hasCommittees, showCommittees,
                setShowCommittees, handleDownloadImage, dataFiles, unitFilter,
                getDescendantOrgIds, processedData, buildMemberProfileData,
                setSelectedMemberProfile
              }} />}

              <FloatingHelpAndModals {...{
                showReference, setShowReference, selectedMember, detailLevel,
                setSelectedMember, setDetailLevel, getLevelBreakdown, LEVEL_DISPLAY_MAP,
                promotionMember, setPromotionMember, getPromotionDetails,
                selectedMemberProfile, setSelectedMemberProfile, getMemberEmail,
                dataFiles, drillDownPosition, setDrillDownPosition, unitFilter,
                getDescendantOrgIds, processedData, buildMemberProfileData,
                DUTY_TO_TRACK_MAP, LEVELS, getCadetProtectionStatus, getTlcStatus,
                dataService, activeTab
              }} />
            </main>

            {/* SHARED MODALS - rendered at app level */}
            <SeniorProfileModal
              isOpen={!!selectedMemberProfile}
              onClose={() => setSelectedMemberProfile(null)}
              member={selectedMemberProfile}
              getMemberEmail={getMemberEmail}
              getCadetProtectionStatus={getCadetProtectionStatus}
              getTlcStatus={getTlcStatus}
              getPromotionDetails={getPromotionDetails}
              normalizeTrackDisplayName={normalizeTrackDisplayName}
              dataFiles={dataFiles}
              trainingCourseIndex={trainingCourseIndex}
              voluInstructorIndex={voluInstructorIndex}
              LEVELS={LEVELS}
              PME_COURSE_DEFS={PME_COURSE_DEFS}
              CAP_LEADERSHIP_COURSE_DEFS={CAP_LEADERSHIP_COURSE_DEFS}
              LEGACY_LEADERSHIP_COURSE_DEFS={LEGACY_LEADERSHIP_COURSE_DEFS}
              ES_FUNCTIONAL_AREAS={ES_FUNCTIONAL_AREAS}
              setSelectedMember={setSelectedMember}
              setDetailLevel={setDetailLevel}
              setSelectedESQualification={setSelectedESQualification}
              setShowESTreeModal={setShowESTreeModal}
            />

            <CadetProfileModal
              isOpen={!!selectedCadet}
              onClose={() => setSelectedCadet(null)}
              cadet={selectedCadet}
              getRankInsigniaUrl={getRankInsigniaUrl}
              getAchievementDisplayName={getAchievementDisplayName}
              getCadetProtectionStatus={getCadetProtectionStatus}
              dataFiles={dataFiles}
              configFiles={configFiles}
              cadetDataService={cadetDataService}
              esDataService={dataService}
              CADET_ACHIEVEMENT_TO_RANK={CADET_ACHIEVEMENT_TO_RANK}
              ES_FUNCTIONAL_AREAS={ES_FUNCTIONAL_AREAS}
            />

            <LevelDetailModal
              isOpen={!!selectedMember && !!detailLevel}
              onClose={() => { setSelectedMember(null); setDetailLevel(null); }}
              member={selectedMember}
              level={detailLevel}
              getLevelBreakdown={getLevelBreakdown}
              LEVEL_DISPLAY_MAP={LEVEL_DISPLAY_MAP}
            />

            <PromotionCriteriaModal
              isOpen={!!promotionMember}
              onClose={() => setPromotionMember(null)}
              member={promotionMember}
              getPromotionDetails={getPromotionDetails}
            />

            <DrillDownPositionModal
              isOpen={!!drillDownPosition}
              onClose={() => setDrillDownPosition(null)}
              position={drillDownPosition}
              getDescendantOrgIds={getDescendantOrgIds}
              buildMemberProfileData={buildMemberProfileData}
              unitFilter={unitFilter}
              dataFiles={dataFiles}
              processedData={processedData}
              setSelectedMemberProfile={setSelectedMemberProfile}
              setDrillDownPosition={setDrillDownPosition}
            />

            <ReferenceModal
              isOpen={showReference}
              onClose={() => setShowReference(false)}
              activeTab={activeTab}
              DUTY_TO_TRACK_MAP={DUTY_TO_TRACK_MAP}
              unitFilter={unitFilter}
              showAllDescendants={showAllDescendants}
              lastUpdated={lastUpdated}
              dataFiles={dataFiles}
              availableUnits={availableUnits}
            />

            {/* Recruiting & Retention Modal */}
            <RecruitingRetentionModal
              isOpen={recruitingRetentionModal.isOpen}
              onClose={() => setRecruitingRetentionModal({ isOpen: false })}
              metrics={recruitingRetentionModal.metrics}
              unitFilter={unitFilter}
              showAllDescendants={showAllDescendants}
              timeRange={recruitingRetentionModal.timeRange}
              orgStatsService={orgStatsService}
              descendantOrgIds={getDescendantOrgIds(unitFilter)}
              dataFiles={dataFiles}
            />

            {/* ES Readiness Modal */}
            <ESReadinessModal
              isOpen={esReadinessModal.isOpen}
              onClose={() => setESReadinessModal({ isOpen: false, analysis: null })}
              esAnalysis={esReadinessModal.analysis}
              dataFiles={dataFiles}
              unitFilter={unitFilter}
            />

            {/* ES Modals - These need state at this level */}
            {dataService && selectedESQualification && selectedMemberProfile && (
              <ESQualificationDetailModal
                isOpen={!!selectedESQualification}
                onClose={() => setSelectedESQualification(null)}
                qualification={selectedESQualification}
                member={selectedMemberProfile}
                dataService={dataService}
              />
            )}

            {dataService && selectedMemberProfile && (
              <ESQualificationTreeModal
                isOpen={showESTreeModal}
                onClose={() => setShowESTreeModal(false)}
                member={selectedMemberProfile}
                dataService={dataService}
                allQualifications={dataService.getAllESAchievements ? dataService.getAllESAchievements() : []}
              />
            )}

            {/* ZIP Import Modal */}
            {showZipImportModal && (
              <ZipImportModal
                isOpen={showZipImportModal}
                onImport={handleZipImport}
                onClose={null}
              />
            )}
          </div>
        );
      }



      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <ErrorBoundary>
          <App />
        </ErrorBoundary>
      );
    
  </script>
</body>
</html>
